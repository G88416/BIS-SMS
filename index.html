<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced School Management System (ASMS) - Bophelong Independent School</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe SDK -->
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1e3c72, #2a5298); 
            color: #fff; 
            min-height: 100vh;
        }
        .sidebar { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            border-right: 1px solid rgba(255, 255, 255, 0.2); 
            height: 100vh; 
            position: fixed; 
            width: 260px; 
            padding: 20px; 
            overflow-y: auto; 
            transition: width 0.3s ease; 
            z-index: 1000; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link { 
            color: #fff; 
            font-weight: 500; 
            margin-bottom: 10px; 
            padding: 12px; 
            border-radius: 10px; 
            transition: all 0.3s; 
            backdrop-filter: blur(5px);
        }
        .sidebar .nav-link:hover { 
            background: rgba(255, 255, 255, 0.2); 
            transform: translateX(5px); 
        }
        .sidebar .nav-link.active { 
            background: rgba(255, 255, 255, 0.3); 
            font-weight: 600;
        }
        .content { 
            margin-left: 260px; 
            padding: 40px; 
            transition: margin-left 0.3s ease; 
            min-height: 100vh;
        }
        .content.expanded { margin-left: 70px; }
        .card-metric { 
            background: rgba(255, 255, 255, 0.15); 
            border: none; 
            border-radius: 15px; 
            backdrop-filter: blur(10px); 
            transition: transform 0.3s; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .card-metric:hover { transform: translateY(-8px); }
        .table { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 15px; 
            overflow: hidden; 
            backdrop-filter: blur(10px);
        }
        .table th { background: rgba(255, 255, 255, 0.2); color: #fff; padding: 15px; font-weight: 600; }
        .table td { padding: 12px; vertical-align: middle; }
        .modal-content { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 20px; 
            backdrop-filter: blur(15px); 
            color: #333;
        }
        .modal-header { border-bottom: 1px solid #dee2e6; padding: 20px; }
        .modal-body { padding: 20px; }
        .modal-footer { border-top: 1px solid #dee2e6; padding: 15px 20px; }
        .form-group { margin-bottom: 1.5rem; }
        .btn-toggle-sidebar { 
            position: fixed; 
            top: 20px; 
            left: 270px; 
            z-index: 1001; 
            background: rgba(255, 255, 255, 0.2); 
            border: none; 
            color: #fff;
        }
        .btn-toggle-sidebar.expanded { left: 80px; }
        #notificationBell { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1100; 
        }
        .admin-only { display: block; }
        .teacher-only { display: none; }
        .parent-only { display: none; }
        .student-only { display: none; }
        .dark-mode { filter: brightness(0.8); }
        .login-page { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }
        .login-card { 
            width: 100%; 
            max-width: 450px; 
            padding: 2.5rem; 
            border-radius: 20px; 
            background: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); 
            backdrop-filter: blur(15px);
        }
        .login-title { 
            font-weight: 700; 
            color: #1e3c72; 
            text-align: center;
        }
        .report-card { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 15px; 
            padding: 20px; 
            margin: 10px 0; 
            backdrop-filter: blur(10px);
        }
        .timetable-cell { 
            padding: 10px; 
            text-align: center; 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 8px; 
            margin: 2px; 
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-message { 
            margin-bottom: 10px; 
            padding: 10px; 
            border-radius: 10px; 
        }
        .chat-user { background: rgba(255, 255, 255, 0.2); }
        .chat-assistant { background: rgba(0, 255, 0, 0.1); }
        .editable { cursor: pointer; }
        .editable:hover { background: rgba(255, 255, 255, 0.2); }
        .payslip-preview { 
            background: white; color: #333; padding: 20px; border-radius: 10px; 
            font-family: Arial, sans-serif; 
        }
        .payslip-header { text-align: center; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; }
        .payslip-body table { width: 100%; margin-bottom: 20px; }
        .payslip-body th { text-align: right; width: 60%; }
        .payslip-footer { text-align: center; font-size: 0.9em; color: #666; border-top: 1px solid #ccc; padding-top: 10px; }
        .photo-preview { max-width: 150px; height: auto; border-radius: 50%; border: 2px solid #ddd; margin-top: 10px; }
        .badge { font-size: 0.8em; padding: 0.5em 0.8em; }
        .nav-tabs .nav-link { padding: 12px 20px; font-weight: 500; border-radius: 10px 10px 0 0; }
        .nav-tabs .nav-link.active { background: rgba(255, 255, 255, 0.2); color: #fff; }
        .btn { border-radius: 8px; padding: 8px 16px; font-weight: 500; transition: all 0.3s; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .mb-3 { margin-bottom: 1.5rem !important; }
        .student-card { background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; margin-bottom: 20px; backdrop-filter: blur(10px); }
        .student-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(255,255,255,0.3); }
        .progress { height: 8px; }
        .parent-dashboard { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .child-card { background: rgba(255, 255, 255, 0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .child-photo { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .teacher-dashboard { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .class-card { background: rgba(255, 255, 255, 0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px; cursor: pointer; transition: transform 0.2s; }
        .class-card:hover { transform: translateY(-2px); }
        .schedule-item { background: rgba(255, 255, 255, 0.1); padding: 10px; margin: 5px 0; border-radius: 8px; }
        .alert-card { background: rgba(255, 193, 7, 0.2); border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 15px; }
        .student-dashboard { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .assignment-card { background: rgba(255, 255, 255, 0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .grade-item { display: flex; justify-content: space-between; margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px; }
        .calendar { background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 15px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { padding: 10px; text-align: center; border-radius: 5px; background: rgba(255,255,255,0.05); }
        .calendar-event { background: rgba(255, 193, 7, 0.3); padding: 2px 5px; border-radius: 3px; font-size: 0.8em; margin-top: 2px; }
        .progress-report { background: white; color: #333; padding: 20px; border-radius: 10px; }
        .report-section { margin-bottom: 20px; }
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 70px; }
            .btn-toggle-sidebar { left: 80px; }
            .table { font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x text-primary mb-3"></i>
                <h3 class="login-title">ASMS - Bophelong Independent School</h3>
                <p class="text-muted">Advanced School Management System</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <button type="button" class="btn btn-secondary w-100 mb-3" onclick="biometricLogin()">
                    <i class="fas fa-fingerprint me-2"></i>Biometric Login
                </button>
                <div class="login-demo">
                    <p class="mb-1"><strong>Admin:</strong> admin / admin123</p>
                    <p class="mb-1"><strong>Teacher:</strong> teacher / teacher123</p>
                    <p class="mb-1"><strong>Parent:</strong> parent / parent123</p>
                    <p class="mb-0"><strong>Student:</strong> student / student123</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-warning rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>

        <button class="btn btn-sm btn-light btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

        <div class="sidebar">
            <h4 class="mb-4 text-center"><i class="fas fa-school me-2"></i><span class="nav-text">ASMS</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only non-student"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
                <li class="teacher-only"><a href="#teacherDashboard" class="nav-link" onclick="showSection('teacherDashboard')"><i class="fas fa-chalkboard-teacher me-2"></i><span class="nav-text">Teacher Dashboard</span></a></li>
                <li class="parent-only"><a href="#parentDashboard" class="nav-link" onclick="showSection('parentDashboard')"><i class="fas fa-home me-2"></i><span class="nav-text">Parent Dashboard</span></a></li>
                <li class="student-only"><a href="#studentDashboard" class="nav-link" onclick="showSection('studentDashboard')"><i class="fas fa-user-graduate me-2"></i><span class="nav-text">Student Dashboard</span></a></li>
                <li class="non-student"><a href="#admission" class="nav-link" onclick="showSection('admission')"><i class="fas fa-user-plus me-2"></i><span class="nav-text">Admission</span></a></li>
                <li class="non-student"><a href="#students" class="nav-link" onclick="showSection('students')"><i class="fas fa-users me-2"></i><span class="nav-text">Student Info</span></a></li>
                <li class="non-student"><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
                <li class="non-student"><a href="#fees" class="nav-link" onclick="showSection('fees')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">Fee Management</span></a></li>
                <li><a href="#timetable" class="nav-link" onclick="showSection('timetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Timetable</span></a></li>
                <li><a href="#exams" class="nav-link" onclick="showSection('exams')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Examinations</span></a></li>
                <li class="admin-only non-student"><a href="#hr" class="nav-link" onclick="showSection('hr')"><i class="fas fa-user-tie me-2"></i><span class="nav-text">HR Management</span></a></li>
                <li class="non-student"><a href="#communication" class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments me-2"></i><span class="nav-text">Communication</span></a></li>
                <li><a href="#content" class="nav-link" onclick="showSection('content')"><i class="fas fa-book me-2"></i><span class="nav-text">Content</span></a></li>
                <li class="admin-only non-student"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Reports</span></a></li>
                <li class="admin-only non-student"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="student-only"><a href="#aiResearch" class="nav-link" onclick="showSection('aiResearch')"><i class="fas fa-robot me-2"></i><span class="nav-text">AI Research</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>

        <div class="content">
            <!-- Dashboard (unchanged) -->
            <section id="dashboard" class="section">
                <!-- Previous content -->
            </section>

            <!-- Teacher Dashboard (unchanged) -->
            <section id="teacherDashboard" class="section d-none teacher-only">
                <!-- Previous teacher content -->
            </section>

            <!-- Parent Dashboard (unchanged) -->
            <section id="parentDashboard" class="section d-none parent-only">
                <!-- Previous parent content -->
            </section>

            <!-- Enhanced Student Portal Dashboard -->
            <section id="studentDashboard" class="section d-none student-only">
                <h2><i class="fas fa-user-graduate me-2"></i>Student Portal</h2>
                <p class="lead">Welcome, <strong id="studentWelcome"></strong>! Track your progress and access resources.</p>
                
                <!-- Quick Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <i class="fas fa-clock fa-2x text-info mb-2"></i>
                            <h5>Today's Attendance</h5>
                            <h3 id="studentTodayAtt" class="text-success">Present</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                            <h5>Avg Grade</h5>
                            <h3 id="studentAvgGrade" class="text-primary">85%</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <i class="fas fa-tasks fa-2x text-warning mb-2"></i>
                            <h5>Pending Assignments</h5>
                            <h3 id="pendingAssignments">3</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <i class="fas fa-calendar-alt fa-2x text-secondary mb-2"></i>
                            <h5>Upcoming Exams</h5>
                            <h3 id="upcomingExamsStudent">2</h3>
                        </div>
                    </div>
                </div>

                <!-- Tabs for Student Features -->
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#studentProfile"><i class="fas fa-user me-1"></i>Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#studentTimetable"><i class="fas fa-calendar-alt me-1"></i>Timetable</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#studentGrades"><i class="fas fa-chart-bar me-1"></i>Grades</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#studentProgressReport"><i class="fas fa-file-alt me-1"></i>Progress Report</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#studentCalendar"><i class="fas fa-calendar-days me-1"></i>Calendar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#studentAssignments"><i class="fas fa-tasks me-1"></i>Assignments</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#studentMessages"><i class="fas fa-comments me-1"></i>Messages</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#studentResources"><i class="fas fa-book me-1"></i>Resources</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="studentProfile">
                        <div id="studentProfileDetails"></div>
                    </div>
                    <div class="tab-pane fade" id="studentTimetable">
                        <div id="studentTimetableView"></div>
                    </div>
                    <div class="tab-pane fade" id="studentGrades">
                        <canvas id="studentGradesChart" class="mt-3"></canvas>
                        <div id="studentMarksSummary"></div>
                    </div>
                    <div class="tab-pane fade" id="studentProgressReport">
                        <div class="progress-report">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Progress Report - <span id="reportTerm">Term 1</span></h5>
                                <button class="btn btn-primary" onclick="generateProgressReportPDF()">Download PDF</button>
                            </div>
                            <div class="report-section">
                                <h6>Overall Performance</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <p><strong>Average Grade:</strong> <span id="overallAvgGrade">85%</span></p>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 85%"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>Attendance Rate:</strong> <span id="overallAttRate">95%</span></p>
                                        <div class="progress">
                                            <div class="progress-bar bg-info" style="width: 95%"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>Assignments Completed:</strong> <span id="completedAssignments">8/10</span></p>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" style="width: 80%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="report-section">
                                <h6>Subject Breakdown</h6>
                                <table class="table table-striped">
                                    <thead><tr><th>Subject</th><th>Avg Mark</th><th>Progress</th><th>Comments</th></tr></thead>
                                    <tbody id="subjectBreakdown"></tbody>
                                </table>
                            </div>
                            <div class="report-section">
                                <h6>Teacher Comments</h6>
                                <div id="teacherComments"></div>
                            </div>
                            <div class="report-section">
                                <h6>Goals & Recommendations</h6>
                                <ul id="goalsList">
                                    <li>Improve math scores by practicing daily</li>
                                    <li>Maintain high attendance</li>
                                    <li>Complete all assignments on time</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="studentCalendar">
                        <div class="calendar">
                            <div class="calendar-header">
                                <button class="btn btn-outline-light" onclick="prevMonth()"><i class="fas fa-chevron-left"></i></button>
                                <h5 id="calendarTitle">November 2025</h5>
                                <button class="btn btn-outline-light" onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="calendar-days">
                                <div class="calendar-day fw-bold">Sun</div>
                                <div class="calendar-day fw-bold">Mon</div>
                                <div class="calendar-day fw-bold">Tue</div>
                                <div class="calendar-day fw-bold">Wed</div>
                                <div class="calendar-day fw-bold">Thu</div>
                                <div class="calendar-day fw-bold">Fri</div>
                                <div class="calendar-day fw-bold">Sat</div>
                                <div id="calendarGrid"></div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="studentAssignments">
                        <div id="assignmentsList"></div>
                    </div>
                    <div class="tab-pane fade" id="studentMessages">
                        <div id="studentMessageHistory"></div>
                    </div>
                    <div class="tab-pane fade" id="studentResources">
                        <div id="studentContentList"></div>
                    </div>
                </div>
            </section>

            <!-- Student Information System (unchanged) -->
            <section id="students" class="section d-none">
                <!-- Previous student content -->
            </section>

            <!-- Other sections unchanged -->
            <!-- ... -->

        </div>
    </div>

    <!-- Other modals unchanged -->
    <!-- ... -->

    <script>
        // Global Data (add calendar events)
        let calendarEvents = []; // Student-specific events
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Enhanced Login for Students
        function login() {
            // ... previous logic
            if (currentUser.role === 'student') {
                // Find student by username
                currentStudent = students.find(s => s.name.toLowerCase() === currentUser.username.toLowerCase()) || students[0]; // Demo fallback
                // Demo calendar events
                calendarEvents = [
                    {date: '2025-11-15', title: 'Math Exam', type: 'exam', description: 'Mid-term math assessment'},
                    {date: '2025-11-20', title: 'Assignment Due', type: 'assignment', description: 'Science project submission'},
                    {date: '2025-11-25', title: 'Parent-Teacher Meeting', type: 'event', description: 'Meet with advisor'},
                    {date: '2025-12-01', title: 'Science Quiz', type: 'quiz', description: 'Chapter 5 review'}
                ];
            }
            // ... rest
        }

        // Student Dashboard Functions
        function showSection(section) {
            // ... previous
            if (section === 'studentDashboard' && currentUser.role === 'student') {
                renderStudentDashboard();
            }
        }

        function renderStudentDashboard() {
            document.getElementById('studentWelcome').textContent = currentStudent ? currentStudent.name : currentUser.username;
            // Quick Stats
            document.getElementById('studentTodayAtt').textContent = getTodayAttendance(currentStudent.id) ? 'Present' : 'Absent';
            document.getElementById('studentTodayAtt').className = getTodayAttendance(currentStudent.id) ? 'text-success' : 'text-danger';
            document.getElementById('studentAvgGrade').textContent = `${calculateChildAvgGrade(currentStudent.id)}%`;
            document.getElementById('pendingAssignments').textContent = getPendingAssignmentsCount(currentStudent.id);
            document.getElementById('upcomingExamsStudent').textContent = getUpcomingExamsForStudent(currentStudent.id).length;
            // Load tabs
            renderStudentProfile();
            renderStudentTimetable();
            renderStudentGrades();
            renderStudentProgressReport();
            renderStudentCalendar();
            renderStudentAssignments();
            renderStudentMessages();
            renderStudentResources();
        }

        // ... previous render functions ...

        function renderStudentProgressReport() {
            if (!currentStudent) return;
            const studentMarks = Object.entries(marks).flatMap(([examId, marksObj]) => 
                Object.entries(marksObj).map(([studentId, mark]) => ({examId: parseInt(examId), studentId: parseInt(studentId), mark}))
            ).filter(m => m.studentId === currentStudent.id && typeof m.mark === 'number');
            const overallAvg = studentMarks.length ? studentMarks.reduce((sum, m) => sum + m.mark, 0) / studentMarks.length : 0;
            const overallAtt = Math.floor(Math.random() * 10 + 90); // Demo
            const completedAss = '8/10'; // Demo
            document.getElementById('overallAvgGrade').textContent = `${overallAvg.toFixed(1)}%`;
            document.getElementById('overallAttRate').textContent = `${overallAtt}%`;
            document.getElementById('completedAssignments').textContent = completedAss;
            // Subject Breakdown (demo subjects)
            const subjects = ['Math', 'Science', 'English', 'History'];
            document.getElementById('subjectBreakdown').innerHTML = subjects.map(sub => `
                <tr>
                    <td>${sub}</td>
                    <td>${Math.floor(Math.random() * 20 + 80)}%</td>
                    <td><div class="progress"><div class="progress-bar" style="width: ${Math.floor(Math.random() * 20 + 80)}%"></div></div></td>
                    <td>Keep up the good work!</td>
                </tr>
            `).join('');
            // Teacher Comments (demo)
            document.getElementById('teacherComments').innerHTML = `
                <blockquote class="blockquote">
                    <p>"Excellent progress in all subjects. Continue to challenge yourself!"</p>
                    <footer class="blockquote-footer">Ms. Smith, Advisor</footer>
                </blockquote>
            `;
            document.getElementById('goalsList').innerHTML = `
                <li>Improve math scores by practicing daily</li>
                <li>Maintain high attendance</li>
                <li>Complete all assignments on time</li>
                <li>Participate more in class discussions</li>
            `;
        }

        function renderStudentCalendar() {
            renderCalendar();
        }

        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            document.getElementById('calendarTitle').textContent = firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            let html = '';
            for (let i = 0; i < 42; i++) { // 6 weeks
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dayClass = date.getMonth() !== currentMonth ? 'text-muted' : '';
                const dayNum = date.getDate();
                const events = calendarEvents.filter(e => e.date === date.toISOString().split('T')[0]);
                let eventHtml = '';
                if (events.length) {
                    eventHtml = events.map(e => `<div class="calendar-event">${e.title}</div>`).join('');
                }
                html += `<div class="calendar-day ${dayClass}">${dayNum}${eventHtml}</div>`;
            }
            document.getElementById('calendarGrid').innerHTML = html;
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar();
        }

        function generateProgressReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const studentName = currentStudent.name;
            doc.text(`Progress Report for ${studentName}`, 105, 20, { align: 'center' });
            doc.text(`Term: 1 | Date: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            doc.text('Overall Performance', 20, 50);
            doc.text(`Average Grade: ${document.getElementById('overallAvgGrade').textContent}`, 20, 60);
            doc.text(`Attendance Rate: ${document.getElementById('overallAttRate').textContent}`, 20, 70);
            doc.text('Subject Breakdown', 20, 90);
            // Add more sections...
            doc.text('Teacher Comments: Excellent progress!', 20, 120);
            doc.text('Goals: Improve math, maintain attendance', 20, 130);
            doc.save(`progress-report-${studentName}-${Date.now()}.pdf`);
        }

        // ... previous helper functions ...

        // Role visibility update
        function updateRoleVisibility() {
            // ... previous
            document.querySelectorAll('.student-only').forEach(el => el.style.display = currentUser.role === 'student' ? 'block' : 'none');
        }

        // Init
        function initApp() {
            // ... previous
            updateRoleVisibility();
            if (currentUser.role === 'student') renderStudentDashboard();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ... previous
        });
    </script>
</body>
</html>
