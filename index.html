<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced School Management System (ASMS) - Bophelong Independent School</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe SDK -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            height: 100vh;
            position: fixed;
            width: 260px;
            padding: 20px;
            overflow-y: auto;
            transition: width 0.3s ease;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link {
            color: #fff;
            font-weight: 500;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 10px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }
        .content {
            margin-left: 260px;
            padding: 40px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        .content.expanded { margin-left: 70px; }
        .card-metric {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .card-metric:hover { transform: translateY(-8px); }
        .table {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .table th { background: rgba(255, 255, 255, 0.2); color: #fff; }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            color: #333;
        }
        .btn-toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 270px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
        }
        .btn-toggle-sidebar.expanded { left: 80px; }
        #notificationBell {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        .admin-only { display: block; }
        .teacher-only { display: none; }
        .parent-only { display: none; }
        .student-only { display: none; }
        .non-student { display: block; }
        .dark-mode { filter: brightness(0.8); }
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }
        .login-card {
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
        }
        .login-title {
            font-weight: 700;
            color: #1e3c72;
            text-align: center;
        }
        .report-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }
        .timetable-cell {
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin: 2px;
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
        }
        .chat-user { background: rgba(255, 255, 255, 0.2); }
        .chat-assistant { background: rgba(0, 255, 0, 0.1); }
        .editable { cursor: pointer; }
        .editable:hover { background: rgba(255, 255, 255, 0.2); }
        .payslip-preview { background: white; color: black; padding: 20px; border-radius: 10px; }
        .hr-chart { height: 300px; }
        .leave-calendar { height: 400px; }
        .applicant-stage { cursor: pointer; }
        .cert-expiry { color: #ffc107; }
        .cert-expired { color: #dc3545; }
        .lesson-plan { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 10px 0; }
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 70px; }
            .btn-toggle-sidebar { left: 80px; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x text-primary mb-3"></i>
                <h3 class="login-title">ASMS - Bophelong Independent School</h3>
                <p class="text-muted">Advanced School Management System</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <button type="button" class="btn btn-secondary w-100 mb-3" onclick="biometricLogin()">
                    <i class="fas fa-fingerprint me-2"></i>Biometric Login
                </button>
                <div class="login-demo">
                    <p class="mb-1"><strong>Admin:</strong> admin / admin123</p>
                    <p class="mb-1"><strong>Teacher:</strong> teacher / teacher123</p>
                    <p class="mb-1"><strong>Parent:</strong> parent / parent123</p>
                    <p class="mb-0"><strong>Student:</strong> student / student123</p>
                </div>
            </form>
        </div>
    </div>
    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-warning rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>
        <button class="btn btn-sm btn-light btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="sidebar">
            <h4 class="mb-4 text-center"><i class="fas fa-school me-2"></i><span class="nav-text">ASMS</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only non-student"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
                <li class="non-student"><a href="#admission" class="nav-link" onclick="showSection('admission')"><i class="fas fa-user-plus me-2"></i><span class="nav-text">Admission</span></a></li>
                <li class="non-student"><a href="#students" class="nav-link" onclick="showSection('students')"><i class="fas fa-users me-2"></i><span class="nav-text">Student Info</span></a></li>
                <li class="non-student"><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
                <li class="non-student"><a href="#fees" class="nav-link" onclick="showSection('fees')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">Fee Management</span></a></li>
                <li class="teacher-only non-student"><a href="#timetable" class="nav-link" onclick="showSection('timetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Timetable</span></a></li>
                <li class="teacher-only non-student"><a href="#teachers" class="nav-link" onclick="showSection('teachers')"><i class="fas fa-chalkboard-teacher me-2"></i><span class="nav-text">Advanced Teachers</span></a></li>
                <li class="teacher-only non-student"><a href="#exams" class="nav-link" onclick="showSection('exams')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Examinations</span></a></li>
                <li class="admin-only non-student"><a href="#hr" class="nav-link" onclick="showSection('hr')"><i class="fas fa-user-tie me-2"></i><span class="nav-text">HR Management</span></a></li>
                <li class="non-student"><a href="#communication" class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments me-2"></i><span class="nav-text">Communication</span></a></li>
                <li class="admin-only non-student"><a href="#content" class="nav-link" onclick="showSection('content')"><i class="fas fa-book me-2"></i><span class="nav-text">Content</span></a></li>
                <li class="admin-only non-student"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Reports</span></a></li>
                <li class="admin-only non-student"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="student-only"><a href="#aiResearch" class="nav-link" onclick="showSection('aiResearch')"><i class="fas fa-robot me-2"></i><span class="nav-text">AI Research</span></a></li>
                <li class="parent-only"><a href="#parentPortal" class="nav-link" onclick="showSection('parentPortal')"><i class="fas fa-home me-2"></i><span class="nav-text">Parent Portal</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
        <div class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section">
                <h2>School Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Students</h5><h3 id="totalStudents">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's Attendance</h5><h3 id="todayAttendance">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Fees</h5><h3 id="pendingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Upcoming Exams</h5><h3 id="upcomingExams">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaffDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeavesDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositionsDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Performance</h5><h3 id="avgPerformanceDash">0%</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4"></canvas>
            </section>
            <!-- Admission Management -->
            <section id="admission" class="section d-none">
                <h2>Admission Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddAdmissionModal()">New Application</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkAdmissionModal()">Bulk Import (CSV/Excel)</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search admissions..." id="admissionSearch">
                    <button class="btn btn-outline-secondary" onclick="searchAdmissions()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="admissionTable"></tbody>
                </table>
            </section>
            <!-- Student Information System -->
            <section id="students" class="section d-none">
                <h2>Student Information System</h2>
                <button class="btn btn-primary mb-3" onclick="showAddStudentModal()">Add Student</button>
                <button class="btn btn-info mb-3" onclick="showBulkStudentModal()">Bulk Import Students (CSV/Excel)</button>
                <button class="btn btn-info mb-3" onclick="importClassListFromPDF()">Import Class List from MX-4051 PDF</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search student..." id="studentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchStudents()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Parent</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="studentTable"></tbody>
                </table>
            </section>
            <!-- Attendance Management -->
            <section id="attendance" class="section d-none">
                <h2>Attendance Management</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="date" id="attendanceDate" class="form-control" onchange="loadAttendance()">
                    </div>
                    <div class="col-md-4">
                        <select id="attendanceClass" class="form-control" onchange="loadAttendance()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success mb-3" onclick="showBulkAttendanceModal()">Bulk Mark Attendance</button>
                <button class="btn btn-info mb-3" onclick="syncBiometricAttendance()">Sync Biometric Attendance</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </section>
            <!-- Fee Management -->
            <section id="fees" class="section d-none">
                <h2>Fee Management</h2>
                <button class="btn btn-primary mb-3" onclick="showGenerateInvoiceModal()">Generate Invoice</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkUploadFeesModal()">Bulk Import (CSV/Excel)</button>
                <button class="btn btn-warning mb-3" onclick="sendFeeReminders()">Send Reminders</button>
                <div class="row mb-3">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Collected</h5><h3 id="totalCollected">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Outstanding</h5><h3 id="outstandingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Overdue</h5><h3 id="overdueFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Payment Rate</h5><h3 id="paymentRate">0%</h3></div></div>
                </div>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search fees..." id="feeSearch">
                    <button class="btn btn-outline-secondary" onclick="searchFees()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Student</th><th>Amount</th><th>Due Date</th><th>Paid Date</th><th>Status</th><th>Receipt</th><th>Actions</th></tr></thead>
                    <tbody id="feeTable"></tbody>
                </table>
                <div id="feeHistory" class="mt-4"></div>
            </section>
            <!-- Timetable Management -->
            <section id="timetable" class="section d-none">
                <h2>Timetable Management</h2>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="timetableGrade" class="form-control" onchange="loadTimetable()">
                            <option value="">Select Grade</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="timetableTeacher" class="form-control" onchange="highlightTeacherSchedule()">
                            <option value="">Select Teacher</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="showAddTimeSlotModal()">Add Time Slot</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning" onclick="checkTimetableConflicts()">Check Conflicts</button>
                    </div>
                </div>
                <div id="timetableContainer"></div>
            </section>
            <!-- Advanced Teachers Module -->
            <section id="teachers" class="section d-none teacher-only">
                <h2>Advanced Teachers Module</h2>
                <ul class="nav nav-tabs mb-3" id="teachersTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#lesson-plans" onclick="renderLessonPlans()">Lesson Plans</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#grading" onclick="renderGrading()">Grading</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#resources" onclick="renderResources()">Resources</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#student-progress" onclick="renderStudentProgress()">Student Progress</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="lesson-plans">
                        <button class="btn btn-primary mb-3" onclick="showAddLessonPlanModal()">Add Lesson Plan</button>
                        <div id="lessonPlansList"></div>
                    </div>
                    <div class="tab-pane fade" id="grading">
                        <button class="btn btn-primary mb-3" onclick="showAddGradeModal()">Add Grade</button>
                        <select id="gradingClass" class="form-control mb-3" onchange="loadGrading()">
                            <option value="">Select Class</option>
                        </select>
                        <table class="table table-striped">
                            <thead><tr><th>Student</th><th>Subject</th><th>Grade</th><th>Comments</th><th>Actions</th></tr></thead>
                            <tbody id="gradingTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="resources">
                        <button class="btn btn-primary mb-3" onclick="showAddResourceModal()">Add Resource</button>
                        <div id="resourcesList"></div>
                    </div>
                    <div class="tab-pane fade" id="student-progress">
                        <select id="progressStudent" class="form-control mb-3" onchange="loadStudentProgress()">
                            <option value="">Select Student</option>
                        </select>
                        <canvas id="progressChart" class="mt-4"></canvas>
                        <div id="progressDetails"></div>
                    </div>
                </div>
            </section>
            <!-- Examination Management -->
            <section id="exams" class="section d-none">
                <h2>Examination Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddExamModal()">Schedule Exam</button>
                <button class="btn btn-info mb-3" onclick="showEnterMarksModal()">Enter Marks</button>
                <button class="btn btn-success mb-3" onclick="generateAllReportCards()">Generate All Report Cards</button>
                <button class="btn btn-warning mb-3" onclick="generateHallTickets()">Generate Hall Tickets</button>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="examGradeFilter" class="form-control" onchange="renderExams()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="examSubjectFilter" class="form-control" placeholder="Filter by Subject" oninput="debounce(renderExams, 300)()">
                    </div>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Exam</th><th>Date</th><th>Subject</th><th>Grade</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="examTable"></tbody>
                </table>
                <div id="marksEntry" class="mt-4 d-none">
                    <h3>Enter Marks for <span id="marksExamName"></span></h3>
                    <table class="table table-striped">
                        <thead><tr><th>Student</th><th>Marks</th></tr></thead>
                        <tbody id="marksTable"></tbody>
                    </table>
                    <button class="btn btn-primary" onclick="saveMarks()">Save</button>
                </div>
            </section>
            <!-- Enhanced HR Management -->
            <section id="hr" class="section d-none admin-only">
                <h2>Human Resource Management</h2>
                <ul class="nav nav-tabs mb-3" id="hrTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#hr-staff" onclick="renderStaff()">Staff</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-payroll" onclick="renderPayrolls()">Payroll</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-leaves" onclick="renderLeaves()">Leaves</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-performance" onclick="renderReviews()">Performance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-recruitment" onclick="renderJobs()">Recruitment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-audit" onclick="renderAudit()">Audit Trail</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="hr-staff">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddStaffModal()">Add Staff</button>
                                <button class="btn btn-secondary ms-2" onclick="syncStaffBiometric()">Sync Biometric</button>
                                <button class="btn btn-info ms-2" onclick="generateStaffReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Search staff..." id="staffSearch" oninput="debounce(renderStaff, 300)()">
                                    <select id="staffFilterRole" class="form-select" style="max-width: 150px;" onchange="renderStaff()">
                                        <option value="">All Roles</option>
                                        <option value="Teacher">Teacher</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Support">Support</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaff">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Active</h5><h3 id="activeStaff">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Salary</h5><h3 id="avgSalary">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Expiring Certs</h5><h3 id="expiringCerts">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Department</th><th>Salary</th><th>Tax #</th><th>UIF #</th><th>Cert Expiry</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="staffTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-payroll">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddPayrollModal()">Add Payroll</button>
                                <button class="btn btn-info ms-2" onclick="generatePayroll()">Generate Payroll</button>
                                <button class="btn btn-success ms-2" onclick="exportPayrollToExcel()">Export Payroll</button>
                                <button class="btn btn-warning ms-2" onclick="calculateCompliance()">Check Compliance</button>
                            </div>
                            <div class="col-md-6">
                                <input type="month" id="payrollMonthFilter" class="form-control" onchange="renderPayrolls()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Payroll</h5><h3 id="totalPayroll">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Deductions</h5><h3 id="totalDeductions">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Net Payroll</h5><h3 id="netPayroll">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Compliance Score</h5><h3 id="complianceScore">0%</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Month</th><th>Salary</th><th>Deductions</th><th>Tax</th><th>UIF</th><th>Net</th><th>Actions</th></tr></thead>
                            <tbody id="payrollTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-leaves">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddLeaveModal()">Add Leave Request</button>
                                <button class="btn btn-info ms-2" onclick="generateLeaveReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="date" id="leaveDateFilter" class="form-control" onchange="renderLeaves()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Requests</h5><h3 id="totalLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending</h5><h3 id="pendingLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Approved</h5><h3 id="approvedLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Rejected</h5><h3 id="rejectedLeaves">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Type</th><th>Date</th><th>Days</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="leavesTable"></tbody>
                        </table>
                        <canvas id="leaveChart" class="mt-4 hr-chart"></canvas>
                    </div>
                    <div class="tab-pane fade" id="hr-performance">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddReviewModal()">Add Review</button>
                                <button class="btn btn-info ms-2" onclick="generatePerformanceReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="date" id="reviewDateFilter" class="form-control" onchange="renderReviews()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Score</h5><h3 id="avgScore">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Reviews</h5><h3 id="totalReviews">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Goals Achieved</h5><h3 id="goalsAchieved">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Feedback</h5><h3 id="pendingFeedback">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Date</th><th>Score</th><th>Comments</th><th>Actions</th></tr></thead>
                            <tbody id="reviewsTable"></tbody>
                        </table>
                        <canvas id="performanceChart" class="mt-4 hr-chart"></canvas>
                    </div>
                    <div class="tab-pane fade" id="hr-recruitment">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddJobModal()">Add Job</button>
                                <button class="btn btn-success ms-2" onclick="showApplyJobModal()">Apply</button>
                                <button class="btn btn-info ms-2" onclick="generateRecruitmentReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" placeholder="Search jobs..." id="jobSearch" oninput="debounce(renderJobs, 300)()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositions">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Applications</h5><h3 id="totalApplications">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Interviews Scheduled</h5><h3 id="interviewsScheduled">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Hire Rate</h5><h3 id="hireRate">0%</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Title</th><th>Department</th><th>Applications</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="jobTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-audit">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-info" onclick="generateAuditReport()">Generate Report</button>
                                <button class="btn btn-success ms-2" onclick="exportAuditToExcel()">Export</button>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="date" id="auditDateFilter" class="form-control" onchange="renderAudit()">
                                    <select id="auditActionFilter" class="form-select" style="max-width: 150px;" onchange="renderAudit()">
                                        <option value="">All Actions</option>
                                        <option value="Update">Update</option>
                                        <option value="Delete">Delete</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Entries</h5><h3 id="totalAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's</h5><h3 id="todayAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>High Risk</h5><h3 id="highRiskAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Compliance Issues</h5><h3 id="complianceIssues">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Details</th><th>Risk</th></tr></thead>
                            <tbody id="auditTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <!-- Communication -->
            <section id="communication" class="section d-none non-student">
                <h2>Communication</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="showSendMessageModal()">Send Message</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success" onclick="viewAnnouncements()">View Announcements</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-info" onclick="startChat()">Live Chat</button>
                    </div>
                </div>
                <div id="messagesContainer"></div>
            </section>
            <!-- Content Management -->
            <section id="content" class="section d-none">
                <h2>Content Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddContentModal()">Add Content</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search content..." id="contentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchContent()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="contentTable"></tbody>
                </table>
            </section>
            <!-- Reports -->
            <section id="reports" class="section d-none admin-only">
                <h2>Reports</h2>
                <select id="reportType" class="form-select mb-3" style="width: auto;">
                    <option value="attendance">Attendance Report</option>
                    <option value="fees">Fee Report</option>
                    <option value="exams">Exam Report</option>
                    <option value="hr">HR Report</option>
                </select>
                <button class="btn btn-primary mb-3" onclick="generateReport()">Generate</button>
                <button class="btn btn-success mb-3" onclick="exportReport()">Export</button>
                <div id="reportOutput" class="d-none"></div>
            </section>
            <!-- Settings -->
            <section id="settings" class="section d-none admin-only">
                <h2>Settings</h2>
                <div class="row">
                    <div class="col-md-6">
                        <h5>SMS Integration (WinSMS)</h5>
                        <div class="mb-3">
                            <label>Username</label>
                            <input type="text" id="smsUsername" class="form-control" placeholder="WinSMS Username">
                        </div>
                        <div class="mb-3">
                            <label>Password</label>
                            <input type="password" id="smsPassword" class="form-control" placeholder="WinSMS Password">
                        </div>
                        <button class="btn btn-primary" onclick="saveSMSSettings()">Save SMS Settings</button>
                    </div>
                    <div class="col-md-6">
                        <h5>HR Settings</h5>
                        <div class="mb-3">
                            <label>Annual Leave Days</label>
                            <input type="number" id="annualLeaveDays" class="form-control" value="21">
                        </div>
                        <div class="mb-3">
                            <label>UIF Rate (%)</label>
                            <input type="number" id="uifRate" class="form-control" value="1" step="0.1">
                        </div>
                        <button class="btn btn-primary" onclick="updateHRSettings()">Update HR Settings</button>
                    </div>
                </div>
                <div class="mt-4">
                    <button class="btn btn-secondary" onclick="backupData()">Backup Data</button>
                    <button class="btn btn-warning ms-2" onclick="restoreData()">Restore Data</button>
                </div>
            </section>
            <!-- Parent Portal -->
            <section id="parentPortal" class="section d-none parent-only">
                <h2>Parent Portal</h2>
                <div id="parentChildInfo"></div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4>Attendance</h4>
                        <div id="parentAttendance"></div>
                    </div>
                    <div class="col-md-6">
                        <h4>Fees</h4>
                        <div id="parentFees"></div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4>Grades</h4>
                        <div id="parentGrades"></div>
                    </div>
                    <div class="col-md-6">
                        <h4>Announcements</h4>
                        <div id="parentAnnouncements"></div>
                    </div>
                </div>
            </section>
            <!-- AI Research for Students -->
            <section id="aiResearch" class="section d-none student-only">
                <h2>AI Research Assistant</h2>
                <div class="mb-3">
                    <input type="text" id="researchQuery" class="form-control" placeholder="Ask a research question...">
                    <button class="btn btn-primary mt-2" onclick="researchWithAI()">Research</button>
                </div>
                <div id="researchResults"></div>
            </section>
            <!-- Modals -->
            <!-- New Admission Modal -->
            <div class="modal fade" id="addAdmissionModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">New Admission</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="admissionName" class="form-control mb-2" placeholder="Name">
                            <input type="text" id="admissionGrade" class="form-control mb-2" placeholder="Grade">
                            <input type="text" id="admissionUsername" class="form-control mb-2" placeholder="Student Username">
                            <input type="password" id="admissionPassword" class="form-control mb-2" placeholder="Student Password">
                            <select id="admissionStatus" class="form-control mb-2">
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveAdmission()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Student Modal -->
            <div class="modal fade" id="addStudentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Student</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="studentName" class="form-control mb-2" placeholder="Full Name">
                            <input type="text" id="studentGrade" class="form-control mb-2" placeholder="Grade">
                            <input type="text" id="studentParent" class="form-control mb-2" placeholder="Parent Name">
                            <input type="text" id="studentAccession" class="form-control mb-2" placeholder="Accession Number">
                            <input type="text" id="studentEducator" class="form-control mb-2" placeholder="Educator">
                            <select id="studentStatus" class="form-control mb-2">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveStudent()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Student Import Modal -->
            <div class="modal fade" id="bulkStudentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Import Students (CSV/Excel)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="studentFile" class="form-control" accept=".csv,.xlsx">
                            <div id="studentPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkStudents()">Import</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Attendance Marking Modal -->
            <div class="modal fade" id="attendanceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Mark Attendance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="attendanceStudentId">
                            <p id="attendanceStudentName"></p>
                            <input type="date" id="attendanceModalDate" class="form-control mb-2">
                            <select id="attendanceStatus" class="form-control mb-2">
                                <option value="Present">Present</option>
                                <option value="Absent">Absent</option>
                                <option value="Late">Late</option>
                            </select>
                            <textarea id="attendanceNotes" class="form-control" placeholder="Notes"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveAttendanceMark()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Attendance Modal -->
            <div class="modal fade" id="bulkAttendanceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Mark Attendance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="date" id="bulkAttendanceDate" class="form-control mb-2">
                            <select id="bulkStatus" class="form-control mb-2">
                                <option value="Present">All Present</option>
                                <option value="Absent">All Absent</option>
                            </select>
                            <select id="bulkClass" class="form-control mb-2">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="bulkMarkAttendance()">Mark</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Generate Invoice Modal -->
            <div class="modal fade" id="generateInvoiceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Generate Invoice</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="invoiceStudent" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <input type="number" id="invoiceAmount" class="form-control mb-2" placeholder="Amount (R)">
                            <input type="date" id="invoiceDueDate" class="form-control mb-2">
                            <textarea id="invoiceDescription" class="form-control mb-2" placeholder="Description"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveInvoice()">Generate</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Upload Fees Modal -->
            <div class="modal fade" id="bulkUploadFeesModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Upload Fees (CSV/Excel)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="feesFile" class="form-control" accept=".csv,.xlsx">
                            <div id="feesPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkFees()">Upload</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Time Slot Modal -->
            <div class="modal fade" id="addTimeSlotModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Time Slot</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="timeSlotGrade" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="timeSlotDay" class="form-control mb-2">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                            </select>
                            <input type="time" id="timeSlotTime" class="form-control mb-2">
                            <input type="text" id="timeSlotSubject" class="form-control mb-2" placeholder="Subject/Teacher">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveTimeSlot()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Exam Modal -->
            <div class="modal fade" id="addExamModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Schedule Exam</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="examName" class="form-control mb-2" placeholder="Exam Name">
                            <input type="date" id="examDate" class="form-control mb-2">
                            <input type="text" id="examSubject" class="form-control mb-2" placeholder="Subject">
                            <select id="examGrade" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="examStatus" class="form-control mb-2">
                                <option value="Scheduled">Scheduled</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveExam()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Payroll Modal -->
            <div class="modal fade" id="addPayrollModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Payroll</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="payrollStaff" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <input type="month" id="payrollMonth" class="form-control mb-2">
                            <input type="number" id="payrollSalary" class="form-control mb-2" placeholder="Gross Salary (R)">
                            <input type="number" id="payrollDeductions" class="form-control mb-2" placeholder="Deductions (R)">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="savePayroll()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Send Message Modal -->
            <div class="modal fade" id="sendMessageModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Send Message</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="messageRecipient" class="form-control mb-2">
                                <option value="all-students">All Students</option>
                                <option value="all-parents">All Parents</option>
                                <option value="all-staff">All Staff</option>
                            </select>
                            <textarea id="messageText" class="form-control mb-2" placeholder="Message text"></textarea>
                            <div class="form-check">
                                <input type="checkbox" id="sendViaSMS" class="form-check-input">
                                <label class="form-check-label">Send via SMS (WinSMS)</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Content Modal -->
            <div class="modal fade" id="addContentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Content</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="contentTitle" class="form-control mb-2" placeholder="Title">
                            <select id="contentType" class="form-control mb-2">
                                <option value="Article">Article</option>
                                <option value="Video">Video</option>
                                <option value="Document">Document</option>
                            </select>
                            <textarea id="contentBody" class="form-control mb-2" placeholder="Content"></textarea>
                            <input type="file" id="contentFile" class="form-control mb-2">
                            <select id="contentStatus" class="form-control">
                                <option value="Draft">Draft</option>
                                <option value="Published">Published</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveContent()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Admission Modal -->
            <div class="modal fade" id="bulkAdmissionModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Import Admissions (CSV/Excel)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="admissionsFile" class="form-control" accept=".csv,.xlsx">
                            <div id="admissionsPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkAdmissions()">Import</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Staff Modal -->
            <div class="modal fade" id="addStaffModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="staffModalTitle">Add Staff</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="staffName" class="form-control mb-2" placeholder="Full Name">
                            <select id="staffRole" class="form-control mb-2">
                                <option value="Teacher">Teacher</option>
                                <option value="Admin">Admin</option>
                                <option value="Support">Support</option>
                            </select>
                            <input type="text" id="staffDepartment" class="form-control mb-2" placeholder="Department">
                            <input type="number" id="staffSalary" class="form-control mb-2" placeholder="Salary (R)">
                            <input type="text" id="staffTax" class="form-control mb-2" placeholder="Tax Number">
                            <input type="text" id="staffUif" class="form-control mb-2" placeholder="UIF Number">
                            <input type="date" id="staffCertExpiry" class="form-control mb-2" placeholder="Cert Expiry">
                            <input type="text" id="staffUsername" class="form-control mb-2" placeholder="Staff Username">
                            <input type="password" id="staffPassword" class="form-control mb-2" placeholder="Staff Password">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveStaff()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Leave Modal -->
            <div class="modal fade" id="addLeaveModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Leave Request</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="leaveStaff" class="form-control mb-2"></select>
                            <select id="leaveType" class="form-control mb-2">
                                <option value="Annual">Annual</option>
                                <option value="Sick">Sick</option>
                                <option value="Maternity">Maternity</option>
                            </select>
                            <input type="date" id="leaveDate" class="form-control mb-2">
                            <input type="number" id="leaveDays" class="form-control mb-2" placeholder="Days">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveLeave()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Review Modal -->
            <div class="modal fade" id="addReviewModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Performance Review</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="reviewStaff" class="form-control mb-2"></select>
                            <input type="date" id="reviewDate" class="form-control mb-2">
                            <input type="number" id="reviewScore" class="form-control mb-2" placeholder="Score (0-100)" min="0" max="100">
                            <textarea id="reviewComments" class="form-control mb-2" placeholder="Comments"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveReview()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Job Modal -->
            <div class="modal fade" id="addJobModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="jobModalTitle">Add Job</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="jobTitle" class="form-control mb-2" placeholder="Job Title">
                            <input type="text" id="jobDepartment" class="form-control mb-2" placeholder="Department">
                            <textarea id="jobDescription" class="form-control mb-2" placeholder="Description"></textarea>
                            <select id="jobStatus" class="form-control">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveJob()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Apply Job Modal -->
            <div class="modal fade" id="applyJobModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Apply for Job</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="applyJobSelect" class="form-control mb-2"></select>
                            <input type="text" id="applicantName" class="form-control mb-2" placeholder="Name">
                            <input type="email" id="applicantEmail" class="form-control mb-2" placeholder="Email">
                            <input type="tel" id="applicantPhone" class="form-control mb-2" placeholder="Phone">
                            <textarea id="applicantCoverLetter" class="form-control mb-2" placeholder="Cover Letter"></textarea>
                            <input type="file" id="applicantResume" class="form-control">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="submitApplication()">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Schedule Interview Modal -->
            <div class="modal fade" id="scheduleInterviewModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Schedule Interview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="interviewApplicant" class="form-control mb-2" readonly>
                            <input type="datetime-local" id="interviewDateTime" class="form-control mb-2">
                            <select id="interviewType" class="form-control mb-2">
                                <option value="In-person">In-person</option>
                                <option value="Video">Video</option>
                            </select>
                            <textarea id="interviewNotes" class="form-control" placeholder="Notes"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveInterview()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Lesson Plan Modal -->
            <div class="modal fade" id="addLessonPlanModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Lesson Plan</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="lessonTitle" class="form-control mb-2" placeholder="Title">
                            <select id="lessonSubject" class="form-control mb-2">
                                <option value="">Select Subject</option>
                                <option value="Math">Math</option>
                                <option value="Science">Science</option>
                                <option value="English">English</option>
                            </select>
                            <input type="date" id="lessonDate" class="form-control mb-2">
                            <textarea id="lessonObjectives" class="form-control mb-2" placeholder="Objectives"></textarea>
                            <textarea id="lessonActivities" class="form-control mb-2" placeholder="Activities"></textarea>
                            <textarea id="lessonMaterials" class="form-control mb-2" placeholder="Materials"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveLessonPlan()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Grade Modal -->
            <div class="modal fade" id="addGradeModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Grade</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="gradeStudent" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="gradeSubject" class="form-control mb-2">
                                <option value="">Select Subject</option>
                                <option value="Math">Math</option>
                                <option value="Science">Science</option>
                                <option value="English">English</option>
                            </select>
                            <input type="number" id="gradeScore" class="form-control mb-2" placeholder="Score" min="0" max="100">
                            <textarea id="gradeComments" class="form-control" placeholder="Comments"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveGrade()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Resource Modal -->
            <div class="modal fade" id="addResourceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Resource</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="resourceTitle" class="form-control mb-2" placeholder="Title">
                            <input type="text" id="resourceUrl" class="form-control mb-2" placeholder="URL">
                            <select id="resourceType" class="form-control mb-2">
                                <option value="Document">Document</option>
                                <option value="Video">Video</option>
                                <option value="Link">Link</option>
                            </select>
                            <textarea id="resourceDescription" class="form-control" placeholder="Description"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveResource()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Notifications Modal -->
            <div class="modal fade" id="notificationsModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Notifications</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="notificationContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        var currentUser = null;
        var editingJob = null;
        var editingStaffId = null;
        var editingReviewId = null;
        var students = [];
        var admissions = [];
        var fees = [];
        var timetable = {};
        var exams = [];
        var staff = [];
        var payrolls = [];
        var leaveRequests = [];
        var performanceReviews = [];
        var jobs = [];
        var auditLog = [];
        var contents = [];
        var messages = [];
        var announcements = [];
        var users = [];
        var hrSettings = { annualLeaveDays: 21, uifRate: 0.01 };
        var smsSettings = { username: '', password: '', senderId: 'BophelongSchool' };
        var attendanceRecords = {};
        var lessonPlans = [];
        var grades = [];
        var resources = [];
        var dashboardChart = null;
        var leaveChart = null;
        var performanceChart = null;
        var progressChart = null;
        // MX-4051 PDF Data
        var mx4051Data = [
            { class: '1A', accession: '2890', surname: 'CHAUKE', first_name: 'Nobule', educator: 'K MOGANE' },
            { class: '1A', accession: '2598', surname: 'FATLANA', first_name: 'Retumetse', educator: 'K MOGANE' },
            { class: '1A', accession: '2558', surname: 'KENANA', first_name: 'Dumpho', educator: 'K MOGANE' },
            { class: '1A', accession: '2445', surname: 'LUBENA', first_name: 'Manjela Jama', educator: 'K MOGANE' },
            { class: '1A', accession: '2565', surname: 'MABASOE', first_name: 'Victor', educator: 'K MOGANE' },
            { class: '1A', accession: '2370', surname: 'MAHLANGU', first_name: 'Sandile', educator: 'K MOGANE' },
            { class: '1A', accession: '2540', surname: 'MANCHUD', first_name: 'Khumo', educator: 'K MOGANE' },
            { class: '1A', accession: '2557', surname: 'MATHEBULA', first_name: 'Lungo', educator: 'K MOGANE' },
            { class: '1A', accession: '2597', surname: 'MONDLI', first_name: 'Thepo', educator: 'K MOGANE' },
            { class: '1A', accession: '2570', surname: 'NOZINYANA', first_name: 'Philo', educator: 'K MOGANE' },
            { class: '1A', accession: '2573', surname: 'PHLANE', first_name: 'Outshile', educator: 'K MOGANE' },
            { class: '1A', accession: '2496', surname: 'SAKOMA', first_name: 'Amogelang', educator: 'K MOGANE' },
            { class: '1A', accession: '2533', surname: 'SHUMBA', first_name: 'Zobride', educator: 'K MOGANE' },
            { class: '1A', accession: '20128', surname: 'THOBAKGALE', first_name: 'Aleng', educator: 'K MOGANE' },
            // Add more from other classes...
            { class: '1B', accession: '2542', surname: 'KHUMALO', first_name: 'Meliswe', educator: 'F NCUBE' },
            { class: '1B', accession: '2404', surname: 'MAHLANGU', first_name: 'Abigail', educator: 'F NCUBE' },
            { class: '1B', accession: '2546', surname: 'MAKOLA', first_name: 'Ndithulo', educator: 'F NCUBE' },
            { class: '1B', accession: '2559', surname: 'MANABE', first_name: 'Ningibi', educator: 'F NCUBE' },
            { class: '1B', accession: '2524', surname: 'SEHWANG', first_name: 'Gantile', educator: 'F NCUBE' },
            { class: '1B', accession: '2535', surname: 'YU DA', first_name: 'Massego', educator: 'F NCUBE' },
            { class: '1B', accession: '2545', surname: 'YU DA', first_name: 'Kanga', educator: 'F NCUBE' },
            // Continue for all classes...
            // For brevity, adding a few more
            { class: '2A', accession: '2408', surname: 'CHUMA', first_name: 'Jabu', educator: 'MS MOYO' },
            { class: '2A', accession: '2448', surname: 'LEPHAKU', first_name: 'Outshilemo', educator: 'MS MOYO' },
            { class: '3A', accession: '2211', surname: 'HAMZAT', first_name: 'Mercy', educator: 'R CHWAYO' },
            { class: '4A', accession: '2203', surname: 'AGYAPONG', first_name: 'Princess', educator: 'M KESWA' },
            { class: '5A', accession: '2405', surname: 'BOYS', first_name: 'Gcina', educator: 'NN DONDO' },
            { class: '6A', accession: '2012', surname: 'GUMESHE', first_name: 'Rudo', educator: 'NL TSIMA' },
            { class: '7A', accession: '2323', surname: 'BALOYI', first_name: 'Okoposi', educator: 'NP NTLOLE' },
            { class: '8A', accession: '2153', surname: 'BAMDLE', first_name: 'Michelle', educator: 'MC KGANAKGA' },
            { class: '9A', accession: '2435', surname: 'ARIES', first_name: 'Kayla', educator: 'G TSHILOANE' },
            { class: 'RA', accession: '2598', surname: 'DELEKILE', first_name: 'Boloto', educator: 'SB MALEKA' }
        ];
        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        // Load data from localStorage
        function loadData() {
            students = JSON.parse(localStorage.getItem('students') || '[]');
            admissions = JSON.parse(localStorage.getItem('admissions') || '[]');
            fees = JSON.parse(localStorage.getItem('fees') || '[]');
            timetable = JSON.parse(localStorage.getItem('timetable') || '{}');
            exams = JSON.parse(localStorage.getItem('exams') || '[]');
            staff = JSON.parse(localStorage.getItem('staff') || '[]');
            payrolls = JSON.parse(localStorage.getItem('payrolls') || '[]');
            leaveRequests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
            performanceReviews = JSON.parse(localStorage.getItem('performanceReviews') || '[]');
            jobs = JSON.parse(localStorage.getItem('jobs') || '[]');
            auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');
            contents = JSON.parse(localStorage.getItem('contents') || '[]');
            messages = JSON.parse(localStorage.getItem('messages') || '[]');
            announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            users = JSON.parse(localStorage.getItem('users') || '[]');
            hrSettings = JSON.parse(localStorage.getItem('hrSettings') || JSON.stringify(hrSettings));
            smsSettings = JSON.parse(localStorage.getItem('smsSettings') || JSON.stringify(smsSettings));
            attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
            lessonPlans = JSON.parse(localStorage.getItem('lessonPlans') || '[]');
            grades = JSON.parse(localStorage.getItem('grades') || '[]');
            resources = JSON.parse(localStorage.getItem('resources') || '[]');
            integrateEducatorsAsStaff();
            if (students.length === 0) generateDemoData();
        }
        // Generate demo data
        function generateDemoData() {
            // Demo data if needed
            saveData();
        }
        // Integrate educators from students as staff
        function integrateEducatorsAsStaff() {
            const educators = [...new Set(students.map(s => s.educator).filter(e => e && e !== 'Unknown'))];
            educators.forEach(educator => {
                if (!staff.find(s => s.name === educator)) {
                    const id = Date.now() + Math.random();
                    staff.push({
                        id,
                        name: educator,
                        role: 'Teacher',
                        department: 'Education',
                        salary: 30000,
                        taxNumber: 'T' + Date.now(),
                        uifNumber: 'U' + Date.now(),
                        certExpiry: new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],
                        status: 'Active'
                    });
                    users.push({
                        username: educator.toLowerCase().replace(/\s+/g, '') + Math.floor(Math.random() * 1000),
                        password: 'teacher' + Math.floor(Math.random() * 1000),
                        name: educator,
                        role: 'Teacher'
                    });
                }
            });
            saveData();
        }
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('admissions', JSON.stringify(admissions));
            localStorage.setItem('fees', JSON.stringify(fees));
            localStorage.setItem('timetable', JSON.stringify(timetable));
            localStorage.setItem('exams', JSON.stringify(exams));
            localStorage.setItem('staff', JSON.stringify(staff));
            localStorage.setItem('payrolls', JSON.stringify(payrolls));
            localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
            localStorage.setItem('performanceReviews', JSON.stringify(performanceReviews));
            localStorage.setItem('jobs', JSON.stringify(jobs));
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
            localStorage.setItem('contents', JSON.stringify(contents));
            localStorage.setItem('messages', JSON.stringify(messages));
            localStorage.setItem('announcements', JSON.stringify(announcements));
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('hrSettings', JSON.stringify(hrSettings));
            localStorage.setItem('smsSettings', JSON.stringify(smsSettings));
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            localStorage.setItem('lessonPlans', JSON.stringify(lessonPlans));
            localStorage.setItem('grades', JSON.stringify(grades));
            localStorage.setItem('resources', JSON.stringify(resources));
        }
        // Login function
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            let user = users.find(u => u.username === username && u.password === password);
            if (!user) {
                const fallback = {
                    'admin': { name: 'Admin User', role: 'Admin' },
                    'teacher': { name: 'Teacher User', role: 'Teacher' },
                    'parent': { name: 'Parent User', role: 'Parent' },
                    'student': { name: 'Student User', role: 'Student' }
                }[username];
                if (fallback && password === username + '123') {
                    user = fallback;
                }
            }
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                updateVisibility();
                loadData();
                loadDashboard();
                renderHR();
                populateSelects();
                addNotification('Welcome back, ' + user.name + '!', 'info');
            } else {
                alert('Invalid credentials');
            }
        }
        // Biometric Login
        function biometricLogin() {
            alert('Biometric login simulated. Using default admin login.');
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
            login();
        }
        // Update visibility
        function updateVisibility() {
            if (!currentUser) return;
            const role = currentUser.role.toLowerCase();
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = role === 'admin' ? 'block' : 'none');
            document.querySelectorAll('.teacher-only').forEach(el => el.style.display = role === 'teacher' ? 'block' : 'none');
            document.querySelectorAll('.parent-only').forEach(el => el.style.display = role === 'parent' ? 'block' : 'none');
            document.querySelectorAll('.student-only').forEach(el => el.style.display = role === 'student' ? 'block' : 'none');
            document.querySelectorAll('.non-student').forEach(el => el.style.display = role !== 'student' ? 'block' : 'none');
        }
        // Show section
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
            document.getElementById(section).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.target.closest('a').classList.add('active');
            switch (section) {
                case 'dashboard': loadDashboard(); break;
                case 'admission': renderAdmissions(); break;
                case 'students': renderStudents(); break;
                case 'attendance': loadAttendance(); break;
                case 'fees': renderFees(); break;
                case 'timetable': loadTimetable(); break;
                case 'teachers': renderTeachers(); break;
                case 'exams': renderExams(); break;
                case 'hr': renderHR(); break;
                case 'communication': renderMessages(); break;
                case 'content': renderContents(); break;
                case 'reports': break;
                case 'settings': loadSettings(); break;
                case 'parentPortal': loadParentPortal(); break;
                case 'aiResearch': break;
            }
        }
        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const content = document.querySelector('.content');
            const btn = document.querySelector('.btn-toggle-sidebar');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            btn.classList.toggle('expanded');
        }
        // Logout
        function logout() {
            currentUser = null;
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        // Populate selects
        function populateSelects() {
            // Students
            const studentSelects = document.querySelectorAll('select[id*="Student"], select[id*="student"]');
            studentSelects.forEach(select => {
                if (select.id === 'invoiceStudent') {
                    select.innerHTML = students.map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('');
                }
            });
            // Staff
            const staffSelects = document.querySelectorAll('select[id*="Staff"], select[id*="staff"]');
            staffSelects.forEach(select => {
                select.innerHTML = staff.map(s => `<option value="${s.id}">${s.name} (${s.role})</option>`).join('');
            });
            // Grades
            const gradeSelects = document.querySelectorAll('select[id*="Grade"], select[id*="grade"]');
            gradeSelects.forEach(select => {
                if (select.id === 'timetableGrade' || select.id === 'examGrade' || select.id === 'timeSlotGrade') {
                    select.innerHTML = '<option value="">Select Grade</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
                }
            });
            // Attendance class
            document.getElementById('attendanceClass').innerHTML = '<option value="">All Classes</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            // Bulk class
            document.getElementById('bulkClass').innerHTML = '<option value="">All Classes</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            // Timetable teacher
            document.getElementById('timetableTeacher').innerHTML = '<option value="">Select Teacher</option>' + staff.filter(s => s.role === 'Teacher').map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            // Exam grade filter
            document.getElementById('examGradeFilter').innerHTML = '<option value="">All Grades</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            // Apply job select
            document.getElementById('applyJobSelect').innerHTML = jobs.filter(j => j.status === 'Open').map(j => `<option value="${j.id}">${j.title}</option>`).join('');
            // Leave staff, review staff, payroll staff
            ['leaveStaff', 'reviewStaff', 'payrollStaff'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            });
            // Grading student
            document.getElementById('gradeStudent').innerHTML = students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            // Progress student
            document.getElementById('progressStudent').innerHTML = students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            // Grading class
            document.getElementById('gradingClass').innerHTML = '<option value="">Select Class</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
        }
        // Dashboard
        function loadDashboard() {
            document.getElementById('totalStudents').textContent = students.length;
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendanceRecords[today] || {};
            const present = Object.values(todayAttendance).filter(a => a.status === 'Present').length;
            const attendanceRate = students.length > 0 ? Math.round((present / students.length) * 100) : 0;
            document.getElementById('todayAttendance').textContent = attendanceRate + '%';
            const pendingFeesTotal = fees.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
            document.getElementById('pendingFees').textContent = 'R' + pendingFeesTotal.toLocaleString();
            const upcomingExamsCount = exams.filter(e => new Date(e.date) > new Date() && e.status === 'Scheduled').length;
            document.getElementById('upcomingExams').textContent = upcomingExamsCount;
            document.getElementById('totalStaffDash').textContent = staff.length;
            const pendingLeavesCount = leaveRequests.filter(l => l.status === 'Pending').length;
            document.getElementById('pendingLeavesDash').textContent = pendingLeavesCount;
            document.getElementById('openPositionsDash').textContent = jobs.filter(j => j.status === 'Open').length;
            const avgPerformance = performanceReviews.length > 0 ? Math.round(performanceReviews.reduce((sum, r) => sum + r.score, 0) / performanceReviews.length) : 0;
            document.getElementById('avgPerformanceDash').textContent = avgPerformance + '%';
            // Chart
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            if (dashboardChart) dashboardChart.destroy();
            dashboardChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Students', 'Staff', 'Pending Fees', 'Upcoming Exams'],
                    datasets: [{
                        data: [students.length, staff.length, pendingFeesTotal / 1000, upcomingExamsCount],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                    }]
                },
                options: { responsive: true }
            });
        }
        // Import Class List from MX-4051 PDF
        function importClassListFromPDF() {
            mx4051Data.forEach(data => {
                const id = Date.now() + Math.random();
                const name = `${data.surname}, ${data.first_name}`;
                const grade = data.class;
                const parent = 'Parent ' + data.surname; // Mock
                const accession = data.accession;
                const educator = data.educator;
                if (!students.find(s => s.accession === accession)) {
                    students.push({
                        id,
                        name,
                        grade,
                        parent,
                        status: 'Active',
                        accession,
                        educator
                    });
                }
            });
            saveData();
            renderStudents();
            integrateEducatorsAsStaff();
            addNotification('MX-4051 class list imported successfully', 'success');
        }
        // Teachers Module
        function renderTeachers() {
            // Default to lesson plans
            renderLessonPlans();
        }
        function renderLessonPlans() {
            document.getElementById('lessonPlansList').innerHTML = lessonPlans.map(lp => `
                <div class="lesson-plan">
                    <h5>${lp.title}</h5>
                    <p><strong>Subject:</strong> ${lp.subject} | <strong>Date:</strong> ${lp.date}</p>
                    <p><strong>Objectives:</strong> ${lp.objectives}</p>
                    <p><strong>Activities:</strong> ${lp.activities}</p>
                    <p><strong>Materials:</strong> ${lp.materials}</p>
                    <button class="btn btn-sm btn-warning" onclick="editLessonPlan(${lp.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteLessonPlan(${lp.id})">Delete</button>
                </div>
            `).join('');
        }
        function showAddLessonPlanModal() {
            new bootstrap.Modal(document.getElementById('addLessonPlanModal')).show();
        }
        function saveLessonPlan() {
            const title = document.getElementById('lessonTitle').value;
            const subject = document.getElementById('lessonSubject').value;
            const date = document.getElementById('lessonDate').value;
            const objectives = document.getElementById('lessonObjectives').value;
            const activities = document.getElementById('lessonActivities').value;
            const materials = document.getElementById('lessonMaterials').value;
            if (title && subject && date) {
                const id = Date.now();
                lessonPlans.push({ id, title, subject, date, objectives, activities, materials });
                saveData();
                renderLessonPlans();
                bootstrap.Modal.getInstance(document.getElementById('addLessonPlanModal')).hide();
                addNotification('Lesson plan added', 'success');
            }
        }
        function editLessonPlan(id) {
            const lp = lessonPlans.find(l => l.id === id);
            if (lp) {
                document.getElementById('lessonTitle').value = lp.title;
                document.getElementById('lessonSubject').value = lp.subject;
                document.getElementById('lessonDate').value = lp.date;
                document.getElementById('lessonObjectives').value = lp.objectives;
                document.getElementById('lessonActivities').value = lp.activities;
                document.getElementById('lessonMaterials').value = lp.materials;
                // Override save
                const saveBtn = document.querySelector('#addLessonPlanModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => updateLessonPlan(id);
                new bootstrap.Modal(document.getElementById('addLessonPlanModal')).show();
            }
        }
        function updateLessonPlan(id) {
            const lp = lessonPlans.find(l => l.id === id);
            if (lp) {
                lp.title = document.getElementById('lessonTitle').value;
                lp.subject = document.getElementById('lessonSubject').value;
                lp.date = document.getElementById('lessonDate').value;
                lp.objectives = document.getElementById('lessonObjectives').value;
                lp.activities = document.getElementById('lessonActivities').value;
                lp.materials = document.getElementById('lessonMaterials').value;
                saveData();
                renderLessonPlans();
                addNotification('Lesson plan updated', 'success');
            }
            bootstrap.Modal.getInstance(document.getElementById('addLessonPlanModal')).hide();
            const saveBtn = document.querySelector('#addLessonPlanModal .btn-primary');
            saveBtn.textContent = 'Save';
            saveBtn.onclick = saveLessonPlan;
        }
        function deleteLessonPlan(id) {
            if (confirm('Delete lesson plan?')) {
                lessonPlans = lessonPlans.filter(l => l.id !== id);
                saveData();
                renderLessonPlans();
                addNotification('Lesson plan deleted', 'danger');
            }
        }
        function renderGrading() {
            const classFilter = document.getElementById('gradingClass').value;
            const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
            document.getElementById('gradingTable').innerHTML = filteredStudents.map(s => {
                const studentGrades = grades.filter(g => g.studentId === s.id);
                return `
                    <tr>
                        <td>${s.name}</td>
                        <td>Math</td> <!-- Mock subject -->
                        <td>${studentGrades[0]?.score || ''}</td>
                        <td>${studentGrades[0]?.comments || ''}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="showAddGradeModal(${s.id})">Edit</button></td>
                    </tr>
                `;
            }).join('');
        }
        function showAddGradeModal(studentId) {
            if (studentId) document.getElementById('gradeStudent').value = studentId;
            new bootstrap.Modal(document.getElementById('addGradeModal')).show();
        }
        function saveGrade() {
            const studentId = parseInt(document.getElementById('gradeStudent').value);
            const subject = document.getElementById('gradeSubject').value;
            const score = parseFloat(document.getElementById('gradeScore').value);
            const comments = document.getElementById('gradeComments').value;
            if (studentId && subject && score) {
                const id = Date.now();
                grades.push({ id, studentId, subject, score, comments });
                saveData();
                renderGrading();
                bootstrap.Modal.getInstance(document.getElementById('addGradeModal')).hide();
                addNotification('Grade added', 'success');
            }
        }
        function renderResources() {
            document.getElementById('resourcesList').innerHTML = resources.map(r => `
                <div class="lesson-plan">
                    <h5>${r.title}</h5>
                    <p><strong>Type:</strong> ${r.type} | <strong>URL:</strong> <a href="${r.url}" target="_blank">${r.url}</a></p>
                    <p>${r.description}</p>
                    <button class="btn btn-sm btn-warning" onclick="editResource(${r.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteResource(${r.id})">Delete</button>
                </div>
            `).join('');
        }
        function showAddResourceModal() {
            new bootstrap.Modal(document.getElementById('addResourceModal')).show();
        }
        function saveResource() {
            const title = document.getElementById('resourceTitle').value;
            const url = document.getElementById('resourceUrl').value;
            const type = document.getElementById('resourceType').value;
            const description = document.getElementById('resourceDescription').value;
            if (title && url) {
                const id = Date.now();
                resources.push({ id, title, url, type, description });
                saveData();
                renderResources();
                bootstrap.Modal.getInstance(document.getElementById('addResourceModal')).hide();
                addNotification('Resource added', 'success');
            }
        }
        function editResource(id) {
            // Similar to editLessonPlan
            const r = resources.find(res => res.id === id);
            if (r) {
                document.getElementById('resourceTitle').value = r.title;
                document.getElementById('resourceUrl').value = r.url;
                document.getElementById('resourceType').value = r.type;
                document.getElementById('resourceDescription').value = r.description;
                // Override save
                const saveBtn = document.querySelector('#addResourceModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => {
                    r.title = document.getElementById('resourceTitle').value;
                    r.url = document.getElementById('resourceUrl').value;
                    r.type = document.getElementById('resourceType').value;
                    r.description = document.getElementById('resourceDescription').value;
                    saveData();
                    renderResources();
                    bootstrap.Modal.getInstance(document.getElementById('addResourceModal')).hide();
                    saveBtn.textContent = 'Save';
                    saveBtn.onclick = saveResource;
                };
                new bootstrap.Modal(document.getElementById('addResourceModal')).show();
            }
        }
        function deleteResource(id) {
            if (confirm('Delete resource?')) {
                resources = resources.filter(r => r.id !== id);
                saveData();
                renderResources();
                addNotification('Resource deleted', 'danger');
            }
        }
        function renderStudentProgress() {
            const studentId = parseInt(document.getElementById('progressStudent').value);
            if (studentId) {
                const studentGrades = grades.filter(g => g.studentId === studentId);
                const ctx = document.getElementById('progressChart').getContext('2d');
                if (progressChart) progressChart.destroy();
                progressChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: studentGrades.map(g => g.subject),
                        datasets: [{
                            label: 'Scores',
                            data: studentGrades.map(g => g.score),
                            backgroundColor: '#36A2EB'
                        }]
                    },
                    options: { responsive: true }
                });
                document.getElementById('progressDetails').innerHTML = studentGrades.map(g => `
                    <p><strong>${g.subject}:</strong> ${g.score} - ${g.comments}</p>
                `).join('');
            }
        }
        function loadStudentProgress() {
            renderStudentProgress();
        }
        // Other functions remain the same as before...
        // (Include all other functions from the previous code, like renderAdmissions, saveAdmission, etc.)
        // For brevity, assuming they are included as in the initial code.
        // Add the teachers tabs event listener
        document.addEventListener('DOMContentLoaded', () => {
            const teachersTabs = document.querySelector('#teachersTabs');
            teachersTabs.addEventListener('shown.bs.tab', e => {
                const target = e.target.getAttribute('href');
                if (target === '#lesson-plans') renderLessonPlans();
                if (target === '#grading') renderGrading();
                if (target === '#resources') renderResources();
                if (target === '#student-progress') renderStudentProgress();
            });
            const hrTabs = document.querySelector('#hrTabs');
            hrTabs.addEventListener('shown.bs.tab', e => {
                const target = e.target.getAttribute('href');
                if (target === '#hr-staff') renderStaff();
                if (target === '#hr-payroll') renderPayrolls();
                if (target === '#hr-leaves') renderLeaves();
                if (target === '#hr-performance') renderReviews();
                if (target === '#hr-recruitment') renderJobs();
                if (target === '#hr-audit') renderAudit();
            });
            if (users.length === 0) {
                users = [
                    { username: 'admin', password: 'admin123', name: 'Admin User', role: 'Admin' },
                    { username: 'teacher', password: 'teacher123', name: 'Teacher User', role: 'Teacher' },
                    { username: 'parent', password: 'parent123', name: 'Parent User', role: 'Parent' },
                    { username: 'student', password: 'student123', name: 'Student User', role: 'Student' }
                ];
                saveData();
            }
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        });
        // Add notification function
        function addNotification(message, type = 'info') {
            const badge = document.getElementById('notificationBadge');
            let count = parseInt(badge.textContent) + 1 || 1;
            badge.textContent = count;
            badge.style.display = 'block';
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            notifications.unshift({ id: Date.now(), message, type, timestamp: new Date().toISOString() });
            localStorage.setItem('notifications', JSON.stringify(notifications.slice(0, 50)));
        }
        // Render notifications
        document.getElementById('notificationsModal').addEventListener('show.bs.modal', () => {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            document.getElementById('notificationContent').innerHTML = notifications.map(n => `
                <div class="alert alert-${n.type === 'success' ? 'success' : n.type === 'danger' ? 'danger' : n.type === 'warning' ? 'warning' : 'info'}">
                    ${n.message} <small>${new Date(n.timestamp).toLocaleString()}</small>
                </div>
            `).join('');
            document.getElementById('notificationBadge').style.display = 'none';
            localStorage.removeItem('notifications');
        });

                    <!-- Enter Marks Modal -->
            <div class="modal fade" id="enterMarksModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Enter Marks</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="marksExamSelect" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <table class="table table-striped">
                                <thead><tr><th>Student</th><th>Marks</th></tr></thead>
                                <tbody id="marksEntryTable"></tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveAllMarks()">Save All Marks</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Hall Ticket Modal -->
            <div class="modal fade" id="hallTicketModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Hall Ticket</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="hallTicketContent"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-success" onclick="printHallTicket()">Print</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fee Receipt Modal -->
            <div class="modal fade" id="feeReceiptModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Fee Receipt</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="receiptContent"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-success" onclick="printReceipt()">Print</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Payslip Modal -->
            <div class="modal fade" id="payslipModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Payslip</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body payslip-preview">
                            <div id="payslipContent"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-success" onclick="printPayslip()">Print</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Chat Modal -->
            <div class="modal fade" id="chatModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Live Chat</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
                            <input type="text" id="chatInput" class="form-control" placeholder="Type message...">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Continue from where left off: Implement missing functions for admissions, students, attendance, fees, timetable, exams, HR, etc.

        // Admission Functions
        function showAddAdmissionModal() {
            new bootstrap.Modal(document.getElementById('addAdmissionModal')).show();
        }

        function saveAdmission() {
            const name = document.getElementById('admissionName').value;
            const grade = document.getElementById('admissionGrade').value;
            const username = document.getElementById('admissionUsername').value;
            const password = document.getElementById('admissionPassword').value;
            const status = document.getElementById('admissionStatus').value;
            if (name && grade) {
                const id = Date.now();
                admissions.push({ id, name, grade, username, password, status, dateApplied: new Date().toISOString().split('T')[0] });
                users.push({ username, password, name, role: 'Student' });
                saveData();
                renderAdmissions();
                bootstrap.Modal.getInstance(document.getElementById('addAdmissionModal')).hide();
                addNotification('Admission application saved', 'success');
                // Clear form
                document.getElementById('admissionName').value = '';
                document.getElementById('admissionGrade').value = '';
                document.getElementById('admissionUsername').value = '';
                document.getElementById('admissionPassword').value = '';
            }
        }

        function renderAdmissions() {
            const searchTerm = document.getElementById('admissionSearch').value.toLowerCase();
            const filtered = admissions.filter(a => a.name.toLowerCase().includes(searchTerm) || a.grade.toLowerCase().includes(searchTerm));
            document.getElementById('admissionTable').innerHTML = filtered.map(a => `
                <tr>
                    <td>${a.id}</td>
                    <td>${a.name}</td>
                    <td>${a.grade}</td>
                    <td><span class="badge bg-${a.status === 'Approved' ? 'success' : 'warning'}">${a.status}</span></td>
                    <td><button class="btn btn-sm btn-info">View Docs</button></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editAdmission(${a.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAdmission(${a.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function searchAdmissions() {
            renderAdmissions();
        }

        function editAdmission(id) {
            const adm = admissions.find(a => a.id === id);
            if (adm) {
                document.getElementById('admissionName').value = adm.name;
                document.getElementById('admissionGrade').value = adm.grade;
                document.getElementById('admissionStatus').value = adm.status;
                // Override save for update
                const saveBtn = document.querySelector('#addAdmissionModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => updateAdmission(id);
                new bootstrap.Modal(document.getElementById('addAdmissionModal')).show();
            }
        }

        function updateAdmission(id) {
            const adm = admissions.find(a => a.id === id);
            if (adm) {
                adm.name = document.getElementById('admissionName').value;
                adm.grade = document.getElementById('admissionGrade').value;
                adm.status = document.getElementById('admissionStatus').value;
                saveData();
                renderAdmissions();
                bootstrap.Modal.getInstance(document.getElementById('addAdmissionModal')).hide();
                addNotification('Admission updated', 'success');
                // Reset save
                const saveBtn = document.querySelector('#addAdmissionModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveAdmission;
            }
        }

        function deleteAdmission(id) {
            if (confirm('Delete admission?')) {
                admissions = admissions.filter(a => a.id !== id);
                saveData();
                renderAdmissions();
                addNotification('Admission deleted', 'danger');
            }
        }

        function showBulkAdmissionModal() {
            new bootstrap.Modal(document.getElementById('bulkAdmissionModal')).show();
        }

        function uploadBulkAdmissions() {
            const file = document.getElementById('admissionsFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    json.forEach(row => {
                        if (row.Name && row.Grade) {
                            const id = Date.now() + Math.random();
                            admissions.push({
                                id,
                                name: row.Name,
                                grade: row.Grade,
                                status: row.Status || 'Pending',
                                dateApplied: new Date().toISOString().split('T')[0]
                            });
                        }
                    });
                    saveData();
                    renderAdmissions();
                    addNotification('Bulk admissions imported', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('bulkAdmissionModal')).hide();
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // Student Functions
        function showAddStudentModal() {
            new bootstrap.Modal(document.getElementById('addStudentModal')).show();
        }

        function saveStudent() {
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('studentGrade').value;
            const parent = document.getElementById('studentParent').value;
            const accession = document.getElementById('studentAccession').value;
            const educator = document.getElementById('studentEducator').value;
            const status = document.getElementById('studentStatus').value;
            if (name && grade) {
                const id = Date.now();
                students.push({ id, name, grade, parent, status, accession, educator });
                saveData();
                renderStudents();
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                addNotification('Student added', 'success');
                // Clear form
                document.getElementById('studentName').value = '';
                document.getElementById('studentGrade').value = '';
                document.getElementById('studentParent').value = '';
                document.getElementById('studentAccession').value = '';
                document.getElementById('studentEducator').value = '';
            }
        }

        function renderStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const filtered = students.filter(s => s.name.toLowerCase().includes(searchTerm) || s.grade.toLowerCase().includes(searchTerm));
            document.getElementById('studentTable').innerHTML = filtered.map(s => `
                <tr>
                    <td>${s.accession || s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.grade}</td>
                    <td>${s.parent}</td>
                    <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'secondary'}">${s.status}</span></td>
                    <td><button class="btn btn-sm btn-info">View Docs</button></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editStudent(${s.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent(${s.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function searchStudents() {
            renderStudents();
        }

        function editStudent(id) {
            const stu = students.find(s => s.id === id);
            if (stu) {
                document.getElementById('studentName').value = stu.name;
                document.getElementById('studentGrade').value = stu.grade;
                document.getElementById('studentParent').value = stu.parent;
                document.getElementById('studentAccession').value = stu.accession;
                document.getElementById('studentEducator').value = stu.educator;
                document.getElementById('studentStatus').value = stu.status;
                // Override save
                const saveBtn = document.querySelector('#addStudentModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => updateStudent(id);
                new bootstrap.Modal(document.getElementById('addStudentModal')).show();
            }
        }

        function updateStudent(id) {
            const stu = students.find(s => s.id === id);
            if (stu) {
                stu.name = document.getElementById('studentName').value;
                stu.grade = document.getElementById('studentGrade').value;
                stu.parent = document.getElementById('studentParent').value;
                stu.accession = document.getElementById('studentAccession').value;
                stu.educator = document.getElementById('studentEducator').value;
                stu.status = document.getElementById('studentStatus').value;
                saveData();
                renderStudents();
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                addNotification('Student updated', 'success');
                // Reset save
                const saveBtn = document.querySelector('#addStudentModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveStudent;
            }
        }

        function deleteStudent(id) {
            if (confirm('Delete student?')) {
                students = students.filter(s => s.id !== id);
                saveData();
                renderStudents();
                addNotification('Student deleted', 'danger');
            }
        }

        function showBulkStudentModal() {
            new bootstrap.Modal(document.getElementById('bulkStudentModal')).show();
        }

        function uploadBulkStudents() {
            const file = document.getElementById('studentFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    json.forEach(row => {
                        if (row.Name && row.Grade) {
                            const id = Date.now() + Math.random();
                            students.push({
                                id,
                                name: row.Name,
                                grade: row.Grade,
                                parent: row.Parent || 'Unknown',
                                status: 'Active',
                                accession: row.Accession || '',
                                educator: row.Educator || 'Unknown'
                            });
                        }
                    });
                    saveData();
                    renderStudents();
                    integrateEducatorsAsStaff();
                    addNotification('Bulk students imported', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('bulkStudentModal')).hide();
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // Attendance Functions
        function loadAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const classFilter = document.getElementById('attendanceClass').value;
            const records = attendanceRecords[date] || {};
            let filteredStudents = students;
            if (classFilter) {
                filteredStudents = students.filter(s => s.grade === classFilter);
            }
            document.getElementById('attendanceTable').innerHTML = filteredStudents.map(s => {
                const record = records[s.id] || { status: 'Absent' };
                return `
                    <tr>
                        <td>${s.accession || s.id}</td>
                        <td>${s.name}</td>
                        <td><span class="badge bg-${record.status === 'Present' ? 'success' : record.status === 'Late' ? 'warning' : 'danger'}">${record.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="showAttendanceModal(${s.id}, '${s.name}', '${date}')">Edit</button></td>
                    </tr>
                `;
            }).join('');
        }

        function showAttendanceModal(id, name, date) {
            document.getElementById('attendanceStudentId').value = id;
            document.getElementById('attendanceStudentName').textContent = name;
            document.getElementById('attendanceModalDate').value = date;
            const records = attendanceRecords[date] || {};
            const record = records[id] || { status: 'Absent', notes: '' };
            document.getElementById('attendanceStatus').value = record.status;
            document.getElementById('attendanceNotes').value = record.notes;
            new bootstrap.Modal(document.getElementById('attendanceModal')).show();
        }

        function saveAttendanceMark() {
            const id = parseInt(document.getElementById('attendanceStudentId').value);
            const date = document.getElementById('attendanceModalDate').value;
            const status = document.getElementById('attendanceStatus').value;
            const notes = document.getElementById('attendanceNotes').value;
            if (!attendanceRecords[date]) attendanceRecords[date] = {};
            attendanceRecords[date][id] = { status, notes, timestamp: new Date().toISOString() };
            saveData();
            loadAttendance();
            bootstrap.Modal.getInstance(document.getElementById('attendanceModal')).hide();
            addNotification('Attendance marked', 'success');
        }

        function showBulkAttendanceModal() {
            new bootstrap.Modal(document.getElementById('bulkAttendanceModal')).show();
            document.getElementById('bulkAttendanceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('bulkClass').innerHTML = '<option value="">All Classes</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
        }

        function bulkMarkAttendance() {
            const date = document.getElementById('bulkAttendanceDate').value;
            const status = document.getElementById('bulkStatus').value;
            const classFilter = document.getElementById('bulkClass').value;
            let targetStudents = students;
            if (classFilter) {
                targetStudents = students.filter(s => s.grade === classFilter);
            }
            if (!attendanceRecords[date]) attendanceRecords[date] = {};
            targetStudents.forEach(s => {
                attendanceRecords[date][s.id] = { status, notes: 'Bulk mark', timestamp: new Date().toISOString() };
            });
            saveData();
            loadAttendance();
            bootstrap.Modal.getInstance(document.getElementById('bulkAttendanceModal')).hide();
            addNotification('Bulk attendance marked', 'success');
        }

        function syncBiometricAttendance() {
            // Simulate biometric sync
            const today = new Date().toISOString().split('T')[0];
            if (!attendanceRecords[today]) attendanceRecords[today] = {};
            students.forEach(s => {
                if (!attendanceRecords[today][s.id]) {
                    attendanceRecords[today][s.id] = { status: Math.random() > 0.1 ? 'Present' : 'Absent', notes: 'Biometric sync', timestamp: new Date().toISOString() };
                }
            });
            saveData();
            loadAttendance();
            addNotification('Biometric attendance synced', 'success');
        }

        // Fee Functions
        function showGenerateInvoiceModal() {
            document.getElementById('invoiceStudent').innerHTML = students.map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('');
            new bootstrap.Modal(document.getElementById('generateInvoiceModal')).show();
        }

        function saveInvoice() {
            const studentId = parseInt(document.getElementById('invoiceStudent').value);
            const amount = parseFloat(document.getElementById('invoiceAmount').value);
            const dueDate = document.getElementById('invoiceDueDate').value;
            const description = document.getElementById('invoiceDescription').value;
            if (studentId && amount && dueDate) {
                const id = Date.now();
                const student = students.find(s => s.id === studentId);
                fees.push({
                    id,
                    studentId,
                    studentName: student.name,
                    amount,
                    dueDate,
                    paidDate: '',
                    status: 'Pending',
                    description,
                    receiptId: ''
                });
                saveData();
                renderFees();
                bootstrap.Modal.getInstance(document.getElementById('generateInvoiceModal')).hide();
                addNotification('Invoice generated', 'success');
                // Clear form
                document.getElementById('invoiceAmount').value = '';
                document.getElementById('invoiceDueDate').value = '';
                document.getElementById('invoiceDescription').value = '';
            }
        }

        function renderFees() {
            const searchTerm = document.getElementById('feeSearch').value.toLowerCase();
            const filtered = fees.filter(f => f.studentName.toLowerCase().includes(searchTerm) || f.description.toLowerCase().includes(searchTerm));
            document.getElementById('feeTable').innerHTML = filtered.map(f => {
                const isOverdue = new Date(f.dueDate) < new Date() && f.status === 'Pending';
                return `
                    <tr class="${isOverdue ? 'table-danger' : ''}">
                        <td>${f.studentName}</td>
                        <td>R${f.amount.toLocaleString()}</td>
                        <td>${f.dueDate}</td>
                        <td>${f.paidDate || ''}</td>
                        <td><span class="badge bg-${f.status === 'Paid' ? 'success' : 'warning'}">${f.status}</span></td>
                        <td><button class="btn btn-sm btn-info" onclick="showReceipt(${f.id})">Receipt</button></td>
                        <td>
                            ${f.status === 'Pending' ? `<button class="btn btn-sm btn-success" onclick="markPaid(${f.id})">Mark Paid</button>` : ''}
                            <button class="btn btn-sm btn-primary" onclick="editFee(${f.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFee(${f.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
            // Update metrics
            const totalCollected = fees.filter(f => f.status === 'Paid').reduce((sum, f) => sum + f.amount, 0);
            const outstanding = fees.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
            const overdue = fees.filter(f => f.status === 'Pending' && new Date(f.dueDate) < new Date()).reduce((sum, f) => sum + f.amount, 0);
            const paymentRate = fees.length > 0 ? Math.round((totalCollected / (totalCollected + outstanding)) * 100) : 0;
            document.getElementById('totalCollected').textContent = 'R' + totalCollected.toLocaleString();
            document.getElementById('outstandingFees').textContent = 'R' + outstanding.toLocaleString();
            document.getElementById('overdueFees').textContent = 'R' + overdue.toLocaleString();
            document.getElementById('paymentRate').textContent = paymentRate + '%';
            // Fee history
            document.getElementById('feeHistory').innerHTML = '<h5>Payment History</h5>' + fees.filter(f => f.paidDate).slice(-5).map(f => `<div class="report-card"><strong>${f.studentName}:</strong> R${f.amount} paid on ${f.paidDate}</div>`).join('');
        }

        function searchFees() {
            renderFees();
        }

        function markPaid(id) {
            const fee = fees.find(f => f.id === id);
            if (fee) {
                fee.status = 'Paid';
                fee.paidDate = new Date().toISOString().split('T')[0];
                fee.receiptId = 'REC' + Date.now();
                saveData();
                renderFees();
                addNotification('Fee marked as paid', 'success');
            }
        }

        function showReceipt(id) {
            const fee = fees.find(f => f.id === id);
            if (fee) {
                document.getElementById('receiptContent').innerHTML = `
                    <h4>Receipt #${fee.receiptId}</h4>
                    <p><strong>Student:</strong> ${fee.studentName}</p>
                    <p><strong>Amount:</strong> R${fee.amount}</p>
                    <p><strong>Paid Date:</strong> ${fee.paidDate}</p>
                    <p><strong>Description:</strong> ${fee.description}</p>
                `;
                new bootstrap.Modal(document.getElementById('feeReceiptModal')).show();
            }
        }

        function printReceipt() {
            const content = document.getElementById('receiptContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Receipt</title></head><body>' + content + '</body></html>');
            printWindow.print();
        }

        function editFee(id) {
            const fee = fees.find(f => f.id === id);
            if (fee) {
                // Populate a modal if needed, but for simplicity, alert edit
                const newAmount = prompt('New Amount:', fee.amount);
                if (newAmount) {
                    fee.amount = parseFloat(newAmount);
                    saveData();
                    renderFees();
                }
            }
        }

        function deleteFee(id) {
            if (confirm('Delete fee?')) {
                fees = fees.filter(f => f.id !== id);
                saveData();
                renderFees();
                addNotification('Fee deleted', 'danger');
            }
        }

        function showBulkUploadFeesModal() {
            new bootstrap.Modal(document.getElementById('bulkUploadFeesModal')).show();
        }

        function uploadBulkFees() {
            const file = document.getElementById('feesFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    json.forEach(row => {
                        const student = students.find(s => s.name.includes(row.Student) || s.accession === row.Accession);
                        if (student && row.Amount) {
                            const id = Date.now() + Math.random();
                            fees.push({
                                id,
                                studentId: student.id,
                                studentName: student.name,
                                amount: parseFloat(row.Amount),
                                dueDate: row.DueDate || new Date().toISOString().split('T')[0],
                                status: 'Pending',
                                description: row.Description || ''
                            });
                        }
                    });
                    saveData();
                    renderFees();
                    addNotification('Bulk fees uploaded', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('bulkUploadFeesModal')).hide();
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function sendFeeReminders() {
            const overdue = fees.filter(f => f.status === 'Pending' && new Date(f.dueDate) < new Date());
            if (overdue.length > 0) {
                overdue.forEach(f => {
                    addNotification(`Reminder sent to ${f.studentName} for R${f.amount}`, 'warning');
                    // Simulate SMS
                    console.log(`SMS to parent of ${f.studentName}: Fee overdue`);
                });
                addNotification(`${overdue.length} reminders sent`, 'info');
            } else {
                addNotification('No overdue fees', 'info');
            }
        }

        // Timetable Functions
        function loadTimetable() {
            const grade = document.getElementById('timetableGrade').value;
            const container = document.getElementById('timetableContainer');
            if (!grade) {
                container.innerHTML = '<p>Select a grade to view timetable</p>';
                return;
            }
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const times = ['08:00-09:00', '09:00-10:00', '10:00-11:00', '11:00-12:00', '12:00-13:00', '14:00-15:00'];
            let tableHTML = '<table class="table table-striped"><thead><tr><th>Time</th>' + days.map(d => `<th>${d}</th>`).join('') + '</tr></thead><tbody>';
            times.forEach(time => {
                tableHTML += `<tr><td>${time}</td>`;
                days.forEach(day => {
                    const slot = timetable[grade]?.[day]?.[time] || '';
                    tableHTML += `<td class="timetable-cell editable" onclick="editTimeSlot('${grade}', '${day}', '${time}')">${slot}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            highlightTeacherSchedule();
        }

        function showAddTimeSlotModal() {
            document.getElementById('timeSlotGrade').innerHTML = [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            new bootstrap.Modal(document.getElementById('addTimeSlotModal')).show();
        }

        function saveTimeSlot() {
            const grade = document.getElementById('timeSlotGrade').value;
            const day = document.getElementById('timeSlotDay').value;
            const time = document.getElementById('timeSlotTime').value;
            const subject = document.getElementById('timeSlotSubject').value;
            if (grade && day && time && subject) {
                if (!timetable[grade]) timetable[grade] = {};
                if (!timetable[grade][day]) timetable[grade][day] = {};
                timetable[grade][day][time] = subject;
                saveData();
                loadTimetable();
                bootstrap.Modal.getInstance(document.getElementById('addTimeSlotModal')).hide();
                addNotification('Time slot added', 'success');
            }
        }

        function editTimeSlot(grade, day, time) {
            const current = timetable[grade]?.[day]?.[time] || '';
            const newSubject = prompt('Subject/Teacher:', current);
            if (newSubject !== null) {
                if (!timetable[grade]) timetable[grade] = {};
                if (!timetable[grade][day]) timetable[grade][day] = {};
                timetable[grade][day][time] = newSubject;
                saveData();
                loadTimetable();
            }
        }

        function highlightTeacherSchedule() {
            const teacher = document.getElementById('timetableTeacher').value;
            if (teacher) {
                document.querySelectorAll('.timetable-cell').forEach(cell => {
                    cell.style.backgroundColor = cell.textContent.includes(teacher) ? 'rgba(255, 255, 0, 0.3)' : '';
                });
            }
        }

        function checkTimetableConflicts() {
            let conflicts = [];
            Object.keys(timetable).forEach(grade => {
                Object.keys(timetable[grade]).forEach(day => {
                    const slots = Object.values(timetable[grade][day]);
                    const teacherCounts = {};
                    slots.forEach(slot => {
                        if (slot) {
                            teacherCounts[slot] = (teacherCounts[slot] || 0) + 1;
                        }
                    });
                    Object.entries(teacherCounts).forEach(([teacher, count]) => {
                        if (count > 1) conflicts.push(`Conflict: ${teacher} has ${count} slots on ${day} in ${grade}`);
                    });
                });
            });
            if (conflicts.length > 0) {
                alert('Conflicts found:\n' + conflicts.join('\n'));
            } else {
                alert('No conflicts found');
            }
        }

        // Exam Functions
        function showAddExamModal() {
            document.getElementById('examGrade').innerHTML = [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            new bootstrap.Modal(document.getElementById('addExamModal')).show();
        }

        function saveExam() {
            const name = document.getElementById('examName').value;
            const date = document.getElementById('examDate').value;
            const subject = document.getElementById('examSubject').value;
            const grade = document.getElementById('examGrade').value;
            const status = document.getElementById('examStatus').value;
            if (name && date && subject && grade) {
                const id = Date.now();
                exams.push({ id, name, date, subject, grade, status });
                saveData();
                renderExams();
                bootstrap.Modal.getInstance(document.getElementById('addExamModal')).hide();
                addNotification('Exam scheduled', 'success');
            }
        }

        function renderExams() {
            const gradeFilter = document.getElementById('examGradeFilter').value;
            const subjectFilter = document.getElementById('examSubjectFilter').value.toLowerCase();
            let filtered = exams.filter(e => (!gradeFilter || e.grade === gradeFilter) && e.subject.toLowerCase().includes(subjectFilter));
            document.getElementById('examTable').innerHTML = filtered.map(e => `
                <tr>
                    <td>${e.name}</td>
                    <td>${e.date}</td>
                    <td>${e.subject}</td>
                    <td>${e.grade}</td>
                    <td><span class="badge bg-${e.status === 'Completed' ? 'success' : 'warning'}">${e.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editExam(${e.id})">Edit</button>
                        <button class="btn btn-sm btn-info" onclick="enterMarksForExam(${e.id})">Enter Marks</button>
                        <button class="btn btn-sm btn-success" onclick="generateHallTicketForExam(${e.id})">Hall Ticket</button>
                    </td>
                </tr>
            `).join('');
        }

        function editExam(id) {
            // Similar to other edit functions
            const exam = exams.find(e => e.id === id);
            if (exam) {
                document.getElementById('examName').value = exam.name;
                document.getElementById('examDate').value = exam.date;
                document.getElementById('examSubject').value = exam.subject;
                document.getElementById('examGrade').value = exam.grade;
                document.getElementById('examStatus').value = exam.status;
                const saveBtn = document.querySelector('#addExamModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => {
                    exam.name = document.getElementById('examName').value;
                    exam.date = document.getElementById('examDate').value;
                    exam.subject = document.getElementById('examSubject').value;
                    exam.grade = document.getElementById('examGrade').value;
                    exam.status = document.getElementById('examStatus').value;
                    saveData();
                    renderExams();
                    bootstrap.Modal.getInstance(document.getElementById('addExamModal')).hide();
                    addNotification('Exam updated', 'success');
                    saveBtn.textContent = 'Save';
                    saveBtn.onclick = saveExam;
                };
                new bootstrap.Modal(document.getElementById('addExamModal')).show();
            }
        }

        function showEnterMarksModal() {
            document.getElementById('marksExamSelect').innerHTML = exams.map(e => `<option value="${e.id}">${e.name} (${e.subject})</option>`).join('');
            new bootstrap.Modal(document.getElementById('enterMarksModal')).show();
            // Load marks for selected exam on change
            document.getElementById('marksExamSelect').onchange = function() {
                const examId = parseInt(this.value);
                const exam = exams.find(e => e.id === examId);
                if (exam) {
                    const studentsInGrade = students.filter(s => s.grade === exam.grade);
                    let tableHTML = '';
                    studentsInGrade.forEach(s => {
                        const mark = grades.find(g => g.examId === examId && g.studentId === s.id);
                        tableHTML += `
                            <tr>
                                <td>${s.name}</td>
                                <td><input type="number" class="form-control" value="${mark ? mark.score : ''}" data-student="${s.id}" min="0" max="100"></td>
                            </tr>
                        `;
                    });
                    document.getElementById('marksEntryTable').innerHTML = tableHTML;
                }
            };
        }

        function saveAllMarks() {
            const examId = parseInt(document.getElementById('marksExamSelect').value);
            if (examId) {
                const inputs = document.querySelectorAll('#marksEntryTable input');
                inputs.forEach(input => {
                    const studentId = parseInt(input.dataset.student);
                    const score = parseFloat(input.value);
                    if (score >= 0) {
                        let mark = grades.find(g => g.examId === examId && g.studentId === studentId);
                        if (mark) {
                            mark.score = score;
                        } else {
                            grades.push({ id: Date.now(), examId, studentId, score, subject: exams.find(e => e.id === examId).subject });
                        }
                    }
                });
                saveData();
                renderExams();
                addNotification('Marks saved', 'success');
                bootstrap.Modal.getInstance(document.getElementById('enterMarksModal')).hide();
            }
        }

        function enterMarksForExam(examId) {
            document.getElementById('marksExamSelect').value = examId;
            document.getElementById('marksExamSelect').onchange();
            new bootstrap.Modal(document.getElementById('enterMarksModal')).show();
        }

        function generateAllReportCards() {
            students.forEach(s => {
                const studentGrades = grades.filter(g => g.studentId === s.id);
                const avg = studentGrades.length > 0 ? Math.round(studentGrades.reduce((sum, g) => sum + g.score, 0) / studentGrades.length) : 0;
                // Simulate report card generation
                console.log(`Report Card for ${s.name}: Average ${avg}%`);
                addNotification(`Report card generated for ${s.name}`, 'success');
            });
        }

        function generateHallTickets() {
            exams.filter(e => e.status === 'Scheduled').forEach(e => generateHallTicketForExam(e.id));
        }

        function generateHallTicketForExam(examId) {
            const exam = exams.find(e => e.id === examId);
            const studentsInGrade = students.filter(s => s.grade === exam.grade);
            studentsInGrade.forEach(s => {
                document.getElementById('hallTicketContent').innerHTML = `
                    <h4>Hall Ticket</h4>
                    <p><strong>Student:</strong> ${s.name}</p>
                    <p><strong>Exam:</strong> ${exam.name} - ${exam.subject}</p>
                    <p><strong>Date:</strong> ${exam.date}</p>
                `;
                new bootstrap.Modal(document.getElementById('hallTicketModal')).show();
            });
            addNotification('Hall tickets generated', 'success');
        }

        function printHallTicket() {
            const content = document.getElementById('hallTicketContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Hall Ticket</title></head><body>' + content + '</body></html>');
            printWindow.print();
        }

        // HR Functions
        function renderHR() {
            // Default to staff tab
            renderStaff();
        }

        function renderStaff() {
            const searchTerm = document.getElementById('staffSearch').value.toLowerCase();
            const roleFilter = document.getElementById('staffFilterRole').value;
            let filtered = staff.filter(s => s.name.toLowerCase().includes(searchTerm) && (!roleFilter || s.role === roleFilter));
            document.getElementById('staffTable').innerHTML = filtered.map(s => {
                const isExpiring = new Date(s.certExpiry) < new Date(Date.now() + 30*24*60*60*1000);
                const expiryClass = isExpiring ? 'cert-expired' : 'cert-expiry';
                return `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${s.role}</td>
                        <td>${s.department}</td>
                        <td>R${s.salary.toLocaleString()}</td>
                        <td>${s.taxNumber}</td>
                        <td>${s.uifNumber}</td>
                        <td><span class="${expiryClass}">${s.certExpiry}</span></td>
                        <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'secondary'}">${s.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editStaff(${s.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStaff(${s.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
            // Update metrics
            const activeStaff = staff.filter(s => s.status === 'Active').length;
            const avgSalary = staff.length > 0 ? Math.round(staff.reduce((sum, s) => sum + s.salary, 0) / staff.length) : 0;
            const expiringCerts = staff.filter(s => new Date(s.certExpiry) < new Date(Date.now() + 30*24*60*60*1000)).length;
            document.getElementById('totalStaff').textContent = staff.length;
            document.getElementById('activeStaff').textContent = activeStaff;
            document.getElementById('avgSalary').textContent = 'R' + avgSalary.toLocaleString();
            document.getElementById('expiringCerts').textContent = expiringCerts;
        }

        function showAddStaffModal() {
            document.getElementById('staffModalTitle').textContent = 'Add Staff';
            // Clear form
            document.querySelectorAll('#addStaffModal input, #addStaffModal select').forEach(el => el.value = '');
            const saveBtn = document.querySelector('#addStaffModal .btn-primary');
            saveBtn.textContent = 'Save';
            saveBtn.onclick = saveStaff;
            new bootstrap.Modal(document.getElementById('addStaffModal')).show();
        }

        function saveStaff() {
            const name = document.getElementById('staffName').value;
            const role = document.getElementById('staffRole').value;
            const department = document.getElementById('staffDepartment').value;
            const salary = parseFloat(document.getElementById('staffSalary').value);
            const tax = document.getElementById('staffTax').value;
            const uif = document.getElementById('staffUif').value;
            const certExpiry = document.getElementById('staffCertExpiry').value;
            const username = document.getElementById('staffUsername').value;
            const password = document.getElementById('staffPassword').value;
            if (name && role && salary) {
                const id = Date.now();
                staff.push({
                    id,
                    name,
                    role,
                    department,
                    salary,
                    taxNumber: tax || 'T' + id,
                    uifNumber: uif || 'U' + id,
                    certExpiry: certExpiry || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],
                    status: 'Active'
                });
                if (username && password) {
                    users.push({ username, password, name, role });
                }
                saveData();
                renderStaff();
                bootstrap.Modal.getInstance(document.getElementById('addStaffModal')).hide();
                addNotification('Staff added', 'success');
            }
        }

        function editStaff(id) {
            editingStaffId = id;
            document.getElementById('staffModalTitle').textContent = 'Edit Staff';
            const staffMember = staff.find(s => s.id === id);
            if (staffMember) {
                document.getElementById('staffName').value = staffMember.name;
                document.getElementById('staffRole').value = staffMember.role;
                document.getElementById('staffDepartment').value = staffMember.department;
                document.getElementById('staffSalary').value = staffMember.salary;
                document.getElementById('staffTax').value = staffMember.taxNumber;
                document.getElementById('staffUif').value = staffMember.uifNumber;
                document.getElementById('staffCertExpiry').value = staffMember.certExpiry;
                // Username/password optional for edit
            }
            const saveBtn = document.querySelector('#addStaffModal .btn-primary');
            saveBtn.textContent = 'Update';
            saveBtn.onclick = updateStaff;
            new bootstrap.Modal(document.getElementById('addStaffModal')).show();
        }

        function updateStaff() {
            const staffMember = staff.find(s => s.id === editingStaffId);
            if (staffMember) {
                staffMember.name = document.getElementById('staffName').value;
                staffMember.role = document.getElementById('staffRole').value;
                staffMember.department = document.getElementById('staffDepartment').value;
                staffMember.salary = parseFloat(document.getElementById('staffSalary').value);
                staffMember.taxNumber = document.getElementById('staffTax').value;
                staffMember.uifNumber = document.getElementById('staffUif').value;
                staffMember.certExpiry = document.getElementById('staffCertExpiry').value;
                saveData();
                renderStaff();
                bootstrap.Modal.getInstance(document.getElementById('addStaffModal')).hide();
                addNotification('Staff updated', 'success');
                editingStaffId = null;
                // Reset
                const saveBtn = document.querySelector('#addStaffModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveStaff;
            }
        }

        function deleteStaff(id) {
            if (confirm('Delete staff?')) {
                staff = staff.filter(s => s.id !== id);
                saveData();
                renderStaff();
                addNotification('Staff deleted', 'danger');
            }
        }

        function syncStaffBiometric() {
            // Simulate
            staff.forEach(s => {
                s.biometricId = 'BIO' + Math.random().toString(36).substr(2, 9);
            });
            saveData();
            addNotification('Biometric synced for staff', 'success');
        }

        function generateStaffReport() {
            const report = staff.map(s => `${s.name} - ${s.role} - R${s.salary}`).join('\n');
            document.getElementById('reportOutput').innerHTML = `<pre>${report}</pre>`;
            document.getElementById('reportOutput').classList.remove('d-none');
            addNotification('Staff report generated', 'info');
        }

        // Payroll Functions
        function renderPayrolls() {
            const monthFilter = document.getElementById('payrollMonthFilter').value;
            let filtered = payrolls;
            if (monthFilter) {
                filtered = payrolls.filter(p => p.month === monthFilter);
            }
            document.getElementById('payrollTable').innerHTML = filtered.map(p => {
                const staffMember = staff.find(s => s.id === p.staffId);
                const net = p.salary - (p.deductions || 0) - (p.tax || 0) - (p.uif || 0);
                return `
                    <tr>
                        <td>${p.id}</td>
                        <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                        <td>${p.month}</td>
                        <td>R${p.salary.toLocaleString()}</td>
                        <td>R${(p.deductions || 0).toLocaleString()}</td>
                        <td>R${(p.tax || 0).toLocaleString()}</td>
                        <td>R${(p.uif || 0).toLocaleString()}</td>
                        <td>R${net.toLocaleString()}</td>
                        <td><button class="btn btn-sm btn-info" onclick="viewPayslip(${p.id})">View</button></td>
                    </tr>
                `;
            }).join('');
            // Metrics
            const totalPay = payrolls.reduce((sum, p) => sum + p.salary, 0);
            const totalDed = payrolls.reduce((sum, p) => sum + (p.deductions || 0), 0);
            const totalTax = payrolls.reduce((sum, p) => sum + (p.tax || 0), 0);
            const totalUif = payrolls.reduce((sum, p) => sum + (p.uif || 0), 0);
            const netPay = totalPay - totalDed - totalTax - totalUif;
            document.getElementById('totalPayroll').textContent = 'R' + totalPay.toLocaleString();
            document.getElementById('totalDeductions').textContent = 'R' + totalDed.toLocaleString();
            document.getElementById('netPayroll').textContent = 'R' + netPay.toLocaleString();
            document.getElementById('complianceScore').textContent = '100%'; // Mock
        }

        function showAddPayrollModal() {
            document.getElementById('payrollStaff').innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            new bootstrap.Modal(document.getElementById('addPayrollModal')).show();
        }

        function savePayroll() {
            const staffId = parseInt(document.getElementById('payrollStaff').value);
            const month = document.getElementById('payrollMonth').value;
            const salary = parseFloat(document.getElementById('payrollSalary').value);
            const deductions = parseFloat(document.getElementById('payrollDeductions').value) || 0;
            if (staffId && month && salary) {
                const staffMember = staff.find(s => s.id === staffId);
                const tax = salary * 0.25; // Mock tax
                const uif = salary * hrSettings.uifRate;
                const id = Date.now();
                payrolls.push({
                    id,
                    staffId,
                    staffName: staffMember.name,
                    month,
                    salary,
                    deductions,
                    tax,
                    uif
                });
                saveData();
                renderPayrolls();
                bootstrap.Modal.getInstance(document.getElementById('addPayrollModal')).hide();
                addNotification('Payroll added', 'success');
            }
        }

        function generatePayroll() {
            staff.forEach(s => {
                if (s.status === 'Active') {
                    const existing = payrolls.find(p => p.staffId === s.id && p.month === new Date().toISOString().slice(0, 7));
                    if (!existing) {
                        const id = Date.now() + Math.random();
                        payrolls.push({
                            id,
                            staffId: s.id,
                            staffName: s.name,
                            month: new Date().toISOString().slice(0, 7),
                            salary: s.salary,
                            deductions: 0,
                            tax: s.salary * 0.25,
                            uif: s.salary * hrSettings.uifRate
                        });
                    }
                }
            });
            saveData();
            renderPayrolls();
            addNotification('Payroll generated', 'success');
        }

        function exportPayrollToExcel() {
            const ws = XLSX.utils.json_to_sheet(payrolls.map(p => ({
                'Staff': p.staffName,
                'Month': p.month,
                'Salary': p.salary,
                'Net': p.salary - (p.deductions || 0) - (p.tax || 0) - (p.uif || 0)
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Payroll');
            XLSX.writeFile(wb, 'payroll.xlsx');
            addNotification('Payroll exported to Excel', 'success');
        }

        function calculateCompliance() {
            // Mock compliance check
            const issues = Math.random() > 0.5 ? 0 : 1;
            document.getElementById('complianceScore').textContent = issues === 0 ? '100%' : '80%';
            addNotification(issues === 0 ? 'Compliant' : 'Compliance issues found', issues === 0 ? 'success' : 'warning');
        }

        function viewPayslip(id) {
            const payroll = payrolls.find(p => p.id === id);
            if (payroll) {
                const net = payroll.salary - (payroll.deductions || 0) - (payroll.tax || 0) - (payroll.uif || 0);
                document.getElementById('payslipContent').innerHTML = `
                    <h4>Payslip for ${payroll.staffName}</h4>
                    <p><strong>Month:</strong> ${payroll.month}</p>
                    <p><strong>Gross Salary:</strong> R${payroll.salary.toLocaleString()}</p>
                    <p><strong>Deductions:</strong> R${(payroll.deductions || 0).toLocaleString()}</p>
                    <p><strong>Tax:</strong> R${(payroll.tax || 0).toLocaleString()}</p>
                    <p><strong>UIF:</strong> R${(payroll.uif || 0).toLocaleString()}</p>
                    <p><strong>Net Pay:</strong> R${net.toLocaleString()}</p>
                `;
                new bootstrap.Modal(document.getElementById('payslipModal')).show();
            }
        }

        function printPayslip() {
            const content = document.getElementById('payslipContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Payslip</title></head><body>' + content + '</body></html>');
            printWindow.print();
        }

        // Leave Functions
        function renderLeaves() {
            const dateFilter = document.getElementById('leaveDateFilter').value;
            let filtered = leaveRequests;
            if (dateFilter) {
                filtered = leaveRequests.filter(l => l.date === dateFilter);
            }
            document.getElementById('leavesTable').innerHTML = filtered.map(l => {
                const staffMember = staff.find(s => s.id === l.staffId);
                return `
                    <tr>
                        <td>${l.id}</td>
                        <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                        <td>${l.type}</td>
                        <td>${l.date}</td>
                        <td>${l.days}</td>
                        <td><span class="badge bg-${l.status === 'Approved' ? 'success' : l.status === 'Rejected' ? 'danger' : 'warning'}">${l.status}</span></td>
                        <td>
                            ${l.status === 'Pending' ? `<button class="btn btn-sm btn-success" onclick="approveLeave(${l.id})">Approve</button> <button class="btn btn-sm btn-danger" onclick="rejectLeave(${l.id})">Reject</button>` : ''}
                            <button class="btn btn-sm btn-primary" onclick="editLeave(${l.id})">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');
            // Metrics
            const total = leaveRequests.length;
            const pending = leaveRequests.filter(l => l.status === 'Pending').length;
            const approved = leaveRequests.filter(l => l.status === 'Approved').length;
            const rejected = leaveRequests.filter(l => l.status === 'Rejected').length;
            document.getElementById('totalLeaves').textContent = total;
            document.getElementById('pendingLeaves').textContent = pending;
            document.getElementById('approvedLeaves').textContent = approved;
            document.getElementById('rejectedLeaves').textContent = rejected;
            // Chart
            const ctx = document.getElementById('leaveChart').getContext('2d');
            if (leaveChart) leaveChart.destroy();
            leaveChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Pending', 'Approved', 'Rejected'],
                    datasets: [{
                        data: [pending, approved, rejected],
                        backgroundColor: ['#FFCE56', '#36A2EB', '#FF6384']
                    }]
                },
                options: { responsive: true }
            });
        }

        function showAddLeaveModal() {
            document.getElementById('leaveStaff').innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            new bootstrap.Modal(document.getElementById('addLeaveModal')).show();
        }

        function saveLeave() {
            const staffId = parseInt(document.getElementById('leaveStaff').value);
            const type = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const days = parseInt(document.getElementById('leaveDays').value);
            if (staffId && date && days) {
                const id = Date.now();
                leaveRequests.push({
                    id,
                    staffId,
                    type,
                    date,
                    days,
                    status: 'Pending'
                });
                saveData();
                renderLeaves();
                bootstrap.Modal.getInstance(document.getElementById('addLeaveModal')).hide();
                addNotification('Leave request added', 'success');
            }
        }

        function approveLeave(id) {
            const leave = leaveRequests.find(l => l.id === id);
            if (leave) {
                leave.status = 'Approved';
                saveData();
                renderLeaves();
                addNotification('Leave approved', 'success');
            }
        }

        function rejectLeave(id) {
            const leave = leaveRequests.find(l => l.id === id);
            if (leave) {
                leave.status = 'Rejected';
                saveData();
                renderLeaves();
                addNotification('Leave rejected', 'danger');
            }
        }

        function editLeave(id) {
            // Similar edit pattern
            const leave = leaveRequests.find(l => l.id === id);
            if (leave) {
                document.getElementById('leaveStaff').value = leave.staffId;
                document.getElementById('leaveType').value = leave.type;
                document.getElementById('leaveDate').value = leave.date;
                document.getElementById('leaveDays').value = leave.days;
                const saveBtn = document.querySelector('#addLeaveModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => {
                    leave.staffId = parseInt(document.getElementById('leaveStaff').value);
                    leave.type = document.getElementById('leaveType').value;
                    leave.date = document.getElementById('leaveDate').value;
                    leave.days = parseInt(document.getElementById('leaveDays').value);
                    saveData();
                    renderLeaves();
                    bootstrap.Modal.getInstance(document.getElementById('addLeaveModal')).hide();
                    addNotification('Leave updated', 'success');
                    saveBtn.textContent = 'Save';
                    saveBtn.onclick = saveLeave;
                };
                new bootstrap.Modal(document.getElementById('addLeaveModal')).show();
            }
        }

        function generateLeaveReport() {
            const report = leaveRequests.map(l => {
                const staffMember = staff.find(s => s.id === l.staffId);
                return `${staffMember ? staffMember.name : 'Unknown'} - ${l.type} - ${l.days} days - ${l.status}`;
            }).join('\n');
            console.log('Leave Report:\n' + report);
            addNotification('Leave report generated', 'info');
        }

        // Performance Functions
        function renderReviews() {
            const dateFilter = document.getElementById('reviewDateFilter').value;
            let filtered = performanceReviews;
            if (dateFilter) {
                filtered = performanceReviews.filter(r => r.date === dateFilter);
            }
            document.getElementById('reviewsTable').innerHTML = filtered.map(r => {
                const staffMember = staff.find(s => s.id === r.staffId);
                return `
                    <tr>
                        <td>${r.id}</td>
                        <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                        <td>${r.date}</td>
                        <td>${r.score}</td>
                        <td>${r.comments}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="editReview(${r.id})">Edit</button></td>
                    </tr>
                `;
            }).join('');
            // Metrics
            const avgScore = performanceReviews.length > 0 ? Math.round(performanceReviews.reduce((sum, r) => sum + r.score, 0) / performanceReviews.length) : 0;
            const total = performanceReviews.length;
            const pending = staff.length - total; // Mock
            document.getElementById('avgScore').textContent = avgScore;
            document.getElementById('totalReviews').textContent = total;
            document.getElementById('goalsAchieved').textContent = Math.round(total * 0.8); // Mock
            document.getElementById('pendingFeedback').textContent = pending;
            // Chart
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (performanceChart) performanceChart.destroy();
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filtered.map(r => r.date),
                    datasets: [{
                        label: 'Scores',
                        data: filtered.map(r => r.score),
                        borderColor: '#36A2EB',
                        fill: false
                    }]
                },
                options: { responsive: true }
            });
        }

        function showAddReviewModal() {
            document.getElementById('reviewStaff').innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            new bootstrap.Modal(document.getElementById('addReviewModal')).show();
        }

        function saveReview() {
            const staffId = parseInt(document.getElementById('reviewStaff').value);
            const date = document.getElementById('reviewDate').value;
            const score = parseFloat(document.getElementById('reviewScore').value);
            const comments = document.getElementById('reviewComments').value;
            if (staffId && date && score) {
                const id = Date.now();
                performanceReviews.push({ id, staffId, date, score, comments });
                saveData();
                renderReviews();
                bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
                addNotification('Review added', 'success');
            }
        }

        function editReview(id) {
            editingReviewId = id;
            const review = performanceReviews.find(r => r.id === id);
            if (review) {
                document.getElementById('reviewStaff').value = review.staffId;
                document.getElementById('reviewDate').value = review.date;
                document.getElementById('reviewScore').value = review.score;
                document.getElementById('reviewComments').value = review.comments;
                const saveBtn = document.querySelector('#addReviewModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = updateReview;
                new bootstrap.Modal(document.getElementById('addReviewModal')).show();
            }
        }

        function updateReview() {
            const review = performanceReviews.find(r => r.id === editingReviewId);
            if (review) {
                review.staffId = parseInt(document.getElementById('reviewStaff').value);
                review.date = document.getElementById('reviewDate').value;
                review.score = parseFloat(document.getElementById('reviewScore').value);
                review.comments = document.getElementById('reviewComments').value;
                saveData();
                renderReviews();
                bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
                addNotification('Review updated', 'success');
                editingReviewId = null;
                // Reset
                const saveBtn = document.querySelector('#addReviewModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveReview;
            }
        }

        function generatePerformanceReport() {
            const report = performanceReviews.map(r => {
                const staffMember = staff.find(s => s.id === r.staffId);
                return `${staffMember ? staffMember.name : 'Unknown'} - Score: ${r.score} - ${r.comments}`;
            }).join('\n');
            console.log('Performance Report:\n' + report);
            addNotification('Performance report generated', 'info');
        }

        // Recruitment Functions
        function renderJobs() {
            const searchTerm = document.getElementById('jobSearch').value.toLowerCase();
            const filtered = jobs.filter(j => j.title.toLowerCase().includes(searchTerm));
            document.getElementById('jobTable').innerHTML = filtered.map(j => `
                <tr>
                    <td>${j.id}</td>
                    <td>${j.title}</td>
                    <td>${j.department}</td>
                    <td>${applicationsForJob(j.id).length}</td>
                    <td><span class="badge bg-${j.status === 'Open' ? 'success' : 'secondary'}">${j.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editJob(${j.id})">Edit</button>
                        <button class="btn btn-sm btn-info" onclick="viewApplications(${j.id})">View Apps</button>
                        ${j.status === 'Open' ? `<button class="btn btn-sm btn-success" onclick="closeJob(${j.id})">Close</button>` : ''}
                    </td>
                </tr>
            `).join('');
            // Metrics
            const open = jobs.filter(j => j.status === 'Open').length;
            const totalApps = jobs.reduce((sum, j) => sum + applicationsForJob(j.id).length, 0);
            const interviews = applications.filter(a => a.stage === 'Interview').length; // Assume applications array
            const hireRate = totalApps > 0 ? Math.round((staff.length / totalApps) * 100) : 0; // Mock
            document.getElementById('openPositions').textContent = open;
            document.getElementById('totalApplications').textContent = totalApps;
            document.getElementById('interviewsScheduled').textContent = interviews;
            document.getElementById('hireRate').textContent = hireRate + '%';
        }

        let applications = []; // Global for applications

        function loadData() {
            // ... existing loadData ...
            applications = JSON.parse(localStorage.getItem('applications') || '[]');
            // ... rest
        }

        function saveData() {
            // ... existing saveData ...
            localStorage.setItem('applications', JSON.stringify(applications));
            // ... rest
        }

        function applicationsForJob(jobId) {
            return applications.filter(a => a.jobId === jobId);
        }

        function showAddJobModal() {
            document.getElementById('jobModalTitle').textContent = 'Add Job';
            // Clear form
            document.querySelectorAll('#addJobModal input, #addJobModal textarea, #addJobModal select').forEach(el => el.value = '');
            const saveBtn = document.querySelector('#addJobModal .btn-primary');
            saveBtn.textContent = 'Save';
            saveBtn.onclick = saveJob;
            new bootstrap.Modal(document.getElementById('addJobModal')).show();
        }

        function saveJob() {
            const title = document.getElementById('jobTitle').value;
            const department = document.getElementById('jobDepartment').value;
            const description = document.getElementById('jobDescription').value;
            const status = document.getElementById('jobStatus').value;
            if (title && department) {
                const id = Date.now();
                jobs.push({ id, title, department, description, status: status || 'Open' });
                saveData();
                renderJobs();
                bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
                addNotification('Job added', 'success');
            }
        }

        function editJob(id) {
            editingJob = id;
            document.getElementById('jobModalTitle').textContent = 'Edit Job';
            const job = jobs.find(j => j.id === id);
            if (job) {
                document.getElementById('jobTitle').value = job.title;
                document.getElementById('jobDepartment').value = job.department;
                document.getElementById('jobDescription').value = job.description;
                document.getElementById('jobStatus').value = job.status;
            }
            const saveBtn = document.querySelector('#addJobModal .btn-primary');
            saveBtn.textContent = 'Update';
            saveBtn.onclick = updateJob;
            new bootstrap.Modal(document.getElementById('addJobModal')).show();
        }

        function updateJob() {
            const job = jobs.find(j => j.id === editingJob);
            if (job) {
                job.title = document.getElementById('jobTitle').value;
                job.department = document.getElementById('jobDepartment').value;
                job.description = document.getElementById('jobDescription').value;
                job.status = document.getElementById('jobStatus').value;
                saveData();
                renderJobs();
                bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
                addNotification('Job updated', 'success');
                editingJob = null;
                // Reset
                const saveBtn = document.querySelector('#addJobModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveJob;
            }
        }

        function closeJob(id) {
            const job = jobs.find(j => j.id === id);
            if (job) {
                job.status = 'Closed';
                saveData();
                renderJobs();
                addNotification('Job closed', 'info');
            }
        }

        function viewApplications(jobId) {
            const apps = applications.filter(a => a.jobId === jobId);
            alert('Applications:\n' + apps.map(a => `${a.name} - ${a.stage}`).join('\n'));
        }

        function showApplyJobModal() {
            document.getElementById('applyJobSelect').innerHTML = jobs.filter(j => j.status === 'Open').map(j => `<option value="${j.id}">${j.title}</option>`).join('');
            new bootstrap.Modal(document.getElementById('applyJobModal')).show();
        }

        function submitApplication() {
            const jobId = parseInt(document.getElementById('applyJobSelect').value);
            const name = document.getElementById('applicantName').value;
            const email = document.getElementById('applicantEmail').value;
            const phone = document.getElementById('applicantPhone').value;
            const coverLetter = document.getElementById('applicantCoverLetter').value;
            if (jobId && name && email) {
                const id = Date.now();
                applications.push({
                    id,
                    jobId,
                    name,
                    email,
                    phone,
                    coverLetter,
                    stage: 'Applied',
                    resume: document.getElementById('applicantResume').files[0]?.name || ''
                });
                saveData();
                renderJobs();
                bootstrap.Modal.getInstance(document.getElementById('applyJobModal')).hide();
                addNotification('Application submitted', 'success');
            }
        }

        function generateRecruitmentReport() {
            const report = jobs.map(j => `${j.title} - ${applicationsForJob(j.id).length} apps - ${j.status}`).join('\n');
            console.log('Recruitment Report:\n' + report);
            addNotification('Recruitment report generated', 'info');
        }

        // Audit Functions
        function renderAudit() {
            const dateFilter = document.getElementById('auditDateFilter').value;
            const actionFilter = document.getElementById('auditActionFilter').value;
            let filtered = auditLog;
            if (dateFilter) {
                filtered = filtered.filter(a => a.timestamp.split('T')[0] === dateFilter);
            }
            if (actionFilter) {
                filtered = filtered.filter(a => a.action === actionFilter);
            }
            document.getElementById('auditTable').innerHTML = filtered.map(a => `
                <tr class="${a.risk === 'High' ? 'table-danger' : ''}">
                    <td>${a.timestamp}</td>
                    <td>${a.user}</td>
                    <td>${a.action}</td>
                    <td>${a.details}</td>
                    <td><span class="badge bg-${a.risk === 'High' ? 'danger' : 'warning'}">${a.risk}</span></td>
                </tr>
            `).join('');
            // Metrics
            const total = auditLog.length;
            const todayCount = auditLog.filter(a => a.timestamp.split('T')[0] === new Date().toISOString().split('T')[0]).length;
            const highRisk = auditLog.filter(a => a.risk === 'High').length;
            const complianceIssues = highRisk; // Mock
            document.getElementById('totalAudit').textContent = total;
            document.getElementById('todayAudit').textContent = todayCount;
            document.getElementById('highRiskAudit').textContent = highRisk;
            document.getElementById('complianceIssues').textContent = complianceIssues;
        }

        function generateAuditReport() {
            const report = auditLog.map(a => `${a.timestamp} - ${a.user} - ${a.action}: ${a.details}`).join('\n');
            console.log('Audit Report:\n' + report);
            addNotification('Audit report generated', 'info');
        }

        function exportAuditToExcel() {
            const ws = XLSX.utils.json_to_sheet(auditLog);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Audit');
            XLSX.writeFile(wb, 'audit.xlsx');
            addNotification('Audit exported to Excel', 'success');
        }

        // Log audit entry
        function logAudit(user, action, details, risk = 'Low') {
            auditLog.unshift({
                id: Date.now(),
                user,
                action,
                details,
                risk,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('auditLog', JSON.stringify(auditLog.slice(0, 1000))); // Limit size
        }

        // Communication Functions
        function showSendMessageModal() {
            new bootstrap.Modal(document.getElementById('sendMessageModal')).show();
        }

        function sendMessage() {
            const recipient = document.getElementById('messageRecipient').value;
            const text = document.getElementById('messageText').value;
            const viaSMS = document.getElementById('sendViaSMS').checked;
            if (text) {
                const id = Date.now();
                messages.push({ id, recipient, text, sender: currentUser.name, date: new Date().toISOString(), viaSMS });
                announcements.push({ id, text, date: new Date().toISOString().split('T')[0], type: 'General' }); // Also add as announcement
                saveData();
                renderMessages();
                if (viaSMS && smsSettings.username) {
                    // Simulate SMS
                    console.log(`SMS sent via WinSMS to ${recipient}: ${text}`);
                }
                bootstrap.Modal.getInstance(document.getElementById('sendMessageModal')).hide();
                addNotification('Message sent', 'success');
            }
        }

        function renderMessages() {
            document.getElementById('messagesContainer').innerHTML = messages.slice(-20).map(m => `
                <div class="chat-message ${m.sender === currentUser.name ? 'chat-user' : 'chat-assistant'}">
                    <strong>${m.sender}:</strong> ${m.text} <small>${m.date}</small>
                    ${m.viaSMS ? '<i class="fas fa-sms text-success"></i>' : ''}
                </div>
            `).join('');
        }

        function viewAnnouncements() {
            document.getElementById('messagesContainer').innerHTML = '<h5>Announcements</h5>' + announcements.slice(-10).map(a => `
                <div class="alert alert-info">${a.text} <small>${a.date}</small></div>
            `).join('');
        }

        function startChat() {
            new bootstrap.Modal(document.getElementById('chatModal')).show();
            document.getElementById('chatMessages').innerHTML = ''; // Clear
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (text) {
                const messagesDiv = document.getElementById('chatMessages');
                messagesDiv.innerHTML += `<div class="chat-message chat-user"><strong>You:</strong> ${text}</div>`;
                // Simulate response
                setTimeout(() => {
                    messagesDiv.innerHTML += `<div class="chat-message chat-assistant"><strong>Assistant:</strong> Got your message: "${text}". How can I help?</div>`;
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }, 500);
                input.value = '';
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // Content Functions
        function showAddContentModal() {
            new bootstrap.Modal(document.getElementById('addContentModal')).show();
        }

        function saveContent() {
            const title = document.getElementById('contentTitle').value;
            const type = document.getElementById('contentType').value;
            const body = document.getElementById('contentBody').value;
            const file = document.getElementById('contentFile').files[0];
            const status = document.getElementById('contentStatus').value;
            if (title && body) {
                const id = Date.now();
                contents.push({
                    id,
                    title,
                    type,
                    body,
                    file: file ? file.name : '',
                    status
                });
                saveData();
                renderContents();
                bootstrap.Modal.getInstance(document.getElementById('addContentModal')).hide();
                addNotification('Content added', 'success');
            }
        }

        function renderContents() {
            const searchTerm = document.getElementById('contentSearch').value.toLowerCase();
            const filtered = contents.filter(c => c.title.toLowerCase().includes(searchTerm));
            document.getElementById('contentTable').innerHTML = filtered.map(c => `
                <tr>
                    <td>${c.id}</td>
                    <td>${c.title}</td>
                    <td>${c.type}</td>
                    <td><span class="badge bg-${c.status === 'Published' ? 'success' : 'warning'}">${c.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editContent(${c.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteContent(${c.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function searchContent() {
            renderContents();
        }

        function editContent(id) {
            // Edit pattern similar to others
            const content = contents.find(c => c.id === id);
            if (content) {
                document.getElementById('contentTitle').value = content.title;
                document.getElementById('contentType').value = content.type;
                document.getElementById('contentBody').value = content.body;
                document.getElementById('contentStatus').value = content.status;
                // Override save for update
                const saveBtn = document.querySelector('#addContentModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => {
                    content.title = document.getElementById('contentTitle').value;
                    content.type = document.getElementById('contentType').value;
                    content.body = document.getElementById('contentBody').value;
                    content.status = document.getElementById('contentStatus').value;
                    saveData();
                    renderContents();
                    bootstrap.Modal.getInstance(document.getElementById('addContentModal')).hide();
                    addNotification('Content updated', 'success');
                    saveBtn.textContent = 'Save';
                    saveBtn.onclick = saveContent;
                };
                new bootstrap.Modal(document.getElementById('addContentModal')).show();
            }
        }

        function deleteContent(id) {
            if (confirm('Delete content?')) {
                contents = contents.filter(c => c.id !== id);
                saveData();
                renderContents();
                addNotification('Content deleted', 'danger');
            }
        }

        // Reports Functions
        function generateReport() {
            const type = document.getElementById('reportType').value;
            let report = '';
            switch (type) {
                case 'attendance':
                    const today = new Date().toISOString().split('T')[0];
                    const attRecords = attendanceRecords[today] || {};
                    report = students.map(s => `${s.name}: ${attRecords[s.id]?.status || 'Absent'}`).join('\n');
                    break;
                case 'fees':
                    report = fees.map(f => `${f.studentName} - R${f.amount} - ${f.status}`).join('\n');
                    break;
                case 'exams':
                    report = exams.map(e => `${e.name} - ${e.subject} - ${e.grade} - ${e.status}`).join('\n');
                    break;
                case 'hr':
                    report = staff.map(s => `${s.name} - ${s.role} - R${s.salary}`).join('\n');
                    break;
            }
            document.getElementById('reportOutput').innerHTML = `<pre>${report}</pre>`;
            document.getElementById('reportOutput').classList.remove('d-none');
            addNotification(`${type} report generated`, 'info');
        }

        function exportReport() {
            const content = document.getElementById('reportOutput').textContent;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report.txt';
            a.click();
            addNotification('Report exported', 'success');
        }

        // Settings Functions
        function loadSettings() {
            document.getElementById('smsUsername').value = smsSettings.username;
            document.getElementById('smsPassword').value = smsSettings.password;
            document.getElementById('annualLeaveDays').value = hrSettings.annualLeaveDays;
            document.getElementById('uifRate').value = hrSettings.uifRate * 100;
        }

        function saveSMSSettings() {
            smsSettings.username = document.getElementById('smsUsername').value;
            smsSettings.password = document.getElementById('smsPassword').value;
            saveData();
            addNotification('SMS settings saved', 'success');
        }

        function updateHRSettings() {
            hrSettings.annualLeaveDays = parseInt(document.getElementById('annualLeaveDays').value);
            hrSettings.uifRate = parseFloat(document.getElementById('uifRate').value) / 100;
            saveData();
            addNotification('HR settings updated', 'success');
        }

        function backupData() {
            const data = {
                students,
                staff,
                fees,
                // ... all arrays/objects
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'asms_backup.json';
            a.click();
            addNotification('Data backed up', 'success');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const data = JSON.parse(ev.target.result);
                        // Restore selected data
                        if (data.students) students = data.students;
                        if (data.staff) staff = data.staff;
                        // ... etc.
                        saveData();
                        addNotification('Data restored', 'success');
                        location.reload();
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Parent Portal Functions
        function loadParentPortal() {
            // Mock child for parent
            const child = students.find(s => s.parent === currentUser.name) || students[0];
            if (child) {
                document.getElementById('parentChildInfo').innerHTML = `<h4>Child: ${child.name} (${child.grade})</h4>`;
                // Attendance
                const today = new Date().toISOString().split('T')[0];
                const att = attendanceRecords[today]?.[child.id]?.status || 'Absent';
                document.getElementById('parentAttendance').innerHTML = `<p>Today: <span class="badge bg-${att === 'Present' ? 'success' : 'danger'}">${att}</span></p>`;
                // Fees
                const childFees = fees.filter(f => f.studentId === child.id);
                document.getElementById('parentFees').innerHTML = childFees.map(f => `<div class="report-card">R${f.amount} - ${f.status}</div>`).join('');
                // Grades
                const childGrades = grades.filter(g => g.studentId === child.id);
                document.getElementById('parentGrades').innerHTML = childGrades.map(g => `<div class="report-card">${g.subject}: ${g.score}%</div>`).join('');
                // Announcements
                document.getElementById('parentAnnouncements').innerHTML = announcements.slice(-5).map(a => `<div class="alert alert-info">${a.text}</div>`).join('');
            }
        }

        // AI Research Functions
        function researchWithAI() {
            const query = document.getElementById('researchQuery').value;
            if (query) {
                // Simulate AI response
                document.getElementById('researchResults').innerHTML = `
                    <div class="alert alert-info">
                        <h5>Research on "${query}"</h5>
                        <p>Summary: This is a simulated AI response. In a real app, integrate with Grok API or similar.</p>
                        <ul>
                            <li>Key fact 1</li>
                            <li>Key fact 2</li>
                        </ul>
                    </div>
                `;
                addNotification('Research completed', 'info');
            }
        }

        // Utility: Override some saves to log audit
        const originalSaveData = saveData;
        saveData = function() {
            logAudit(currentUser.name, 'Data Save', 'Updated localStorage', 'Low');
            originalSaveData();
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            populateSelects();
            // Search inputs
            document.getElementById('admissionSearch').addEventListener('input', debounce(renderAdmissions, 300));
            document.getElementById('studentSearch').addEventListener('input', debounce(renderStudents, 300));
            document.getElementById('feeSearch').addEventListener('input', debounce(renderFees, 300));
            document.getElementById('contentSearch').addEventListener('input', debounce(renderContents, 300));
            document.getElementById('staffSearch').addEventListener('input', debounce(renderStaff, 300));
            document.getElementById('jobSearch').addEventListener('input', debounce(renderJobs, 300));
            // Chat input enter
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendChatMessage();
            });
        });

        // Generate demo data on first load if empty
        if (students.length === 0) {
            // Add some demo students from mx4051Data
            mx4051Data.forEach(data => {
                const id = Date.now() + Math.random();
                students.push({
                    id,
                    name: `${data.surname}, ${data.first_name}`,
                    grade: data.class,
                    parent: `Parent of ${data.surname}`,
                    status: 'Active',
                    accession: data.accession,
                    educator: data.educator
                });
            });
            saveData();
            integrateEducatorsAsStaff();
        }
    </script>
</body>
</html>
        
