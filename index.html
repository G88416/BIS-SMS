
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced School Management System (ASMS) - Bophelong Independent School</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe SDK -->
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1e3c72, #2a5298); 
            color: #fff; 
            min-height: 100vh;
        }
        .sidebar { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            border-right: 1px solid rgba(255, 255, 255, 0.2); 
            height: 100vh; 
            position: fixed; 
            width: 260px; 
            padding: 20px; 
            overflow-y: auto; 
            transition: width 0.3s ease; 
            z-index: 1000; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link { 
            color: #fff; 
            font-weight: 500; 
            margin-bottom: 10px; 
            padding: 12px; 
            border-radius: 10px; 
            transition: all 0.3s; 
            backdrop-filter: blur(5px);
        }
        .sidebar .nav-link:hover { 
            background: rgba(255, 255, 255, 0.2); 
            transform: translateX(5px); 
        }
        .sidebar .nav-link.active { 
            background: rgba(255, 255, 255, 0.3); 
            font-weight: 600;
        }
        .content { 
            margin-left: 260px; 
            padding: 40px; 
            transition: margin-left 0.3s ease; 
            min-height: 100vh;
        }
        .content.expanded { margin-left: 70px; }
        .card-metric { 
            background: rgba(255, 255, 255, 0.15); 
            border: none; 
            border-radius: 15px; 
            backdrop-filter: blur(10px); 
            transition: transform 0.3s; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .card-metric:hover { transform: translateY(-8px); }
        .table { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 15px; 
            overflow: hidden; 
            backdrop-filter: blur(10px);
        }
        .table th { background: rgba(255, 255, 255, 0.2); color: #fff; }
        .modal-content { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 20px; 
            backdrop-filter: blur(15px); 
            color: #333;
        }
        .btn-toggle-sidebar { 
            position: fixed; 
            top: 20px; 
            left: 270px; 
            z-index: 1001; 
            background: rgba(255, 255, 255, 0.2); 
            border: none; 
            color: #fff;
        }
        .btn-toggle-sidebar.expanded { left: 80px; }
        #notificationBell { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1100; 
        }
        .admin-only { display: block; }
        .teacher-only { display: none; }
        .parent-only { display: none; }
        .student-only { display: none; }
        .dark-mode { filter: brightness(0.8); }
        .login-page { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }
        .login-card { 
            width: 100%; 
            max-width: 450px; 
            padding: 2.5rem; 
            border-radius: 20px; 
            background: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); 
            backdrop-filter: blur(15px);
        }
        .login-title { 
            font-weight: 700; 
            color: #1e3c72; 
            text-align: center;
        }
        .report-card { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 15px; 
            padding: 20px; 
            margin: 10px 0; 
            backdrop-filter: blur(10px);
        }
        .timetable-cell { 
            padding: 10px; 
            text-align: center; 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 8px; 
            margin: 2px; 
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-message { 
            margin-bottom: 10px; 
            padding: 10px; 
            border-radius: 10px; 
        }
        .chat-user { background: rgba(255, 255, 255, 0.2); }
        .chat-assistant { background: rgba(0, 255, 0, 0.1); }
        .editable { cursor: pointer; }
        .editable:hover { background: rgba(255, 255, 255, 0.2); }
        .staff-photo { max-width: 100px; max-height: 100px; border-radius: 50%; }
        .hr-tab { padding: 15px; margin-bottom: 20px; border-radius: 10px; }
        .badge { font-size: 0.8em; }
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 70px; }
            .btn-toggle-sidebar { left: 80px; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x text-primary mb-3"></i>
                <h3 class="login-title">ASMS - Bophelong Independent School</h3>
                <p class="text-muted">Advanced School Management System</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <button type="button" class="btn btn-secondary w-100 mb-3" onclick="biometricLogin()">
                    <i class="fas fa-fingerprint me-2"></i>Biometric Login
                </button>
                <div class="login-demo">
                    <p class="mb-1"><strong>Admin:</strong> admin / admin123</p>
                    <p class="mb-1"><strong>Teacher:</strong> teacher / teacher123</p>
                    <p class="mb-1"><strong>Parent:</strong> parent / parent123</p>
                    <p class="mb-0"><strong>Student:</strong> student / student123</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-warning rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>

        <button class="btn btn-sm btn-light btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

        <div class="sidebar">
            <h4 class="mb-4 text-center"><i class="fas fa-school me-2"></i><span class="nav-text">ASMS</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only non-student"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
                <li class="non-student"><a href="#admission" class="nav-link" onclick="showSection('admission')"><i class="fas fa-user-plus me-2"></i><span class="nav-text">Admission</span></a></li>
                <li class="non-student"><a href="#students" class="nav-link" onclick="showSection('students')"><i class="fas fa-users me-2"></i><span class="nav-text">Student Info</span></a></li>
                <li class="non-student"><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
                <li class="non-student"><a href="#fees" class="nav-link" onclick="showSection('fees')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">Fee Management</span></a></li>
                <li><a href="#timetable" class="nav-link" onclick="showSection('timetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Timetable</span></a></li>
                <li><a href="#exams" class="nav-link" onclick="showSection('exams')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Examinations</span></a></li>
                <li class="admin-only non-student"><a href="#hr" class="nav-link" onclick="showSection('hr')"><i class="fas fa-user-tie me-2"></i><span class="nav-text">HR Management</span></a></li>
                <li class="non-student"><a href="#communication" class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments me-2"></i><span class="nav-text">Communication</span></a></li>
                <li><a href="#content" class="nav-link" onclick="showSection('content')"><i class="fas fa-book me-2"></i><span class="nav-text">Content</span></a></li>
                <li class="admin-only non-student"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Reports</span></a></li>
                <li class="admin-only non-student"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="student-only"><a href="#aiResearch" class="nav-link" onclick="showSection('aiResearch')"><i class="fas fa-robot me-2"></i><span class="nav-text">AI Research</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section">
                <h2>School Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Students</h5><h3 id="totalStudents">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's Attendance</h5><h3 id="todayAttendance">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Fees</h5><h3 id="pendingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Upcoming Exams</h5><h3 id="upcomingExams">0</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4"></canvas>
            </section>

            <!-- Admission Management -->
            <section id="admission" class="section d-none">
                <h2>Admission Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddAdmissionModal()">New Application</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkAdmissionModal()">Bulk Import (CSV/Excel)</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="admissionTable"></tbody>
                </table>
            </section>

            <!-- Student Information System -->
            <section id="students" class="section d-none">
                <h2>Student Information System</h2>
                <button class="btn btn-primary mb-3" onclick="showAddStudentModal()">Add Student</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search student..." id="studentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchStudents()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Parent</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="studentTable"></tbody>
                </table>
            </section>

            <!-- Attendance Management -->
            <section id="attendance" class="section d-none">
                <h2>Attendance Management</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="date" id="attendanceDate" class="form-control" onchange="loadAttendance()">
                    </div>
                    <div class="col-md-4">
                        <select id="attendanceClass" class="form-control" onchange="loadAttendance()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success mb-3" onclick="markAllPresent()">Mark All Present</button>
                <button class="btn btn-info mb-3" onclick="syncBiometricAttendance()">Sync Biometric Attendance</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </section>

            <!-- Fee Management -->
            <section id="fees" class="section d-none">
                <h2>Fee Management</h2>
                <button class="btn btn-primary mb-3" onclick="showGenerateInvoiceModal()">Generate Invoice</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkUploadFeesModal()">Bulk Import (CSV/Excel)</button>
                <button class="btn btn-warning mb-3" onclick="sendFeeReminders()">Send Reminders</button>
                <div class="row mb-3">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Collected</h5><h3 id="totalCollected">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Outstanding</h5><h3 id="outstandingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Overdue</h5><h3 id="overdueFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Payment Rate</h5><h3 id="paymentRate">0%</h3></div></div>
                </div>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search fees..." id="feeSearch">
                    <button class="btn btn-outline-secondary" onclick="searchFees()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Student</th><th>Amount</th><th>Due Date</th><th>Paid Date</th><th>Status</th><th>Receipt</th><th>Actions</th></tr></thead>
                    <tbody id="feeTable"></tbody>
                </table>
                <div id="feeHistory" class="mt-4"></div>
            </section>

            <!-- Timetable Management -->
            <section id="timetable" class="section d-none">
                <h2>Timetable Management</h2>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="timetableGrade" class="form-control" onchange="loadTimetable()">
                            <option value="">Select Grade</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="timetableTeacher" class="form-control" onchange="highlightTeacherSchedule()">
                            <option value="">Select Teacher</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="showAddTimeSlotModal()">Add Time Slot</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning" onclick="checkTimetableConflicts()">Check Conflicts</button>
                    </div>
                </div>
                <div id="timetableContainer"></div>
            </section>

            <!-- Examination Management -->
            <section id="exams" class="section d-none">
                <h2>Examination Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddExamModal()">Schedule Exam</button>
                <button class="btn btn-info mb-3" onclick="showEnterMarksModal()">Enter Marks</button>
                <button class="btn btn-success mb-3" onclick="generateAllReportCards()">Generate All Report Cards</button>
                <button class="btn btn-warning mb-3" onclick="generateHallTickets()">Generate Hall Tickets</button>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="examGradeFilter" class="form-control" onchange="renderExams()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="examSubjectFilter" class="form-control" placeholder="Filter by Subject" oninput="debounce(renderExams, 300)()">
                    </div>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Exam</th><th>Date</th><th>Subject</th><th>Grade</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="examTable"></tbody>
                </table>
                <div id="marksEntry" class="mt-4 d-none">
                    <h3>Enter Marks for <span id="marksExamName"></span></h3>
                    <table class="table table-striped">
                        <thead><tr><th>Student</th><th>Marks</th></tr></thead>
                        <tbody id="marksTable"></tbody>
                    </table>
                    <button class="btn btn-primary" onclick="saveMarks()">Save</button>
                </div>
            </section>

            <!-- Enhanced HR Management -->
            <section id="hr" class="section d-none admin-only">
                <h2>Human Resource Management</h2>
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#hr-staff"><i class="fas fa-users me-1"></i>Staff</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-payroll"><i class="fas fa-money-bill-wave me-1"></i>Payroll</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-leaves"><i class="fas fa-calendar-check me-1"></i>Leaves</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-performance"><i class="fas fa-star me-1"></i>Performance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-recruitment"><i class="fas fa-briefcase me-1"></i>Recruitment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-audit"><i class="fas fa-clipboard-list me-1"></i>Audit Trail</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active hr-tab" id="hr-staff">
                        <div class="d-flex justify-content-between mb-3">
                            <h5><i class="fas fa-users me-2"></i>Staff Directory</h5>
                            <button class="btn btn-primary" onclick="showAddStaffModal()"><i class="fas fa-plus me-2"></i>Add Staff</button>
                        </div>
                        <button class="btn btn-secondary mb-3" onclick="syncStaffBiometric()"><i class="fas fa-fingerprint me-2"></i>Sync Biometric</button>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Photo</th><th>Name</th><th>Role</th><th>Department</th><th>Salary</th><th>Tax #</th><th>UIF #</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="staffTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade hr-tab" id="hr-payroll">
                        <div class="d-flex justify-content-between mb-3">
                            <h5><i class="fas fa-money-bill-wave me-2"></i>Payroll Management</h5>
                            <div>
                                <button class="btn btn-primary me-2" onclick="showAddPayrollModal()"><i class="fas fa-plus me-2"></i>Add Payroll</button>
                                <button class="btn btn-info" onclick="generatePayroll()"><i class="fas fa-cogs me-2"></i>Generate Monthly</button>
                            </div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Month</th><th>Salary</th><th>Deductions</th><th>Net</th><th>Tax #</th><th>Actions</th></tr></thead>
                            <tbody id="payrollTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade hr-tab" id="hr-leaves">
                        <div class="d-flex justify-content-between mb-3">
                            <h5><i class="fas fa-calendar-check me-2"></i>Leave Requests</h5>
                            <div>
                                <input type="date" id="leaveDate" class="form-control me-2" style="width: auto;" onchange="loadLeaveRequests()">
                                <button class="btn btn-primary" onclick="showAddLeaveModal()"><i class="fas fa-plus me-2"></i>Add Request</button>
                            </div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>Staff</th><th>Date</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="leaveTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade hr-tab" id="hr-performance">
                        <div class="d-flex justify-content-between mb-3">
                            <h5><i class="fas fa-star me-2"></i>Performance Reviews</h5>
                            <button class="btn btn-primary" onclick="showAddReviewModal()"><i class="fas fa-plus me-2"></i>Add Review</button>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>Staff</th><th>Date</th><th>Score</th><th>Comments</th><th>Actions</th></tr></thead>
                            <tbody id="reviewTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade hr-tab" id="hr-recruitment">
                        <div class="d-flex justify-content-between mb-3">
                            <h5><i class="fas fa-briefcase me-2"></i>Job Postings & Applications</h5>
                            <button class="btn btn-primary" onclick="showAddJobModal()"><i class="fas fa-plus me-2"></i>Add Position</button>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Title</th><th>Department</th><th>Applications</th><th>Actions</th></tr></thead>
                            <tbody id="jobTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade hr-tab" id="hr-audit">
                        <h5><i class="fas fa-clipboard-list me-2"></i>Audit Trail</h5>
                        <table class="table table-striped">
                            <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
                            <tbody id="auditTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Communication Module -->
            <section id="communication" class="section d-none">
                <h2>Communication Hub</h2>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <textarea id="messageText" class="form-control" rows="3" placeholder="Type message..."></textarea>
                    </div>
                    <div class="col-md-3">
                        <select id="messageRecipient" class="form-control">
                            <option value="all">All</option>
                            <option value="parents">Parents</option>
                            <option value="students">Students</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success w-100" onclick="sendMessage()">Send Message</button>
                    </div>
                </div>
                <div id="messageHistory" class="mt-3"></div>
            </section>

            <!-- Content Module -->
            <section id="content" class="section d-none">
                <h2>Content Management</h2>
                <p>This comprehensive module hosts subjects, interventions, online lessons, textbooks, examinations, and work due. Filter by grade and subject for easy access.</p>
                <button class="btn btn-primary mb-3" onclick="showUploadContentModal()">Upload Content</button>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="contentGradeFilter" class="form-control" onchange="renderContent()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="contentSubjectFilter" class="form-control" placeholder="Filter by Subject" oninput="debounce(renderContent, 300)()">
                    </div>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Type</th><th>Name</th><th>Grade</th><th>Subject</th><th>Actions</th></tr></thead>
                    <tbody id="contentTable"></tbody>
                </table>
            </section>

            <!-- Reports -->
            <section id="reports" class="section d-none admin-only">
                <h2>Reports & Analytics</h2>
                <div class="row">
                    <div class="col-md-4"><button class="btn btn-primary w-100 mb-3" onclick="exportToExcel(students, 'students')">Export Students</button></div>
                    <div class="col-md-4"><button class="btn btn-success w-100 mb-3" onclick="exportToExcel(fees, 'fees')">Export Fees</button></div>
                    <div class="col-md-4"><button class="btn btn-info w-100 mb-3" onclick="exportToExcel(attendanceRecords, 'attendance')">Export Attendance</button></div>
                    <div class="col-md-4"><button class="btn btn-warning w-100 mb-3" onclick="exportToExcel(staff, 'staff')">Export Staff</button></div>
                    <div class="col-md-4"><button class="btn btn-danger w-100 mb-3" onclick="exportToExcel(payrolls, 'payrolls')">Export Payrolls</button></div>
                </div>
            </section>

            <!-- Settings -->
            <section id="settings" class="section d-none admin-only">
                <h2>System Settings</h2>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode(this.checked)">
                    <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
                </div>
                <h5>School Year</h5>
                <input type="text" id="schoolYear" class="form-control w-50" value="2025">
            </section>

            <!-- AI Research Module (Student Only) -->
            <section id="aiResearch" class="section d-none">
                <h2>AI Research Module - Powered by Grok</h2>
                <div class="mb-3">
                    <label>API Key (obtain from https://x.ai/api):</label>
                    <input type="text" id="grokApiKey" class="form-control" placeholder="Enter your xAI API Key">
                </div>
                <div id="chatHistory" class="border p-3 mb-3" style="height: 400px; overflow-y: auto;"></div>
                <div class="input-group">
                    <textarea id="grokQuery" class="form-control" rows="2" placeholder="Enter your research query..."></textarea>
                    <button class="btn btn-primary" onclick="sendGrokQuery()">Send</button>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals (Enhanced for HR) -->
    <!-- Staff Modal with Photo Preview -->
    <div class="modal fade" id="addStaffModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staffModalTitle">Add Staff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <img id="staffPhotoPreview" src="" alt="Staff Photo" class="staff-photo mb-3" style="display:none;">
                            <input type="file" id="staffPhoto" class="form-control" accept="image/*" onchange="previewStaffPhoto()">
                            <small class="text-muted">Upload photo (optional)</small>
                        </div>
                        <div class="col-md-8">
                            <input type="text" id="staffName" class="form-control mb-3" placeholder="Full Name *" required>
                            <select id="staffRole" class="form-control mb-3" required>
                                <option value="">Select Role</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Admin">Admin</option>
                                <option value="Support">Support</option>
                            </select>
                            <input type="text" id="staffDepartment" class="form-control mb-3" placeholder="Department">
                            <input type="number" id="staffSalary" class="form-control mb-3" placeholder="Salary (R) *" min="0" step="0.01" required>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" id="staffTaxNumber" class="form-control mb-3" placeholder="Tax Number">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" id="staffUifNumber" class="form-control mb-3" placeholder="UIF Number">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStaff()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payroll Modal -->
    <div class="modal fade" id="addPayrollModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="payrollModalTitle">Add Payroll</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <select id="payrollStaff" class="form-control mb-3" required>
                        <option value="">Select Staff</option>
                    </select>
                    <input type="month" id="payrollMonth" class="form-control mb-3" required>
                    <input type="number" id="payrollDeductions" class="form-control mb-3" placeholder="Deductions (R)" min="0" step="0.01">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePayroll()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Modal -->
    <div class="modal fade" id="addLeaveModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="leaveModalTitle">Add Leave Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <select id="leaveStaff" class="form-control mb-3" required>
                        <option value="">Select Staff</option>
                    </select>
                    <input type="date" id="leaveDate" class="form-control mb-3" required min="2025-01-01">
                    <textarea id="leaveReason" class="form-control mb-3" rows="3" placeholder="Reason *" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveLeave()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Approve/Reject Modal -->
    <div class="modal fade" id="leaveRequestModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Approve/Reject Leave</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <select id="leaveStatus" class="form-control mb-3">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <textarea id="leaveComments" class="form-control" rows="2" placeholder="Comments (optional)"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveLeaveStatus()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Review Modal -->
    <div class="modal fade" id="addReviewModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewModalTitle">Add Performance Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <select id="reviewStaff" class="form-control mb-3" required>
                        <option value="">Select Staff</option>
                    </select>
                    <input type="date" id="reviewDate" class="form-control mb-3" required>
                    <input type="number" id="reviewScore" class="form-control mb-3" min="0" max="100" placeholder="Score (0-100)" required>
                    <textarea id="reviewComments" class="form-control" rows="3" placeholder="Comments"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveReview()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Modal -->
    <div class="modal fade" id="addJobModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jobModalTitle">Add Job Position</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="jobTitle" class="form-control mb-3" placeholder="Job Title *" required>
                    <input type="text" id="jobDepartment" class="form-control mb-3" placeholder="Department">
                    <textarea id="jobDescription" class="form-control mb-3" rows="4" placeholder="Description *" required></textarea>
                    <button class="btn btn-secondary mb-3" onclick="demoApplyJob()">Demo: Staff Apply (for testing)</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveJob()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payslip Preview Modal (Enhanced) -->
    <div class="modal fade" id="payslipModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-invoice-dollar me-2"></i>Payslip Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="payslipPreview" class="payslip-preview border p-4 rounded" style="background: white; color: black;">
                        <div class="text-center mb-4">
                            <h4 class="text-primary"><i class="fas fa-school me-2"></i>ASMS - Bophelong Independent School</h4>
                            <p id="payslipStaff" class="fw-bold"></p>
                            <p id="payslipPeriod"></p>
                        </div>
                        <table class="table table-borderless">
                            <tr><th>Basic Salary</th><td id="payslipSalary">R0.00</td></tr>
                            <tr><th>Deductions</th><td id="payslipDeductions">R0.00</td></tr>
                            <tr><th><strong>Net Pay</strong></th><td class="fw-bold" id="payslipNet">R0.00</td></tr>
                        </table>
                        <div class="text-center mt-3">
                            <p><strong>Tax Number:</strong> <span id="payslipTaxNumber"></span></p>
                            <small class="text-muted">This is a computer-generated payslip</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="downloadPayslipPDF()"><i class="fas fa-download me-2"></i>Download PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Modals (unchanged for brevity) -->
    <!-- ... (Include all other modals from original document) ... -->

    <div class="modal fade" id="notificationsModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Notifications</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div id="notificationsList">No notifications</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Data (unchanged)
        let students = [];
        let admissions = [];
        let attendanceRecords = [];
        let fees = [];
        let exams = [];
        let staff = [];
        let payrolls = [];
        let leaveRequests = [];
        let performanceReviews = [];
        let jobs = [];
        let auditLog = [];
        let messages = [];
        let content = [];
        let timetables = {};
        let documents = {};
        let marks = {};
        let timeSlots = Array(8).fill().map((_, i) => ({start: `0${i + 8}:00`, end: `0${i + 9}:00`, label: ''}));
        let currentUser = null;
        let chatHistory = [];
        let editingCell = null;
        let editingFee = null;
        let currentStudentId = null;
        let currentMarksExam = null;
        let editingLeave = null;
        let editingReview = null;
        let editingPayroll = null;
        let editingJob = null;
        let editingStaff = null;
        let sidebarCollapsed = false;

        // Enhanced HR Initialization and Functions
        function renderHR() {
            populateStaffSelects();
            populateGradesForModal(); // For other selects
            renderStaff();
            renderPayrolls();
            loadLeaveRequests();
            renderReviews();
            renderJobs();
            renderAudit();
        }

        function populateStaffSelects() {
            const selects = ['#payrollStaff', '#leaveStaff', '#reviewStaff', '#editTimetableTeacher'];
            selects.forEach(sel => {
                const element = document.querySelector(sel);
                if (element) {
                    element.innerHTML = '<option value="">Select Staff</option>' + staff.map(s => `<option value="${s.id}">${s.name} (${s.role})</option>`).join('');
                }
            });
        }

        function previewStaffPhoto() {
            const file = document.getElementById('staffPhoto').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('staffPhotoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function renderStaff() {
            document.getElementById('staffTable').innerHTML = staff.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td><img src="${s.photo || ''}" alt="${s.name}" class="staff-photo" style="width:40px;height:40px;border-radius:50%;${!s.photo ? 'display:none;' : ''}"></td>
                    <td>${s.name}</td>
                    <td><span class="badge bg-${s.role === 'Admin' ? 'danger' : s.role === 'Teacher' ? 'primary' : 'secondary'}">${s.role}</span></td>
                    <td>${s.department || '-'}</td>
                    <td>R${(s.salary || 0).toFixed(2)}</td>
                    <td>${s.taxNumber || '-'}</td>
                    <td>${s.uifNumber || '-'}</td>
                    <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'danger'}">${s.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="showAddStaffModal(${s.id})" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-warning me-1" onclick="showAddReviewModal(${s.id})" title="Review"><i class="fas fa-star"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStaff(${s.id})" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddStaffModal(editId = null) {
            editingStaff = editId ? staff.find(s => s.id === editId) : null;
            document.getElementById('staffModalTitle').textContent = editingStaff ? 'Edit Staff' : 'Add Staff';
            if (editingStaff) {
                document.getElementById('staffName').value = editingStaff.name;
                document.getElementById('staffRole').value = editingStaff.role || '';
                document.getElementById('staffDepartment').value = editingStaff.department || '';
                document.getElementById('staffSalary').value = editingStaff.salary || '';
                document.getElementById('staffTaxNumber').value = editingStaff.taxNumber || '';
                document.getElementById('staffUifNumber').value = editingStaff.uifNumber || '';
                const preview = document.getElementById('staffPhotoPreview');
                if (editingStaff.photo) {
                    preview.src = editingStaff.photo;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
                document.getElementById('staffPhoto').value = '';
            } else {
                // Reset form
                ['staffName', 'staffRole', 'staffDepartment', 'staffSalary', 'staffTaxNumber', 'staffUifNumber'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('staffPhotoPreview').style.display = 'none';
                document.getElementById('staffPhoto').value = '';
            }
            new bootstrap.Modal(document.getElementById('addStaffModal')).show();
        }

        function saveStaff() {
            const name = document.getElementById('staffName').value.trim();
            const role = document.getElementById('staffRole').value;
            const department = document.getElementById('staffDepartment').value.trim();
            const salary = parseFloat(document.getElementById('staffSalary').value);
            const taxNumber = document.getElementById('staffTaxNumber').value.trim();
            const uifNumber = document.getElementById('staffUifNumber').value.trim();
            if (!name || !role || isNaN(salary) || salary <= 0) {
                return alert('Name, Role, and valid Salary are required.');
            }
            const photoFile = document.getElementById('staffPhoto').files[0];
            let photoData = editingStaff ? editingStaff.photo : null;
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoData = e.target.result;
                    finalizeSave({ name, role, department, salary, taxNumber, uifNumber, photo: photoData });
                };
                reader.readAsDataURL(photoFile);
            } else {
                finalizeSave({ name, role, department, salary, taxNumber, uifNumber, photo: photoData });
            }
            function finalizeSave(data) {
                data.status = editingStaff ? editingStaff.status : 'Active';
                if (editingStaff) {
                    Object.assign(editingStaff, data);
                    logAudit('Staff Updated', `ID: ${editingStaff.id}, Name: ${name}`);
                } else {
                    data.id = Date.now();
                    staff.push(data);
                    logAudit('Staff Added', `Name: ${name}, Role: ${role}`);
                }
                localStorage.setItem('staff', JSON.stringify(staff));
                renderStaff();
                populateStaffSelects();
                populateTeachers();
                bootstrap.Modal.getInstance(document.getElementById('addStaffModal')).hide();
                editingStaff = null;
            }
        }

        function deleteStaff(id) {
            if (confirm('Delete this staff member? This action cannot be undone.')) {
                const staffMember = staff.find(s => s.id === id);
                staff = staff.filter(s => s.id !== id);
                localStorage.setItem('staff', JSON.stringify(staff));
                renderStaff();
                populateStaffSelects();
                populateTeachers();
                logAudit('Staff Deleted', `ID: ${id}, Name: ${staffMember ? staffMember.name : 'Unknown'}`);
            }
        }

        // Payroll Functions (Enhanced with full monthly generation)
        function renderPayrolls() {
            document.getElementById('payrollTable').innerHTML = payrolls.map(p => {
                const s = staff.find(st => st.id === p.staffId);
                const net = (p.salary || 0) - (p.deductions || 0);
                return `
                    <tr>
                        <td>${p.id}</td>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>${p.month}</td>
                        <td>R${(p.salary || 0).toFixed(2)}</td>
                        <td>R${(p.deductions || 0).toFixed(2)}</td>
                        <td>R${net.toFixed(2)}</td>
                        <td>${s ? s.taxNumber : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewPayslip(${p.id})"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-secondary me-1" onclick="showAddPayrollModal(${p.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deletePayroll(${p.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAddPayrollModal(editId = null) {
            editingPayroll = editId ? payrolls.find(p => p.id === editId) : null;
            document.getElementById('payrollModalTitle').textContent = editingPayroll ? 'Edit Payroll' : 'Add Payroll';
            populateStaffSelects();
            if (editingPayroll) {
                document.getElementById('payrollStaff').value = editingPayroll.staffId;
                document.getElementById('payrollMonth').value = editingPayroll.month;
                document.getElementById('payrollDeductions').value = editingPayroll.deductions || '';
            } else {
                document.getElementById('payrollStaff').value = '';
                document.getElementById('payrollMonth').value = new Date().toISOString().slice(0,7);
                document.getElementById('payrollDeductions').value = '';
            }
            new bootstrap.Modal(document.getElementById('addPayrollModal')).show();
        }

        function savePayroll() {
            const staffId = parseInt(document.getElementById('payrollStaff').value);
            const month = document.getElementById('payrollMonth').value;
            const deductions = parseFloat(document.getElementById('payrollDeductions').value) || 0;
            if (!staffId || !month) return alert('Staff and Month required.');
            const staffMember = staff.find(s => s.id === staffId);
            if (!staffMember) return alert('Invalid staff selected.');
            const payrollData = {
                staffId,
                month,
                salary: staffMember.salary || 0,
                deductions
            };
            if (editingPayroll) {
                Object.assign(editingPayroll, payrollData);
                logAudit('Payroll Updated', `ID: ${editingPayroll.id}, Month: ${month}`);
            } else {
                payrollData.id = Date.now();
                payrolls.push(payrollData);
                logAudit('Payroll Added', `Staff ID: ${staffId}, Month: ${month}`);
            }
            localStorage.setItem('payrolls', JSON.stringify(payrolls));
            renderPayrolls();
            bootstrap.Modal.getInstance(document.getElementById('addPayrollModal')).hide();
            editingPayroll = null;
        }

        function deletePayroll(id) {
            if (confirm('Delete this payroll record?')) {
                const payroll = payrolls.find(p => p.id === id);
                payrolls = payrolls.filter(p => p.id !== id);
                localStorage.setItem('payrolls', JSON.stringify(payrolls));
                renderPayrolls();
                logAudit('Payroll Deleted', `ID: ${id}, Month: ${payroll ? payroll.month : 'Unknown'}`);
            }
        }

        function generatePayroll() {
            const currentMonth = new Date().toISOString().slice(0,7);
            let generatedCount = 0;
            staff.forEach(s => {
                if (!payrolls.some(p => p.staffId === s.id && p.month === currentMonth)) {
                    payrolls.push({
                        id: Date.now() + generatedCount,
                        staffId: s.id,
                        month: currentMonth,
                        salary: s.salary || 0,
                        deductions: 0
                    });
                    generatedCount++;
                }
            });
            localStorage.setItem('payrolls', JSON.stringify(payrolls));
            renderPayrolls();
            alert(`${generatedCount} payroll records generated for ${currentMonth}.`);
            logAudit('Payroll Generated', `Month: ${currentMonth}, Count: ${generatedCount}`);
        }

        function viewPayslip(id) {
            const p = payrolls.find(pr => pr.id === id);
            if (!p) return;
            const s = staff.find(st => st.id === p.staffId);
            if (!s) return;
            document.getElementById('payslipStaff').textContent = `Staff: ${s.name} (${s.role})`;
            document.getElementById('payslipPeriod').textContent = `Period: ${p.month}`;
            document.getElementById('payslipSalary').textContent = `R${(p.salary || 0).toFixed(2)}`;
            document.getElementById('payslipDeductions').textContent = `R${(p.deductions || 0).toFixed(2)}`;
            const net = (p.salary || 0) - (p.deductions || 0);
            document.getElementById('payslipNet').textContent = `R${net.toFixed(2)}`;
            document.getElementById('payslipTaxNumber').textContent = s.taxNumber || '-';
            new bootstrap.Modal(document.getElementById('payslipModal')).show();
        }

        function downloadPayslipPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const staffText = document.getElementById('payslipStaff').textContent;
            const periodText = document.getElementById('payslipPeriod').textContent;
            const salaryText = document.getElementById('payslipSalary').textContent;
            const deductionsText = document.getElementById('payslipDeductions').textContent;
            const netText = document.getElementById('payslipNet').textContent;
            const taxText = document.getElementById('payslipTaxNumber').textContent;
            doc.text('ASMS - Bophelong Independent School', 105, 20, { align: 'center' });
            doc.text(staffText, 20, 40);
            doc.text(periodText, 20, 50);
            doc.text(`Basic Salary: ${salaryText}`, 20, 60);
            doc.text(`Deductions: ${deductionsText}`, 20, 70);
            doc.text(`Net Pay: ${netText}`, 20, 80);
            doc.text(`Tax Number: ${taxText}`, 20, 90);
            doc.text('This is a computer-generated payslip', 105, 100, { align: 'center' });
            doc.save(`payslip-${Date.now()}.pdf`);
            logAudit('Payslip Downloaded', `Payroll ID: ${payrolls.find(p => p.id === parseInt(id)) ? id : 'Unknown'}`);
        }

        // Leaves Functions (Calendar-aware with date filtering)
        function loadLeaveRequests() {
            const date = document.getElementById('leaveDate').value;
            const filtered = leaveRequests.filter(l => !date || l.date === date);
            document.getElementById('leaveTable').innerHTML = filtered.map(l => {
                const s = staff.find(st => st.id === l.staffId);
                return `
                    <tr>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>${l.date}</td>
                        <td>${l.reason || 'N/A'}</td>
                        <td><span class="badge bg-${l.status === 'Approved' ? 'success' : l.status === 'Rejected' ? 'danger' : 'warning'}">${l.status || 'Pending'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary me-1" onclick="editLeave(${l.id})"><i class="fas fa-edit"></i> ${l.status === 'Pending' ? 'Approve/Reject' : 'Edit'}</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLeave(${l.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAddLeaveModal(editId = null) {
            editingLeave = editId ? leaveRequests.find(l => l.id === editId) : null;
            document.getElementById('leaveModalTitle').textContent = editingLeave ? 'Edit Leave Request' : 'Add Leave Request';
            populateStaffSelects();
            if (editingLeave) {
                document.getElementById('leaveStaff').value = editingLeave.staffId;
                document.getElementById('leaveDate').value = editingLeave.date;
                document.getElementById('leaveReason').value = editingLeave.reason || '';
            } else {
                document.getElementById('leaveStaff').value = '';
                document.getElementById('leaveDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('leaveReason').value = '';
            }
            new bootstrap.Modal(document.getElementById('addLeaveModal')).show();
        }

        function saveLeave() {
            const staffId = parseInt(document.getElementById('leaveStaff').value);
            const date = document.getElementById('leaveDate').value;
            const reason = document.getElementById('leaveReason').value.trim();
            if (!staffId || !date || !reason) return alert('All fields required.');
            const leaveData = {
                staffId,
                date,
                reason,
                status: editingLeave ? editingLeave.status : 'Pending',
                comments: editingLeave ? editingLeave.comments : ''
            };
            if (editingLeave) {
                Object.assign(editingLeave, leaveData);
                logAudit('Leave Request Updated', `ID: ${editingLeave.id}, Date: ${date}`);
            } else {
                leaveData.id = Date.now();
                leaveRequests.push(leaveData);
                logAudit('Leave Request Added', `Staff ID: ${staffId}, Date: ${date}`);
            }
            localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
            bootstrap.Modal.getInstance(document.getElementById('addLeaveModal')).hide();
            loadLeaveRequests();
            editingLeave = null;
        }

        function editLeave(id) {
            editingLeave = leaveRequests.find(l => l.id === id);
            if (!editingLeave) return;
            document.getElementById('leaveStatus').value = editingLeave.status || 'Pending';
            document.getElementById('leaveComments').value = editingLeave.comments || '';
            new bootstrap.Modal(document.getElementById('leaveRequestModal')).show();
        }

        function saveLeaveStatus() {
            if (!editingLeave) return;
            editingLeave.status = document.getElementById('leaveStatus').value;
            editingLeave.comments = document.getElementById('leaveComments').value.trim();
            localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
            bootstrap.Modal.getInstance(document.getElementById('leaveRequestModal')).hide();
            loadLeaveRequests();
            logAudit('Leave Status Updated', `ID: ${editingLeave.id}, Status: ${editingLeave.status}`);
            editingLeave = null;
        }

        function deleteLeave(id) {
            if (confirm('Delete this leave request?')) {
                const leave = leaveRequests.find(l => l.id === id);
                leaveRequests = leaveRequests.filter(l => l.id !== id);
                localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
                loadLeaveRequests();
                logAudit('Leave Deleted', `ID: ${id}, Date: ${leave ? leave.date : 'Unknown'}`);
            }
        }

        // Performance Reviews (With proper edit loading)
        function renderReviews() {
            document.getElementById('reviewTable').innerHTML = performanceReviews.map(r => {
                const s = staff.find(st => st.id === r.staffId);
                return `
                    <tr>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>${r.date}</td>
                        <td><span class="badge bg-${r.score >= 80 ? 'success' : r.score >= 60 ? 'warning' : 'danger'}">${r.score}/100</span></td>
                        <td>${r.comments || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary me-1" onclick="showAddReviewModal(${r.staffId}, ${r.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteReview(${r.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAddReviewModal(staffId = null, editId = null) {
            editingReview = editId ? performanceReviews.find(r => r.id === editId) : null;
            document.getElementById('reviewModalTitle').textContent = editingReview ? 'Edit Performance Review' : 'Add Performance Review';
            populateStaffSelects();
            if (editingReview) {
                document.getElementById('reviewStaff').value = editingReview.staffId;
                document.getElementById('reviewDate').value = editingReview.date;
                document.getElementById('reviewScore').value = editingReview.score;
                document.getElementById('reviewComments').value = editingReview.comments || '';
            } else {
                document.getElementById('reviewStaff').value = staffId || '';
                document.getElementById('reviewDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('reviewScore').value = '';
                document.getElementById('reviewComments').value = '';
            }
            new bootstrap.Modal(document.getElementById('addReviewModal')).show();
        }

        function saveReview() {
            const staffId = parseInt(document.getElementById('reviewStaff').value);
            const date = document.getElementById('reviewDate').value;
            const score = parseInt(document.getElementById('reviewScore').value);
            const comments = document.getElementById('reviewComments').value.trim();
            if (!staffId || !date || isNaN(score) || score < 0 || score > 100) return alert('Valid Staff, Date, and Score (0-100) required.');
            const reviewData = { staffId, date, score, comments };
            if (editingReview) {
                reviewData.id = editingReview.id;
                Object.assign(editingReview, reviewData);
                logAudit('Review Updated', `ID: ${editingReview.id}, Score: ${score}`);
            } else {
                reviewData.id = Date.now();
                performanceReviews.push(reviewData);
                logAudit('Performance Review Added', `Staff ID: ${staffId}, Score: ${score}`);
            }
            localStorage.setItem('performanceReviews', JSON.stringify(performanceReviews));
            bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
            renderReviews();
            editingReview = null;
        }

        function deleteReview(id) {
            if (confirm('Delete this review?')) {
                performanceReviews = performanceReviews.filter(r => r.id !== id);
                localStorage.setItem('performanceReviews', JSON.stringify(performanceReviews));
                renderReviews();
                logAudit('Review Deleted', `ID: ${id}`);
            }
        }

        // Recruitment (With demo application inbox)
        function renderJobs() {
            document.getElementById('jobTable').innerHTML = jobs.map(j => `
                <tr>
                    <td>${j.id}</td>
                    <td>${j.title}</td>
                    <td>${j.department || '-'}</td>
                    <td><span class="badge bg-info">${j.applications ? j.applications.length : 0}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="showAddJobModal(${j.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-info me-1" onclick="viewJobApplications(${j.id})"><i class="fas fa-envelope"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteJob(${j.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddJobModal(editId = null) {
            editingJob = editId ? jobs.find(j => j.id === editId) : null;
            document.getElementById('jobModalTitle').textContent = editingJob ? 'Edit Job Position' : 'Add Job Position';
            if (editingJob) {
                document.getElementById('jobTitle').value = editingJob.title;
                document.getElementById('jobDepartment').value = editingJob.department || '';
                document.getElementById('jobDescription').value = editingJob.description || '';
            } else {
                document.getElementById('jobTitle').value = '';
                document.getElementById('jobDepartment').value = '';
                document.getElementById('jobDescription').value = '';
            }
            new bootstrap.Modal(document.getElementById('addJobModal')).show();
        }

        function saveJob() {
            const title = document.getElementById('jobTitle').value.trim();
            const department = document.getElementById('jobDepartment').value.trim();
            const description = document.getElementById('jobDescription').value.trim();
            if (!title || !description) return alert('Title and Description required.');
            const jobData = { title, department, description, applications: editingJob ? editingJob.applications || [] : [] };
            if (editingJob) {
                jobData.id = editingJob.id;
                Object.assign(editingJob, jobData);
                logAudit('Job Position Updated', `ID: ${editingJob.id}, Title: ${title}`);
            } else {
                jobData.id = Date.now();
                jobs.push(jobData);
                logAudit('Job Position Added', `Title: ${title}`);
            }
            localStorage.setItem('jobs', JSON.stringify(jobs));
            bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
            renderJobs();
            editingJob = null;
        }

        function deleteJob(id) {
            if (confirm('Delete this job position? Applications will be lost.')) {
                jobs = jobs.filter(j => j.id !== id);
                localStorage.setItem('jobs', JSON.stringify(jobs));
                renderJobs();
                logAudit('Job Position Deleted', `ID: ${id}`);
            }
        }

        function demoApplyJob() {
            if (!editingJob && !jobs.length) return alert('Create a job first.');
            const currentJob = editingJob || jobs[jobs.length - 1];
            const demoApp = {
                id: Date.now(),
                applicant: staff[Math.floor(Math.random() * staff.length)]?.name || 'Demo Staff',
                timestamp: new Date().toLocaleString(),
                coverLetter: 'Demo application cover letter.'
            };
            if (!currentJob.applications) currentJob.applications = [];
            currentJob.applications.push(demoApp);
            localStorage.setItem('jobs', JSON.stringify(jobs));
            renderJobs();
            alert('Demo application added!');
            logAudit('Demo Job Application Added', `Job ID: ${currentJob.id}`);
        }

        function viewJobApplications(id) {
            const job = jobs.find(j => j.id === id);
            if (!job || !job.applications || job.applications.length === 0) {
                return alert('No applications for this position.');
            }
            let appsText = `Applications for ${job.title}:\n\n`;
            job.applications.forEach(app => {
                appsText += `Applicant: ${app.applicant}\nDate: ${app.timestamp}\nCover: ${app.coverLetter}\n\n`;
            });
            alert(appsText);
            // In production, use a modal with list
        }

        // Audit Trail (Enhanced logging for all HR actions)
        function logAudit(action, details) {
            const entry = {
                time: new Date().toLocaleString(),
                user: currentUser ? currentUser.username : 'System',
                role: currentUser ? currentUser.role : 'System',
                action,
                details
            };
            auditLog.unshift(entry);
            auditLog = auditLog.slice(0, 1000);
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
            renderAudit();
            updateNotificationBadge();
        }

        function renderAudit() {
            document.getElementById('auditTable').innerHTML = auditLog.slice(0, 50).map(a => `
                <tr>
                    <td><small>${a.time}</small></td>
                    <td><span class="badge bg-${a.role === 'admin' ? 'danger' : 'primary'}">${a.user} (${a.role})</span></td>
                    <td>${a.action}</td>
                    <td>${a.details}</td>
                </tr>
            `).join('');
        }

        // Utility Functions (unchanged or minor)
        function populateTeachers() {
            const select = document.getElementById('timetableTeacher');
            if (select) {
                select.innerHTML = '<option value="">Select Teacher</option>' + staff.filter(s => s.role === 'Teacher').map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            }
        }

        function syncStaffBiometric() {
            alert('Staff biometric data synced successfully. (Integration placeholder)');
            logAudit('Staff Biometric Synced', 'All active staff');
        }

        // Other utility functions like toggleSidebar, showSection, etc. (unchanged)
        function toggleSidebar() {
            sidebarCollapsed = !sidebarCollapsed;
            document.querySelector('.sidebar').classList.toggle('collapsed', sidebarCollapsed);
            document.querySelector('.content').classList.toggle('expanded', sidebarCollapsed);
            document.querySelector('.btn-toggle-sidebar').classList.toggle('expanded', sidebarCollapsed);
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
            document.getElementById(section).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.closest('.nav-link').classList.add('active');
            // Call renders
            if (section === 'hr') renderHR();
            // ... other sections
        }

        function toggleDarkMode(enabled) {
            document.body.classList.toggle('dark-mode', enabled);
            localStorage.setItem('darkMode', enabled);
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const recentCount = auditLog.filter(a => new Date(a.time) > new Date(Date.now() - 24 * 60 * 60 * 1000)).length;
            badge.textContent = recentCount;
            badge.style.display = recentCount > 0 ? 'block' : 'none';
        }

        // Placeholder functions for other modules (to avoid errors)
        function initApp() { /* Load all data */ }
        function login() { /* Login logic with demo users */ currentUser = { username: 'admin', role: 'admin' }; /* etc. */ location.reload(); }
        function biometricLogin() { alert('Biometric login placeholder.'); }
        function logout() { if (confirm('Logout?')) { localStorage.removeItem('currentUser'); location.reload(); } }
        // Add other placeholders as needed for full functionality

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Dark mode restore
            if (localStorage.getItem('darkMode') === 'true') toggleDarkMode(true);
            // Login handling
            if (localStorage.getItem('currentUser')) {
                currentUser = JSON.parse(localStorage.getItem('currentUser'));
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                // Load data from localStorage
                staff = safeParseJSON('staff', []);
                // ... load others
                initApp();
                updateNotificationBadge();
            }
        });

        // Safe JSON parse utility
        function safeParseJSON(key, defaultVal = []) {
            try {
                const val = localStorage.getItem(key);
                return val ? JSON.parse(val) : defaultVal;
            } catch (e) {
                console.error(`Error parsing ${key}:`, e);
                localStorage.removeItem(key);
                return defaultVal;
            }
        }
    </script>
</body>
</html>
