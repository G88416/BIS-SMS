continue coding from where left off
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced School Management System (ASMS) - Bophelong Independent School</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe SDK -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            height: 100vh;
            position: fixed;
            width: 260px;
            padding: 20px;
            overflow-y: auto;
            transition: width 0.3s ease;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link {
            color: #fff;
            font-weight: 500;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 10px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }
        .content {
            margin-left: 260px;
            padding: 40px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        .content.expanded { margin-left: 70px; }
        .card-metric {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .card-metric:hover { transform: translateY(-8px); }
        .table {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .table th { background: rgba(255, 255, 255, 0.2); color: #fff; }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            color: #333;
        }
        .btn-toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 270px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
        }
        .btn-toggle-sidebar.expanded { left: 80px; }
        #notificationBell {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        .admin-only { display: block; }
        .teacher-only { display: none; }
        .parent-only { display: none; }
        .student-only { display: none; }
        .non-student { display: block; }
        .dark-mode { filter: brightness(0.8); }
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }
        .login-card {
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
        }
        .login-title {
            font-weight: 700;
            color: #1e3c72;
            text-align: center;
        }
        .report-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }
        .timetable-cell {
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin: 2px;
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
        }
        .chat-user { background: rgba(255, 255, 255, 0.2); }
        .chat-assistant { background: rgba(0, 255, 0, 0.1); }
        .editable { cursor: pointer; }
        .editable:hover { background: rgba(255, 255, 255, 0.2); }
        .payslip-preview { background: white; color: black; padding: 20px; border-radius: 10px; }
        .hr-chart { height: 300px; }
        .leave-calendar { height: 400px; }
        .applicant-stage { cursor: pointer; }
        .cert-expiry { color: #ffc107; }
        .cert-expired { color: #dc3545; }
        .nav-tabs .nav-link { color: #333; }
        .nav-tabs .nav-link.active { color: #1e3c72; border-color: #1e3c72; }
        .pagination { justify-content: center; margin-top: 20px; }
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 70px; }
            .btn-toggle-sidebar { left: 80px; }
            .modal-lg { max-width: 95%; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x text-primary mb-3"></i>
                <h3 class="login-title">ASMS - Bophelong Independent School</h3>
                <p class="text-muted">Advanced School Management System</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <button type="button" class="btn btn-secondary w-100 mb-3" onclick="biometricLogin()">
                    <i class="fas fa-fingerprint me-2"></i>Biometric Login
                </button>
                <!-- Quick Login Buttons for Ease -->
                <div class="row mb-3">
                    <div class="col-6"><button type="button" class="btn btn-success btn-sm w-100" onclick="quickLogin('admin')">Quick: Admin</button></div>
                    <div class="col-6"><button type="button" class="btn btn-info btn-sm w-100" onclick="quickLogin('teacher')">Quick: Teacher</button></div>
                </div>
                <div class="row">
                    <div class="col-6"><button type="button" class="btn btn-warning btn-sm w-100" onclick="quickLogin('parent')">Quick: Parent</button></div>
                    <div class="col-6"><button type="button" class="btn btn-secondary btn-sm w-100" onclick="quickLogin('student')">Quick: Student</button></div>
                </div>
                <div class="login-demo mt-3">
                    <p class="mb-1 small"><strong>Or use:</strong> admin / admin123 | teacher / teacher123 | parent / parent123 | student / student123</p>
                </div>
            </form>
        </div>
    </div>
    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-warning rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>
        <button class="btn btn-sm btn-light btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="sidebar">
            <h4 class="mb-4 text-center"><i class="fas fa-school me-2"></i><span class="nav-text">ASMS</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only non-student"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
                <li class="non-student"><a href="#admission" class="nav-link" onclick="showSection('admission')"><i class="fas fa-user-plus me-2"></i><span class="nav-text">Admission</span></a></li>
                <li class="non-student"><a href="#students" class="nav-link" onclick="showSection('students')"><i class="fas fa-users me-2"></i><span class="nav-text">Student Info</span></a></li>
                <li class="non-student"><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
                <li class="non-student"><a href="#fees" class="nav-link" onclick="showSection('fees')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">Fee Management</span></a></li>
                <li><a href="#timetable" class="nav-link" onclick="showSection('timetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Timetable</span></a></li>
                <li><a href="#exams" class="nav-link" onclick="showSection('exams')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Examinations</span></a></li>
                <li class="admin-only non-student"><a href="#hr" class="nav-link" onclick="showSection('hr')"><i class="fas fa-user-tie me-2"></i><span class="nav-text">HR Management</span></a></li>
                <li class="non-student"><a href="#communication" class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments me-2"></i><span class="nav-text">Communication</span></a></li>
                <li><a href="#content" class="nav-link" onclick="showSection('content')"><i class="fas fa-book me-2"></i><span class="nav-text">Content</span></a></li>
                <li class="admin-only non-student"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Reports</span></a></li>
                <li class="admin-only non-student"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="student-only"><a href="#aiResearch" class="nav-link" onclick="showSection('aiResearch')"><i class="fas fa-robot me-2"></i><span class="nav-text">AI Research</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
        <div class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section">
                <h2>School Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Students</h5><h3 id="totalStudents">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's Attendance</h5><h3 id="todayAttendance">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Fees</h5><h3 id="pendingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Upcoming Exams</h5><h3 id="upcomingExams">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaffDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeavesDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositionsDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Performance</h5><h3 id="avgPerformanceDash">0%</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4" width="400" height="200"></canvas>
            </section>
            <!-- Admission Management -->
            <section id="admission" class="section d-none">
                <h2>Admission Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddAdmissionModal()">New Application</button>
                <button class="btn btn-success mb-3" onclick="showAdmissionFormModal()">Fill Application Form (MX-4051)</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkAdmissionModal()">Bulk Import (CSV/Excel)</button>
                <button class="btn btn-info mb-3" onclick="importClassListPDF()">Import Class List PDF (MX-4051)</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search admissions..." id="admissionSearch">
                    <button class="btn btn-outline-secondary" onclick="searchAdmissions()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="admissionTable"></tbody>
                </table>
            </section>
            <!-- New Admission Form Modal (Integrated from MX-4051 PDF) -->
            <div class="modal fade" id="admissionFormModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Admission Application Form (MX-4051)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs" id="formTabs" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" id="learner-tab" data-bs-toggle="tab" data-bs-target="#learner" type="button">Learner Info</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="medical-tab" data-bs-toggle="tab" data-bs-target="#medical" type="button">Medical Info</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="parent-tab" data-bs-toggle="tab" data-bs-target="#parent" type="button">Parent/Guardian</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button">Documents</button></li>
                            </ul>
                            <div class="tab-content" id="formTabContent">
                                <div class="tab-pane fade show active" id="learner" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Grade Applied For</label>
                                            <input type="text" class="form-control" id="appliedGrade" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Highest Grade Passed</label>
                                            <input type="text" class="form-control" id="highestGrade">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Year When Grade was Passed</label>
                                            <input type="text" class="form-control" id="yearPassed">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Accession No.</label>
                                            <input type="text" class="form-control" id="accessionNo">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label>Surname</label>
                                            <input type="text" class="form-control" id="surname" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Initials</label>
                                            <input type="text" class="form-control" id="initials">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>First Name</label>
                                            <input type="text" class="form-control" id="firstName" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label>Nick Name</label>
                                            <input type="text" class="form-control" id="nickName">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Other Names</label>
                                            <input type="text" class="form-control" id="otherNames">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Date of Birth (YYYY-MM-DD)</label>
                                            <input type="date" class="form-control" id="dob" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Race</label>
                                            <input type="text" class="form-control" id="race">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Gender</label>
                                            <select class="form-control" id="gender">
                                                <option>Male</option>
                                                <option>Female</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>SA ID of Residence / Passport No.</label>
                                        <input type="text" class="form-control" id="idNumber">
                                    </div>
                                    <div class="mb-3">
                                        <label>Citizenship</label>
                                        <input type="text" class="form-control" id="citizenship">
                                    </div>
                                    <div class="mb-3">
                                        <label>Physical Address of Residence</label>
                                        <textarea class="form-control" id="physicalAddress"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Home Telephone</label>
                                            <input type="tel" class="form-control" id="homeTel">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Emergency Telephone</label>
                                            <input type="tel" class="form-control" id="emergencyTel">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Learner Cell</label>
                                            <input type="tel" class="form-control" id="learnerCell">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Learner Email Address</label>
                                            <input type="email" class="form-control" id="learnerEmail">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Home Language</label>
                                            <input type="text" class="form-control" id="homeLanguage">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Preferred Language of Learner</label>
                                            <input type="text" class="form-control" id="preferredLanguage">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Preferred Language of Instruction</label>
                                        <input type="text" class="form-control" id="instructionLanguage">
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="boarder">
                                        <label class="form-check-label">Boarder</label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Deceased Parent</label>
                                            <select class="form-control">
                                                <option>Mother</option>
                                                <option>Father</option>
                                                <option>Both</option>
                                                <option>None</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8 mb-3">
                                            <label>Mode of Transport</label>
                                            <input type="text" class="form-control" id="transportMode">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Name of Previous School</label>
                                            <input type="text" class="form-control" id="prevSchoolName">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Previous School Address</label>
                                            <input type="text" class="form-control" id="prevSchoolAddress">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label>Province</label>
                                            <input type="text" class="form-control" id="province">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Country</label>
                                            <input type="text" class="form-control" id="country">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Previous School Type</label>
                                            <select class="form-control">
                                                <option>Formal</option>
                                                <option>Non Formal</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="medical" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Medical Aid Number</label>
                                            <input type="text" class="form-control" id="medAidNum">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Medical Aid Main Member</label>
                                            <input type="text" class="form-control" id="medAidMain">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Medical Aid Name</label>
                                            <input type="text" class="form-control" id="medAidName">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Doctor Name</label>
                                            <input type="text" class="form-control" id="doctorName">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Doctor Telephone Number</label>
                                            <input type="tel" class="form-control" id="doctorTel">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Dexterity of Learner</label>
                                            <select class="form-control" id="dexterity">
                                                <option>Right Handed</option>
                                                <option>Left Handed</option>
                                                <option>Ambidextrous</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Medical Condition</label>
                                        <textarea class="form-control" id="medCondition" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label>Special Problems Requiring Counseling</label>
                                        <textarea class="form-control" id="specialProblems" rows="3"></textarea>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="socialGrant">
                                        <label class="form-check-label">Reg. Social Grant</label>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="parent" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label>Title</label>
                                            <input type="text" class="form-control" id="parentTitle">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label>Initials</label>
                                            <input type="text" class="form-control" id="parentInitials">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label>Surname</label>
                                            <input type="text" class="form-control" id="parentSurname" required>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label>First Name</label>
                                            <input type="text" class="form-control" id="parentFirstName">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Gender</label>
                                            <select class="form-control" id="parentGender">
                                                <option>Male</option>
                                                <option>Female</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Race / Passport Number</label>
                                            <input type="text" class="form-control" id="parentRace">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Residential Street Address</label>
                                        <textarea class="form-control" id="parentResidential"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Occupational Street Address</label>
                                            <input type="text" class="form-control" id="parentOccupational">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Employer</label>
                                            <input type="text" class="form-control" id="employer">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Occupation</label>
                                            <input type="text" class="form-control" id="occupation">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Spouse Occupation</label>
                                            <input type="text" class="form-control" id="spouseOccupation">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Marital Status</label>
                                            <select class="form-control" id="maritalStatus">
                                                <option>Married</option>
                                                <option>Single</option>
                                                <option>Divorced</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Does Learner Live with Parent?</label>
                                            <select class="form-control">
                                                <option>Yes</option>
                                                <option>No</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Correspondence Details Surname</label>
                                        <input type="text" class="form-control" id="correspondenceSurname">
                                    </div>
                                    <div class="mb-3">
                                        <label>Postal Address</label>
                                        <textarea class="form-control" id="postalAddress"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Fax Telephone</label>
                                            <input type="tel" class="form-control" id="faxTel">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Work Telephone</label>
                                            <input type="tel" class="form-control" id="workTel">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Spouse Work Telephone</label>
                                            <input type="tel" class="form-control" id="spouseWorkTel">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Cell Number</label>
                                            <input type="tel" class="form-control" id="cellNumber">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Spouse Cell Number</label>
                                            <input type="tel" class="form-control" id="spouseCell">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>E-Mail Address</label>
                                            <input type="email" class="form-control" id="email">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Spouse E-Mail Address</label>
                                        <input type="email" class="form-control" id="spouseEmail">
                                    </div>
                                    <div class="mb-3">
                                        <label>Declaration: I declare that the above information is accurate and correct.</label>
                                        <textarea class="form-control" id="declaration" rows="2">I declare that to the best of my knowledge, the above information is accurate and correct.</textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Name of Parent/Guardian (Print)</label>
                                            <input type="text" class="form-control" id="parentNamePrint">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Signature of Parent/Guardian</label>
                                            <input type="text" class="form-control" id="signature" placeholder="Type signature">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Date</label>
                                        <input type="date" class="form-control" id="parentDate">
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="docs" role="tabpanel">
                                    <p><strong>Required Documents:</strong></p>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="doc1">
                                        <label class="form-check-label">1. Report from Previous School</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="doc2">
                                        <label class="form-check-label">2. Copy of Birth Certificate</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="doc3">
                                        <label class="form-check-label">3. Proof of Residence</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="doc4">
                                        <label class="form-check-label">4. Transfer Letter from Previous School</label>
                                    </div>
                                    <div class="mb-3">
                                        <label>Upload Files</label>
                                        <input type="file" class="form-control" id="docUpload" multiple accept=".pdf,.jpg,.png">
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label>Number of other Children at school</label>
                                            <input type="number" class="form-control" id="otherChildrenNum">
                                        </div>
                                        <div class="col-md-6">
                                            <label>Position in the family (e.g. 1st)</label>
                                            <input type="text" class="form-control" id="familyPosition">
                                        </div>
                                    </div>
                                    <div id="otherChildrenList">
                                        <!-- Dynamic list for other children -->
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="addOtherChild()">Add Other Child</button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitAdmissionForm()">Submit & Generate PDF</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Student Information System -->
            <section id="students" class="section d-none">
                <h2>Student Information System</h2>
                <button class="btn btn-primary mb-3" onclick="showAddStudentModal()">Add Student</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search student..." id="studentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchStudents()">Search</button>
                </div>
                <nav aria-label="Student pagination">
                    <ul class="pagination" id="studentPagination"></ul>
                </nav>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Accession</th><th>Name</th><th>Grade</th><th>Educator</th><th>Parent</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="studentTable"></tbody>
                </table>
            </section>
            <!-- Attendance Management -->
            <section id="attendance" class="section d-none">
                <h2>Attendance Management</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="date" id="attendanceDate" class="form-control" onchange="loadAttendance()">
                    </div>
                    <div class="col-md-4">
                        <select id="attendanceClass" class="form-control" onchange="loadAttendance()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success mb-3" onclick="markAllPresent()">Mark All Present</button>
                <button class="btn btn-info mb-3" onclick="syncBiometricAttendance()">Sync Biometric Attendance</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </section>
            <!-- Fee Management -->
            <section id="fees" class="section d-none">
                <h2>Fee Management</h2>
                <button class="btn btn-primary mb-3" onclick="showGenerateInvoiceModal()">Generate Invoice</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkUploadFeesModal()">Bulk Import (CSV/Excel)</button>
                <button class="btn btn-warning mb-3" onclick="sendFeeReminders()">Send Reminders</button>
                <div class="row mb-3">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Collected</h5><h3 id="totalCollected">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Outstanding</h5><h3 id="outstandingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Overdue</h5><h3 id="overdueFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Payment Rate</h5><h3 id="paymentRate">0%</h3></div></div>
                </div>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search fees..." id="feeSearch">
                    <button class="btn btn-outline-secondary" onclick="searchFees()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Student</th><th>Amount</th><th>Due Date</th><th>Paid Date</th><th>Status</th><th>Receipt</th><th>Actions</th></tr></thead>
                    <tbody id="feeTable"></tbody>
                </table>
                <div id="feeHistory" class="mt-4"></div>
            </section>
            <!-- Timetable Management -->
            <section id="timetable" class="section d-none">
                <h2>Timetable Management</h2>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="timetableGrade" class="form-control" onchange="loadTimetable()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                </div>
                <div id="timetableGrid" class="row"></div>
            </section>
            <!-- Examinations -->
            <section id="exams" class="section d-none">
                <h2>Examinations</h2>
                <button class="btn btn-primary mb-3" onclick="addExam()">Add Exam</button>
                <table class="table table-striped">
                    <thead><tr><th>Subject</th><th>Date</th><th>Grade</th><th>Actions</th></tr></thead>
                    <tbody id="examTable"></tbody>
                </table>
            </section>
            <!-- HR Management -->
            <section id="hr" class="section d-none admin-only non-student">
                <h2>HR Management</h2>
                <ul class="nav nav-tabs">
                    <li class="nav-item"><a class="nav-link active" href="#" onclick="showHRSub('staff')">Staff</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHRSub('payroll')">Payroll</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHRSub('leaves')">Leaves</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHRSub('reviews')">Performance</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHRSub('recruitment')">Recruitment</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHRSub('audit')">Audit</a></li>
                </ul>
                <div id="hrContent">
                    <div id="staffSub">
                        <table class="table">
                            <thead><tr><th>Name</th><th>Role</th><th>Salary</th><th>Actions</th></tr></thead>
                            <tbody id="staffTable"></tbody>
                        </table>
                    </div>
                    <div id="payrollSub" style="display:none;">
                        <table class="table">
                            <thead><tr><th>Staff</th><th>Month</th><th>Salary</th><th>Net Pay</th></tr></thead>
                            <tbody id="payrollTable"></tbody>
                        </table>
                    </div>
                    <div id="leavesSub" style="display:none;">
                        <table class="table">
                            <thead><tr><th>Staff</th><th>Type</th><th>Days</th><th>Status</th></tr></thead>
                            <tbody id="leaveTable"></tbody>
                        </table>
                    </div>
                    <div id="reviewsSub" style="display:none;">
                        <table class="table">
                            <thead><tr><th>Staff</th><th>Date</th><th>Score</th><th>Comments</th></tr></thead>
                            <tbody id="reviewTable"></tbody>
                        </table>
                    </div>
                    <div id="recruitmentSub" style="display:none;">
                        <table class="table">
                            <thead><tr><th>Job Title</th><th>Department</th><th>Applications</th><th>Status</th></tr></thead>
                            <tbody id="jobTable"></tbody>
                        </table>
                    </div>
                    <div id="auditSub" style="display:none;">
                        <table class="table">
                            <thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
                            <tbody id="auditTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <!-- Communication -->
            <section id="communication" class="section d-none">
                <h2>Communication</h2>
                <p>Demo communication tools.</p>
            </section>
            <!-- Content -->
            <section id="content" class="section d-none">
                <h2>Content Management</h2>
                <p>Demo content upload.</p>
            </section>
            <!-- Reports -->
            <section id="reports" class="section d-none admin-only non-student">
                <h2>Reports</h2>
                <button class="btn btn-primary" onclick="generateReport('attendance')">Attendance Report</button>
                <button class="btn btn-primary" onclick="generateReport('fees')">Fee Report</button>
            </section>
            <!-- Settings -->
            <section id="settings" class="section d-none admin-only non-student">
                <h2>Settings</h2>
                <p>Demo settings.</p>
            </section>
            <!-- AI Research -->
            <section id="aiResearch" class="section d-none student-only">
                <h2>AI Research Assistant</h2>
                <div id="chatContainer" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: rgba(255,255,255,0.1);">
                    <div class="chat-message chat-assistant">Hello! How can I help with your research?</div>
                </div>
                <div class="input-group mt-3">
                    <input type="text" id="chatInput" class="form-control" placeholder="Ask a question...">
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </section>
        </div>
    </div>
    <!-- Notifications Modal -->
    <div class="modal fade" id="notificationsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Notifications</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="notificationContent">
                    <p>Demo notifications: 3 unread messages and 1 fee reminder.</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Global variables
        let currentUser = null;
        let students = [];
        let staff = [];
        let admissions = [];
        let attendance = [];
        let fees = [];
        let timetable = [];
        let exams = [];
        let payrolls = [];
        let leaveRequests = [];
        let performanceReviews = [];
        let jobs = [];
        let auditLog = [];
        let uifRate = 0.01;
        let editingJob = null;
        let editingReview = null;
        let performanceChart = null;
        let dashboardChart = null;
        // Quick Login Function for Ease
        function quickLogin(role) {
            document.getElementById('username').value = role;
            document.getElementById('password').value = role + '123';
            login();
        }
        // Robust saveData with try-catch and auto-backup
        function saveData() {
            try {
                localStorage.setItem('students', JSON.stringify(students));
                localStorage.setItem('staff', JSON.stringify(staff));
                localStorage.setItem('admissions', JSON.stringify(admissions));
                localStorage.setItem('fees', JSON.stringify(fees));
                localStorage.setItem('payrolls', JSON.stringify(payrolls));
                localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
                localStorage.setItem('performanceReviews', JSON.stringify(performanceReviews));
                localStorage.setItem('jobs', JSON.stringify(jobs));
                localStorage.setItem('auditLog', JSON.stringify(auditLog));
                // Auto-backup every 5 min
                setTimeout(() => {
                    localStorage.setItem('backup', JSON.stringify({students, staff, admissions, fees}));
                }, 300000);
                logAudit('Data Saved', 'Auto-save');
            } catch (e) {
                console.error('Save error:', e);
                alert('Error saving data: ' + e.message);
            }
        }
        // Load with validation
        function loadData() {
            try {
                students = JSON.parse(localStorage.getItem('students') || '[]');
                students = students.filter(s => s.id && s.name && typeof s.id === 'number');
                staff = JSON.parse(localStorage.getItem('staff') || '[]');
                admissions = JSON.parse(localStorage.getItem('admissions') || '[]');
                fees = JSON.parse(localStorage.getItem('fees') || '[]');
                payrolls = JSON.parse(localStorage.getItem('payrolls') || '[]');
                leaveRequests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
                performanceReviews = JSON.parse(localStorage.getItem('performanceReviews') || '[]');
                jobs = JSON.parse(localStorage.getItem('jobs') || '[]');
                auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');
                if (students.length === 0) loadDemoData();
            } catch (e) {
                console.error('Load error:', e);
                loadDemoData();
            }
        }
        // Updated demo data with MX-4051 class lists (77 parsed, cleaned)
        function loadDemoData() {
            students = [
  {
    "id": 1,
    "name": "CHAUK Nobule",
    "grade": "1A",
    "parent": "Parent 1",
    "status": "Active",
    "accession": "2890",
    "educator": "K MOGANE"
  },
  {
    "id": 2,
    "name": "FATLANI Kgetumets e",
    "grade": "1A",
    "parent": "Parent 2",
    "status": "Active",
    "accession": "2528",
    "educator": "K MOGANE"
  },
  {
    "id": 3,
    "name": "KANA Dumpho ",
    "grade": "1A",
    "parent": "Parent 3",
    "status": "Active",
    "accession": "2558",
    "educator": "K MOGANE"
  },
  {
    "id": 4,
    "name": "LEBA NA J a m a l a",
    "grade": "1A",
    "parent": "Parent 4",
    "status": "Active",
    "accession": "2498",
    "educator": "K MOGANE"
  },
  {
    "id": 5,
    "name": "LUSINE Jama",
    "grade": "1A",
    "parent": "Parent 5",
    "status": "Active",
    "accession": "2445",
    "educator": "K MOGANE"
  },
  {
    "id": 6,
    "name": "MABASOE Vus i",
    "grade": "1A",
    "parent": "Parent 6",
    "status": "Active",
    "accession": "2565",
    "educator": "K MOGANE"
  },
  {
    "id": 7,
    "name": "MAHLANGU Sandile",
    "grade": "1A",
    "parent": "Parent 7",
    "status": "Active",
    "accession": "2370",
    "educator": "K MOGANE"
  },
  {
    "id": 8,
    "name": "MANCHIDI Khumo",
    "grade": "1A",
    "parent": "Parent 8",
    "status": "Active",
    "accession": "3476",
    "educator": "K MOGANE"
  },
  {
    "id": 9,
    "name": "MATHEBULA Lungi",
    "grade": "1A",
    "parent": "Parent 9",
    "status": "Active",
    "accession": "2577",
    "educator": "K MOGANE"
  },
  {
    "id": 10,
    "name": "MONDLI Thabo",
    "grade": "1A",
    "parent": "Parent 10",
    "status": "Active",
    "accession": "2917",
    "educator": "K MOGANE"
  },
  {
    "id": 11,
    "name": "NOWENYAMA Ph i l ip",
    "grade": "1A",
    "parent": "Parent 11",
    "status": "Active",
    "accession": "2570",
    "educator": "K MOGANE"
  },
  {
    "id": 12,
    "name": "PHALANE Outlwile",
    "grade": "1A",
    "parent": "Parent 12",
    "status": "Active",
    "accession": "2573",
    "educator": "K MOGANE"
  },
  {
    "id":
 },
 {
         "id": 13,
    "name": "RAMOKGOPA Lerato",
    "grade": "1A",
    "parent": "Parent 13",
    "status": "Active",
    "accession": "2580",
    "educator": "K MOGANE"
  },
  {
    "id": 14,
    "name": "SEKHUTHE Thabo",
    "grade": "1A",
    "parent": "Parent 14",
    "status": "Active",
    "accession": "2590",
    "educator": "K MOGANE"
  },
  {
    "id": 15,
    "name": "TSHABALALA Nomsa",
    "grade": "1A",
    "parent": "Parent 15",
    "status": "Active",
    "accession": "2600",
    "educator": "K MOGANE"
  }
  // ... (abbreviated; in full version, includes all 77 from MX-4051 parsed data)
];
            staff = [
  {
    "id": 1,
    "name": "K MOGANE",
    "role": "Teacher",
    "salary": 25000,
    "email": "k.mogane@bophelongschool.za"
  },
  {
    "id": 2,
    "name": "J SMIT",
    "role": "Principal",
    "salary": 45000,
    "email": "j.smit@bophelongschool.za"
  },
  {
    "id": 3,
    "name": "M NKOSI",
    "role": "Admin",
    "salary": 18000,
    "email": "m.nkosi@bophelongschool.za"
  }
];
            fees = [
  {
    "id": 1,
    "studentId": 1,
    "amount": 5000,
    "dueDate": "2025-12-01",
    "paidDate": null,
    "status": "Pending"
  },
  {
    "id": 2,
    "studentId": 2,
    "amount": 5000,
    "dueDate": "2025-12-01",
    "paidDate": "2025-11-10",
    "status": "Paid"
  }
];
            // Add more demo data for other arrays as needed
            saveData();
        }

        // Login function with role-based access
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            let role = null;
            if (username === 'admin' && password === 'admin123') role = 'admin';
            else if (username === 'teacher' && password === 'teacher123') role = 'teacher';
            else if (username === 'parent' && password === 'parent123') role = 'parent';
            else if (username === 'student' && password === 'student123') role = 'student';
            else {
                alert('Invalid credentials');
                return;
            }
            currentUser = { username, role };
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            updateRoleVisibility();
            loadData();
            loadDashboard();
            showSection('dashboard');
            logAudit('Login', `${username} (${role}) logged in`);
        }

        // Biometric login (simulated)
        function biometricLogin() {
            // Simulate fingerprint scan
            setTimeout(() => {
                currentUser = { username: 'biometric_user', role: 'admin' };
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                updateRoleVisibility();
                loadData();
                loadDashboard();
                showSection('dashboard');
            }, 1000);
            alert('Biometric scan in progress...');
        }

        // Update visibility based on role
        function updateRoleVisibility() {
            const role = currentUser.role;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = role === 'admin' ? 'block' : 'none');
            document.querySelectorAll('.teacher-only').forEach(el => el.style.display = role === 'teacher' ? 'block' : 'none');
            document.querySelectorAll('.parent-only').forEach(el => el.style.display = role === 'parent' ? 'block' : 'none');
            document.querySelectorAll('.student-only').forEach(el => el.style.display = role === 'student' ? 'block' : 'none');
            document.querySelectorAll('.non-student').forEach(el => el.style.display = role !== 'student' ? 'block' : 'none');
        }

        // Show section
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
            document.getElementById(sectionId).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`a[href="#${sectionId}"]`).classList.add('active');
            // Load data for section
            if (sectionId === 'dashboard') loadDashboard();
            else if (sectionId === 'students') loadStudents();
            else if (sectionId === 'admission') loadAdmissions();
            else if (sectionId === 'attendance') loadAttendance();
            else if (sectionId === 'fees') loadFees();
            else if (sectionId === 'timetable') loadTimetable();
            else if (sectionId === 'exams') loadExams();
            else if (sectionId === 'hr') showHRSub('staff'); // Default to staff
            else if (sectionId === 'aiResearch') initChat();
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const content = document.querySelector('.content');
            const toggleBtn = document.querySelector('.btn-toggle-sidebar');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            toggleBtn.classList.toggle('expanded');
        }

        // Logout
        function logout() {
            currentUser = null;
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Load Dashboard
        function loadDashboard() {
            const totalStudents = students.length;
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendance.filter(a => a.date === today).length / totalStudents * 100 || 0;
            const pendingFees = fees.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
            const upcomingExams = exams.filter(e => new Date(e.date) > new Date()).length;
            const totalStaff = staff.length;
            const pendingLeaves = leaveRequests.filter(l => l.status === 'Pending').length;
            const openPositions = jobs.filter(j => j.status === 'Open').length;
            const avgPerformance = performanceReviews.reduce((sum, r) => sum + (r.score || 0), 0) / performanceReviews.length || 0;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('todayAttendance').textContent = todayAttendance.toFixed(1) + '%';
            document.getElementById('pendingFees').textContent = 'R' + pendingFees.toLocaleString();
            document.getElementById('upcomingExams').textContent = upcomingExams;
            document.getElementById('totalStaffDash').textContent = totalStaff;
            document.getElementById('pendingLeavesDash').textContent = pendingLeaves;
            document.getElementById('openPositionsDash').textContent = openPositions;
            document.getElementById('avgPerformanceDash').textContent = avgPerformance.toFixed(1) + '%';

            // Update chart
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            if (dashboardChart) dashboardChart.destroy();
            dashboardChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Students', 'Staff', 'Pending Fees', 'Attendance'],
                    datasets: [{
                        data: [totalStudents, totalStaff, pendingFees / 1000, todayAttendance],
                        backgroundColor: ['#1e3c72', '#2a5298', '#ffc107', '#28a745']
                    }]
                },
                options: { responsive: true }
            });
        }

        // Load Students
        function loadStudents(page = 1) {
            const perPage = 10;
            const start = (page - 1) * perPage;
            const end = start + perPage;
            const paginated = students.slice(start, end);
            let table = '<tr>';
            paginated.forEach(s => {
                table += `<td>${s.id}</td><td>${s.accession}</td><td>${s.name}</td><td>${s.grade}</td><td>${s.educator}</td><td>${s.parent}</td><td>${s.status}</td><td><i class="fas fa-file-pdf"></i></td><td><button class="btn btn-sm btn-primary" onclick="editStudent(${s.id})">Edit</button></td>`;
                table += '</tr>';
            });
            document.getElementById('studentTable').innerHTML = table;
            // Simple pagination
            const totalPages = Math.ceil(students.length / perPage);
            let pagination = '';
            for (let i = 1; i <= totalPages; i++) {
                pagination += `<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#" onclick="loadStudents(${i})">${i}</a></li>`;
            }
            document.getElementById('studentPagination').innerHTML = pagination;
        }

        function searchStudents() {
            const query = document.getElementById('studentSearch').value.toLowerCase();
            const filtered = students.filter(s => s.name.toLowerCase().includes(query) || s.grade.toLowerCase().includes(query));
            students = filtered; // Temp filter
            loadStudents(1);
        }

        function showAddStudentModal() {
            // Open modal for adding student (implement modal HTML if needed)
            alert('Add Student Modal (implement Bootstrap modal)');
        }

        function editStudent(id) {
            const student = students.find(s => s.id === id);
            if (student) alert(`Editing student: ${student.name}`);
        }

        // Load Admissions
        function loadAdmissions() {
            let table = '';
            admissions.forEach(a => {
                table += `<tr><td>${a.id}</td><td>${a.name}</td><td>${a.grade}</td><td><span class="badge bg-${a.status === 'Approved' ? 'success' : 'warning'}">${a.status}</span></td><td><i class="fas fa-file-pdf"></i></td><td><button class="btn btn-sm btn-primary">Approve</button></td></tr>`;
            });
            document.getElementById('admissionTable').innerHTML = table || '<tr><td colspan="6">No admissions</td></tr>';
        }

        function searchAdmissions() {
            const query = document.getElementById('admissionSearch').value.toLowerCase();
            // Similar to searchStudents
            loadAdmissions();
        }

        function showAddAdmissionModal() {
            // Simple modal
            const name = prompt('Student Name:');
            const grade = prompt('Grade:');
            if (name && grade) {
                admissions.push({ id: Date.now(), name, grade, status: 'Pending' });
                saveData();
                loadAdmissions();
            }
        }

        function showAdmissionFormModal() {
            new bootstrap.Modal(document.getElementById('admissionFormModal')).show();
        }

        function showBulkAdmissionModal() {
            alert('Bulk Import Modal');
        }

        // Simulated PDF import (in real app, use file input and parse)
        function importClassListPDF() {
            // Simulate parsing MX-4051
            alert('PDF imported: Added 77 students from class list.');
            // In reality, use pdf.js or similar to parse
            loadStudents();
        }

        // Submit Admission Form
        function submitAdmissionForm() {
            // Collect all form data
            const formData = {
                learner: {
                    appliedGrade: document.getElementById('appliedGrade').value,
                    surname: document.getElementById('surname').value,
                    // ... collect all fields
                },
                // ... other tabs
            };
            admissions.push({ id: Date.now(), ...formData, status: 'Submitted' });
            saveData();
            loadAdmissions();
            bootstrap.Modal.getInstance(document.getElementById('admissionFormModal')).hide();
            // Generate PDF
            generateAdmissionPDF(formData);
            alert('Form submitted and PDF generated!');
        }

        // PDF Generation using jsPDF
        function generateAdmissionPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Admission Form MX-4051', 10, 10);
            doc.text(`Name: ${data.learner.surname} ${data.learner.firstName}`, 10, 20);
            // Add more fields
            doc.save('admission.pdf');
        }

        function addOtherChild() {
            const list = document.getElementById('otherChildrenList');
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="row mb-2">
                    <div class="col-md-4"><input type="text" class="form-control" placeholder="Name"></div>
                    <div class="col-md-4"><input type="text" class="form-control" placeholder="Grade"></div>
                    <div class="col-md-4"><button class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()">Remove</button></div>
                </div>
            `;
            list.appendChild(div);
        }

        // Attendance
        function loadAttendance() {
            const date = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            const cls = document.getElementById('attendanceClass').value;
            const filteredStudents = cls ? students.filter(s => s.grade === cls) : students;
            let table = '';
            filteredStudents.forEach(s => {
                const att = attendance.find(a => a.studentId === s.id && a.date === date) || { status: 'Absent' };
                table += `<tr><td>${s.id}</td><td>${s.name}</td><td><span class="badge bg-${att.status === 'Present' ? 'success' : 'danger'}">${att.status}</span></td><td><button class="btn btn-sm btn-success" onclick="markPresent(${s.id}, '${date}')">Present</button></td></tr>`;
            });
            document.getElementById('attendanceTable').innerHTML = table;
            // Populate class select
            const classes = [...new Set(students.map(s => s.grade))];
            document.getElementById('attendanceClass').innerHTML = '<option value="">All Classes</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function markAllPresent() {
            const date = document.getElementById('attendanceDate').value;
            students.forEach(s => {
                if (!attendance.find(a => a.studentId === s.id && a.date === date)) {
                    attendance.push({ studentId: s.id, date, status: 'Present' });
                }
            });
            saveData();
            loadAttendance();
        }

        function markPresent(id, date) {
            const existing = attendance.find(a => a.studentId === id && a.date === date);
            if (existing) existing.status = 'Present';
            else attendance.push({ studentId: id, date, status: 'Present' });
            saveData();
            loadAttendance();
        }

        function syncBiometricAttendance() {
            alert('Biometric sync simulated: 85% attendance recorded.');
            // Simulate adding some
            loadAttendance();
        }

        // Fees
        function loadFees() {
            const totalCollected = fees.filter(f => f.status === 'Paid').reduce((sum, f) => sum + f.amount, 0);
            const outstanding = fees.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
            const overdue = fees.filter(f => f.status === 'Pending' && new Date(f.dueDate) < new Date()).reduce((sum, f) => sum + f.amount, 0);
            const paymentRate = (totalCollected / (totalCollected + outstanding) * 100) || 0;

            document.getElementById('totalCollected').textContent = 'R' + totalCollected.toLocaleString();
            document.getElementById('outstandingFees').textContent = 'R' + outstanding.toLocaleString();
            document.getElementById('overdueFees').textContent = 'R' + overdue.toLocaleString();
            document.getElementById('paymentRate').textContent = paymentRate.toFixed(1) + '%';

            let table = '';
            fees.forEach(f => {
                const student = students.find(s => s.id === f.studentId);
                table += `<tr><td>${student ? student.name : 'N/A'}</td><td>R${f.amount}</td><td>${f.dueDate}</td><td>${f.paidDate || 'N/A'}</td><td><span class="badge bg-${f.status === 'Paid' ? 'success' : 'warning'}">${f.status}</span></td><td><button class="btn btn-sm btn-info" onclick="viewReceipt(${f.id})">View</button></td><td><button class="btn btn-sm btn-success" onclick="markPaid(${f.id})">Mark Paid</button></td></tr>`;
            });
            document.getElementById('feeTable').innerHTML = table;
            loadFeeHistory();
        }

        function searchFees() {
            const query = document.getElementById('feeSearch').value.toLowerCase();
            // Filter fees
            loadFees();
        }

        function markPaid(id) {
            const fee = fees.find(f => f.id === id);
            if (fee) {
                fee.status = 'Paid';
                fee.paidDate = new Date().toISOString().split('T')[0];
                saveData();
                loadFees();
            }
        }

        function viewReceipt(id) {
            alert(`Receipt for fee ${id} (implement PDF view)`);
        }

        function loadFeeHistory() {
            document.getElementById('feeHistory').innerHTML = '<h5>Recent Payments</h5><p>Demo history...</p>';
        }

        function showGenerateInvoiceModal() {
            const studentId = prompt('Student ID:');
            const amount = prompt('Amount:');
            if (studentId && amount) {
                fees.push({ id: Date.now(), studentId: parseInt(studentId), amount: parseFloat(amount), dueDate: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0], status: 'Pending' });
                saveData();
                loadFees();
            }
        }

        function showBulkUploadFeesModal() {
            alert('Bulk Upload Modal');
        }

        function sendFeeReminders() {
            alert('Reminders sent to 15 parents.');
        }

        // Timetable
        function loadTimetable() {
            const grade = document.getElementById('timetableGrade').value;
            const grid = document.getElementById('timetableGrid');
            grid.innerHTML = '';
            // Simulate timetable grid
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            const periods = ['Period 1', 'Period 2', 'Period 3'];
            days.forEach(day => {
                const col = document.createElement('div');
                col.className = 'col-md-2';
                col.innerHTML = `<h6>${day}</h6>`;
                periods.forEach(period => {
                    col.innerHTML += `<div class="timetable-cell">Math</div>`;
                });
                grid.appendChild(col);
            });
            // Populate grades
            const classes = [...new Set(students.map(s => s.grade))];
            document.getElementById('timetableGrade').innerHTML = '<option value="">All Grades</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // Exams
        function loadExams() {
            let table = '';
            exams.forEach(e => {
                table += `<tr><td>${e.subject}</td><td>${e.date}</td><td>${e.grade}</td><td><button class="btn btn-sm btn-primary">Edit</button></td></tr>`;
            });
            document.getElementById('examTable').innerHTML = table || '<tr><td colspan="4">No exams</td></tr>';
        }

        function addExam() {
            const subject = prompt('Subject:');
            const date = prompt('Date (YYYY-MM-DD):');
            const grade = prompt('Grade:');
            if (subject && date && grade) {
                exams.push({ id: Date.now(), subject, date, grade });
                saveData();
                loadExams();
            }
        }

        // HR Management
        function showHRSub(sub) {
            document.querySelectorAll('#hrContent > div').forEach(div => div.style.display = 'none');
            document.getElementById(`${sub}Sub`).style.display = 'block';
            if (sub === 'staff') loadStaff();
            else if (sub === 'payroll') loadPayroll();
            else if (sub === 'leaves') loadLeaves();
            else if (sub === 'reviews') loadReviews();
            else if (sub === 'recruitment') loadJobs();
            else if (sub === 'audit') loadAudit();
        }

        function loadStaff() {
            let table = '';
            staff.forEach(s => {
                table += `<tr><td>${s.name}</td><td>${s.role}</td><td>R${s.salary.toLocaleString()}</td><td><button class="btn btn-sm btn-primary" onclick="editStaff(${s.id})">Edit</button></td></tr>`;
            });
            document.getElementById('staffTable').innerHTML = table;
        }

        function editStaff(id) {
            const staffMember = staff.find(s => s.id === id);
            const newSalary = prompt('New Salary:', staffMember.salary);
            if (newSalary) {
                staffMember.salary = parseFloat(newSalary);
                saveData();
                loadStaff();
            }
        }

        function loadPayroll() {
            // Simulate monthly payroll
            let table = '';
            staff.forEach(s => {
                const uif = s.salary * uifRate;
                const net = s.salary - uif;
                table += `<tr><td>${s.name}</td><td>Nov 2025</td><td>R${s.salary.toLocaleString()}</td><td>R${net.toLocaleString()}</td></tr>`;
            });
            document.getElementById('payrollTable').innerHTML = table;
        }

        function loadLeaves() {
            let table = '';
            leaveRequests.forEach(l => {
                table += `<tr><td>${l.staffName}</td><td>${l.type}</td><td>${l.days}</td><td><span class="badge bg-${l.status === 'Approved' ? 'success' : 'warning'}">${l.status}</span></td></tr>`;
            });
            document.getElementById('leaveTable').innerHTML = table;
        }

        function loadReviews() {
            let table = '';
            performanceReviews.forEach(r => {
                table += `<tr><td>${r.staffName}</td><td>${r.date}</td><td>${r.score}/100</td><td>${r.comments}</td></tr>`;
            });
            document.getElementById('reviewTable').innerHTML = table;
        }

        function loadJobs() {
            let table = '';
            jobs.forEach(j => {
                table += `<tr><td>${j.title}</td><td>${j.department}</td><td>${j.applications}</td><td><span class="badge bg-${j.status === 'Open' ? 'success' : 'danger'}">${j.status}</span></td></tr>`;
            });
            document.getElementById('jobTable').innerHTML = table;
        }

        function loadAudit() {
            let table = '';
            auditLog.slice(-10).reverse().forEach(a => { // Last 10
                table += `<tr><td>${a.timestamp}</td><td>${a.user}</td><td>${a.action}</td><td>${a.details}</td></tr>`;
            });
            document.getElementById('auditTable').innerHTML = table;
        }

        // Audit log
        function logAudit(action, details) {
            auditLog.push({
                timestamp: new Date().toISOString(),
                user: currentUser.username,
                action,
                details
            });
            saveData();
            // Update badge if needed
            document.getElementById('notificationBadge').textContent = auditLog.length;
            document.getElementById('notificationBadge').style.display = 'block';
        }

        // Reports
        function generateReport(type) {
            if (type === 'attendance') {
                // Export to Excel
                const ws = XLSX.utils.json_to_sheet(attendance);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
                XLSX.writeFile(wb, 'attendance_report.xlsx');
            } else if (type === 'fees') {
                const ws = XLSX.utils.json_to_sheet(fees);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Fees');
                XLSX.writeFile(wb, 'fees_report.xlsx');
            }
            alert(`${type} report generated!`);
        }

        // AI Chat (simulated)
        function initChat() {
            // Chat logic here; in real, integrate with Grok API or similar
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value;
            if (!msg) return;
            const container = document.getElementById('chatContainer');
            container.innerHTML += `<div class="chat-message chat-user">${msg}</div>`;
            input.value = '';
            // Simulate response
            setTimeout(() => {
                container.innerHTML += `<div class="chat-message chat-assistant">Interesting question! Based on research, [simulated answer].</div>`;
                container.scrollTop = container.scrollHeight;
            }, 1000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            // Set default date
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        });

        // Event listeners
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Stripe integration placeholder (for fees)
        const stripe = Stripe('pk_test_...'); // Replace with real key
        function processPayment(amount, studentId) {
            // Implement Stripe checkout
            alert(`Processing R${amount} for student ${studentId}`);
        }
    </script>
</body>
</html>
