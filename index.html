 

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Advanced School Management System (BIS) - Bophelong Independent School (Mamelodi)</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Advanced School Management System for Bophelong Independent School (BIS) - Mamelodi. Manage students, attendance, fees, and more.">
    <meta name="theme-color" content="#667eea">
    <!-- iOS: Enable full-screen standalone mode when added to home screen -->
    <!-- Note: This hides Safari UI for app-like experience. Users can still access browser by re-opening from Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BIS Management">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <!-- Note: Using external icon URL. For offline reliability, consider hosting locally -->
    <link rel="apple-touch-icon" href="https://img1.wsimg.com/isteam/ip/33f55342-69d0-4c3b-9478-c9e1f81bbc39/blob.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe SDK -->
    
    <!-- PeerJS for WebRTC Video/Voice Calling -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- Socket.IO for WebRTC Signaling -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --primary-gradient-start: #1a1a2e;
            --primary-gradient-end: #16213e;
            --accent-primary: #e94560;
            --accent-secondary: #ff6b6b;
            --accent-tertiary: #0f3460;
            --text-color: #fff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-bg-hover: rgba(255, 255, 255, 0.15);
            --card-border: rgba(255, 255, 255, 0.12);
            --sidebar-bg: rgba(255, 255, 255, 0.08);
            --sidebar-border: rgba(255, 255, 255, 0.15);
            --table-bg: rgba(255, 255, 255, 0.05);
            --table-th-bg: rgba(233, 69, 96, 0.2);
            --btn-toggle-bg: rgba(255, 255, 255, 0.15);
            --glow-color: rgba(233, 69, 96, 0.4);
            --glass-blur: blur(20px);
        }
        
        /* ============================================
           ENHANCED MAIN APPLICATION STYLES
           Modern, Beautiful & Interactive Design
           ============================================ */
        
        body {
            font-family: 'Poppins', sans-serif;
            font-size: 13.33px;
            background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
            color: var(--text-color);
            min-height: 100vh;
            transition: background 0.5s ease;
            position: relative;
        }
        
        /* Animated Background Overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(233, 69, 96, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(15, 52, 96, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(255, 107, 107, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: ambientGlow 25s ease-in-out infinite alternate;
        }
        
        @keyframes ambientGlow {
            0% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        /* Floating Particles Animation */
        @keyframes floatParticle {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.6; }
        }
        /* Enhanced Sidebar */
        .sidebar {
            background: var(--sidebar-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-right: 1px solid var(--sidebar-border);
            height: 100vh;
            position: fixed;
            width: 260px;
            padding: 20px;
            overflow-y: auto;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.4);
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
            padding: 14px 16px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .sidebar .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary));
            transform: scaleY(0);
            transition: transform 0.3s ease;
            pointer-events: none;
        }
        .sidebar .nav-link:hover {
            background: rgba(233, 69, 96, 0.15);
            color: #fff;
            transform: translateX(8px);
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.2);
            border-color: rgba(233, 69, 96, 0.3);
        }
        .sidebar .nav-link:hover::before {
            transform: scaleY(1);
        }
        .sidebar .nav-link.active {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.25), rgba(255, 107, 107, 0.15));
            color: #fff;
            font-weight: 600;
            box-shadow: 0 6px 25px rgba(233, 69, 96, 0.3);
            border-color: rgba(233, 69, 96, 0.4);
        }
        .sidebar .nav-link.active::before {
            transform: scaleY(1);
        }
        .sidebar .nav-link i {
            transition: transform 0.3s ease, color 0.3s ease;
        }
        .sidebar .nav-link:hover i,
        .sidebar .nav-link.active i {
            color: var(--accent-primary);
            transform: scale(1.1);
        }
        
        .logo-image {
            width: 60px;
            height: auto;
            display: block;
            margin: 0 auto 0.5rem auto;
            filter: drop-shadow(0 4px 15px rgba(233, 69, 96, 0.3));
            transition: transform 0.3s ease;
        }
        .logo-image:hover {
            transform: scale(1.05) rotate(2deg);
        }
        
        /* Enhanced Content Area */
        .content {
            margin-left: 260px;
            padding: 40px;
            transition: margin-left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }
        .content.expanded { margin-left: 70px; }
        
        /* Section Headings Enhancement */
        .section > h2 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
            position: relative;
            display: inline-block;
        }
        .section > h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 2px;
        }
        
        /* Enhanced Metric Cards with Glassmorphism */
        .card-metric {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }
        .card-metric::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s ease;
            pointer-events: none;
        }
        .card-metric:hover::before {
            left: 100%;
        }
        .card-metric:hover { 
            transform: translateY(-10px) scale(1.02);
            box-shadow: 
                0 20px 50px rgba(233, 69, 96, 0.2),
                0 10px 25px rgba(0, 0, 0, 0.3),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            border-color: rgba(233, 69, 96, 0.4);
        }
        .card-metric h5 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .card-metric h5 i {
            color: var(--accent-primary);
            margin-right: 8px;
        }
        .card-metric h3 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }
        
        /* Enhanced Tables */
        .table {
            background: var(--table-bg);
            border-radius: 16px;
            overflow: hidden;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .table th { 
            background: var(--table-th-bg); 
            color: var(--text-color); 
            transition: background 0.5s ease; 
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            padding: 16px 12px;
            border: none;
        }
        .table td {
            padding: 14px 12px;
            border-color: rgba(255, 255, 255, 0.05);
            vertical-align: middle;
        }
        .table tbody tr {
            transition: all 0.3s ease;
        }
        .table tbody tr:hover {
            background: rgba(233, 69, 96, 0.1);
        }
        
        /* Enhanced Modal - Fallback CSS for when Bootstrap CSS doesn't load */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1055;
            display: none;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            outline: 0;
        }
        .modal.fade {
            opacity: 0;
            transition: opacity 0.15s linear;
        }
        .modal.show {
            display: block !important;
            opacity: 1;
        }
        .modal-dialog {
            position: relative;
            width: auto;
            margin: 1.75rem auto;
            max-width: 500px;
            pointer-events: none;
        }
        .modal-dialog.modal-lg {
            max-width: 800px;
        }
        .modal.show .modal-dialog {
            pointer-events: auto;
        }
        .modal-backdrop {
            display: none !important;
        }
        .modal-content {
            position: relative;
            pointer-events: auto;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
            border-radius: 24px;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
        }
        .modal-header .modal-title {
            color: #fff;
            font-weight: 600;
        }
        .modal-header .btn-close {
            filter: invert(1);
        }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-body .form-label {
            color: var(--text-secondary);
            font-weight: 500;
        }
        .modal-body .form-control,
        .modal-body .form-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 10px;
        }
        .modal-body .form-control:focus,
        .modal-body .form-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
            color: #fff;
        }
        .modal-body .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
        }
        
        /* Enhanced Buttons */
        .btn {
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
            pointer-events: none;
        }
        .btn:hover::before {
            width: 300%;
            height: 300%;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(233, 69, 96, 0.4);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #34d399);
            border: none;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #34d399, #10b981);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #f87171);
            border: none;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #f87171, #ef4444);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            border: none;
            color: #1a1a2e;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
            color: #1a1a2e;
        }
        .btn-info {
            background: linear-gradient(135deg, #0ea5e9, #38bdf8);
            border: none;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }
        .btn-info:hover {
            background: linear-gradient(135deg, #38bdf8, #0ea5e9);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.4);
        }
        
        /* Remove box-shadow when button is selected/focused */
        .btn:focus,
        .btn:active,
        .btn:focus:active {
            box-shadow: none;
            outline: none;
        }
        
        /* Enhanced Form Controls */
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.15);
            color: #fff;
        }
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .form-label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        /* Enhanced Alerts */
        .alert {
            border-radius: 14px;
            border: none;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
        }
        .alert-info {
            background: rgba(14, 165, 233, 0.15);
            border-left: 4px solid #0ea5e9;
            color: #fff;
        }
        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            border-left: 4px solid #10b981;
            color: #fff;
        }
        .alert-warning {
            background: rgba(245, 158, 11, 0.15);
            border-left: 4px solid #f59e0b;
            color: #fff;
        }
        .alert-danger {
            background: rgba(239, 68, 68, 0.15);
            border-left: 4px solid #ef4444;
            color: #fff;
        }
        
        /* Enhanced Badges */
        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.8rem;
        }
        .badge.bg-success {
            background: linear-gradient(135deg, #10b981, #34d399) !important;
        }
        .badge.bg-danger {
            background: linear-gradient(135deg, #ef4444, #f87171) !important;
        }
        .badge.bg-warning {
            background: linear-gradient(135deg, #f59e0b, #fbbf24) !important;
            color: #1a1a2e !important;
        }
        .badge.bg-info {
            background: linear-gradient(135deg, #0ea5e9, #38bdf8) !important;
        }
        .badge.bg-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)) !important;
        }
        
        /* Fallback CSS for Bootstrap tab-pane visibility */
        .tab-pane:not(.active):not(.show) {
            display: none !important;
        }
        .tab-pane.active,
        .tab-pane.show.active {
            display: block !important;
        }
        
        /* Enhanced Nav Tabs */
        .nav-tabs {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 14px;
            padding: 8px;
            margin-bottom: 20px;
        }
        .nav-tabs .nav-link {
            color: var(--text-secondary);
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            margin: 0 4px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .nav-tabs .nav-link:hover {
            background: rgba(233, 69, 96, 0.15);
            color: #fff;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: #fff;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }
        
        /* Enhanced shadow effect for pressed/active tabs - mouse-friendly */
        .nav-tabs .nav-link:active,
        .nav-tabs .nav-link:focus {
            outline: none;
            pointer-events: auto;
        }
        
        .nav-tabs .nav-link.active:active,
        .nav-tabs .nav-link.active:focus {
            outline: none;
            pointer-events: auto;
        }
        
        /* Finance Management Table - Status, Receipt, Action columns alignment */
        #fees table th:nth-child(5),
        #fees table td:nth-child(5),
        #fees table th:nth-child(6),
        #fees table td:nth-child(6),
        #fees table th:nth-child(7),
        #fees table td:nth-child(7) {
            font-size: calc(0.875rem - 3pt);
            padding: 10px 8px;
            text-align: center;
            white-space: nowrap;
        }
        
        #fees table td:nth-child(5) .badge {
            font-size: calc(0.8rem - 3pt);
            padding: 4px 10px;
        }
        
        #fees table td:nth-child(6) .btn,
        #fees table td:nth-child(7) .btn {
            font-size: calc(0.8rem - 3pt);
            padding: 5px 10px;
            margin: 1px;
        }
        
        .btn-toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 270px;
            z-index: 1001;
            background: var(--btn-toggle-bg);
            border: none;
            color: var(--text-color);
            transition: all 0.3s ease;
            border-radius: 10px;
            padding: 10px 14px;
        }
        .btn-toggle-sidebar:hover {
            background: rgba(233, 69, 96, 0.3);
            transform: scale(1.05);
        }
        .btn-toggle-sidebar.expanded { left: 80px; }
        #notificationBell {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        .admin-only { display: block; }
        .hod-only { display: none; }
        .teacher-only { display: none; }
        
        
        
        
        .dark-mode { filter: brightness(0.8); }
        
        /* Enhanced Login Page */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
            position: relative;
            overflow: hidden;
        }
        .login-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(233, 69, 96, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(15, 52, 96, 0.3) 0%, transparent 40%);
            pointer-events: none;
            animation: ambientGlow 20s ease-in-out infinite alternate;
        }
        .login-card {
            width: 100%;
            max-width: 450px;
            padding: 3rem;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.4),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }
        .login-card .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 14px 18px;
            border-radius: 12px;
        }
        .login-card .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.2);
            color: #fff;
        }
        .login-card .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .login-card .form-label {
            color: rgba(255, 255, 255, 0.8);
        }
        .login-card .btn-primary {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-weight: 600;
        }
        .login-title {
            font-weight: 700;
            background: linear-gradient(135deg, #fff, var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        .login-card .logo-image {
            width: 100px;
            margin-bottom: 1rem;
        }
        
        .report-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            margin: 10px 0;
            backdrop-filter: var(--glass-blur);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .timetable-cell {
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            margin: 3px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        .timetable-cell:hover {
            background: rgba(233, 69, 96, 0.15);
            border-color: rgba(233, 69, 96, 0.3);
        }
        .chat-message {
            margin-bottom: 12px;
            padding: 14px 18px;
            border-radius: 14px;
        }
        .chat-user { 
            background: rgba(233, 69, 96, 0.15); 
            border-left: 3px solid var(--accent-primary);
        }
        .chat-assistant { 
            background: rgba(16, 185, 129, 0.15); 
            border-left: 3px solid #10b981;
        }
        
        /* Voice Note and Voice Call Styles */
        .recording-indicator {
            animation: pulse-recording 1s infinite;
        }
        @keyframes pulse-recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .voice-note-message {
            background: rgba(14, 165, 233, 0.15);
            border-left: 3px solid #0ea5e9;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
        }
        .voice-note-message .voice-note-player {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .voice-note-message .play-btn {
            background: linear-gradient(135deg, #0ea5e9, #38bdf8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .voice-note-message .play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
        }
        .voice-note-message .waveform {
            flex: 1;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .voice-call-notification {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .incoming-call-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
            border-radius: 20px;
            padding: 30px;
            z-index: 2000;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            text-align: center;
            display: none;
        }
        .incoming-call-modal.show {
            display: block;
            animation: callPulse 0.5s ease;
        }
        @keyframes callPulse {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        /* Real-time Notification Styles */
        #realtimeNotifications {
            pointer-events: none;
        }
        
        #realtimeNotifications .realtime-notification {
            pointer-events: auto;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        @keyframes notificationSlideIn {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes notificationSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }
        
        /* Incoming Call Backdrop */
        #incomingCallBackdrop {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        /* Real-time indicator dot */
        .realtime-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 6px;
            animation: realtimePulse 1.5s infinite;
        }
        
        @keyframes realtimePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* Video Chat Styles */
        .video-chat-container {
            display: none;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        .video-chat-container.active {
            display: block;
        }
        
        /* Participants List Panel Styles */
        .participants-list-panel {
            background: rgba(0, 0, 0, 0.85);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .participants-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .participants-header h6 {
            margin: 0;
            color: #fff;
            font-size: 1rem;
        }
        .participants-body {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .participant-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        .participant-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        .participant-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #fff;
            font-size: 0.85rem;
        }
        .participant-details {
            display: flex;
            flex-direction: column;
        }
        .participant-name {
            font-weight: 500;
            color: #fff;
            font-size: 0.9rem;
        }
        .participant-role {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }
        .participant-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
        }
        .participant-status.muted {
            color: #ef4444;
        }
        .participant-status.unmuted {
            color: #10b981;
        }
        .participant-controls {
            display: flex;
            gap: 5px;
        }
        .participant-controls .btn {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        /* Voice Participants List */
        .voice-participants-list {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        /* Recipient Type Badge Styles */
        .recipient-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }
        .recipient-badge.teachers {
            background: linear-gradient(135deg, #0ea5e9, #38bdf8);
            color: #fff;
        }
        .recipient-badge.parents {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: #fff;
        }
        .recipient-badge.students {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
        }
        .recipient-badge.hod {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: #000;
            font-weight: 600;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .video-participant {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }
        .video-participant video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        .video-participant .participant-name {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #fff;
        }
        .video-participant.local-video {
            border: 2px solid var(--accent-primary);
        }
        .video-participant .muted-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.8);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #fff;
            display: none;
        }
        .video-participant .muted-indicator.show {
            display: block;
        }
        .video-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .video-controls .btn {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .video-controls .btn:hover {
            transform: scale(1.1);
        }
        .video-controls .btn-end-call {
            background: linear-gradient(135deg, #ef4444, #f87171);
            border: none;
            color: #fff;
        }
        .video-controls .btn-mute {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            border: none;
            color: #1a1a2e;
        }
        .video-controls .btn-mute.muted {
            background: linear-gradient(135deg, #6b7280, #9ca3af);
        }
        .video-controls .btn-video {
            background: linear-gradient(135deg, #0ea5e9, #38bdf8);
            border: none;
            color: #fff;
        }
        .video-controls .btn-video.off {
            background: linear-gradient(135deg, #6b7280, #9ca3af);
        }
        .video-call-status {
            text-align: center;
            margin-bottom: 10px;
            color: #fff;
        }
        .video-call-status .call-timer {
            font-size: 1.2rem;
            font-weight: 600;
            color: #10b981;
        }
        
        .editable { cursor: pointer; }
        .editable:hover { background: rgba(233, 69, 96, 0.15); }
        .payslip-preview { background: white; color: black; padding: 20px; border-radius: 14px; }
        .hr-chart { height: 300px; }
        .leave-calendar { height: 400px; }
        .applicant-stage { cursor: pointer; }
        .cert-expiry { color: #fbbf24; }
        .cert-expired { color: #f87171; }
        .lesson-plan { 
            background: rgba(255, 255, 255, 0.08); 
            padding: 18px; 
            border-radius: 14px; 
            margin: 12px 0; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .lesson-plan:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(233, 69, 96, 0.3);
        }
        
        /* Enhanced Action Buttons Styling */
        .btn-sm { font-size: 0.875rem; transition: all 0.3s ease; }
        .btn-sm:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .btn-sm i { margin-right: 0; }
        
        /* Virtual Forms Section Styles */
        .virtual-forms-section { background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 15px; margin-top: 20px; }
        .form-card { background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid rgba(102, 126, 234, 0.8); transition: all 0.3s; }
        .form-card:hover { background: rgba(255, 255, 255, 0.15); transform: translateX(5px); }
        .form-preview-btn { margin: 5px; }
        .uploaded-files-list { max-height: 500px; overflow-y: auto; }
        .file-item { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .file-item:hover { background: rgba(255, 255, 255, 0.2); }
        
        /* Online Applications Tab - Quick Responsive Styles */
        #online-applications {
            transition: opacity 0.2s ease-in-out;
        }
        
        #online-applications .virtual-forms-section {
            animation: fadeInFast 0.3s ease-out;
        }
        
        @keyframes fadeInFast {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #online-applications .form-card {
            transition: all 0.2s ease-out;
        }
        
        #online-applications .btn {
            transition: all 0.15s ease-out;
        }
        
        #online-applications .btn:active {
            transform: scale(0.95);
        }
        
        /* Admission Tabs Quick Response */
        #admissionTabs .nav-link {
            transition: all 0.2s ease-out;
        }
        
        #admissionTabs .nav-link:active {
            outline: none;
            pointer-events: auto;
        }
        
        /* Enhanced scroll tabs - mouse-friendly */
        .nav-tabs,
        .nav-pills {
            scroll-behavior: smooth;
        }
        
        .nav-tabs .nav-link:active,
        .nav-pills .nav-link:active {
            outline: none;
            pointer-events: auto;
        }
        
        /* Theme Generator Styles */
        .theme-option {
            cursor: pointer;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .theme-option:hover {
            transform: scale(1.05);
        }
        .theme-preview {
            width: 120px;
            height: 80px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }
        .theme-option.active .theme-preview {
            border-color: #fff;
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.4);
        }
        .theme-option.active .theme-check {
            display: block !important;
            color: #fff;
            font-size: 2rem;
            animation: checkPop 0.3s ease;
        }
        .theme-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        @keyframes checkPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* User Management Styles */
        #user-management .card-metric {
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #user-management .card-metric:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        #usersTableBody tr {
            transition: all 0.2s ease;
        }
        #usersTableBody tr:hover {
            background: rgba(233, 69, 96, 0.15) !important;
        }
        #usersTableBody code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        #user-management .input-group-text {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
        }
        
        /* Inline Editable Cells */
        .editable-cell {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
        }
        .editable-cell:hover {
            background: rgba(233, 69, 96, 0.2);
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.3);
        }
        .editable-cell i {
            transition: opacity 0.2s ease;
        }
        .editable-cell:hover i {
            opacity: 1 !important;
        }
        
        /* Save Changes Button Pulse Animation */
        @keyframes pulseBtn {
            0% { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(16, 185, 129, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        }
        .pulse-animation {
            animation: pulseBtn 1.5s infinite;
        }
        #saveAllChangesBtn {
            transition: all 0.3s ease;
        }
        #saveAllChangesBtn:hover {
            transform: translateY(-3px) scale(1.02);
        }
        
        /* User Table Pagination Styles */
        #usersPagination .page-link {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        #usersPagination .page-link:hover {
            background: rgba(233, 69, 96, 0.3);
            border-color: rgba(233, 69, 96, 0.5);
            color: #fff;
        }
        #usersPagination .page-item.active .page-link {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: var(--accent-primary);
            color: #fff;
        }
        #usersPagination .page-item.disabled .page-link {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.3);
        }
        
        /* Sortable Table Headers */
        #usersTable thead th {
            user-select: none;
            transition: background 0.2s ease;
        }
        #usersTable thead th:hover {
            background: rgba(233, 69, 96, 0.2);
        }
        #usersTable thead th i {
            color: var(--accent-secondary);
        }
        
        #settingsTabs .nav-link {
            border-radius: 8px 8px 0 0;
        }
        #settingsTabs .nav-link.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)) !important;
        }
        .modal-content code {
            background: rgba(255, 255, 255, 0.15);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 1.1rem;
            display: inline-block;
            margin-top: 4px;
        }
        
        /* Enhanced Teachers Module Styles */
        #teachers .nav-tabs {
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
        }
        #teachers .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 0 5px;
            transition: all 0.3s;
        }
        #teachers .nav-tabs .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        #teachers .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
            color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        #teachers .tab-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }
        
        /* Enhanced Wellness Section Styles */
        #employee-wellness .card-metric {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(168, 85, 247, 0.3));
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: all 0.3s;
        }
        #employee-wellness .card-metric:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }
        #employee-wellness .card-metric i {
            color: rgba(255, 255, 255, 0.9);
        }
        #wellness-activities, #wellness-tips, #wellness-tracking, #wellness-support {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 12px;
            min-height: 300px;
        }
        .wellness-activity-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid rgba(99, 102, 241, 0.8);
            transition: all 0.3s;
        }
        .wellness-activity-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }
        
        /* ============================================
           ENHANCED RESPONSIVE DESIGN
           Mobile & Desktop UI Optimization
           ============================================ */
        
        /* Mobile Navigation Bar (Bottom) */
        .mobile-nav-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--sidebar-bg);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--sidebar-border);
            padding: 8px 0;
            z-index: 1100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .mobile-nav-bar .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
        }
        
        .mobile-nav-bar .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px 5px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s;
            border-radius: 10px;
            max-width: 80px;
        }
        
        .mobile-nav-bar .nav-item:hover,
        .mobile-nav-bar .nav-item.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .mobile-nav-bar .nav-item i {
            display: block;
            font-size: 1.3rem;
            margin-bottom: 2px;
        }
        
        .mobile-nav-bar .nav-item span {
            display: block;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        /* Mobile Header */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--sidebar-bg);
            backdrop-filter: blur(20px);
            padding: 12px 15px;
            z-index: 1050;
            border-bottom: 1px solid var(--sidebar-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .mobile-header .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mobile-header .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mobile-header .logo img {
            width: 35px;
            height: 35px;
            border-radius: 8px;
        }
        
        .mobile-header .logo h6 {
            margin: 0;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .mobile-header .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .mobile-header .header-actions button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .mobile-header .header-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Desktop Enhancements */
        .desktop-only {
            display: block;
        }
        
        .mobile-only {
            display: none;
        }
        
        /* Tablet & Desktop (992px and up) */
        @media (min-width: 992px) {
            .content {
                padding: 50px;
            }
            
            .card-metric {
                padding: 25px !important;
            }
            
            .table {
                font-size: 1rem;
            }
            
            /* Enhanced spacing for larger screens */
            .row {
                margin-bottom: 30px;
            }
            
            /* Better grid layouts for desktop */
            .col-md-3 {
                padding: 10px;
            }
            
            .col-md-6 {
                padding: 10px;
            }
        }
        
        /* Large Desktop (1200px and up) */
        @media (min-width: 1200px) {
            .sidebar {
                width: 280px;
            }
            
            .content {
                margin-left: 280px;
                padding: 60px;
            }
            
            .card-metric {
                padding: 30px !important;
            }
            
            /* Multi-column layouts for large screens */
            .dashboard-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
            }
        }
        
        /* Tablet (768px - 991px) */
        @media (min-width: 768px) and (max-width: 991px) {
            .sidebar {
                width: 80px;
            }
            
            .sidebar .nav-text {
                display: none;
            }
            
            .content {
                margin-left: 80px;
                padding: 30px 20px;
            }
            
            .btn-toggle-sidebar {
                left: 90px;
            }
            
            .card-metric {
                padding: 20px !important;
            }
            
            /* Adjust grid for tablets */
            .col-md-3 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }
        
        /* Mobile (up to 767px) */
        @media (max-width: 767px) {
            /* Hide desktop sidebar */
            .sidebar {
                display: none;
            }
            
            /* Show mobile navigation */
            .mobile-nav-bar {
                display: block;
            }
            
            .mobile-header {
                display: block;
            }
            
            .mobile-only {
                display: block;
            }
            
            .desktop-only {
                display: none;
            }
            
            /* Adjust content for mobile */
            .content {
                margin-left: 0;
                margin-top: 65px;
                margin-bottom: 70px;
                padding: 15px;
            }
            
            /* Hide desktop toggle button */
            .btn-toggle-sidebar {
                display: none;
            }
            
            /* Mobile-optimized cards */
            .card-metric {
                padding: 15px !important;
                margin-bottom: 15px;
            }
            
            .card-metric h5 {
                font-size: 0.85rem;
            }
            
            .card-metric h3 {
                font-size: 1.5rem;
            }
            
            /* Full-width elements on mobile */
            .col-md-3,
            .col-md-4,
            .col-md-6,
            .col-md-8 {
                flex: 0 0 100%;
                max-width: 100%;
                padding: 5px;
            }
            
            /* Mobile-friendly tables */
            .table {
                font-size: 0.85rem;
            }
            
            .table th,
            .table td {
                padding: 8px 5px;
            }
            
            /* Mobile buttons */
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .btn-sm {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            /* Stack form elements */
            .row.mb-3 {
                flex-direction: column;
            }
            
            /* Mobile tabs */
            .nav-tabs .nav-link {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            /* Mobile modals */
            .modal-dialog {
                margin: 10px;
            }
            
            /* Notification positioning */
            #notificationBell {
                display: none; /* Hide in favor of mobile header */
            }
            
            #onlineStatus {
                top: 75px;
                right: 15px;
            }
            
            /* Login page mobile optimization */
            .login-card {
                padding: 1.5rem;
                margin: 15px;
            }
            
            .login-card .logo-image {
                width: 150px;
            }
            
            /* Employee wellness mobile */
            #employee-wellness .row {
                flex-direction: column;
            }
            
            #employee-wellness .card-metric {
                margin-bottom: 15px;
            }
            
            /* Teachers section mobile */
            #teachers .nav-tabs {
                flex-wrap: wrap;
            }
            
            #teachers .nav-tabs .nav-link {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            #teachers .tab-content {
                padding: 15px;
            }
            
            /* PWA Install Prompt Mobile */
            #installPrompt {
                bottom: 80px; /* Above mobile nav */
                left: 10px;
                right: 10px;
                transform: none;
                max-width: none;
                font-size: 0.9rem;
            }
            
            #installPrompt .btn-install,
            #installPrompt .btn-dismiss {
                padding: 6px 15px;
                font-size: 0.85rem;
            }
            
            /* ============================================
               MOBILE-SPECIFIC SIZE REDUCTIONS
               ============================================ */
            
            /* Dashboard: Reduce blocks by 3pt and graph by 1pt */
            #dashboard .card-metric {
                font-size: calc(1rem - 3pt);
            }
            
            #dashboard .card-metric h5 {
                font-size: calc(0.85rem - 3pt);
            }
            
            #dashboard .card-metric h3 {
                font-size: calc(1.5rem - 3pt);
            }
            
            #dashboardChart {
                height: calc(300px - 1pt) !important;
            }
            
            /* Admission: Reduce tabs by 3pt */
            #admission .nav-tabs .nav-link {
                font-size: calc(0.85rem - 3pt) !important;
                padding: calc(8px - 1pt) calc(12px - 1pt) !important;
            }
            
            /* Student Information System: Reduce buttons and inputs by 3pt */
            #students .btn {
                font-size: calc(0.9rem - 3pt) !important;
                padding: calc(10px - 1pt) calc(15px - 1pt) !important;
            }
            
            #students .input-group input,
            #students .input-group button {
                font-size: calc(0.9rem - 3pt) !important;
            }
            
            /* Attendance Management: Reduce form controls and buttons by 3pt */
            #attendance .form-control,
            #attendance .btn {
                font-size: calc(0.9rem - 3pt) !important;
                padding: calc(10px - 1pt) calc(12px - 1pt) !important;
            }
            
            /* Finance Management: Reduce blocks by 3pt */
            #fees .card-metric {
                font-size: calc(1rem - 3pt) !important;
            }
            
            #fees .card-metric h5 {
                font-size: calc(0.85rem - 3pt) !important;
            }
            
            #fees .card-metric h3 {
                font-size: calc(1.5rem - 3pt) !important;
            }
            
            /* Finance Management: Reduce Status, Receipt, and Action columns by 3pt */
            #fees table th:nth-child(5),
            #fees table td:nth-child(5),
            #fees table th:nth-child(6),
            #fees table td:nth-child(6),
            #fees table th:nth-child(7),
            #fees table td:nth-child(7) {
                font-size: calc(0.85rem - 3pt) !important;
                padding: calc(8px - 1pt) calc(5px - 1pt) !important;
            }
            
            #fees table td:nth-child(5) .badge {
                font-size: calc(0.75rem - 3pt) !important;
                padding: calc(4px - 1pt) calc(8px - 1pt) !important;
            }
            
            #fees table td:nth-child(6) .btn,
            #fees table td:nth-child(7) .btn {
                font-size: calc(0.75rem - 3pt) !important;
                padding: calc(4px - 1pt) calc(8px - 1pt) !important;
            }
            
            /* HR Management: Reduce tabs by 3pt */
            #hr .nav-tabs .nav-link {
                font-size: calc(0.8rem - 3pt) !important;
                padding: calc(8px - 1pt) calc(10px - 1pt) !important;
            }
            
            /* Events Management: Reduce blocks by 3pt */
            #eventsManagement .card-metric {
                font-size: calc(1rem - 3pt) !important;
            }
            
            #eventsManagement .card-metric h5 {
                font-size: calc(0.85rem - 3pt) !important;
            }
            
            #eventsManagement .card-metric h3 {
                font-size: calc(1.5rem - 3pt) !important;
            }
            
            /* System and Settings Management: Reduce blocks by 3pt */
            #systemManagement .card-metric {
                font-size: calc(1rem - 3pt) !important;
            }
            
            #systemManagement .card-metric h5 {
                font-size: calc(0.85rem - 3pt) !important;
            }
            
            #systemManagement .card-metric h3 {
                font-size: calc(1.5rem - 3pt) !important;
            }
            
            /* Settings: Reduce elements by 3pt */
            #settings h5 {
                font-size: calc(1.1rem - 3pt) !important;
            }
            
            #settings .form-control,
            #settings .btn {
                font-size: calc(0.9rem - 3pt) !important;
                padding: calc(10px - 1pt) calc(12px - 1pt) !important;
            }
        }
        
        /* Small Mobile (up to 576px) */
        @media (max-width: 576px) {
            .mobile-header .logo h6 {
                font-size: 0.9rem;
            }
            
            .mobile-nav-bar .nav-item span {
                font-size: 0.65rem;
            }
            
            .content {
                padding: 10px;
            }
            
            .card-metric {
                padding: 12px !important;
            }
            
            .card-metric h5 {
                font-size: 0.75rem;
            }
            
            .card-metric h3 {
                font-size: 1.2rem;
            }
            
            /* Compact tables for small screens */
            .table {
                font-size: 0.75rem;
            }
            
            .table th,
            .table td {
                padding: 6px 3px;
            }
            
            /* Hide less important table columns on small screens */
            .table .mobile-hide {
                display: none;
            }
        }
        
        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .btn {
                min-height: 44px;
                padding: 12px 20px;
            }
            
            .nav-link {
                min-height: 44px;
            }
            
            .mobile-nav-bar .nav-item {
                min-height: 60px;
            }
            
            /* Remove hover effects on touch devices */
            .card-metric:hover {
                transform: none;
            }
            
            .sidebar .nav-link:hover {
                transform: none;
            }
        }
        
        /* Landscape phone orientation */
        @media (max-width: 767px) and (orientation: landscape) {
            .mobile-header {
                padding: 8px 15px;
            }
            
            .mobile-nav-bar {
                padding: 4px 0;
            }
            
            .mobile-nav-bar .nav-item i {
                font-size: 1.1rem;
            }
            
            .mobile-nav-bar .nav-item span {
                font-size: 0.6rem;
            }
            
            .content {
                margin-top: 55px;
                margin-bottom: 55px;
            }
        }
        
        /* ============================================
           COMMHUB PRO MOBILE RESPONSIVE STYLES
           Enhanced for mobile devices
           ============================================ */
        
        /* Mobile optimizations for CommHub Pro (up to 767px) */
        @media (max-width: 767px) {
            /* Stack layout vertically on mobile */
            #commhub-container {
                flex-direction: column !important;
                height: auto !important;
                max-height: none !important;
            }
            
            /* Sidebar becomes top bar on mobile */
            #commhub-sidebar {
                width: 100% !important;
                border-right: none !important;
                border-bottom: 1px solid #333;
                max-height: 200px;
            }
            
            /* Adjust sidebar padding for mobile */
            #commhub-sidebar > div:first-child {
                padding: 15px !important;
                font-size: 18px !important;
            }
            
            /* Room input section */
            #commhub-sidebar > div:nth-child(2) {
                padding: 10px !important;
            }
            
            #commhubRoomInput {
                padding: 10px !important;
                font-size: 14px !important;
            }
            
            #commhubJoinBtn {
                padding: 10px !important;
                font-size: 14px !important;
            }
            
            /* Participants list - compact on mobile */
            #commhubParticipants {
                max-height: 100px;
                overflow-y: auto;
            }
            
            #commhubParticipants > div {
                padding: 8px !important;
                font-size: 12px !important;
            }
            
            /* Video grid - full width on mobile */
            #commhub-container > div:nth-child(2) {
                flex: 1 !important;
                min-height: 300px !important;
            }
            
            #commhubVideoGrid {
                grid-template-columns: 1fr !important;
                padding: 10px !important;
                gap: 8px !important;
            }
            
            /* Video containers - optimized for mobile */
            .commhub-video-container {
                min-height: 200px !important;
            }
            
            /* Control buttons - larger touch targets */
            #commhubControls {
                height: 70px !important;
                gap: 8px !important;
                flex-wrap: wrap;
                padding: 8px !important;
            }
            
            .commhub-ctrl-btn {
                width: 50px !important;
                height: 50px !important;
                font-size: 20px !important;
            }
            
            /* Chat panel - bottom drawer on mobile */
            #commhub-container > div:nth-child(3) {
                width: 100% !important;
                border-left: none !important;
                border-top: 1px solid #333;
                max-height: 250px;
            }
            
            #commhubChatMessages {
                max-height: 150px !important;
                padding: 10px !important;
            }
            
            #commhubChatMessages > div {
                font-size: 12px !important;
                padding: 6px 10px !important;
            }
            
            #commhubChatInput {
                padding: 8px !important;
                font-size: 13px !important;
            }
            
            /* Server status indicator */
            #commhub-sidebar > div:last-child {
                padding: 8px !important;
            }
            
            #commhub-sidebar > div:last-child small {
                font-size: 11px !important;
            }
        }
        
        /* Tablet optimizations for CommHub Pro (768px - 991px) */
        @media (min-width: 768px) and (max-width: 991px) {
            #commhub-container {
                height: 70vh !important;
            }
            
            #commhub-sidebar {
                width: 220px !important;
            }
            
            #commhub-container > div:nth-child(3) {
                width: 250px !important;
            }
            
            #commhubVideoGrid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)) !important;
            }
        }
        
        /* Small mobile devices (up to 576px) */
        @media (max-width: 576px) {
            #commhub-sidebar {
                max-height: 180px;
            }
            
            #commhub-sidebar > div:first-child {
                font-size: 16px !important;
                padding: 12px !important;
            }
            
            .commhub-video-container {
                min-height: 180px !important;
            }
            
            .commhub-ctrl-btn {
                width: 45px !important;
                height: 45px !important;
                font-size: 18px !important;
            }
            
            #commhubChatMessages {
                max-height: 120px !important;
            }
        }
        
        /* Landscape mode optimizations for CommHub Pro */
        @media (max-width: 767px) and (orientation: landscape) {
            #commhub-container {
                flex-direction: row !important;
            }
            
            #commhub-sidebar {
                width: 200px !important;
                max-height: none !important;
                border-right: 1px solid #333;
                border-bottom: none;
            }
            
            #commhub-container > div:nth-child(3) {
                width: 200px !important;
                border-left: 1px solid #333;
                border-top: none;
                max-height: none;
            }
            
            #commhubVideoGrid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* PWA Install Prompt Styles */
        #installPrompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            display: none;
            max-width: 90%;
            backdrop-filter: blur(10px);
            animation: slideUp 0.5s ease;
        }
        
        #installPrompt.show {
            display: block;
        }
        
        @keyframes slideUp {
            from {
                bottom: -100px;
                opacity: 0;
            }
            to {
                bottom: 20px;
                opacity: 1;
            }
        }
        
        #installPrompt .btn-install {
            background: white;
            color: #667eea;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s;
        }
        
        #installPrompt .btn-install:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }
        
        #installPrompt .btn-dismiss {
            background: transparent;
            color: white;
            border: 1px solid white;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s;
        }
        
        #installPrompt .btn-dismiss:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* ============================================
           ENHANCED STUDENT PORTAL STYLES
           Modern, Clear, and Mobile-Friendly UI
           ============================================ */
        
        /* Student Portal Sections - Enhanced Layout */
        
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Enhanced Student Portal Headers */
        
        
        
        
        /* Enhanced Alert Boxes */
        
        
        
        
        /* Enhanced Metric Cards for Student Portal */
        
        
        
        
        
        
        
        
        /* Enhanced Tables for Student Portal */
        
        
        
        
        
        
        
        
        
        
        
        
        /* Enhanced Form Controls in Student Portal */
        
        
        
        
        
        
        
        
        /* Enhanced Buttons in Student Portal */
        
        
        
        
        
        
        
        
        /* Enhanced Upload Work Section */
        
        
        
        
        
        
        
        
        /* Mobile Responsiveness for Student Portal */
        @media (max-width: 767px) {
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        }
        
        /* ============================================
           MATH GAME ENHANCED STYLES
           ============================================ */
        
        #mathGame {
            animation: fadeInUp 0.5s ease;
        }
        
        #mathGame .card-metric {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        #mathGame .card-metric:hover {
            transform: translateY(-8px) scale(1.02);
        }
        
        #mathQuestion {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.1), rgba(255, 107, 107, 0.1));
            padding: 30px;
            border-radius: 20px;
            border: 2px solid rgba(233, 69, 96, 0.3);
            animation: questionPulse 2s ease-in-out infinite;
        }
        
        @keyframes questionPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(233, 69, 96, 0.2); }
            50% { box-shadow: 0 0 40px rgba(233, 69, 96, 0.4); }
        }
        
        #mathGameScore, #mathGameHighScore {
            font-size: 3rem !important;
            font-weight: 800;
        }
        
        #mathStreak {
            color: #fbbf24;
        }
        
        #mathTimer {
            font-family: 'Courier New', monospace;
            font-weight: 700;
        }
        
        /* HRM Staff Username Column Enhancement */
        #hr-staff .table {
            font-size: 0.9rem;
        }
        
        #hr-staff .table th,
        #hr-staff .table td {
            white-space: nowrap;
        }
        
        #hr-staff .username-cell {
            font-family: monospace;
            color: #4CAF50;
            font-weight: 600;
        }
        
        

        /* ============================================
        
        /* Portal Background with Animated Gradient */
        
        
        
        
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.1); }
        }
        
        
        
        /* Portal Header */
        
        
            0% { filter: drop-shadow(0 0 5px rgba(233, 69, 96, 0.3)); }
            100% { filter: drop-shadow(0 0 20px rgba(233, 69, 96, 0.6)); }
        }
        
        /* Enhanced Glassmorphism Cards */
        
        
        
        
        
        
        
        
        /* Portal Metric Cards */
        
        
        
        
        
        
        
        
        /* Portal Tabs */
        
        
        
        
        
        
        
        
        /* Enhanced Tool Cards */
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        /* Theme Selector */
        
        
        
        
        
        
        
        
        
        
        
        
        /* Color Filter Sliders */
        
        
        
        
        
        
        
        
        
        
        /* Storage Facility Section */
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        /* Enhanced Tables */
        
        
        
        
        
        
        
        
        /* Enhanced Buttons */
        
        
        
        
        
        
        
        
        /* Progress Bar */
        
        
        
        
        /* Alerts */
        
        
        
        
        
        
        
        
        /* Badges */
        
        
        @media (max-width: 991px) {
            
            
            
            
            
            
            
        }
        
        @media (max-width: 576px) {
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        }
        
        /* Floating Particles Animation */
        
        
        
        
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <img src="https://img1.wsimg.com/isteam/ip/33f55342-69d0-4c3b-9478-c9e1f81bbc39/blob.png" alt="Bophelong Community Independent School Logo" style="width: 200px; height: auto; margin-bottom: 1rem;">
                <h3 class="login-title">BIS(Mamelodi) - Bophelong Independent School</h3>
                <p class="text-muted">Advanced School Management System</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
            </form>
            <div class="alert alert-info mt-3" style="font-size: 0.85rem; padding: 10px;">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Cross-Device Login:</strong> Users created by admin can login from any device with internet access. Changes sync automatically.
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Mobile Header -->
        <div class="mobile-header mobile-only">
            <div class="header-content">
                <div class="logo">
                    <img src="https://img1.wsimg.com/isteam/ip/33f55342-69d0-4c3b-9478-c9e1f81bbc39/blob.png" alt="BIS Logo">
                    <h6>BIS Management</h6>
                </div>
                <div class="header-actions">
                    <button onclick="document.getElementById('notificationsModal').click()" title="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="mobileNotificationBadge" style="display:none;font-size:0.6rem;">0</span>
                    </button>
                    <button onclick="showSection('settings')" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Online/Offline Status Indicator -->
        <div id="onlineStatus" style="position: fixed; top: 20px; right: 80px; z-index: 1100;">
            <span id="statusIndicator" class="badge bg-success shadow">
                <i class="fas fa-wifi me-1"></i>Online
            </span>
            <span id="syncStatusIndicator" class="badge bg-secondary shadow ms-2" style="font-size:0.75rem; padding: 6px 10px; border-radius: 8px; display: none;">
                <i class="fas fa-sync-alt fa-spin me-1"></i><span id="syncStatusText">Syncing...</span>
            </span>
            <button id="updateAppBtn" class="btn btn-info shadow ms-2" onclick="updateApplicationData()" onkeypress="if(event.key==='Enter')updateApplicationData()" tabindex="0" title=" Instantly sync all data across all devices in real-time" aria-label="Update application data across all devices" style="font-weight: 600; padding: 8px 16px; border-radius: 10px; transition: all 0.3s ease;">
                <i class="fas fa-sync-alt me-1"></i><span class="d-none d-md-inline">Real-time </span>Update
            </button>
        </div>
        <!-- Notification Bell (Desktop) -->
        <div id="notificationBell" class="desktop-only">
            <button class="btn btn-warning rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>
        <button class="btn btn-sm btn-light btn-toggle-sidebar desktop-only" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="sidebar">
            <div class="mb-4 text-center">
                <img src="https://img1.wsimg.com/isteam/ip/33f55342-69d0-4c3b-9478-c9e1f81bbc39/blob.png" alt="Bophelong Community Independent School Logo" class="logo-image">
                <h4 class="mb-0"><span class="nav-text">BIS(Mamelodi)</span></h4>
            </div>
            <ul class="nav flex-column">
                <li class="admin-only non-student"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
                <li class="hod-only non-student"><a href="#hodDashboard" class="nav-link active" onclick="showSection('hodDashboard')"><i class="fas fa-chart-line me-2"></i><span class="nav-text">HOD Dashboard</span></a></li>
                <li class="hod-only non-student"><a href="#teacherMonitoring" class="nav-link" onclick="showSection('teacherMonitoring')"><i class="fas fa-user-check me-2"></i><span class="nav-text">Teacher Monitoring</span></a></li>
                <li class="hod-only non-student"><a href="#teacherPortalView" class="nav-link" onclick="showSection('teacherPortalView')"><i class="fas fa-eye me-2"></i><span class="nav-text">Teacher Portal View</span></a></li>
                <li class="hod-only non-student"><a href="#departmentReports" class="nav-link" onclick="showSection('departmentReports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Department Reports</span></a></li>
                <li class="admin-only non-student"><a href="#admission" class="nav-link" onclick="showSection('admission')"><i class="fas fa-user-plus me-2"></i><span class="nav-text">Admission</span></a></li>

                <li class="non-student non-parent"><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
                <li class="admin-only non-student"><a href="#fees" class="nav-link" onclick="showSection('fees')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">Finance Management</span></a></li>
                <li class="teacher-only non-student"><a href="#timetable" class="nav-link" onclick="showSection('timetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Timetable</span></a></li>
                <li class="teacher-only non-student"><a href="#teachers" class="nav-link" onclick="showSection('teachers')"><i class="fas fa-chalkboard-teacher me-2"></i><span class="nav-text">Advanced Teachers</span></a></li>
                <li class="teacher-only non-student"><a href="#exams" class="nav-link" onclick="showSection('exams')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Assessment</span></a></li>
                <li class="admin-only non-student"><a href="#hr" class="nav-link" onclick="showSection('hr')"><i class="fas fa-user-tie me-2"></i><span class="nav-text">HR Management</span></a></li>

                <li class="admin-only non-student"><a href="#eventsManagement" class="nav-link" onclick="showSection('eventsManagement')"><i class="fas fa-calendar-check me-2"></i><span class="nav-text">Events Management</span></a></li>
                <li class="admin-only non-student"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Reports</span></a></li>
                <li class="admin-only non-student"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="student-only"><a href="#studentTimetable" class="nav-link" onclick="showSection('studentTimetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Time Table</span></a></li>
                <li class="student-only"><a href="#studentExamination" class="nav-link" onclick="showSection('studentExamination')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Assessment</span></a></li>
                <li class="student-only"><a href="#studentInbox" class="nav-link" onclick="showSection('studentInbox')"><i class="fas fa-inbox me-2"></i><span class="nav-text">Inbox</span></a></li>
                <li class="student-only"><a href="#studentUploadWork" class="nav-link" onclick="showSection('studentUploadWork')"><i class="fas fa-upload me-2"></i><span class="nav-text">Upload Work</span></a></li>
                <li class="student-only"><a href="#mathGame" class="nav-link" onclick="showSection('mathGame')"><i class="fas fa-calculator me-2"></i><span class="nav-text">Math Game</span></a></li>
                <li class="student-only"><a href="#aiResearch" class="nav-link" onclick="showSection('aiResearch')"><i class="fas fa-robot me-2"></i><span class="nav-text">AI Research</span></a></li>

                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
        <div class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section">
                <h2>School Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Students</h5><h3 id="totalStudents">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's Attendance</h5><h3 id="todayAttendance">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Fees</h5><h3 id="pendingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Upcoming Exams</h5><h3 id="upcomingExams">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaffDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeavesDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositionsDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Performance</h5><h3 id="avgPerformanceDash">0%</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4"></canvas>
            </section>
            
            <!-- HOD Dashboard -->
            <section id="hodDashboard" class="section d-none hod-only">
                <h2><i class="fas fa-user-shield me-2"></i>Head of Department Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-chalkboard-teacher me-2"></i>Teachers</h5>
                            <h3 id="hodTotalTeachers">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-check-circle me-2"></i>Active Today</h5>
                            <h3 id="hodActiveTeachers">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-file-alt me-2"></i>Lesson Plans</h5>
                            <h3 id="hodTotalLessonPlans">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-percentage me-2"></i>Avg Performance</h5>
                            <h3 id="hodAvgPerformance">0%</h3>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-chart-bar me-2"></i>Teacher Performance Overview</h5>
                            <canvas id="hodPerformanceChart" style="height:300px;"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-clock me-2"></i>Attendance Trends</h5>
                            <canvas id="hodAttendanceChart" style="height:300px;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-bell me-2"></i>Recent Activities</h5>
                            <div id="hodRecentActivities" style="max-height:300px;overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Teacher Monitoring -->
            <section id="teacherMonitoring" class="section d-none hod-only">
                <h2><i class="fas fa-user-check me-2"></i>Teacher Monitoring</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="monitorTeacherFilter" class="form-control" onchange="loadTeacherMonitoring()">
                            <option value="">All Teachers</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="date" id="monitorDateFilter" class="form-control" onchange="loadTeacherMonitoring()">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="generateTeacherReport()">
                            <i class="fas fa-file-pdf me-2"></i>Generate Report
                        </button>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                            <h5>Lesson Plans Submitted</h5>
                            <h3 id="monitorLessonPlansCount">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <i class="fas fa-graduation-cap fa-2x mb-2"></i>
                            <h5>Grades Entered</h5>
                            <h3 id="monitorGradesCount">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <i class="fas fa-user-clock fa-2x mb-2"></i>
                            <h5>Attendance Marked</h5>
                            <h3 id="monitorAttendanceCount">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <i class="fas fa-comments fa-2x mb-2"></i>
                            <h5>Communications</h5>
                            <h3 id="monitorCommCount">0</h3>
                        </div>
                    </div>
                </div>
                
                <div class="card card-metric p-3">
                    <h5><i class="fas fa-list me-2"></i>Teacher Activity Log</h5>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Teacher</th>
                                <th>Activity</th>
                                <th>Date & Time</th>
                                <th>Details</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="teacherActivityLog"></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Teacher Portal View (Read-Only) -->
            <section id="teacherPortalView" class="section d-none hod-only">
                <h2><i class="fas fa-eye me-2"></i>Teacher Portal View (Read-Only)</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This is a read-only view of the teacher portal. You can view all teacher activities but cannot make changes.
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>Select Teacher:</strong></label>
                        <select id="hodSelectTeacher" class="form-control" onchange="loadTeacherPortalView()">
                            <option value="">Select a teacher to view their portal</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>View Date Range:</strong></label>
                        <input type="date" id="hodViewDateRange" class="form-control" onchange="loadTeacherPortalView()">
                    </div>
                </div>
                
                <div id="teacherPortalContent" class="mt-4">
                    <p class="text-center text-muted">Select a teacher above to view their portal activities</p>
                </div>
                
                <ul class="nav nav-tabs mb-3" id="teacherPortalTabs" style="display:none;">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#hodLessonPlansView">Lesson Plans</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hodGradingView">Grading</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hodResourcesView">Resources</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hodStudentProgressView">Student Progress</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hodUploadedWorkView">Uploaded Work</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hodChatView">Chat History</a>
                    </li>
                </ul>
                
                <div class="tab-content" id="teacherPortalTabContent" style="display:none;">
                    <div class="tab-pane fade show active" id="hodLessonPlansView">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-clipboard-list me-2"></i>Lesson Plans</h5>
                            <div id="hodLessonPlansList"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="hodGradingView">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-graduation-cap me-2"></i>Grading Records</h5>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Subject</th>
                                        <th>Grade</th>
                                        <th>Date</th>
                                        <th>Comments</th>
                                    </tr>
                                </thead>
                                <tbody id="hodGradingTable"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="hodResourcesView">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-book me-2"></i>Resources Shared</h5>
                            <div id="hodResourcesList"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="hodStudentProgressView">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-chart-line me-2"></i>Student Progress Tracking</h5>
                            <div id="hodProgressDetails"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="hodUploadedWorkView">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-upload me-2"></i>Work Uploaded</h5>
                            <div id="hodUploadedWorkList"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="hodChatView">
                        <div class="card card-metric p-3">
                            <h5><i class="fas fa-comments me-2"></i>Chat History</h5>
                            <div id="hodChatHistory"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Department Reports -->
            <section id="departmentReports" class="section d-none hod-only">
                <h2><i class="fas fa-chart-bar me-2"></i>Department Reports</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="reportType" class="form-control">
                            <option value="performance">Teacher Performance</option>
                            <option value="attendance">Attendance Summary</option>
                            <option value="grading">Grading Analysis</option>
                            <option value="lessonPlans">Lesson Plan Completion</option>
                            <option value="comprehensive">Comprehensive Report</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="month" id="reportMonth" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="generateDepartmentReport()">
                            <i class="fas fa-file-pdf me-2"></i>Generate Report
                        </button>
                        <button class="btn btn-success ms-2" onclick="exportDepartmentData()">
                            <i class="fas fa-file-excel me-2"></i>Export Data
                        </button>
                    </div>
                </div>
                
                <div class="card card-metric p-3">
                    <h5><i class="fas fa-chart-pie me-2"></i>Department Performance Overview</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="departmentPerformanceChart" style="height:300px;"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="departmentActivityChart" style="height:300px;"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card card-metric p-3 mt-4">
                    <h5><i class="fas fa-table me-2"></i>Detailed Statistics</h5>
                    <div id="departmentStatsTable"></div>
                </div>
            </section>
            
            <!-- Admission Management -->
            <section id="admission" class="section d-none admin-only">
                <h2>Admission Management</h2>
                
                <!-- Tabs for Admission Management -->
                <ul class="nav nav-tabs mb-3" id="admissionTabs" role="tablist" aria-label="Admission Management Tabs">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="admissions-list-tab" data-bs-toggle="tab" href="#admissions-list" role="tab" aria-selected="true" aria-controls="admissions-list">Admissions List</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="online-applications-tab" data-bs-toggle="tab" href="#online-applications" role="tab" aria-selected="false" aria-controls="online-applications">Online Applications</a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Admissions List Tab -->
                    <div class="tab-pane fade show active" id="admissions-list" role="tabpanel" aria-labelledby="admissions-list-tab">
                        <button class="btn btn-primary mb-3" onclick="showAddAdmissionModal()">New Application</button>
                        <button class="btn btn-secondary mb-3" onclick="showBulkAdmissionModal()">Bulk Import (CSV/Excel/PDF/Word)</button>
                        <button class="btn btn-danger mb-3" onclick="resetAdmissions()">Reset Admission (Save to Vault)</button>
                        <div class="input-group mb-3 w-50">
                            <input type="text" class="form-control" placeholder="Search admissions..." id="admissionSearch">
                            <button class="btn btn-outline-secondary" onclick="searchAdmissions()">Search</button>
                        </div>
                <style>
                    #admission table.sasams-format {
                        width: 100%;
                        border-collapse: collapse;
                        font-family: Arial, sans-serif;
                        font-size: 12px;
                        background: rgba(255, 255, 255, 0.95);
                        color: #333;
                    }
                    #admission table.sasams-format th,
                    #admission table.sasams-format td {
                        border: 1px solid #ddd;
                        padding: 8px;
                        text-align: left;
                    }
                    #admission table.sasams-format th {
                        background-color: #f2f2f2;
                        font-weight: bold;
                        color: #333;
                    }
                    #admission table.sasams-format tr:nth-child(even) {
                        background-color: #f9f9f9;
                    }
                    #admission table.sasams-format caption {
                        font-weight: bold;
                        margin-bottom: 10px;
                        font-size: 14px;
                        color: #333;
                        background: rgba(255, 255, 255, 0.95);
                        padding: 10px;
                        border-radius: 5px;
                    }
                </style>
                <table class="sasams-format">
                    <caption id="sasamsCaption">SA-SAMS v25.3.0 - Learner and Parent Info (3.1.13) - <span id="admissionReportDate"></span></caption>
                    <thead>
                        <tr>
                            <th colspan="9">LEARNER DETAILS</th>
                            <th colspan="4">FATHER DETAILS</th>
                            <th colspan="4">MOTHER DETAILS</th>
                            <th rowspan="2">ACTIONS</th>
                        </tr>
                        <tr>
                            <th>Number</th>
                            <th>Surname</th>
                            <th>First Name</th>
                            <th>Gender</th>
                            <th>Grade</th>
                            <th>Class</th>
                            <th>Cell#</th>
                            <th>Email</th>
                            <th>Language</th>
                            <th>Name</th>
                            <th>Surname</th>
                            <th>Email</th>
                            <th>Cell#</th>
                            <th>Name</th>
                            <th>Surname</th>
                            <th>Email</th>
                            <th>Cell#</th>
                        </tr>
                    </thead>
                    <tbody id="admissionTable"></tbody>
                </table>
                    </div>
                    
                    <!-- Online Applications Tab -->
                    <div class="tab-pane fade" id="online-applications" role="tabpanel" aria-labelledby="online-applications-tab">
                        <div class="virtual-forms-section">
                            <h4><i class="fas fa-file-alt me-2"></i>Online Application Forms</h4>
                            <p class="text-muted">View, fill, print, and download school admission forms</p>
                            
                            <!-- Pre-defined Forms Section -->
                            <div class="card card-metric p-3 mb-4">
                                <h5><i class="fas fa-file-invoice me-2"></i>Pre-defined School Forms</h5>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-card">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6><i class="fas fa-file-alt me-2"></i>Application for Admission - Bophelong Community Independent School</h6>
                                                    <p class="mb-0 text-muted"><small>Complete admission application form with learner and parent information</small></p>
                                                </div>
                                                <div>
                                                    <button class="btn btn-sm btn-info form-preview-btn" onclick="viewAdmissionForm()">
                                                        <i class="fas fa-eye me-1"></i>View
                                                    </button>
                                                    <button class="btn btn-sm btn-primary form-preview-btn" onclick="fillAdmissionForm()">
                                                        <i class="fas fa-edit me-1"></i>Fill
                                                    </button>
                                                    <button class="btn btn-sm btn-success form-preview-btn" onclick="printAdmissionForm()">
                                                        <i class="fas fa-print me-1"></i>Print
                                                    </button>
                                                    <button class="btn btn-sm btn-secondary form-preview-btn" onclick="downloadAdmissionForm()">
                                                        <i class="fas fa-download me-1"></i>Download
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Submitted Applications List -->
                            <div class="card card-metric p-3">
                                <h5><i class="fas fa-folder-open me-2"></i>Submitted Online Applications</h5>
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    This section displays all online applications submitted through the admission form. 
                                    Applications are automatically tracked and stored for review.
                                </div>
                                <div class="mb-3">
                                    <button class="btn btn-success btn-sm" onclick="approveAllApplications()">
                                        <i class="fas fa-check-double me-1"></i>Approve All Pending
                                    </button>
                                    <button class="btn btn-secondary btn-sm ms-2" onclick="refreshApplicationsList()">
                                        <i class="fas fa-sync me-1"></i>Refresh
                                    </button>
                                </div>
                                <div class="uploaded-files-list" id="submittedApplicationsList" role="status" aria-live="polite">
                                    <p class="text-center text-muted">No online applications submitted yet. Applications submitted via the online form will appear here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Student Information System -->
            <!-- Media -->
            
            <!-- Incoming Call Modal -->
            <div id="incomingCallBackdrop" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9998; backdrop-filter:blur(5px); -webkit-backdrop-filter:blur(5px);"></div>
            <div id="incomingCallModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:9999;">
                <div style="background:linear-gradient(135deg, #1a1a2e, #16213e); border-radius:20px; padding:40px; text-align:center; max-width:400px; box-shadow:0 25px 80px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.1);">
                    <!-- Caller Photo -->
                    <div style="width:80px; height:80px; margin:0 auto 20px; background:linear-gradient(135deg, #10b981, #34d399); border-radius:50%; display:flex; align-items:center; justify-content:center; animation:pulse 2s infinite; overflow:hidden;">
                        <img id="incomingCallerPhoto" src="" alt="Caller" style="width:100%; height:100%; object-fit:cover; display:none;">
                        <i id="incomingCallerIcon" class="fas fa-video fa-2x" style="color:white;"></i>
                    </div>
                    <h3 style="color:white; margin-bottom:10px;">Incoming Group Call</h3>
                    <p id="incomingCallerName" style="color:rgba(255,255,255,0.7); font-size:1.2rem; margin-bottom:10px;">Unknown Caller</p>
                    <p id="incomingCallTitle" style="color:rgba(255,255,255,0.5); font-size:0.9rem; margin-bottom:30px;">Group Call</p>
                    <div style="display:flex; gap:15px; justify-content:center;">
                        <button onclick="acceptIncomingGroupCall()" style="background:linear-gradient(135deg, #10b981, #34d399); border:none; color:white; padding:15px 30px; border-radius:12px; cursor:pointer; font-weight:600; font-size:1rem; transition:all 0.3s;">
                            <i class="fas fa-phone me-2"></i>Accept
                        </button>
                        <button onclick="declineIncomingGroupCall()" style="background:linear-gradient(135deg, #ef4444, #f87171); border:none; color:white; padding:15px 30px; border-radius:12px; cursor:pointer; font-weight:600; font-size:1rem; transition:all 0.3s;">
                            <i class="fas fa-phone-slash me-2"></i>Decline
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Recording Indicator -->
            <div id="recordingIndicator" style="display:none; position:fixed; top:80px; right:20px; background:rgba(239,68,68,0.95); padding:10px 20px; border-radius:20px; box-shadow:0 4px 15px rgba(239,68,68,0.4); z-index:9998; animation:pulse 1.5s infinite;">
                <i class="fas fa-circle me-2" style="color:white; font-size:10px; animation:blink 1s infinite;"></i>
                <span style="color:white; font-weight:600;">Recording in Progress</span>
            </div>
            
            <!-- Events Management -->
            <section id="eventsManagement" class="section d-none admin-only">
                <h2>Events Management</h2>
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>Manage school events and automatically send notifications to parents and teachers.
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5>Total Events</h5>
                            <h3 id="totalEvents">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5>Upcoming Events</h5>
                            <h3 id="upcomingEvents">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5>Past Events</h5>
                            <h3 id="pastEvents">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5>Notifications Sent</h5>
                            <h3 id="eventNotificationsSent">0</h3>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-12">
                        <button class="btn btn-primary" onclick="showAddEventModal()"><i class="fas fa-plus me-2"></i>Add Event</button>
                        <button class="btn btn-success ms-2" onclick="showAddExcursionModal()"><i class="fas fa-bus me-2"></i>Add Excursion</button>
                        <button class="btn btn-warning ms-2" onclick="showAddFundraisingModal()"><i class="fas fa-hand-holding-usd me-2"></i>Add Fundraising</button>
                        <button class="btn btn-info ms-2" onclick="showUpcomingEventsCalendar()"><i class="fas fa-calendar me-2"></i>View Calendar</button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-control" id="eventTypeFilter" onchange="filterEvents()">
                            <option value="">All Event Types</option>
                            <option value="excursion">Excursion</option>
                            <option value="fundraising">Fundraising</option>
                            <option value="sports">Sports Day</option>
                            <option value="cultural">Cultural Event</option>
                            <option value="academic">Academic Event</option>
                            <option value="meeting">Parent-Teacher Meeting</option>
                            <option value="ceremony">Ceremony</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="eventDateFilter" onchange="filterEvents()">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Search events..." id="eventSearch" oninput="filterEvents()">
                    </div>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Location</th>
                            <th>Participants</th>
                            <th>Status</th>
                            <th>Notifications</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTable"></tbody>
                </table>
            </section>
            <!-- Content Management -->
            <section id="content" class="section d-none admin-only">
                <h2>Content Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddContentModal()">Add Content</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search content..." id="contentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchContent()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="contentTable"></tbody>
                </table>
            </section>
            <!-- Reports -->
            <section id="reports" class="section d-none admin-only">
                <h2>Reports & Virtual Forms</h2>
                
                <!-- Tabs for Reports and Virtual Forms -->
                <ul class="nav nav-tabs mb-3" id="reportsTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#reports-tab">Reports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#virtual-forms-tab">Virtual Forms</a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Reports Tab -->
                    <div class="tab-pane fade show active" id="reports-tab">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" onclick="showAddIncidentModal()">
                                    <i class="fas fa-plus me-2"></i>Add Incident Report
                                </button>
                                <button class="btn btn-info ms-2" onclick="viewAllIncidents()">
                                    <i class="fas fa-list me-2"></i>View All Incidents
                                </button>
                            </div>
                        </div>
                        <select id="reportType" class="form-select mb-3" style="width: auto;">
                            <option value="attendance">Attendance Report</option>
                            <option value="fees">Fee Report</option>
                            <option value="exams">Exam Report</option>
                            <option value="hr">HR Report</option>
                            <option value="incidents">Incident Reports</option>
                            <option value="events">Events Report</option>
                        </select>
                        <button class="btn btn-primary mb-3" onclick="generateReport()">Generate</button>
                        <button class="btn btn-success mb-3" onclick="exportReport()">Export</button>
                        <div id="reportOutput" class="d-none"></div>
                    </div>
                    
                    <!-- Virtual Forms Tab -->
                    <div class="tab-pane fade" id="virtual-forms-tab">
                        <div class="virtual-forms-section">
                            <h4><i class="fas fa-file-alt me-2"></i>Virtual Forms Management</h4>
                            <p class="text-muted">Upload, edit, fill in, print, and download school forms</p>
                            
                            <!-- Upload Section -->
                            <div class="card card-metric p-3 mb-4">
                                <h5><i class="fas fa-upload me-2"></i>Upload New Form</h5>
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label class="form-label">Form Name</label>
                                            <input type="text" id="virtualFormName" class="form-control" placeholder="Enter form name">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Upload Form File (PDF, Word, Excel, etc.)</label>
                                            <input type="file" id="virtualFormFile" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea id="virtualFormDescription" class="form-control" rows="2" placeholder="Brief description of the form"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Form Category</label>
                                        <select id="virtualFormCategory" class="form-control mb-3">
                                            <option value="admission">Admission Forms</option>
                                            <option value="enrollment">Enrollment Forms</option>
                                            <option value="financial">Financial Forms</option>
                                            <option value="medical">Medical Forms</option>
                                            <option value="permission">Permission Forms</option>
                                            <option value="other">Other</option>
                                        </select>
                                        <button class="btn btn-primary w-100" onclick="uploadVirtualForm()">
                                            <i class="fas fa-cloud-upload me-2"></i>Upload Form
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pre-defined Forms Section -->
                            <div class="card card-metric p-3 mb-4">
                                <h5><i class="fas fa-file-invoice me-2"></i>Pre-defined School Forms</h5>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-card">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6><i class="fas fa-file-alt me-2"></i>Application for Admission - Bophelong Community Independent School</h6>
                                                    <p class="mb-0 text-muted"><small>Complete admission application form with learner and parent information</small></p>
                                                </div>
                                                <div>
                                                    <button class="btn btn-sm btn-info form-preview-btn" onclick="viewAdmissionForm()">
                                                        <i class="fas fa-eye me-1"></i>View
                                                    </button>
                                                    <button class="btn btn-sm btn-primary form-preview-btn" onclick="fillAdmissionForm()">
                                                        <i class="fas fa-edit me-1"></i>Fill
                                                    </button>
                                                    <button class="btn btn-sm btn-success form-preview-btn" onclick="printAdmissionForm()">
                                                        <i class="fas fa-print me-1"></i>Print
                                                    </button>
                                                    <button class="btn btn-sm btn-secondary form-preview-btn" onclick="downloadAdmissionForm()">
                                                        <i class="fas fa-download me-1"></i>Download
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Uploaded Forms List -->
                            <div class="card card-metric p-3">
                                <h5><i class="fas fa-folder-open me-2"></i>Uploaded Forms</h5>
                                <div class="uploaded-files-list" id="uploadedVirtualForms">
                                    <p class="text-center text-muted">No forms uploaded yet. Upload a form using the section above.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Settings -->
            
            
            <section id="settings" class="section d-none admin-only">
                <h2>Settings</h2>
                
                <!-- Settings Navigation Tabs -->
                <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-settings-tab" data-bs-toggle="tab" data-bs-target="#general-settings" type="button" role="tab" aria-controls="general-settings" aria-selected="true">
                            <i class="fas fa-cog me-2"></i>General
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="user-management-tab" data-bs-toggle="tab" data-bs-target="#user-management" type="button" role="tab" aria-controls="user-management" aria-selected="false">
                            <i class="fas fa-users-cog me-2"></i>User Management
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="theme-settings-tab" data-bs-toggle="tab" data-bs-target="#theme-settings" type="button" role="tab" aria-controls="theme-settings" aria-selected="false">
                            <i class="fas fa-palette me-2"></i>Themes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="data-vault-tab" data-bs-toggle="tab" data-bs-target="#data-vault-settings" type="button" role="tab" aria-controls="data-vault-settings" aria-selected="false">
                            <i class="fas fa-database me-2"></i>Data Vault
                        </button>
                    </li>
                </ul>
                
                <!-- Settings Tab Content -->
                <div class="tab-content" id="settingsTabContent">
                    <!-- General Settings Tab -->
                    <div class="tab-pane fade show active" id="general-settings" role="tabpanel" aria-labelledby="general-settings-tab">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>SMS Integration (WinSMS)</h5>
                                <div class="mb-3">
                                    <label>Username</label>
                                    <input type="text" id="smsUsername" class="form-control" placeholder="WinSMS Username">
                                </div>
                                <div class="mb-3">
                                    <label>Password</label>
                                    <input type="password" id="smsPassword" class="form-control" placeholder="WinSMS Password">
                                </div>
                                <button class="btn btn-primary" onclick="saveSMSSettings()">Save SMS Settings</button>
                            </div>
                            <div class="col-md-6">
                                <h5>HR Settings</h5>
                                <div class="mb-3">
                                    <label>Annual Leave Days</label>
                                    <input type="number" id="annualLeaveDays" class="form-control" value="21">
                                </div>
                                <div class="mb-3">
                                    <label>UIF Rate (%)</label>
                                    <input type="number" id="uifRate" class="form-control" value="1" step="0.1">
                                </div>
                                <button class="btn btn-primary" onclick="updateHRSettings()">Update HR Settings</button>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h5>AI Integration (ChatGPT-4 API)</h5>
                                <div class="mb-3">
                                    <label>API Key</label>
                                    <input type="password" id="chatGPTApiKey" class="form-control" placeholder="Enter ChatGPT-4 API Key">
                                </div>
                                <div class="mb-3">
                                    <label>Model</label>
                                    <select id="chatGPTModel" class="form-control">
                                        <option value="gpt-4">GPT-4</option>
                                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="saveChatGPTSettings()">Save ChatGPT Settings</button>
                                <button class="btn btn-secondary ms-2" onclick="configureChatGPTAPI()">Configure</button>
                            </div>
                            <div class="col-md-6">
                                <h5>AI Integration (Grok API)</h5>
                                <div class="mb-3">
                                    <label>API Key</label>
                                    <input type="password" id="grokApiKey" class="form-control" placeholder="Enter Grok API Key">
                                </div>
                                <div class="mb-3">
                                    <label>Model</label>
                                    <select id="grokModel" class="form-control">
                                        <option value="grok-beta">Grok Beta</option>
                                        <option value="grok-1">Grok-1</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="saveGrokSettings()">Save Grok Settings</button>
                                <button class="btn btn-secondary ms-2" onclick="configureGrokAPI()">Configure</button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button class="btn btn-secondary" onclick="backupData()">Backup Data</button>
                            <button class="btn btn-warning ms-2" onclick="restoreData()">Restore Data</button>
                        </div>
                    </div>
                    
                    <!-- User Management Tab -->
                    <div class="tab-pane fade" id="user-management" role="tabpanel" aria-labelledby="user-management-tab">
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>User Management</h5>
                                    <button class="btn btn-primary" onclick="showCreateUserModal()">
                                        <i class="fas fa-user-plus me-2"></i>Create New User
                                    </button>
                                </div>
                                <p class="text-muted mt-2">Create and manage user accounts for Parents, Students, Teachers, and HODs. View all users and their credentials.</p>
                            </div>
                        </div>
                        
                        <!-- User Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card card-metric p-3 text-center">
                                    <h5><i class="fas fa-users me-2" style="color: #0ea5e9;"></i>Total Users</h5>
                                    <h3 id="totalUsersCount">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card card-metric p-3 text-center">
                                    <h5><i class="fas fa-chalkboard-teacher me-2" style="color: #10b981;"></i>Teachers</h5>
                                    <h3 id="teacherUsersCount">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card card-metric p-3 text-center">
                                    <h5><i class="fas fa-user-graduate me-2" style="color: #f59e0b;"></i>Students</h5>
                                    <h3 id="studentUsersCount">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card card-metric p-3 text-center">
                                    <h5><i class="fas fa-user-friends me-2" style="color: #8b5cf6;"></i>Parents</h5>
                                    <h3 id="parentUsersCount">0</h3>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="row mb-3">
                            <div class="col-md-6 mb-2">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="userSearchInput" class="form-control" placeholder="Search users by name, username, or email..." oninput="renderUsersList()">
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select id="userRoleFilter" class="form-select" onchange="renderUsersList()">
                                    <option value="">All Roles</option>
                                    <option value="Admin">Admin</option>
                                    <option value="HOD">HOD</option>
                                    <option value="Teacher">Teacher</option>
                                    <option value="Student">Student</option>
                                    <option value="Parent">Parent</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-info w-100" onclick="exportUsersList()">
                                    <i class="fas fa-download me-2"></i>Export Users
                                </button>
                            </div>
                        </div>
                        
                        <!-- Users Table -->
                        <div class="table-responsive">
                            <table class="table table-striped" id="usersTable">
                                <thead>
                                    <tr>
                                        <th style="cursor: pointer;" onclick="sortUsersTable('index')"># <i class="fas fa-sort ms-1" id="sort-index"></i></th>
                                        <th style="cursor: pointer;" onclick="sortUsersTable('name')">Name <i class="fas fa-sort ms-1" id="sort-name"></i></th>
                                        <th style="cursor: pointer;" onclick="sortUsersTable('username')">Username <i class="fas fa-sort ms-1" id="sort-username"></i></th>
                                        <th>Password</th>
                                        <th style="cursor: pointer;" onclick="sortUsersTable('role')">Role <i class="fas fa-sort ms-1" id="sort-role"></i></th>
                                        <th style="cursor: pointer;" onclick="sortUsersTable('email')">Email <i class="fas fa-sort ms-1" id="sort-email"></i></th>
                                        <th style="cursor: pointer;" onclick="sortUsersTable('status')">Status <i class="fas fa-sort ms-1" id="sort-status"></i></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label class="me-2">Show:</label>
                                    <select id="usersPerPage" class="form-select form-select-sm" style="width: auto;" onchange="changeUsersPerPage()">
                                        <option value="10">10</option>
                                        <option value="25" selected>25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                    <span class="ms-2" id="usersTableInfo">Showing 0 of 0 users</span>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex justify-content-end">
                                <nav aria-label="Users pagination">
                                    <ul class="pagination pagination-sm mb-0" id="usersPagination">
                                        <!-- Pagination will be rendered here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                        
                        <!-- Save Changes Button -->
                        <div class="row mt-4">
                            <div class="col-12 d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="realtime-indicator"></span>
                                    <small class="text-muted">Real-time sync enabled - changes update on all devices instantly</small>
                                </div>
                                <button class="btn btn-success btn-lg" id="saveAllChangesBtn" onclick="saveAllUserChanges()" style="display: none;">
                                    <i class="fas fa-save me-2"></i>Save All Changes
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Quick Tips:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>Click the <i class="fas fa-eye"></i> button to view/copy passwords</li>
                                        <li>Use the role filter to quickly find specific user types</li>
                                        <li>HOD users have Head of Department privileges</li>
                                        <li>Use the magic wand button when creating users to generate secure passwords</li>
                                        <li><strong>Inline Editing:</strong> Click on name, username, email, role, or status to edit directly in the table</li>
                                        <li><strong>Sorting:</strong> Click column headers to sort the table</li>
                                        <li><strong>Real-time Sync:</strong> All changes are instantly synced across all connected devices</li>
                                        <li><strong>Pagination:</strong> Use the controls below the table to navigate through large user lists</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Theme Settings Tab -->
                    <div class="tab-pane fade" id="theme-settings" role="tabpanel" aria-labelledby="theme-settings-tab">
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <h5>Enhanced Theme Generator</h5>
                                <p>Choose from 12 professional color themes to customize the appearance of the application.</p>
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="d-flex flex-wrap gap-3" id="themeSelector">
                                            <!-- Theme 1: Default Purple -->
                                            <div class="theme-option" onclick="applyTheme('default')" data-theme="default">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Default Purple</div>
                                            </div>
                                            
                                            <!-- Theme 2: Ocean Blue -->
                                            <div class="theme-option" onclick="applyTheme('ocean')" data-theme="ocean">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Ocean Blue</div>
                                            </div>
                                            
                                            <!-- Theme 3: Forest Green -->
                                            <div class="theme-option" onclick="applyTheme('forest')" data-theme="forest">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Forest Green</div>
                                            </div>
                                            
                                            <!-- Theme 4: Sunset Orange -->
                                            <div class="theme-option" onclick="applyTheme('sunset')" data-theme="sunset">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #f46b45 0%, #eea849 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Sunset Orange</div>
                                            </div>
                                            
                                            <!-- Theme 5: Midnight Dark -->
                                            <div class="theme-option" onclick="applyTheme('midnight')" data-theme="midnight">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #232526 0%, #414345 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Midnight Dark</div>
                                            </div>
                                            
                                            <!-- Theme 6: Rose Pink -->
                                            <div class="theme-option" onclick="applyTheme('rose')" data-theme="rose">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #ee9ca7 0%, #ffdde1 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Rose Pink</div>
                                            </div>
                                            
                                            <!-- Theme 7: Emerald -->
                                            <div class="theme-option" onclick="applyTheme('emerald')" data-theme="emerald">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Emerald</div>
                                            </div>
                                            
                                            <!-- Theme 8: Crimson Red -->
                                            <div class="theme-option" onclick="applyTheme('crimson')" data-theme="crimson">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Crimson Red</div>
                                            </div>
                                            
                                            <!-- Theme 9: Royal Gold -->
                                            <div class="theme-option" onclick="applyTheme('royal')" data-theme="royal">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #141e30 0%, #243b55 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Royal Gold</div>
                                            </div>
                                            
                                            <!-- Theme 10: Cosmic Purple -->
                                            <div class="theme-option" onclick="applyTheme('cosmic')" data-theme="cosmic">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #3a1c71 0%, #d76d77 50%, #ffaf7b 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Cosmic Purple</div>
                                            </div>
                                            
                                            <!-- Theme 11: Aqua Marine -->
                                            <div class="theme-option" onclick="applyTheme('aqua')" data-theme="aqua">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #2E3192 0%, #1BFFFF 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Aqua Marine</div>
                                            </div>
                                            
                                            <!-- Theme 12: Autumn Leaves -->
                                            <div class="theme-option" onclick="applyTheme('autumn')" data-theme="autumn">
                                                <div class="theme-preview" style="background: linear-gradient(135deg, #DAD299 0%, #B0DAB9 100%);">
                                                    <i class="fas fa-check theme-check d-none"></i>
                                                </div>
                                                <div class="theme-name">Autumn Leaves</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Your selected theme will be saved automatically and persist across sessions. Choose from 12 beautiful themes!
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Vault Tab -->
                    <div class="tab-pane fade" id="data-vault-settings" role="tabpanel" aria-labelledby="data-vault-tab">
                        <div class="mt-4">
                            <h5>Data Vault</h5>
                            <p>The vault stores all reset and archived data for recovery purposes.</p>
                            <div class="row mb-3">
                                <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Items</h5><h3 id="vaultTotalItems">0</h3></div></div>
                                <div class="col-md-3"><div class="card card-metric p-3"><h5>Attendance Resets</h5><h3 id="vaultAttendanceResets">0</h3></div></div>
                                <div class="col-md-3"><div class="card card-metric p-3"><h5>Student Resets</h5><h3 id="vaultStudentResets">0</h3></div></div>
                                <div class="col-md-3"><div class="card card-metric p-3"><h5>Fee Resets</h5><h3 id="vaultFeeResets">0</h3></div></div>
                            </div>
                            <button class="btn btn-info mb-3" onclick="showVaultViewer()">View Vault Contents</button>
                            <button class="btn btn-warning mb-3" onclick="exportVault()">Export Vault</button>
                            <button class="btn btn-danger mb-3" onclick="clearVault()">Clear Vault</button>
                            <div id="vaultContent" class="d-none mt-3">
                                <h6>Vault Contents</h6>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead><tr><th>Timestamp</th><th>Type</th><th>Description</th><th>Actions</th></tr></thead>
                                        <tbody id="vaultTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </section>
            
            <!-- Create User Modal -->
            <div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="createUserModalLabel"><i class="fas fa-user-plus me-2"></i>Create New User</h5>
                            <button type="button" class="btn-close" aria-label="Close" onclick="hideModal('createUserModal')"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Full Name *</label>
                                    <input type="text" id="newUserName" class="form-control" placeholder="Enter full name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Username *</label>
                                    <input type="text" id="newUserUsername" class="form-control" placeholder="Enter username" required>
                                    <small class="text-muted">Username for login</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Password *</label>
                                    <div class="input-group">
                                        <input type="password" id="newUserPassword" class="form-control" placeholder="Enter password" required>
                                        <button class="btn btn-secondary" type="button" onclick="togglePasswordVisibility('newUserPassword', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-info" type="button" onclick="generateRandomPassword()">
                                            <i class="fas fa-magic"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Click magic wand to generate a password</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Role *</label>
                                    <select id="newUserRole" class="form-select" required onchange="toggleRoleFields()">
                                        <option value="">Select Role</option>
                                        <option value="Admin">Admin</option>
                                        <option value="HOD">HOD (Head of Department)</option>
                                        <option value="Teacher">Teacher</option>
                                        <option value="Student">Student</option>
                                        <option value="Parent">Parent</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" id="newUserEmail" class="form-control" placeholder="Enter email address">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" id="newUserPhone" class="form-control" placeholder="Enter phone number">
                                </div>
                            </div>
                            
                            <!-- HOD Specific Fields -->
                            <div id="hodFields" class="d-none">
                                <hr>
                                <h6><i class="fas fa-user-tie me-2"></i>HOD Details</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Department *</label>
                                        <select id="newUserDepartment" class="form-select">
                                            <option value="">Select Department</option>
                                            <option value="Mathematics">Mathematics</option>
                                            <option value="Science">Science</option>
                                            <option value="Languages">Languages</option>
                                            <option value="Social Sciences">Social Sciences</option>
                                            <option value="Arts">Arts</option>
                                            <option value="Sports">Sports</option>
                                            <option value="Technology">Technology</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Employee ID</label>
                                        <input type="text" id="newUserEmployeeId" class="form-control" placeholder="Enter employee ID">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Teacher Specific Fields -->
                            <div id="teacherFields" class="d-none">
                                <hr>
                                <h6><i class="fas fa-chalkboard-teacher me-2"></i>Teacher Details</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Subject Specialization</label>
                                        <input type="text" id="newUserSubject" class="form-control" placeholder="Enter subject">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Assigned Grades</label>
                                        <input type="text" id="newUserGrades" class="form-control" placeholder="e.g., Grade 8, Grade 9">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Student Specific Fields -->
                            <div id="studentFields" class="d-none">
                                <hr>
                                <h6><i class="fas fa-user-graduate me-2"></i>Student Details</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Grade</label>
                                        <select id="newUserStudentGrade" class="form-select">
                                            <option value="">Select Grade</option>
                                            <option value="Grade R">Grade R</option>
                                            <option value="Grade 01">Grade 01</option>
                                            <option value="Grade 02">Grade 02</option>
                                            <option value="Grade 03">Grade 03</option>
                                            <option value="Grade 04">Grade 04</option>
                                            <option value="Grade 05">Grade 05</option>
                                            <option value="Grade 06">Grade 06</option>
                                            <option value="Grade 07">Grade 07</option>
                                            <option value="Grade 08">Grade 08</option>
                                            <option value="Grade 09">Grade 09</option>
                                            <option value="Grade 10">Grade 10</option>
                                            <option value="Grade 11">Grade 11</option>
                                            <option value="Grade 12">Grade 12</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Class</label>
                                        <input type="text" id="newUserClass" class="form-control" placeholder="e.g., A, B, C">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Parent Specific Fields -->
                            <div id="parentFields" class="d-none">
                                <hr>
                                <h6><i class="fas fa-user-friends me-2"></i>Parent Details</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Child's Name</label>
                                        <input type="text" id="newUserChildName" class="form-control" placeholder="Enter child's name">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Relationship</label>
                                        <select id="newUserRelationship" class="form-select">
                                            <option value="">Select Relationship</option>
                                            <option value="Father">Father</option>
                                            <option value="Mother">Mother</option>
                                            <option value="Guardian">Guardian</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">Notes</label>
                                    <textarea id="newUserNotes" class="form-control" rows="2" placeholder="Additional notes (optional)"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="hideModal('createUserModal')">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="createNewUser()">
                                <i class="fas fa-user-plus me-2"></i>Create User
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Edit User Modal -->
            <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editUserModalLabel"><i class="fas fa-user-edit me-2"></i>Edit User</h5>
                            <button type="button" class="btn-close" aria-label="Close" onclick="hideModal('editUserModal')"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="editUserIndex">
                            <div class="mb-3">
                                <label class="form-label">Full Name *</label>
                                <input type="text" id="editUserName" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Username *</label>
                                <input type="text" id="editUserUsername" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password *</label>
                                <div class="input-group">
                                    <input type="password" id="editUserPassword" class="form-control" required>
                                    <button class="btn btn-secondary" type="button" onclick="togglePasswordVisibility('editUserPassword', this)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Role *</label>
                                <select id="editUserRole" class="form-select" required>
                                    <option value="Admin">Admin</option>
                                    <option value="HOD">HOD (Head of Department)</option>
                                    <option value="Teacher">Teacher</option>
                                    <option value="Student">Student</option>
                                    <option value="Parent">Parent</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" id="editUserEmail" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select id="editUserStatus" class="form-select">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="hideModal('editUserModal')">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="updateUser()">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- View User Modal -->
            <div class="modal fade" id="viewUserModal" tabindex="-1" aria-labelledby="viewUserModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="viewUserModalLabel"><i class="fas fa-user me-2"></i>User Details</h5>
                            <button type="button" class="btn-close" aria-label="Close" onclick="hideModal('viewUserModal')"></button>
                        </div>
                        <div class="modal-body">
                            <div id="viewUserContent">
                                <!-- User details will be rendered here -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-info" onclick="copyUserCredentials()">
                                <i class="fas fa-copy me-2"></i>Copy Credentials
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideModal('viewUserModal')">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Parent Portal -->
            
            <!-- Math Game Section (Student Portal) -->
            <section id="mathGame" class="section d-none student-only">
                <h2><i class="fas fa-calculator me-2"></i>Math Challenge Game</h2>
                <div class="alert alert-success mb-4">
                    <i class="fas fa-gamepad me-2"></i><strong>Improve Your Math Skills!</strong> Select your grade level and challenge yourself with math problems. Earn points and track your progress!
                </div>
                
                <!-- Game Setup -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card card-metric p-4">
                            <h5><i class="fas fa-graduation-cap me-2"></i>Select Grade Level</h5>
                            <select id="mathGameGrade" class="form-control mt-3" onchange="updateMathGameDifficulty()">
                                <option value="5">Grade 5</option>
                                <option value="6">Grade 6</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                                <option value="12">Grade 12</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-4">
                            <h5><i class="fas fa-star me-2"></i>Your Score</h5>
                            <h3 id="mathGameScore">0</h3>
                            <small>Points Earned</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-4">
                            <h5><i class="fas fa-trophy me-2"></i>High Score</h5>
                            <h3 id="mathGameHighScore">0</h3>
                            <small>Your Best</small>
                        </div>
                    </div>
                </div>
                
                <!-- Game Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <h5><i class="fas fa-check-circle text-success"></i></h5>
                            <h4 id="mathCorrectCount">0</h4>
                            <small>Correct</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <h5><i class="fas fa-times-circle text-danger"></i></h5>
                            <h4 id="mathWrongCount">0</h4>
                            <small>Wrong</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <h5><i class="fas fa-fire text-warning"></i></h5>
                            <h4 id="mathStreak">0</h4>
                            <small>Streak</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3 text-center">
                            <h5><i class="fas fa-clock text-info"></i></h5>
                            <h4 id="mathTimer">60</h4>
                            <small>Seconds Left</small>
                        </div>
                    </div>
                </div>
                
                <!-- Game Area -->
                <div class="card" style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(233, 69, 96, 0.2), rgba(255, 107, 107, 0.1));">
                        <h5 class="mb-0"><i class="fas fa-puzzle-piece me-2"></i>Math Challenge</h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Question Display -->
                        <div id="mathQuestionArea" style="display: none;">
                            <div class="text-center mb-4">
                                <div id="mathQuestionType" class="badge bg-info mb-3" style="font-size: 1rem;"></div>
                                <h1 id="mathQuestion" style="font-size: 3rem; font-weight: 700;"></h1>
                            </div>
                            
                            <!-- Answer Input -->
                            <div class="row justify-content-center mb-4">
                                <div class="col-md-6">
                                    <div class="input-group input-group-lg">
                                        <input type="text" id="mathAnswer" class="form-control text-center" placeholder="Your Answer" style="font-size: 1.5rem; font-weight: 600;" onkeypress="if(event.key==='Enter') checkMathAnswer()">
                                        <button class="btn btn-primary btn-lg" onclick="checkMathAnswer()">
                                            <i class="fas fa-check me-2"></i>Submit
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Feedback Area -->
                            <div id="mathFeedback" class="text-center mb-3" style="min-height: 50px;"></div>
                            
                            <!-- Skip Button -->
                            <div class="text-center">
                                <button class="btn btn-secondary" onclick="skipMathQuestion()">
                                    <i class="fas fa-forward me-2"></i>Skip (-5 points)
                                </button>
                            </div>
                        </div>
                        
                        <!-- Start Screen -->
                        <div id="mathStartScreen" class="text-center py-5">
                            <i class="fas fa-brain fa-5x mb-4" style="color: var(--accent-primary);"></i>
                            <h3>Ready to Challenge Your Math Skills?</h3>
                            <p class="text-muted mb-4">Select your grade level above and click Start to begin!</p>
                            <button class="btn btn-primary btn-lg px-5" onclick="startMathGame()">
                                <i class="fas fa-play me-2"></i>Start Game
                            </button>
                        </div>
                        
                        <!-- Game Over Screen -->
                        <div id="mathGameOver" class="text-center py-5" style="display: none;">
                            <i class="fas fa-trophy fa-5x mb-4" style="color: #fbbf24;"></i>
                            <h2>Game Over!</h2>
                            <div class="row justify-content-center mt-4">
                                <div class="col-md-8">
                                    <div class="card card-metric p-4" style="background: rgba(233, 69, 96, 0.15);">
                                        <h4>Your Final Score: <span id="mathFinalScore" style="color: var(--accent-primary);">0</span></h4>
                                        <p class="mb-0">
                                            Correct: <span id="mathFinalCorrect">0</span> | 
                                            Wrong: <span id="mathFinalWrong">0</span> | 
                                            Best Streak: <span id="mathFinalStreak">0</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-lg mt-4" onclick="startMathGame()">
                                <i class="fas fa-redo me-2"></i>Play Again
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Math Topics by Grade -->
                <div class="card mt-4" style="background: rgba(255, 255, 255, 0.05);">
                    <div class="card-header" style="background: rgba(255, 255, 255, 0.1);">
                        <h5 class="mb-0"><i class="fas fa-book me-2"></i>Topics by Grade Level</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <h6 class="text-primary">Grade 5-6</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check me-2 text-success"></i>Basic Operations</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Fractions</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Decimals</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Percentages</li>
                                </ul>
                            </div>
                            <div class="col-md-3 mb-3">
                                <h6 class="text-info">Grade 7-8</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check me-2 text-success"></i>Integers</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Basic Algebra</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Ratios</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Geometry Basics</li>
                                </ul>
                            </div>
                            <div class="col-md-3 mb-3">
                                <h6 class="text-warning">Grade 9-10</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check me-2 text-success"></i>Linear Equations</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Quadratics</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Exponents</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Pythagoras</li>
                                </ul>
                            </div>
                            <div class="col-md-3 mb-3">
                                <h6 class="text-danger">Grade 11-12</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check me-2 text-success"></i>Trigonometry</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Functions</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Calculus Basics</li>
                                    <li><i class="fas fa-check me-2 text-success"></i>Complex Numbers</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- AI Research Assistant (Student Portal) -->
            <section id="aiResearch" class="section d-none student-only">
                <h2>AI Research Assistant</h2>
                <div class="alert alert-success mb-3">
                    <i class="fas fa-lightbulb me-2"></i>Use our advanced AI to help with your research, homework, and learning!
                </div>
                <div class="row mb-3">
                    <div class="col-md-8">
                        <textarea id="researchQuery" class="form-control" rows="3" placeholder="Ask a detailed research question or describe what you'd like to learn..."></textarea>
                    </div>
                    <div class="col-md-4">
                        <select id="aiProvider" class="form-control mb-2">
                            <option value="chatgpt">ChatGPT</option>
                            <option value="grok">Grok</option>
                        </select>
                        <select id="researchCategory" class="form-control mb-2">
                            <option value="general">General Research</option>
                            <option value="science">Science</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="history">History</option>
                            <option value="literature">Literature</option>
                            <option value="geography">Geography</option>
                            <option value="technology">Technology</option>
                        </select>
                        <button class="btn btn-primary w-100" onclick="researchWithAI()">
                            <i class="fas fa-search me-2"></i>Research
                        </button>
                        <button class="btn btn-secondary w-100 mt-2" onclick="clearResearch()">
                            <i class="fas fa-eraser me-2"></i>Clear
                        </button>
                    </div>
                </div>
                <div id="researchResults"></div>
                <div id="researchHistory" class="mt-4"></div>
            </section>
            <!-- Student Time Table (Read-Only) -->
            <section id="studentTimetable" class="section d-none student-only">
                <h2>My Time Table</h2>
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>This is a read-only view of your class timetable.
                </div>
                <div id="studentTimetableContainer">
                    <p class="text-center">Loading your timetable...</p>
                </div>
            </section>
            <!-- Student Examination (Read-Only) -->
            <section id="studentExamination" class="section d-none student-only">
                <h2>My Assessments</h2>
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>View your upcoming assessments and past results.
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Filter by Assessment Type:</label>
                        <select class="form-control" id="assessmentTypeFilter" onchange="loadStudentExamination()">
                            <option value="">All Types</option>
                            <option value="test">Test</option>
                            <option value="project">Project</option>
                            <option value="exam">Exam</option>
                            <option value="assignment">Assignment</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Upcoming Assessments</h5>
                            <h3 id="studentUpcomingExams">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Average Score</h5>
                            <h3 id="studentAvgScore">0%</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Completed Assessments</h5>
                            <h3 id="studentCompletedExams">0</h3>
                        </div>
                    </div>
                </div>
                <h4 class="mt-4">Upcoming Assessments</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Subject</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Duration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="studentExamTable"></tbody>
                </table>
                <h4 class="mt-4">My Results</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Subject</th>
                            <th>Assessment</th>
                            <th>Date</th>
                            <th>Score</th>
                            <th>Grade</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody id="studentResultsTable"></tbody>
                </table>
            </section>
            <!-- Student Inbox -->
            <section id="studentInbox" class="section d-none student-only">
                <h2>My Inbox</h2>
                <div class="alert alert-success mb-3">
                    <i class="fas fa-envelope me-2"></i>View messages from teachers and send messages to your teachers.
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="showSendTeacherMessageModal()">
                            <i class="fas fa-paper-plane me-2"></i>Send Message to Teacher
                        </button>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search messages..." id="studentInboxSearch">
                            <button class="btn btn-outline-secondary" onclick="searchStudentInbox()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-control" id="studentInboxFilter" onchange="loadStudentInbox()">
                            <option value="all">All Messages</option>
                            <option value="unread">Unread</option>
                            <option value="important">Important</option>
                            <option value="sent">Sent by Me</option>
                        </select>
                    </div>
                </div>
                <div id="studentInboxContainer"></div>
            </section>
            <!-- Student Upload Work -->
            <section id="studentUploadWork" class="section d-none student-only">
                <h2>My Work Submissions</h2>
                <div class="alert alert-success mb-3">
                    <i class="fas fa-upload me-2"></i>Submit your homework, projects, and assignments here.
                </div>
                
                <!-- Submit New Work Form -->
                <div class="card mb-4" style="background: rgba(255, 255, 255, 0.1);">
                    <div class="card-header" style="background: rgba(255, 255, 255, 0.2);">
                        <h5><i class="fas fa-plus-circle me-2"></i>Submit New Work</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Assignment Title</label>
                                <input type="text" id="studentWorkTitle" class="form-control" placeholder="e.g., Math Homework Chapter 5">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Subject</label>
                                <select id="studentWorkSubject" class="form-control">
                                    <option value="">Select Subject</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="English">English</option>
                                    <option value="Science">Science</option>
                                    <option value="History">History</option>
                                    <option value="Geography">Geography</option>
                                    <option value="Art">Art</option>
                                    <option value="Physical Education">Physical Education</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description / Notes</label>
                            <textarea id="studentWorkDescription" class="form-control" rows="3" placeholder="Add any notes or comments about your submission..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Upload Files (PDF, Word, Images, etc.)</label>
                            <input type="file" id="studentWorkFiles" class="form-control" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt">
                            <small class="text-muted">You can select multiple files</small>
                        </div>
                        <button class="btn btn-primary" onclick="submitStudentWork()">
                            <i class="fas fa-paper-plane me-2"></i>Submit Work
                        </button>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Submitted</h5>
                            <h3 id="studentSubmittedWork">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Pending</h5>
                            <h3 id="studentPendingWork">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Graded</h5>
                            <h3 id="studentGradedWork">0</h3>
                        </div>
                    </div>
                </div>
                <h4 class="mt-4">My Submissions</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Assignment</th>
                            <th>Subject</th>
                            <th>Submitted Date</th>
                            <th>Files</th>
                            <th>Status</th>
                            <th>Grade</th>
                            <th>Feedback</th>
                        </tr>
                    </thead>
                    <tbody id="studentWorkTable"></tbody>
                </table>
            </section>
            <!-- Modals -->
            <!-- New Admission Modal -->
            <div class="modal fade" id="addAdmissionModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">New Admission - SA-SAMS Format</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info text-dark">
                                <strong>SA-Sams Format:</strong> Complete all required fields according to South African School Administration standards.
                            </div>
                            <h6 class="text-dark mt-3">Learner Details</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" id="admissionAccession" class="form-control mb-2" placeholder="Student Number *" required>
                                    <input type="text" id="admissionSurname" class="form-control mb-2" placeholder="Surname *" required>
                                    <input type="text" id="admissionFirstName" class="form-control mb-2" placeholder="First Name *" required>
                                    <select id="admissionGender" class="form-control mb-2">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <input type="text" id="admissionGrade" class="form-control mb-2" placeholder="Grade *" required>
                                    <input type="text" id="admissionClass" class="form-control mb-2" placeholder="Class">
                                    <input type="text" id="admissionCell" class="form-control mb-2" placeholder="Cell#">
                                    <input type="email" id="admissionEmail" class="form-control mb-2" placeholder="Email">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <select id="admissionHomeLanguage" class="form-control mb-2">
                                        <option value="">Select Home Language</option>
                                        <option value="English">English</option>
                                        <option value="Afrikaans">Afrikaans</option>
                                        <option value="isiZulu">isiZulu</option>
                                        <option value="isiXhosa">isiXhosa</option>
                                        <option value="Sesotho">Sesotho</option>
                                        <option value="Setswana">Setswana</option>
                                        <option value="Sepedi">Sepedi</option>
                                        <option value="Xitsonga">Xitsonga</option>
                                        <option value="siSwati">siSwati</option>
                                        <option value="Tshivenda">Tshivenda</option>
                                        <option value="isiNdebele">isiNdebele</option>
                                    </select>
                                </div>
                            </div>
                            <h6 class="text-dark mt-3">Father Details</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" id="admissionFatherName" class="form-control mb-2" placeholder="Father Name">
                                    <input type="text" id="admissionFatherSurname" class="form-control mb-2" placeholder="Father Surname">
                                </div>
                                <div class="col-md-6">
                                    <input type="email" id="admissionFatherEmail" class="form-control mb-2" placeholder="Father Email">
                                    <input type="text" id="admissionFatherCell" class="form-control mb-2" placeholder="Father Cell#">
                                </div>
                            </div>
                            <h6 class="text-dark mt-3">Mother Details</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" id="admissionMotherName" class="form-control mb-2" placeholder="Mother Name">
                                    <input type="text" id="admissionMotherSurname" class="form-control mb-2" placeholder="Mother Surname">
                                </div>
                                <div class="col-md-6">
                                    <input type="email" id="admissionMotherEmail" class="form-control mb-2" placeholder="Mother Email">
                                    <input type="text" id="admissionMotherCell" class="form-control mb-2" placeholder="Mother Cell#">
                                </div>
                            </div>
                            <h6 class="text-dark mt-3">Additional Information</h6>
                            <input type="text" id="admissionUsername" class="form-control mb-2" placeholder="Student Username">
                            <input type="password" id="admissionPassword" class="form-control mb-2" placeholder="Student Password">
                            <select id="admissionStatus" class="form-control mb-2">
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveAdmission()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Student Modal -->
            <div class="modal fade" id="addStudentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Student</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info text-dark">
                                <strong>SA-Sams Format:</strong> Complete all required fields according to South African School Administration standards.
                            </div>
                            <input type="text" id="studentAccession" class="form-control mb-2" placeholder="Accession Number *" required>
                            <input type="text" id="studentSurname" class="form-control mb-2" placeholder="Surname *" required>
                            <input type="text" id="studentFirstName" class="form-control mb-2" placeholder="First Name *" required>
                            <input type="text" id="studentIdNumber" class="form-control mb-2" placeholder="ID Number / Birth Certificate Number">
                            <input type="date" id="studentDateOfBirth" class="form-control mb-2" placeholder="Date of Birth">
                            <select id="studentGender" class="form-control mb-2">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                            <select id="studentHomeLanguage" class="form-control mb-2">
                                <option value="">Select Home Language</option>
                                <option value="English">English</option>
                                <option value="Afrikaans">Afrikaans</option>
                                <option value="isiZulu">isiZulu</option>
                                <option value="isiXhosa">isiXhosa</option>
                                <option value="Sesotho">Sesotho</option>
                                <option value="Setswana">Setswana</option>
                                <option value="Sepedi">Sepedi</option>
                                <option value="Xitsonga">Xitsonga</option>
                                <option value="siSwati">siSwati</option>
                                <option value="Tshivenda">Tshivenda</option>
                                <option value="isiNdebele">isiNdebele</option>
                            </select>
                            <input type="text" id="studentGrade" class="form-control mb-2" placeholder="Grade *" required>
                            <input type="text" id="studentParent" class="form-control mb-2" placeholder="Parent/Guardian Name">
                            <input type="text" id="studentParentContact" class="form-control mb-2" placeholder="Parent Contact Number">
                            <input type="text" id="studentAddress" class="form-control mb-2" placeholder="Residential Address">
                            <input type="text" id="studentEducator" class="form-control mb-2" placeholder="Educator">
                            <select id="studentStatus" class="form-control mb-2">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                            <h6 class="mt-3 mb-2 text-dark"><strong>Additional Information</strong></h6>
                            <!-- Note: In production, implement proper authentication with secure password hashing -->
                            <input type="text" id="studentUsername" class="form-control mb-2" placeholder="Username for profile login">
                            <input type="password" id="studentPassword" class="form-control mb-2" placeholder="Password for profile login">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveStudent()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Student Import Modal -->
            <div class="modal fade" id="bulkStudentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Import Students (CSV/Excel/PDF/Word)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info mb-3 text-dark">
                                <strong>SA-Sams Format Requirements:</strong> Your file should contain the following columns:
                                <br><strong>Required:</strong> Surname, FirstName, Grade, Accession Number
                                <br><strong>Optional:</strong> IDNumber, DateOfBirth, Gender, HomeLanguage, ParentName, ParentContact, Address
                                <br>Example: <code>Accession,Surname,FirstName,Grade,IDNumber,DateOfBirth,Gender,HomeLanguage</code>
                            </div>
                            <input type="file" id="studentFile" class="form-control" accept=".csv,.xlsx,.pdf,.doc,.docx">
                            <div id="studentPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkStudents()">Import</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Attendance Marking Modal -->
            <div class="modal fade" id="attendanceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Mark Attendance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="attendanceStudentId">
                            <p id="attendanceStudentName"></p>
                            <input type="date" id="attendanceModalDate" class="form-control mb-2">
                            <select id="attendanceStatus" class="form-control mb-2">
                                <option value="Present">Present</option>
                                <option value="Absent">Absent</option>
                                <option value="Late">Late</option>
                            </select>
                            <textarea id="attendanceNotes" class="form-control" placeholder="Notes"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveAttendanceMark()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Mark All Present Modal -->
            <div class="modal fade" id="markAllPresentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-check-double me-2"></i>Mark All Present</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>This will mark all students as present for the selected date and class.
                            </div>
                            <label for="markAllPresentDate" class="form-label">Select Date:</label>
                            <input type="date" id="markAllPresentDate" class="form-control mb-3">
                            <label for="markAllPresentClass" class="form-label">Select Class (Optional):</label>
                            <select id="markAllPresentClass" class="form-control mb-2">
                                <option value="">All Classes</option>
                            </select>
                            <div id="markAllPresentPreview" class="mt-3 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                                <small class="text-muted">Select a date and class to see how many students will be marked present.</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="confirmMarkAllPresent()"><i class="fas fa-check me-2"></i>Mark All Present</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Import Attendance Modal -->
            <div class="modal fade" id="importAttendanceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Import Attendance (CSV/Excel/PDF/Word)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="attendanceFile" class="form-control" accept=".csv,.xlsx,.pdf,.doc,.docx">
                            <div id="attendancePreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkAttendance()">Import</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Generate Invoice Modal -->
            <div class="modal fade" id="generateInvoiceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Generate Invoice</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="invoiceStudent" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <input type="number" id="invoiceAmount" class="form-control mb-2" placeholder="Amount (R)">
                            <input type="date" id="invoiceDueDate" class="form-control mb-2">
                            <textarea id="invoiceDescription" class="form-control mb-2" placeholder="Description"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveInvoice()">Generate</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Upload Fees Modal -->
            <div class="modal fade" id="bulkUploadFeesModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Upload Fees (CSV/PDF/Word)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="feesFile" class="form-control" accept=".csv,.xlsx,.pdf,.doc,.docx">
                            <div id="feesPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkFees()">Upload</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Time Slot Modal -->
            <div class="modal fade" id="addTimeSlotModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Time Slot</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="timeSlotGrade" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="timeSlotDay" class="form-control mb-2">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                            </select>
                            <input type="time" id="timeSlotTime" class="form-control mb-2">
                            <input type="text" id="timeSlotSubject" class="form-control mb-2" placeholder="Subject/Teacher">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveTimeSlot()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Exam Modal -->
            <div class="modal fade" id="addExamModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Schedule Exam</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="examName" class="form-control mb-2" placeholder="Exam Name">
                            <input type="date" id="examDate" class="form-control mb-2">
                            <input type="text" id="examSubject" class="form-control mb-2" placeholder="Subject">
                            <select id="examGrade" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="examStatus" class="form-control mb-2">
                                <option value="Scheduled">Scheduled</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveExam()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Payroll Modal -->
            <div class="modal fade" id="addPayrollModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Payroll</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="payrollStaff" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <input type="month" id="payrollMonth" class="form-control mb-2">
                            <input type="number" id="payrollSalary" class="form-control mb-2" placeholder="Gross Salary (R)">
                            <input type="number" id="payrollDeductions" class="form-control mb-2" placeholder="Deductions (R)">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="savePayroll()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Send Message Modal -->
            <div class="modal fade" id="sendMessageModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Send Message</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="messageRecipient" class="form-control mb-2">
                                <option value="all-students">All Students</option>
                                <option value="all-parents">All Parents</option>
                                <option value="all-staff">All Staff</option>
                            </select>
                            <textarea id="messageText" class="form-control mb-2" placeholder="Message text"></textarea>
                            <div class="form-check">
                                <input type="checkbox" id="sendViaSMS" class="form-check-input">
                                <label class="form-check-label">Send via SMS (WinSMS)</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Enhanced Announcements Modal -->
            <div class="modal fade" id="announcementsModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-bullhorn me-2"></i>Announcements Center <span class="realtime-indicator" title="Real-time broadcast enabled"></span></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-success mb-3">
                                <i class="fas fa-broadcast-tower me-2"></i>
                                <strong>Real-time Broadcasting:</strong> Announcements are instantly sent to all connected users across the system!
                            </div>
                            <ul class="nav nav-tabs mb-3" id="announcementsTabs">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#view-announcements">View Announcements</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#create-announcement">Create Announcement</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#upload-video">Upload Video</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="view-announcements">
                                    <h6>Recent Announcements</h6>
                                    <div id="announcementsList"></div>
                                </div>
                                <div class="tab-pane fade" id="create-announcement">
                                    <h6>Create New Announcement <small class="text-success"><i class="fas fa-wifi me-1"></i>Broadcasts instantly</small></h6>
                                    <div class="mb-3">
                                        <label class="form-label">Title</label>
                                        <input type="text" id="announcementTitle" class="form-control" placeholder="Enter announcement title">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Content</label>
                                        <textarea id="announcementContent" class="form-control" rows="5" placeholder="Enter announcement content"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Priority</label>
                                        <select id="announcementPriority" class="form-control">
                                            <option value="Low">Low</option>
                                            <option value="Medium" selected>Medium</option>
                                            <option value="High">High</option>
                                            <option value="Urgent">Urgent</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Target Audience</label>
                                        <select id="announcementAudience" class="form-control">
                                            <option value="All">All</option>
                                            <option value="Students">Students</option>
                                            <option value="Parents">Parents</option>
                                            <option value="Staff">Staff</option>
                                            <option value="Teachers">Teachers</option>
                                        </select>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Tip:</strong> Use the <a href="#" onclick="goToPosterCreator()">Poster Creator</a> or 
                                        <a href="#" onclick="goToVideoCreator()">Video Creator</a> 
                                        in the Media section to create visual announcements!
                                    </div>
                                    <button class="btn btn-primary" onclick="createAnnouncement()">
                                        <i class="fas fa-broadcast-tower me-2"></i>Publish & Broadcast Announcement
                                    </button>
                                </div>
                                <div class="tab-pane fade" id="upload-video">
                                    <h6>Upload Video Announcement</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Video Title</label>
                                        <input type="text" id="videoTitle" class="form-control" placeholder="Enter video title">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Video Description</label>
                                        <textarea id="videoDescription" class="form-control" rows="3" placeholder="Enter video description"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Upload Video File</label>
                                        <input type="file" id="videoFile" class="form-control" accept="video/*">
                                        <small class="text-muted">Supported formats: MP4, MOV, AVI (Max 100MB)</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Or Video URL</label>
                                        <input type="url" id="videoURL" class="form-control" placeholder="https://youtube.com/watch?v=...">
                                        <small class="text-muted">Paste YouTube, Vimeo, or other video link</small>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-video me-2"></i>
                                        <strong>New!</strong> Use the <a href="#" onclick="goToVideoCreator()">Advanced Video Creator</a> 
                                        in the Media section to record and edit your own videos!
                                    </div>
                                    <button class="btn btn-info" onclick="uploadVideo()">
                                        <i class="fas fa-upload me-2"></i>Upload Video
                                    </button>
                                    <div id="videoPreview" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Content Modal -->
            <div class="modal fade" id="addContentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Content</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="contentTitle" class="form-control mb-2" placeholder="Title">
                            <select id="contentType" class="form-control mb-2">
                                <option value="Article">Article</option>
                                <option value="Video">Video</option>
                                <option value="Document">Document</option>
                            </select>
                            <textarea id="contentBody" class="form-control mb-2" placeholder="Content"></textarea>
                            <input type="file" id="contentFile" class="form-control mb-2">
                            <select id="contentStatus" class="form-control">
                                <option value="Draft">Draft</option>
                                <option value="Published">Published</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveContent()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Admission Modal -->
            <div class="modal fade" id="bulkAdmissionModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Import Admissions (CSV/Excel/PDF/Word)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="admissionsFile" class="form-control" accept=".csv,.xlsx,.pdf,.doc,.docx">
                            <div id="admissionsPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkAdmissions()">Import</button>
                            <button type="button" class="btn btn-secondary" onclick="clearBulkAdmissionNotification()">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Staff Import Modal -->
            <div class="modal fade" id="bulkStaffModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Import Staff (CSV/Excel/PDF/Word)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="staffFile" class="form-control" accept=".csv,.xlsx,.pdf,.doc,.docx">
                            <div id="staffPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkStaff()">Import</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Staff Modal -->
            <div class="modal fade" id="addStaffModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="staffModalTitle">Add Staff</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="staffName" class="form-control mb-2" placeholder="Full Name">
                            <select id="staffRole" class="form-control mb-2">
                                <option value="Teacher">Teacher</option>
                                <option value="Admin">Admin</option>
                                <option value="Support">Support</option>
                            </select>
                            <input type="text" id="staffDepartment" class="form-control mb-2" placeholder="Department">
                            <input type="number" id="staffSalary" class="form-control mb-2" placeholder="Salary (R)">
                            <input type="text" id="staffTax" class="form-control mb-2" placeholder="Tax Number">
                            <input type="text" id="staffUif" class="form-control mb-2" placeholder="UIF Number">
                            <input type="date" id="staffCertExpiry" class="form-control mb-2" placeholder="Cert Expiry">
                            <input type="text" id="staffUsername" class="form-control mb-2" placeholder="Staff Username">
                            <input type="password" id="staffPassword" class="form-control mb-2" placeholder="Staff Password">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveStaff()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Leave Modal -->
            <div class="modal fade" id="addLeaveModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Leave Request</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="leaveStaff" class="form-control mb-2"></select>
                            <select id="leaveType" class="form-control mb-2">
                                <option value="Annual">Annual</option>
                                <option value="Sick">Sick</option>
                                <option value="Maternity">Maternity</option>
                            </select>
                            <input type="date" id="leaveDate" class="form-control mb-2">
                            <input type="number" id="leaveDays" class="form-control mb-2" placeholder="Days">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveLeave()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Review Modal -->
            <div class="modal fade" id="addReviewModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Performance Review</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="reviewStaff" class="form-control mb-2"></select>
                            <input type="date" id="reviewDate" class="form-control mb-2">
                            <input type="number" id="reviewScore" class="form-control mb-2" placeholder="Score (0-100)" min="0" max="100">
                            <textarea id="reviewComments" class="form-control mb-2" placeholder="Comments"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveReview()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Job Modal -->
            <div class="modal fade" id="addJobModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="jobModalTitle">Add Job</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="jobTitle" class="form-control mb-2" placeholder="Job Title">
                            <input type="text" id="jobDepartment" class="form-control mb-2" placeholder="Department">
                            <textarea id="jobDescription" class="form-control mb-2" placeholder="Description"></textarea>
                            <select id="jobStatus" class="form-control">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveJob()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Apply Job Modal -->
            <div class="modal fade" id="applyJobModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Apply for Job</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="applyJobSelect" class="form-control mb-2"></select>
                            <input type="text" id="applicantName" class="form-control mb-2" placeholder="Name">
                            <input type="email" id="applicantEmail" class="form-control mb-2" placeholder="Email">
                            <input type="tel" id="applicantPhone" class="form-control mb-2" placeholder="Phone">
                            <textarea id="applicantCoverLetter" class="form-control mb-2" placeholder="Cover Letter"></textarea>
                            <input type="file" id="applicantResume" class="form-control">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="submitApplication()">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Schedule Interview Modal -->
            <div class="modal fade" id="scheduleInterviewModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Schedule Interview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="interviewApplicant" class="form-control mb-2" readonly>
                            <input type="datetime-local" id="interviewDateTime" class="form-control mb-2">
                            <select id="interviewType" class="form-control mb-2">
                                <option value="In-person">In-person</option>
                                <option value="Video">Video</option>
                            </select>
                            <textarea id="interviewNotes" class="form-control" placeholder="Notes"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveInterview()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Lesson Plan Modal -->
            <div class="modal fade" id="addLessonPlanModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Lesson Plan</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="lessonTitle" class="form-control mb-2" placeholder="Title">
                            <select id="lessonSubject" class="form-control mb-2">
                                <option value="">Select Subject</option>
                                <option value="Math">Math</option>
                                <option value="Science">Science</option>
                                <option value="English">English</option>
                            </select>
                            <input type="date" id="lessonDate" class="form-control mb-2">
                            <textarea id="lessonObjectives" class="form-control mb-2" placeholder="Objectives"></textarea>
                            <textarea id="lessonActivities" class="form-control mb-2" placeholder="Activities"></textarea>
                            <textarea id="lessonMaterials" class="form-control mb-2" placeholder="Materials"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveLessonPlan()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Grade Modal -->
            <div class="modal fade" id="addGradeModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Grade</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="gradeStudent" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="gradeSubject" class="form-control mb-2">
                                <option value="">Select Subject</option>
                                <option value="Math">Math</option>
                                <option value="Science">Science</option>
                                <option value="English">English</option>
                            </select>
                            <input type="number" id="gradeScore" class="form-control mb-2" placeholder="Score" min="0" max="100">
                            <textarea id="gradeComments" class="form-control" placeholder="Comments"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveGrade()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Resource Modal -->
            <div class="modal fade" id="addResourceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Resource</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="resourceTitle" class="form-control mb-2" placeholder="Title">
                            <input type="text" id="resourceUrl" class="form-control mb-2" placeholder="URL">
                            <select id="resourceType" class="form-control mb-2">
                                <option value="Document">Document</option>
                                <option value="Video">Video</option>
                                <option value="Link">Link</option>
                            </select>
                            <textarea id="resourceDescription" class="form-control" placeholder="Description"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveResource()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Calendar Event Modal -->
            <div class="modal fade" id="addCalendarEventModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Calendar Event</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="eventTitle" class="form-control mb-2" placeholder="Event Title">
                            <input type="date" id="eventDate" class="form-control mb-2">
                            <input type="time" id="eventTime" class="form-control mb-2">
                            <select id="eventType" class="form-control mb-2">
                                <option value="Class">Class</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Exam">Exam</option>
                                <option value="Event">Event</option>
                                <option value="Deadline">Deadline</option>
                            </select>
                            <textarea id="eventDescription" class="form-control mb-2" rows="3" placeholder="Event Description"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveCalendarEvent()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Notifications Modal -->
            <div class="modal fade" id="notificationsModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Notifications</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="notificationContent"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Wellness Program Modal -->
            <div class="modal fade" id="addWellnessProgramModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Wellness Program</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Program Name</label>
                                <input type="text" id="wellnessProgramName" class="form-control" placeholder="e.g., Yoga & Meditation">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select id="wellnessProgramCategory" class="form-control">
                                    <option value="Physical Fitness">Physical Fitness</option>
                                    <option value="Mental Health">Mental Health</option>
                                    <option value="Nutrition">Nutrition</option>
                                    <option value="Stress Management">Stress Management</option>
                                    <option value="Work-Life Balance">Work-Life Balance</option>
                                    <option value="General Wellness">General Wellness</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea id="wellnessProgramDescription" class="form-control" rows="3" placeholder="Describe the wellness program..."></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" id="wellnessProgramStartDate" class="form-control">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Duration (weeks)</label>
                                    <input type="number" id="wellnessProgramDuration" class="form-control" min="1" value="4" placeholder="e.g., 4">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target Participants</label>
                                <select id="wellnessProgramTarget" class="form-control">
                                    <option value="All Staff">All Staff</option>
                                    <option value="Teachers">Teachers Only</option>
                                    <option value="Admin Staff">Admin Staff Only</option>
                                    <option value="Support Staff">Support Staff Only</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Participants</label>
                                <input type="number" id="wellnessProgramMaxParticipants" class="form-control" min="1" value="20" placeholder="e.g., 20">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Facilitator</label>
                                <input type="text" id="wellnessProgramFacilitator" class="form-control" placeholder="e.g., Dr. Smith">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select id="wellnessProgramStatus" class="form-control">
                                    <option value="Active">Active</option>
                                    <option value="Upcoming">Upcoming</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveWellnessProgram()">
                                <i class="fas fa-save me-2"></i>Save Program
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Wellness Resource Modal -->
            <div class="modal fade" id="addWellnessResourceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Wellness Resource</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Resource Title</label>
                                <input type="text" id="wellnessResourceTitle" class="form-control" placeholder="e.g., Stress Management Guide">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Type</label>
                                <select id="wellnessResourceType" class="form-control">
                                    <option value="Article">Article</option>
                                    <option value="Video">Video</option>
                                    <option value="Guide">Guide</option>
                                    <option value="Workshop">Workshop</option>
                                    <option value="External Link">External Link</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select id="wellnessResourceCategory" class="form-control">
                                    <option value="Mental Health">Mental Health</option>
                                    <option value="Physical Fitness">Physical Fitness</option>
                                    <option value="Nutrition">Nutrition</option>
                                    <option value="Stress Management">Stress Management</option>
                                    <option value="General Wellness">General Wellness</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">URL/Link</label>
                                <input type="url" id="wellnessResourceUrl" class="form-control" placeholder="https://...">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea id="wellnessResourceDescription" class="form-control" rows="3" placeholder="Describe the resource..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveWellnessResource()">
                                <i class="fas fa-save me-2"></i>Save Resource
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Send Message to Teacher Modal (Student) -->
            <div class="modal fade" id="sendTeacherMessageModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Send Message to Teacher</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Select Teacher</label>
                                <select id="teacherRecipient" class="form-control">
                                    <option value="">-- Select Teacher --</option>
                                    <option value="Mr. Smith">Mr. Smith (Mathematics)</option>
                                    <option value="Mrs. Johnson">Mrs. Johnson (English)</option>
                                    <option value="Dr. Brown">Dr. Brown (Science)</option>
                                    <option value="Ms. Davis">Ms. Davis (History)</option>
                                    <option value="Mr. Wilson">Mr. Wilson (Geography)</option>
                                    <option value="Coach Taylor">Coach Taylor (Physical Education)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                <input type="text" id="messageSubject" class="form-control" placeholder="e.g., Question about Homework">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Message</label>
                                <textarea id="messageBody" class="form-control" rows="5" placeholder="Type your message here..."></textarea>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="markImportant">
                                    <label class="form-check-label" for="markImportant">
                                        Mark as Important
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="sendTeacherMessage()">
                                <i class="fas fa-paper-plane me-2"></i>Send Message
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Event Modal -->
        <div class="modal fade" id="addEventModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add School Event</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="eventName" class="form-control mb-2" placeholder="Event Name *" required>
                        <select id="eventType" class="form-control mb-2">
                            <option value="">Select Event Type *</option>
                            <option value="excursion">Excursion</option>
                            <option value="fundraising">Fundraising</option>
                            <option value="sports">Sports Day</option>
                            <option value="cultural">Cultural Event</option>
                            <option value="academic">Academic Event</option>
                            <option value="meeting">Parent-Teacher Meeting</option>
                            <option value="ceremony">Ceremony</option>
                            <option value="other">Other</option>
                        </select>
                        <input type="date" id="eventDate" class="form-control mb-2" placeholder="Event Date *" required>
                        <input type="time" id="eventTime" class="form-control mb-2" placeholder="Event Time *" required>
                        <input type="text" id="eventLocation" class="form-control mb-2" placeholder="Location *" required>
                        <textarea id="eventDescription" class="form-control mb-2" rows="3" placeholder="Event Description"></textarea>
                        <select id="eventParticipants" class="form-control mb-2">
                            <option value="all">All Students & Staff</option>
                            <option value="students">Students Only</option>
                            <option value="staff">Staff Only</option>
                            <option value="parents">Parents Only</option>
                            <option value="specific">Specific Grades</option>
                        </select>
                        <div id="specificGradesContainer" class="d-none mb-2">
                            <input type="text" id="eventSpecificGrades" class="form-control" placeholder="Enter grades (e.g., Grade 8, Grade 9)">
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" id="eventSendNotification" class="form-check-input" checked>
                            <label class="form-check-label" for="eventSendNotification">
                                Send automatic notifications to parents and teachers
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="addEvent()">
                            <i class="fas fa-plus me-2"></i>Add Event
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Excursion Modal -->
        <div class="modal fade" id="addExcursionModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Excursion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="excursionName" class="form-control mb-2" placeholder="Excursion Name *" required>
                        <input type="date" id="excursionDate" class="form-control mb-2" placeholder="Date *" required>
                        <input type="time" id="excursionTime" class="form-control mb-2" placeholder="Departure Time *" required>
                        <input type="text" id="excursionDestination" class="form-control mb-2" placeholder="Destination *" required>
                        <input type="number" id="excursionCost" class="form-control mb-2" placeholder="Cost per Student (R)" min="0">
                        <textarea id="excursionDescription" class="form-control mb-2" rows="3" placeholder="Description and requirements"></textarea>
                        <input type="text" id="excursionGrades" class="form-control mb-2" placeholder="Grades participating (e.g., Grade 8, Grade 9)">
                        <input type="date" id="excursionDeadline" class="form-control mb-2" placeholder="Permission slip deadline">
                        <div class="form-check mb-2">
                            <input type="checkbox" id="excursionSendNotification" class="form-check-input" checked>
                            <label class="form-check-label" for="excursionSendNotification">
                                Send automatic notifications to parents and teachers
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="addExcursion()">
                            <i class="fas fa-bus me-2"></i>Add Excursion
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Fundraising Modal -->
        <div class="modal fade" id="addFundraisingModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Fundraising Event</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="fundraisingName" class="form-control mb-2" placeholder="Event Name *" required>
                        <input type="date" id="fundraisingDate" class="form-control mb-2" placeholder="Date *" required>
                        <input type="time" id="fundraisingTime" class="form-control mb-2" placeholder="Time *" required>
                        <input type="text" id="fundraisingLocation" class="form-control mb-2" placeholder="Location *" required>
                        <input type="number" id="fundraisingGoal" class="form-control mb-2" placeholder="Fundraising Goal (R)" min="0">
                        <textarea id="fundraisingDescription" class="form-control mb-2" rows="3" placeholder="Description and purpose"></textarea>
                        <input type="text" id="fundraisingContact" class="form-control mb-2" placeholder="Contact Person">
                        <div class="form-check mb-2">
                            <input type="checkbox" id="fundraisingSendNotification" class="form-check-input" checked>
                            <label class="form-check-label" for="fundraisingSendNotification">
                                Send automatic notifications to parents and teachers
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="addFundraising()">
                            <i class="fas fa-hand-holding-usd me-2"></i>Add Fundraising
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Request Meeting Modal -->
        <div class="modal fade" id="requestMeetingModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Request Meeting with Teacher</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <select id="meetingTeacher" class="form-control mb-2">
                            <option value="">Select Teacher *</option>
                        </select>
                        <select id="meetingType" class="form-control mb-2">
                            <option value="">Meeting Type *</option>
                            <option value="virtual">Virtual Meeting</option>
                            <option value="in-person">In-Person Meeting</option>
                        </select>
                        <input type="date" id="meetingDate" class="form-control mb-2" placeholder="Preferred Date *" required>
                        <input type="time" id="meetingTime" class="form-control mb-2" placeholder="Preferred Time *" required>
                        <textarea id="meetingReason" class="form-control mb-2" rows="3" placeholder="Reason for meeting *" required></textarea>
                        <input type="text" id="meetingContact" class="form-control mb-2" placeholder="Your Contact Number">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitMeetingRequest()">
                            <i class="fas fa-calendar-plus me-2"></i>Request Meeting
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Incident Report Modal (Admin Only) -->
        <div class="modal fade" id="addIncidentModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Incident Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <select id="incidentStudent" class="form-control mb-2">
                            <option value="">Select Student *</option>
                        </select>
                        <select id="incidentType" class="form-control mb-2">
                            <option value="">Incident Type *</option>
                            <option value="behavioral">Behavioral</option>
                            <option value="academic">Academic</option>
                            <option value="medical">Medical</option>
                            <option value="disciplinary">Disciplinary</option>
                            <option value="positive">Positive Recognition</option>
                        </select>
                        <select id="incidentSeverity" class="form-control mb-2">
                            <option value="">Severity *</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                        <input type="date" id="incidentDate" class="form-control mb-2" value="" required>
                        <textarea id="incidentDescription" class="form-control mb-2" rows="3" placeholder="Incident Description *" required></textarea>
                        <textarea id="incidentAction" class="form-control mb-2" rows="2" placeholder="Action Taken"></textarea>
                        <input type="text" id="incidentReporter" class="form-control mb-2" placeholder="Reported By" value="">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="addIncidentReport()">
                            <i class="fas fa-plus me-2"></i>Add Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========================================
        // APPLICATION CONFIGURATION
        // ========================================
        
        // Role-based access control configuration
        const ACCESS_CONTROL_CONFIG = {
            // Sections restricted from student access
            studentRestrictedSections: ['students', 'attendance', 'fees', 'admission', 'hr', 'dashboard', 'reports', 'settings', 'eventsManagement'],
            // Default redirect section for students when accessing restricted areas
            studentDefaultSection: 'studentTimetable'
        };
        
        // Check browser compatibility for media features
        function checkBrowserCompatibility() {
            const features = {
                mediaDevices: !!navigator.mediaDevices,
                getUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                mediaRecorder: typeof MediaRecorder !== 'undefined',
                rtc: !!(window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection)
            };
            
            if (!features.getUserMedia) {
                console.warn(' getUserMedia not supported - Voice/video features may not work');
                return false;
            }
            
            if (!features.mediaRecorder) {
                console.warn(' MediaRecorder not supported - Voice notes may not work');
            }
            
            if (!features.rtc) {
                console.warn(' WebRTC not supported - Peer-to-peer calls may not work');
            }
            
            return true;
        }
        
        // Validate user is logged in before accessing communication features
        function validateUserLogin(featureName) {
            if (!currentUser) {
                addNotification(`Please log in to ${featureName}`, 'warning');
                return false;
            }
            return true;
        }
        
        // Check if media device support is available
        function checkMediaDeviceSupport(requireRecorder = false) {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                addNotification('Your browser does not support media features. Please use a modern browser like Chrome, Firefox, or Edge.', 'error');
                return false;
            }
            
            if (requireRecorder && typeof MediaRecorder === 'undefined') {
                addNotification('Your browser does not support voice recording. Please use Chrome or Firefox.', 'error');
                return false;
            }
            
            return true;
        }
        
        // ========================================
        // BACKEND/CLOUD CONNECTIVITY CHECKER
        // ========================================
        
        // Configuration constants
        const CONNECTION_CHECK_TIMEOUT = 5000; // 5 seconds timeout for async checks
        
        // Check all backend/cloud connections
        async function checkAllConnections() {
            console.log(' Checking all backend/cloud connections...');
            
            // Check Local Storage
            checkLocalStorage();
            
            // Check Internet
            checkInternetConnection();
            
            
            
            // Check Video Server
            await checkVideoServerConnection();
        }
        
        // Check Local Storage availability
        function checkLocalStorage() {
            const statusEl = document.getElementById('localStorageStatus');
            if (!statusEl) return;
            
            try {
                const testKey = '_test_storage_';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                
                statusEl.className = 'badge bg-success';
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Available';
                console.log(' Local Storage: Available');
            } catch (e) {
                statusEl.className = 'badge bg-danger';
                statusEl.innerHTML = '<i class="fas fa-times-circle"></i> Unavailable';
                console.error(' Local Storage: Unavailable', e);
            }
        }
        
        // Check Internet connectivity
        function checkInternetConnection() {
            const statusEl = document.getElementById('internetStatus');
            if (!statusEl) return;
            
            if (navigator.onLine) {
                statusEl.className = 'badge bg-success';
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                console.log(' Internet: Connected');
            } else {
                statusEl.className = 'badge bg-danger';
                statusEl.innerHTML = '<i class="fas fa-times-circle"></i> Offline';
                console.log(' Internet: Offline');
            }
        }
        
        // Check Video Server (WebSocket signaling server) connection
        async function checkVideoServerConnection() {
            const statusEl = document.getElementById('videoServerStatus');
            if (!statusEl) return;
            
            try {
                const SIGNALING_SERVER = "wss://commhub-signaling-production.up.railway.app";
                
                // Check if Socket.IO is loaded
                if (typeof io === 'undefined') {
                    statusEl.className = 'badge bg-warning';
                    statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> SDK Not Loaded';
                    console.log(' Video Server: Socket.IO not loaded');
                    return;
                }
                
                // Check if CommHub socket is already connected
                if (commhubSocket && commhubSocket.connected) {
                    statusEl.className = 'badge bg-success';
                    statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected (Active)';
                    console.log(' Video Server: Already connected');
                    return;
                }
                
                // Create a test socket connection with timeout
                const testSocket = io(SIGNALING_SERVER, {
                    transports: ['websocket', 'polling'],
                    timeout: CONNECTION_CHECK_TIMEOUT,
                    reconnection: false,
                    autoConnect: true
                });
                
                // Set timeout
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => {
                        testSocket.close();
                        reject(new Error('Connection timeout'));
                    }, CONNECTION_CHECK_TIMEOUT)
                );
                
                // Connection promise
                const connectionPromise = new Promise((resolve, reject) => {
                    testSocket.on('connect', () => {
                        testSocket.close();
                        resolve(true);
                    });
                    
                    testSocket.on('connect_error', (error) => {
                        testSocket.close();
                        reject(error);
                    });
                });
                
                await Promise.race([connectionPromise, timeoutPromise]);
                
                statusEl.className = 'badge bg-success';
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                console.log(' Video Server: Connected');
            } catch (error) {
                statusEl.className = 'badge bg-danger';
                statusEl.innerHTML = '<i class="fas fa-times-circle"></i> Unavailable';
                console.error(' Video Server: Connection failed', error);
            }
        }
        
        // Update online/offline indicator
        window.addEventListener('online', () => {
            const statusEl = document.getElementById('statusIndicator');
            if (statusEl) {
                statusEl.className = 'badge bg-success shadow';
                statusEl.innerHTML = '<i class="fas fa-wifi me-1"></i>Online';
            }
            checkInternetConnection();
        });
        
        window.addEventListener('offline', () => {
            const statusEl = document.getElementById('statusIndicator');
            if (statusEl) {
                statusEl.className = 'badge bg-danger shadow';
                statusEl.innerHTML = '<i class="fas fa-wifi-slash me-1"></i>Offline';
            }
            checkInternetConnection();
        });
        
        // Run connectivity check on page load
        window.addEventListener('load', () => {
            // Delay check to allow page to fully render
            setTimeout(() => {
                checkAllConnections();
                // Auto-initialize CommHub Pro video server connection
                autoInitializeCommHub();
                }, 1000);
        });
        
        // Auto-initialize CommHub Pro video server on page load
        function autoInitializeCommHub() {
            if (typeof io !== 'undefined' && typeof initCommHubSocket === 'function') {
                try {
                    console.log(' Auto-initializing CommHub Pro video server...');
                    initCommHubSocket();
                } catch (error) {
                    console.log('CommHub Pro auto-init skipped:', error.message);
                }
            }
        }
        
        // Global variables
        var currentUser = null;
        var editingJob = null;
        var editingStaffId = null;
        var editingReviewId = null;
        var students = [];
        var admissions = [];
        var fees = [];
        var timetable = {};
        var exams = [];
        var staff = [];
        var payrolls = [];
        var leaveRequests = [];
        var performanceReviews = [];
        var jobs = [];
        var auditLog = [];
        var contents = [];
        var messages = [];
        var announcements = [];
        var users = [];
        var hrSettings = { annualLeaveDays: 21, uifRate: 0.01 };
        
        // Utility function to escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Modal helper functions with fallback for when Bootstrap JS is not loaded
        function showModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (!modalElement) {
                console.error('Modal not found: ' + modalId);
                return;
            }
            
            // Try Bootstrap Modal first
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                try {
                    // Use getOrCreateInstance to reuse existing modal instance or create new one
                    const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                    modal.show();
                    return;
                } catch (e) {
                    console.warn('Bootstrap Modal failed, using fallback:', e);
                }
            }
            
            // Fallback: Show modal using CSS classes
            modalElement.classList.add('show');
            modalElement.style.display = 'block';
            modalElement.setAttribute('aria-modal', 'true');
            modalElement.setAttribute('role', 'dialog');
            modalElement.removeAttribute('aria-hidden');
            
            // Add backdrop with unique identifier
            let backdrop = document.querySelector('.modal-backdrop[data-modal-id="' + modalId + '"]');
            if (!backdrop) {
                backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.setAttribute('data-modal-id', modalId);
                document.body.appendChild(backdrop);
            }
            
            // Add modal-open class to body
            document.body.classList.add('modal-open');
            document.body.style.overflow = 'hidden';
            document.body.style.paddingRight = '0px';
            
            // Setup close handlers using addEventListener to preserve existing handlers
            const closeButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"], .btn-close');
            closeButtons.forEach(function(btn) {
                // Remove any previously added fallback listener to avoid duplicates
                if (btn._fallbackCloseHandler) {
                    btn.removeEventListener('click', btn._fallbackCloseHandler);
                }
                btn._fallbackCloseHandler = function() { hideModal(modalId); };
                btn.addEventListener('click', btn._fallbackCloseHandler);
            });
            
            // Close on backdrop click using addEventListener
            if (modalElement._fallbackBackdropHandler) {
                modalElement.removeEventListener('click', modalElement._fallbackBackdropHandler);
            }
            modalElement._fallbackBackdropHandler = function(e) {
                if (e.target === modalElement) {
                    hideModal(modalId);
                }
            };
            modalElement.addEventListener('click', modalElement._fallbackBackdropHandler);
        }
        
        function hideModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (!modalElement) return;
            
            // Try Bootstrap Modal first
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                try {
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                        return;
                    }
                } catch (e) {
                    console.warn('Bootstrap Modal hide failed, using fallback:', e);
                }
            }
            
            // Fallback: Hide modal using CSS classes
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
            modalElement.setAttribute('aria-hidden', 'true');
            modalElement.removeAttribute('aria-modal');
            modalElement.removeAttribute('role');
            
            // Remove backdrop for this specific modal
            const backdrop = document.querySelector('.modal-backdrop[data-modal-id="' + modalId + '"]');
            if (backdrop) {
                backdrop.remove();
            }
            
            // Only remove modal-open class and clean up backdrops if no other modals are open
            const openModals = document.querySelectorAll('.modal.show');
            if (openModals.length === 0) {
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                // Clean up any remaining backdrops only when no modals are open
                // This handles orphaned Bootstrap backdrops that weren't properly cleaned up
                setTimeout(function() {
                    const remainingOpenModals = document.querySelectorAll('.modal.show');
                    if (remainingOpenModals.length === 0) {
                        document.querySelectorAll('.modal-backdrop').forEach(function(bd) {
                            bd.remove();
                        });
                    }
                }, 150); // Small delay to allow Bootstrap transition to complete
            }
        }
        
        // Safe modal hide helper function
        function safeHideModal(modalId) {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                try {
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById(modalId));
                    if (modalInstance) {
                        modalInstance.hide();
                        return;
                    }
                } catch (e) {
                    console.warn('Bootstrap Modal hide failed:', e);
                }
            }
            hideModal(modalId);
        }
        
        var smsSettings = { username: '', password: '', senderId: 'BophelongSchool' };
        var chatGPTSettings = { apiKey: '', model: 'gpt-4', enabled: false };
        var grokSettings = { apiKey: '', model: 'grok-beta', enabled: false };
        var attendanceRecords = {};
        var lessonPlans = [];
        var grades = [];
        var resources = [];
        var uploadedWork = [];
        var calendarEvents = [];
        var dashboardChart = null;
        var leaveChart = null;
        var performanceChart = null;
        var progressChart = null;
        var dataVault = [];
        var teacherChats = [];
        var adminMessages = [];
                                    let posterCanvas;
                                    let posterActiveObject = null;
                                    let posterInitialized = false;
                                    
                                    // Initialize poster creator when tab is shown
                                    function initPosterCreator() {
                                        if (posterInitialized) return;
                                        posterInitialized = true;
                                        
                                        posterCanvas = new fabric.Canvas('poster-canvas', { 
                                            preserveObjectStacking: true,
                                            backgroundColor: '#f8f9fa'
                                        });
                                        
                                        // Update right panel when selection changes
                                        posterCanvas.on('selection:created', updatePosterUI);
                                        posterCanvas.on('selection:updated', updatePosterUI);
                                        posterCanvas.on('selection:cleared', () => { 
                                            document.getElementById('poster-props').style.display='none'; 
                                            updatePosterLayers(); 
                                        });
                                        posterCanvas.on('object:modified', updatePosterLayers);
                                        posterCanvas.on('object:added', updatePosterLayers);
                                        posterCanvas.on('object:removed', updatePosterLayers);
                                        
                                        // Initial welcome text
                                        addPosterText('YOUR POSTER\nHERE');
                                        updatePosterLayers();
                                    }
                                    
                                    // Listen for tab shown event
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const posterTab = document.querySelector('a[href="#create-poster"]');
                                        if (posterTab) {
                                            posterTab.addEventListener('shown.bs.tab', function() {
                                                setTimeout(initPosterCreator, 100);
                                            });
                                        }
                                    });
                                    
                                    function updatePosterUI(e) {
                                        posterActiveObject = posterCanvas.getActiveObject();
                                        if (!posterActiveObject) return;
                                        document.getElementById('poster-props').style.display = 'block';
                                        if (posterActiveObject.type.includes('text') || posterActiveObject.type === 'i-text' || posterActiveObject.type === 'textbox') {
                                            document.getElementById('posterFontFamily').value = posterActiveObject.fontFamily || 'Montserrat';
                                            document.getElementById('posterFontSize').value = posterActiveObject.fontSize || 60;
                                            document.getElementById('posterFill').value = rgbToPosterHex(posterActiveObject.fill);
                                        } else {
                                            document.getElementById('posterFill').value = rgbToPosterHex(posterActiveObject.fill);
                                        }
                                        updatePosterLayers();
                                    }
                                        
                                        function setPosterProp(prop, value) {
                                            if (!posterActiveObject) return;
                                            if (prop === 'fontSize') value = parseInt(value);
                                            posterActiveObject.set(prop, value);
                                            posterCanvas.renderAll();
                                            updatePosterLayers();
                                        }
                                        
                                        function togglePosterProp(prop, value) {
                                            if (!posterActiveObject) return;
                                            const current = posterActiveObject.get(prop);
                                            posterActiveObject.set(prop, current === value ? '' : value);
                                            posterCanvas.renderAll();
                                            updatePosterLayers();
                                        }
                                        
                                        function addPosterText(text = 'YOUR EVENT\nHERE', size = 100) {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            const textbox = new fabric.Textbox(text, {
                                                left: 100, 
                                                top: 100, 
                                                width: 600,
                                                fontSize: size,
                                                fontFamily: 'Bebas Neue',
                                                fill: '#212529',
                                                textAlign: 'center',
                                                fontWeight: 'bold',
                                                shadow: 'rgba(0,0,0,0.3) 5px 5px 15px',
                                                editable: true
                                            });
                                            posterCanvas.add(textbox);
                                            posterCanvas.setActiveObject(textbox);
                                            posterCanvas.renderAll();
                                            updatePosterLayers();
                                        }
                                        
                                        function addPosterShape(type) {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            let shape;
                                            if (type==='rect') shape = new fabric.Rect({width:300, height:200, fill:'#ff5722', rx:20});
                                            if (type==='circle') shape = new fabric.Circle({radius:150, fill:'#2196f3'});
                                            if (type==='triangle') shape = new fabric.Triangle({width:250, height:220, fill:'#4caf50'});
                                            shape.set({left:200, top:200, shadow:'rgba(0,0,0,0.3) 10px 10px 20px'});
                                            posterCanvas.add(shape);
                                            posterCanvas.setActiveObject(shape);
                                            posterCanvas.renderAll();
                                            updatePosterLayers();
                                        }
                                        
                                        function uploadPosterImage() {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            const input = document.createElement('input');
                                            input.type = 'file';
                                            input.accept = 'image/*';
                                            input.onchange = e => {
                                                const file = e.target.files[0];
                                                if (!file) return;
                                                const reader = new FileReader();
                                                reader.onload = event => fabric.Image.fromURL(event.target.result, img => {
                                                    img.scale(0.5);
                                                    posterCanvas.centerObject(img);
                                                    posterCanvas.add(img);
                                                    posterCanvas.renderAll();
                                                    updatePosterLayers();
                                                });
                                                reader.readAsDataURL(file);
                                            };
                                            input.click();
                                        }
                                        
                                        function unsplashPosterBg() {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            const keyword = prompt('Unsplash keyword (e.g. abstract, nature, party)', 'abstract');
                                            if (!keyword) return;
                                            // Sanitize keyword to prevent URL injection - replace spaces with hyphens
                                            const sanitizedKeyword = encodeURIComponent(keyword.replace(/[^\w-]/g, '').replace(/\s+/g, '-'));
                                            const url = `https://source.unsplash.com/random/${posterCanvas.width}x${posterCanvas.height}/?${sanitizedKeyword}`;
                                            addNotification('Loading background image...', 'info');
                                            fabric.Image.fromURL(url, img => {
                                                posterCanvas.setBackgroundImage(img, posterCanvas.renderAll.bind(posterCanvas), { 
                                                    scaleX: posterCanvas.width / img.width, 
                                                    scaleY: posterCanvas.height / img.height 
                                                });
                                                addNotification('Background loaded successfully!', 'success');
                                            }, { crossOrigin: 'anonymous' });
                                        }
                                        
                                        function setPosterBgColor(c) { 
                                            if (!posterCanvas) return;
                                            posterCanvas.backgroundColor = c; 
                                            posterCanvas.renderAll(); 
                                        }
                                        
                                        function downloadPoster() {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            try {
                                                const link = document.createElement('a');
                                                link.download = 'my-poster-' + Date.now() + '.png';
                                                link.href = posterCanvas.toDataURL({multiplier: 2}); // 2x resolution for print
                                                link.click();
                                                addNotification('Poster downloaded successfully!', 'success');
                                            } catch (error) {
                                                addNotification('Error downloading poster: ' + error.message, 'error');
                                            }
                                        }
                                        
                                        // Simple templates
                                        function loadPosterTemplate(type) {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            posterCanvas.clear();
                                            posterCanvas.backgroundColor = '#ffffff';
                                            
                                            if (type==='event') {
                                                // Load event template
                                                const keyword = 'concert';
                                                const sanitizedKeyword = encodeURIComponent(keyword);
                                                const url = `https://source.unsplash.com/random/${posterCanvas.width}x${posterCanvas.height}/?${sanitizedKeyword}`;
                                                fabric.Image.fromURL(url, img => {
                                                    posterCanvas.setBackgroundImage(img, posterCanvas.renderAll.bind(posterCanvas), { 
                                                        scaleX: posterCanvas.width / img.width, 
                                                        scaleY: posterCanvas.height / img.height 
                                                    });
                                                    setTimeout(() => {
                                                        addPosterText('LIVE\nCONCERT',120);
                                                        setTimeout(() => {
                                                            const subtext = new fabric.Textbox('Friday 25 Dec\nDoors open 19:00', {
                                                                left: 100, top: 400, width: 600,
                                                                fontSize: 60,
                                                                fontFamily: 'Montserrat',
                                                                fill: '#ffffff',
                                                                textAlign: 'center',
                                                                shadow: 'rgba(0,0,0,0.5) 3px 3px 10px'
                                                            });
                                                            posterCanvas.add(subtext);
                                                            posterCanvas.renderAll();
                                                            updatePosterLayers();
                                                        }, 100);
                                                    }, 200);
                                                }, { crossOrigin: 'anonymous' });
                                            }
                                            else if (type==='sale') {
                                                posterCanvas.backgroundColor = '#ff1744';
                                                posterCanvas.renderAll();
                                                setTimeout(() => {
                                                    const mainText = new fabric.Textbox('MEGA\nSALE', {
                                                        left: 100, top: 300, width: 600,
                                                        fontSize: 150,
                                                        fontFamily: 'Bebas Neue',
                                                        fill: '#ffffff',
                                                        textAlign: 'center',
                                                        fontWeight: 'bold',
                                                        shadow: 'rgba(0,0,0,0.5) 5px 5px 20px'
                                                    });
                                                    posterCanvas.add(mainText);
                                                    
                                                    const subText = new fabric.Textbox('50% OFF', {
                                                        left: 150, top: 650, width: 500,
                                                        fontSize: 100,
                                                        fontFamily: 'Bebas Neue',
                                                        fill: '#ffeb3b',
                                                        textAlign: 'center',
                                                        fontWeight: 'bold',
                                                        shadow: 'rgba(0,0,0,0.5) 5px 5px 20px'
                                                    });
                                                    posterCanvas.add(subText);
                                                    posterCanvas.renderAll();
                                                    updatePosterLayers();
                                                }, 100);
                                            }
                                            else if (type==='motivation') {
                                                const keyword = 'mountain';
                                                const sanitizedKeyword = encodeURIComponent(keyword);
                                                const url = `https://source.unsplash.com/random/${posterCanvas.width}x${posterCanvas.height}/?${sanitizedKeyword}`;
                                                fabric.Image.fromURL(url, img => {
                                                    posterCanvas.setBackgroundImage(img, posterCanvas.renderAll.bind(posterCanvas), { 
                                                        scaleX: posterCanvas.width / img.width, 
                                                        scaleY: posterCanvas.height / img.height 
                                                    });
                                                    setTimeout(() => {
                                                        const mainText = new fabric.Textbox('DREAM BIG\nWORK HARD', {
                                                            left: 100, top: 400, width: 600,
                                                            fontSize: 120,
                                                            fontFamily: 'Bebas Neue',
                                                            fill: '#ffffff',
                                                            textAlign: 'center',
                                                            fontWeight: 'bold',
                                                            shadow: 'rgba(0,0,0,0.8) 5px 5px 20px'
                                                        });
                                                        posterCanvas.add(mainText);
                                                        posterCanvas.renderAll();
                                                        updatePosterLayers();
                                                    }, 200);
                                                }, { crossOrigin: 'anonymous' });
                                            }
                                            addNotification('Template loaded successfully!', 'success');
                                        }
                                        
                                        // Layers list
                                        function updatePosterLayers() {
                                            if (!posterCanvas) return;
                                            const list = document.getElementById('poster-layers');
                                            if (!list) return;
                                            list.innerHTML = '';
                                            const objects = posterCanvas.getObjects();
                                            if (objects.length === 0) {
                                                list.innerHTML = '<li style="text-align:center;color:#999;">No layers yet</li>';
                                                return;
                                            }
                                            objects.slice().reverse().forEach((obj, index) => {
                                                const li = document.createElement('li');
                                                let layerName = '';
                                                if (obj.type === 'textbox' || obj.type === 'i-text' || obj.type === 'text') {
                                                    layerName = obj.text ? obj.text.slice(0,20) + (obj.text.length > 20 ? '...' : '') : 'Text';
                                                } else if (obj.type === 'image') {
                                                    layerName = 'Image';
                                                } else {
                                                    layerName = obj.type.charAt(0).toUpperCase() + obj.type.slice(1);
                                                }
                                                
                                                const icon = obj.type === 'textbox' || obj.type === 'i-text' || obj.type === 'text' ? '' : 
                                                           obj.type === 'image' ? '' : 
                                                           obj.type === 'rect' ? '' : 
                                                           obj.type === 'circle' ? '' : 
                                                           obj.type === 'triangle' ? '' : '';
                                                
                                                li.innerHTML = `<span>${icon} ${layerName}</span><span style="font-size:11px;opacity:0.7;">Layer ${objects.length - index}</span>`;
                                                li.onclick = () => {
                                                    posterCanvas.setActiveObject(obj);
                                                    posterCanvas.renderAll();
                                                };
                                                if (posterCanvas.getActiveObject() === obj) li.classList.add('active');
                                                list.appendChild(li);
                                            });
                                        }
                                        
                                        function deletePosterActive() {
                                            if (!posterCanvas) return;
                                            const activeObj = posterCanvas.getActiveObject();
                                            if (activeObj) {
                                                posterCanvas.remove(activeObj);
                                                posterActiveObject = null;
                                                posterCanvas.renderAll();
                                                updatePosterLayers();
                                                addNotification('Object deleted', 'info');
                                            }
                                        }
                                        
                                        // Save poster to gallery (localStorage)
                                        function savePosterToGallery() {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            try {
                                                const posterData = posterCanvas.toDataURL({multiplier: 1});
                                                let gallery = [];
                                                try {
                                                    gallery = JSON.parse(localStorage.getItem('posterGallery') || '[]');
                                                    if (!Array.isArray(gallery)) gallery = [];
                                                } catch (parseError) {
                                                    // Handle corrupted localStorage data
                                                    gallery = [];
                                                }
                                                const newPoster = {
                                                    id: Date.now(),
                                                    name: prompt('Enter poster name:', 'My Poster ' + (gallery.length + 1)) || 'Untitled Poster',
                                                    image: posterData,
                                                    createdAt: new Date().toISOString()
                                                };
                                                gallery.unshift(newPoster);
                                                // Keep only last 20 posters to avoid localStorage limits
                                                if (gallery.length > 20) gallery.pop();
                                                localStorage.setItem('posterGallery', JSON.stringify(gallery));
                                                addNotification(' Poster saved to gallery successfully!', 'success');
                                            } catch (error) {
                                                addNotification('Error saving poster: ' + error.message, 'error');
                                            }
                                        }
                                        
                                        // Clear poster canvas
                                        function clearPosterCanvas() {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            if (!confirm('Are you sure you want to clear the canvas? All unsaved changes will be lost.')) {
                                                return;
                                            }
                                            posterCanvas.clear();
                                            posterCanvas.backgroundColor = '#ffffff';
                                            posterCanvas.renderAll();
                                            updatePosterLayers();
                                            addNotification('Canvas cleared', 'info');
                                        }
                                        
                                        // Helper to convert rgb to hex for color picker
                                        function rgbToPosterHex(color) {
                                            if (!color) return '#000000';
                                            if (typeof color === 'string' && color.startsWith('rgb')) {
                                                const matches = color.match(/\d+/g);
                                                if (matches && matches.length >= 3) {
                                                    const [r,g,b] = matches;
                                                    return "#" + ((1 << 24) + (parseInt(r) << 16) + (parseInt(g) << 8) + parseInt(b)).toString(16).slice(1);
                                                }
                                            }
                                            return color || '#000000';
                                        }
                                        
                                        // Enhanced poster functions
                                        function handlePosterImageUpload(input) {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            const file = input.files[0];
                                            if (!file) return;
                                            const reader = new FileReader();
                                            reader.onload = function(event) {
                                                fabric.Image.fromURL(event.target.result, function(img) {
                                                    img.scale(0.5);
                                                    posterCanvas.centerObject(img);
                                                    posterCanvas.add(img);
                                                    posterCanvas.setActiveObject(img);
                                                    posterCanvas.renderAll();
                                                    updatePosterLayers();
                                                    addNotification('Image added successfully!', 'success');
                                                });
                                            };
                                            reader.readAsDataURL(file);
                                        }
                                        
                                        function addImageFromUrl() {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            const url = prompt('Enter image URL:', 'https://example.com/image.jpg');
                                            if (!url) return;
                                            addNotification('Loading image...', 'info');
                                            fabric.Image.fromURL(url, function(img) {
                                                if (img) {
                                                    img.scale(0.5);
                                                    posterCanvas.centerObject(img);
                                                    posterCanvas.add(img);
                                                    posterCanvas.setActiveObject(img);
                                                    posterCanvas.renderAll();
                                                    updatePosterLayers();
                                                    addNotification('Image added successfully!', 'success');
                                                } else {
                                                    addNotification('Failed to load image from URL.', 'error');
                                                }
                                            }, { crossOrigin: 'anonymous' });
                                        }
                                        
                                        function setGradientBackground() {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            const gradients = [
                                                { name: 'Sunset', colors: ['#f46b45', '#eea849'] },
                                                { name: 'Ocean', colors: ['#1e3c72', '#2a5298'] },
                                                { name: 'Purple', colors: ['#667eea', '#764ba2'] },
                                                { name: 'Emerald', colors: ['#134e5e', '#71b280'] },
                                                { name: 'Midnight', colors: ['#232526', '#414345'] },
                                                { name: 'Rose', colors: ['#ee9ca7', '#ffdde1'] }
                                            ];
                                            const choice = prompt('Choose gradient:\n1. Sunset\n2. Ocean\n3. Purple\n4. Emerald\n5. Midnight\n6. Rose', '1');
                                            const idx = parseInt(choice) - 1;
                                            if (idx >= 0 && idx < gradients.length) {
                                                const gradient = new fabric.Gradient({
                                                    type: 'linear',
                                                    coords: { x1: 0, y1: 0, x2: posterCanvas.width, y2: posterCanvas.height },
                                                    colorStops: [
                                                        { offset: 0, color: gradients[idx].colors[0] },
                                                        { offset: 1, color: gradients[idx].colors[1] }
                                                    ]
                                                });
                                                // Create a gradient rectangle as background
                                                const bgRect = new fabric.Rect({
                                                    left: 0,
                                                    top: 0,
                                                    width: posterCanvas.width,
                                                    height: posterCanvas.height,
                                                    fill: gradient,
                                                    selectable: false,
                                                    evented: false
                                                });
                                                // Clear existing background and add gradient rect
                                                posterCanvas.backgroundColor = '#ffffff';
                                                posterCanvas.renderAll();
                                                // Insert at the bottom layer
                                                posterCanvas.insertAt(bgRect, 0);
                                                posterCanvas.renderAll();
                                                updatePosterLayers();
                                                addNotification(`${gradients[idx].name} gradient applied!`, 'success');
                                            }
                                        }
                                        
                                        function bringToFront() {
                                            if (!posterCanvas) return;
                                            const activeObj = posterCanvas.getActiveObject();
                                            if (activeObj) {
                                                activeObj.bringToFront();
                                                posterCanvas.renderAll();
                                                updatePosterLayers();
                                                addNotification('Object brought to front', 'info');
                                            }
                                        }
                                        
                                        function sendToBack() {
                                            if (!posterCanvas) return;
                                            const activeObj = posterCanvas.getActiveObject();
                                            if (activeObj) {
                                                activeObj.sendToBack();
                                                posterCanvas.renderAll();
                                                updatePosterLayers();
                                                addNotification('Object sent to back', 'info');
                                            }
                                        }
                                        
                                        function duplicatePosterObject() {
                                            if (!posterCanvas) return;
                                            const activeObj = posterCanvas.getActiveObject();
                                            if (!activeObj) {
                                                addNotification('Please select an object to duplicate', 'warning');
                                                return;
                                            }
                                            activeObj.clone(function(cloned) {
                                                cloned.set({
                                                    left: activeObj.left + 20,
                                                    top: activeObj.top + 20
                                                });
                                                posterCanvas.add(cloned);
                                                posterCanvas.setActiveObject(cloned);
                                                posterCanvas.renderAll();
                                                updatePosterLayers();
                                                addNotification('Object duplicated', 'success');
                                            });
                                        }
                                        
                                        function exportPosterPDF() {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            // Check if jsPDF is available (handle various loading scenarios)
                                            let PDFConstructor = null;
                                            if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                                                PDFConstructor = window.jspdf.jsPDF;
                                            } else if (typeof jsPDF !== 'undefined') {
                                                PDFConstructor = jsPDF;
                                            } else if (typeof window.jsPDF !== 'undefined') {
                                                PDFConstructor = window.jsPDF;
                                            }
                                            
                                            if (!PDFConstructor) {
                                                addNotification('PDF export requires jsPDF library. Using PNG download instead.', 'warning');
                                                downloadPoster();
                                                return;
                                            }
                                            try {
                                                const imgData = posterCanvas.toDataURL({ format: 'png', quality: 1 });
                                                const pdf = new PDFConstructor({
                                                    orientation: posterCanvas.width > posterCanvas.height ? 'landscape' : 'portrait',
                                                    unit: 'px',
                                                    format: [posterCanvas.width, posterCanvas.height]
                                                });
                                                pdf.addImage(imgData, 'PNG', 0, 0, posterCanvas.width, posterCanvas.height);
                                                pdf.save('poster-' + Date.now() + '.pdf');
                                                addNotification('PDF exported successfully!', 'success');
                                            } catch (error) {
                                                addNotification('Error exporting PDF: ' + error.message, 'error');
                                            }
                                        }
                                        
                                        // Enhanced shape with line and star
                                        const originalAddPosterShape = addPosterShape;
                                        addPosterShape = function(type) {
                                            if (!posterCanvas) {
                                                addNotification('Please wait, poster creator is initializing...', 'warning');
                                                return;
                                            }
                                            let shape;
                                            if (type === 'rect') {
                                                shape = new fabric.Rect({ width: 300, height: 200, fill: '#ff5722', rx: 20 });
                                            } else if (type === 'circle') {
                                                shape = new fabric.Circle({ radius: 150, fill: '#2196f3' });
                                            } else if (type === 'triangle') {
                                                shape = new fabric.Triangle({ width: 250, height: 220, fill: '#4caf50' });
                                            } else if (type === 'line') {
                                                shape = new fabric.Line([50, 50, 300, 50], {
                                                    stroke: '#333333',
                                                    strokeWidth: 5
                                                });
                                            } else if (type === 'star') {
                                                // Create a 5-pointed star using polygon
                                                const points = [];
                                                const outerRadius = 100;
                                                const innerRadius = 50;
                                                const numPoints = 5;
                                                for (let i = 0; i < numPoints * 2; i++) {
                                                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                                                    const angle = (i * Math.PI / numPoints) - Math.PI / 2;
                                                    points.push({
                                                        x: radius * Math.cos(angle),
                                                        y: radius * Math.sin(angle)
                                                    });
                                                }
                                                shape = new fabric.Polygon(points, {
                                                    fill: '#ffc107',
                                                    stroke: '#ff9800',
                                                    strokeWidth: 2
                                                });
                                            }
                                            if (shape) {
                                                shape.set({ left: 200, top: 200, shadow: 'rgba(0,0,0,0.3) 10px 10px 20px' });
                                                posterCanvas.add(shape);
                                                posterCanvas.setActiveObject(shape);
                                                posterCanvas.renderAll();
                                                updatePosterLayers();
                                            }
                                        };
                                        
                                        // Keyboard shortcuts for poster canvas
                                        document.addEventListener('keydown', function(e) {
                                            // Only if poster canvas exists and is active
                                            if (!posterCanvas) return;
                                            const activeElement = document.activeElement;
                                            // Don't trigger if user is interacting with form elements or editable content
                                            if (activeElement && (
                                                activeElement.tagName === 'INPUT' || 
                                                activeElement.tagName === 'TEXTAREA' ||
                                                activeElement.tagName === 'SELECT' ||
                                                activeElement.tagName === 'BUTTON' ||
                                                activeElement.isContentEditable
                                            )) return;
                                            
                                            // Delete key
                                            if (e.key === 'Delete' || e.key === 'Backspace') {
                                                const activeObj = posterCanvas.getActiveObject();
                                                if (activeObj) {
                                                    e.preventDefault();
                                                    deletePosterActive();
                                                }
                                            }
                                            // Ctrl/Cmd + D for duplicate
                                            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                                                const activeObj = posterCanvas.getActiveObject();
                                                if (activeObj) {
                                                    e.preventDefault();
                                                    duplicatePosterObject();
                                                }
                                            }
                                        });
                                        
                                        // Make poster canvas responsive
                                        function resizePosterCanvas() {
                                            const wrapper = document.getElementById('poster-canvas-wrapper');
                                            if (!wrapper || !posterCanvas) return;
                                            const wrapperWidth = wrapper.clientWidth - 60;
                                            const wrapperHeight = wrapper.clientHeight - 60;
                                            // Keep aspect ratio but maximize size
                                            const aspectRatio = 900 / 650;
                                            let newWidth = wrapperWidth;
                                            let newHeight = wrapperWidth / aspectRatio;
                                            if (newHeight > wrapperHeight) {
                                                newHeight = wrapperHeight;
                                                newWidth = newHeight * aspectRatio;
                                            }
                                            // Only resize if significantly different
                                            if (Math.abs(posterCanvas.width - newWidth) > 50) {
                                                posterCanvas.setDimensions({ width: Math.max(newWidth, 400), height: Math.max(newHeight, 300) });
                                                posterCanvas.renderAll();
                                            }
                                        }
                                        
                                        // Responsive resize on window resize
                                        window.addEventListener('resize', debounce(resizePosterCanvas, 250));
        var selectedChatStudent = null;
        var isOnline = navigator.onLine;
        var offlineQueue = [];
        var schoolEvents = [];
        var meetingRequests = [];
        var incidentReports = [];
        var wellnessPrograms = [];
        // MX-4051 PDF Data
        var mx4051Data = [
            { class: '1A', accession: '2890', surname: 'CHAUKE', first_name: 'Nobule', educator: 'K MOGANE' },
            { class: '1A', accession: '2598', surname: 'FATLANA', first_name: 'Retumetse', educator: 'K MOGANE' },
            { class: '1A', accession: '2558', surname: 'KENANA', first_name: 'Dumpho', educator: 'K MOGANE' },
            { class: '1A', accession: '2445', surname: 'LUBENA', first_name: 'Manjela Jama', educator: 'K MOGANE' },
            { class: '1A', accession: '2565', surname: 'MABASOE', first_name: 'Victor', educator: 'K MOGANE' },
            { class: '1A', accession: '2370', surname: 'MAHLANGU', first_name: 'Sandile', educator: 'K MOGANE' },
            { class: '1A', accession: '2540', surname: 'MANCHUD', first_name: 'Khumo', educator: 'K MOGANE' },
            { class: '1A', accession: '2557', surname: 'MATHEBULA', first_name: 'Lungo', educator: 'K MOGANE' },
            { class: '1A', accession: '2597', surname: 'MONDLI', first_name: 'Thepo', educator: 'K MOGANE' },
            { class: '1A', accession: '2570', surname: 'NOZINYANA', first_name: 'Philo', educator: 'K MOGANE' },
            { class: '1A', accession: '2573', surname: 'PHLANE', first_name: 'Outshile', educator: 'K MOGANE' },
            { class: '1A', accession: '2496', surname: 'SAKOMA', first_name: 'Amogelang', educator: 'K MOGANE' },
            { class: '1A', accession: '2533', surname: 'SHUMBA', first_name: 'Zobride', educator: 'K MOGANE' },
            { class: '1A', accession: '20128', surname: 'THOBAKGALE', first_name: 'Aleng', educator: 'K MOGANE' },
            // Add more from other classes...
            { class: '1B', accession: '2542', surname: 'KHUMALO', first_name: 'Meliswe', educator: 'F NCUBE' },
            { class: '1B', accession: '2404', surname: 'MAHLANGU', first_name: 'Abigail', educator: 'F NCUBE' },
            { class: '1B', accession: '2546', surname: 'MAKOLA', first_name: 'Ndithulo', educator: 'F NCUBE' },
            { class: '1B', accession: '2559', surname: 'MANABE', first_name: 'Ningibi', educator: 'F NCUBE' },
            { class: '1B', accession: '2524', surname: 'SEHWANG', first_name: 'Gantile', educator: 'F NCUBE' },
            { class: '1B', accession: '2535', surname: 'YU DA', first_name: 'Massego', educator: 'F NCUBE' },
            { class: '1B', accession: '2545', surname: 'YU DA', first_name: 'Kanga', educator: 'F NCUBE' },
            // Continue for all classes...
            // For brevity, adding a few more
            { class: '2A', accession: '2408', surname: 'CHUMA', first_name: 'Jabu', educator: 'MS MOYO' },
            { class: '2A', accession: '2448', surname: 'LEPHAKU', first_name: 'Outshilemo', educator: 'MS MOYO' },
            { class: '3A', accession: '2211', surname: 'HAMZAT', first_name: 'Mercy', educator: 'R CHWAYO' },
            { class: '4A', accession: '2203', surname: 'AGYAPONG', first_name: 'Princess', educator: 'M KESWA' },
            { class: '5A', accession: '2405', surname: 'BOYS', first_name: 'Gcina', educator: 'NN DONDO' },
            { class: '6A', accession: '2012', surname: 'GUMESHE', first_name: 'Rudo', educator: 'NL TSIMA' },
            { class: '7A', accession: '2323', surname: 'BALOYI', first_name: 'Okoposi', educator: 'NP NTLOLE' },
            { class: '8A', accession: '2153', surname: 'BAMDLE', first_name: 'Michelle', educator: 'MC KGANAKGA' },
            { class: '9A', accession: '2435', surname: 'ARIES', first_name: 'Kayla', educator: 'G TSHILOANE' },
            { class: 'RA', accession: '2598', surname: 'DELEKILE', first_name: 'Boloto', educator: 'SB MALEKA' }
        ];
        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        // Load data from localStorage
        function loadData() {
            students = JSON.parse(localStorage.getItem('students') || '[]');
            admissions = JSON.parse(localStorage.getItem('admissions') || '[]');
            fees = JSON.parse(localStorage.getItem('fees') || '[]');
            timetable = JSON.parse(localStorage.getItem('timetable') || '{}');
            exams = JSON.parse(localStorage.getItem('exams') || '[]');
            staff = JSON.parse(localStorage.getItem('staff') || '[]');
            payrolls = JSON.parse(localStorage.getItem('payrolls') || '[]');
            leaveRequests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
            performanceReviews = JSON.parse(localStorage.getItem('performanceReviews') || '[]');
            jobs = JSON.parse(localStorage.getItem('jobs') || '[]');
            auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');
            contents = JSON.parse(localStorage.getItem('contents') || '[]');
            messages = JSON.parse(localStorage.getItem('messages') || '[]');
            announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            users = JSON.parse(localStorage.getItem('users') || '[]');
            hrSettings = JSON.parse(localStorage.getItem('hrSettings') || JSON.stringify(hrSettings));
            smsSettings = JSON.parse(localStorage.getItem('smsSettings') || JSON.stringify(smsSettings));
            chatGPTSettings = JSON.parse(localStorage.getItem('chatGPTSettings') || JSON.stringify(chatGPTSettings));
            grokSettings = JSON.parse(localStorage.getItem('grokSettings') || JSON.stringify(grokSettings));
            attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
            lessonPlans = JSON.parse(localStorage.getItem('lessonPlans') || '[]');
            grades = JSON.parse(localStorage.getItem('grades') || '[]');
            resources = JSON.parse(localStorage.getItem('resources') || '[]');
            uploadedWork = JSON.parse(localStorage.getItem('uploadedWork') || '[]');
            calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
            dataVault = JSON.parse(localStorage.getItem('dataVault') || '[]');
            schoolEvents = JSON.parse(localStorage.getItem('schoolEvents') || '[]');
            meetingRequests = JSON.parse(localStorage.getItem('meetingRequests') || '[]');
            incidentReports = JSON.parse(localStorage.getItem('incidentReports') || '[]');
            wellnessPrograms = JSON.parse(localStorage.getItem('wellnessPrograms') || '[]');
            integrateEducatorsAsStaff();
            if (students.length === 0) generateDemoData();
            if (admissions.length === 0) initializeAdmissionData();
        }
        // Initialize admission data with default students - ALL 213 STUDENTS
        function initializeAdmissionData() {
            // Raw student data from problem statement - tab-separated format
            // Format: Number, Surname, FirstName, Gender, Grade, Class, Cell#, Email, Language, FatherName, FatherSurname, FatherEmail, FatherCell, MotherName, MotherSurname, MotherEmail, MotherCell
            const rawStudentData = `1	AGYAPONG	Princess	F	Grade 04	4A	0738012103		English					Olivia	AGYAPONG		
2	ARRIES	Kaylin	F	Grade 09	9A	0835918224		English	Francois	ARRIES		0783660823	Sharoline	ARRIES	SHAROLINEARRIES@GMAIL.COM	0680554938
3	BALOYI	Onkgopoditse	M	Grade 07	7A	0648264275		English					Sharon	BALOYI		0727841024
4	BAMIDELE	Michelle	F	Grade 08	8A	0766696262		English					Joyce	MOTSEPE		
5	BOYS	Ginolia	F	Grade 05	5A			English					Thandi	BOYS		0681182017
6	CHAKA	Tumelo	M	Grade 09	9A	0760522944		English		MAGOLEGO			Dimakatso	CHAKA		
7	CHAUKE	Nobuhle	F	Grade 10	10A			English					Emelina Nomsa	CHAUKE		0726002475
8	CHAUKE	Siyanda	F	Grade 07	7A	0793247842		English	Bafana	CHAUKE						
9	CHIMBIRO	Alaine	F	Grade 08	8A	0734638108		English	Chikwando				Nyarai	CHIMBIRO		
10	CHIRUME	Mafaro	F	Grade 05	5A	0732157461		English	Francis				Pers	CHIRUME		0732157462
11	CHIVIMA	Jayden	M	Grade 05	5A	0739202633		English	Anywau	CHIVIMA			Faustina	MAKAINGANWA		
12	CHIVIMA	Jayla	F	Grade 02	2A	0739202633		English	Anuwau	CHIRIMA			Faustina			
13	DELEKILE	Boiketlo	F	Grade R	RA	0787123382		English					Ziyanda	DELEKI		
14	DELEKILE	Mbali	F	Grade 09	9A	0837438666		English					Nomzamo	DELEKILE		
15	DZUKUSO	Ruvimbo	F	Grade 04	4A	074099665		English	Archbold	DZUKUSO			Pieti	ZHIRA		
16	FRANCIS	Phetogo	F	Grade 07	7A	0710256321		English	Johannes				Lesego	FRANCIS		
17	GWESHE	Rufaro	F	Grade 06	6A	0749145762		English	Desmond	GWESHE		0636900874	Huruva			
18	GWESHE	Tinotenda	F	Grade 07	7A	0626855114		English	Desmond	GWESHE			Julie	HURUVA		
19	HAMZAT	Mercy	F	Grade 03	3A	0715603020		English	Hamzat				Tebogo	MASITE		
20	HLALETHWA	Berritta	F	Grade R	RA	0782257768		English		NKWANA			Palesa	HLALETHWA		
21	HLONGWANE	Kgotso	M	Grade 10	10A	0797886667		English					Emily	HLONGWANE		0820517718
22	HLONGWANE	Tiyani	M	Grade R	RA			English					Cynthia	HLONGWANE		
23	JEKE	Perpetual	F	Grade R	RA			English					Hildah	BALOYI		
24	KEKANA	Dimpho	M	Grade 10	10A			English					Palesa	KEKANA		
25	KGAPHOLA	Itebogeleng	M	Grade R	RA	0837144622		English					Poriia	SEEKOEI		
26	KGOSANA	Lehlogonolo	M	Grade 09	9A	0785877954		English	Mpho	LETWABA		0734009661	Ingrid	KGOSANA		
27	KGOSANA	Polelo	M	Grade 04	4A	0791142645		English	Mpho	LETWAA			Christinah	KGOSANA		0785877954
28	KGWETE	Mulalo	M	Grade 06	6A			English	Alpheus	KGWETE		0711062122			
29	KHOZA	Kgomotso	M	Grade 09	9A	0834221060		English	Daniel	MABUNDA			Julliet	KHOZA		0834221060
30	KHOZA	Kgosi	M	Grade 03	3A			English					Julliet	KHOZA		0834221060
31	KHOZA	Laybon	M	Grade 08	8A			English					Nkateko	KHOZA		
32	KHUMALO	Melisizwe	M	Grade 01	1A			English	Nkeku	KHUMALO					
33	KUNENE	Mojalefa	M	Grade 10	10A	0761929171		English	Christy	KUNENE	CHRISTY.KUNENE@GMAIL.COM	0784575151	Thembi	KUNENE		0713919278
34	LAMOLA	Amogelang	F	Grade 06	6A	0765197804		English	Andy	MAHLANGU					
35	LANDANE	Thato	M	Grade 04	4A	0731875351		English	Ambrose				Pelo	HLABANGWANE		
36	LEBAMBO	Atlegang	F	Grade 03	3A			English					Sphiwe	LEBAMBO		0649541623
37	LEBISI	James	M	Grade 10	10A	0681449791		English	James	LEBISI		0784376819			
38	LEKGANYANE	Kaiki	F	Grade 07	7A	0790610833		English	Makgako	LEKGANYANE		0720971689	Solane	LEKGANYANE		0721123998
39	LEKHOTWANE	Lethabo	F	Grade R	RA			English					Khumotso	LEKHOTWANE		
40	LEPAKU	Ontshiametso	M	Grade 02	2A	0766585443		English					Dineo Georginah	LEPAKU		0769840436
41	LETSIKE	Suprise	M	Grade 02	2A			English					Matema	LETSIKE		0614558443
42	LISIMATI	Conland	M	Grade 08	8A	0823635637		English					Primrose	INGWANI		
43	LONGWE	Amelia	F	Grade 04	4A	0781820641		English	Matheus	LONGWE			Natasha	MWANSA		
44	LONGWE	Anita	F	Grade 07	7A	0781820641		English	Mathes	LONGWE		0781820641	Natasha	MWANGA		
45	LUKHULENI	Nikiwe	F	Grade 08	8A	0727983157		English					Isizulu	LEKHULENI		
46	MABASO	Surprise	M	Grade 10	10A			English					Thulile Precious	MABASO		
47	MABUELA	Gomolemo	M	Grade 06	6A	0735606807		English	Stephens				Lorraine	MABUELA		
48	MADEDE	Angela	F	Grade 07	7A	0822698218		English	Morgan				Privillage	MUZATA		
49	MADEDE	Prince	M	Grade 03	3A	0713159498		English	Morgn				Privillage	MUZATA		
50	MAELE	Rearabilwe	M	Grade 07	7A	0679237470		English	Kgomotso				Chrmaine	MAKU		0826446996
51	MAENGEDZE	Victor	M	Grade 10	10A	0788911237		English		MAENGEDZE			Loveness	PEYIYE		
52	MAEPA	Botshelo	F	Grade 08	8A			English					Dimakatso	MAEPA		
53	MAHLANGU	Abigail	F	Grade 01	1A	0609429366		English	Musa	MAHLANGU			Ntshenekane	LEKHOTWANE		0728619891
54	MAHLANGU	Mahlatse	M	Grade 10	10A			English					Petricia	MAHLANGU		0791434414
55	MAHLANGU	Thalia	F	Grade R	RA			English					Jennifer	LEKHOTWANE		
56	MAHLANGU	Zoe	F	Grade 05	5A	0636793507		English					Letta	MAHLANGU		
57	MAHWAMURE	Evan	M	Grade R	RA			English					Kudzai	CHINGARANDE		
58	MAILA	Lesedi	F	Grade 02	2A	0715156789		English					Matopong	MAILA		
59	MAILA	Sandile	M	Grade 10	10A			English					Ivy	MAILA		073245924180
60	MAKHELE	Thabiso	M	Grade 07	7A	0713030723		English	Paul	MAKHELE			Moropane	MOAGI		0826734069
61	MAKHELE	Tlotliso	F	Grade 01	1A	0713030723		English	Paul	MAKHELE						
62	MAKOLA	Kagisho	M	Grade 05	5A	0174485266		English		NCHABELENG			Phelehlave	MAKOLA		
63	MAKOLA	Nhlamulo	F	Grade 01	1A	0722723971		English					Dimakatso	MAKOLA		
64	MAKOLA	Ofentse	F	Grade 07	7A	0604126344		English	Londrick	SEUPE			Getrude	MAKOLA		0711729998
65	MAKWEVERA	Kim	F	Grade 05	5A	0626130952		English					Judith	MAKWRVERA		
66	MALATA	Thego	F	Grade 03	3A	0715034732		English					Lerato	MALATA		0715034732
67	MALEBYE	Siyabonga	M	Grade 06	6A	0738974171		English					Juliah	MALEBYE		
68	MALEKA	Dumisile	M	Grade R	RA			English					Sannah	MALEKA		
69	MALEKE	Bokang	M	Grade R	RA	07239096		English					Petunia	MKABELA		
70	MALEPE	Phemelo	M	Grade 05	5A	0760891344		English					Maitumelo	MALEPE		
71	MAMPHOLO	Zwavhudi	M	Grade 05	5A	0765710251		English					Rebone	MAMPHOLO		0765710251
72	MANALA	Rethabile	F	Grade 01	1A	0728098382		English	Abrey				Matobole	MANALA		
73	MANCHIDI	Khutso	M	Grade 10	10A			English	Tjlamsgale	MANCHIDI		0670342063			
74	MANDEYA	Anashe	F	Grade 04	4A	0722864753		English	Kudakwashe	MANDEYA					
75	MANGANYE	Faith	F	Grade 03	3A	0711482175		English	Muzi				Maria	MANGANYE		
76	MANGENJANI	Cliff	M	Grade 09	9A			English	Clive	MANGENYANI			Lindiwe	NTULI		
77	MANGWATO	Kabelo	M	Grade 07	7A	0711128530		English	Thabang	LEPOTA		0724695759		MANGWATO		
78	MANYIKE	Kamogelo	F	Grade 02	2A	0768338293		English					Lindiwe	MANYIKE		
79	MANYIKE	Thandolwethu	M	Grade 04	4A	0604349048		English	Johannes	MAHLANGU			Phindile	MANYIKE		
80	MAREDI	Khumo	M	Grade 03	3A			English					Diana	MREDI		072261539
81	MAREDI	Stanley	M	Grade 07	7A	0835960702		English	Innocent				Diana	MAREDI		
82	MARIRI	Lethabo	M	Grade 09	9A	0606870046		English	Solomon	MOAGI			Penelope	MARIRI		0849011176
83	MARUFU	Tumelo	M	Grade 10	10A			English	Shepherrd	MARUFU					
84	MASHABA	Hlompho	M	Grade R	RA			English	Mashaba	MASHABA					
85	MASHABA	Kobeli	M	Grade 08	8A	0724811082		English					Mikateko	MASHABA		
86	MASHAYAMOMBE	Brian	M	Grade 03	3A	0743722612		English					Steve	MASHAYAMOMBE		
87	MASILELA	Dineo	F	Grade 03	3A	0790446054		English					Bathabile	MASILELA		
88	MASINGA	Oratilwe	F	Grade 02	2A	0719014898		English					Jane	MASINGA		
89	MASINGA	Rearabiloe	F	Grade 02	2A			English	Ngangamuni	MACHEKE					
90	MATEKOANE	Koketso	M	Grade 04	4A	0183642604		English	Bernard	MARAKALALA			Maria			
91	MATHEBULA	Lungile	F	Grade 10	10A	0796805801		English	James	MAHLALELA					
92	MATHEBULA	Rivoningo	F	Grade 07	7A	0710412798		English					Millie	MATHEBULA		
93	MATHEGA	Opelong	M	Grade 07	7A	0725791972		English	Rakwena				Dorcas	MATHEGA		072591972
94	MATSILA	Tebogo	F	Grade 09	9A	0614049594		English					Mapula	MATSILA		
95	MATSILA	Tlotliso	F	Grade 03	3A			English					Mapula	MATSILA		0814566424
96	MAUBANE	Thabang	F	Grade 07	7A	0823635652		English					Mokete	NYALUNGA		
97	MAUNGANIDZE	Constance	F	Grade 06	6A	0734267361		English	Douglas	MAUNGANIDZE			Mukunyu			
98	MAUNGANIDZE	Prosper	M	Grade 02	2A			English	Douglas	MAYUNGANIDZE					
99	MDLOVU	Makayla	M	Grade 02	2A	0781112438		English	Sibonelo	MPUNGOSE			Neglecia	MDLOVU		
100	MDLULI	Tshepo	M	Grade 10	10A			English					Koketso	MDLULI		
101	MENTOOR	Chuene	M	Grade 09	9A	0824397657		English					Lesego	MENTOOR		
102	MHANGANI	Rhulani	F	Grade 09	9A			English	Mpho	MHLANGANI			Dinah			
103	MHLABENI	Mnqobi	M	Grade 01	1A	0735939520		English					Judith	MHLABENI		
104	MNISI	Lehlogonolo	M	Grade 05	5A	0826878961		English	Johannes	MAMPANE		0796106158		MNISI		
105	MODIBA	Bokamoso	F	Grade 06	6A	0764797308		English	Moeti	MODIBA			Khaiso			
106	MOEKELETSI	Maropeng	M	Grade R	RA			English					Sebwana	MOEKELETSI		
107	MOFOKENG	Khuthitsho	F	Grade 02	2A	0722008854		English					Nation	MOFOKENG		0766132342
108	MOHLALA	Lesedi	F	Grade 06	6A	0799133695		English		MOHLALA			Letta	MOHLALA		0799105695
109	MOHLALA	Lesego	F	Grade 09	9A	0799105695		English	Joseph	MONIALA		0769543408	Joseph			
110	MOHLALA	Oratile	M	Grade 01	1A			English					Annah Mapula	MOHLALA		
111	MOHLAMONYANE	Dimakatso	F	Grade 09	9A	0762753972		English	Abram	MOLOANTOA					
112	MOKALAPA	Nomusa	F	Grade 03	3A	06996681		English		MAHLANGU			Mohlakwana	MOKALAPA		
113	MOKHOTHU	Lehlohonolo	M	Grade 02	2A			English	Simon	TSHABALALA		0606115934			
114	MOKOENA	Gryaor	M	Grade R	RA			English					Dina	MOKOENA		
115	MOKOENA	Owami	M	Grade 07	7A	0781443501		English					Anna	MOKOENA		
116	MOLEKWA	Christinah	F	Grade R	RA	0637441569		English	Jackson	NGWENYA			Zandile			
117	MOLOTO	Dimpho	F	Grade 06	6A			English					Grace	MOLOTO	gracemoloto3@gmail.com	0661885138
118	MONALE	Reabetswe	M	Grade 09	9A	0659428683		English					Tshepiso	MONALE		
119	MONAMA	Thami	M	Grade 10	10A	0713155135		English					Theresa	MONAMA		
120	MONYEKI	Mpho	M	Grade 10	10A	0765223412		English					Josephina	MONYEKI		
121	MOSOMA	Keitumetse	F	Grade 04	4A	0818634148		English					Forgiveness	MOSOMA		
122	MOSOMANE	Bokamoso	F	Grade 02	2A			English					Kgothatso	MOSOMANE	BOITUMELO.MOSOMANE@GMAIL.COM	0682357909
123	MOSOMANE	Keabetswe	F	Grade R	RA	0682357909		English					Kgothatso	MOSOMANE		
124	MOTENA	Njabulo	M	Grade 03	3A			English					Maria Connie	MOTEMA		
125	MOTLHODI	Rorisang	F	Grade R	RA			English					Matseko	MOTLHODI		
126	MOTONG	Kgotalo	F	Grade 03	3A			English					Winnie	MOTONG		0760162916
127	MOTONG	Kulani	M	Grade 05	5A			English					Winnie	MOTONG		0766916110
128	MPHAHLELE	Thabo	M	Grade 04	4A	0662579294		English	Sello	LETSOALO		0823520608			
129	MPHASHA	Matlala	M	Grade 03	3A	0818547003		English	Matome				Tintswalo	MPHASHA		
130	MTHIMUNYE	Ofentse	M	Grade 04	4A	0682406374		English	Tshite	MADIHLABA				MOKWANA		
131	MTSHWENE	Methembe	F	Grade 08	8A	0661812543		English					Jeaneth	MTSHWENE		
132	MUGORE	Dephine	F	Grade 04	4A			English					Kudzai	CHINGARANDE		
133	MUSUSA	Jayden	M	Grade 07	7A	0765983346		English	Muchineyi	MUSUSA			Dambaza	MAJURY		
134	MUSUSA	Sean	M	Grade 04	4A	0765983346		English	Muchineyi	MUSUSA					
135	MUTEMA	Ian	M	Grade 02	2A			English	Rodney	MUTEMA		0849678108	Sibmbisai	MUTEMA		0652106526
136	MUTYORARINGA	Lennon	M	Grade 07	7A	0723040849		English				0723060849	Stella	MUTYORARINGA		
137	MUTYORARINGA	Lennon	M	Grade 07	7A	0723040849		English					Stella	MUTYORARINGA		
138	MUZENDA	Joyce	F	Grade 06	6A	0847114393		English	Mazenda	EDISON			Patience	HOVE		
139	MZIMBA	Thapelo	M	Grade 08	8A	0842993607		English	Levy	MZIMBA		0820403170	Adolphin			
140	NAZO	Owethu	F	Grade R	RA			English	Siyabonga	NAZO					
141	NCUBE	Chriselda	F	Grade 05	5A	0789818509		English	Sifiso	NCUBE			Nomsa	KUTUDZA		
142	NCUBE	Mpumelelo	M	Grade 07	7A	0624284401		English					Moreblessing	NTINI		
143	NDABA	Molemo	M	Grade R	RA	0793209815		English	Joel	RAMOSHABA			Priscilla	NDABA		
144	NDALA	Leonard	M	Grade 07	7A	0729465451		English					Martha	NDAL		
145	NDHLOVU	Palesa	F	Grade 08	8A	0674967607		English					Assah	NDHLOVU		0712949125
146	NDLELA	Iminathi	M	Grade 08	8A	0655565886		English	sefso				Neziswa	NOBANGELA		
147	NDLOVU	Innocent	M	Grade 04	4A	067610360		English	Ephios	MATSANE		0762805947			
148	NDLOVU	Nelson	M	Grade 04	4A	0604800281		English					Amanda	NDLOVU		
149	NDOU	Kevin	M	Grade R	RA			English					Emily	NDOU		
150	NDOU	Mutondi	F	Grade 02	2A			English					Lerato	NDOU		
151	NDOU	Vendros	M	Grade R	RA			English					Emily	NDOU		
152	NDUKULU	Isabella	F	Grade R	RA			English					Mashudu	NDUKULU		
153	NGOBENI	Princess	F	Grade 03	3A			English					Mihloti	NGOENI		0786770806
154	NGOMANE	Nosibusiso	F	Grade 05	5A	0897288019		English	Sizo	NGOMANE					
155	NGWENYAMA	Phillip	M	Grade 10	10A	0699037446		English					Clever	NGWENYAMA		
156	NHAMBI	Jimmy	M	Grade 03	3A			English	Moses	NTHAMBI					
157	NKABINDE	Ofentse	F	Grade 02	2A			English					Nonhlanhla	NKABINDE		
158	NKADIMENG	Thabang	M	Grade 09	9A	0682875371		English					Itumeleng	NKADIMENG	THATO.MOKWENA@GMAIL.COM	0782552261
159	NKOANA	Tlotlang	F	Grade 05	5A	0798992865		English					Stella	NKOANA		
160	NKUNA	Ntsako	M	Grade 02	2A	0791674875		English					Marry	NKUNA		0660616578
161	NKWE	Mohau	F	Grade 04	4A	0721181022		English					Mpuseng	NKWE		
162	NTULI	Ntokozo	F	Grade 06	6A	0810515455		English	Bridgt				Simphiwe	NTULI		
163	NTULI	Ntokozo	F	Grade 06	6A	0810515455		English					Simphiwe	NTULI		
164	NYADZANI	Ompha	F	Grade 02	2A			English	Avhatakali Lesley	NYADZANI		0765063317			
165	NYAMANE	Mackyla	F	Grade 05	5A	0764788227		English					Silvence Sebongile	NYAMANE		0764788227
166	NYAMAROPA	Nyasha	F	Grade 02	2A			English	Forward	NYAMAROPA		0611075328	Sibusisiwe	HLONGWANE	HLONGWANEBUSI@GMAIL.COM	
167	NYARUVEMBO	Sonia	F	Grade 03	3A	0746200360		English	Taban	NYARUVEMBO					
168	PAPO	Reitumetse	F	Grade 09	9A	0605576391		English					Onicca	PAPO		
169	PHALANE	Serogole	F	Grade 10	10A	0722172577		English					Thuru	PHALANE		
170	PHALANE	Tumelo	M	Grade 09	9A	0766820226		English					Joyce	PHALANE		0860497999
171	PHETLA	Gift	M	Grade 05	5A	0725691292		English	Melusi				Florence	NCUBE		
172	PHIRI	Alemekezeke	F	Grade R	RA			English	Lefa P	PHIRI					
173	PHIRI	Onthatile	F	Grade 10	10A			English					Ayanda	PHIRI		
174	RAKGALAKANE	Thabo	M	Grade 03	3A			English					Suzan	RAKGALAKANE		
175	RAKGOTHO	Thapelo	M	Grade 03	3A			English	Thabo	RAKGOTHO		0722599853			
176	RAKOMA	Amogelang	M	Grade 10	10A	0608079614		English					Lesego	RAKOMA		0726501927
177	RAMOKGATLA	Bokamoso	M	Grade 02	2A	0822952941		English	Karinne				Thoko	RAMOKGATLA		0606411435
178	RAMOKGOPA	Katlego	M	Grade 08	8A	0839464815		English	Mack				Mmapula	RAMOKGOPA		
179	RATSHIVHADELO	Oluga	F	Grade 03	3A	0715663036		English	Mashudu	RATSHIVHADELO					
180	SADIKGE	Khuliso	M	Grade 03	3A	0820806467		English	Mulalo	SADIKGE				NGAKO		
181	SEEMA	Fezile	M	Grade 05	5A	0728450730		English	Raymond	MASEMOLA					
182	SEFAKO	Thandeka	F	Grade 05	5A	0679277866		English	Banny				Ivy	SEFAKO		
183	SEGODI	Masego Kayla	F	Grade R	RA			English					Nthabiseng Revien	SEGODI		
184	SELEKA	Amohelang	M	Grade 06	6A	0729898507		English					Zondi	SELEKA		
185	SELEMELA	Tshegofatso	F	Grade 09	9A			English	Mashilo	MAGORO					
186	SELEPE	Karabo	M	Grade 07	7A	0716231064		English					Pinky	SELEPE		
187	SERETLO	Odirile	M	Grade 10	10A	0828725943		English	Thabiso				Letta	NYAKALE		
188	SESHWENG	Kgasietsile	M	Grade 01	1A			English					Mphedi	SESHANG		
189	SGUDLA	Justice	M	Grade 09	9A	0768027363		English	Mlungisi	TAITO					
190	SHIBAMBU	Nkateko	F	Grade 05	5A	0615365661		English	Lazarus	SHIBAMBO			Vironica	MKHONDO		
191	SHUMBA	Nelson	M	Grade 09	9A	0814964733		English	Moses	SHUMBA		0826433477		NDABA		
192	SHUMBA	Zakhele	M	Grade 10	10A			English					Thoko	RAMAKGATLA		0820870157
193	SIMBINI	Amokelani	M	Grade 09	9A			English					Mamiki	SIMBINI		07907196
194	SINGO	Vhuthu	F	Grade 05	5A			English	Livhuwani Rodney	SINGO		0731273422				0832702980
195	SKOSANA	Ngobile	F	Grade 08	8A	0722469383		English	Percy	TJIANE		0617629522			
196	TAU	Happiness	M	Grade 03	3A	0791514602		English	Eric	THUBANE					
197	THOBAKGALE	Atlegang	M	Grade 10	10A	0824362308		English					Mashego	THOBAKGALE		
198	TICK	Angel	F	Grade 09	9A	0787114211		English	Jackson	TICK			Nleya			
199	TICK	Samuel	M	Grade 02	2A			English	Jackson	TICK	N/A	0761294251			HANNAHNBEYA@GMAIL.COM	0625398674
200	TJALE	Tokollo	M	Grade 08	8A	0796175000		English					Vellery	TJALE		
201	TLADI	Boitumelo	F	Grade 05	5A	0825463158		English	Thabo	MOKWANA					
202	TLADI	Masego	M	Grade 01	1A	0825463158		English	Thabo	MOKWANA					
203	TLADI	Steve	M	Grade 09	9A	0825443158		English	Thabo				Nancy	TLADI		0825463158
204	TWALA	Asimbonge	F	Grade 04	4A	0796522700		English					Ns	TWALA		
205	TYULU	Ikhona	F	Grade 07	7A	0648223127		English					Ntombie	TYULU		0648223127
206	XABA	Nqobile	F	Grade R	RA	0793583738		English					Nonkululeko	XABA		
207	XOZWA	Precious	F	Grade 02	2A	0723537400		English	George	LEBISI			Tembi	XOZWA		
208	YUDA	Keagan	M	Grade 01	1A			English					Mitchelle	MASHONGANYIKA		
209	ZIMBWA	Agnes	F	Grade 04	4A	0653625473		English	Kudakwashe	ZIMBWA		0691569583	Tenda			
210	ZINDERE	Wajeed	M	Grade 03	3A	0739945030		English					Jane	ZINDERE		
211	ZINDERE	Waleed	M	Grade 03	3A	0836213919		English					Jane	ZINDERE		
212	ZINDERE	Yasmis	F	Grade 09	9A	0832321195		English					Jane	ZINDERE		
213	ZWANE	Nqubeko	F	Grade 09	9A			English					Brenda	ZWANE`;
            
            // Parse the raw data
            const lines = rawStudentData.trim().split('\n');
            const initialAdmissions = [];
            
            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length >= 9) {
                    const admission = {
                        accession: parts[0].trim(),
                        surname: parts[1].trim(),
                        firstName: parts[2].trim(),
                        gender: parts[3].trim(),
                        grade: parts[4].trim(),
                        classValue: parts[5].trim(),
                        cell: parts[6].trim(),
                        email: parts[7].trim(),
                        homeLanguage: parts[8].trim(),
                        fatherName: parts.length > 9 ? parts[9].trim() : '',
                        fatherSurname: parts.length > 10 ? parts[10].trim() : '',
                        fatherEmail: parts.length > 11 ? parts[11].trim() : '',
                        fatherCell: parts.length > 12 ? parts[12].trim() : '',
                        motherName: parts.length > 13 ? parts[13].trim() : '',
                        motherSurname: parts.length > 14 ? parts[14].trim() : '',
                        motherEmail: parts.length > 15 ? parts[15].trim() : '',
                        motherCell: parts.length > 16 ? parts[16].trim() : ''
                    };
                    initialAdmissions.push(admission);
                }
            });
            
            // Add all parsed admissions to the system
            initialAdmissions.forEach(admission => {
                const id = Date.now() + Math.random();
                const name = admission.firstName + ' ' + admission.surname;
                admissions.push({
                    id,
                    name,
                    ...admission,
                    username: '',
                    password: '',
                    status: 'Pending',
                    saSamsFormat: true
                });
                
                // Also add to students array for Student Information System
                students.push({
                    id,
                    name,
                    ...admission,
                    parent: admission.motherName + ' ' + admission.motherSurname,
                    status: 'Active',
                    educator: '',
                    saSamsFormat: true
                });
            });
            
            saveData();
            console.log(`Initialized ${initialAdmissions.length} students in admission and student information systems`);
        }
        // Generate demo data
        function generateDemoData() {
            // Demo data if needed
            saveData();
        }
        // Integrate educators from students as staff
        function integrateEducatorsAsStaff() {
            const educators = [...new Set(students.map(s => s.educator).filter(e => e && e !== 'Unknown'))];
            educators.forEach(educator => {
                if (!staff.find(s => s.name === educator)) {
                    const id = Date.now() + Math.random();
                    staff.push({
                        id,
                        name: educator,
                        role: 'Teacher',
                        department: 'Education',
                        salary: 30000,
                        taxNumber: 'T' + Date.now(),
                        uifNumber: 'U' + Date.now(),
                        certExpiry: new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],
                        status: 'Active'
                    });
                    users.push({
                        username: educator.toLowerCase().replace(/\s+/g, '') + Math.floor(Math.random() * 1000),
                        password: 'teacher' + Math.floor(Math.random() * 1000),
                        name: educator,
                        role: 'Teacher'
                    });
                }
            });
            saveData();
        }
        // Save data to localStorage
        function saveData() {
            // Save to localStorage
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('admissions', JSON.stringify(admissions));
            localStorage.setItem('fees', JSON.stringify(fees));
            localStorage.setItem('timetable', JSON.stringify(timetable));
            localStorage.setItem('exams', JSON.stringify(exams));
            localStorage.setItem('staff', JSON.stringify(staff));
            localStorage.setItem('payrolls', JSON.stringify(payrolls));
            localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
            localStorage.setItem('performanceReviews', JSON.stringify(performanceReviews));
            localStorage.setItem('jobs', JSON.stringify(jobs));
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
            localStorage.setItem('contents', JSON.stringify(contents));
            localStorage.setItem('messages', JSON.stringify(messages));
            localStorage.setItem('announcements', JSON.stringify(announcements));
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('hrSettings', JSON.stringify(hrSettings));
            localStorage.setItem('smsSettings', JSON.stringify(smsSettings));
            localStorage.setItem('chatGPTSettings', JSON.stringify(chatGPTSettings));
            localStorage.setItem('grokSettings', JSON.stringify(grokSettings));
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            localStorage.setItem('lessonPlans', JSON.stringify(lessonPlans));
            localStorage.setItem('grades', JSON.stringify(grades));
            localStorage.setItem('resources', JSON.stringify(resources));
            localStorage.setItem('uploadedWork', JSON.stringify(uploadedWork));
            localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
            localStorage.setItem('dataVault', JSON.stringify(dataVault));
            localStorage.setItem('teacherChats', JSON.stringify(teacherChats));
            localStorage.setItem('adminMessages', JSON.stringify(adminMessages));
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
            localStorage.setItem('schoolEvents', JSON.stringify(schoolEvents));
            localStorage.setItem('meetingRequests', JSON.stringify(meetingRequests));
            localStorage.setItem('incidentReports', JSON.stringify(incidentReports));
            localStorage.setItem('wellnessPrograms', JSON.stringify(wellnessPrograms));
            
            if (typeof syncDataToAllDevices === 'function' && currentUser) {
                // Sync critical data types that need real-time propagation
                const criticalDataTypes = [
                    { name: 'students', data: students },
                    { name: 'attendance', data: attendanceRecords },
                    { name: 'fees', data: fees },
                    { name: 'grades', data: grades },
                    { name: 'staff', data: staff },
                    { name: 'announcements', data: announcements },
                    { name: 'users', data: users },
                    { name: 'admissions', data: admissions },
                    { name: 'timetable', data: timetable },
                    { name: 'resources', data: resources },
                    { name: 'lessonPlans', data: lessonPlans }
                ];
                
                // Sync each critical data type
                criticalDataTypes.forEach(item => {
                    syncDataToAllDevices(item.name, item.data, 'update');
                });
            }
        }
        // Login function - Make globally accessible
        window.login = async function() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // IMPORTANT: Reload users from localStorage before login attempt
            // This ensures newly created users can log in immediately on any device/tab
            users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Find user first - simple username/password match
            let user = users.find(u => u.username === username && u.password === password);
            
            // If not found, check fallback default users
            if (!user) {
                const fallback = {
                    'admin': { username: 'admin', password: 'admin123', name: 'Admin User', role: 'Admin' },
                    'hod': { username: 'hod', password: 'hod123', name: 'HOD User', role: 'HOD' },
                    'teacher': { username: 'teacher', password: 'teacher123', name: 'Teacher User', role: 'Teacher' },
                    'parent': { username: 'parent', password: 'parent123', name: 'Parent User', role: 'Parent' },
                    'student': { username: 'student', password: 'student123', name: 'Student User', role: 'Student' }
                }[username.toLowerCase()];
                
                if (fallback && password === fallback.password) {
                    user = fallback;
                }
            }
            
            if (user) {
                // Log successful login activity
                logUserActivity(username, user.role, 'Login', 'Successful login');
                
                currentUser = user;
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                updateVisibility();
                loadData();
                if (currentUser.role.toLowerCase() === 'hod') {
                    loadHODDashboard();
                } else if (currentUser.role.toLowerCase() === 'parent') {
                    loadParentPortal();
                } else {
                    loadDashboard();
                }
                renderHR();
                populateSelects();
                
                // Initialize real-time communication systems
                initializeCommunicationSystems();
                
                // Setup periodic auto-sync for real-time updates (every 30 seconds)
                // This ensures data stays fresh even if other mechanisms fail
                if (typeof setupPeriodicSync === 'function') {
                    setupPeriodicSync();
                }
                
                addNotification('Welcome back, ' + user.name + '!', 'info');
            } else {
                alert('Invalid credentials. Please check your username and password.');
            }
        }
        // Biometric Login
        // Update visibility
        function updateVisibility() {
            if (!currentUser) return;
            const role = currentUser.role.toLowerCase();
            
            // Helper function to set display based on visibility condition
            // Uses 'block' for visible elements to override CSS defaults like 'display: none'
            const setVisibility = (elements, isVisible) => {
                elements.forEach(el => {
                    // For list items, use 'list-item', for others use 'block'
                    const displayValue = el.tagName === 'LI' ? 'list-item' : 'block';
                    el.style.display = isVisible ? displayValue : 'none';
                });
            };
            
            // For students: Hide all non-student elements (including Student Info and Attendance)
            if (role === 'student') {
                setVisibility(document.querySelectorAll('.admin-only, .teacher-only, .hod-only, .non-student, .parent-only'), false);
                setVisibility(document.querySelectorAll('.student-only'), true);
            } else if (role === 'teacher') {
                setVisibility(document.querySelectorAll('.admin-only, .hod-only, .student-only, .parent-only'), false);
                setVisibility(document.querySelectorAll('.teacher-only, .non-student'), true);
            } else if (role === 'hod') {
                setVisibility(document.querySelectorAll('.admin-only, .student-only, .teacher-only, .parent-only'), false);
                setVisibility(document.querySelectorAll('.hod-only, .non-student'), true);
            } else if (role === 'parent') {
                setVisibility(document.querySelectorAll('.admin-only, .teacher-only, .hod-only, .student-only, .non-parent'), false);
                setVisibility(document.querySelectorAll('.parent-only'), true);
            } else if (role === 'admin') {
                setVisibility(document.querySelectorAll('.teacher-only, .hod-only, .student-only, .parent-only'), false);
                setVisibility(document.querySelectorAll('.admin-only, .non-student'), true);
            }
        }
        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const content = document.querySelector('.content');
            const btn = document.querySelector('.btn-toggle-sidebar');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            btn.classList.toggle('expanded');
        }
        // Logout
        function logout() {
            // Stop periodic sync
            if (typeof stopPeriodicSync === 'function') {
                stopPeriodicSync();
            }
            
            // ========================================
            
            
            currentUser = null;
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        
        
        function loadStudentProgress() {
            renderStudentProgress();
        }
        
        function exportStudentProgress() {
            const studentId = parseInt(document.getElementById('progressStudent').value);
            if (!studentId) {
                addNotification('Please select a student first', 'warning');
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            const studentGrades = grades.filter(g => g.studentId === studentId);
            
            if (studentGrades.length === 0) {
                addNotification('No progress data to export', 'warning');
                return;
            }
            
            // Calculate metrics
            const scores = studentGrades.map(g => g.score);
            const overallAvg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            const highestScore = Math.max(...scores);
            const lowestScore = Math.min(...scores);
            
            // Create CSV content
            const headers = ['Subject', 'Score', 'Grade', 'Comments', 'Date'];
            const rows = studentGrades.map(g => {
                const grade = g.score >= 90 ? 'A+' : g.score >= 80 ? 'A' : g.score >= 70 ? 'B' : g.score >= 60 ? 'C' : g.score >= 50 ? 'D' : 'F';
                return [
                    g.subject,
                    g.score + '%',
                    grade,
                    g.comments || 'No comments',
                    g.date ? new Date(g.date).toLocaleDateString() : 'N/A'
                ].map(cell => `"${cell}"`).join(',');
            });
            
            const csvContent = [
                `Student Progress Report - ${student ? student.name : 'Unknown Student'}`,
                `Generated: ${new Date().toLocaleString()}`,
                `Overall Average: ${overallAvg}%`,
                `Highest Score: ${highestScore}%`,
                `Lowest Score: ${lowestScore}%`,
                `Total Entries: ${studentGrades.length}`,
                '',
                headers.join(','),
                ...rows
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${student ? student.name.replace(/\s+/g, '_') : 'student'}_progress_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            addNotification('Progress report exported successfully!', 'success');
            logUserActivity(currentUser.username || currentUser.name, currentUser.role, 'Export', `Exported progress report for ${student ? student.name : 'student'}`);
        }

        // Upload Work Functions
        function renderUploadWork() {
            // Populate classes
            const classes = [...new Set(students.map(s => s.grade))];
            document.getElementById('workClass').innerHTML = '<option value="">Select Class</option>' + 
                classes.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // Display uploaded work
            document.getElementById('uploadedWorkList').innerHTML = uploadedWork.length > 0 ? 
                uploadedWork.map(w => `
                    <div class="report-card mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6><i class="fas fa-file me-2"></i>${w.title}</h6>
                                <p class="mb-1"><small>Class: ${w.class} | Uploaded: ${w.uploadDate}</small></p>
                                <p class="mb-1"><small>${w.description}</small></p>
                                <p class="mb-0"><small>Files: ${w.files.map(f => f.name).join(', ')}</small></p>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteWorkFile(${w.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') : 
                '<p class="text-muted">No uploaded work files yet.</p>';
        }

        function uploadWorkFile() {
            const files = document.getElementById('workFileUpload').files;
            const title = document.getElementById('workTitle').value;
            const workClass = document.getElementById('workClass').value;
            const description = document.getElementById('workDescription').value;

            if (!files || files.length === 0) {
                addNotification('Please select at least one file', 'warning');
                return;
            }
            if (!title) {
                addNotification('Please enter a title', 'warning');
                return;
            }

            const fileList = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                // Check file type
                const validTypes = ['.csv', '.pdf', '.doc', '.docx', '.xls', '.xlsx'];
                const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                if (!validTypes.includes(fileExt)) {
                    addNotification(`Invalid file type: ${file.name}. Please use CSV, PDF, Word, or Excel files.`, 'danger');
                    continue;
                }
                fileList.push({
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
            }

            if (fileList.length === 0) {
                addNotification('No valid files to upload', 'danger');
                return;
            }

            const id = Date.now();
            uploadedWork.push({
                id,
                title,
                class: workClass,
                description,
                files: fileList,
                uploadDate: new Date().toLocaleDateString(),
                uploadedBy: currentUser.name
            });

            saveData();
            renderUploadWork();

            // Clear form
            document.getElementById('workFileUpload').value = '';
            document.getElementById('workTitle').value = '';
            document.getElementById('workClass').value = '';
            document.getElementById('workDescription').value = '';

            addNotification(`Uploaded ${fileList.length} file(s) successfully`, 'success');
        }

        function deleteWorkFile(id) {
            if (confirm('Are you sure you want to delete this work file?')) {
                uploadedWork = uploadedWork.filter(w => w.id !== id);
                saveData();
                renderUploadWork();
                addNotification('Work file deleted', 'success');
            }
        }

        // Calendar Functions
        function renderCalendar() {
            const monthInput = document.getElementById('calendarMonth').value;
            const currentMonth = monthInput ? new Date(monthInput + '-01') : new Date();
            
            // Generate calendar
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            let calendarHTML = '<table class="table table-bordered">';
            calendarHTML += '<thead><tr>';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<th class="text-center">${day}</th>`;
            });
            calendarHTML += '</tr></thead><tbody><tr>';
            
            // Empty cells for days before start of month
            for (let i = 0; i < startDay; i++) {
                calendarHTML += '<td></td>';
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = calendarEvents.filter(e => e.date === currentDate);
                
                calendarHTML += `<td class="timetable-cell" style="height: 100px; vertical-align: top; cursor: pointer;" onclick="showDayEvents('${currentDate}')">`;
                calendarHTML += `<strong>${day}</strong><br>`;
                
                if (dayEvents.length > 0) {
                    dayEvents.forEach(e => {
                        const colors = {
                            'Class': '#36A2EB',
                            'Meeting': '#FFCE56',
                            'Exam': '#FF6384',
                            'Event': '#4BC0C0',
                            'Deadline': '#FF9F40'
                        };
                        const color = colors[e.type] || '#cccccc';
                        calendarHTML += `<div style="background: ${color}; padding: 2px; margin: 2px 0; border-radius: 3px; font-size: 0.75rem;" title="${e.title} - ${e.time}">
                            ${e.title}
                        </div>`;
                    });
                }
                
                calendarHTML += '</td>';
                
                if ((startDay + day) % 7 === 0) {
                    calendarHTML += '</tr><tr>';
                }
            }
            
            // Fill remaining cells
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                calendarHTML += '<td></td>';
            }
            
            calendarHTML += '</tr></tbody></table>';
            document.getElementById('calendarView').innerHTML = calendarHTML;
            
            // Render upcoming events
            const today = new Date().toISOString().split('T')[0];
            const upcoming = calendarEvents
                .filter(e => e.date >= today)
                .sort((a, b) => a.date.localeCompare(b.date))
                .slice(0, 5);
            
            document.getElementById('upcomingEventsList').innerHTML = upcoming.length > 0 ?
                upcoming.map(e => `
                    <div class="report-card mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6><span class="badge" style="background: ${getEventColor(e.type)}">${e.type}</span> ${e.title}</h6>
                                <p class="mb-1"><small><i class="fas fa-calendar me-1"></i>${e.date} at ${e.time}</small></p>
                                <p class="mb-0"><small>${e.description}</small></p>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteCalendarEvent(${e.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') :
                '<p class="text-muted">No upcoming events.</p>';
        }

        function getEventColor(type) {
            const colors = {
                'Class': '#36A2EB',
                'Meeting': '#FFCE56',
                'Exam': '#FF6384',
                'Event': '#4BC0C0',
                'Deadline': '#FF9F40'
            };
            return colors[type] || '#cccccc';
        }

        function showDayEvents(date) {
            const dayEvents = calendarEvents.filter(e => e.date === date);
            if (dayEvents.length === 0) {
                addNotification(`No events on ${date}`, 'info');
            } else {
                let message = `Events on ${date}:\n`;
                dayEvents.forEach(e => {
                    message += `\n${e.time} - ${e.title} (${e.type})`;
                });
                alert(message);
            }
        }

        function showAddCalendarEventModal() {
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventType').value = 'Class';
            document.getElementById('eventDescription').value = '';
            new bootstrap.Modal(document.getElementById('addCalendarEventModal')).show();
        }

        function saveCalendarEvent() {
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const type = document.getElementById('eventType').value;
            const description = document.getElementById('eventDescription').value;

            if (!title || !date || !time) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }

            const id = Date.now();
            calendarEvents.push({
                id,
                title,
                date,
                time,
                type,
                description,
                createdBy: currentUser.name
            });

            saveData();
            renderCalendar();
            bootstrap.Modal.getInstance(document.getElementById('addCalendarEventModal')).hide();
            addNotification('Calendar event added', 'success');
        }

        function deleteCalendarEvent(id) {
            if (confirm('Are you sure you want to delete this event?')) {
                calendarEvents = calendarEvents.filter(e => e.id !== id);
                saveData();
                renderCalendar();
                addNotification('Calendar event deleted', 'success');
            }
        }

        // HR Services Functions for Teachers
        function renderHRServices() {
            renderLeaveCalendar();
            renderMyLeaveRequests();
        }

        function renderLeaveCalendar() {
            const monthInput = document.getElementById('leaveCalendarMonth');
            if (!monthInput.value) {
                monthInput.value = new Date().toISOString().slice(0, 7);
            }
            const currentMonth = new Date(monthInput.value + '-01');
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            let calendarHTML = '<table class="table table-bordered">';
            calendarHTML += '<thead><tr>';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<th class="text-center">${day}</th>`;
            });
            calendarHTML += '</tr></thead><tbody><tr>';
            
            for (let i = 0; i < startDay; i++) {
                calendarHTML += '<td></td>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayLeaves = leaves.filter(l => l.startDate <= currentDate && l.endDate >= currentDate && l.staff === currentUser.name);
                
                calendarHTML += `<td class="text-center" style="height: 80px; vertical-align: top;">`;
                calendarHTML += `<strong>${day}</strong><br>`;
                
                if (dayLeaves.length > 0) {
                    calendarHTML += `<div style="background: #FF6384; padding: 2px; margin: 2px; border-radius: 3px; font-size: 0.7rem;">Leave</div>`;
                }
                
                calendarHTML += '</td>';
                
                if ((startDay + day) % 7 === 0) {
                    calendarHTML += '</tr><tr>';
                }
            }
            
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                calendarHTML += '<td></td>';
            }
            
            calendarHTML += '</tr></tbody></table>';
            document.getElementById('leaveCalendarView').innerHTML = calendarHTML;
        }

        function renderMyLeaveRequests() {
            const myLeaves = leaves.filter(l => l.staff === currentUser.name);
            document.getElementById('myLeaveRequestsTable').innerHTML = myLeaves.length > 0 ? myLeaves.map(l => `
                <tr>
                    <td>${l.type}</td>
                    <td>${l.startDate}</td>
                    <td>${l.endDate}</td>
                    <td>${l.days}</td>
                    <td><span class="badge bg-${l.status === 'Approved' ? 'success' : l.status === 'Pending' ? 'warning' : 'danger'}">${l.status}</span></td>
                    <td>
                        ${l.status === 'Pending' ? `<button class="btn btn-sm btn-danger" onclick="cancelLeaveRequest(${l.id})">Cancel</button>` : ''}
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="6" class="text-center text-muted">No leave requests found.</td></tr>';
        }

        function showApplyLeaveModal() {
            const modalHTML = `
                <div class="modal fade" id="applyLeaveModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Apply for Leave</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Leave Type</label>
                                    <select id="leaveType" class="form-control">
                                        <option value="Annual">Annual Leave</option>
                                        <option value="Sick">Sick Leave</option>
                                        <option value="Personal">Personal Leave</option>
                                        <option value="Maternity">Maternity Leave</option>
                                        <option value="Study">Study Leave</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" id="leaveStartDate" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" id="leaveEndDate" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Reason</label>
                                    <textarea id="leaveReason" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitLeaveRequest()">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('applyLeaveModal'));
            modal.show();
            document.getElementById('applyLeaveModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        function submitLeaveRequest() {
            const type = document.getElementById('leaveType').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value;

            if (!startDate || !endDate || !reason) {
                addNotification('Please fill in all fields', 'warning');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            const id = Date.now();
            leaves.push({
                id,
                staff: currentUser.name,
                type,
                startDate,
                endDate,
                days,
                reason,
                status: 'Pending',
                appliedDate: new Date().toISOString().split('T')[0]
            });

            saveData();
            renderHRServices();
            bootstrap.Modal.getInstance(document.getElementById('applyLeaveModal')).hide();
            addNotification('Leave request submitted successfully', 'success');
        }

        function cancelLeaveRequest(id) {
            if (confirm('Are you sure you want to cancel this leave request?')) {
                leaves = leaves.filter(l => l.id !== id);
                saveData();
                renderMyLeaveRequests();
                addNotification('Leave request cancelled', 'success');
            }
        }

        // Employee Wellness Functions for Teachers
        function renderEmployeeWellness() {
            renderWellnessActivities();
            renderHealthTips();
            updateWellnessMetrics();
        }

        function updateWellnessMetrics() {
            // Update wellness score and metrics
            const wellnessActivities = JSON.parse(localStorage.getItem('wellnessActivities') || '[]');
            const userActivities = wellnessActivities.filter(a => a.user === currentUser.name);
            
            document.getElementById('wellnessScore').textContent = Math.min(100, 70 + userActivities.length * 2) + '%';
            document.getElementById('activitiesCount').textContent = userActivities.length;
            document.getElementById('healthTipsCount').textContent = '8';
            document.getElementById('checkInsCount').textContent = userActivities.filter(a => a.type === 'check-in').length;
        }

        function renderWellnessActivities() {
            const activities = [
                { name: 'Morning Yoga', category: 'Fitness', description: '30 minutes yoga session', icon: 'fa-spa' },
                { name: 'Team Walk', category: 'Fitness', description: 'Group walking activity', icon: 'fa-walking' },
                { name: 'Healthy Lunch Workshop', category: 'Nutrition', description: 'Learn healthy eating', icon: 'fa-apple-alt' },
                { name: 'Mental Health Support', category: 'Mental Health', description: 'Counseling session', icon: 'fa-brain' },
                { name: 'Meditation Session', category: 'Mental Health', description: 'Guided meditation', icon: 'fa-om' },
                { name: 'Fitness Challenge', category: 'Fitness', description: 'Monthly step challenge', icon: 'fa-running' }
            ];

            document.getElementById('wellnessActivitiesList').innerHTML = activities.map(a => `
                <div class="card mb-2" style="background: rgba(255, 255, 255, 0.1);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6><i class="fas ${a.icon} me-2"></i>${a.name}</h6>
                                <p class="mb-0"><small>${a.description}</small></p>
                                <span class="badge bg-secondary">${a.category}</span>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="enrollInActivity('${a.name}')">Enroll</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderHealthTips() {
            const tips = [
                'Stay hydrated - drink at least 8 glasses of water daily',
                'Take regular breaks during work to reduce stress',
                'Practice good posture while working',
                'Get 7-8 hours of sleep each night',
                'Include fruits and vegetables in every meal',
                'Exercise for at least 30 minutes daily',
                'Practice mindfulness or meditation',
                'Maintain work-life balance'
            ];

            document.getElementById('healthTipsList').innerHTML = tips.map((tip, idx) => `
                <div class="alert alert-light text-dark mb-2">
                    <i class="fas fa-lightbulb me-2"></i>${tip}
                </div>
            `).join('');
        }

        function enrollInActivity(activityName) {
            const wellnessActivities = JSON.parse(localStorage.getItem('wellnessActivities') || '[]');
            wellnessActivities.push({
                user: currentUser.name,
                activity: activityName,
                date: new Date().toISOString().split('T')[0],
                type: 'enrollment'
            });
            localStorage.setItem('wellnessActivities', JSON.stringify(wellnessActivities));
            addNotification('Enrolled in ' + activityName, 'success');
            updateWellnessMetrics();
        }

        function showAddWellnessActivityModal() {
            const modalHTML = `
                <div class="modal fade" id="addWellnessActivityModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Log Wellness Activity</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Activity</label>
                                    <input type="text" id="activityName" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Duration (minutes)</label>
                                    <input type="number" id="activityDuration" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Date</label>
                                    <input type="date" id="activityDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveWellnessActivity()">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('addWellnessActivityModal'));
            modal.show();
            document.getElementById('addWellnessActivityModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        function saveWellnessActivity() {
            const name = document.getElementById('activityName').value;
            const duration = document.getElementById('activityDuration').value;
            const date = document.getElementById('activityDate').value;

            if (!name || !duration) {
                addNotification('Please fill in all fields', 'warning');
                return;
            }

            const wellnessActivities = JSON.parse(localStorage.getItem('wellnessActivities') || '[]');
            wellnessActivities.push({
                user: currentUser.name,
                activity: name,
                duration,
                date,
                type: 'logged'
            });
            localStorage.setItem('wellnessActivities', JSON.stringify(wellnessActivities));
            
            bootstrap.Modal.getInstance(document.getElementById('addWellnessActivityModal')).hide();
            addNotification('Activity logged successfully', 'success');
            updateWellnessMetrics();
        }

        function saveWellnessTracking() {
            const weight = document.getElementById('weightInput').value;
            const mood = document.getElementById('moodInput').value;

            if (!weight) {
                addNotification('Please enter your weight', 'warning');
                return;
            }

            const wellnessTracking = JSON.parse(localStorage.getItem('wellnessTracking') || '[]');
            wellnessTracking.push({
                user: currentUser.name,
                weight,
                mood,
                date: new Date().toISOString().split('T')[0]
            });
            localStorage.setItem('wellnessTracking', JSON.stringify(wellnessTracking));
            
            addNotification('Wellness data saved', 'success');
        }

        function showWellnessSupportModal() {
            const modalHTML = `
                <div class="modal fade" id="wellnessSupportModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Wellness Support</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <h6>Contact Information</h6>
                                <p><i class="fas fa-phone me-2"></i>Phone: 123-456-7890</p>
                                <p><i class="fas fa-envelope me-2"></i>Email: wellness@school.com</p>
                                <hr>
                                <div class="mb-3">
                                    <label class="form-label">Your Message</label>
                                    <textarea id="supportMessage" class="form-control" rows="4"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="sendWellnessSupport()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('wellnessSupportModal'));
            modal.show();
            document.getElementById('wellnessSupportModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        function sendWellnessSupport() {
            const message = document.getElementById('supportMessage').value;
            if (!message) {
                addNotification('Please enter a message', 'warning');
                return;
            }
            bootstrap.Modal.getInstance(document.getElementById('wellnessSupportModal')).hide();
            addNotification('Support request sent successfully', 'success');
        }

        // Employee Wellness Admin Functions
        function renderEmployeeWellnessAdmin() {
            renderWellnessPrograms();
        }

        function renderWellnessPrograms() {
            wellnessPrograms = JSON.parse(localStorage.getItem('wellnessPrograms') || '[]');
            
            // If no programs, show sample data
            if (wellnessPrograms.length === 0) {
                wellnessPrograms = [
                    { id: 1, name: 'Fitness Challenge 2024', category: 'Physical Fitness', participants: [], maxParticipants: 50, startDate: '2024-01-01', status: 'Active', duration: 12 },
                    { id: 2, name: 'Mental Health Week', category: 'Mental Health', participants: [], maxParticipants: 100, startDate: '2024-02-15', status: 'Active', duration: 1 },
                    { id: 3, name: 'Nutrition Workshop Series', category: 'Nutrition', participants: [], maxParticipants: 30, startDate: '2024-03-01', status: 'Active', duration: 8 },
                    { id: 4, name: 'Yoga Sessions', category: 'Physical Fitness', participants: [], maxParticipants: 25, startDate: '2024-01-15', status: 'Active', duration: 16 }
                ];
                localStorage.setItem('wellnessPrograms', JSON.stringify(wellnessPrograms));
            }
            
            const searchTerm = document.getElementById('wellnessSearch')?.value.toLowerCase() || '';
            const filteredPrograms = wellnessPrograms.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.category.toLowerCase().includes(searchTerm)
            );

            const statusBadgeClass = (status) => {
                switch(status) {
                    case 'Active': return 'success';
                    case 'Upcoming': return 'primary';
                    case 'Completed': return 'secondary';
                    case 'Cancelled': return 'danger';
                    default: return 'info';
                }
            };

            document.getElementById('wellnessProgramsTable').innerHTML = filteredPrograms.length > 0 ? filteredPrograms.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td><span class="badge bg-info">${p.category}</span></td>
                    <td>${p.participants?.length || 0}/${p.maxParticipants}</td>
                    <td>${p.startDate}</td>
                    <td><span class="badge bg-${statusBadgeClass(p.status)}">${p.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewWellnessProgram(${p.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editWellnessProgram(${p.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWellnessProgram(${p.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="6" class="text-center text-muted">No wellness programs found. Click "Add Wellness Program" to create one.</td></tr>';

            // Update metrics
            const totalParticipants = wellnessPrograms.reduce((sum, p) => sum + (p.participants?.length || 0), 0);
            document.getElementById('totalWellnessParticipants').textContent = totalParticipants;
            document.getElementById('totalWellnessPrograms').textContent = wellnessPrograms.length;
            
            const activePrograms = wellnessPrograms.filter(p => p.status === 'Active').length;
            const engagement = wellnessPrograms.length > 0 ? Math.round((activePrograms / wellnessPrograms.length) * 100) : 0;
            document.getElementById('avgWellnessEngagement').textContent = engagement + '%';
            document.getElementById('wellnessSatisfaction').textContent = '92%';
        }
        
        function deleteWellnessProgram(id) {
            if (confirm('Are you sure you want to delete this wellness program?')) {
                wellnessPrograms = wellnessPrograms.filter(p => p.id !== id);
                localStorage.setItem('wellnessPrograms', JSON.stringify(wellnessPrograms));
                renderWellnessPrograms();
                addNotification('Wellness program deleted', 'warning');
                logAudit('Wellness Program', 'Deleted wellness program', 'Medium');
            }
        }

        function renderWellnessParticipants() {
            const participants = staff.map(s => ({
                name: s.name,
                department: s.department || 'General',
                score: Math.floor(Math.random() * 30) + 70,
                activities: Math.floor(Math.random() * 15) + 5,
                lastCheckIn: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
            }));

            document.getElementById('wellnessParticipantsTable').innerHTML = participants.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.department}</td>
                    <td><span class="badge bg-${p.score >= 80 ? 'success' : 'warning'}">${p.score}%</span></td>
                    <td>${p.activities}</td>
                    <td>${p.lastCheckIn}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewParticipantDetails('${p.name}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderWellnessAnalytics() {
            // Placeholder for wellness analytics charts
            addNotification('Wellness analytics loaded', 'info');
        }

        function renderWellnessResourcesAdmin() {
            wellnessResources = JSON.parse(localStorage.getItem('wellnessResources') || '[]');
            
            // If no resources, show sample data
            if (wellnessResources.length === 0) {
                wellnessResources = [
                    { id: 1, title: 'Healthy Eating Guide', type: 'Guide', category: 'Nutrition', views: 145, url: '#' },
                    { id: 2, title: 'Stress Management Tips', type: 'Video', category: 'Mental Health', views: 289, url: '#' },
                    { id: 3, title: 'Fitness Program Guide', type: 'Guide', category: 'Physical Fitness', views: 203, url: '#' }
                ];
                localStorage.setItem('wellnessResources', JSON.stringify(wellnessResources));
            }

            document.getElementById('wellnessResourcesTable').innerHTML = wellnessResources.length > 0 ? wellnessResources.map(r => `
                <tr>
                    <td><a href="${r.url}" target="_blank" class="text-white">${r.title}</a></td>
                    <td><span class="badge bg-secondary">${r.type}</span></td>
                    <td><span class="badge bg-info">${r.category}</span></td>
                    <td>${r.views}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editWellnessResource(${r.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWellnessResource(${r.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="text-center text-muted">No wellness resources found.</td></tr>';
        }
        
        function editWellnessResource(id) {
            const resource = wellnessResources.find(r => r.id === id);
            if (resource) {
                document.getElementById('wellnessResourceTitle').value = resource.title;
                document.getElementById('wellnessResourceType').value = resource.type;
                document.getElementById('wellnessResourceCategory').value = resource.category;
                document.getElementById('wellnessResourceUrl').value = resource.url;
                document.getElementById('wellnessResourceDescription').value = resource.description || '';
                
                wellnessResources = wellnessResources.filter(r => r.id !== id);
                showAddWellnessResourceModal();
            }
        }
        
        function deleteWellnessResource(id) {
            if (confirm('Are you sure you want to delete this wellness resource?')) {
                wellnessResources = wellnessResources.filter(r => r.id !== id);
                localStorage.setItem('wellnessResources', JSON.stringify(wellnessResources));
                renderWellnessResourcesAdmin();
                addNotification('Wellness resource deleted', 'warning');
            }
        }

        // Wellness Program Storage (wellnessPrograms already declared on line 3181)
        wellnessPrograms = JSON.parse(localStorage.getItem('wellnessPrograms') || '[]');
        let wellnessResources = JSON.parse(localStorage.getItem('wellnessResources') || '[]');
        
        function showAddWellnessProgramModal() {
            new bootstrap.Modal(document.getElementById('addWellnessProgramModal')).show();
        }

        function saveWellnessProgram() {
            const name = document.getElementById('wellnessProgramName').value.trim();
            const category = document.getElementById('wellnessProgramCategory').value;
            const description = document.getElementById('wellnessProgramDescription').value.trim();
            const startDate = document.getElementById('wellnessProgramStartDate').value;
            const duration = document.getElementById('wellnessProgramDuration').value;
            const target = document.getElementById('wellnessProgramTarget').value;
            const maxParticipants = document.getElementById('wellnessProgramMaxParticipants').value;
            const facilitator = document.getElementById('wellnessProgramFacilitator').value.trim();
            const status = document.getElementById('wellnessProgramStatus').value;
            
            if (!name || !startDate || !description) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const program = {
                id: Date.now(),
                name,
                category,
                description,
                startDate,
                duration,
                target,
                maxParticipants,
                facilitator,
                status,
                participants: [],
                createdBy: currentUser.name,
                createdAt: new Date().toISOString()
            };
            
            wellnessPrograms.push(program);
            localStorage.setItem('wellnessPrograms', JSON.stringify(wellnessPrograms));
            
            // Clear form
            document.getElementById('wellnessProgramName').value = '';
            document.getElementById('wellnessProgramDescription').value = '';
            document.getElementById('wellnessProgramStartDate').value = '';
            document.getElementById('wellnessProgramDuration').value = '4';
            document.getElementById('wellnessProgramMaxParticipants').value = '20';
            document.getElementById('wellnessProgramFacilitator').value = '';
            
            bootstrap.Modal.getInstance(document.getElementById('addWellnessProgramModal')).hide();
            renderWellnessPrograms();
            addNotification('Wellness program added successfully!', 'success');
            logAudit('Wellness Program', `Added program: ${name}`, 'Low');
        }

        function showAddWellnessResourceModal() {
            new bootstrap.Modal(document.getElementById('addWellnessResourceModal')).show();
        }
        
        function saveWellnessResource() {
            const title = document.getElementById('wellnessResourceTitle').value.trim();
            const type = document.getElementById('wellnessResourceType').value;
            const category = document.getElementById('wellnessResourceCategory').value;
            const url = document.getElementById('wellnessResourceUrl').value.trim();
            const description = document.getElementById('wellnessResourceDescription').value.trim();
            
            if (!title || !url) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const resource = {
                id: Date.now(),
                title,
                type,
                category,
                url,
                description,
                views: 0,
                createdBy: currentUser.name,
                createdAt: new Date().toISOString()
            };
            
            wellnessResources.push(resource);
            localStorage.setItem('wellnessResources', JSON.stringify(wellnessResources));
            
            // Clear form
            document.getElementById('wellnessResourceTitle').value = '';
            document.getElementById('wellnessResourceUrl').value = '';
            document.getElementById('wellnessResourceDescription').value = '';
            
            bootstrap.Modal.getInstance(document.getElementById('addWellnessResourceModal')).hide();
            renderWellnessResourcesAdmin();
            addNotification('Wellness resource added successfully!', 'success');
            logAudit('Wellness Resource', `Added resource: ${title}`, 'Low');
        }

        function exportWellnessReport() {
            const report = {
                programs: wellnessPrograms,
                resources: wellnessResources,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wellness-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            addNotification('Wellness report exported successfully', 'success');
        }

        function viewWellnessProgram(id) {
            const program = wellnessPrograms.find(p => p.id === id);
            if (program) {
                alert(`Program: ${program.name}\nCategory: ${program.category}\nStart: ${program.startDate}\nDuration: ${program.duration} weeks\nStatus: ${program.status}\nParticipants: ${program.participants.length}/${program.maxParticipants}\n\n${program.description}`);
            }
        }

        function editWellnessProgram(id) {
            const program = wellnessPrograms.find(p => p.id === id);
            if (program) {
                document.getElementById('wellnessProgramName').value = program.name;
                document.getElementById('wellnessProgramCategory').value = program.category;
                document.getElementById('wellnessProgramDescription').value = program.description;
                document.getElementById('wellnessProgramStartDate').value = program.startDate;
                document.getElementById('wellnessProgramDuration').value = program.duration;
                document.getElementById('wellnessProgramTarget').value = program.target;
                document.getElementById('wellnessProgramMaxParticipants').value = program.maxParticipants;
                document.getElementById('wellnessProgramFacilitator').value = program.facilitator;
                document.getElementById('wellnessProgramStatus').value = program.status;
                
                // Remove old and save as new
                wellnessPrograms = wellnessPrograms.filter(p => p.id !== id);
                showAddWellnessProgramModal();
            }
        }

        function viewParticipantDetails(name) {
            addNotification('Viewing details for ' + name, 'info');
        }

        // Update mood value display
        document.addEventListener('DOMContentLoaded', function() {
            const moodInput = document.getElementById('moodInput');
            if (moodInput) {
                moodInput.addEventListener('input', function() {
                    document.getElementById('moodValue').textContent = this.value;
                });
            }
        });

        // Other functions remain the same as before...
        // (Include all other functions from the previous code, like renderAdmissions, saveAdmission, etc.)
        // For brevity, assuming they are included as in the initial code.
        // Add the teachers tabs event listener
        document.addEventListener('DOMContentLoaded', () => {
            const teachersTabs = document.querySelector('#teachersTabs');
            teachersTabs.addEventListener('shown.bs.tab', e => {
                const target = e.target.getAttribute('href');
                if (target === '#lesson-plans') renderLessonPlans();
                if (target === '#grading') renderGrading();
                if (target === '#resources') renderResources();
                if (target === '#student-progress') renderStudentProgress();
                if (target === '#upload-work') renderUploadWork();
                if (target === '#calendar') renderCalendar();
                if (target === '#hr-services') renderHRServices();
                if (target === '#employee-wellness') renderEmployeeWellness();
            });
            const hrTabs = document.querySelector('#hrTabs');
            hrTabs.addEventListener('shown.bs.tab', e => {
                const target = e.target.getAttribute('href');
                if (target === '#hr-staff') renderStaff();
                if (target === '#hr-payroll') renderPayrolls();
                if (target === '#hr-leaves') renderLeaves();
                if (target === '#hr-performance') renderReviews();
                if (target === '#hr-recruitment') renderJobs();
                if (target === '#hr-audit') renderAudit();
                if (target === '#hr-employee-wellness') renderEmployeeWellnessAdmin();
            });
            if (users.length === 0) {
                users = [
                    { username: 'admin', password: 'admin123', name: 'Admin User', role: 'Admin' },
                    { username: 'teacher', password: 'teacher123', name: 'Teacher User', role: 'Teacher' },
                    { username: 'parent', password: 'parent123', name: 'Parent User', role: 'Parent' },
                    { username: 'student', password: 'student123', name: 'Student User', role: 'Student' }
                ];
                saveData();
            }
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        });
        // Add notification function
        function addNotification(message, type = 'info') {
            const badge = document.getElementById('notificationBadge');
            const mobileBadge = document.getElementById('mobileNotificationBadge');
            let count = parseInt(badge.textContent) + 1 || 1;
            badge.textContent = count;
            badge.style.display = 'block';
            
            // Update mobile badge if it exists
            if (mobileBadge) {
                mobileBadge.textContent = count;
                mobileBadge.style.display = 'block';
            }
            
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            notifications.unshift({ id: Date.now(), message, type, timestamp: new Date().toISOString() });
            localStorage.setItem('notifications', JSON.stringify(notifications.slice(0, 50)));
        }
        // Render notifications
        document.getElementById('notificationsModal').addEventListener('show.bs.modal', () => {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            document.getElementById('notificationContent').innerHTML = notifications.length === 0 
                ? '<div class="alert alert-info">No notifications yet.</div>'
                : notifications.map(n => {
                    // Escape notification message to prevent XSS
                    const safeMessage = escapeHtml(n.message || '');
                    const alertType = n.type === 'success' ? 'success' : n.type === 'danger' ? 'danger' : n.type === 'warning' ? 'warning' : 'info';
                    return `<div class="alert alert-${alertType}">
                        ${safeMessage} <small>${new Date(n.timestamp).toLocaleString()}</small>
                    </div>`;
                }).join('');
            
            // Clear both badges
            document.getElementById('notificationBadge').style.display = 'none';
            const mobileBadge = document.getElementById('mobileNotificationBadge');
            if (mobileBadge) mobileBadge.style.display = 'none';
            
            localStorage.removeItem('notifications');
        });

                // Admission Management
        function showAddAdmissionModal() {
            showModal('addAdmissionModal');
        }
        function renderAdmissions() {
            // Update the report date in the caption
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10) + ' ' + now.toTimeString().slice(0, 5);
            document.getElementById('admissionReportDate').textContent = dateStr;
            
            const search = document.getElementById('admissionSearch').value.toLowerCase();
            const filtered = admissions.filter(a => {
                const surname = a.surname || a.name?.split(' ')[0] || '';
                const firstName = a.firstName || a.name?.split(' ').slice(1).join(' ') || '';
                const fullName = firstName + ' ' + surname;
                return surname.toLowerCase().includes(search) || 
                       firstName.toLowerCase().includes(search) || 
                       fullName.toLowerCase().includes(search) ||
                       (a.grade && a.grade.toLowerCase().includes(search));
            });
            document.getElementById('admissionTable').innerHTML = filtered.map(a => {
                const surname = a.surname || a.name?.split(' ')[0] || '';
                const firstName = a.firstName || a.name?.split(' ').slice(1).join(' ') || '';
                return `
                <tr>
                    <td>${a.accession || ''}</td>
                    <td>${surname}</td>
                    <td>${firstName}</td>
                    <td>${a.gender || ''}</td>
                    <td>${a.grade || ''}</td>
                    <td>${a.classValue || ''}</td>
                    <td>${a.cell || ''}</td>
                    <td>${a.email || ''}</td>
                    <td>${a.homeLanguage || ''}</td>
                    <td>${a.fatherName || ''}</td>
                    <td>${a.fatherSurname || ''}</td>
                    <td>${a.fatherEmail || ''}</td>
                    <td>${a.fatherCell || ''}</td>
                    <td>${a.motherName || ''}</td>
                    <td>${a.motherSurname || ''}</td>
                    <td>${a.motherEmail || ''}</td>
                    <td>${a.motherCell || ''}</td>
                    <td style="white-space:nowrap;">
                        <button class="btn btn-sm btn-info" onclick="viewAdmission(${a.id})" title="View"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-primary" onclick="editAdmission(${a.id})" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAdmission(${a.id})" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
        }
        function saveAdmission() {
            const accession = document.getElementById('admissionAccession').value;
            const surname = document.getElementById('admissionSurname').value;
            const firstName = document.getElementById('admissionFirstName').value;
            const gender = document.getElementById('admissionGender').value;
            const homeLanguage = document.getElementById('admissionHomeLanguage').value;
            const grade = document.getElementById('admissionGrade').value;
            const classValue = document.getElementById('admissionClass').value;
            const cell = document.getElementById('admissionCell').value;
            const email = document.getElementById('admissionEmail').value;
            const fatherName = document.getElementById('admissionFatherName').value;
            const fatherSurname = document.getElementById('admissionFatherSurname').value;
            const fatherEmail = document.getElementById('admissionFatherEmail').value;
            const fatherCell = document.getElementById('admissionFatherCell').value;
            const motherName = document.getElementById('admissionMotherName').value;
            const motherSurname = document.getElementById('admissionMotherSurname').value;
            const motherEmail = document.getElementById('admissionMotherEmail').value;
            const motherCell = document.getElementById('admissionMotherCell').value;
            const username = document.getElementById('admissionUsername').value.trim();
            const password = document.getElementById('admissionPassword').value.trim();
            const status = document.getElementById('admissionStatus').value;
            if (surname && firstName && grade) {
                const id = Date.now();
                const name = surname + ' ' + firstName;
                admissions.push({ 
                    id, name, surname, firstName, accession, grade, classValue, cell, email, 
                    username, password, status, gender, homeLanguage,
                    fatherName, fatherSurname, fatherEmail, fatherCell,
                    motherName, motherSurname, motherEmail, motherCell,
                    saSamsFormat: true
                });
                
                // Create student user account if username and password are provided
                if (username && password) {
                    const existingUser = users.find(u => u.username === username);
                    if (existingUser) {
                        addNotification('Username already exists. Please use a different username.', 'warning');
                    } else {
                        users.push({ 
                            username, 
                            password, 
                            name, 
                            role: 'Student' 
                        });
                        addNotification('Student login account created: ' + username, 'success');
                        logUserActivity(currentUser.username || currentUser.name, currentUser.role, 'Account Creation', `Created student account for ${name}`);
                    }
                }
                
                // Create parent accounts if parent information is available
                if (fatherEmail && fatherName && fatherSurname) {
                    const fatherUsername = 'parent_' + fatherSurname.toLowerCase() + '_' + fatherName.toLowerCase().charAt(0);
                    const fatherExists = users.find(u => u.username === fatherUsername);
                    if (!fatherExists) {
                        const fatherPassword = 'parent' + Math.floor(Math.random() * 10000);
                        users.push({
                            username: fatherUsername,
                            password: fatherPassword,
                            name: fatherName + ' ' + fatherSurname,
                            role: 'Parent',
                            linkedStudent: id,
                            linkedStudentName: name
                        });
                        addNotification('Parent account created for father: ' + fatherUsername + ' (Password: ' + fatherPassword + ')', 'success');
                        logUserActivity(currentUser.username || currentUser.name, currentUser.role, 'Account Creation', `Created parent account for ${fatherName} ${fatherSurname}`);
                    }
                }
                
                if (motherEmail && motherName && motherSurname) {
                    const motherUsername = 'parent_' + motherSurname.toLowerCase() + '_' + motherName.toLowerCase().charAt(0);
                    const motherExists = users.find(u => u.username === motherUsername);
                    if (!motherExists) {
                        const motherPassword = 'parent' + Math.floor(Math.random() * 10000);
                        users.push({
                            username: motherUsername,
                            password: motherPassword,
                            name: motherName + ' ' + motherSurname,
                            role: 'Parent',
                            linkedStudent: id,
                            linkedStudentName: name
                        });
                        addNotification('Parent account created for mother: ' + motherUsername + ' (Password: ' + motherPassword + ')', 'success');
                        logUserActivity(currentUser.username || currentUser.name, currentUser.role, 'Account Creation', `Created parent account for ${motherName} ${motherSurname}`);
                    }
                }
                
                // Auto-sync to Student Info
                if (status === 'approved' || status === 'Approved' || status === 'enrolled') {
                    syncAdmissionToStudentInfo(id);
                }
                
                saveData();
                renderAdmissions();
                safeHideModal('addAdmissionModal');
                addNotification('Admission saved with SA-Sams format and synced to Student Info', 'success');
                triggerDashboardUpdate();
            }
        }
        function editAdmission(id) {
            const adm = admissions.find(a => a.id === id);
            if (adm) {
                document.getElementById('admissionAccession').value = adm.accession || '';
                document.getElementById('admissionSurname').value = adm.surname || adm.name?.split(' ')[0] || '';
                document.getElementById('admissionFirstName').value = adm.firstName || adm.name?.split(' ').slice(1).join(' ') || '';
                document.getElementById('admissionGrade').value = adm.grade;
                document.getElementById('admissionUsername').value = adm.username || '';
                document.getElementById('admissionPassword').value = adm.password || '';
                document.getElementById('admissionStatus').value = adm.status;
                // Override save to update
                const saveBtn = document.querySelector('#addAdmissionModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => {
                    const oldUsername = adm.username;
                    const newUsername = document.getElementById('admissionUsername').value.trim();
                    const newPassword = document.getElementById('admissionPassword').value.trim();
                    
                    adm.accession = document.getElementById('admissionAccession').value;
                    adm.surname = document.getElementById('admissionSurname').value;
                    adm.firstName = document.getElementById('admissionFirstName').value;
                    adm.name = adm.surname + ' ' + adm.firstName;
                    adm.grade = document.getElementById('admissionGrade').value;
                    adm.username = newUsername;
                    adm.password = newPassword;
                    const newStatus = document.getElementById('admissionStatus').value;
                    const statusChanged = adm.status !== newStatus;
                    adm.status = newStatus;
                    
                    // Update or create user account for student
                    if (newUsername && newPassword) {
                        // Find existing user by old username or current username
                        let existingUser = users.find(u => u.username === oldUsername || u.username === newUsername);
                        
                        if (existingUser) {
                            // Update existing user credentials
                            existingUser.username = newUsername;
                            existingUser.password = newPassword;
                            existingUser.name = adm.name;
                            existingUser.role = 'Student';
                        } else {
                            // Create new user account
                            users.push({ 
                                username: newUsername, 
                                password: newPassword, 
                                name: adm.name, 
                                role: 'Student' 
                            });
                        }
                        
                        // Create parent accounts if parent information is available
                        if (adm.fatherEmail || adm.motherEmail) {
                            // Create father account if email exists and username doesn't exist yet
                            if (adm.fatherEmail && adm.fatherName && adm.fatherSurname) {
                                const fatherUsername = 'parent_' + adm.fatherSurname.toLowerCase() + '_' + adm.fatherName.toLowerCase().charAt(0);
                                const fatherExists = users.find(u => u.username === fatherUsername);
                                if (!fatherExists) {
                                    users.push({
                                        username: fatherUsername,
                                        password: 'parent' + Math.floor(Math.random() * 10000),
                                        name: adm.fatherName + ' ' + adm.fatherSurname,
                                        role: 'Parent',
                                        linkedStudent: adm.id
                                    });
                                    addNotification('Parent account created for father: ' + fatherUsername, 'success');
                                }
                            }
                            
                            // Create mother account if email exists and username doesn't exist yet
                            if (adm.motherEmail && adm.motherName && adm.motherSurname) {
                                const motherUsername = 'parent_' + adm.motherSurname.toLowerCase() + '_' + adm.motherName.toLowerCase().charAt(0);
                                const motherExists = users.find(u => u.username === motherUsername);
                                if (!motherExists) {
                                    users.push({
                                        username: motherUsername,
                                        password: 'parent' + Math.floor(Math.random() * 10000),
                                        name: adm.motherName + ' ' + adm.motherSurname,
                                        role: 'Parent',
                                        linkedStudent: adm.id
                                    });
                                    addNotification('Parent account created for mother: ' + motherUsername, 'success');
                                }
                            }
                        }
                        
                        addNotification('Student login credentials updated: ' + newUsername, 'success');
                        logUserActivity(currentUser.username || currentUser.name, currentUser.role, 'Credentials Update', `Updated login credentials for ${adm.name}`);
                    }
                    
                    // Auto-sync to Student Info if status changed to approved
                    if (statusChanged && (newStatus === 'approved' || newStatus === 'Approved' || newStatus === 'enrolled')) {
                        syncAdmissionToStudentInfo(adm.id);
                    }
                    
                    saveData();
                    renderAdmissions();
                    safeHideModal('addAdmissionModal');
                    saveBtn.textContent = 'Save';
                    saveBtn.onclick = saveAdmission;
                    addNotification('Admission updated and synced', 'success');
                    triggerDashboardUpdate();
                };
                // Safely show the modal using showModal function
                showModal('addAdmissionModal');
            }
        }
        function viewAdmission(id) {
            const adm = admissions.find(a => a.id === id);
            if (adm) {
                const surname = adm.surname || adm.name?.split(' ')[0] || '';
                const firstName = adm.firstName || adm.name?.split(' ').slice(1).join(' ') || '';
                const details = `
Admission Details:

LEARNER INFORMATION:
  Number: ${adm.accession || 'N/A'}
  Name: ${firstName} ${surname}
  Gender: ${adm.gender || 'N/A'}
  Grade: ${adm.grade || 'N/A'}
  Class: ${adm.classValue || 'N/A'}
  Cell: ${adm.cell || 'N/A'}
  Email: ${adm.email || 'N/A'}
  Home Language: ${adm.homeLanguage || 'N/A'}
  Status: ${adm.status || 'N/A'}

FATHER INFORMATION:
  Name: ${adm.fatherName || 'N/A'} ${adm.fatherSurname || ''}
  Email: ${adm.fatherEmail || 'N/A'}
  Cell: ${adm.fatherCell || 'N/A'}

MOTHER INFORMATION:
  Name: ${adm.motherName || 'N/A'} ${adm.motherSurname || ''}
  Email: ${adm.motherEmail || 'N/A'}
  Cell: ${adm.motherCell || 'N/A'}

ACCOUNT INFORMATION:
  Username: ${adm.username || 'N/A'}
  Password: ${adm.password ? '****** (hidden)' : 'N/A'}
`;
                alert(details);
            } else {
                addNotification('Admission not found', 'error');
            }
        }
        function deleteAdmission(id) {
            if (confirm('Delete admission?')) {
                admissions = admissions.filter(a => a.id !== id);
                saveData();
                renderAdmissions();
                addNotification('Admission deleted', 'danger');
            }
        }
        function viewAdmissionDocuments(id) {
            alert('Documents for admission ' + id + ' (mock)');
        }
        function searchAdmissions() {
            renderAdmissions();
        }
        function showBulkAdmissionModal() {
            showModal('bulkAdmissionModal');
        }
        
        // New Bophelong Bulk Import Algorithm - Using SheetJS with SA-SAMS Format
        // Helper: clean empty cells, undefined, etc.
        function cleanCell(val) {
            if (val === undefined || val === null || val === '') return '';
            return String(val).trim();
        }
        
        // Helper: find student by number, name, and optionally grade to avoid false positives
        function findStudentByLearner(learner) {
            return students.find(s => 
                // First try exact number match (most reliable)
                (s.accession === learner.number && learner.number) ||
                // Then try name + grade match for better accuracy
                (s.surname === learner.surname && s.firstName === learner.firstName && s.grade === learner.grade) ||
                // Finally try just name match (less reliable, but needed for imports without grade)
                (s.surname === learner.surname && s.firstName === learner.firstName)
            );
        }
        
        // Unified parser for SA-SAMS "Learner and Parent Info" Excel format
        function parseSASAMSFile(file, onSuccess) {
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // The data is usually in the first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON - expecting SA-SAMS format with title in row 1, headers in row 2
                    // header: 1 = treat rows as arrays (not as key-value objects)
                    // range: 1 = skip Excel row 1 (0-indexed), start reading from Excel row 2
                    const rawJson = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,     // treat every row as array
                        range: 1       // start from row 2 (0-indexed  skip title row)
                    });

                    // Headers are in row 1 of our rawJson (index 0)
                    const headers = rawJson[0];
                    const rows = rawJson.slice(1); // actual data starts from row 2 of file

                    const learners = [];

                    rows.forEach(row => {
                        // Map columns based on SA-SAMS file structure
                        const learner = {
                            number:         cleanCell(row[0]),
                            surname:        cleanCell(row[1]),
                            firstName:      cleanCell(row[2]),
                            gender:         cleanCell(row[3]),
                            grade:          cleanCell(row[4]),
                            class:          cleanCell(row[5]),
                            cell:           cleanCell(row[6]),
                            email:          cleanCell(row[7]),
                            language:       cleanCell(row[8]),

                            // Father
                            fatherName:     cleanCell(row[9]),
                            fatherSurname:  cleanCell(row[10]),
                            fatherEmail:    cleanCell(row[11]),
                            fatherCell:     cleanCell(row[12]),

                            // Mother
                            motherName:     cleanCell(row[13]),
                            motherSurname:  cleanCell(row[14]),
                            motherEmail:    cleanCell(row[15]),
                            motherCell:     cleanCell(row[16])
                        };

                        // Only push if there's at least a name or surname
                        if (learner.surname || learner.firstName) {
                            learners.push(learner);
                        }
                    });

                    // Call success callback with parsed data
                    onSuccess(learners);

                } catch (error) {
                    addNotification('Error parsing file: ' + error.message, 'danger');
                    console.error(error);
                }
            };

            reader.readAsArrayBuffer(file);
        }
        
        function uploadBulkAdmissions() {
            const file = document.getElementById('admissionsFile').files[0];
            if (!file) {
                addNotification('Please select a file', 'warning');
                return;
            }
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (fileExt !== 'xlsx' && fileExt !== 'xls') {
                addNotification('Please use SA-SAMS Excel format (.xlsx or .xls)', 'warning');
                return;
            }
            
            // Use the new SA-SAMS parser
            parseSASAMSFile(file, function(learners) {
                // Show result
                const resultHTML = `<div class="alert alert-info">
                    <strong> Import Summary:</strong><br>
                    <strong>${learners.length} learners successfully parsed!</strong>
                </div>`;
                
                // Preview table (SA-SAMS format)
                let previewHTML = resultHTML + `
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-striped" style="background: white; color: #333;">
                            <thead>
                                <tr style="background-color: #f2f2f2;">
                                    <th colspan="9" style="border: 1px solid #ddd; padding: 8px;">LEARNER DETAILS</th>
                                    <th colspan="4" style="border: 1px solid #ddd; padding: 8px;">FATHER DETAILS</th>
                                    <th colspan="4" style="border: 1px solid #ddd; padding: 8px;">MOTHER DETAILS</th>
                                </tr>
                                <tr style="background-color: #f2f2f2;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">Number</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Surname</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">First Name</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Gender</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Grade</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Class</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Cell#</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Email</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Language</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Surname</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Email</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Cell#</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Surname</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Email</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Cell#</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${learners.slice(0, 10).map(l => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.number}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.surname}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.firstName}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.gender}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.grade}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.class}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.cell}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.email}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.language}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.fatherName}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.fatherSurname}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.fatherEmail}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.fatherCell}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.motherName}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.motherSurname}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.motherEmail}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.motherCell}</td>
                                    </tr>
                                `).join('')}
                                ${learners.length > 10 ? `<tr><td colspan="17" style="text-align: center; padding: 8px;">...and ${learners.length - 10} more learners</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary mt-2" onclick='confirmAdmissionImport(${JSON.stringify(learners)})'>Import ${learners.length} Records</button>
                `;
                
                document.getElementById('admissionsPreview').innerHTML = previewHTML;
            });
        }
        
        function confirmAdmissionImport(records) {
            records.forEach(record => {
                const id = Date.now() + Math.random();
                const fullName = `${record.firstName} ${record.surname}`.trim();
                admissions.push({
                    id,
                    name: fullName,
                    surname: record.surname,
                    firstName: record.firstName,
                    accession: record.number,
                    gender: record.gender,
                    grade: record.grade,
                    classValue: record.class,
                    cell: record.cell,
                    email: record.email,
                    homeLanguage: record.language,
                    fatherName: record.fatherName,
                    fatherSurname: record.fatherSurname,
                    fatherEmail: record.fatherEmail,
                    fatherCell: record.fatherCell,
                    motherName: record.motherName,
                    motherSurname: record.motherSurname,
                    motherEmail: record.motherEmail,
                    motherCell: record.motherCell,
                    status: 'Pending',
                    username: '',
                    password: ''
                });
            });
            saveData();
            renderAdmissions();
            
            // Auto-sync approved admissions to Student Info
            syncAllApprovedAdmissions();
            
            hideModal('bulkAdmissionModal');
            addNotification(` Successfully imported ${records.length} admissions using SA-SAMS format`, 'success');
            logAudit('Bulk Import', `Imported ${records.length} admissions using SA-SAMS format`, 'Low');
            triggerDashboardUpdate();
        }
        
        function clearBulkAdmissionNotification() {
            // Clear the preview and file input
            document.getElementById('admissionsFile').value = '';
            document.getElementById('admissionsPreview').innerHTML = '';
            addNotification('Bulk admission import cleared', 'info');
        }
        
        // ========================================
        // SYNC ADMISSION TO STUDENT INFO AND ATTENDANCE
        // ========================================
        
        function syncAdmissionToStudentInfo(admissionId) {
            const admission = admissions.find(a => a.id === admissionId);
            if (!admission) {
                console.error('Admission not found:', admissionId);
                return false;
            }
            
            // Check if student already exists
            const existingStudent = students.find(s => 
                s.accession === admission.accession || 
                (s.name === admission.name && s.grade === admission.grade)
            );
            
            if (existingStudent) {
                console.log('Student already exists in Student Info:', existingStudent.name);
                return false;
            }
            
            // Create student record from admission
            const studentId = Date.now() + Math.random();
            const newStudent = {
                id: studentId,
                number: admission.accession || `STU-${studentId}`,
                name: admission.name || '',
                surname: admission.surname || (admission.name ? admission.name.split(' ')[0] : ''),
                firstName: admission.firstName || (admission.name ? admission.name.split(' ').slice(1).join(' ') : ''),
                gender: admission.gender || 'Not specified',
                grade: admission.grade,
                class: admission.classValue || admission.grade,
                cell: admission.cell || '',
                email: admission.email || '',
                language: admission.homeLanguage || 'English',
                fatherName: admission.fatherName || '',
                fatherSurname: admission.fatherSurname || '',
                fatherEmail: admission.fatherEmail || '',
                fatherCell: admission.fatherCell || '',
                motherName: admission.motherName || '',
                motherSurname: admission.motherSurname || '',
                motherEmail: admission.motherEmail || '',
                motherCell: admission.motherCell || '',
                status: 'Active',
                accession: admission.accession,
                username: admission.username,
                admissionId: admissionId,
                enrolledDate: new Date().toISOString().split('T')[0]
            };
            
            // Add to students array
            students.push(newStudent);
            
            // Initialize attendance record for the student
            const today = new Date().toISOString().split('T')[0];
            if (!attendanceRecords[today]) {
                attendanceRecords[today] = {};
            }
            
            // Mark as present for first day
            attendanceRecords[today][studentId] = {
                studentId: studentId,
                studentName: newStudent.name,
                status: 'Present',
                remarks: 'First day - Enrolled from admission',
                markedAt: new Date().toISOString()
            };
            
            // Save all data
            saveData();
            
            // Refresh relevant sections if they're visible
            if (!document.getElementById('students').classList.contains('d-none')) {
                renderStudents();
            }
            if (!document.getElementById('attendance').classList.contains('d-none')) {
                loadAttendance();
            }
            
            console.log('Student synced to Student Info and Attendance:', newStudent.name);
            addNotification(`Student ${newStudent.name} added to Student Info and Attendance`, 'success');
            
            // Log the sync action
            logAudit('Admission Sync', `Synced admission ${admission.name} to Student Info and Attendance`, 'Low');
            
            return true;
        }
        
        // Bulk sync all approved admissions
        function syncAllApprovedAdmissions() {
            const approvedAdmissions = admissions.filter(a => 
                a.status === 'approved' || a.status === 'Approved' || a.status === 'enrolled'
            );
            
            let syncedCount = 0;
            approvedAdmissions.forEach(admission => {
                if (syncAdmissionToStudentInfo(admission.id)) {
                    syncedCount++;
                }
            });
            
            if (syncedCount > 0) {
                addNotification(`Synced ${syncedCount} approved admissions to Student Info`, 'success');
                triggerDashboardUpdate();
            } else {
                addNotification('No new admissions to sync', 'info');
            }
        }

        // Student Management
        function showAddStudentModal() {
            new bootstrap.Modal(document.getElementById('addStudentModal')).show();
        }
        function renderStudents() {
            // Update report date
            const reportDateEl = document.getElementById('studentReportDate');
            if (reportDateEl) {
                reportDateEl.textContent = new Date().toLocaleDateString();
            }
            
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const filtered = students.filter(s => {
                const surname = s.surname || s.name?.split(' ')[0] || '';
                const firstName = s.firstName || s.name?.split(' ').slice(1).join(' ') || '';
                const accession = s.accession || '';
                return surname.toLowerCase().includes(search) || 
                       firstName.toLowerCase().includes(search) || 
                       accession.toLowerCase().includes(search) ||
                       ((s.grade || '').toLowerCase().includes(search));
            });
            document.getElementById('studentTable').innerHTML = filtered.map(s => {
                const surname = s.surname || s.name?.split(' ')[0] || '';
                const firstName = s.firstName || s.name?.split(' ').slice(1).join(' ') || '';
                const accession = s.accession || s.id || '';
                const studentClass = s.class || s.className || '';
                const cell = s.cell || s.contact || s.parentContact || '';
                const email = s.email || '';
                const language = s.homeLanguage || s.language || '';
                
                // Father details
                const fatherName = s.fatherName || s.parentName || '';
                const fatherSurname = s.fatherSurname || s.parentSurname || '';
                const fatherEmail = s.fatherEmail || '';
                const fatherCell = s.fatherCell || s.fatherContact || '';
                
                // Mother details
                const motherName = s.motherName || '';
                const motherSurname = s.motherSurname || '';
                const motherEmail = s.motherEmail || '';
                const motherCell = s.motherCell || s.motherContact || '';
                
                return `
                <tr>
                    <td>${accession}</td>
                    <td>${surname}</td>
                    <td>${firstName}</td>
                    <td>${s.gender || ''}</td>
                    <td>${s.grade || ''}</td>
                    <td>${studentClass}</td>
                    <td>${cell}</td>
                    <td>${email}</td>
                    <td>${language}</td>
                    <td>${fatherName}</td>
                    <td>${fatherSurname}</td>
                    <td>${fatherEmail}</td>
                    <td>${fatherCell}</td>
                    <td>${motherName}</td>
                    <td>${motherSurname}</td>
                    <td>${motherEmail}</td>
                    <td>${motherCell}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-sm btn-info me-1" onclick="viewStudentDetails(${s.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary me-1" onclick="editStudent(${s.id})" title="Edit Student">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent(${s.id})" title="Delete Student">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }
        function saveStudent() {
            const accession = document.getElementById('studentAccession').value;
            const surname = document.getElementById('studentSurname').value;
            const firstName = document.getElementById('studentFirstName').value;
            const idNumber = document.getElementById('studentIdNumber').value;
            const dateOfBirth = document.getElementById('studentDateOfBirth').value;
            const gender = document.getElementById('studentGender').value;
            const homeLanguage = document.getElementById('studentHomeLanguage').value;
            const grade = document.getElementById('studentGrade').value;
            const parent = document.getElementById('studentParent').value;
            const parentContact = document.getElementById('studentParentContact').value;
            const address = document.getElementById('studentAddress').value;
            const educator = document.getElementById('studentEducator').value;
            const status = document.getElementById('studentStatus').value;
            const username = document.getElementById('studentUsername').value;
            const password = document.getElementById('studentPassword').value;
            if (surname && firstName && grade) {
                const id = Date.now();
                const name = surname + ' ' + firstName;
                students.push({ 
                    id, name, surname, firstName, accession, grade, parent, status, educator,
                    idNumber, dateOfBirth, gender, homeLanguage, parentContact, address,
                    username, password,
                    saSamsFormat: true
                });
                saveData();
                renderStudents();
                integrateEducatorsAsStaff();
                safeHideModal('addStudentModal');
                addNotification('Student added with SA-Sams format', 'success');
                
                // Broadcast real-time sync to all devices
                if (typeof broadcastDataUpdate === 'function') {
                    broadcastDataUpdate('STUDENT_UPDATE', { action: 'add', studentName: name });
                }
            }
        }
        function editStudent(id) {
            const stu = students.find(s => s.id === id);
            if (stu) {
                document.getElementById('studentAccession').value = stu.accession || '';
                document.getElementById('studentSurname').value = stu.surname || stu.name?.split(' ')[0] || '';
                document.getElementById('studentFirstName').value = stu.firstName || stu.name?.split(' ').slice(1).join(' ') || '';
                document.getElementById('studentGrade').value = stu.grade;
                document.getElementById('studentParent').value = stu.parent;
                document.getElementById('studentEducator').value = stu.educator;
                document.getElementById('studentStatus').value = stu.status;
                document.getElementById('studentUsername').value = stu.username || '';
                document.getElementById('studentPassword').value = stu.password || '';
                // Override save to update
                const saveBtn = document.querySelector('#addStudentModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => {
                    stu.accession = document.getElementById('studentAccession').value;
                    stu.surname = document.getElementById('studentSurname').value;
                    stu.firstName = document.getElementById('studentFirstName').value;
                    stu.name = stu.surname + ' ' + stu.firstName;
                    stu.grade = document.getElementById('studentGrade').value;
                    stu.parent = document.getElementById('studentParent').value;
                    stu.educator = document.getElementById('studentEducator').value;
                    stu.status = document.getElementById('studentStatus').value;
                    stu.username = document.getElementById('studentUsername').value;
                    stu.password = document.getElementById('studentPassword').value;
                    saveData();
                    renderStudents();
                    safeHideModal('addStudentModal');
                    saveBtn.textContent = 'Save';
                    saveBtn.onclick = saveStudent;
                    addNotification('Student updated', 'success');
                    
                    // Broadcast real-time sync to all devices
                    if (typeof broadcastDataUpdate === 'function') {
                        broadcastDataUpdate('STUDENT_UPDATE', { action: 'update', studentName: stu.name });
                    }
                };
                showModal('addStudentModal');
            }
        }
        function deleteStudent(id) {
            if (confirm('Delete student?')) {
                const deletedStudent = students.find(s => s.id === id);
                students = students.filter(s => s.id !== id);
                saveData();
                renderStudents();
                addNotification('Student deleted', 'danger');
                
                // Broadcast real-time sync to all devices
                if (typeof broadcastDataUpdate === 'function') {
                    broadcastDataUpdate('STUDENT_UPDATE', { action: 'delete', studentName: deletedStudent ? deletedStudent.name : 'Student' });
                }
            }
        }
        function viewStudentDocuments(id) {
            alert('Documents for student ' + id + ' (mock)');
        }
        
        function viewStudentDetails(id) {
            const student = students.find(s => s.id === id);
            if (!student) {
                addNotification('Student not found', 'error');
                return;
            }
            
            const surname = student.surname || student.name?.split(' ')[0] || '';
            const firstName = student.firstName || student.name?.split(' ').slice(1).join(' ') || '';
            
            // Escape all user data to prevent XSS
            const safeData = {
                surname: escapeHtml(surname),
                firstName: escapeHtml(firstName),
                accession: escapeHtml(String(student.accession || student.id)),
                gender: escapeHtml(student.gender || 'N/A'),
                grade: escapeHtml(student.grade || 'N/A'),
                className: escapeHtml(student.class || student.className || 'N/A'),
                cell: escapeHtml(student.cell || student.contact || 'N/A'),
                email: escapeHtml(student.email || 'N/A'),
                language: escapeHtml(student.homeLanguage || student.language || 'N/A'),
                fatherName: escapeHtml(student.fatherName || student.parentName || 'N/A'),
                fatherSurname: escapeHtml(student.fatherSurname || student.parentSurname || 'N/A'),
                fatherEmail: escapeHtml(student.fatherEmail || 'N/A'),
                fatherCell: escapeHtml(student.fatherCell || student.fatherContact || 'N/A'),
                motherName: escapeHtml(student.motherName || 'N/A'),
                motherSurname: escapeHtml(student.motherSurname || 'N/A'),
                motherEmail: escapeHtml(student.motherEmail || 'N/A'),
                motherCell: escapeHtml(student.motherCell || student.motherContact || 'N/A')
            };
            
            // Create a modal to show student details with edit button
            const modalHtml = `
                <div class="modal fade" id="studentDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Learner Details - ${safeData.surname} ${safeData.firstName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><strong>Learner Information</strong></h6>
                                        <p><strong>Student Number:</strong> ${safeData.accession}</p>
                                        <p><strong>Surname:</strong> ${safeData.surname}</p>
                                        <p><strong>First Name:</strong> ${safeData.firstName}</p>
                                        <p><strong>Gender:</strong> ${safeData.gender}</p>
                                        <p><strong>Grade:</strong> ${safeData.grade}</p>
                                        <p><strong>Class:</strong> ${safeData.className}</p>
                                        <p><strong>Cell:</strong> ${safeData.cell}</p>
                                        <p><strong>Email:</strong> ${safeData.email}</p>
                                        <p><strong>Language:</strong> ${safeData.language}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><strong>Father Details</strong></h6>
                                        <p><strong>Name:</strong> ${safeData.fatherName}</p>
                                        <p><strong>Surname:</strong> ${safeData.fatherSurname}</p>
                                        <p><strong>Email:</strong> ${safeData.fatherEmail}</p>
                                        <p><strong>Cell:</strong> ${safeData.fatherCell}</p>
                                        <hr>
                                        <h6><strong>Mother Details</strong></h6>
                                        <p><strong>Name:</strong> ${safeData.motherName}</p>
                                        <p><strong>Surname:</strong> ${safeData.motherSurname}</p>
                                        <p><strong>Email:</strong> ${safeData.motherEmail}</p>
                                        <p><strong>Cell:</strong> ${safeData.motherCell}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="editStudent(${parseInt(id, 10)}); safeHideModal('studentDetailsModal');">
                                    <i class="fas fa-edit me-1"></i>Edit Learner
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('studentDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
            modal.show();
            
            // Clean up modal when hidden
            document.getElementById('studentDetailsModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
        function searchStudents() {
            renderStudents();
        }
        function showBulkStudentModal() {
            showModal('bulkStudentModal');
        }
        function uploadBulkStudents() {
            const file = document.getElementById('studentFile').files[0];
            if (!file) {
                addNotification('Please select a file', 'warning');
                return;
            }
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (fileExt !== 'xlsx' && fileExt !== 'xls') {
                addNotification('Please use SA-SAMS Excel format (.xlsx or .xls)', 'warning');
                return;
            }
            
            // Use the new SA-SAMS parser
            parseSASAMSFile(file, function(learners) {
                // Show result
                const resultHTML = `<div class="alert alert-info">
                    <strong> Import Summary:</strong><br>
                    <strong>${learners.length} learners successfully parsed!</strong>
                </div>`;
                
                // Preview table (SA-SAMS format)
                let previewHTML = resultHTML + `
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-striped" style="background: white; color: #333;">
                            <thead>
                                <tr style="background-color: #f2f2f2;">
                                    <th colspan="9" style="border: 1px solid #ddd; padding: 8px;">LEARNER DETAILS</th>
                                    <th colspan="4" style="border: 1px solid #ddd; padding: 8px;">FATHER DETAILS</th>
                                    <th colspan="4" style="border: 1px solid #ddd; padding: 8px;">MOTHER DETAILS</th>
                                </tr>
                                <tr style="background-color: #f2f2f2;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">Number</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Surname</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">First Name</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Gender</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Grade</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Class</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Cell#</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Email</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Language</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Surname</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Email</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Cell#</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Surname</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Email</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Cell#</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${learners.slice(0, 10).map(l => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.number}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.surname}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.firstName}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.gender}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.grade}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.class}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.cell}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.email}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.language}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.fatherName}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.fatherSurname}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.fatherEmail}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.fatherCell}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.motherName}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.motherSurname}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.motherEmail}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${l.motherCell}</td>
                                    </tr>
                                `).join('')}
                                ${learners.length > 10 ? `<tr><td colspan="17" style="text-align: center; padding: 8px;">...and ${learners.length - 10} more learners</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary mt-2" onclick='confirmStudentImport(${JSON.stringify(learners)})'>Import ${learners.length} Students</button>
                `;
                
                document.getElementById('studentPreview').innerHTML = previewHTML;
            });
        }
        
        function confirmStudentImport(records) {
            records.forEach(record => {
                const id = Date.now() + Math.random();
                const fullName = `${record.firstName} ${record.surname}`.trim();
                students.push({
                    id,
                    name: fullName,
                    surname: record.surname,
                    firstName: record.firstName,
                    gender: record.gender,
                    grade: record.grade,
                    class: record.class,
                    cell: record.cell,
                    email: record.email,
                    language: record.language,
                    fatherName: record.fatherName,
                    fatherSurname: record.fatherSurname,
                    fatherEmail: record.fatherEmail,
                    fatherCell: record.fatherCell,
                    motherName: record.motherName,
                    motherSurname: record.motherSurname,
                    motherEmail: record.motherEmail,
                    motherCell: record.motherCell,
                    status: 'Active',
                    accession: record.number,
                    educator: 'Unassigned',
                    parent: [
                        `${record.fatherName || ''} ${record.fatherSurname || ''}`.trim(),
                        `${record.motherName || ''} ${record.motherSurname || ''}`.trim()
                    ].filter(p => p && p.length > 0).join(' / ') || 'Unknown'
                });
            });
            saveData();
            renderStudents();
            integrateEducatorsAsStaff();
            hideModal('bulkStudentModal');
            addNotification(` Successfully imported ${records.length} students using SA-SAMS format`, 'success');
            logAudit('Bulk Import', `Imported ${records.length} students using SA-SAMS format`, 'Low');
        }
        function resetAllStudents() {
            if (confirm('Are you sure you want to reset ALL students? All student records will be saved to the vault and cleared from the system.')) {
                if (confirm('This is your final warning. Student data will be moved to vault. Continue?')) {
                    // Save to vault
                    const vaultEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'Student Reset',
                        description: `Reset ${students.length} student records`,
                        data: JSON.parse(JSON.stringify(students)),
                        user: currentUser ? currentUser.name : 'Unknown'
                    };
                    dataVault.push(vaultEntry);
                    
                    // Clear students
                    students = [];
                    
                    saveData();
                    renderStudents();
                    updateVaultMetrics();
                    addNotification('All students reset and saved to vault', 'warning');
                    logAudit('Student Reset', 'Reset all student records to vault', 'Medium');
                }
            }
        }

        // Attendance Management
        function loadAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const classFilter = document.getElementById('attendanceClass').value;
            const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
            const records = attendanceRecords[date] || {};
            document.getElementById('attendanceTable').innerHTML = filteredStudents.map(s => {
                const record = records[s.id] || { status: 'Absent' };
                const surname = s.surname || s.name?.split(' ')[0] || '';
                const firstName = s.firstName || s.name?.split(' ').slice(1).join(' ') || s.name || '';
                return `
                    <tr>
                        <td>${s.accession || s.id}</td>
                        <td>${surname}</td>
                        <td>${firstName}</td>
                        <td>${s.grade || ''}</td>
                        <td><span class="badge bg-${record.status === 'Present' ? 'success' : record.status === 'Late' ? 'warning' : 'danger'}">${record.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="showAttendanceModal(${s.id}, '${surname} ${firstName}')">Edit</button></td>
                    </tr>
                `;
            }).join('');
        }
        function showAttendanceModal(id, name) {
            document.getElementById('attendanceStudentId').value = id;
            document.getElementById('attendanceStudentName').textContent = name;
            document.getElementById('attendanceModalDate').value = document.getElementById('attendanceDate').value;
            new bootstrap.Modal(document.getElementById('attendanceModal')).show();
        }
        function saveAttendanceMark() {
            const studentId = document.getElementById('attendanceStudentId').value;
            const date = document.getElementById('attendanceModalDate').value;
            const status = document.getElementById('attendanceStatus').value;
            const notes = document.getElementById('attendanceNotes').value;
            if (!attendanceRecords[date]) attendanceRecords[date] = {};
            attendanceRecords[date][studentId] = { status, notes };
            saveData();
            loadAttendance();
            bootstrap.Modal.getInstance(document.getElementById('attendanceModal')).hide();
            addNotification('Attendance marked', 'success');
            
            // Broadcast real-time sync to all devices
            if (typeof broadcastDataUpdate === 'function') {
                broadcastDataUpdate('ATTENDANCE_UPDATE', { action: 'mark', date: date, status: status });
            }
        }
        // Mark All Present Functions
        function markAllPresent() {
            // Populate class select from students
            const classes = [...new Set(students.map(s => s.grade).filter(Boolean))].sort();
            document.getElementById('markAllPresentClass').innerHTML = '<option value="">All Classes</option>' + 
                classes.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // Set default date to today
            document.getElementById('markAllPresentDate').value = new Date().toISOString().split('T')[0];
            
            // Update preview
            updateMarkAllPresentPreview();
            
            new bootstrap.Modal(document.getElementById('markAllPresentModal')).show();
        }
        
        function updateMarkAllPresentPreview() {
            const classFilter = document.getElementById('markAllPresentClass').value;
            const date = document.getElementById('markAllPresentDate').value;
            const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
            
            const previewEl = document.getElementById('markAllPresentPreview');
            if (filteredStudents.length > 0) {
                previewEl.innerHTML = `
                    <div class="text-success">
                        <i class="fas fa-users me-2"></i><strong>${filteredStudents.length}</strong> students will be marked as <span class="badge bg-success">Present</span> on <strong>${date || 'selected date'}</strong>
                    </div>
                `;
            } else {
                previewEl.innerHTML = `<div class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>No students found for the selected criteria.</div>`;
            }
        }
        
        function confirmMarkAllPresent() {
            const date = document.getElementById('markAllPresentDate').value;
            const classFilter = document.getElementById('markAllPresentClass').value;
            
            if (!date) {
                addNotification('Please select a date', 'warning');
                return;
            }
            
            const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
            
            if (filteredStudents.length === 0) {
                addNotification('No students found for the selected criteria', 'warning');
                return;
            }
            
            if (!attendanceRecords[date]) attendanceRecords[date] = {};
            
            filteredStudents.forEach(s => {
                attendanceRecords[date][s.id] = { status: 'Present', notes: 'Marked via Mark All Present' };
            });
            
            saveData();
            loadAttendance();
            bootstrap.Modal.getInstance(document.getElementById('markAllPresentModal')).hide();
            addNotification(` Successfully marked ${filteredStudents.length} students as Present for ${date}`, 'success');
            logAudit('Mark All Present', `Marked ${filteredStudents.length} students present for ${date}${classFilter ? ` (${classFilter})` : ''}`, 'Medium');
            
            // Broadcast real-time sync to all devices
            if (typeof broadcastDataUpdate === 'function') {
                broadcastDataUpdate('ATTENDANCE_UPDATE', { action: 'bulk_mark', date: date, count: filteredStudents.length });
            }
        }
        
        // Add event listeners for preview updates
        document.getElementById('markAllPresentDate')?.addEventListener('change', updateMarkAllPresentPreview);
        document.getElementById('markAllPresentClass')?.addEventListener('change', updateMarkAllPresentPreview);
        
        function showBulkAttendanceModal() {
            // Redirect to new Mark All Present function for backward compatibility
            markAllPresent();
        }
        function bulkMarkAttendance() {
            // Redirect to new function for backward compatibility
            confirmMarkAllPresent();
        }
        
        function showImportAttendanceModal() {
            showModal('importAttendanceModal');
        }
        
        function uploadBulkAttendance() {
            const file = document.getElementById('attendanceFile').files[0];
            if (!file) {
                addNotification('Please select a file', 'warning');
                return;
            }
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (fileExt !== 'xlsx' && fileExt !== 'xls') {
                addNotification('Please use SA-SAMS Excel format (.xlsx or .xls)', 'warning');
                return;
            }
            
            // Use the new SA-SAMS parser
            parseSASAMSFile(file, function(learners) {
                // For attendance, we'll mark all imported learners as present for today
                const today = new Date().toISOString().split('T')[0];
                const matchedRecords = [];
                
                learners.forEach(learner => {
                    const student = findStudentByLearner(learner);
                    
                    if (student) {
                        matchedRecords.push({
                            studentId: student.id,
                            studentName: `${learner.firstName} ${learner.surname}`,
                            date: today,
                            status: 'Present',
                            notes: 'Imported from SA-SAMS'
                        });
                    }
                });
                
                // Show result
                const resultHTML = `<div class="alert alert-info">
                    <strong> Import Summary:</strong><br>
                    Total learners in file: ${learners.length}<br>
                    Matched students: ${matchedRecords.length}<br>
                    Unmatched: ${learners.length - matchedRecords.length}
                </div>`;
                
                let previewHTML = resultHTML;
                
                if (matchedRecords.length > 0) {
                    previewHTML += `
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped" style="background: white; color: #333;">
                                <thead>
                                    <tr style="background-color: #f2f2f2;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Student</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${matchedRecords.slice(0, 20).map(r => `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${r.studentName}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${r.date}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${r.status}</td>
                                        </tr>
                                    `).join('')}
                                    ${matchedRecords.length > 20 ? `<tr><td colspan="3" style="text-align: center; padding: 8px;">...and ${matchedRecords.length - 20} more</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-primary mt-2" onclick='confirmAttendanceImport(${JSON.stringify(matchedRecords)})'>Import ${matchedRecords.length} Attendance Records</button>
                    `;
                }
                
                document.getElementById('attendancePreview').innerHTML = previewHTML;
            });
        }
        
        function confirmAttendanceImport(records) {
            let importedCount = 0;
            records.forEach(record => {
                if (!attendanceRecords[record.date]) {
                    attendanceRecords[record.date] = {};
                }
                attendanceRecords[record.date][record.studentId] = {
                    status: record.status,
                    notes: record.notes
                };
                importedCount++;
            });
            saveData();
            loadAttendance();
            hideModal('importAttendanceModal');
            addNotification(` Successfully imported ${importedCount} attendance records using SA-SAMS format`, 'success');
            logAudit('Bulk Import', `Imported ${importedCount} attendance records using SA-SAMS format`, 'Low');
        }
        function syncBiometricAttendance() {
            addNotification('Biometric sync simulated', 'info');
            // Mock sync
            const today = new Date().toISOString().split('T')[0];
            if (!attendanceRecords[today]) attendanceRecords[today] = {};
            students.forEach(s => {
                if (!attendanceRecords[today][s.id]) {
                    attendanceRecords[today][s.id] = { status: Math.random() > 0.2 ? 'Present' : 'Absent' };
                }
            });
            saveData();
            loadAttendance();
        }
        
        function resetAttendance() {
            if (confirm('Are you sure you want to reset attendance? All attendance records will be saved to the vault and cleared from the system.')) {
                if (confirm('This is your final warning. Attendance data will be moved to vault. Continue?')) {
                    // Save to vault
                    const vaultEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'Attendance Reset',
                        description: `Reset ${Object.keys(attendanceRecords).length} days of attendance records`,
                        data: JSON.parse(JSON.stringify(attendanceRecords)),
                        user: currentUser ? currentUser.name : 'Unknown'
                    };
                    dataVault.push(vaultEntry);
                    
                    // Clear attendance
                    attendanceRecords = {};
                    
                    saveData();
                    loadAttendance();
                    updateVaultMetrics();
                    addNotification('Attendance reset and saved to vault', 'warning');
                    logAudit('Attendance Reset', 'Reset all attendance records to vault', 'Medium');
                }
            }
        }

        // Fee Management
        function renderFees() {
            const search = document.getElementById('feeSearch').value.toLowerCase();
            const filtered = fees.filter(f => 
                students.find(s => s.id === f.studentId)?.name.toLowerCase().includes(search) || search === ''
            );
            document.getElementById('feeTable').innerHTML = filtered.map(f => {
                const student = students.find(s => s.id === f.studentId);
                return `
                    <tr>
                        <td>${student ? student.name : 'Unknown'}</td>
                        <td>R${f.amount.toLocaleString()}</td>
                        <td>${f.dueDate}</td>
                        <td>${f.paidDate || ''}</td>
                        <td><span class="badge bg-${f.status === 'Paid' ? 'success' : 'Pending' ? 'warning' : 'danger'}">${f.status}</span></td>
                        <td><button class="btn btn-sm btn-success" onclick="generateReceipt(${f.id})">Receipt</button></td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewFeeDetails(${f.id})" title="View Details">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-primary me-1" onclick="editFee(${f.id})" title="Edit Fee">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFee(${f.id})" title="Delete Fee">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            // Metrics
            const totalCollected = fees.filter(f => f.status === 'Paid').reduce((sum, f) => sum + f.amount, 0);
            const outstanding = fees.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
            const overdue = fees.filter(f => f.status === 'Pending' && new Date(f.dueDate) < new Date()).reduce((sum, f) => sum + f.amount, 0);
            const paymentRate = fees.length > 0 ? Math.round((totalCollected / (totalCollected + outstanding)) * 100) : 0;
            document.getElementById('totalCollected').textContent = 'R' + totalCollected.toLocaleString();
            document.getElementById('outstandingFees').textContent = 'R' + outstanding.toLocaleString();
            document.getElementById('overdueFees').textContent = 'R' + overdue.toLocaleString();
            document.getElementById('paymentRate').textContent = paymentRate + '%';
            // History
            document.getElementById('feeHistory').innerHTML = fees.slice(-5).map(f => `
                <div class="report-card">
                    <strong>${students.find(s => s.id === f.studentId)?.name}</strong>: R${f.amount} - ${f.status} on ${f.paidDate || f.dueDate}
                </div>
            `).join('');
        }
        function showGenerateInvoiceModal() {
            document.getElementById('invoiceStudent').innerHTML = students.map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('');
            new bootstrap.Modal(document.getElementById('generateInvoiceModal')).show();
        }
        function saveInvoice() {
            const studentId = document.getElementById('invoiceStudent').value;
            const amount = parseFloat(document.getElementById('invoiceAmount').value);
            const dueDate = document.getElementById('invoiceDueDate').value;
            const description = document.getElementById('invoiceDescription').value;
            if (studentId && amount && dueDate) {
                const id = Date.now();
                fees.push({ id, studentId, amount, dueDate, description, status: 'Pending', paidDate: '' });
                saveData();
                renderFees();
                bootstrap.Modal.getInstance(document.getElementById('generateInvoiceModal')).hide();
                addNotification('Invoice generated', 'success');
            }
        }
        function editFee(id) {
            const fee = fees.find(f => f.id === id);
            if (!fee) {
                addNotification('Fee not found', 'error');
                return;
            }
            
            const student = students.find(s => s.id === fee.studentId);
            const newAmount = prompt(`Edit Amount for ${student ? student.name : 'Unknown'} (Current: R${fee.amount}):`, fee.amount);
            
            if (newAmount === null) return; // User cancelled
            
            const parsedAmount = parseFloat(newAmount);
            if (isNaN(parsedAmount) || parsedAmount <= 0) {
                addNotification('Invalid amount entered', 'error');
                return;
            }
            
            const newDueDate = prompt(`Edit Due Date (YYYY-MM-DD format, Current: ${fee.dueDate}):`, fee.dueDate);
            if (newDueDate === null) return; // User cancelled
            
            // Validate date format
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateRegex.test(newDueDate)) {
                addNotification('Invalid date format. Please use YYYY-MM-DD format.', 'error');
                return;
            }
            
            const newStatus = prompt(`Edit Status (Current: ${fee.status})\nOptions: Paid, Pending, Overdue:`, fee.status);
            if (newStatus === null) return; // User cancelled
            
            // Validate status
            const validStatuses = ['Paid', 'Pending', 'Overdue'];
            if (!validStatuses.includes(newStatus)) {
                addNotification('Invalid status. Must be Paid, Pending, or Overdue.', 'error');
                return;
            }
            
            // Update the fee
            fee.amount = parsedAmount;
            fee.dueDate = newDueDate;
            fee.status = newStatus;
            
            if (newStatus === 'Paid' && !fee.paidDate) {
                fee.paidDate = new Date().toISOString().split('T')[0];
            }
            
            saveData();
            renderFees();
            addNotification('Fee updated successfully', 'success');
            logAudit('Edit Fee', `Edited fee for ${student ? student.name : 'Unknown'}`, 'Medium');
        }
        
        function deleteFee(id) {
            const fee = fees.find(f => f.id === id);
            if (!fee) {
                addNotification('Fee not found', 'error');
                return;
            }
            
            const student = students.find(s => s.id === fee.studentId);
            const confirmDelete = confirm(`Are you sure you want to delete the fee record for ${student ? student.name : 'Unknown'} (R${fee.amount})?`);
            
            if (!confirmDelete) return;
            
            const index = fees.findIndex(f => f.id === id);
            if (index > -1) {
                fees.splice(index, 1);
                saveData();
                renderFees();
                addNotification('Fee deleted successfully', 'success');
                logAudit('Delete Fee', `Deleted fee for ${student ? student.name : 'Unknown'}`, 'High');
            }
        }
        
        function viewFeeDetails(id) {
            const fee = fees.find(f => f.id === id);
            if (!fee) {
                addNotification('Fee not found', 'error');
                return;
            }
            
            const student = students.find(s => s.id === fee.studentId);
            const details = `
Fee Details:

Fee ID: ${fee.id}
Student: ${student ? student.name : 'Unknown'}
Grade: ${student ? student.grade : 'N/A'}
Amount: R${fee.amount.toLocaleString()}
Due Date: ${fee.dueDate}
Paid Date: ${fee.paidDate || 'Not paid yet'}
Status: ${fee.status}
Description: ${fee.description || 'N/A'}
Created: ${fee.createdAt || 'N/A'}

            `;
            
            alert(details.trim());
        }
        function generateReceipt(id) {
            const fee = fees.find(f => f.id === id);
            if (fee) {
                const student = students.find(s => s.id === fee.studentId);
                const receipt = `
                    <div class="payslip-preview">
                        <h4>Receipt #${id}</h4>
                        <p>Student: ${student.name}</p>
                        <p>Amount: R${fee.amount}</p>
                        <p>Date: ${new Date().toLocaleDateString()}</p>
                    </div>
                `;
                document.body.innerHTML += `<div class="modal fade" id="receiptModal"><div class="modal-dialog"><div class="modal-content">${receipt}</div></div></div>`;
                new bootstrap.Modal(document.getElementById('receiptModal')).show();
            }
        }
        function searchFees() {
            renderFees();
        }
        function showBulkUploadFeesModal() {
            showModal('bulkUploadFeesModal');
        }
        function uploadBulkFees() {
            const file = document.getElementById('feesFile').files[0];
            if (!file) {
                addNotification('Please select a file', 'warning');
                return;
            }
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (fileExt !== 'xlsx' && fileExt !== 'xls') {
                addNotification('Please use SA-SAMS Excel format (.xlsx or .xls)', 'warning');
                return;
            }
            
            // Use the new SA-SAMS parser
            parseSASAMSFile(file, function(learners) {
                // Create fee records for each learner
                const feeRecords = [];
                const defaultFeeAmount = 5000; // Default annual fee
                const defaultDueDate = new Date(new Date().getFullYear(), 11, 31).toISOString().split('T')[0]; // End of year
                
                learners.forEach(learner => {
                    const student = findStudentByLearner(learner);
                    
                    if (student) {
                        feeRecords.push({
                            studentId: student.id,
                            studentName: `${learner.firstName} ${learner.surname}`,
                            amount: defaultFeeAmount,
                            dueDate: defaultDueDate,
                            description: 'Annual School Fees',
                            status: 'Pending'
                        });
                    }
                });
                
                // Show result
                const resultHTML = `<div class="alert alert-info">
                    <strong> Import Summary:</strong><br>
                    Total learners in file: ${learners.length}<br>
                    Matched students: ${feeRecords.length}<br>
                    Unmatched: ${learners.length - feeRecords.length}
                </div>`;
                
                let previewHTML = resultHTML;
                
                if (feeRecords.length > 0) {
                    previewHTML += `
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped" style="background: white; color: #333;">
                                <thead>
                                    <tr style="background-color: #f2f2f2;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Student</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Due Date</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${feeRecords.slice(0, 20).map(r => `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${r.studentName}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">R${r.amount.toLocaleString()}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${r.dueDate}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${r.status}</td>
                                        </tr>
                                    `).join('')}
                                    ${feeRecords.length > 20 ? `<tr><td colspan="4" style="text-align: center; padding: 8px;">...and ${feeRecords.length - 20} more</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-primary mt-2" onclick='confirmFeesImport(${JSON.stringify(feeRecords)})'>Import ${feeRecords.length} Fee Records</button>
                    `;
                }
                
                document.getElementById('feesPreview').innerHTML = previewHTML;
            });
        }
        
        function confirmFeesImport(records) {
            records.forEach(record => {
                const id = Date.now() + Math.random();
                fees.push({
                    id,
                    studentId: record.studentId,
                    amount: record.amount,
                    dueDate: record.dueDate,
                    description: record.description,
                    status: record.status,
                    paidDate: ''
                });
            });
            saveData();
            renderFees();
            hideModal('bulkUploadFeesModal');
            addNotification(` Successfully imported ${records.length} fee records using SA-SAMS format`, 'success');
            logAudit('Bulk Import', `Imported ${records.length} fee records using SA-SAMS format`, 'Low');
        }
        function sendFeeReminders() {
            // Get all pending and overdue fees
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const overdue = fees.filter(f => {
                const dueDate = new Date(f.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return f.status === 'Pending' && dueDate < today;
            });
            
            // Also include fees that are due soon (within 7 days)
            const dueSoon = fees.filter(f => {
                const dueDate = new Date(f.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                const sevenDaysFromNow = new Date(today);
                sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
                return f.status === 'Pending' && dueDate >= today && dueDate <= sevenDaysFromNow;
            });
            
            const allReminders = [...overdue, ...dueSoon];
            
            if (allReminders.length === 0) {
                addNotification('No pending or overdue fees to send reminders for', 'info');
                return;
            }
            
            let successCount = 0;
            let failCount = 0;
            let overdueCount = 0;
            let dueSoonCount = 0;
            
            allReminders.forEach(f => {
                const student = students.find(s => s.id === f.studentId);
                if (student) {
                    const isOverdue = overdue.includes(f);
                    const daysOverdue = isOverdue ? Math.floor((today - new Date(f.dueDate)) / (1000 * 60 * 60 * 24)) : 0;
                    const daysDue = !isOverdue ? Math.ceil((new Date(f.dueDate) - today) / (1000 * 60 * 60 * 24)) : 0;
                    
                    // Create a detailed reminder record
                    const reminder = {
                        id: Date.now() + Math.random(),
                        feeId: f.id,
                        studentId: f.studentId,
                        studentName: student.name || `${student.firstName} ${student.surname}`,
                        parentEmail: student.fatherEmail || student.motherEmail || 'N/A',
                        parentCell: student.fatherCell || student.motherCell || 'N/A',
                        amount: f.amount,
                        dueDate: f.dueDate,
                        sentDate: new Date().toISOString(),
                        sentTime: new Date().toLocaleTimeString(),
                        method: 'Email & SMS',
                        status: 'sent',
                        reminderType: isOverdue ? 'overdue' : 'due-soon',
                        daysOverdue: daysOverdue,
                        daysDue: daysDue,
                        priority: isOverdue ? (daysOverdue > 30 ? 'urgent' : 'high') : 'normal',
                        message: isOverdue 
                            ? `OVERDUE: Payment of R${f.amount} was due on ${f.dueDate} (${daysOverdue} days overdue). Please settle immediately.`
                            : `REMINDER: Payment of R${f.amount} is due on ${f.dueDate} (in ${daysDue} days). Please ensure timely payment.`
                    };
                    
                    // Store reminder in localStorage
                    let reminders = JSON.parse(localStorage.getItem('feeReminders') || '[]');
                    reminders.push(reminder);
                    localStorage.setItem('feeReminders', JSON.stringify(reminders));
                    
                    // Update fee record to show reminder was sent
                    f.lastReminderSent = new Date().toISOString();
                    f.reminderCount = (f.reminderCount || 0) + 1;
                    f.lastReminderType = reminder.reminderType;
                    f.reminderHistory = f.reminderHistory || [];
                    f.reminderHistory.push({
                        date: new Date().toISOString(),
                        type: reminder.reminderType,
                        priority: reminder.priority
                    });
                    
                    successCount++;
                    if (isOverdue) overdueCount++;
                    else dueSoonCount++;
                    
                    // Add individual notification with details
                    const studentName = student.name || `${student.firstName} ${student.surname}`;
                    const priorityIcon = reminder.priority === 'urgent' ? '' : reminder.priority === 'high' ? '' : '';
                    addNotification(
                        `${priorityIcon} ${reminder.reminderType.toUpperCase()}: ${studentName} - R${f.amount} (${isOverdue ? `${daysOverdue} days overdue` : `due in ${daysDue} days`})`,
                        isOverdue ? 'warning' : 'info'
                    );
                } else {
                    failCount++;
                }
            });
            
            // Save updated fees
            saveData();
            renderFees();
            
            // Enhanced summary notification with breakdown
            let summaryMsg = ` ${successCount} fee reminder(s) sent successfully!\n`;
            if (overdueCount > 0) summaryMsg += `   - ${overdueCount} OVERDUE reminders\n`;
            if (dueSoonCount > 0) summaryMsg += `   - ${dueSoonCount} DUE SOON reminders\n`;
            summaryMsg += ` Sent via Email & SMS to parents`;
            
            addNotification(summaryMsg, 'success');
            logAudit('Send Fee Reminders', `Sent ${successCount} fee reminders (${overdueCount} overdue, ${dueSoonCount} due soon)`, 'Medium');
            
            if (failCount > 0) {
                addNotification(` ${failCount} reminder(s) failed (student not found)`, 'warning');
            }
            
            // Show detailed summary modal
            const reminderSummary = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Fee Reminders Sent Successfully!</h5>
                    <hr>
                    <p><strong>Total Reminders Sent:</strong> ${successCount}</p>
                    <p><strong>Overdue Fees:</strong> ${overdueCount}</p>
                    <p><strong>Due Soon (Next 7 Days):</strong> ${dueSoonCount}</p>
                    <p><strong>Failed:</strong> ${failCount}</p>
                    <hr>
                    <p><small> Tip: Reminders include payment details and are sent to parent email and mobile numbers.</small></p>
                </div>
            `;
            
            setTimeout(() => {
                if (confirm(summaryMsg + '\n\nWould you like to view the detailed reminder log?')) {
                    const reminders = JSON.parse(localStorage.getItem('feeReminders') || '[]');
                    const recentReminders = reminders.slice(-10).reverse();
                    let logHtml = '<h5>Recent Reminders Sent:</h5><ul>';
                    recentReminders.forEach(r => {
                        logHtml += `<li>${r.sentDate} - ${r.studentName}: ${r.message}</li>`;
                    });
                    logHtml += '</ul>';
                    alert(logHtml.replace(/<[^>]*>/g, '\n'));
                }
            }, 1500);
        }
        
        function resetFees() {
            if (confirm('Are you sure you want to reset all fees? All fee records will be saved to the vault and cleared from the system.')) {
                if (confirm('This is your final warning. Fee data will be moved to vault. Continue?')) {
                    // Save to vault
                    const vaultEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'Fee Reset',
                        description: `Reset ${fees.length} fee records`,
                        data: JSON.parse(JSON.stringify(fees)),
                        user: currentUser ? currentUser.name : 'Unknown'
                    };
                    dataVault.push(vaultEntry);
                    
                    // Clear fees
                    fees = [];
                    
                    saveData();
                    renderFees();
                    updateVaultMetrics();
                    addNotification('Fees reset and saved to vault', 'warning');
                    logAudit('Fee Reset', 'Reset all fee records to vault', 'Medium');
                }
            }
        }
        
        function resetAdmissions() {
            if (confirm('Are you sure you want to reset all admissions? All admission records will be saved to the vault and cleared from the system.')) {
                if (confirm('This is your final warning. Admission data will be moved to vault. Continue?')) {
                    // Save to vault
                    const vaultEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'Admission Reset',
                        description: `Reset ${admissions.length} admission records`,
                        data: JSON.parse(JSON.stringify(admissions)),
                        user: currentUser ? currentUser.name : 'Unknown'
                    };
                    dataVault.push(vaultEntry);
                    
                    // Clear admissions
                    admissions = [];
                    
                    saveData();
                    renderAdmissions();
                    updateVaultMetrics();
                    addNotification('Admissions reset and saved to vault', 'warning');
                    logAudit('Admission Reset', 'Reset all admission records to vault', 'Medium');
                }
            }
        }

        // Timetable Management
        function loadTimetable() {
            const grade = document.getElementById('timetableGrade').value;
            if (!grade) return;
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            let table = '<table class="table"><thead><tr><th>Time</th>' + days.map(d => `<th>${d}</th>`).join('') + '</tr></thead><tbody>';
            const times = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00'];
            times.forEach(time => {
                table += `<tr><td>${time}</td>`;
                days.forEach(day => {
                    const slot = timetable[grade]?.[day]?.[time] || '';
                    table += `<td class="timetable-cell editable" onclick="editTimeSlot('${grade}', '${day}', '${time}')">${slot}</td>`;
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            document.getElementById('timetableContainer').innerHTML = table;
        }
        function showAddTimeSlotModal() {
            document.getElementById('timeSlotGrade').innerHTML = [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            new bootstrap.Modal(document.getElementById('addTimeSlotModal')).show();
        }
        function saveTimeSlot() {
            const grade = document.getElementById('timeSlotGrade').value;
            const day = document.getElementById('timeSlotDay').value;
            const time = document.getElementById('timeSlotTime').value;
            const subject = document.getElementById('timeSlotSubject').value;
            if (!timetable[grade]) timetable[grade] = {};
            if (!timetable[grade][day]) timetable[grade][day] = {};
            timetable[grade][day][time] = subject;
            saveData();
            loadTimetable();
            bootstrap.Modal.getInstance(document.getElementById('addTimeSlotModal')).hide();
            addNotification('Time slot added', 'success');
        }
        function editTimeSlot(grade, day, time) {
            document.getElementById('timeSlotGrade').value = grade;
            document.getElementById('timeSlotDay').value = day;
            document.getElementById('timeSlotTime').value = time;
            document.getElementById('timeSlotSubject').value = timetable[grade][day][time] || '';
            // Override to update
            const saveBtn = document.querySelector('#addTimeSlotModal .btn-primary');
            saveBtn.textContent = 'Update';
            saveBtn.onclick = () => {
                timetable[grade][day][time] = document.getElementById('timeSlotSubject').value;
                saveData();
                loadTimetable();
                bootstrap.Modal.getInstance(document.getElementById('addTimeSlotModal')).hide();
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveTimeSlot;
                addNotification('Time slot updated', 'success');
            };
            new bootstrap.Modal(document.getElementById('addTimeSlotModal')).show();
        }
        function checkTimetableConflicts() {
            // Mock conflict check
            addNotification('No conflicts found (mock)', 'success');
        }
        function highlightTeacherSchedule() {
            const teacher = document.getElementById('timetableTeacher').value;
            if (teacher) {
                // Highlight cells with teacher
                document.querySelectorAll('.timetable-cell').forEach(cell => {
                    if (cell.textContent.includes(teacher)) {
                        cell.style.background = 'rgba(255, 255, 0, 0.3)';
                    }
                });
            }
        }

        // Examination Management
        function renderExams() {
            const gradeFilter = document.getElementById('examGradeFilter').value;
            const subjectFilter = document.getElementById('examSubjectFilter').value.toLowerCase();
            const filtered = exams.filter(e => 
                (!gradeFilter || e.grade === gradeFilter) && 
                (!subjectFilter || e.subject.toLowerCase().includes(subjectFilter))
            );
            document.getElementById('examTable').innerHTML = filtered.map(e => `
                <tr>
                    <td>${e.name}</td>
                    <td>${e.date}</td>
                    <td>${e.subject}</td>
                    <td>${e.grade}</td>
                    <td><span class="badge bg-${e.status === 'Completed' ? 'success' : 'warning'}">${e.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="editExam(${e.id})">Edit</button></td>
                </tr>
            `).join('');
        }
        function showAddExamModal() {
            document.getElementById('examGrade').innerHTML = [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            new bootstrap.Modal(document.getElementById('addExamModal')).show();
        }
        function saveExam() {
            const name = document.getElementById('examName').value;
            const date = document.getElementById('examDate').value;
            const subject = document.getElementById('examSubject').value;
            const grade = document.getElementById('examGrade').value;
            const status = document.getElementById('examStatus').value;
            if (name && date && subject && grade) {
                const id = Date.now();
                exams.push({ id, name, date, subject, grade, status });
                saveData();
                renderExams();
                bootstrap.Modal.getInstance(document.getElementById('addExamModal')).hide();
                addNotification('Exam scheduled', 'success');
            }
        }
        function editExam(id) {
            // Similar edit logic
            alert('Edit exam ' + id + ' (implement)');
        }
        function showEnterMarksModal(examId) {
            document.getElementById('marksExamName').textContent = exams.find(e => e.id === examId)?.name || '';
            const exam = exams.find(e => e.id === examId);
            if (exam) {
                const studentsInGrade = students.filter(s => s.grade === exam.grade);
                document.getElementById('marksTable').innerHTML = studentsInGrade.map(s => `
                    <tr>
                        <td>${s.name}</td>
                        <td><input type="number" class="form-control" min="0" max="100" data-student="${s.id}"></td>
                    </tr>
                `).join('');
                document.getElementById('marksEntry').classList.remove('d-none');
            }
        }
        function saveMarks() {
            const inputs = document.querySelectorAll('#marksTable input');
            inputs.forEach(input => {
                const studentId = input.dataset.student;
                const score = parseFloat(input.value);
                if (score) {
                    const id = Date.now();
                    grades.push({ id, studentId, subject: document.getElementById('marksExamName').textContent, score, comments: '' });
                }
            });
            saveData();
            document.getElementById('marksEntry').classList.add('d-none');
            renderExams();
            addNotification('Marks saved', 'success');
        }
        function generateAllReportCards() {
            students.forEach(s => {
                const studentGrades = grades.filter(g => g.studentId === s.id);
                const avg = studentGrades.length > 0 ? studentGrades.reduce((sum, g) => sum + g.score, 0) / studentGrades.length : 0;
                addNotification(`Report card for ${s.name}: ${Math.round(avg)}%`, 'info');
            });
        }
        function generateHallTickets() {
            exams.forEach(e => {
                if (e.status === 'Scheduled') {
                    students.filter(s => s.grade === e.grade).forEach(s => {
                        addNotification(`Hall ticket for ${s.name} - ${e.name}`, 'info');
                    });
                }
            });
        }

        // HR Management
        function renderHR() {
            // Default to staff
            renderStaff();
        }
        function renderStaff() {
            const search = document.getElementById('staffSearch').value.toLowerCase();
            const roleFilter = document.getElementById('staffFilterRole').value;
            const filtered = staff.filter(s => 
                s.name.toLowerCase().includes(search) && 
                (!roleFilter || s.role === roleFilter)
            );
            document.getElementById('staffTable').innerHTML = filtered.map(s => {
                const expiryDate = new Date(s.certExpiry);
                const isExpired = expiryDate < new Date();
                const daysUntilExpiry = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
                const expiryWarning = isExpired ? 'EXPIRED' : daysUntilExpiry < 90 ? `${daysUntilExpiry}d left` : '';
                const username = s.username ? escapeHtml(s.username) : '<span class="text-muted">Not set</span>';
                const isTeacher = s.role === 'Teacher';
                return `
                    <tr>
                        <td class="text-center"><strong>#${s.id}</strong></td>
                        <td><i class="fas fa-user-circle me-2"></i>${s.name}</td>
                        <td><span class="badge bg-primary">${s.role}</span></td>
                        <td>${s.department}</td>
                        <td class="text-end"><strong>R${s.salary.toLocaleString()}</strong></td>
                        <td>${s.taxNumber}</td>
                        <td>${s.uifNumber}</td>
                        <td>
                            <span class="${isExpired ? 'cert-expired' : 'cert-expiry'}">
                                ${s.certExpiry}
                                ${expiryWarning ? `<br><small class="badge bg-${isExpired ? 'danger' : 'warning'}">${expiryWarning}</small>` : ''}
                            </span>
                        </td>
                        <td class="username-cell">
                            ${isTeacher ? `<i class="fas fa-chalkboard-teacher me-1"></i>` : ''}${username}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-${s.status === 'Active' ? 'success' : 'warning'}">
                                <i class="fas fa-${s.status === 'Active' ? 'check-circle' : 'clock'}"></i> ${s.status}
                            </span>
                        </td>
                        <td class="text-center" style="white-space: nowrap;">
                            <button class="btn btn-sm btn-info me-1" onclick="viewStaffDetails(${s.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="showAddStaffModal(${s.id})" title="Edit Staff">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            // Metrics
            document.getElementById('totalStaff').textContent = staff.length;
            document.getElementById('activeStaff').textContent = staff.filter(s => s.status === 'Active').length;
            const avgSalary = staff.length > 0 ? Math.round(staff.reduce((sum, s) => sum + s.salary, 0) / staff.length) : 0;
            document.getElementById('avgSalary').textContent = 'R' + avgSalary.toLocaleString();
            const expiringCerts = staff.filter(s => new Date(s.certExpiry) < new Date(Date.now() + 90*24*60*60*1000)).length;
            document.getElementById('expiringCerts').textContent = expiringCerts;
        }
        function showAddStaffModal(editId) {
            if (editId) {
                editingStaffId = editId;
                const staffMember = staff.find(s => s.id === editId);
                if (staffMember) {
                    document.getElementById('staffModalTitle').textContent = 'Edit Staff';
                    document.getElementById('staffName').value = staffMember.name;
                    document.getElementById('staffRole').value = staffMember.role;
                    document.getElementById('staffDepartment').value = staffMember.department;
                    document.getElementById('staffSalary').value = staffMember.salary;
                    document.getElementById('staffTax').value = staffMember.taxNumber;
                    document.getElementById('staffUif').value = staffMember.uifNumber;
                    document.getElementById('staffCertExpiry').value = staffMember.certExpiry;
                    document.getElementById('staffUsername').value = staffMember.username || '';
                    document.getElementById('staffPassword').value = '';
                }
                const saveBtn = document.querySelector('#addStaffModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = updateStaff;
            } else {
                document.getElementById('staffModalTitle').textContent = 'Add Staff';
                // Clear form
                new FormData(); // Reset
                const saveBtn = document.querySelector('#addStaffModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveStaff;
                editingStaffId = null;
            }
            new bootstrap.Modal(document.getElementById('addStaffModal')).show();
        }
        
        function viewStaffDetails(staffId) {
            const staffMember = staff.find(s => s.id === staffId);
            if (!staffMember) {
                addNotification('Staff member not found', 'error');
                return;
            }
            
            const expiryDate = new Date(staffMember.certExpiry);
            const isExpired = expiryDate < new Date();
            const daysUntilExpiry = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
            
            // Build detailed staff information display
            const detailsHTML = `
                <div style="background: rgba(255,255,255,0.95); color: #333; padding: 25px; border-radius: 15px; max-width: 600px;">
                    <h4 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px;">
                        <i class="fas fa-user-tie me-2"></i>${staffMember.name}
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <p style="margin-bottom: 8px;">
                                <strong style="color: #555;"><i class="fas fa-id-badge me-2"></i>Staff ID:</strong><br>
                                <span style="color: #333;">${staffMember.id}</span>
                            </p>
                            <p style="margin-bottom: 8px;">
                                <strong style="color: #555;"><i class="fas fa-briefcase me-2"></i>Role:</strong><br>
                                <span class="badge bg-primary" style="font-size: 0.9em;">${staffMember.role}</span>
                            </p>
                            <p style="margin-bottom: 8px;">
                                <strong style="color: #555;"><i class="fas fa-building me-2"></i>Department:</strong><br>
                                <span style="color: #333;">${staffMember.department}</span>
                            </p>
                            <p style="margin-bottom: 8px;">
                                <strong style="color: #555;"><i class="fas fa-money-bill-wave me-2"></i>Salary:</strong><br>
                                <span style="color: #28a745; font-size: 1.1em; font-weight: 600;">R${staffMember.salary.toLocaleString()}</span>
                            </p>
                        </div>
                        
                        <div>
                            <p style="margin-bottom: 8px;">
                                <strong style="color: #555;"><i class="fas fa-file-invoice me-2"></i>Tax Number:</strong><br>
                                <span style="color: #333;">${staffMember.taxNumber}</span>
                            </p>
                            <p style="margin-bottom: 8px;">
                                <strong style="color: #555;"><i class="fas fa-shield-alt me-2"></i>UIF Number:</strong><br>
                                <span style="color: #333;">${staffMember.uifNumber}</span>
                            </p>
                            <p style="margin-bottom: 8px;">
                                <strong style="color: #555;"><i class="fas fa-certificate me-2"></i>Certificate Expiry:</strong><br>
                                <span style="color: ${isExpired ? '#dc3545' : daysUntilExpiry < 90 ? '#ffc107' : '#28a745'}; font-weight: 600;">
                                    ${staffMember.certExpiry}
                                    ${isExpired ? ' <i class="fas fa-exclamation-triangle"></i> EXPIRED' : 
                                      daysUntilExpiry < 90 ? ` (${daysUntilExpiry} days left)` : ''}
                                </span>
                            </p>
                            <p style="margin-bottom: 8px;">
                                <strong style="color: #555;"><i class="fas fa-toggle-on me-2"></i>Status:</strong><br>
                                <span class="badge bg-${staffMember.status === 'Active' ? 'success' : 'warning'}" style="font-size: 0.9em;">
                                    ${staffMember.status}
                                </span>
                            </p>
                        </div>
                    </div>
                    
                    ${staffMember.username ? `
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                        <p style="margin-bottom: 0;">
                            <strong style="color: #555;"><i class="fas fa-user me-2"></i>Username:</strong>
                            <span style="color: #333;">${staffMember.username}</span>
                        </p>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; text-align: right;">
                        <button class="btn btn-primary" onclick="this.closest('.swal2-popup').querySelector('.swal2-confirm').click(); showAddStaffModal(${staffMember.id})">
                            <i class="fas fa-edit me-2"></i>Edit Staff
                        </button>
                    </div>
                </div>
            `;
            
            // Use SweetAlert if available, otherwise use alert
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    html: detailsHTML,
                    showConfirmButton: true,
                    confirmButtonText: 'Close',
                    width: '650px',
                    customClass: {
                        container: 'staff-view-modal'
                    }
                });
            } else {
                // Fallback to a custom modal or alert
                const modalContent = `
Staff Details:

Name: ${staffMember.name}
ID: ${staffMember.id}
Role: ${staffMember.role}
Department: ${staffMember.department}
Salary: R${staffMember.salary.toLocaleString()}
Tax Number: ${staffMember.taxNumber}
UIF Number: ${staffMember.uifNumber}
Certificate Expiry: ${staffMember.certExpiry} ${isExpired ? '(EXPIRED)' : daysUntilExpiry < 90 ? `(${daysUntilExpiry} days left)` : ''}
Status: ${staffMember.status}
${staffMember.username ? '\nUsername: ' + staffMember.username : ''}

                `;
                alert(modalContent);
            }
            
            logUserActivity(currentUser.username || currentUser.name, currentUser.role, 'View Staff', `Viewed details for ${staffMember.name}`);
        }
        
        function saveStaff() {
            const name = document.getElementById('staffName').value;
            const role = document.getElementById('staffRole').value;
            const department = document.getElementById('staffDepartment').value;
            const salary = parseFloat(document.getElementById('staffSalary').value);
            const tax = document.getElementById('staffTax').value;
            const uif = document.getElementById('staffUif').value;
            const certExpiry = document.getElementById('staffCertExpiry').value;
            const username = document.getElementById('staffUsername').value;
            const password = document.getElementById('staffPassword').value;
            if (name && role && salary) {
                const id = Date.now();
                const newStaff = { id, name, role, department, salary, taxNumber: tax, uifNumber: uif, certExpiry, status: 'Active' };
                if (username && password) {
                    newStaff.username = username;
                    users.push({ username, password, name, role });
                }
                staff.push(newStaff);
                saveData();
                renderStaff();
                bootstrap.Modal.getInstance(document.getElementById('addStaffModal')).hide();
                addNotification('Staff added', 'success');
            }
        }
        function updateStaff() {
            if (editingStaffId) {
                const staffMember = staff.find(s => s.id === editingStaffId);
                if (staffMember) {
                    staffMember.name = document.getElementById('staffName').value;
                    staffMember.role = document.getElementById('staffRole').value;
                    staffMember.department = document.getElementById('staffDepartment').value;
                    staffMember.salary = parseFloat(document.getElementById('staffSalary').value);
                    staffMember.taxNumber = document.getElementById('staffTax').value;
                    staffMember.uifNumber = document.getElementById('staffUif').value;
                    staffMember.certExpiry = document.getElementById('staffCertExpiry').value;
                    const username = document.getElementById('staffUsername').value;
                    const password = document.getElementById('staffPassword').value;
                    if (password) {
                        const existingUser = users.find(u => u.name === staffMember.name);
                        if (existingUser) {
                            existingUser.password = password;
                        } else if (username) {
                            users.push({ username, password, name: staffMember.name, role: staffMember.role });
                        }
                    }
                    saveData();
                    renderStaff();
                    bootstrap.Modal.getInstance(document.getElementById('addStaffModal')).hide();
                    addNotification('Staff updated', 'success');
                }
            }
        }
        function syncStaffBiometric() {
            addNotification('Biometric sync for staff simulated', 'info');
        }
        function generateStaffReport() {
            addNotification('Staff report generated (mock PDF)', 'success');
            // Use jsPDF for actual generation
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Staff Report', 10, 10);
            doc.save('staff-report.pdf');
        }
        
        function showBulkStaffModal() {
            showModal('bulkStaffModal');
        }
        
        function uploadBulkStaff() {
            const file = document.getElementById('staffFile').files[0];
            if (!file) {
                addNotification('Please select a file', 'warning');
                return;
            }
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (fileExt !== 'xlsx' && fileExt !== 'xls') {
                addNotification('Please use Excel format (.xlsx or .xls)', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Skip Excel row 1 (title/header row), start from Excel row 2
                    // range: 1 means skip 0-indexed row 0, begin reading at row 1
                    const rawJson = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        range: 1
                    });
                    
                    const headers = rawJson[0];
                    const rows = rawJson.slice(1);
                    
                    const staffRecords = [];
                    
                    rows.forEach(row => {
                        const record = {
                            name: cleanCell(row[0]),
                            role: cleanCell(row[1]),
                            department: cleanCell(row[2]),
                            salary: cleanCell(row[3]),
                            taxNumber: cleanCell(row[4]),
                            uifNumber: cleanCell(row[5]),
                            certExpiry: cleanCell(row[6]),
                            status: cleanCell(row[7]) || 'Active'
                        };
                        
                        if (record.name && record.role) {
                            staffRecords.push(record);
                        }
                    });
                    
                    // Show result
                    const resultHTML = `<div class="alert alert-info">
                        <strong> Import Summary:</strong><br>
                        <strong>${staffRecords.length} staff members successfully parsed!</strong>
                    </div>`;
                    
                    let previewHTML = resultHTML + `
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped" style="background: white; color: #333;">
                                <thead>
                                    <tr style="background-color: #f2f2f2;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Role</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Department</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Salary</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${staffRecords.slice(0, 10).map(r => `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${r.name}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${r.role}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${r.department}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">R${parseFloat(r.salary || 0).toLocaleString()}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${r.status}</td>
                                        </tr>
                                    `).join('')}
                                    ${staffRecords.length > 10 ? `<tr><td colspan="5" style="text-align: center; padding: 8px;">...and ${staffRecords.length - 10} more staff members</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-primary mt-2" onclick='confirmStaffImport(${JSON.stringify(staffRecords)})'>Import ${staffRecords.length} Staff Members</button>
                    `;
                    
                    document.getElementById('staffPreview').innerHTML = previewHTML;
                    
                } catch (error) {
                    addNotification('Error parsing file: ' + error.message, 'danger');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function confirmStaffImport(records) {
            records.forEach(record => {
                const id = Date.now() + Math.random();
                const newStaff = {
                    id,
                    name: record.name,
                    role: record.role,
                    department: record.department || 'General',
                    salary: parseFloat(record.salary) || 0,
                    taxNumber: record.taxNumber || 'Not Provided',
                    uifNumber: record.uifNumber || 'Not Provided',
                    certExpiry: record.certExpiry || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],
                    status: record.status || 'Active'
                };
                
                staff.push(newStaff);
            });
            saveData();
            renderStaff();
            hideModal('bulkStaffModal');
            addNotification(` Successfully imported ${records.length} staff members using SheetJS`, 'success');
            logAudit('Bulk Import', `Imported ${records.length} staff members using SheetJS`, 'Low');
        }
        function renderPayrolls() {
            const monthFilter = document.getElementById('payrollMonthFilter').value;
            const filtered = monthFilter ? payrolls.filter(p => p.month === monthFilter) : payrolls;
            document.getElementById('payrollTable').innerHTML = filtered.map(p => {
                const staffMember = staff.find(s => s.id === p.staffId);
                const deductions = p.deductions || 0;
                const tax = p.salary * 0.25; // Mock
                const uif = p.salary * hrSettings.uifRate;
                const net = p.salary - deductions - tax - uif;
                return `
                    <tr>
                        <td>${p.id}</td>
                        <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                        <td>${p.month}</td>
                        <td>R${p.salary.toLocaleString()}</td>
                        <td>R${deductions.toLocaleString()}</td>
                        <td>R${tax.toLocaleString()}</td>
                        <td>R${uif.toLocaleString()}</td>
                        <td>R${net.toLocaleString()}</td>
                        <td><button class="btn btn-sm btn-success" onclick="generatePayslip(${p.id})">Payslip</button></td>
                    </tr>
                `;
            }).join('');
            // Metrics
            const totalPay = filtered.reduce((sum, p) => sum + p.salary, 0);
            const totalDed = filtered.reduce((sum, p) => sum + (p.deductions || 0), 0);
            const netPay = totalPay - totalDed;
            const compliance = Math.random() * 100; // Mock
            document.getElementById('totalPayroll').textContent = 'R' + totalPay.toLocaleString();
            document.getElementById('totalDeductions').textContent = 'R' + totalDed.toLocaleString();
            document.getElementById('netPayroll').textContent = 'R' + netPay.toLocaleString();
            document.getElementById('complianceScore').textContent = Math.round(compliance) + '%';
        }
        function showAddPayrollModal() {
            new bootstrap.Modal(document.getElementById('addPayrollModal')).show();
        }
        function savePayroll() {
            const staffId = document.getElementById('payrollStaff').value;
            const month = document.getElementById('payrollMonth').value;
            const salary = parseFloat(document.getElementById('payrollSalary').value);
            const deductions = parseFloat(document.getElementById('payrollDeductions').value) || 0;
            if (staffId && month && salary) {
                const id = Date.now();
                payrolls.push({ id, staffId, month, salary, deductions });
                saveData();
                renderPayrolls();
                bootstrap.Modal.getInstance(document.getElementById('addPayrollModal')).hide();
                addNotification('Payroll added', 'success');
            }
        }
        function generatePayroll() {
            staff.forEach(s => {
                if (!payrolls.find(p => p.staffId === s.id && p.month === new Date().toISOString().slice(0,7))) {
                    const id = Date.now();
                    payrolls.push({ id, staffId: s.id, month: new Date().toISOString().slice(0,7), salary: s.salary, deductions: 0 });
                }
            });
            saveData();
            renderPayrolls();
            addNotification('Payroll generated', 'success');
        }
        function exportPayrollToExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(payrolls.map(p => ({
                ...p,
                staffName: staff.find(s => s.id === p.staffId)?.name || ''
            })));
            XLSX.utils.book_append_sheet(wb, ws, 'Payroll');
            XLSX.writeFile(wb, 'payroll.xlsx');
            addNotification('Payroll exported', 'success');
        }
        function calculateCompliance() {
            addNotification('Compliance checked (mock)', 'info');
        }
        function generatePayslip(id) {
            const payroll = payrolls.find(p => p.id === id);
            if (payroll) {
                const staffMember = staff.find(s => s.id === payroll.staffId);
                const deductions = payroll.deductions || 0;
                const tax = payroll.salary * 0.25;
                const uif = payroll.salary * hrSettings.uifRate;
                const net = payroll.salary - deductions - tax - uif;
                const payslip = `
                    <div class="payslip-preview">
                        <h4>Payslip for ${staffMember.name}</h4>
                        <p>Month: ${payroll.month}</p>
                        <p>Gross: R${payroll.salary.toLocaleString()}</p>
                        <p>Deductions: R${deductions.toLocaleString()}</p>
                        <p>Tax: R${tax.toLocaleString()}</p>
                        <p>UIF: R${uif.toLocaleString()}</p>
                        <p><strong>Net: R${net.toLocaleString()}</strong></p>
                    </div>
                `;
                // Similar modal as receipt
                addNotification('Payslip generated (mock)', 'success');
            }
        }
        function renderLeaves() {
            const dateFilter = document.getElementById('leaveDateFilter').value;
            const filtered = dateFilter ? leaveRequests.filter(l => l.date === dateFilter) : leaveRequests;
            document.getElementById('leavesTable').innerHTML = filtered.map(l => {
                const staffMember = staff.find(s => s.id === l.staffId);
                return `
                    <tr>
                        <td>${l.id}</td>
                        <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                        <td>${l.type}</td>
                        <td>${l.date}</td>
                        <td>${l.days}</td>
                        <td><span class="badge bg-${l.status === 'Approved' ? 'success' : l.status === 'Rejected' ? 'danger' : 'warning'}">${l.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="toggleLeaveStatus(${l.id})">Toggle</button></td>
                    </tr>
                `;
            }).join('');
            // Metrics
            document.getElementById('totalLeaves').textContent = leaveRequests.length;
            document.getElementById('pendingLeaves').textContent = leaveRequests.filter(l => l.status === 'Pending').length;
            document.getElementById('approvedLeaves').textContent = leaveRequests.filter(l => l.status === 'Approved').length;
            document.getElementById('rejectedLeaves').textContent = leaveRequests.filter(l => l.status === 'Rejected').length;
            // Chart - with safety check
            if (typeof Chart !== 'undefined') {
                const ctx = document.getElementById('leaveChart').getContext('2d');
                if (leaveChart) leaveChart.destroy();
                leaveChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Pending', 'Approved', 'Rejected'],
                        datasets: [{
                            data: [leaveRequests.filter(l => l.status === 'Pending').length, leaveRequests.filter(l => l.status === 'Approved').length, leaveRequests.filter(l => l.status === 'Rejected').length],
                            backgroundColor: ['#FFCE56', '#36A2EB', '#FF6384']
                        }]
                    },
                    options: { responsive: true }
                });
            }
        }
        function showAddLeaveModal() {
            new bootstrap.Modal(document.getElementById('addLeaveModal')).show();
        }
        function saveLeave() {
            const staffId = document.getElementById('leaveStaff').value;
            const type = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const days = parseInt(document.getElementById('leaveDays').value);
            if (staffId && date && days) {
                const id = Date.now();
                leaveRequests.push({ id, staffId, type, date, days, status: 'Pending' });
                saveData();
                renderLeaves();
                bootstrap.Modal.getInstance(document.getElementById('addLeaveModal')).hide();
                addNotification('Leave request added', 'success');
            }
        }
        function toggleLeaveStatus(id) {
            const leave = leaveRequests.find(l => l.id === id);
            if (leave) {
                leave.status = leave.status === 'Pending' ? 'Approved' : leave.status === 'Approved' ? 'Rejected' : 'Pending';
                saveData();
                renderLeaves();
                addNotification('Leave status updated', 'info');
            }
        }
        function generateLeaveReport() {
            addNotification('Leave report generated (mock)', 'success');
        }
        function renderReviews() {
            const dateFilter = document.getElementById('reviewDateFilter').value;
            const filtered = dateFilter ? performanceReviews.filter(r => r.date === dateFilter) : performanceReviews;
            document.getElementById('reviewsTable').innerHTML = filtered.map(r => {
                const staffMember = staff.find(s => s.id === r.staffId);
                return `
                    <tr>
                        <td>${r.id}</td>
                        <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                        <td>${r.date}</td>
                        <td>${r.score}</td>
                        <td>${r.comments}</td>
                        <td><button class="btn btn-sm btn-warning" onclick="editReview(${r.id})">Edit</button></td>
                    </tr>
                `;
            }).join('');
            // Metrics
            const avgScore = performanceReviews.length > 0 ? Math.round(performanceReviews.reduce((sum, r) => sum + r.score, 0) / performanceReviews.length) : 0;
            document.getElementById('avgScore').textContent = avgScore;
            document.getElementById('totalReviews').textContent = performanceReviews.length;
            document.getElementById('goalsAchieved').textContent = performanceReviews.filter(r => r.score > 80).length;
            document.getElementById('pendingFeedback').textContent = 0; // Mock
            // Chart - with safety check
            if (typeof Chart !== 'undefined') {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                if (performanceChart) performanceChart.destroy();
                performanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Scores'],
                        datasets: [{
                            label: 'Average',
                            data: [avgScore],
                            backgroundColor: '#4BC0C0'
                        }]
                    },
                    options: { responsive: true }
                });
            }
        }
        function showAddReviewModal() {
            new bootstrap.Modal(document.getElementById('addReviewModal')).show();
        }
        function saveReview() {
            const staffId = document.getElementById('reviewStaff').value;
            const date = document.getElementById('reviewDate').value;
            const score = parseFloat(document.getElementById('reviewScore').value);
            const comments = document.getElementById('reviewComments').value;
            if (staffId && date && score) {
                const id = Date.now();
                performanceReviews.push({ id, staffId, date, score, comments });
                saveData();
                renderReviews();
                bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
                addNotification('Review added', 'success');
            }
        }
        function editReview(id) {
            editingReviewId = id;
            const review = performanceReviews.find(r => r.id === id);
            if (review) {
                document.getElementById('reviewStaff').value = review.staffId;
                document.getElementById('reviewDate').value = review.date;
                document.getElementById('reviewScore').value = review.score;
                document.getElementById('reviewComments').value = review.comments;
                // Override save
                const saveBtn = document.querySelector('#addReviewModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = updateReview;
                new bootstrap.Modal(document.getElementById('addReviewModal')).show();
            }
        }
        function updateReview() {
            const review = performanceReviews.find(r => r.id === editingReviewId);
            if (review) {
                review.staffId = document.getElementById('reviewStaff').value;
                review.date = document.getElementById('reviewDate').value;
                review.score = parseFloat(document.getElementById('reviewScore').value);
                review.comments = document.getElementById('reviewComments').value;
                saveData();
                renderReviews();
                bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
                const saveBtn = document.querySelector('#addReviewModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveReview;
                addNotification('Review updated', 'success');
            }
        }
        function generatePerformanceReport() {
            addNotification('Performance report generated (mock)', 'success');
        }
        function renderJobs() {
            const search = document.getElementById('jobSearch').value.toLowerCase();
            const filtered = jobs.filter(j => j.title.toLowerCase().includes(search));
            document.getElementById('jobTable').innerHTML = filtered.map(j => `
                <tr>
                    <td>${j.id}</td>
                    <td>${j.title}</td>
                    <td>${j.department}</td>
                    <td>${j.applications || 0}</td>
                    <td><span class="badge bg-${j.status === 'Open' ? 'success' : 'danger'}">${j.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="editJob(${j.id})">Edit</button> <button class="btn btn-sm btn-info" onclick="showScheduleInterviewModal(${j.id})">Schedule</button></td>
                </tr>
            `).join('');
            // Metrics
            document.getElementById('openPositions').textContent = jobs.filter(j => j.status === 'Open').length;
            document.getElementById('totalApplications').textContent = jobs.reduce((sum, j) => sum + (j.applications || 0), 0);
            document.getElementById('interviewsScheduled').textContent = 0; // Mock
            document.getElementById('hireRate').textContent = '0%'; // Mock
        }
        function showAddJobModal(editId) {
            editingJob = editId || null;
            if (editId) {
                const job = jobs.find(j => j.id === editId);
                if (job) {
                    document.getElementById('jobModalTitle').textContent = 'Edit Job';
                    document.getElementById('jobTitle').value = job.title;
                    document.getElementById('jobDepartment').value = job.department;
                    document.getElementById('jobDescription').value = job.description;
                    document.getElementById('jobStatus').value = job.status;
                    const saveBtn = document.querySelector('#addJobModal .btn-primary');
                    saveBtn.textContent = 'Update';
                    saveBtn.onclick = updateJob;
                }
            } else {
                document.getElementById('jobModalTitle').textContent = 'Add Job';
                // Clear
                const saveBtn = document.querySelector('#addJobModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveJob;
            }
            new bootstrap.Modal(document.getElementById('addJobModal')).show();
        }
        function saveJob() {
            const title = document.getElementById('jobTitle').value;
            const department = document.getElementById('jobDepartment').value;
            const description = document.getElementById('jobDescription').value;
            const status = document.getElementById('jobStatus').value;
            if (title && department) {
                const id = Date.now();
                jobs.push({ id, title, department, description, status, applications: 0 });
                saveData();
                renderJobs();
                bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
                addNotification('Job added', 'success');
            }
        }
        function updateJob() {
            if (editingJob) {
                const job = jobs.find(j => j.id === editingJob);
                if (job) {
                    job.title = document.getElementById('jobTitle').value;
                    job.department = document.getElementById('jobDepartment').value;
                    job.description = document.getElementById('jobDescription').value;
                    job.status = document.getElementById('jobStatus').value;
                    saveData();
                    renderJobs();
                    bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
                    addNotification('Job updated', 'success');
                }
            }
        }
        function editJob(id) {
            showAddJobModal(id);
        }
        function showApplyJobModal() {
            new bootstrap.Modal(document.getElementById('applyJobModal')).show();
        }
        function submitApplication() {
            const jobId = document.getElementById('applyJobSelect').value;
            const name = document.getElementById('applicantName').value;
            const email = document.getElementById('applicantEmail').value;
            const phone = document.getElementById('applicantPhone').value;
            const coverLetter = document.getElementById('applicantCoverLetter').value;
            const job = jobs.find(j => j.id === jobId);
            if (job && name && email) {
                job.applications = (job.applications || 0) + 1;
                // Mock applicant
                addNotification(`Application from ${name} for ${job.title}`, 'info');
                saveData();
                renderJobs();
                bootstrap.Modal.getInstance(document.getElementById('applyJobModal')).hide();
            }
        }
        function showScheduleInterviewModal(jobId) {
            // Mock applicant for job
            document.getElementById('interviewApplicant').value = 'Mock Applicant';
            new bootstrap.Modal(document.getElementById('scheduleInterviewModal')).show();
        }
        function saveInterview() {
            const dateTime = document.getElementById('interviewDateTime').value;
            const type = document.getElementById('interviewType').value;
            const notes = document.getElementById('interviewNotes').value;
            if (dateTime) {
                addNotification(`Interview scheduled for ${dateTime}`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('scheduleInterviewModal')).hide();
            }
        }
        function generateRecruitmentReport() {
            addNotification('Recruitment report generated (mock)', 'success');
        }
        function renderAudit() {
            const dateFilter = document.getElementById('auditDateFilter').value;
            const actionFilter = document.getElementById('auditActionFilter').value;
            const filtered = auditLog.filter(a => 
                (!dateFilter || a.timestamp.startsWith(dateFilter)) &&
                (!actionFilter || a.action === actionFilter)
            );
            document.getElementById('auditTable').innerHTML = filtered.map(a => `
                <tr>
                    <td>${a.timestamp}</td>
                    <td>${a.user}</td>
                    <td>${a.action}</td>
                    <td>${a.details}</td>
                    <td><span class="badge bg-${a.risk === 'High' ? 'danger' : 'warning'}">${a.risk}</span></td>
                </tr>
            `).join('');
            // Metrics
            document.getElementById('totalAudit').textContent = auditLog.length;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayAudit').textContent = auditLog.filter(a => a.timestamp.startsWith(today)).length;
            document.getElementById('highRiskAudit').textContent = auditLog.filter(a => a.risk === 'High').length;
            document.getElementById('complianceIssues').textContent = 0; // Mock
        }
        function generateAuditReport() {
            addNotification('Audit report generated (mock)', 'success');
        }
        function exportAuditToExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(auditLog);
            XLSX.utils.book_append_sheet(wb, ws, 'Audit');
            XLSX.writeFile(wb, 'audit.xlsx');
            addNotification('Audit exported', 'success');
        }

        // Communication
        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No messages yet. Click "Send Message" to start a conversation.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(m => `
                <div class="chat-message ${m.sender === currentUser?.name ? 'chat-user' : 'chat-assistant'}">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <strong>${escapeHtml(m.sender || 'Unknown')}${m.recipient ? `  ${escapeHtml(m.recipient)}` : ''}</strong>
                        <small class="text-muted">${escapeHtml(m.timestamp || 'N/A')}</small>
                    </div>
                    <p class="mb-1">${escapeHtml(m.text || '')}</p>
                    ${m.viaSMS ? '<small class="badge bg-info"><i class="fas fa-sms me-1"></i>SMS</small>' : ''}
                </div>
            `).join('');
        }
        function showSendMessageModal() {
            // Populate recipient dropdown with students and staff
            const recipientSelect = document.getElementById('messageRecipient');
            if (recipientSelect) {
                let options = '<option value="">Select Recipient (or leave blank for broadcast)</option>';
                options += '<optgroup label="Students">';
                students.forEach(s => {
                    options += `<option value="${s.name}">${s.name} (${s.grade || 'N/A'})</option>`;
                });
                options += '</optgroup>';
                options += '<optgroup label="Staff">';
                staff.forEach(s => {
                    options += `<option value="${s.name}">${s.name} (${s.role || 'N/A'})</option>`;
                });
                options += '</optgroup>';
                recipientSelect.innerHTML = options;
            }
            showModal('sendMessageModal');
        }
        function sendMessage() {
            // Validate user is logged in
            if (!validateUserLogin('send messages')) return;
            
            const recipient = document.getElementById('messageRecipient')?.value || '';
            const text = document.getElementById('messageText')?.value?.trim();
            const viaSMS = document.getElementById('sendViaSMS')?.checked || false;
            
            if (!text) {
                addNotification('Please enter a message', 'warning');
                return;
            }
            
            const id = Date.now();
            messages.push({ 
                id, 
                sender: currentUser.name, 
                recipient: recipient || 'All', 
                text, 
                timestamp: new Date().toLocaleString(), 
                viaSMS 
            });
            
            if (viaSMS) {
                addNotification('SMS sent via WinSMS', 'info');
            }
            
            saveData();
            renderMessages();
            
            // Clear form
            document.getElementById('messageText').value = '';
            
            safeHideModal('sendMessageModal');
            addNotification(`Message sent${recipient ? ` to ${recipient}` : ' to All'}`, 'success');
        }
        function viewAnnouncements() {
            announcements.forEach(a => {
                addNotification(a.title + ': ' + a.content, 'info');
            });
        }
        
        // Enhanced Announcements Functions
        function showAnnouncementsModal() {
            renderAnnouncementsList();
            new bootstrap.Modal(document.getElementById('announcementsModal')).show();
        }
        
        function renderAnnouncementsList() {
            const container = document.getElementById('announcementsList');
            if (announcements.length === 0) {
                container.innerHTML = '<p class="text-muted">No announcements yet.</p>';
                return;
            }
            container.innerHTML = announcements.map(a => {
                const priorityClass = a.priority === 'Urgent' ? 'danger' : a.priority === 'High' ? 'warning' : a.priority === 'Medium' ? 'info' : 'secondary';
                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="card-title">${a.title || 'Untitled'}</h6>
                                <span class="badge bg-${priorityClass}">${a.priority || 'Medium'}</span>
                            </div>
                            <p class="card-text">${a.content || ''}</p>
                            <small class="text-muted">
                                <i class="fas fa-users me-1"></i>${a.audience || 'All'} | 
                                <i class="fas fa-clock me-1"></i>${a.timestamp ? new Date(a.timestamp).toLocaleString() : 'N/A'}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function createAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            const priority = document.getElementById('announcementPriority').value;
            const audience = document.getElementById('announcementAudience').value;
            
            if (!title || !content) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const announcement = {
                id: Date.now(),
                title: title,
                content: content,
                priority: priority,
                audience: audience,
                timestamp: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            announcements.push(announcement);
            localStorage.setItem('announcements', JSON.stringify(announcements));
            
            // Clear form
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
            document.getElementById('announcementPriority').value = 'Medium';
            document.getElementById('announcementAudience').value = 'All';
            
            renderAnnouncementsList();
            addNotification('Announcement published successfully', 'success');
        }
        
        function createPoster() {
            const title = document.getElementById('posterTitle').value.trim();
            const date = document.getElementById('posterDate').value;
            const time = document.getElementById('posterTime').value;
            const location = document.getElementById('posterLocation').value.trim();
            const description = document.getElementById('posterDescription').value.trim();
            
            if (!title || !date) {
                addNotification('Please provide at least a title and date', 'warning');
                return;
            }
            
            const poster = {
                id: Date.now(),
                type: 'poster',
                title: title,
                date: date,
                time: time,
                location: location,
                description: description,
                timestamp: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            announcements.push({
                id: poster.id,
                title: `Event: ${title}`,
                content: `${description} | Date: ${date} ${time || ''} | Location: ${location}`,
                priority: 'High',
                audience: 'All',
                timestamp: poster.timestamp,
                createdBy: poster.createdBy,
                type: 'poster'
            });
            
            localStorage.setItem('announcements', JSON.stringify(announcements));
            
            // Display poster preview
            document.getElementById('posterPreview').innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Poster Created!</h5>
                    <div class="card mt-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px;">
                        <h3 class="text-center">${title}</h3>
                        <hr style="border-color: rgba(255,255,255,0.3);">
                        <p><i class="fas fa-calendar me-2"></i><strong>Date:</strong> ${date}</p>
                        ${time ? `<p><i class="fas fa-clock me-2"></i><strong>Time:</strong> ${time}</p>` : ''}
                        ${location ? `<p><i class="fas fa-map-marker-alt me-2"></i><strong>Location:</strong> ${location}</p>` : ''}
                        ${description ? `<p class="mt-3">${description}</p>` : ''}
                    </div>
                </div>
            `;
            
            // Clear form
            document.getElementById('posterTitle').value = '';
            document.getElementById('posterDate').value = '';
            document.getElementById('posterTime').value = '';
            document.getElementById('posterLocation').value = '';
            document.getElementById('posterDescription').value = '';
            
            renderAnnouncementsList();
            addNotification('Poster created and published', 'success');
        }
        
        function uploadVideo() {
            const title = document.getElementById('videoTitle').value.trim();
            const description = document.getElementById('videoDescription').value.trim();
            const videoFile = document.getElementById('videoFile').files[0];
            const videoURL = document.getElementById('videoURL').value.trim();
            
            if (!title) {
                addNotification('Please provide a video title', 'warning');
                return;
            }
            
            if (!videoFile && !videoURL) {
                addNotification('Please upload a video file or provide a video URL', 'warning');
                return;
            }
            
            const video = {
                id: Date.now(),
                type: 'video',
                title: title,
                description: description,
                url: videoURL,
                fileName: videoFile ? videoFile.name : null,
                timestamp: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            announcements.push({
                id: video.id,
                title: `Video: ${title}`,
                content: description + (videoURL ? ` | ${videoURL}` : ''),
                priority: 'Medium',
                audience: 'All',
                timestamp: video.timestamp,
                createdBy: video.createdBy,
                type: 'video'
            });
            
            localStorage.setItem('announcements', JSON.stringify(announcements));
            
            // Display video preview
            let previewHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Video Uploaded!</h5>
                    <div class="card mt-2">
                        <div class="card-body">
                            <h6>${title}</h6>
                            <p>${description}</p>
            `;
            
            if (videoURL) {
                // Try to embed if it's a YouTube or Vimeo link
                if (videoURL.includes('youtube.com') || videoURL.includes('youtu.be')) {
                    let videoId = '';
                    if (videoURL.includes('youtube.com/watch?v=')) {
                        videoId = videoURL.split('v=')[1].split('&')[0];
                    } else if (videoURL.includes('youtu.be/')) {
                        videoId = videoURL.split('youtu.be/')[1].split('?')[0];
                    }
                    if (videoId) {
                        previewHTML += `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                    }
                } else {
                    previewHTML += `<p><a href="${videoURL}" target="_blank" class="btn btn-sm btn-primary"><i class="fas fa-external-link-alt me-2"></i>View Video</a></p>`;
                }
            } else if (videoFile) {
                previewHTML += `<p><i class="fas fa-file-video me-2"></i>File: ${videoFile.name}</p>`;
            }
            
            previewHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('videoPreview').innerHTML = previewHTML;
            
            // Clear form
            document.getElementById('videoTitle').value = '';
            document.getElementById('videoDescription').value = '';
            document.getElementById('videoFile').value = '';
            document.getElementById('videoURL').value = '';
            
            renderAnnouncementsList();
            addNotification('Video uploaded and published', 'success');
        }
        
        function clearAllCommunications() {
            if (confirm('Are you sure you want to clear all notifications and messages? This action cannot be undone.')) {
                // Clear notifications
                localStorage.removeItem('notifications');
                document.getElementById('notificationBadge').style.display = 'none';
                document.getElementById('notificationBadge').textContent = '0';
                
                // Clear messages
                messages = [];
                
                // Clear live chat messages
                liveChatMessages = [];
                localStorage.removeItem('liveChatMessages');
                
                saveData();
                renderMessages();
                renderLiveChatMessages();
                
                addNotification('All communications cleared', 'success');
            }
        }
        
        // ========================================
        // MEDIA CENTER FUNCTIONS
        // ========================================
        
        function loadMediaCenter() {
            // Render messages in the communication tab
            renderMessages();
            
            // Initialize poster canvas if needed
            initMediaPosterCanvas();
        }
        
        // ========================================
        // MEDIA POSTER CREATOR FUNCTIONS
        // ========================================
        
        // Constants for Media Center
        const CANVAS_INIT_DELAY = 500;
        
        let mediaPosterCanvas = null;
        let mediaPosterActiveObject = null;
        
        // Initialize Media Poster Canvas when tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Poster tab initialization removed - incomplete code
        });
        
        function initMediaPosterCanvas() {
            if (mediaPosterCanvas) return; // Already initialized
            
            const canvasElement = document.getElementById('mediaPosterCanvas');
            if (!canvasElement) return;
            
            // Check if fabric is loaded
            if (typeof fabric === 'undefined') {
                // Load Fabric.js dynamically
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js';
                script.onload = function() {
                    createMediaPosterCanvas();
                };
                document.head.appendChild(script);
            } else {
                createMediaPosterCanvas();
            }
        }
        
        function createMediaPosterCanvas() {
            const canvasElement = document.getElementById('mediaPosterCanvas');
            if (!canvasElement) return;
            
            mediaPosterCanvas = new fabric.Canvas('mediaPosterCanvas', {
                backgroundColor: '#ffffff',
                selection: true
            });
            
            // Event listeners
            mediaPosterCanvas.on('selection:created', updateMediaPosterProps);
            mediaPosterCanvas.on('selection:updated', updateMediaPosterProps);
            mediaPosterCanvas.on('selection:cleared', function() {
                mediaPosterActiveObject = null;
                document.getElementById('media-poster-props').style.display = 'none';
            });
            
            // Add welcome text
            const welcomeText = new fabric.Textbox('Welcome to\nPoster Creator', {
                left: 300,
                top: 250,
                width: 400,
                fontSize: 60,
                fontFamily: 'Arial',
                fill: '#333333',
                textAlign: 'center',
                fontWeight: 'bold'
            });
            mediaPosterCanvas.add(welcomeText);
            mediaPosterCanvas.renderAll();
            updateMediaPosterLayers();
            
            addNotification('Poster Creator initialized!', 'success');
        }
        
        function updateMediaPosterProps() {
            mediaPosterActiveObject = mediaPosterCanvas.getActiveObject();
            if (mediaPosterActiveObject) {
                document.getElementById('media-poster-props').style.display = 'block';
                // Update property values
                if (mediaPosterActiveObject.fontSize) {
                    document.getElementById('mediaPosterFontSize').value = mediaPosterActiveObject.fontSize;
                    document.getElementById('mediaPosterFontSizeValue').textContent = mediaPosterActiveObject.fontSize;
                }
                if (mediaPosterActiveObject.fontFamily) {
                    document.getElementById('mediaPosterFontFamily').value = mediaPosterActiveObject.fontFamily;
                }
                if (mediaPosterActiveObject.fill) {
                    document.getElementById('mediaPosterFillColor').value = mediaPosterActiveObject.fill;
                }
            }
        }
        
        function updateMediaPosterLayers() {
            if (!mediaPosterCanvas) return;
            const layersList = document.getElementById('media-poster-layers');
            if (!layersList) return;
            
            const objects = mediaPosterCanvas.getObjects();
            if (objects.length === 0) {
                layersList.innerHTML = '<li style="color: #999; text-align: center;">No layers yet</li>';
                return;
            }
            
            layersList.innerHTML = objects.map((obj, i) => {
                const type = obj.type === 'textbox' ? ' Text' : 
                            obj.type === 'rect' ? ' Rectangle' : 
                            obj.type === 'circle' ? ' Circle' :
                            obj.type === 'triangle' ? ' Triangle' :
                            obj.type === 'image' ? ' Image' : ' Object';
                const isActive = mediaPosterCanvas.getActiveObject() === obj;
                return `<li class="${isActive ? 'active' : ''}" onclick="selectMediaPosterLayer(${i})">${type} ${i + 1}</li>`;
            }).reverse().join('');
        }
        
        function selectMediaPosterLayer(index) {
            if (!mediaPosterCanvas) return;
            const objects = mediaPosterCanvas.getObjects();
            if (objects[index]) {
                mediaPosterCanvas.setActiveObject(objects[index]);
                mediaPosterCanvas.renderAll();
                updateMediaPosterProps();
                updateMediaPosterLayers();
            }
        }
        
        function addMediaPosterText(text = 'Your Text Here', size = 50) {
            if (!mediaPosterCanvas) {
                initMediaPosterCanvas();
                setTimeout(() => addMediaPosterText(text, size), CANVAS_INIT_DELAY);
                return;
            }
            
            const textbox = new fabric.Textbox(text, {
                left: 150,
                top: 150,
                width: 400,
                fontSize: size,
                fontFamily: 'Arial',
                fill: '#333333',
                textAlign: 'center',
                fontWeight: size > 40 ? 'bold' : 'normal',
                editable: true
            });
            mediaPosterCanvas.add(textbox);
            mediaPosterCanvas.setActiveObject(textbox);
            mediaPosterCanvas.renderAll();
            updateMediaPosterLayers();
        }
        
        function addMediaPosterShape(type) {
            if (!mediaPosterCanvas) {
                initMediaPosterCanvas();
                setTimeout(() => addMediaPosterShape(type), CANVAS_INIT_DELAY);
                return;
            }
            
            let shape;
            const colors = ['#e94560', '#667eea', '#10b981', '#f59e0b', '#8b5cf6'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            switch(type) {
                case 'rect':
                    shape = new fabric.Rect({
                        width: 200,
                        height: 150,
                        fill: randomColor,
                        rx: 10,
                        ry: 10
                    });
                    break;
                case 'circle':
                    shape = new fabric.Circle({
                        radius: 80,
                        fill: randomColor
                    });
                    break;
                case 'triangle':
                    shape = new fabric.Triangle({
                        width: 150,
                        height: 130,
                        fill: randomColor
                    });
                    break;
                case 'star':
                    // Create a star using polygon
                    const points = [];
                    const numPoints = 5;
                    const outerRadius = 60;
                    const innerRadius = 30;
                    for (let i = 0; i < numPoints * 2; i++) {
                        const radius = i % 2 === 0 ? outerRadius : innerRadius;
                        const angle = (Math.PI / numPoints) * i - Math.PI / 2;
                        points.push({
                            x: radius * Math.cos(angle),
                            y: radius * Math.sin(angle)
                        });
                    }
                    shape = new fabric.Polygon(points, {
                        fill: randomColor
                    });
                    break;
                case 'line':
                    shape = new fabric.Line([0, 0, 200, 0], {
                        stroke: randomColor,
                        strokeWidth: 4
                    });
                    break;
            }
            
            if (shape) {
                shape.set({
                    left: 200,
                    top: 200,
                    shadow: 'rgba(0,0,0,0.2) 5px 5px 15px'
                });
                mediaPosterCanvas.add(shape);
                mediaPosterCanvas.setActiveObject(shape);
                mediaPosterCanvas.renderAll();
                updateMediaPosterLayers();
            }
        }
        
        function uploadMediaPosterImage() {
            document.getElementById('media-poster-image-upload').click();
        }
        
        function handleMediaPosterImageUpload(input) {
            if (!mediaPosterCanvas) {
                initMediaPosterCanvas();
                return;
            }
            
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                fabric.Image.fromURL(e.target.result, function(img) {
                    // Scale image to fit canvas
                    const maxWidth = mediaPosterCanvas.width * 0.5;
                    const maxHeight = mediaPosterCanvas.height * 0.5;
                    const scale = Math.min(maxWidth / img.width, maxHeight / img.height);
                    
                    img.scale(scale);
                    img.set({
                        left: 100,
                        top: 100
                    });
                    mediaPosterCanvas.add(img);
                    mediaPosterCanvas.setActiveObject(img);
                    mediaPosterCanvas.renderAll();
                    updateMediaPosterLayers();
                    addNotification('Image added to canvas!', 'success');
                });
            };
            reader.readAsDataURL(file);
        }
        
        function setMediaPosterBgColor(color) {
            if (!mediaPosterCanvas) return;
            mediaPosterCanvas.backgroundColor = color;
            mediaPosterCanvas.renderAll();
        }
        
        function setMediaPosterGradientBg() {
            if (!mediaPosterCanvas) return;
            
            const gradients = [
                ['#667eea', '#764ba2'],
                ['#f093fb', '#f5576c'],
                ['#4facfe', '#00f2fe'],
                ['#43e97b', '#38f9d7'],
                ['#fa709a', '#fee140'],
                ['#a8edea', '#fed6e3']
            ];
            
            const randomGradient = gradients[Math.floor(Math.random() * gradients.length)];
            
            const gradient = new fabric.Gradient({
                type: 'linear',
                coords: { x1: 0, y1: 0, x2: mediaPosterCanvas.width, y2: mediaPosterCanvas.height },
                colorStops: [
                    { offset: 0, color: randomGradient[0] },
                    { offset: 1, color: randomGradient[1] }
                ]
            });
            
            // Create a rectangle with gradient as background
            const bgRect = new fabric.Rect({
                width: mediaPosterCanvas.width,
                height: mediaPosterCanvas.height,
                fill: gradient,
                selectable: false,
                evented: false
            });
            
            // Remove any existing background rectangle
            const objects = mediaPosterCanvas.getObjects();
            objects.forEach(obj => {
                if (obj.isBackgroundRect) {
                    mediaPosterCanvas.remove(obj);
                }
            });
            
            bgRect.isBackgroundRect = true;
            mediaPosterCanvas.add(bgRect);
            mediaPosterCanvas.sendToBack(bgRect);
            mediaPosterCanvas.renderAll();
            addNotification('Gradient background applied!', 'success');
        }
        
        function setMediaPosterRandomBg() {
            if (!mediaPosterCanvas) return;
            
            const colors = ['#f0f4f8', '#e0e5ec', '#ffecd2', '#fcb69f', '#a1c4fd', '#c2e9fb', '#d4fc79', '#96e6a1'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            mediaPosterCanvas.backgroundColor = randomColor;
            mediaPosterCanvas.renderAll();
            addNotification('Random background applied!', 'success');
        }
        
        function loadMediaPosterTemplate(type) {
            if (!mediaPosterCanvas) {
                initMediaPosterCanvas();
                setTimeout(() => loadMediaPosterTemplate(type), CANVAS_INIT_DELAY);
                return;
            }
            
            mediaPosterCanvas.clear();
            
            switch(type) {
                case 'event':
                    mediaPosterCanvas.backgroundColor = '#1a1a2e';
                    addMediaPosterText('SCHOOL EVENT', 70);
                    setTimeout(() => {
                        const dateText = new fabric.Textbox('December 2025\nJoin us for an exciting event!', {
                            left: 150,
                            top: 350,
                            width: 400,
                            fontSize: 30,
                            fontFamily: 'Arial',
                            fill: '#ffffff',
                            textAlign: 'center'
                        });
                        mediaPosterCanvas.add(dateText);
                        mediaPosterCanvas.renderAll();
                        updateMediaPosterLayers();
                    }, 100);
                    break;
                case 'sale':
                    mediaPosterCanvas.backgroundColor = '#f5576c';
                    addMediaPosterText('BIG SALE!', 80);
                    setTimeout(() => {
                        const discountText = new fabric.Textbox('Up to 50% OFF\nLimited Time Only', {
                            left: 150,
                            top: 350,
                            width: 400,
                            fontSize: 35,
                            fontFamily: 'Arial',
                            fill: '#ffffff',
                            textAlign: 'center',
                            fontWeight: 'bold'
                        });
                        mediaPosterCanvas.add(discountText);
                        mediaPosterCanvas.renderAll();
                        updateMediaPosterLayers();
                    }, 100);
                    break;
                case 'school':
                    setMediaPosterGradientBg();
                    setTimeout(() => {
                        addMediaPosterText('Bophelong\nIndependent School', 50);
                    }, 100);
                    break;
            }
            
            mediaPosterCanvas.renderAll();
            addNotification('Template loaded!', 'success');
        }
        
        function setMediaPosterProp(prop, value) {
            if (!mediaPosterActiveObject) return;
            mediaPosterActiveObject.set(prop, value);
            mediaPosterCanvas.renderAll();
            updateMediaPosterLayers();
        }
        
        function toggleMediaPosterProp(prop, value) {
            if (!mediaPosterActiveObject) return;
            const current = mediaPosterActiveObject.get(prop);
            mediaPosterActiveObject.set(prop, current === value ? 'normal' : value);
            mediaPosterCanvas.renderAll();
        }
        
        function bringMediaPosterToFront() {
            if (!mediaPosterActiveObject) return;
            mediaPosterCanvas.bringToFront(mediaPosterActiveObject);
            mediaPosterCanvas.renderAll();
            updateMediaPosterLayers();
        }
        
        function sendMediaPosterToBack() {
            if (!mediaPosterActiveObject) return;
            mediaPosterCanvas.sendToBack(mediaPosterActiveObject);
            mediaPosterCanvas.renderAll();
            updateMediaPosterLayers();
        }
        
        function duplicateMediaPosterObject() {
            if (!mediaPosterActiveObject) return;
            
            mediaPosterActiveObject.clone(function(cloned) {
                cloned.set({
                    left: cloned.left + 20,
                    top: cloned.top + 20
                });
                mediaPosterCanvas.add(cloned);
                mediaPosterCanvas.setActiveObject(cloned);
                mediaPosterCanvas.renderAll();
                updateMediaPosterLayers();
            });
        }
        
        function deleteMediaPosterActive() {
            if (!mediaPosterActiveObject) {
                addNotification('Please select an object to delete', 'warning');
                return;
            }
            mediaPosterCanvas.remove(mediaPosterActiveObject);
            mediaPosterActiveObject = null;
            mediaPosterCanvas.renderAll();
            updateMediaPosterLayers();
            document.getElementById('media-poster-props').style.display = 'none';
        }
        
        function downloadMediaPoster() {
            if (!mediaPosterCanvas) {
                addNotification('Please create a poster first', 'warning');
                return;
            }
            
            try {
                const dataURL = mediaPosterCanvas.toDataURL({
                    format: 'png',
                    multiplier: 2
                });
                
                const link = document.createElement('a');
                link.download = 'poster-' + Date.now() + '.png';
                link.href = dataURL;
                link.click();
                
                addNotification('Poster downloaded successfully!', 'success');
            } catch (error) {
                addNotification('Error downloading poster: ' + error.message, 'error');
            }
        }
        
        function exportMediaPosterPDF() {
            if (!mediaPosterCanvas) {
                addNotification('Please create a poster first', 'warning');
                return;
            }
            
            if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
                addNotification('PDF library not loaded. Please try again.', 'warning');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4');
                
                const imgData = mediaPosterCanvas.toDataURL({
                    format: 'png',
                    multiplier: 2
                });
                
                pdf.addImage(imgData, 'PNG', 10, 10, 277, 190);
                pdf.save('poster-' + Date.now() + '.pdf');
                
                addNotification('PDF exported successfully!', 'success');
            } catch (error) {
                addNotification('Error exporting PDF: ' + error.message, 'error');
            }
        }
        
        function sendMediaPosterAsAnnouncement() {
            if (!mediaPosterCanvas) {
                addNotification('Please create a poster first', 'warning');
                return;
            }
            
            const title = prompt('Enter announcement title:', 'New Poster Announcement');
            if (!title) return;
            
            try {
                const posterImage = mediaPosterCanvas.toDataURL({
                    format: 'png',
                    multiplier: 1
                });
                
                const announcement = {
                    id: Date.now(),
                    title: title,
                    content: '<img src="' + posterImage + '" alt="Poster" style="max-width: 100%; border-radius: 10px;">',
                    isPoster: true,
                    posterImage: posterImage,
                    priority: 'Medium',
                    audience: 'All',
                    createdAt: new Date().toISOString(),
                    author: currentUser.name
                };
                
                announcements.push(announcement);
                localStorage.setItem('announcements', JSON.stringify(announcements));
                
                addNotification('Poster sent as announcement!', 'success');
                logAudit('Poster Announcement', 'Created poster announcement: ' + title, 'Medium');
            } catch (error) {
                addNotification('Error sending poster: ' + error.message, 'error');
            }
        }
        
        function clearMediaPosterCanvas() {
            if (!mediaPosterCanvas) return;
            
            if (confirm('Are you sure you want to clear the canvas? This cannot be undone.')) {
                mediaPosterCanvas.clear();
                mediaPosterCanvas.backgroundColor = '#ffffff';
                mediaPosterCanvas.renderAll();
                updateMediaPosterLayers();
                addNotification('Canvas cleared!', 'info');
            }
        }
        
        // ========================================
        // VIDEO CREATOR FUNCTIONS
        // ========================================
        
        // Constants for Video Creator
        const MAX_RECORDING_SECONDS = 10 * 60; // 10 minutes
        
        let videoCreatorStream = null;
        let videoCreatorRecorder = null;
        let videoCreatorChunks = [];
        let videoCreatorRecordedBlob = null;
        let videoRecordingTimer = null;
        let videoRecordingSeconds = 0;
        let isVideoRecording = false;
        let recordedVideos = [];
        
        // Initialize camera devices
        async function initVideoCreatorDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                
                const cameraSelect = document.getElementById('videoCreatorCameraSelect');
                const micSelect = document.getElementById('videoCreatorMicSelect');
                
                // Clear existing options except first
                while (cameraSelect.options.length > 1) cameraSelect.remove(1);
                while (micSelect.options.length > 1) micSelect.remove(1);
                
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    
                    if (device.kind === 'videoinput') {
                        option.textContent = device.label || 'Camera ' + (cameraSelect.options.length);
                        cameraSelect.appendChild(option);
                    } else if (device.kind === 'audioinput') {
                        option.textContent = device.label || 'Microphone ' + (micSelect.options.length);
                        micSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error enumerating devices:', error);
            }
        }
        
        async function initVideoCreatorCamera() {
            try {
                const cameraId = document.getElementById('videoCreatorCameraSelect').value;
                const micId = document.getElementById('videoCreatorMicSelect').value;
                const quality = document.getElementById('videoCreatorQuality').value;
                
                const constraints = {
                    video: {
                        width: { ideal: quality === '1080' ? 1920 : quality === '720' ? 1280 : 854 },
                        height: { ideal: quality === '1080' ? 1080 : quality === '720' ? 720 : 480 }
                    },
                    audio: true
                };
                
                if (cameraId) constraints.video.deviceId = { exact: cameraId };
                if (micId) constraints.audio = { deviceId: { exact: micId } };
                
                // Stop existing stream
                if (videoCreatorStream) {
                    videoCreatorStream.getTracks().forEach(track => track.stop());
                }
                
                videoCreatorStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const preview = document.getElementById('videoCreatorPreview');
                preview.srcObject = videoCreatorStream;
                preview.style.display = 'block';
                
                document.getElementById('videoCreatorRecording').style.display = 'none';
                document.getElementById('videoTimeline').style.display = 'none';
                
                // Enumerate devices again to get labels
                await initVideoCreatorDevices();
                
                addNotification('Camera started successfully!', 'success');
            } catch (error) {
                console.error('Error accessing camera:', error);
                addNotification('Error accessing camera: ' + error.message, 'error');
            }
        }
        
        function toggleVideoRecording() {
            if (isVideoRecording) {
                stopVideoRecording();
            } else {
                startVideoRecording();
            }
        }
        
        async function startVideoRecording() {
            if (!videoCreatorStream) {
                addNotification('Please start the camera first', 'warning');
                return;
            }
            
            try {
                videoCreatorChunks = [];
                
                const options = { mimeType: 'video/webm;codecs=vp9,opus' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm;codecs=vp8,opus';
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm';
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/mp4';
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    addNotification('Your browser does not support video recording. Please try a different browser like Chrome or Firefox.', 'error');
                    return;
                }
                
                videoCreatorRecorder = new MediaRecorder(videoCreatorStream, options);
                
                videoCreatorRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        videoCreatorChunks.push(event.data);
                    }
                };
                
                videoCreatorRecorder.onstop = () => {
                    videoCreatorRecordedBlob = new Blob(videoCreatorChunks, { type: 'video/webm' });
                    const videoURL = URL.createObjectURL(videoCreatorRecordedBlob);
                    
                    const recordingVideo = document.getElementById('videoCreatorRecording');
                    recordingVideo.src = videoURL;
                    recordingVideo.style.display = 'block';
                    
                    document.getElementById('videoCreatorPreview').style.display = 'none';
                    document.getElementById('videoTimeline').style.display = 'block';
                    
                    // Enable export buttons
                    document.getElementById('downloadVideoBtn').disabled = false;
                    document.getElementById('sendVideoAnnouncementBtn').disabled = false;
                    document.getElementById('trimVideoBtn').disabled = false;
                    
                    // Add to recorded videos list
                    addToRecordedVideosList(videoURL);
                    
                    addNotification('Recording saved! You can now edit and export.', 'success');
                };
                
                videoCreatorRecorder.start(1000); // Collect data every second
                isVideoRecording = true;
                
                // Update UI
                document.getElementById('videoRecordBtn').classList.add('recording');
                document.getElementById('recordingIndicator').style.display = 'block';
                
                // Start timer
                videoRecordingSeconds = 0;
                updateRecordingTimer();
                videoRecordingTimer = setInterval(updateRecordingTimer, 1000);
                
                addNotification('Recording started!', 'info');
            } catch (error) {
                console.error('Error starting recording:', error);
                addNotification('Error starting recording: ' + error.message, 'error');
            }
        }
        
        function stopVideoRecording() {
            if (videoCreatorRecorder && videoCreatorRecorder.state !== 'inactive') {
                videoCreatorRecorder.stop();
            }
            
            isVideoRecording = false;
            
            // Update UI
            document.getElementById('videoRecordBtn').classList.remove('recording');
            document.getElementById('recordingIndicator').style.display = 'none';
            
            // Stop timer
            if (videoRecordingTimer) {
                clearInterval(videoRecordingTimer);
                videoRecordingTimer = null;
            }
        }
        
        function updateRecordingTimer() {
            videoRecordingSeconds++;
            const minutes = Math.floor(videoRecordingSeconds / 60);
            const seconds = videoRecordingSeconds % 60;
            document.getElementById('videoRecordingTimer').textContent = 
                String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            
            // Auto-stop after max recording time
            if (videoRecordingSeconds >= MAX_RECORDING_SECONDS) {
                stopVideoRecording();
                addNotification('Recording stopped - maximum 10 minutes reached', 'warning');
            }
        }
        
        function addToRecordedVideosList(videoURL) {
            const videoInfo = {
                id: Date.now(),
                url: videoURL,
                duration: formatDuration(videoRecordingSeconds),
                timestamp: new Date().toLocaleString()
            };
            
            recordedVideos.push(videoInfo);
            renderRecordedVideosList();
        }
        
        function renderRecordedVideosList() {
            const list = document.getElementById('recordedVideosList');
            
            if (recordedVideos.length === 0) {
                list.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; font-size: 12px;">No videos recorded yet</p>';
                return;
            }
            
            list.innerHTML = recordedVideos.map(video => `
                <div class="recorded-video-item" onclick="loadRecordedVideo('${video.url}')">
                    <div style="width: 60px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-video" style="color: #e94560;"></i>
                    </div>
                    <div class="video-info">
                        <h6>Recording ${recordedVideos.indexOf(video) + 1}</h6>
                        <small>${video.duration}  ${video.timestamp}</small>
                    </div>
                </div>
            `).join('');
        }
        
        function loadRecordedVideo(url) {
            const recordingVideo = document.getElementById('videoCreatorRecording');
            recordingVideo.src = url;
            recordingVideo.style.display = 'block';
            document.getElementById('videoCreatorPreview').style.display = 'none';
            document.getElementById('videoTimeline').style.display = 'block';
        }
        
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins + ':' + String(secs).padStart(2, '0');
        }
        
        function toggleVideoCreatorMute() {
            if (!videoCreatorStream) return;
            
            const audioTrack = videoCreatorStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                const btn = document.getElementById('videoCreatorMuteBtn');
                if (audioTrack.enabled) {
                    btn.innerHTML = '<i class="fas fa-microphone"></i>';
                    btn.style.background = 'rgba(255, 255, 255, 0.2)';
                } else {
                    btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                    btn.style.background = 'rgba(239, 68, 68, 0.6)';
                }
            }
        }
        
        function toggleVideoCreatorCamera() {
            if (!videoCreatorStream) return;
            
            const videoTrack = videoCreatorStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                const btn = document.getElementById('videoCreatorCameraBtn');
                if (videoTrack.enabled) {
                    btn.innerHTML = '<i class="fas fa-video"></i>';
                    btn.style.background = 'rgba(255, 255, 255, 0.2)';
                } else {
                    btn.innerHTML = '<i class="fas fa-video-slash"></i>';
                    btn.style.background = 'rgba(239, 68, 68, 0.6)';
                }
            }
        }
        
        function addVideoOverlayText() {
            const text = document.getElementById('videoOverlayText').value.trim();
            if (!text) {
                addNotification('Please enter text for the overlay', 'warning');
                return;
            }
            
            const color = document.getElementById('videoOverlayColor').value;
            const size = document.getElementById('videoOverlaySize').value;
            
            // This would require more advanced video editing capabilities
            // For now, show a message about the feature
            addNotification('Text overlay "' + text + '" will be added to the video when exported.', 'info');
        }
        
        function trimVideoRecording() {
            const startTime = document.getElementById('videoTrimStart').value;
            const endTime = document.getElementById('videoTrimEnd').value;
            
            // This would require more advanced video editing
            addNotification('Trim applied from ' + startTime + ' to ' + endTime, 'info');
        }
        
        function downloadVideoRecording() {
            if (!videoCreatorRecordedBlob) {
                addNotification('No video to download. Please record a video first.', 'warning');
                return;
            }
            
            const title = document.getElementById('videoCreatorTitle').value.trim() || 'video-recording';
            const sanitizedTitle = title.replace(/[^a-z0-9]/gi, '-').toLowerCase();
            
            const url = URL.createObjectURL(videoCreatorRecordedBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = sanitizedTitle + '-' + Date.now() + '.webm';
            link.click();
            
            URL.revokeObjectURL(url);
            addNotification('Video downloaded successfully!', 'success');
        }
        
        function sendVideoAsAnnouncement() {
            if (!videoCreatorRecordedBlob) {
                addNotification('No video to send. Please record a video first.', 'warning');
                return;
            }
            
            const title = document.getElementById('videoCreatorTitle').value.trim() || 'Video Announcement';
            const description = document.getElementById('videoCreatorDescription').value.trim() || '';
            
            // Convert blob to base64 for storage (note: this is for demo purposes)
            const reader = new FileReader();
            reader.onload = function() {
                const videoData = reader.result;
                
                const announcement = {
                    id: Date.now(),
                    title: title,
                    content: description + '\n\n<video controls style="max-width: 100%; border-radius: 10px;"><source src="' + videoData + '" type="video/webm"></video>',
                    isVideo: true,
                    videoData: videoData,
                    priority: 'High',
                    audience: 'All',
                    createdAt: new Date().toISOString(),
                    author: currentUser.name
                };
                
                announcements.push(announcement);
                localStorage.setItem('announcements', JSON.stringify(announcements));
                
                addNotification('Video announcement published!', 'success');
                logAudit('Video Announcement', 'Created video announcement: ' + title, 'High');
            };
            reader.readAsDataURL(videoCreatorRecordedBlob);
        }
        
        function clearVideoRecording() {
            if (confirm('Are you sure you want to discard the current recording?')) {
                videoCreatorRecordedBlob = null;
                videoCreatorChunks = [];
                
                document.getElementById('videoCreatorRecording').src = '';
                document.getElementById('videoCreatorRecording').style.display = 'none';
                document.getElementById('videoCreatorPreview').style.display = 'block';
                document.getElementById('videoTimeline').style.display = 'none';
                
                document.getElementById('downloadVideoBtn').disabled = true;
                document.getElementById('sendVideoAnnouncementBtn').disabled = true;
                document.getElementById('trimVideoBtn').disabled = true;
                
                document.getElementById('videoRecordingTimer').textContent = '00:00';
                videoRecordingSeconds = 0;
                
                addNotification('Recording discarded', 'info');
            }
        }
        
        // Initialize video creator when tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Video tab initialization removed - incomplete code
        });
        
        // Navigation helper functions for announcements modal
        function goToPosterCreator() {
            try {
                // Use Bootstrap modal API to properly hide the modal
                const modal = document.getElementById('announcementsModal');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) bsModal.hide();
                }
                showSection('media');
            } catch (error) {
                console.error('Error navigating to poster creator:', error);
            }
        }
        
        function goToVideoCreator() {
            try {
                // Use Bootstrap modal API to properly hide the modal
                const modal = document.getElementById('announcementsModal');
                if (modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) bsModal.hide();
                }
                showSection('media');
            } catch (error) {
                console.error('Error navigating to video creator:', error);
            }
        }
        
        // Live Chat Functionality
        let liveChatMessages = JSON.parse(localStorage.getItem('liveChatMessages') || '[]');
        let liveChatInterval = null;
        
        function startLiveChat() {
            document.getElementById('liveChatContainer').classList.remove('d-none');
            renderLiveChatMessages();
            addNotification('Live chat started! You can now communicate with all students and teachers.', 'success');
            
            // Auto-refresh chat every 2 seconds
            if (liveChatInterval) clearInterval(liveChatInterval);
            liveChatInterval = setInterval(renderLiveChatMessages, 2000);
        }
        
        function closeLiveChat() {
            document.getElementById('liveChatContainer').classList.add('d-none');
            if (liveChatInterval) {
                clearInterval(liveChatInterval);
                liveChatInterval = null;
            }
        }
        
        function sendLiveChatMessage() {
            // Validate user is logged in
            if (!validateUserLogin('send messages')) return;
            
            const input = document.getElementById('liveChatInput');
            const text = input.value.trim();
            
            if (!text) {
                addNotification('Please enter a message', 'warning');
                return;
            }
            
            // Get selected recipient type
            const recipientType = document.querySelector('input[name="recipientType"]:checked')?.value || 'teachers';
            
            const message = {
                id: Date.now(),
                sender: currentUser.name,
                role: currentUser.role,
                text: text,
                recipientType: recipientType,
                timestamp: new Date().toISOString()
            };
            
            liveChatMessages.push(message);
            localStorage.setItem('liveChatMessages', JSON.stringify(liveChatMessages));
            
            input.value = '';
            renderLiveChatMessages();
            
            // Scroll to bottom
            const container = document.getElementById('liveChatMessages');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
            
            // Show success notification with recipient type
            const recipientLabel = recipientType.charAt(0).toUpperCase() + recipientType.slice(1);
            addNotification(` Message sent to ${recipientLabel}`, 'success');
        }
        
        function renderLiveChatMessages() {
            const container = document.getElementById('liveChatMessages');
            if (!container) return;
            
            // Get last 50 messages
            const recentMessages = liveChatMessages.slice(-50);
            
            let html = '';
            recentMessages.forEach(msg => {
                const isCurrentUser = msg.sender === currentUser.name;
                const alignClass = isCurrentUser ? 'text-end' : 'text-start';
                const bgClass = isCurrentUser ? 'bg-primary' : 'bg-secondary';
                const roleColor = msg.role === 'teacher' ? 'warning' : msg.role === 'admin' ? 'danger' : 'info';
                
                // Get recipient badge
                const recipientBadge = msg.recipientType ? getRecipientBadge(msg.recipientType) : '';
                
                // Handle different message types
                if (msg.type === 'voice_note') {
                    html += `
                        <div class="${alignClass} mb-3">
                            <div class="d-inline-block" style="max-width: 70%;">
                                <div class="mb-1">
                                    <span class="badge bg-${roleColor}">${msg.sender}</span>
                                    ${recipientBadge}
                                    <small class="text-muted ms-2">${new Date(msg.timestamp).toLocaleString()}</small>
                                </div>
                                <div class="voice-note-message">
                                    <div class="voice-note-player">
                                        <button class="play-btn" onclick="playVoiceNote('${msg.audioUrl}', this)">
                                            <i class="fas fa-play text-white"></i>
                                        </button>
                                        <div class="waveform"></div>
                                        <span class="text-muted"> ${formatDuration(msg.duration)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (msg.type === 'call_log') {
                    html += `
                        <div class="text-center mb-3">
                            <div class="voice-call-notification d-inline-block">
                                <i class="fas fa-phone-alt me-2"></i>${msg.text}
                                ${recipientBadge}
                                <br><small class="text-muted">Participants: ${msg.participants ? msg.participants.join(', ') : 'N/A'}</small>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="${alignClass} mb-3">
                            <div class="d-inline-block" style="max-width: 70%;">
                                <div class="mb-1">
                                    <span class="badge bg-${roleColor}">${msg.sender}</span>
                                    ${recipientBadge}
                                    <small class="text-muted ms-2">${new Date(msg.timestamp).toLocaleString()}</small>
                                </div>
                                <div class="p-3 rounded ${bgClass}" style="word-wrap: break-word;">
                                    ${msg.text}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html || '<p class="text-center text-muted">No messages yet. Start the conversation!</p>';
        }
        
        // Helper function to get recipient badge HTML
        function getRecipientBadge(recipientType) {
            const badges = {
                'teachers': '<span class="recipient-badge teachers"><i class="fas fa-chalkboard-teacher"></i> Teachers</span>',
                'parents': '<span class="recipient-badge parents"><i class="fas fa-user-friends"></i> Parents</span>',
                'students': '<span class="recipient-badge students"><i class="fas fa-user-graduate"></i> Students</span>',
                'hod': '<span class="recipient-badge hod"><i class="fas fa-user-tie"></i> HOD</span>'
            };
            return badges[recipientType] || '';
        }
        
        function startChat() {
            startLiveChat();
        }
        
        // ========================================
        // VOICE NOTE AND VOICE CALL FUNCTIONS
        // ========================================
        
        // Voice Note Variables
        var mediaRecorder = null;
        var audioChunks = [];
        var recordingTimer = null;
        var recordingSeconds = 0;
        var currentRecordingContext = null; // 'live', 'teacher', 'parent'
        
        // Voice Call Variables
        let activeVoiceCall = null;
        let callParticipants = [];
        let isMuted = false;
        let peerConnections = {};
        
        // ===== LIVE CHAT VOICE NOTE FUNCTIONS =====
        function startVoiceNote() {
            // Validate user is logged in
            if (!validateUserLogin('send voice notes')) return;
            
            currentRecordingContext = 'live';
            startRecording('voiceNoteControls', 'recordingDuration');
        }
        
        function cancelVoiceNote() {
            cancelRecording('voiceNoteControls');
        }
        
        function sendVoiceNote() {
            stopRecordingAndSend('live', 'voiceNoteControls');
        }
        
        // ===== TEACHER CHAT VOICE NOTE FUNCTIONS =====
        function startTeacherVoiceNote() {
            if (!selectedChatStudent) {
                addNotification('Please select a student first', 'warning');
                return;
            }
            currentRecordingContext = 'teacher';
            startRecording('teacherVoiceNoteControls', 'teacherRecordingDuration');
        }
        
        function cancelTeacherVoiceNote() {
            cancelRecording('teacherVoiceNoteControls');
        }
        
        function sendTeacherVoiceNote() {
            stopRecordingAndSend('teacher', 'teacherVoiceNoteControls');
        }
        
        // ===== PARENT CHAT VOICE NOTE FUNCTIONS =====
        function startParentVoiceNote() {
            currentRecordingContext = 'parent';
            startRecording('parentVoiceNoteControls', 'parentRecordingDuration');
        }
        
        function cancelParentVoiceNote() {
            cancelRecording('parentVoiceNoteControls');
        }
        
        function sendParentVoiceNote() {
            stopRecordingAndSend('parent', 'parentVoiceNoteControls');
        }
        
        // ===== COMMON RECORDING FUNCTIONS =====
        async function startRecording(controlsId, durationId) {
            try {
                // Check browser compatibility including MediaRecorder
                if (!checkMediaDeviceSupport(true)) return;
                
                // Show permission request notification
                addNotification('Requesting microphone access for voice note...', 'info');
                
                // Try with enhanced audio settings first, fallback to basic if not supported
                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                } catch (enhancedErr) {
                    // Fallback to basic audio if enhanced settings not supported
                    console.log('Enhanced audio settings not supported, using basic audio');
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                
                // Try to use the best available audio codec
                // webm with opus is widely supported and has good quality
                const mimeTypes = [
                    'audio/webm;codecs=opus',
                    'audio/webm',
                    'audio/ogg;codecs=opus',
                    'audio/mp4',
                    ''  // Fall back to browser default
                ];
                
                let options = {};
                for (const mimeType of mimeTypes) {
                    if (mimeType === '' || MediaRecorder.isTypeSupported(mimeType)) {
                        if (mimeType !== '') {
                            options.mimeType = mimeType;
                        }
                        break;
                    }
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                recordingSeconds = 0;
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                // Request data chunks every 250ms for smoother recording and smaller memory footprint
                // This interval provides a good balance between audio quality and responsiveness
                const DATA_CHUNK_INTERVAL_MS = 250;
                mediaRecorder.start(DATA_CHUNK_INTERVAL_MS);
                
                const controlsElement = document.getElementById(controlsId);
                if (controlsElement) {
                    controlsElement.style.display = 'block';
                }
                
                // Start timer
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const mins = Math.floor(recordingSeconds / 60);
                    const secs = recordingSeconds % 60;
                    const durationElement = document.getElementById(durationId);
                    if (durationElement) {
                        durationElement.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    }
                }, 1000);
                
                addNotification(' Recording started... Speak now!', 'success');
            } catch (err) {
                console.error('Error accessing microphone:', err);
                
                let errorMessage = 'Unable to access microphone. ';
                if (err.name === 'NotAllowedError') {
                    errorMessage += 'Microphone access was denied. Please allow microphone access in your browser settings.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage += 'No microphone found. Please connect a microphone and try again.';
                } else if (err.name === 'NotReadableError') {
                    errorMessage += 'Microphone is already in use by another application.';
                } else {
                    errorMessage += 'Please check your microphone permissions and try again.';
                }
                
                addNotification(errorMessage, 'error');
            }
        }
        
        function cancelRecording(controlsId) {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            clearInterval(recordingTimer);
            document.getElementById(controlsId).style.display = 'none';
            audioChunks = [];
            recordingSeconds = 0;
            addNotification('Recording cancelled', 'info');
        }
        
        function stopRecordingAndSend(context, controlsId) {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                addNotification('No recording in progress', 'warning');
                return;
            }
            
            mediaRecorder.onstop = () => {
                // Determine MIME type based on what MediaRecorder actually used
                const mimeType = mediaRecorder.mimeType || 'audio/webm';
                const audioBlob = new Blob(audioChunks, { type: mimeType });
                
                // Convert blob to base64 data URL for persistent storage
                // Blob URLs don't persist across page reloads, but data URLs do
                const reader = new FileReader();
                reader.onloadend = () => {
                    const audioDataUrl = reader.result; // This is a base64 data URL
                    
                    // Get selected recipient type for live chat
                    const recipientType = context === 'live' ? 
                        (document.querySelector('input[name="recipientType"]:checked')?.value || 'teachers') : 
                        null;
                    
                    // Create voice note message with persistent audio data
                    const voiceNoteMessage = {
                        id: Date.now(),
                        sender: currentUser.name,
                        role: currentUser.role,
                        type: 'voice_note',
                        audioUrl: audioDataUrl,
                        duration: recordingSeconds,
                        recipientType: recipientType,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Add message based on context
                    if (context === 'live') {
                        liveChatMessages.push(voiceNoteMessage);
                        localStorage.setItem('liveChatMessages', JSON.stringify(liveChatMessages));
                        renderLiveChatMessages();
                        
                        // Broadcast voice note to all users immediately
                        if (typeof broadcastVoiceNote === 'function') {
                            broadcastVoiceNote({
                                audioUrl: audioDataUrl,
                                duration: recordingSeconds
                            }, 'live');
                        }
                    } else if (context === 'teacher') {
                        const chatMessage = {
                            id: Date.now(),
                            studentId: selectedChatStudent.id,
                            senderId: 'teacher',
                            senderName: currentUser.name,
                            type: 'voice_note',
                            message: ' Voice Note (' + formatDuration(recordingSeconds) + ')',
                            audioUrl: audioDataUrl,
                            duration: recordingSeconds,
                            timestamp: new Date().toISOString(),
                            read: false
                        };
                        teacherChats.push(chatMessage);
                        localStorage.setItem('teacherChats', JSON.stringify(teacherChats));
                        loadChatMessages();
                        
                        // Broadcast teacher voice note
                        if (typeof broadcastVoiceNote === 'function') {
                            broadcastVoiceNote({
                                audioUrl: audioDataUrl,
                                duration: recordingSeconds
                            }, 'teacher');
                        }
                    } else if (context === 'parent') {
                        addVoiceNoteToParentChat(voiceNoteMessage);
                        
                        // Broadcast parent voice note
                        if (typeof broadcastVoiceNote === 'function') {
                            broadcastVoiceNote({
                                audioUrl: audioDataUrl,
                                duration: recordingSeconds
                            }, 'parent');
                        }
                    }
                    
                    addNotification('Voice note sent and broadcast to all users!', 'success');
                };
                
                reader.onerror = () => {
                    console.error('Error converting audio to base64:', reader.error);
                    addNotification('Error saving voice note. Please try again.', 'error');
                };
                
                reader.readAsDataURL(audioBlob);
                
                // Clean up
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                document.getElementById(controlsId).style.display = 'none';
                clearInterval(recordingTimer);
                recordingSeconds = 0;
                audioChunks = [];
            };
            
            mediaRecorder.stop();
        }
        
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function addVoiceNoteToParentChat(voiceNote) {
            const chatContainer = document.getElementById('parentChatMessages');
            const messageHtml = `
                <div class="voice-note-message">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-info">${voiceNote.sender}</span>
                        <small class="text-muted">${new Date(voiceNote.timestamp).toLocaleString()}</small>
                    </div>
                    <div class="voice-note-player">
                        <button class="play-btn" onclick="playVoiceNote('${voiceNote.audioUrl}', this)">
                            <i class="fas fa-play text-white"></i>
                        </button>
                        <div class="waveform"></div>
                        <span class="text-muted">${formatDuration(voiceNote.duration)}</span>
                    </div>
                </div>
            `;
            
            if (chatContainer.innerHTML.includes('No messages yet')) {
                chatContainer.innerHTML = messageHtml;
            } else {
                chatContainer.innerHTML += messageHtml;
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Store currently playing audio to allow pause/resume
        let currentPlayingAudio = null;
        let currentPlayingButton = null;
        
        function playVoiceNote(audioUrl, button) {
            const icon = button.querySelector('i');
            
            // If there's a currently playing audio
            if (currentPlayingAudio) {
                // If clicking the same button, pause/resume
                if (currentPlayingButton === button) {
                    if (currentPlayingAudio.paused) {
                        currentPlayingAudio.play().catch(handleAudioError);
                        icon.className = 'fas fa-pause text-white';
                    } else {
                        currentPlayingAudio.pause();
                        icon.className = 'fas fa-play text-white';
                    }
                    return;
                } else {
                    // Stop the previously playing audio
                    currentPlayingAudio.pause();
                    currentPlayingAudio.currentTime = 0;
                    if (currentPlayingButton) {
                        const prevIcon = currentPlayingButton.querySelector('i');
                        if (prevIcon) prevIcon.className = 'fas fa-play text-white';
                    }
                }
            }
            
            // Check if audioUrl is valid (handle null, undefined, empty string, and string versions)
            if (!audioUrl || audioUrl === '' || String(audioUrl) === 'undefined' || String(audioUrl) === 'null') {
                addNotification('Audio not available. The voice note may have been recorded in a previous session.', 'warning');
                return;
            }
            
            const audio = new Audio();
            
            // Set up event handlers before setting source
            audio.onloadeddata = () => {
                audio.play()
                    .then(() => {
                        // Only change icon to pause after audio successfully starts playing
                        icon.className = 'fas fa-pause text-white';
                    })
                    .catch(handleAudioError);
            };
            
            audio.onended = () => {
                icon.className = 'fas fa-play text-white';
                currentPlayingAudio = null;
                currentPlayingButton = null;
            };
            
            audio.onerror = (e) => {
                console.error('Audio playback error:', e);
                icon.className = 'fas fa-play text-white';
                addNotification('Unable to play voice note. Audio format may not be supported.', 'error');
                currentPlayingAudio = null;
                currentPlayingButton = null;
            };
            
            // Set source and load
            audio.src = audioUrl;
            audio.load();
            
            currentPlayingAudio = audio;
            currentPlayingButton = button;
        }
        
        function handleAudioError(error) {
            console.error('Audio play error:', error);
            if (error.name === 'NotAllowedError') {
                addNotification('Audio playback blocked. Please interact with the page first.', 'warning');
            } else {
                addNotification('Error playing audio: ' + error.message, 'error');
            }
        }
        
        // ===== VOICE CALL FUNCTIONS =====
        function startVoiceCall() {
            // Validate user is logged in
            if (!validateUserLogin('start a call')) return;
            
            // Initialize the voice call
            initVoiceCall('live');
        }
        
        function startTeacherVoiceCall() {
            if (!selectedChatStudent) {
                addNotification('Please select a student first', 'warning');
                return;
            }
            initVoiceCall('teacher');
        }
        
        function startParentVoiceCall() {
            initVoiceCall('parent');
        }
        
        async function initVoiceCall(context) {
            try {
                // Check browser compatibility
                if (!checkMediaDeviceSupport()) return;
                
                // Get selected recipient type
                const recipientType = document.querySelector('input[name="recipientType"]:checked')?.value || 'teachers';
                
                // Request microphone permission with enhanced audio settings
                addNotification('Requesting microphone access...', 'info');
                
                // Try with enhanced audio settings first, fallback to basic if not supported
                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                } catch (enhancedErr) {
                    // Fallback to basic audio if enhanced settings not supported
                    console.log('Enhanced audio settings not supported, using basic audio');
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                
                activeVoiceCall = {
                    context: context,
                    recipientType: recipientType,
                    startTime: Date.now(),
                    stream: stream,
                    participants: [{ name: currentUser.name, role: currentUser.role, isMuted: false }]
                };
                
                callParticipants = [{ name: currentUser.name, role: currentUser.role, isMuted: false }];
                isMuted = false;
                
                // Show call controls based on context
                if (context === 'live') {
                    const controlsElement = document.getElementById('voiceCallControls');
                    if (controlsElement) {
                        controlsElement.style.display = 'block';
                        // Update recipient type badge
                        const recipientBadge = document.getElementById('voiceCallRecipientType');
                        if (recipientBadge) {
                            recipientBadge.innerHTML = getRecipientBadgeText(recipientType);
                            recipientBadge.className = `badge recipient-badge ${recipientType} ms-2`;
                        }
                        updateCallStatus('voiceCallControls', 'callStatusText', 'callParticipantCount');
                        updateVoiceParticipantsList();
                    }
                } else if (context === 'teacher') {
                    const controlsElement = document.getElementById('teacherVoiceCallControls');
                    if (controlsElement) {
                        controlsElement.style.display = 'block';
                        updateCallStatus('teacherVoiceCallControls', 'teacherCallStatusText', 'teacherCallParticipantCount');
                        // Add student to call
                        if (selectedChatStudent) {
                            callParticipants.push({ name: selectedChatStudent.name, role: 'Student', isMuted: false });
                        }
                    }
                } else if (context === 'parent') {
                    const controlsElement = document.getElementById('parentVoiceCallControls');
                    if (controlsElement) {
                        controlsElement.style.display = 'block';
                        updateCallStatus('parentVoiceCallControls', 'parentCallStatusText', 'parentCallParticipantCount');
                    }
                }
                
                // Simulate adding participants
                simulateConferenceCall(context, recipientType);
                
                const recipientLabel = recipientType.charAt(0).toUpperCase() + recipientType.slice(1);
                addNotification(` Voice call started with ${recipientLabel}! Others can join.`, 'success');
                
                // Broadcast call start to other users
                if (typeof broadcastCallEvent === 'function') {
                    broadcastCallEvent('call_started', context, recipientType);
                }
                
            } catch (err) {
                console.error('Error starting voice call:', err);
                let errorMessage = 'Unable to start call. ';
                
                if (err.name === 'NotAllowedError') {
                    errorMessage += 'Microphone access was denied. Please allow microphone access in your browser settings.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage += 'No microphone found. Please connect a microphone and try again.';
                } else if (err.name === 'NotReadableError') {
                    errorMessage += 'Microphone is already in use by another application.';
                } else {
                    errorMessage += 'Please check your microphone permissions and try again.';
                }
                
                addNotification(errorMessage, 'error');
            }
        }
        
        function updateCallStatus(controlsId, statusId, participantCountId) {
            const statusText = document.getElementById(statusId);
            const participantCount = document.getElementById(participantCountId);
            
            if (statusText) {
                statusText.textContent = 'Conference Call Active';
            }
            if (participantCount) {
                participantCount.textContent = callParticipants.length + ' participant' + (callParticipants.length !== 1 ? 's' : '');
            }
        }
        
        function simulateConferenceCall(context, recipientType) {
            // Simulate other participants joining based on recipient type
            let possibleParticipants = [];
            
            if (context === 'live') {
                switch(recipientType) {
                    case 'teachers':
                        possibleParticipants = [
                            { name: 'Mr. John Smith', role: 'Teacher', isMuted: false },
                            { name: 'Ms. Sarah Johnson', role: 'Teacher', isMuted: false }
                        ];
                        break;
                    case 'parents':
                        possibleParticipants = [
                            { name: 'David Brown', role: 'Parent', isMuted: false },
                            { name: 'Emily Davis', role: 'Parent', isMuted: false }
                        ];
                        break;
                    case 'students':
                        possibleParticipants = [
                            { name: 'Alex Wilson', role: 'Student', isMuted: false },
                            { name: 'Maya Thompson', role: 'Student', isMuted: false }
                        ];
                        break;
                    case 'hod':
                        possibleParticipants = [
                            { name: 'Dr. Michael Anderson', role: 'HOD', isMuted: false }
                        ];
                        break;
                    default:
                        possibleParticipants = [
                            { name: 'User A', role: 'User', isMuted: false }
                        ];
                }
            } else if (context === 'teacher') {
                possibleParticipants = [{ name: 'Parent', role: 'Parent', isMuted: false }];
            } else if (context === 'parent') {
                possibleParticipants = [{ name: 'Teacher', role: 'Teacher', isMuted: false }];
            }
            
            // Add participants gradually
            possibleParticipants.forEach((participant, index) => {
                setTimeout(() => {
                    if (activeVoiceCall) {
                        callParticipants.push(participant);
                        
                        if (context === 'live') {
                            updateCallStatus('voiceCallControls', 'callStatusText', 'callParticipantCount');
                            updateVoiceParticipantsList();
                        } else if (context === 'teacher') {
                            updateCallStatus('teacherVoiceCallControls', 'teacherCallStatusText', 'teacherCallParticipantCount');
                        } else if (context === 'parent') {
                            updateCallStatus('parentVoiceCallControls', 'parentCallStatusText', 'parentCallParticipantCount');
                        }
                        
                        addNotification(participant.name + ' joined the call', 'info');
                    }
                }, 3000 + (index * 2000));
            });
        }
        
        function toggleMuteCall() {
            toggleMute('muteCallBtn');
        }
        
        function toggleMuteTeacherCall() {
            toggleMute('teacherMuteCallBtn');
        }
        
        function toggleMuteParentCall() {
            toggleMute('parentMuteCallBtn');
        }
        
        function toggleMute(btnId) {
            isMuted = !isMuted;
            const btn = document.getElementById(btnId);
            
            if (activeVoiceCall && activeVoiceCall.stream) {
                activeVoiceCall.stream.getAudioTracks().forEach(track => {
                    track.enabled = !isMuted;
                });
            }
            
            if (isMuted) {
                btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-secondary');
                addNotification('Microphone muted', 'info');
            } else {
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-warning');
                addNotification('Microphone unmuted', 'info');
            }
        }
        
        function endVoiceCall() {
            endCall('live');
        }
        
        function endTeacherVoiceCall() {
            endCall('teacher');
        }
        
        function endParentVoiceCall() {
            endCall('parent');
        }
        
        function endCall(context) {
            if (activeVoiceCall && activeVoiceCall.stream) {
                activeVoiceCall.stream.getTracks().forEach(track => track.stop());
            }
            
            // Hide call controls
            if (context === 'live') {
                document.getElementById('voiceCallControls').style.display = 'none';
            } else if (context === 'teacher') {
                document.getElementById('teacherVoiceCallControls').style.display = 'none';
            } else if (context === 'parent') {
                document.getElementById('parentVoiceCallControls').style.display = 'none';
            }
            
            // Calculate call duration
            const duration = activeVoiceCall ? Math.floor((Date.now() - activeVoiceCall.startTime) / 1000) : 0;
            
            // Add call log to chat
            const callLogMessage = {
                id: Date.now(),
                sender: currentUser.name,
                role: currentUser.role,
                type: 'call_log',
                text: ` Conference call ended (${formatDuration(duration)}) - ${callParticipants.length} participants`,
                participants: [...callParticipants],
                duration: duration,
                timestamp: new Date().toISOString()
            };
            
            if (context === 'live') {
                liveChatMessages.push(callLogMessage);
                localStorage.setItem('liveChatMessages', JSON.stringify(liveChatMessages));
                renderLiveChatMessages();
            }
            
            // Reset call state
            activeVoiceCall = null;
            callParticipants = [];
            isMuted = false;
            
            addNotification('Call ended', 'info');
            broadcastCallEvent('call_ended', context);
        }
        
        function broadcastCallEvent(event, context) {
            // Store call event for other users to see
            const callEvents = JSON.parse(localStorage.getItem('callEvents') || '[]');
            const callEvent = {
                event: event,
                context: context,
                user: currentUser.name,
                callId: Date.now(),
                timestamp: new Date().toISOString()
            };
            callEvents.push(callEvent);
            localStorage.setItem('callEvents', JSON.stringify(callEvents.slice(-50)));
            
            // Use the new real-time broadcast system for voice calls
            if (typeof broadcastVoiceCallStart === 'function' && event === 'call_started') {
                broadcastVoiceCallStart({
                    callId: callEvent.callId,
                    caller: currentUser.name,
                    participants: callParticipants || [currentUser.name],
                    context: context
                });
            }
            
            // Use the new real-time broadcast system for video calls
            if (typeof broadcastVideoCallStart === 'function' && event === 'video_call_started') {
                broadcastVideoCallStart({
                    callId: callEvent.callId,
                    caller: currentUser.name,
                    participants: videoCallState.participants || [currentUser.name],
                    context: context
                });
            }
            
            if (typeof broadcastCallEnd === 'function' && (event === 'call_ended' || event === 'video_call_ended')) {
                broadcastCallEnd(callEvent.callId);
            }
        }
        
        // ===== VIDEO CALL FUNCTIONS =====
        // Video call state - consolidated into a single object for better maintainability
        const videoCallState = {
            activeCall: null,
            timer: null,
            seconds: 0,
            isMuted: false,
            isCameraOff: false,
            participants: []
        };
        
        // Start video call for each context
        function startVideoCall() {
            // Validate user is logged in
            if (!validateUserLogin('start a video call')) return;
            
            // Initialize the video call
            initVideoCall('live');
        }
        
        function startTeacherVideoCall() {
            if (!selectedChatStudent) {
                addNotification('Please select a student first', 'warning');
                return;
            }
            initVideoCall('teacher');
        }
        
        function startParentVideoCall() {
            initVideoCall('parent');
        }
        
        // Initialize video call with camera and microphone
        async function initVideoCall(context) {
            try {
                // Check browser compatibility
                if (!checkMediaDeviceSupport()) return;
                
                // Get selected recipient type
                const recipientType = document.querySelector('input[name="recipientType"]:checked')?.value || 'teachers';
                
                // Show requesting access notification
                addNotification('Requesting camera and microphone access...', 'info');
                
                // Request access to camera and microphone with enhanced settings
                // Try with enhanced settings first, fallback to basic if not supported
                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }, 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                } catch (enhancedErr) {
                    // Fallback to basic settings if enhanced not supported
                    console.log('Enhanced video/audio settings not supported, using basic settings');
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true,
                        audio: true
                    });
                }
                
                videoCallState.activeCall = {
                    context: context,
                    recipientType: recipientType,
                    startTime: Date.now(),
                    stream: stream,
                    participants: [{ name: currentUser.name, role: currentUser.role, isMuted: false }]
                };
                
                videoCallState.participants = [{ name: currentUser.name, role: currentUser.role, isMuted: false }];
                videoCallState.isMuted = false;
                videoCallState.isCameraOff = false;
                videoCallState.seconds = 0;
                videoCallState.recipientType = recipientType;
                
                // Get container and video elements based on context
                let containerId, videoId, timerElement;
                if (context === 'live') {
                    containerId = 'videoChatContainer';
                    videoId = 'localVideo';
                    timerElement = 'videoCallTimer';
                } else if (context === 'teacher') {
                    containerId = 'teacherVideoChatContainer';
                    videoId = 'teacherLocalVideo';
                    timerElement = 'teacherVideoCallTimer';
                } else if (context === 'parent') {
                    containerId = 'parentVideoChatContainer';
                    videoId = 'parentLocalVideo';
                    timerElement = 'parentVideoCallTimer';
                }
                
                // Show video container
                const container = document.getElementById(containerId);
                if (container) {
                    container.classList.add('active');
                    container.style.display = 'block';
                    
                    // Update recipient type badge for live chat
                    if (context === 'live') {
                        const recipientBadge = document.getElementById('videoCallRecipientType');
                        if (recipientBadge) {
                            recipientBadge.innerHTML = getRecipientBadgeText(recipientType);
                            recipientBadge.className = `badge recipient-badge ${recipientType} ms-2`;
                        }
                    }
                }
                
                // Attach stream to local video element
                const localVideo = document.getElementById(videoId);
                if (localVideo) {
                    localVideo.srcObject = stream;
                    // Ensure video plays
                    localVideo.play().catch(err => {
                        console.log('Video play error:', err);
                    });
                }
                
                // Update participants list
                updateVideoParticipantsList();
                
                // Start call timer
                videoCallState.timer = setInterval(() => {
                    videoCallState.seconds++;
                    const mins = Math.floor(videoCallState.seconds / 60);
                    const secs = videoCallState.seconds % 60;
                    const timer = document.getElementById(timerElement);
                    if (timer) {
                        timer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    }
                }, 1000);
                
                // Update participant count
                updateVideoCallStatus(context);
                
                // Simulate other participants joining
                simulateVideoCallParticipants(context, recipientType);
                
                const recipientLabel = recipientType.charAt(0).toUpperCase() + recipientType.slice(1);
                addNotification(` Video call started with ${recipientLabel}! Camera and microphone active.`, 'success');
                
                if (typeof broadcastCallEvent === 'function') {
                    broadcastCallEvent('video_call_started', context, recipientType);
                }
                
            } catch (err) {
                console.error('Error starting video call:', err);
                let errorMessage = 'Unable to start video call. ';
                
                if (err.name === 'NotAllowedError') {
                    errorMessage += 'Camera and microphone access was denied. Please allow permissions in your browser settings.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage += 'No camera or microphone found. Please connect a webcam and try again.';
                } else if (err.name === 'NotReadableError') {
                    errorMessage += 'Camera or microphone is already in use by another application.';
                } else if (err.name === 'OverconstrainedError') {
                    errorMessage += 'Camera does not meet the required specifications. Try with a different camera.';
                } else {
                    errorMessage += 'Please check your camera and microphone permissions and try again.';
                }
                
                addNotification(errorMessage, 'error');
            }
        }
        
        // Update video call status display
        function updateVideoCallStatus(context) {
            let statusId, countId;
            if (context === 'live') {
                statusId = 'videoCallStatusText';
                countId = 'videoParticipantCount';
            } else if (context === 'teacher') {
                statusId = 'teacherVideoCallStatusText';
                countId = 'teacherVideoParticipantCount';
            } else if (context === 'parent') {
                statusId = 'parentVideoCallStatusText';
                countId = 'parentVideoParticipantCount';
            }
            
            const statusText = document.getElementById(statusId);
            const countBadge = document.getElementById(countId);
            
            if (statusText) {
                statusText.textContent = 'Video Call Active';
            }
            if (countBadge) {
                countBadge.textContent = videoCallState.participants.length + ' participant' + (videoCallState.participants.length !== 1 ? 's' : '');
            }
        }
        
        // Simulate other participants joining the video call
        function simulateVideoCallParticipants(context, recipientType) {
            let possibleParticipants = [];
            
            if (context === 'live') {
                switch(recipientType) {
                    case 'teachers':
                        possibleParticipants = [
                            { name: 'Mr. John Smith', role: 'Teacher', isMuted: false },
                            { name: 'Ms. Sarah Johnson', role: 'Teacher', isMuted: false }
                        ];
                        break;
                    case 'parents':
                        possibleParticipants = [
                            { name: 'David Brown', role: 'Parent', isMuted: false },
                            { name: 'Emily Davis', role: 'Parent', isMuted: false }
                        ];
                        break;
                    case 'students':
                        possibleParticipants = [
                            { name: 'Alex Wilson', role: 'Student', isMuted: false },
                            { name: 'Maya Thompson', role: 'Student', isMuted: false }
                        ];
                        break;
                    case 'hod':
                        possibleParticipants = [
                            { name: 'Dr. Michael Anderson', role: 'HOD', isMuted: false }
                        ];
                        break;
                    default:
                        possibleParticipants = [
                            { name: 'User A', role: 'User', isMuted: false }
                        ];
                }
            } else if (context === 'teacher') {
                possibleParticipants = [{ name: 'Student/Parent', role: 'Student', isMuted: false }];
            } else if (context === 'parent') {
                possibleParticipants = [{ name: 'Teacher', role: 'Teacher', isMuted: false }];
            }
            
            // Add participants gradually
            possibleParticipants.forEach((participant, index) => {
                setTimeout(() => {
                    if (videoCallState.activeCall && videoCallState.activeCall.context === context) {
                        videoCallState.participants.push(participant);
                        
                        // Add simulated remote participant video placeholder
                        addRemoteParticipantVideo(context, participant.name);
                        
                        updateVideoCallStatus(context);
                        updateVideoParticipantsList();
                        addNotification(participant.name + ' joined the video call', 'info');
                    }
                }, 3000 + (index * 2000));
            });
        }
        
        // Add remote participant video placeholder
        function addRemoteParticipantVideo(context, participantName) {
            let gridId;
            if (context === 'live') {
                gridId = 'videoGrid';
            } else if (context === 'teacher') {
                gridId = 'teacherVideoGrid';
            } else if (context === 'parent') {
                gridId = 'parentVideoGrid';
            }
            
            const grid = document.getElementById(gridId);
            if (grid) {
                const participantDiv = document.createElement('div');
                participantDiv.className = 'video-participant';
                // Sanitize participant name for ID attribute - only allow alphanumeric and dash
                const sanitizedId = participantName.replace(/[^a-zA-Z0-9]/g, '-');
                participantDiv.id = `remote-${sanitizedId}`;
                
                // Create inner content safely without innerHTML
                const innerDiv = document.createElement('div');
                innerDiv.style.cssText = 'width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));';
                const icon = document.createElement('i');
                icon.className = 'fas fa-user';
                icon.style.cssText = 'font-size: 3rem; color: rgba(255,255,255,0.5);';
                innerDiv.appendChild(icon);
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'participant-name';
                nameSpan.textContent = participantName; // Safe: textContent escapes HTML
                
                participantDiv.appendChild(innerDiv);
                participantDiv.appendChild(nameSpan);
                grid.appendChild(participantDiv);
            }
        }
        
        // Toggle mute functions for each context
        function toggleVideoMute() {
            toggleVideoMuteInternal('live');
        }
        
        function toggleTeacherVideoMute() {
            toggleVideoMuteInternal('teacher');
        }
        
        function toggleParentVideoMute() {
            toggleVideoMuteInternal('parent');
        }
        
        function toggleVideoMuteInternal(context) {
            videoCallState.isMuted = !videoCallState.isMuted;
            
            let btnId, indicatorId;
            if (context === 'live') {
                btnId = 'videoMuteBtn';
                indicatorId = 'localMutedIndicator';
            } else if (context === 'teacher') {
                btnId = 'teacherVideoMuteBtn';
                indicatorId = 'teacherLocalMutedIndicator';
            } else if (context === 'parent') {
                btnId = 'parentVideoMuteBtn';
                indicatorId = 'parentLocalMutedIndicator';
            }
            
            const btn = document.getElementById(btnId);
            const indicator = document.getElementById(indicatorId);
            
            // Toggle audio track
            if (videoCallState.activeCall && videoCallState.activeCall.stream) {
                videoCallState.activeCall.stream.getAudioTracks().forEach(track => {
                    track.enabled = !videoCallState.isMuted;
                });
            }
            
            if (videoCallState.isMuted) {
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                    btn.classList.add('muted');
                }
                if (indicator) {
                    indicator.classList.add('show');
                }
                addNotification('Microphone muted', 'info');
            } else {
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-microphone"></i>';
                    btn.classList.remove('muted');
                }
                if (indicator) {
                    indicator.classList.remove('show');
                }
                addNotification('Microphone unmuted', 'info');
            }
        }
        
        // Toggle camera functions for each context
        function toggleVideoCamera() {
            toggleVideoCameraInternal('live');
        }
        
        function toggleTeacherVideoCamera() {
            toggleVideoCameraInternal('teacher');
        }
        
        function toggleParentVideoCamera() {
            toggleVideoCameraInternal('parent');
        }
        
        function toggleVideoCameraInternal(context) {
            videoCallState.isCameraOff = !videoCallState.isCameraOff;
            
            let btnId;
            if (context === 'live') {
                btnId = 'videoCameraBtn';
            } else if (context === 'teacher') {
                btnId = 'teacherVideoCameraBtn';
            } else if (context === 'parent') {
                btnId = 'parentVideoCameraBtn';
            }
            
            const btn = document.getElementById(btnId);
            
            // Toggle video track
            if (videoCallState.activeCall && videoCallState.activeCall.stream) {
                videoCallState.activeCall.stream.getVideoTracks().forEach(track => {
                    track.enabled = !videoCallState.isCameraOff;
                });
            }
            
            if (videoCallState.isCameraOff) {
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-video-slash"></i>';
                    btn.classList.add('off');
                }
                addNotification('Camera turned off', 'info');
            } else {
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-video"></i>';
                    btn.classList.remove('off');
                }
                addNotification('Camera turned on', 'info');
            }
        }
        
        // End video call functions for each context
        function endVideoCall() {
            endVideoCallInternal('live');
        }
        
        function endTeacherVideoCall() {
            endVideoCallInternal('teacher');
        }
        
        function endParentVideoCall() {
            endVideoCallInternal('parent');
        }
        
        function endVideoCallInternal(context) {
            // Stop all media tracks
            if (videoCallState.activeCall && videoCallState.activeCall.stream) {
                videoCallState.activeCall.stream.getTracks().forEach(track => track.stop());
            }
            
            // Clear timer
            if (videoCallState.timer) {
                clearInterval(videoCallState.timer);
                videoCallState.timer = null;
            }
            
            // Get container and reset
            let containerId, gridId;
            if (context === 'live') {
                containerId = 'videoChatContainer';
                gridId = 'videoGrid';
            } else if (context === 'teacher') {
                containerId = 'teacherVideoChatContainer';
                gridId = 'teacherVideoGrid';
            } else if (context === 'parent') {
                containerId = 'parentVideoChatContainer';
                gridId = 'parentVideoGrid';
            }
            
            // Hide container
            const container = document.getElementById(containerId);
            if (container) {
                container.classList.remove('active');
            }
            
            // Remove remote participant videos (keep local)
            const grid = document.getElementById(gridId);
            if (grid) {
                const remoteParticipants = grid.querySelectorAll('.video-participant:not(.local-video)');
                remoteParticipants.forEach(p => p.remove());
            }
            
            // Calculate call duration
            const duration = videoCallState.seconds;
            
            // Add call log to chat
            const callLogMessage = {
                id: Date.now(),
                sender: currentUser.name,
                role: currentUser.role,
                type: 'video_call_log',
                text: ` Video call ended (${formatDuration(duration)}) - ${videoCallState.participants.length} participants`,
                participants: [...videoCallState.participants],
                duration: duration,
                timestamp: new Date().toISOString()
            };
            
            if (context === 'live') {
                liveChatMessages.push(callLogMessage);
                localStorage.setItem('liveChatMessages', JSON.stringify(liveChatMessages));
                renderLiveChatMessages();
            } else if (context === 'teacher') {
                const chatMessage = {
                    id: Date.now(),
                    studentId: selectedChatStudent ? selectedChatStudent.id : null,
                    senderId: 'teacher',
                    senderName: currentUser.name,
                    type: 'video_call_log',
                    message: ` Video call ended (${formatDuration(duration)})`,
                    duration: duration,
                    timestamp: new Date().toISOString(),
                    read: true
                };
                teacherChats.push(chatMessage);
                localStorage.setItem('teacherChats', JSON.stringify(teacherChats));
                loadChatMessages();
            }
            
            // Reset state
            videoCallState.activeCall = null;
            videoCallState.seconds = 0;
            videoCallState.isMuted = false;
            videoCallState.isCameraOff = false;
            videoCallState.participants = [];
            
            addNotification('Video call ended', 'info');
            broadcastCallEvent('video_call_ended', context);
        }
        
        // ========================================
        // PARTICIPANT MANAGEMENT FUNCTIONS
        // ========================================
        
        // Toggle participants list panel
        function toggleParticipantsList() {
            const panel = document.getElementById('participantsListPanel');
            if (panel) {
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    updateVideoParticipantsList();
                } else {
                    panel.style.display = 'none';
                }
            }
        }
        
        // Toggle voice participants list
        function toggleVoiceParticipantsList() {
            const list = document.getElementById('voiceParticipantsList');
            if (list) {
                if (list.style.display === 'none') {
                    list.style.display = 'block';
                    updateVoiceParticipantsList();
                } else {
                    list.style.display = 'none';
                }
            }
        }
        
        // Update video participants list
        function updateVideoParticipantsList() {
            const list = document.getElementById('participantsList');
            const count = document.getElementById('participantsCount');
            
            if (!list || !videoCallState.participants) return;
            
            if (count) {
                count.textContent = videoCallState.participants.length;
            }
            
            list.innerHTML = videoCallState.participants.map((participant, index) => {
                const name = typeof participant === 'string' ? participant : participant.name;
                const role = typeof participant === 'object' ? participant.role : 'User';
                const isMuted = typeof participant === 'object' ? participant.isMuted : false;
                const isCurrentUser = name === currentUser.name;
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                return `
                    <div class="participant-item">
                        <div class="participant-info">
                            <div class="participant-avatar">${initials}</div>
                            <div class="participant-details">
                                <div class="participant-name">${name}${isCurrentUser ? ' (You)' : ''}</div>
                                <div class="participant-role">${role}</div>
                            </div>
                        </div>
                        <div class="participant-controls">
                            <div class="participant-status ${isMuted ? 'muted' : 'unmuted'}">
                                <i class="fas fa-${isMuted ? 'microphone-slash' : 'microphone'}"></i>
                                ${isMuted ? 'Muted' : 'Active'}
                            </div>
                            ${!isCurrentUser ? `
                                <button class="btn btn-sm ${isMuted ? 'btn-success' : 'btn-warning'}" 
                                        onclick="toggleParticipantMute(${index})" 
                                        title="${isMuted ? 'Unmute' : 'Mute'} participant">
                                    <i class="fas fa-${isMuted ? 'microphone' : 'microphone-slash'}"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update voice participants list
        function updateVoiceParticipantsList() {
            const list = document.getElementById('voiceParticipantsBody');
            
            if (!list || !callParticipants) return;
            
            list.innerHTML = callParticipants.map((participant, index) => {
                const name = typeof participant === 'string' ? participant : participant.name;
                const role = typeof participant === 'object' ? participant.role : 'User';
                const isMuted = typeof participant === 'object' ? participant.isMuted : false;
                const isCurrentUser = name === currentUser.name;
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                return `
                    <div class="participant-item">
                        <div class="participant-info">
                            <div class="participant-avatar">${initials}</div>
                            <div class="participant-details">
                                <div class="participant-name">${name}${isCurrentUser ? ' (You)' : ''}</div>
                                <div class="participant-role">${role}</div>
                            </div>
                        </div>
                        <div class="participant-controls">
                            <div class="participant-status ${isMuted ? 'muted' : 'unmuted'}">
                                <i class="fas fa-${isMuted ? 'microphone-slash' : 'microphone'}"></i>
                                ${isMuted ? 'Muted' : 'Active'}
                            </div>
                            ${!isCurrentUser ? `
                                <button class="btn btn-sm ${isMuted ? 'btn-success' : 'btn-warning'}" 
                                        onclick="toggleVoiceParticipantMute(${index})" 
                                        title="${isMuted ? 'Unmute' : 'Mute'} participant">
                                    <i class="fas fa-${isMuted ? 'microphone' : 'microphone-slash'}"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle mute for a specific video call participant
        function toggleParticipantMute(index) {
            if (!videoCallState.participants || !videoCallState.participants[index]) return;
            
            const participant = videoCallState.participants[index];
            if (typeof participant === 'object') {
                participant.isMuted = !participant.isMuted;
                const name = participant.name;
                const status = participant.isMuted ? 'muted' : 'unmuted';
                addNotification(`${name} has been ${status}`, 'info');
                updateVideoParticipantsList();
            }
        }
        
        // Toggle mute for a specific voice call participant
        function toggleVoiceParticipantMute(index) {
            if (!callParticipants || !callParticipants[index]) return;
            
            const participant = callParticipants[index];
            if (typeof participant === 'object') {
                participant.isMuted = !participant.isMuted;
                const name = participant.name;
                const status = participant.isMuted ? 'muted' : 'unmuted';
                addNotification(`${name} has been ${status}`, 'info');
                updateVoiceParticipantsList();
            } else {
                // If it's a string (legacy format), convert to object with toggled mute state
                const name = participant;
                // Default to muting on first toggle for legacy participants
                callParticipants[index] = { name: name, role: 'User', isMuted: true };
                addNotification(`${name} has been muted`, 'info');
                updateVoiceParticipantsList();
            }
        }
        
        // Helper function to get recipient badge text
        function getRecipientBadgeText(recipientType) {
            const badges = {
                'teachers': '<i class="fas fa-chalkboard-teacher"></i> Teachers',
                'parents': '<i class="fas fa-user-friends"></i> Parents',
                'students': '<i class="fas fa-user-graduate"></i> Students',
                'hod': '<i class="fas fa-user-tie"></i> HOD'
            };
            return badges[recipientType] || '';
        }
        
        // Enable teacher buttons when student is selected
        function enableTeacherChatButtons() {
            const voiceNoteBtn = document.getElementById('teacherVoiceNoteBtn');
            const voiceCallBtn = document.getElementById('teacherVoiceCallBtn');
            const videoCallBtn = document.getElementById('teacherVideoCallBtn');
            if (voiceNoteBtn) voiceNoteBtn.disabled = false;
            if (voiceCallBtn) voiceCallBtn.disabled = false;
            if (videoCallBtn) videoCallBtn.disabled = false;
        }

        // Content Management
        function renderContents() {
            const search = document.getElementById('contentSearch').value.toLowerCase();
            const filtered = contents.filter(c => c.title.toLowerCase().includes(search));
            document.getElementById('contentTable').innerHTML = filtered.map(c => `
                <tr>
                    <td>${c.id}</td>
                    <td>${c.title}</td>
                    <td>${c.type}</td>
                    <td><span class="badge bg-${c.status === 'Published' ? 'success' : 'warning'}">${c.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="editContent(${c.id})">Edit</button></td>
                </tr>
            `).join('');
        }
        function showAddContentModal() {
            new bootstrap.Modal(document.getElementById('addContentModal')).show();
        }
        function saveContent() {
            const title = document.getElementById('contentTitle').value;
            const type = document.getElementById('contentType').value;
            const body = document.getElementById('contentBody').value;
            const status = document.getElementById('contentStatus').value;
            const file = document.getElementById('contentFile').files[0];
            if (title && body) {
                const id = Date.now();
                contents.push({ id, title, type, body, status, file: file ? file.name : '' });
                saveData();
                renderContents();
                bootstrap.Modal.getInstance(document.getElementById('addContentModal')).hide();
                addNotification('Content added', 'success');
            }
        }
        function editContent(id) {
            // Similar edit logic
            alert('Edit content ' + id + ' (implement)');
        }
        function searchContent() {
            renderContents();
        }

        // Reports
        function generateReport() {
            const type = document.getElementById('reportType').value;
            let report = '';
            switch (type) {
                case 'attendance':
                    report = 'Attendance Report: ' + Object.keys(attendanceRecords).length + ' days';
                    break;
                case 'fees':
                    report = 'Fee Report: R' + fees.reduce((sum, f) => sum + f.amount, 0).toLocaleString();
                    break;
                case 'exams':
                    report = 'Exam Report: ' + exams.length + ' exams';
                    break;
                case 'hr':
                    report = 'HR Report: ' + staff.length + ' staff';
                    break;
                case 'incidents':
                    report = `Incident Reports: ${incidentReports.length} total reports<br>
                             High Severity: ${incidentReports.filter(i => i.severity === 'high').length}<br>
                             Medium Severity: ${incidentReports.filter(i => i.severity === 'medium').length}<br>
                             Low Severity: ${incidentReports.filter(i => i.severity === 'low').length}`;
                    break;
                case 'events':
                    const today = new Date().toISOString().split('T')[0];
                    report = `School Events: ${schoolEvents.length} total events<br>
                             Upcoming: ${schoolEvents.filter(e => e.date >= today).length}<br>
                             Past: ${schoolEvents.filter(e => e.date < today).length}<br>
                             Notifications Sent: ${schoolEvents.filter(e => e.notificationsSent > 0).length}`;
                    break;
            }
            document.getElementById('reportOutput').innerHTML = `<div class="report-card">${report}</div>`;
            document.getElementById('reportOutput').classList.remove('d-none');
        }
        
        function viewAllIncidents() {
            const reportOutput = document.getElementById('reportOutput');
            reportOutput.classList.remove('d-none');
            
            let html = '<h4>All Incident Reports</h4>';
            html += '<table class="table table-striped"><thead><tr>';
            html += '<th>Date</th><th>Student</th><th>Type</th><th>Severity</th><th>Description</th><th>Action</th><th>Reporter</th>';
            html += '</tr></thead><tbody>';
            
            incidentReports.forEach(incident => {
                const severityBadge = incident.severity === 'high' ? 'bg-danger' : 
                                    incident.severity === 'medium' ? 'bg-warning' : 'bg-info';
                html += `<tr>
                    <td>${incident.date}</td>
                    <td>${incident.studentName}</td>
                    <td><span class="badge bg-secondary">${incident.type}</span></td>
                    <td><span class="badge ${severityBadge}">${incident.severity}</span></td>
                    <td>${incident.description}</td>
                    <td>${incident.action || '-'}</td>
                    <td>${incident.reportedBy}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            if (incidentReports.length === 0) {
                html = '<p class="text-center text-muted">No incident reports found.</p>';
            }
            
            reportOutput.innerHTML = html;
        }
        
        function exportReport() {
            addNotification('Report exported (mock)', 'success');
        }

        // Settings
        function loadSettings() {
            document.getElementById('smsUsername').value = smsSettings.username;
            document.getElementById('smsPassword').value = smsSettings.password;
            document.getElementById('annualLeaveDays').value = hrSettings.annualLeaveDays;
            document.getElementById('uifRate').value = hrSettings.uifRate * 100;
            if (document.getElementById('chatGPTApiKey')) {
                document.getElementById('chatGPTApiKey').value = chatGPTSettings.apiKey;
                document.getElementById('chatGPTModel').value = chatGPTSettings.model;
            }
            if (document.getElementById('grokApiKey')) {
                document.getElementById('grokApiKey').value = grokSettings.apiKey;
                document.getElementById('grokModel').value = grokSettings.model;
            }
            // Load users list for User Management tab
            renderUsersList();
        }
        function saveSMSSettings() {
            smsSettings.username = document.getElementById('smsUsername').value;
            smsSettings.password = document.getElementById('smsPassword').value;
            saveData();
            addNotification('SMS settings saved', 'success');
        }
        function updateHRSettings() {
            hrSettings.annualLeaveDays = parseInt(document.getElementById('annualLeaveDays').value);
            hrSettings.uifRate = parseFloat(document.getElementById('uifRate').value) / 100;
            saveData();
            addNotification('HR settings updated', 'success');
        }
        
        function saveChatGPTSettings() {
            chatGPTSettings.apiKey = document.getElementById('chatGPTApiKey').value;
            chatGPTSettings.model = document.getElementById('chatGPTModel').value;
            chatGPTSettings.enabled = chatGPTSettings.apiKey.length > 0;
            saveData();
            addNotification('ChatGPT API settings saved', 'success');
        }
        
        function saveGrokSettings() {
            grokSettings.apiKey = document.getElementById('grokApiKey').value;
            grokSettings.model = document.getElementById('grokModel').value;
            grokSettings.enabled = grokSettings.apiKey.length > 0;
            saveData();
            addNotification('Grok API settings saved', 'success');
        }
        
        // ========================================
        }
        
        // Create new user
        function createNewUser() {
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUserUsername').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const email = document.getElementById('newUserEmail').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const notes = document.getElementById('newUserNotes').value.trim();
            
            // Validation
            if (!name) {
                addNotification('Please enter a name', 'warning');
                return;
            }
            if (!username) {
                addNotification('Please enter a username', 'warning');
                return;
            }
            if (!password) {
                addNotification('Please enter a password', 'warning');
                return;
            }
            if (!role) {
                addNotification('Please select a role', 'warning');
                return;
            }
            
            // Check for duplicate username
            const existingUser = users.find(u => u.username.toLowerCase() === username.toLowerCase());
            if (existingUser) {
                addNotification('Username already exists. Please choose a different username.', 'danger');
                return;
            }
            
            // Create user object
            const newUser = {
                id: Date.now(),
                name: name,
                username: username,
                password: password,
                role: role,
                email: email,
                phone: phone,
                notes: notes,
                status: 'Active',
                createdAt: new Date().toISOString(),
                createdBy: currentUser ? currentUser.name : 'System'
            };
            
            // Add role-specific data
            if (role === 'HOD') {
                newUser.department = document.getElementById('newUserDepartment').value;
                newUser.employeeId = document.getElementById('newUserEmployeeId').value;
            } else if (role === 'Teacher') {
                newUser.subject = document.getElementById('newUserSubject').value;
                newUser.assignedGrades = document.getElementById('newUserGrades').value;
            } else if (role === 'Student') {
                newUser.grade = document.getElementById('newUserStudentGrade').value;
                newUser.class = document.getElementById('newUserClass').value;
            } else if (role === 'Parent') {
                newUser.childName = document.getElementById('newUserChildName').value;
                newUser.relationship = document.getElementById('newUserRelationship').value;
            }
            
            // Add to users array
            users.push(newUser);
            saveData();
            
            // Broadcast USER_UPDATE for real-time sync across all devices/tabs
            // This ensures the new user can log in immediately on all connected devices
            if (typeof broadcastDataUpdate === 'function') {
                broadcastDataUpdate('USER_UPDATE', { 
                    action: 'create', 
                    userName: username, 
                    userRole: role,
                    userId: newUser.id
                });
            }
            
            // Log activity
            logUserActivity(currentUser?.username || 'System', currentUser?.role || 'Admin', 'User Created', `Created ${role} account for ${name} (${username})`);
            
            // Close modal and refresh list
            hideModal('createUserModal');
            renderUsersList();
            
            addNotification(`${role} account created successfully for ${name}! User can now log in.`, 'success');
        }
        
        // View user details
        function viewUser(index) {
            const user = users[index];
            if (!user) return;
            
            currentViewedUser = user;
            
            const content = document.getElementById('viewUserContent');
            content.innerHTML = `
                <div class="text-center mb-4">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user fa-2x" style="color: #fff;"></i>
                    </div>
                    <h4 class="mt-3">${escapeHtml(user.name || 'N/A')}</h4>
                    <span class="badge ${getRoleBadgeClass(user.role)}">${escapeHtml(user.role)}</span>
                    <span class="badge ${getStatusBadgeClass(user.status || 'Active')} ms-2">${escapeHtml(user.status || 'Active')}</span>
                </div>
                
                <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 12px;">
                    <h6 class="mb-3"><i class="fas fa-key me-2"></i>Login Credentials</h6>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Username:</small>
                            <p class="mb-0"><code id="viewUsername">${escapeHtml(user.username)}</code></p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Password:</small>
                            <p class="mb-0"><code id="viewPassword">${escapeHtml(user.password)}</code></p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 p-3" style="background: rgba(255,255,255,0.05); border-radius: 12px;">
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Additional Information</h6>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <small class="text-muted">Email:</small>
                            <p class="mb-0">${escapeHtml(user.email || 'Not provided')}</p>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Phone:</small>
                            <p class="mb-0">${escapeHtml(user.phone || 'Not provided')}</p>
                        </div>
                        ${user.department ? `<div class="col-6 mb-2"><small class="text-muted">Department:</small><p class="mb-0">${escapeHtml(user.department)}</p></div>` : ''}
                        ${user.grade ? `<div class="col-6 mb-2"><small class="text-muted">Grade:</small><p class="mb-0">${escapeHtml(user.grade)}</p></div>` : ''}
                        ${user.childName ? `<div class="col-6 mb-2"><small class="text-muted">Child:</small><p class="mb-0">${escapeHtml(user.childName)}</p></div>` : ''}
                        <div class="col-6 mb-2">
                            <small class="text-muted">Created:</small>
                            <p class="mb-0">${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    </div>
                </div>
                
                ${user.notes ? `
                <div class="mt-3 p-3" style="background: rgba(255,255,255,0.05); border-radius: 12px;">
                    <h6 class="mb-2"><i class="fas fa-sticky-note me-2"></i>Notes</h6>
                    <p class="mb-0">${escapeHtml(user.notes)}</p>
                </div>
                ` : ''}
            `;
            
            showModal('viewUserModal');
        }
        
        // Copy user credentials
        function copyUserCredentials() {
            if (!currentViewedUser) return;
            
            const credentials = `Username: ${currentViewedUser.username}\nPassword: ${currentViewedUser.password}`;
            
            navigator.clipboard.writeText(credentials).then(() => {
                addNotification('Credentials copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = credentials;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                addNotification('Credentials copied to clipboard!', 'success');
            });
        }
        
        // Edit user
        function editUser(index) {
            const user = users[index];
            if (!user) return;
            
            document.getElementById('editUserIndex').value = index;
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserUsername').value = user.username || '';
            document.getElementById('editUserPassword').value = user.password || '';
            document.getElementById('editUserRole').value = user.role || 'Student';
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserStatus').value = user.status || 'Active';
            
            showModal('editUserModal');
        }
        
        // Update user
        function updateUser() {
            const index = parseInt(document.getElementById('editUserIndex').value);
            
            if (isNaN(index) || !users[index]) {
                addNotification('User not found', 'danger');
                return;
            }
            
            const name = document.getElementById('editUserName').value.trim();
            const username = document.getElementById('editUserUsername').value.trim();
            const password = document.getElementById('editUserPassword').value;
            const role = document.getElementById('editUserRole').value;
            const email = document.getElementById('editUserEmail').value.trim();
            const status = document.getElementById('editUserStatus').value;
            
            // Validation
            if (!name || !username || !password || !role) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            // Check for duplicate username (excluding current user)
            const duplicateUser = users.find((u, i) => i !== index && u.username.toLowerCase() === username.toLowerCase());
            if (duplicateUser) {
                addNotification('Username already exists. Please choose a different username.', 'danger');
                return;
            }
            
            // Update user
            users[index].name = name;
            users[index].username = username;
            users[index].password = password;
            users[index].role = role;
            users[index].email = email;
            users[index].status = status;
            users[index].updatedAt = new Date().toISOString();
            users[index].updatedBy = currentUser ? currentUser.name : 'System';
            
            saveData();
            
            // Broadcast USER_UPDATE for real-time sync across all devices/tabs
            if (typeof broadcastDataUpdate === 'function') {
                broadcastDataUpdate('USER_UPDATE', { 
                    action: 'update', 
                    userName: username, 
                    userRole: role,
                    userId: users[index].id,
                    field: 'all'
                });
            }
            
            // Log activity
            logUserActivity(currentUser?.username || 'System', currentUser?.role || 'Admin', 'User Updated', `Updated account for ${name} (${username})`);
            
            hideModal('editUserModal');
            renderUsersList();
            
            addNotification(`User ${name} updated successfully! Changes synced across all devices.`, 'success');
        }
        
        // Track pending inline edits
        let pendingUserEdits = {};
        
        // Helper function to generate editable cell display HTML
        function getEditableCellDisplayHtml(field, value) {
            const escapedValue = escapeHtml(value);
            const pencilIcon = '<i class="fas fa-pencil-alt ms-1" style="font-size:0.7rem;opacity:0.5;"></i>';
            if (field === 'name') {
                return `<strong>${escapedValue}</strong> ${pencilIcon}`;
            } else if (field === 'username') {
                return `<code>${escapedValue}</code> ${pencilIcon}`;
            }
            return `${escapedValue} ${pencilIcon}`;
        }
        
        // Start inline editing for a field
        function startInlineEdit(userIndex, field) {
            const displaySpan = document.getElementById(`${field}-display-${userIndex}`);
            const inputField = document.getElementById(`${field}-input-${userIndex}`);
            
            if (!displaySpan || !inputField) {
                console.warn(`Inline edit elements not found for user ${userIndex}, field ${field}`);
                return;
            }
            
            // Hide display, show input
            displaySpan.classList.add('d-none');
            inputField.classList.remove('d-none');
            inputField.focus();
            inputField.select();
        }
        
        // Handle keydown events for inline edit inputs
        function handleInlineEditKeydown(event, userIndex, field) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveInlineEdit(userIndex, field);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelInlineEdit(userIndex, field);
            }
        }
        
        // Save inline edit for a field
        function saveInlineEdit(userIndex, field) {
            const inputField = document.getElementById(`${field}-input-${userIndex}`);
            const displaySpan = document.getElementById(`${field}-display-${userIndex}`);
            
            if (!inputField || !displaySpan) {
                console.warn(`Inline edit elements not found for user ${userIndex}, field ${field}`);
                return;
            }
            
            if (!users[userIndex]) {
                addNotification('User not found. Please refresh the page.', 'danger');
                return;
            }
            
            const newValue = inputField.value.trim();
            const oldValue = users[userIndex][field] || '';
            
            // Validation
            if (!newValue) {
                addNotification(`${field.charAt(0).toUpperCase() + field.slice(1)} cannot be empty`, 'warning');
                inputField.value = oldValue;
                displaySpan.classList.remove('d-none');
                inputField.classList.add('d-none');
                return;
            }
            
            // Check for duplicate username
            if (field === 'username') {
                const duplicateUser = users.find((u, i) => i !== userIndex && u.username.toLowerCase() === newValue.toLowerCase());
                if (duplicateUser) {
                    addNotification('Username already exists. Please choose a different username.', 'danger');
                    inputField.value = oldValue;
                    displaySpan.classList.remove('d-none');
                    inputField.classList.add('d-none');
                    return;
                }
            }
            
            // Update the display immediately for live feedback using helper function
            displaySpan.innerHTML = getEditableCellDisplayHtml(field, newValue);
            
            // Hide input, show display
            displaySpan.classList.remove('d-none');
            inputField.classList.add('d-none');
            
            // Only track if value changed
            if (newValue !== oldValue) {
                // Track the pending edit for the Save Changes button summary
                if (!pendingUserEdits[userIndex]) {
                    pendingUserEdits[userIndex] = { originalValues: {} };
                }
                if (!pendingUserEdits[userIndex].originalValues[field]) {
                    pendingUserEdits[userIndex].originalValues[field] = oldValue;
                }
                pendingUserEdits[userIndex][field] = newValue;
                
                // Update the user data immediately for fast live update
                users[userIndex][field] = newValue;
                users[userIndex].updatedAt = new Date().toISOString();
                users[userIndex].updatedBy = currentUser ? currentUser.name : 'System';
                
                // Save to localStorage immediately for persistence
                saveData();
                
                // Broadcast USER_UPDATE for real-time sync across all devices/tabs
                if (typeof broadcastDataUpdate === 'function') {
                    broadcastDataUpdate('USER_UPDATE', { 
                        action: 'update', 
                        userName: users[userIndex].username, 
                        userRole: users[userIndex].role,
                        userId: users[userIndex].id,
                        field: field
                    });
                }
                
                // Show the save changes button
                showSaveChangesButton();
                
                // Show success feedback
                addNotification(`${field.charAt(0).toUpperCase() + field.slice(1)} updated: "${newValue}"`, 'success');
                
                // Log activity
                logUserActivity(currentUser?.username || 'System', currentUser?.role || 'Admin', 'User Updated', `Updated ${field} for ${users[userIndex].name || 'Unknown User'} (${users[userIndex].username || 'Unknown'})`);
                
                // Update statistics
                updateUserStatistics();
            }
        }
        
        // Cancel inline edit
        function cancelInlineEdit(userIndex, field) {
            const inputField = document.getElementById(`${field}-input-${userIndex}`);
            const displaySpan = document.getElementById(`${field}-display-${userIndex}`);
            
            if (!inputField || !displaySpan) {
                console.warn(`Inline edit elements not found for user ${userIndex}, field ${field}`);
                return;
            }
            
            if (!users[userIndex]) return;
            
            // Reset input to original value
            inputField.value = users[userIndex][field] || '';
            
            // Hide input, show display
            displaySpan.classList.remove('d-none');
            inputField.classList.add('d-none');
        }
        
        // Show the save changes button
        function showSaveChangesButton() {
            const saveBtn = document.getElementById('saveAllChangesBtn');
            if (saveBtn) {
                saveBtn.style.display = 'inline-block';
                saveBtn.classList.add('pulse-animation');
            }
        }
        
        // Hide the save changes button
        function hideSaveChangesButton() {
            const saveBtn = document.getElementById('saveAllChangesBtn');
            if (saveBtn) {
                saveBtn.style.display = 'none';
                saveBtn.classList.remove('pulse-animation');
            }
        }
        
        // Save all pending user changes - confirms and clears the pending edits summary
        function saveAllUserChanges() {
            const editCount = Object.keys(pendingUserEdits).length;
            
            if (editCount === 0) {
                addNotification('No pending changes to save', 'info');
                return;
            }
            
            // Build a summary of changes made
            let changesSummary = [];
            for (const userIndex in pendingUserEdits) {
                const userEdits = pendingUserEdits[userIndex];
                const userName = users[userIndex]?.name || 'Unknown';
                const fields = Object.keys(userEdits).filter(k => k !== 'originalValues');
                if (fields.length > 0) {
                    changesSummary.push(`${userName}: ${fields.join(', ')}`);
                }
            }
            
            // Data is already persisted via saveInlineEdit - this confirms completion
            saveData();
            
            // Log activity with details
            logUserActivity(currentUser?.username || 'System', currentUser?.role || 'Admin', 'Changes Confirmed', `Confirmed ${editCount} user edit(s): ${changesSummary.join('; ')}`);
            
            // Clear pending edits
            pendingUserEdits = {};
            
            // Hide save button
            hideSaveChangesButton();
            
            // Refresh the list
            renderUsersList();
            
            addNotification(`All changes confirmed and saved! (${editCount} user(s) updated)`, 'success');
        }
        
        // Delete user
        function deleteUser(index) {
            const user = users[index];
            if (!user) return;
            
            if (!confirm(`Are you sure you want to delete the user "${user.name}"?\n\nUsername: ${user.username}\nRole: ${user.role}\n\nThis action cannot be undone.`)) {
                return;
            }
            
            // Store user info before deletion for broadcast
            const deletedUserName = user.username;
            const deletedUserRole = user.role;
            const deletedUserId = user.id;
            
            // Log activity before deletion
            logUserActivity(currentUser?.username || 'System', currentUser?.role || 'Admin', 'User Deleted', `Deleted ${user.role} account for ${user.name} (${user.username})`);
            
            // Remove user
            users.splice(index, 1);
            saveData();
            
            // Broadcast USER_UPDATE for real-time sync across all devices/tabs
            if (typeof broadcastDataUpdate === 'function') {
                broadcastDataUpdate('USER_UPDATE', { 
                    action: 'delete', 
                    userName: deletedUserName, 
                    userRole: deletedUserRole,
                    userId: deletedUserId
                });
            }
            
            renderUsersList();
            
            addNotification(`User ${user.name} deleted successfully!`, 'success');
        }
        
        // Export users list
        function exportUsersList() {
            if (users.length === 0) {
                addNotification('No users to export', 'warning');
                return;
            }
            
            // Create CSV content
            const headers = ['Name', 'Username', 'Role', 'Email', 'Phone', 'Status', 'Created At'];
            const csvContent = [
                headers.join(','),
                ...users.map(user => [
                    `"${(user.name || '').replace(/"/g, '""')}"`,
                    `"${(user.username || '').replace(/"/g, '""')}"`,
                    `"${(user.role || '').replace(/"/g, '""')}"`,
                    `"${(user.email || '').replace(/"/g, '""')}"`,
                    `"${(user.phone || '').replace(/"/g, '""')}"`,
                    `"${(user.status || 'Active').replace(/"/g, '""')}"`,
                    `"${user.createdAt || ''}"`
                ].join(','))
            ].join('\n');
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            addNotification(`Exported ${users.length} users to CSV file (passwords excluded for security)!`, 'success');
            
            // Log activity
            logUserActivity(currentUser?.username || 'System', currentUser?.role || 'Admin', 'Users Export', `Exported ${users.length} users to CSV (passwords excluded)`);
        }
        
        // Settings tabs handler - load user list when switching to User Management tab
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handler for Settings tabs
            const settingsTabs = document.querySelectorAll('#settingsTabs .nav-link');
            settingsTabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active from all tabs
                    settingsTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Hide all tab panes
                    document.querySelectorAll('#settingsTabContent .tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    
                    // Show selected pane
                    const target = this.getAttribute('data-bs-target');
                    const targetPane = document.querySelector(target);
                    if (targetPane) {
                        targetPane.classList.add('show', 'active');
                    }
                    
                    // Load user list if User Management tab is selected
                    if (target === '#user-management') {
                        renderUsersList();
                    }
                });
            });
        });
        
        
        function configureChatGPTAPI() {
            const apiKey = document.getElementById('chatGPTApiKey').value;
            const model = document.getElementById('chatGPTModel').value;
            
            if (!apiKey) {
                addNotification('Please enter a ChatGPT API key', 'warning');
                return;
            }
            
            // Test the API configuration
            addNotification('Testing ChatGPT API configuration...', 'info');
            
            // Mock API test - in real implementation, this would make a test API call
            setTimeout(() => {
                chatGPTSettings.apiKey = apiKey;
                chatGPTSettings.model = model;
                chatGPTSettings.enabled = true;
                saveData();
                addNotification('ChatGPT API configured successfully!', 'success');
                logAudit('API Configuration', 'Configured ChatGPT API', 'Low');
            }, 1000);
        }
        
        function configureGrokAPI() {
            const apiKey = document.getElementById('grokApiKey').value;
            const model = document.getElementById('grokModel').value;
            
            if (!apiKey) {
                addNotification('Please enter a Grok API key', 'warning');
                return;
            }
            
            // Test the API configuration
            addNotification('Testing Grok API configuration...', 'info');
            
            // Mock API test - in real implementation, this would make a test API call
            setTimeout(() => {
                grokSettings.apiKey = apiKey;
                grokSettings.model = model;
                grokSettings.enabled = true;
                saveData();
                addNotification('Grok API configured successfully!', 'success');
                logAudit('API Configuration', 'Configured Grok API', 'Low');
            }, 1000);
        }
        
        function backupData() {
            const data = { ...window }; // Mock full backup
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'asms-backup.json';
            a.click();
            addNotification('Data backed up', 'success');
        }
        function restoreData() {
            if (confirm('Restore will overwrite data?')) {
                // Implement file upload and restore
                addNotification('Data restored (mock)', 'success');
            }
        }
        
        // Theme Generator Functions
        const themes = {
            default: {
                name: 'Default Purple',
                primaryGradientStart: '#667eea',
                primaryGradientEnd: '#764ba2',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            ocean: {
                name: 'Ocean Blue',
                primaryGradientStart: '#1e3c72',
                primaryGradientEnd: '#2a5298',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            forest: {
                name: 'Forest Green',
                primaryGradientStart: '#134e5e',
                primaryGradientEnd: '#71b280',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            sunset: {
                name: 'Sunset Orange',
                primaryGradientStart: '#f46b45',
                primaryGradientEnd: '#eea849',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            midnight: {
                name: 'Midnight Dark',
                primaryGradientStart: '#232526',
                primaryGradientEnd: '#414345',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            rose: {
                name: 'Rose Pink',
                primaryGradientStart: '#ee9ca7',
                primaryGradientEnd: '#ffdde1',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            emerald: {
                name: 'Emerald',
                primaryGradientStart: '#11998e',
                primaryGradientEnd: '#38ef7d',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            crimson: {
                name: 'Crimson Red',
                primaryGradientStart: '#eb3349',
                primaryGradientEnd: '#f45c43',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            royal: {
                name: 'Royal Gold',
                primaryGradientStart: '#141e30',
                primaryGradientEnd: '#243b55',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            cosmic: {
                name: 'Cosmic Purple',
                primaryGradientStart: '#3a1c71',
                primaryGradientEnd: '#d76d77',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            aqua: {
                name: 'Aqua Marine',
                primaryGradientStart: '#2E3192',
                primaryGradientEnd: '#1BFFFF',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            autumn: {
                name: 'Autumn Leaves',
                primaryGradientStart: '#DAD299',
                primaryGradientEnd: '#B0DAB9',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            }
        };
        
        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            
            // Apply CSS variables
            const root = document.documentElement;
            root.style.setProperty('--primary-gradient-start', theme.primaryGradientStart);
            root.style.setProperty('--primary-gradient-end', theme.primaryGradientEnd);
            root.style.setProperty('--text-color', theme.textColor);
            root.style.setProperty('--card-bg', theme.cardBg);
            root.style.setProperty('--card-bg-hover', theme.cardBgHover);
            root.style.setProperty('--sidebar-bg', theme.sidebarBg);
            root.style.setProperty('--sidebar-border', theme.sidebarBorder);
            root.style.setProperty('--table-bg', theme.tableBg);
            root.style.setProperty('--table-th-bg', theme.tableThBg);
            root.style.setProperty('--btn-toggle-bg', theme.btnToggleBg);
            
            // Save to localStorage
            localStorage.setItem('selectedTheme', themeName);
            
            // Update UI to show active theme
            updateThemeSelector(themeName);
            
            // Show notification
            addNotification(`Theme changed to ${theme.name}`, 'success');
        }
        
        function updateThemeSelector(themeName) {
            // Remove active class from all theme options
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Add active class to selected theme
            const selectedTheme = document.querySelector(`[data-theme="${themeName}"]`);
            if (selectedTheme) {
                selectedTheme.classList.add('active');
            }
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            applyTheme(savedTheme);
        }
        
        // Vault Functions
        function updateVaultMetrics() {
            document.getElementById('vaultTotalItems').textContent = dataVault.length;
            document.getElementById('vaultAttendanceResets').textContent = dataVault.filter(v => v.type === 'Attendance Reset').length;
            document.getElementById('vaultStudentResets').textContent = dataVault.filter(v => v.type === 'Student Reset').length;
            document.getElementById('vaultFeeResets').textContent = dataVault.filter(v => v.type === 'Fee Reset').length;
        }
        
        function showVaultViewer() {
            const vaultContent = document.getElementById('vaultContent');
            if (vaultContent.classList.contains('d-none')) {
                vaultContent.classList.remove('d-none');
                renderVaultTable();
            } else {
                vaultContent.classList.add('d-none');
            }
        }
        
        function renderVaultTable() {
            const tbody = document.getElementById('vaultTable');
            tbody.innerHTML = dataVault.slice().reverse().map(item => `
                <tr>
                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                    <td><span class="badge bg-info">${item.type}</span></td>
                    <td>${item.description}<br><small class="text-muted">By: ${item.user}</small></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewVaultItem(${item.id})">View</button>
                        <button class="btn btn-sm btn-success" onclick="restoreVaultItem(${item.id})">Restore</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteVaultItem(${item.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function viewVaultItem(id) {
            const item = dataVault.find(v => v.id === id);
            if (item) {
                const dataPreview = JSON.stringify(item.data, null, 2).substring(0, 500) + '...';
                alert(`Vault Item Details:\n\nType: ${item.type}\nTimestamp: ${new Date(item.timestamp).toLocaleString()}\nDescription: ${item.description}\nUser: ${item.user}\n\nData Preview:\n${dataPreview}`);
            }
        }
        
        function restoreVaultItem(id) {
            const item = dataVault.find(v => v.id === id);
            if (!item) return;
            
            if (confirm(`Restore ${item.type}? This will overwrite current data.`)) {
                switch(item.type) {
                    case 'Attendance Reset':
                        attendanceRecords = JSON.parse(JSON.stringify(item.data));
                        loadAttendance();
                        addNotification('Attendance data restored from vault', 'success');
                        break;
                    case 'Student Reset':
                        students = JSON.parse(JSON.stringify(item.data));
                        renderStudents();
                        addNotification('Student data restored from vault', 'success');
                        break;
                    case 'Admission Reset':
                        admissions = JSON.parse(JSON.stringify(item.data));
                        renderAdmissions();
                        addNotification('Admission data restored from vault', 'success');
                        break;
                    case 'Fee Reset':
                        fees = JSON.parse(JSON.stringify(item.data));
                        renderFees();
                        addNotification('Fee data restored from vault', 'success');
                        break;
                }
                saveData();
                logAudit('Vault Restore', `Restored ${item.type} from vault`, 'Medium');
            }
        }
        
        function deleteVaultItem(id) {
            if (confirm('Delete this vault item permanently?')) {
                dataVault = dataVault.filter(v => v.id !== id);
                saveData();
                renderVaultTable();
                updateVaultMetrics();
                addNotification('Vault item deleted', 'warning');
                logAudit('Vault Delete', 'Deleted vault item', 'Low');
            }
        }
        
        function exportVault() {
            const blob = new Blob([JSON.stringify(dataVault, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vault-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            addNotification('Vault exported successfully', 'success');
            logAudit('Vault Export', 'Exported vault data', 'Low');
        }
        
        function clearVault() {
            if (confirm('Clear all vault data? This cannot be undone.')) {
                if (confirm('Final warning: All vault items will be permanently deleted.')) {
                    dataVault = [];
                    saveData();
                    renderVaultTable();
                    updateVaultMetrics();
                    addNotification('Vault cleared', 'danger');
                    logAudit('Vault Clear', 'Cleared all vault data', 'High');
                }
            }
        }

        // Parent Portal
        // ========================================
        // PARENT PORTAL FUNCTIONS
        // ========================================
        
        function loadParentPortal() {
            // Check if parent has verified child
            const parentVerification = JSON.parse(localStorage.getItem('parentVerifications') || '{}');
            const parentUsername = currentUser.username || currentUser.name;
            const verifiedChild = parentVerification[parentUsername];
            
            if (verifiedChild && verifiedChild.adminApproved) {
                // Show main portal
                document.getElementById('parentVerificationSection').style.display = 'none';
                document.getElementById('parentPortalMain').style.display = 'block';
                loadParentChildInfo(verifiedChild.studentId);
            } else if (verifiedChild && verifiedChild.parentConfirmed && !verifiedChild.adminApproved) {
                // Awaiting admin approval
                document.getElementById('parentVerificationSection').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-clock me-2"></i><strong>Awaiting Approval:</strong> Your child verification request has been submitted to the administration for approval. You will be notified once approved.
                    </div>
                `;
                document.getElementById('parentPortalMain').style.display = 'none';
            } else {
                // Show search section
                document.getElementById('parentVerificationSection').style.display = 'block';
                document.getElementById('parentPortalMain').style.display = 'none';
            }
        }
        
        function searchForChild() {
            const surname = document.getElementById('parentSearchSurname').value.trim().toLowerCase();
            const firstName = document.getElementById('parentSearchFirstName').value.trim().toLowerCase();
            const grade = document.getElementById('parentSearchGrade').value;
            
            // Require all three fields: Surname, Name, and Grade
            if (!surname || !firstName || !grade) {
                addNotification('Please enter Surname, Name, and Grade to search for your child', 'warning');
                return;
            }
            
            // Search for matching students (exact match required for better accuracy)
            const results = students.filter(student => {
                const studentSurname = (student.surname || student.name?.split(' ')[0] || '').toLowerCase();
                const studentFirstName = (student.firstName || student.name?.split(' ').slice(1).join(' ') || '').toLowerCase();
                const studentGrade = student.grade || '';
                
                // Use exact match for grade and contains match for names (for flexibility)
                const surnameMatch = studentSurname.includes(surname) || surname.includes(studentSurname);
                const firstNameMatch = studentFirstName.includes(firstName) || firstName.includes(studentFirstName);
                const gradeMatch = studentGrade === grade;
                
                return surnameMatch && firstNameMatch && gradeMatch;
            });
            
            const resultsContainer = document.getElementById('parentSearchResults');
            const resultsList = document.getElementById('parentSearchResultsList');
            
            if (results.length === 0) {
                resultsList.innerHTML = '<p class="text-center text-muted">No students found matching your search criteria.</p>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            resultsList.innerHTML = results.map(student => {
                const displayName = student.name || `${student.surname} ${student.firstName}`;
                const displayGrade = student.grade || 'N/A';
                const displayId = student.accession || student.id;
                
                return `
                    <div class="file-item">
                        <div style="flex: 1;">
                            <h6><i class="fas fa-user-graduate me-2"></i>${displayName}</h6>
                            <p class="mb-0"><small><strong>Grade:</strong> ${displayGrade} | <strong>ID:</strong> ${displayId}</small></p>
                        </div>
                        <div style="white-space: nowrap;">
                            <button class="btn btn-sm btn-primary" onclick="verifyChild(${student.id})">
                                <i class="fas fa-check-circle"></i> This is My Child
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.style.display = 'block';
        }
        
        function verifyChild(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                addNotification('Student not found', 'error');
                return;
            }
            
            const displayName = student.name || `${student.surname} ${student.firstName}`;
            
            if (!confirm(`Please confirm that ${displayName} is your child.\n\nOnce confirmed, your request will be sent to the administration for approval.`)) {
                return;
            }
            
            // Store verification request
            const parentVerification = JSON.parse(localStorage.getItem('parentVerifications') || '{}');
            const parentUsername = currentUser.username || currentUser.name;
            
            parentVerification[parentUsername] = {
                studentId: studentId,
                studentName: displayName,
                parentName: currentUser.name,
                parentUsername: parentUsername,
                requestDate: new Date().toISOString(),
                parentConfirmed: true,
                adminApproved: false
            };
            
            localStorage.setItem('parentVerifications', JSON.stringify(parentVerification));
            
            // Notify admin
            addNotification('Verification request submitted to administration', 'success');
            logUserActivity(parentUsername, 'Parent', 'Child Verification', `Requested verification for ${displayName}`);
            
            // Reload parent portal
            loadParentPortal();
        }
        
        function loadParentChildInfo(studentId) {
            const child = students.find(s => s.id === studentId);
            if (!child) {
                document.getElementById('parentChildInfo').innerHTML = '<p class="text-muted">Child information not found</p>';
                return;
            }
            
            const displayName = child.name || `${child.surname} ${child.firstName}`;
            const displayGrade = child.grade || 'N/A';
            const displayClass = child.class || 'N/A';
            
            document.getElementById('parentChildInfo').innerHTML = `
                <div class="card card-metric p-3">
                    <h4><i class="fas fa-user-graduate me-2"></i>${displayName}</h4>
                    <p><strong>Grade:</strong> ${displayGrade} | <strong>Class:</strong> ${displayClass}</p>
                </div>
            `;
            
            // Load fees
            const childFees = fees.filter(f => f.studentId === studentId);
            document.getElementById('parentFees').innerHTML = childFees.length > 0 ? 
                childFees.map(f => `<p>${f.description}: R${f.amount} - ${f.status}</p>`).join('') :
                '<p class="text-muted">No fees recorded</p>';
            
            // Load grades
            const childGrades = grades.filter(g => g.studentId === studentId);
            document.getElementById('parentGrades').innerHTML = childGrades.length > 0 ?
                childGrades.map(g => `<p>${g.subject}: ${g.score}%</p>`).join('') :
                '<p class="text-muted">No grades recorded</p>';
            
            // Load announcements
            document.getElementById('parentAnnouncements').innerHTML = announcements.length > 0 ?
                announcements.slice(0, 5).map(a => `<p><strong>${a.title}</strong>: ${a.content}</p>`).join('') :
                '<p class="text-muted">No announcements</p>';
            
            // Populate child selectors for timetable and assessment tabs
            populateParentChildSelectors(studentId);
        }
        
        // Populate child selectors in parent portal tabs
        function populateParentChildSelectors(selectedChildId) {
            // Get all verified children for this parent
            const parentVerification = JSON.parse(localStorage.getItem('parentVerifications') || '{}');
            const parentUsername = currentUser.username || currentUser.name;
            const verifiedData = parentVerification[parentUsername];
            
            if (!verifiedData) return;
            
            const child = students.find(s => s.id === verifiedData.studentId);
            if (!child) return;
            
            const displayName = child.name || `${child.surname} ${child.firstName}`;
            const optionHtml = `<option value="${child.id}" selected>${displayName} - Grade ${child.grade || 'N/A'}</option>`;
            
            // Populate timetable selector
            const timetableSelect = document.getElementById('parentTimetableChildSelect');
            if (timetableSelect) {
                timetableSelect.innerHTML = optionHtml;
                loadParentChildTimetable();
            }
            
            // Populate assessment selector
            const assessmentSelect = document.getElementById('parentAssessmentChildSelect');
            if (assessmentSelect) {
                assessmentSelect.innerHTML = optionHtml;
                loadParentChildAssessment();
            }
        }
        
        // Load child's timetable for parent portal
        function loadParentChildTimetable() {
            const selectEl = document.getElementById('parentTimetableChildSelect');
            if (!selectEl || !selectEl.value) return;
            
            const childId = parseInt(selectEl.value);
            const child = students.find(s => s.id === childId);
            
            if (!child) {
                document.getElementById('parentTimetableBody').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-muted">Child information not found</td></tr>';
                return;
            }
            
            // Get timetables for this grade
            const childGrade = child.grade;
            const childClass = child.class || child.classValue;
            const gradeTimetable = timetables.filter(t => t.grade === childGrade || t.class === childClass);
            
            if (gradeTimetable.length === 0) {
                // Generate sample timetable if none exists
                const timeSlots = ['08:00 - 08:45', '08:45 - 09:30', '09:30 - 10:15', '10:30 - 11:15', '11:15 - 12:00', '12:45 - 13:30', '13:30 - 14:15'];
                const subjects = ['Mathematics', 'English', 'Science', 'History', 'Geography', 'Life Skills', 'Physical Education'];
                
                let html = '';
                timeSlots.forEach((time, index) => {
                    html += `<tr>
                        <td><strong>${time}</strong></td>
                        <td class="timetable-cell">${subjects[index % subjects.length]}</td>
                        <td class="timetable-cell">${subjects[(index + 1) % subjects.length]}</td>
                        <td class="timetable-cell">${subjects[(index + 2) % subjects.length]}</td>
                        <td class="timetable-cell">${subjects[(index + 3) % subjects.length]}</td>
                        <td class="timetable-cell">${subjects[(index + 4) % subjects.length]}</td>
                    </tr>`;
                });
                
                document.getElementById('parentTimetableBody').innerHTML = html;
            } else {
                // Render actual timetable
                let html = '';
                gradeTimetable.forEach(entry => {
                    html += `<tr>
                        <td><strong>${entry.time || '-'}</strong></td>
                        <td class="timetable-cell">${entry.monday || '-'}</td>
                        <td class="timetable-cell">${entry.tuesday || '-'}</td>
                        <td class="timetable-cell">${entry.wednesday || '-'}</td>
                        <td class="timetable-cell">${entry.thursday || '-'}</td>
                        <td class="timetable-cell">${entry.friday || '-'}</td>
                    </tr>`;
                });
                document.getElementById('parentTimetableBody').innerHTML = html || 
                    '<tr><td colspan="6" class="text-center text-muted">No timetable available</td></tr>';
            }
        }
        
        // Load child's assessments for parent portal
        function loadParentChildAssessment() {
            const selectEl = document.getElementById('parentAssessmentChildSelect');
            if (!selectEl || !selectEl.value) return;
            
            const childId = parseInt(selectEl.value);
            const child = students.find(s => s.id === childId);
            const typeFilter = document.getElementById('parentAssessmentTypeFilter')?.value || '';
            
            if (!child) {
                return;
            }
            
            // Get assessments from examinations array or generate samples
            const childGrade = child.grade;
            let childAssessments = examinations.filter(e => e.grade === childGrade || e.studentId === childId);
            
            // Apply type filter
            if (typeFilter) {
                childAssessments = childAssessments.filter(a => a.type === typeFilter);
            }
            
            const today = new Date();
            const upcoming = childAssessments.filter(a => new Date(a.date) >= today);
            const past = childAssessments.filter(a => new Date(a.date) < today);
            
            // Update stats
            document.getElementById('parentUpcomingAssessments').textContent = upcoming.length;
            document.getElementById('parentCompletedAssessments').textContent = past.length;
            
            // Calculate averages from grades
            const childGrades = grades.filter(g => g.studentId === childId);
            if (childGrades.length > 0) {
                const avgScore = Math.round(childGrades.reduce((sum, g) => sum + (g.score || 0), 0) / childGrades.length);
                const bestScore = Math.max(...childGrades.map(g => g.score || 0));
                document.getElementById('parentAverageScore').textContent = avgScore + '%';
                document.getElementById('parentBestScore').textContent = bestScore + '%';
            } else {
                document.getElementById('parentAverageScore').textContent = '0%';
                document.getElementById('parentBestScore').textContent = '0%';
            }
            
            // Render upcoming assessments
            if (upcoming.length > 0) {
                document.getElementById('parentUpcomingAssessmentTable').innerHTML = upcoming.map(a => `
                    <tr>
                        <td><span class="badge bg-info">${a.type || 'Assessment'}</span></td>
                        <td>${a.subject || 'N/A'}</td>
                        <td>${a.date || 'TBD'}</td>
                        <td>${a.time || 'TBD'}</td>
                        <td>${a.duration || '-'}</td>
                    </tr>
                `).join('');
            } else {
                // Generate sample upcoming assessments
                const sampleUpcoming = [
                    { type: 'Test', subject: 'Mathematics', date: getDateAfterDays(7), time: '09:00', duration: '1 hour' },
                    { type: 'Assignment', subject: 'English', date: getDateAfterDays(14), time: '08:00', duration: '2 hours' },
                    { type: 'Project', subject: 'Science', date: getDateAfterDays(21), time: '10:00', duration: '3 hours' }
                ];
                document.getElementById('parentUpcomingAssessmentTable').innerHTML = sampleUpcoming.map(a => `
                    <tr>
                        <td><span class="badge bg-info">${a.type}</span></td>
                        <td>${a.subject}</td>
                        <td>${a.date}</td>
                        <td>${a.time}</td>
                        <td>${a.duration}</td>
                    </tr>
                `).join('');
                document.getElementById('parentUpcomingAssessments').textContent = '3';
            }
            
            // Render past results
            if (childGrades.length > 0) {
                document.getElementById('parentPastResultsTable').innerHTML = childGrades.slice(0, 10).map(g => {
                    const grade = getLetterGrade(g.score);
                    return `
                        <tr>
                            <td><span class="badge bg-secondary">${g.type || 'Test'}</span></td>
                            <td>${g.subject || 'N/A'}</td>
                            <td>${g.assessment || g.title || 'Assessment'}</td>
                            <td>${g.date || 'N/A'}</td>
                            <td>${g.score || 0}%</td>
                            <td><span class="badge ${getGradeBadgeClass(grade)}">${grade}</span></td>
                            <td>${g.comments || '-'}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                // Generate sample past results
                const sampleResults = [
                    { type: 'Test', subject: 'Mathematics', assessment: 'Term 1 Test', date: getDateBeforeDays(30), score: 78, comments: 'Good improvement' },
                    { type: 'Exam', subject: 'English', assessment: 'Mid-Year Exam', date: getDateBeforeDays(60), score: 85, comments: 'Excellent work' },
                    { type: 'Assignment', subject: 'Science', assessment: 'Lab Report', date: getDateBeforeDays(45), score: 72, comments: 'Satisfactory' }
                ];
                document.getElementById('parentPastResultsTable').innerHTML = sampleResults.map(g => {
                    const grade = getLetterGrade(g.score);
                    return `
                        <tr>
                            <td><span class="badge bg-secondary">${g.type}</span></td>
                            <td>${g.subject}</td>
                            <td>${g.assessment}</td>
                            <td>${g.date}</td>
                            <td>${g.score}%</td>
                            <td><span class="badge ${getGradeBadgeClass(grade)}">${grade}</span></td>
                            <td>${g.comments}</td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('parentCompletedAssessments').textContent = '3';
                document.getElementById('parentAverageScore').textContent = '78%';
                document.getElementById('parentBestScore').textContent = '85%';
            }
        }
        
        // Helper function to get date after N days
        function getDateAfterDays(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }
        
        // Helper function to get date before N days
        function getDateBeforeDays(days) {
            const date = new Date();
            date.setDate(date.getDate() - days);
            return date.toISOString().split('T')[0];
        }
        
        // Helper function to get letter grade
        function getLetterGrade(score) {
            if (score >= 80) return 'A';
            if (score >= 70) return 'B';
            if (score >= 60) return 'C';
            if (score >= 50) return 'D';
            return 'F';
        }
        
        // Helper function to get grade badge class
        function getGradeBadgeClass(grade) {
            switch(grade) {
                case 'A': return 'bg-success';
                case 'B': return 'bg-info';
                case 'C': return 'bg-warning';
                case 'D': return 'bg-secondary';
                default: return 'bg-danger';
            }
        }
        
        // Parent attendance info module removed - attendance is no longer shown in parent portal
        
        function sendParentMessage() {
            const message = document.getElementById('parentChatInput').value.trim();
            if (!message) return;
            
            // Add message to chat
            const chatContainer = document.getElementById('parentChatMessages');
            const messageHtml = `
                <div class="p-2 mb-2" style="background: rgba(102, 126, 234, 0.3); border-radius: 8px;">
                    <strong>${currentUser.name}:</strong> ${message}
                    <br><small class="text-muted">${new Date().toLocaleTimeString()}</small>
                </div>
            `;
            
            if (chatContainer.innerHTML.includes('No messages yet')) {
                chatContainer.innerHTML = messageHtml;
            } else {
                chatContainer.innerHTML += messageHtml;
            }
            
            // Clear input
            document.getElementById('parentChatInput').value = '';
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            addNotification('Message sent', 'success');
            logUserActivity(currentUser.username || currentUser.name, 'Parent', 'Send Message', 'Sent message to teacher');
        }
        
        function showSendMessageToTeacher() {
            const message = prompt('Enter your message to the teacher:');
            if (!message) return;
            
            sendParentMessage();
            addNotification('Message sent to teacher', 'success');
        }
        
        function showRequestMeetingModal() {
            const teacher = prompt('Enter teacher name:');
            if (!teacher) return;
            
            const date = prompt('Preferred date (YYYY-MM-DD):');
            if (!date) return;
            
            const time = prompt('Preferred time (HH:MM):');
            if (!time) return;
            
            addNotification('Meeting request sent to teacher', 'success');
            logUserActivity(currentUser.username || currentUser.name, 'Parent', 'Meeting Request', 
                `Requested meeting with ${teacher} on ${date} at ${time}`);
        }

        // Student Module Functions
        
        // Load Student Timetable
        function loadStudentTimetable() {
            if (!currentUser || currentUser.role !== 'student') return;
            
            // Mock timetable data - in a real system, this would be filtered for the current student's class
            const timetableData = timetable.length > 0 ? timetable : [
                { day: 'Monday', period: '08:00-09:00', subject: 'Mathematics', teacher: 'Mr. Smith' },
                { day: 'Monday', period: '09:00-10:00', subject: 'English', teacher: 'Mrs. Johnson' },
                { day: 'Monday', period: '10:00-11:00', subject: 'Science', teacher: 'Dr. Brown' },
                { day: 'Tuesday', period: '08:00-09:00', subject: 'History', teacher: 'Ms. Davis' },
                { day: 'Tuesday', period: '09:00-10:00', subject: 'Geography', teacher: 'Mr. Wilson' },
                { day: 'Wednesday', period: '08:00-09:00', subject: 'Physical Education', teacher: 'Coach Taylor' },
            ];
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            let html = '<div class="table-responsive"><table class="table table-bordered">';
            html += '<thead><tr><th>Time</th>';
            days.forEach(day => html += `<th>${day}</th>`);
            html += '</tr></thead><tbody>';
            
            const periods = ['08:00-09:00', '09:00-10:00', '10:00-11:00', '11:00-12:00', '13:00-14:00', '14:00-15:00'];
            periods.forEach(period => {
                html += `<tr><td><strong>${period}</strong></td>`;
                days.forEach(day => {
                    const slot = timetableData.find(t => t.day === day && t.period === period);
                    if (slot) {
                        html += `<td class="timetable-cell">
                            <div><strong>${slot.subject}</strong></div>
                            <div><small>${slot.teacher}</small></div>
                        </td>`;
                    } else {
                        html += '<td class="timetable-cell">-</td>';
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            document.getElementById('studentTimetableContainer').innerHTML = html;
        }
        
        // Load Student Examination
        function loadStudentExamination() {
            if (!currentUser || currentUser.role !== 'student') return;
            
            // Mock exam data
            const upcomingExams = [
                { subject: 'Mathematics', date: '2025-12-01', time: '09:00', duration: '2 hours', status: 'Scheduled' },
                { subject: 'English', date: '2025-12-03', time: '10:00', duration: '1.5 hours', status: 'Scheduled' },
                { subject: 'Science', date: '2025-12-05', time: '09:00', duration: '2 hours', status: 'Scheduled' },
            ];
            
            const pastResults = [
                { subject: 'Mathematics', exam: 'Mid-term', date: '2025-10-15', score: 85, grade: 'B', comments: 'Good work!' },
                { subject: 'English', exam: 'Mid-term', date: '2025-10-16', score: 92, grade: 'A', comments: 'Excellent!' },
                { subject: 'Science', exam: 'Mid-term', date: '2025-10-17', score: 78, grade: 'C', comments: 'Needs improvement' },
            ];
            
            // Update metrics
            document.getElementById('studentUpcomingExams').textContent = upcomingExams.length;
            const avgScore = Math.round(pastResults.reduce((sum, r) => sum + r.score, 0) / pastResults.length);
            document.getElementById('studentAvgScore').textContent = avgScore + '%';
            document.getElementById('studentCompletedExams').textContent = pastResults.length;
            
            // Render upcoming exams
            let examHtml = '';
            upcomingExams.forEach(exam => {
                examHtml += `<tr>
                    <td>${exam.subject}</td>
                    <td>${exam.date}</td>
                    <td>${exam.time}</td>
                    <td>${exam.duration}</td>
                    <td><span class="badge bg-info">${exam.status}</span></td>
                </tr>`;
            });
            document.getElementById('studentExamTable').innerHTML = examHtml || '<tr><td colspan="5" class="text-center">No upcoming exams</td></tr>';
            
            // Render results
            let resultsHtml = '';
            pastResults.forEach(result => {
                const gradeClass = result.grade === 'A' ? 'success' : result.grade === 'B' ? 'primary' : 'warning';
                resultsHtml += `<tr>
                    <td>${result.subject}</td>
                    <td>${result.exam}</td>
                    <td>${result.date}</td>
                    <td>${result.score}%</td>
                    <td><span class="badge bg-${gradeClass}">${result.grade}</span></td>
                    <td>${result.comments}</td>
                </tr>`;
            });
            document.getElementById('studentResultsTable').innerHTML = resultsHtml || '<tr><td colspan="6" class="text-center">No results yet</td></tr>';
        }
        
        // Student Messages Storage
        let studentMessages = JSON.parse(localStorage.getItem('studentMessages') || '[]');
        
        function showSendTeacherMessageModal() {
            new bootstrap.Modal(document.getElementById('sendTeacherMessageModal')).show();
        }
        
        function sendTeacherMessage() {
            const teacher = document.getElementById('teacherRecipient').value;
            const subject = document.getElementById('messageSubject').value.trim();
            const body = document.getElementById('messageBody').value.trim();
            const important = document.getElementById('markImportant').checked;
            
            if (!teacher) {
                addNotification('Please select a teacher', 'warning');
                return;
            }
            
            if (!subject || !body) {
                addNotification('Please fill in the subject and message', 'warning');
                return;
            }
            
            const message = {
                id: Date.now(),
                from: currentUser.name,
                to: teacher,
                subject: subject,
                message: body,
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString(),
                read: false,
                important: important,
                type: 'sent'
            };
            
            studentMessages.push(message);
            localStorage.setItem('studentMessages', JSON.stringify(studentMessages));
            
            // Clear form
            document.getElementById('teacherRecipient').value = '';
            document.getElementById('messageSubject').value = '';
            document.getElementById('messageBody').value = '';
            document.getElementById('markImportant').checked = false;
            
            bootstrap.Modal.getInstance(document.getElementById('sendTeacherMessageModal')).hide();
            loadStudentInbox();
            addNotification('Message sent to ' + teacher + ' successfully!', 'success');
        }
        
        // Load Student Inbox
        function loadStudentInbox() {
            if (!currentUser || currentUser.role !== 'student') return;
            
            // Get messages from localStorage
            studentMessages = JSON.parse(localStorage.getItem('studentMessages') || '[]');
            
            // Get received messages (mock teacher responses)
            const receivedMessages = [
                { 
                    id: 1001, 
                    from: 'Mr. Smith (Mathematics Teacher)',
                    to: currentUser.name,
                    subject: 'Homework Assignment Due',
                    date: '2025-11-15',
                    message: 'Please complete pages 45-47 by Friday.',
                    read: false,
                    important: true,
                    type: 'received'
                },
                { 
                    id: 1002, 
                    from: 'Administration',
                    to: currentUser.name,
                    subject: 'School Event Reminder',
                    date: '2025-11-14',
                    message: 'Sports day is scheduled for next week. Please bring appropriate attire.',
                    read: true,
                    important: false,
                    type: 'received'
                },
                { 
                    id: 1003, 
                    from: 'Mrs. Johnson (English Teacher)',
                    to: currentUser.name,
                    subject: 'Great work on your essay!',
                    date: '2025-11-13',
                    message: 'Your essay showed excellent writing skills. Keep up the good work!',
                    read: true,
                    important: false,
                    type: 'received'
                },
            ];
            
            // Combine sent and received messages
            const allMessages = [...receivedMessages, ...studentMessages.filter(m => m.from === currentUser.name)];
            
            const filter = document.getElementById('studentInboxFilter')?.value || 'all';
            let filteredMessages = allMessages;
            
            if (filter === 'unread') {
                filteredMessages = allMessages.filter(m => !m.read && m.type === 'received');
            } else if (filter === 'important') {
                filteredMessages = allMessages.filter(m => m.important);
            } else if (filter === 'sent') {
                filteredMessages = allMessages.filter(m => m.type === 'sent');
            }
            
            // Sort by date (newest first)
            filteredMessages.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
            
            let html = '';
            filteredMessages.forEach(msg => {
                const isSent = msg.type === 'sent';
                const importantBadge = msg.important ? '<span class="badge bg-danger ms-2">Important</span>' : '';
                const sentBadge = isSent ? '<span class="badge bg-success ms-2">Sent</span>' : '';
                const unreadIndicator = !isSent && !msg.read ? '<i class="fas fa-circle text-primary me-2" style="font-size: 8px;"></i>' : '';
                
                html += `
                    <div class="card mb-3" style="background: rgba(255, 255, 255, ${isSent ? '0.05' : '0.1'});">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">
                                    ${unreadIndicator}
                                    ${msg.subject}
                                    ${importantBadge}
                                    ${sentBadge}
                                </h5>
                                <small class="text-muted">${msg.date}</small>
                            </div>
                            <h6 class="card-subtitle mb-2 text-muted">
                                ${isSent ? 'To: ' + msg.to : 'From: ' + msg.from}
                            </h6>
                            <p class="card-text">${msg.message}</p>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('studentInboxContainer').innerHTML = html || '<p class="text-center text-muted">No messages found. Click "Send Message to Teacher" to start a conversation!</p>';
        }
        
        function searchStudentInbox() {
            const searchTerm = document.getElementById('studentInboxSearch').value.toLowerCase();
            // In a real implementation, this would filter messages
            loadStudentInbox();
        }
        
        // Student Work Submissions Storage
        let studentSubmissions = JSON.parse(localStorage.getItem('studentSubmissions') || '[]');
        
        function submitStudentWork() {
            const title = document.getElementById('studentWorkTitle').value.trim();
            const subject = document.getElementById('studentWorkSubject').value;
            const description = document.getElementById('studentWorkDescription').value.trim();
            const filesInput = document.getElementById('studentWorkFiles');
            const files = filesInput.files;
            
            if (!title || !subject) {
                addNotification('Please fill in the assignment title and subject', 'warning');
                return;
            }
            
            if (files.length === 0) {
                addNotification('Please select at least one file to upload', 'warning');
                return;
            }
            
            // Create file list
            const fileList = [];
            for (let i = 0; i < files.length; i++) {
                fileList.push({
                    name: files[i].name,
                    size: files[i].size,
                    type: files[i].type
                });
            }
            
            // Get student details from students array
            const studentDetails = students.find(s => s.name === currentUser.name) || {};
            
            const submission = {
                id: Date.now(),
                student: currentUser.name,
                studentId: studentDetails.id || currentUser.username,
                grade: studentDetails.grade || 'N/A',
                class: studentDetails.class || 'N/A',
                assignment: title,
                subject: subject,
                description: description,
                files: fileList,
                submittedDate: new Date().toISOString().split('T')[0],
                submittedTime: new Date().toISOString(),
                status: 'Under Review',
                gradeValue: '-',
                feedback: 'Waiting for teacher review'
            };
            
            studentSubmissions.push(submission);
            localStorage.setItem('studentSubmissions', JSON.stringify(studentSubmissions));
            
            // Clear form
            document.getElementById('studentWorkTitle').value = '';
            document.getElementById('studentWorkSubject').value = '';
            document.getElementById('studentWorkDescription').value = '';
            filesInput.value = '';
            
            loadStudentUploadWork();
            addNotification('Work submitted successfully!', 'success');
        }
        
        // Load Student Upload Work
        function loadStudentUploadWork() {
            if (!currentUser || currentUser.role !== 'student') return;
            
            // Get submissions for current student
            studentSubmissions = JSON.parse(localStorage.getItem('studentSubmissions') || '[]');
            const mySubmissions = studentSubmissions.filter(s => s.student === currentUser.name);
            
            // Update metrics
            const submitted = mySubmissions.length;
            const graded = mySubmissions.filter(s => s.status === 'Graded').length;
            const pending = mySubmissions.filter(s => s.status === 'Under Review').length;
            
            document.getElementById('studentSubmittedWork').textContent = submitted;
            document.getElementById('studentPendingWork').textContent = pending;
            document.getElementById('studentGradedWork').textContent = graded;
            
            // Render submissions table
            let html = '';
            mySubmissions.forEach(sub => {
                const statusClass = sub.status === 'Graded' ? 'success' : 'warning';
                const fileNames = sub.files.map(f => f.name).join(', ');
                html += `<tr>
                    <td>${sub.assignment}</td>
                    <td><span class="badge bg-info">${sub.subject}</span></td>
                    <td>${sub.submittedDate}</td>
                    <td><small title="${fileNames}">${sub.files.length} file(s)</small></td>
                    <td><span class="badge bg-${statusClass}">${sub.status}</span></td>
                    <td>${sub.gradeValue || sub.grade || '-'}</td>
                    <td>${sub.feedback}</td>
                </tr>`;
            });
            
            document.getElementById('studentWorkTable').innerHTML = html || '<tr><td colspan="7" class="text-center text-muted">No submissions yet. Submit your first assignment above!</td></tr>';
        }
        
        // ========================================
        // MATH GAME FUNCTIONS
        // ========================================
        
        // Tolerance for floating-point answer comparisons
        const MATH_ANSWER_TOLERANCE = 0.01;
        
        let mathGameState = {
            score: 0,
            highScore: parseInt(localStorage.getItem('mathGameHighScore') || '0'),
            correctCount: 0,
            wrongCount: 0,
            streak: 0,
            bestStreak: 0,
            timeLeft: 60,
            currentQuestion: null,
            currentAnswer: null,
            isPlaying: false,
            timer: null,
            grade: 5
        };
        
        function updateMathGameDifficulty() {
            mathGameState.grade = parseInt(document.getElementById('mathGameGrade').value);
        }
        
        function startMathGame() {
            // Reset game state
            mathGameState.score = 0;
            mathGameState.correctCount = 0;
            mathGameState.wrongCount = 0;
            mathGameState.streak = 0;
            mathGameState.bestStreak = 0;
            mathGameState.timeLeft = 60;
            mathGameState.isPlaying = true;
            mathGameState.grade = parseInt(document.getElementById('mathGameGrade').value);
            
            // Update UI
            updateMathGameUI();
            document.getElementById('mathGameHighScore').textContent = mathGameState.highScore;
            document.getElementById('mathStartScreen').style.display = 'none';
            document.getElementById('mathGameOver').style.display = 'none';
            document.getElementById('mathQuestionArea').style.display = 'block';
            document.getElementById('mathFeedback').innerHTML = '';
            
            // Start timer
            mathGameState.timer = setInterval(() => {
                mathGameState.timeLeft--;
                document.getElementById('mathTimer').textContent = mathGameState.timeLeft;
                
                if (mathGameState.timeLeft <= 10) {
                    document.getElementById('mathTimer').style.color = '#ef4444';
                }
                
                if (mathGameState.timeLeft <= 0) {
                    endMathGame();
                }
            }, 1000);
            
            // Generate first question
            generateMathQuestion();
        }
        
        function generateMathQuestion() {
            const grade = mathGameState.grade;
            let question, answer, type;
            
            if (grade <= 6) {
                // Grade 5-6: Basic operations, fractions, decimals, percentages
                const questionType = Math.floor(Math.random() * 5);
                
                if (questionType === 0) {
                    // Addition
                    const a = Math.floor(Math.random() * 100) + 10;
                    const b = Math.floor(Math.random() * 100) + 10;
                    question = `${a} + ${b} = ?`;
                    answer = a + b;
                    type = 'Addition';
                } else if (questionType === 1) {
                    // Subtraction
                    const a = Math.floor(Math.random() * 100) + 50;
                    const b = Math.floor(Math.random() * 50) + 1;
                    question = `${a} - ${b} = ?`;
                    answer = a - b;
                    type = 'Subtraction';
                } else if (questionType === 2) {
                    // Multiplication
                    const a = Math.floor(Math.random() * 12) + 2;
                    const b = Math.floor(Math.random() * 12) + 2;
                    question = `${a}  ${b} = ?`;
                    answer = a * b;
                    type = 'Multiplication';
                } else if (questionType === 3) {
                    // Division
                    const b = Math.floor(Math.random() * 10) + 2;
                    const answer_ = Math.floor(Math.random() * 10) + 2;
                    const a = b * answer_;
                    question = `${a}  ${b} = ?`;
                    answer = answer_;
                    type = 'Division';
                } else {
                    // Percentage
                    const percentage = [10, 20, 25, 50][Math.floor(Math.random() * 4)];
                    const value = Math.floor(Math.random() * 10 + 1) * 20;
                    question = `${percentage}% of ${value} = ?`;
                    answer = (percentage / 100) * value;
                    type = 'Percentage';
                }
            } else if (grade <= 8) {
                // Grade 7-8: Integers, basic algebra, ratios
                const questionType = Math.floor(Math.random() * 5);
                
                if (questionType === 0) {
                    // Integer multiplication
                    const a = (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 10) + 2);
                    const b = (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 10) + 2);
                    question = `(${a})  (${b}) = ?`;
                    answer = a * b;
                    type = 'Integers';
                } else if (questionType === 1) {
                    // Simple algebra (solve for x)
                    const x = Math.floor(Math.random() * 10) + 2;
                    const b = Math.floor(Math.random() * 20) + 5;
                    const c = x + b;
                    question = `x + ${b} = ${c}, x = ?`;
                    answer = x;
                    type = 'Algebra';
                } else if (questionType === 2) {
                    // Algebra with multiplication
                    const x = Math.floor(Math.random() * 8) + 2;
                    const a = Math.floor(Math.random() * 5) + 2;
                    const result = a * x;
                    question = `${a}x = ${result}, x = ?`;
                    answer = x;
                    type = 'Algebra';
                } else if (questionType === 3) {
                    // Powers
                    const base = Math.floor(Math.random() * 5) + 2;
                    const exp = Math.floor(Math.random() * 3) + 2;
                    question = `${base}^${exp} = ?`;
                    answer = Math.pow(base, exp);
                    type = 'Exponents';
                } else {
                    // Order of operations
                    const a = Math.floor(Math.random() * 5) + 2;
                    const b = Math.floor(Math.random() * 5) + 2;
                    const c = Math.floor(Math.random() * 10) + 1;
                    question = `${a}  ${b} + ${c} = ?`;
                    answer = a * b + c;
                    type = 'Order of Operations';
                }
            } else if (grade <= 10) {
                // Grade 9-10: Linear equations, quadratics, Pythagoras
                const questionType = Math.floor(Math.random() * 5);
                
                if (questionType === 0) {
                    // Linear equation (2 step)
                    const x = Math.floor(Math.random() * 10) + 1;
                    const a = Math.floor(Math.random() * 5) + 2;
                    const b = Math.floor(Math.random() * 10) + 1;
                    const result = a * x + b;
                    question = `${a}x + ${b} = ${result}, x = ?`;
                    answer = x;
                    type = 'Linear Equation';
                } else if (questionType === 1) {
                    // Perfect square
                    const n = Math.floor(Math.random() * 12) + 2;
                    question = `${n * n} = ?`;
                    answer = n;
                    type = 'Square Root';
                } else if (questionType === 2) {
                    // Pythagoras (find hypotenuse)
                    const pythagoreanTriples = [[3,4,5], [5,12,13], [8,15,17], [6,8,10]];
                    const triple = pythagoreanTriples[Math.floor(Math.random() * pythagoreanTriples.length)];
                    question = `Right triangle: a=${triple[0]}, b=${triple[1]}, c=?`;
                    answer = triple[2];
                    type = 'Pythagoras';
                } else if (questionType === 3) {
                    // Factoring
                    const a = Math.floor(Math.random() * 5) + 2;
                    const b = Math.floor(Math.random() * 5) + 2;
                    question = `${a * b} = ${a}  ?`;
                    answer = b;
                    type = 'Factoring';
                } else {
                    // Negative exponents
                    const base = Math.floor(Math.random() * 3) + 2;
                    const exp = 2;
                    question = `${base}^2 - ${base} = ?`;
                    answer = Math.pow(base, 2) - base;
                    type = 'Expressions';
                }
            } else {
                // Grade 11-12: Trigonometry, functions, calculus basics
                const questionType = Math.floor(Math.random() * 5);
                
                if (questionType === 0) {
                    // Trigonometry (special angles)
                    const angles = [
                        { angle: '0', sin: 0, cos: 1, tan: 0 },
                        { angle: '30', sin: 0.5, cos: 0.866, tan: 0.577 },
                        { angle: '45', sin: 0.707, cos: 0.707, tan: 1 },
                        { angle: '60', sin: 0.866, cos: 0.5, tan: 1.732 },
                        { angle: '90', sin: 1, cos: 0, tan: 'undefined' }
                    ];
                    const angleData = angles[Math.floor(Math.random() * 3)]; // Skip 90 for tan
                    const func = ['sin', 'cos'][Math.floor(Math.random() * 2)];
                    if (func === 'sin') {
                        question = `sin(${angleData.angle}) = ? (decimal)`;
                        answer = angleData.sin;
                    } else {
                        question = `cos(${angleData.angle}) = ? (decimal)`;
                        answer = angleData.cos;
                    }
                    type = 'Trigonometry';
                } else if (questionType === 1) {
                    // Quadratic (find x using formula hint)
                    const r1 = Math.floor(Math.random() * 5) + 1;
                    const r2 = Math.floor(Math.random() * 5) + 1;
                    question = `x - ${r1 + r2}x + ${r1 * r2} = 0, smaller x = ?`;
                    answer = Math.min(r1, r2);
                    type = 'Quadratic';
                } else if (questionType === 2) {
                    // Derivative (power rule)
                    const n = Math.floor(Math.random() * 4) + 2;
                    const coef = Math.floor(Math.random() * 5) + 1;
                    question = `d/dx(${coef}x^${n}) = ax^b, a = ?`;
                    answer = coef * n;
                    type = 'Calculus';
                } else if (questionType === 3) {
                    // Log
                    const base = [2, 10][Math.floor(Math.random() * 2)];
                    const exp = Math.floor(Math.random() * 4) + 1;
                    const value = Math.pow(base, exp);
                    question = `log${base === 10 ? '' : base}(${value}) = ?`;
                    answer = exp;
                    type = 'Logarithms';
                } else {
                    // Complex arithmetic
                    const a = Math.floor(Math.random() * 5) + 1;
                    const b = Math.floor(Math.random() * 5) + 1;
                    question = `(${a} + ${b}i) + (${a} - ${b}i) = ?`;
                    answer = 2 * a;
                    type = 'Complex Numbers';
                }
            }
            
            mathGameState.currentQuestion = question;
            mathGameState.currentAnswer = answer;
            
            document.getElementById('mathQuestion').textContent = question;
            document.getElementById('mathQuestionType').textContent = type;
            document.getElementById('mathAnswer').value = '';
            document.getElementById('mathAnswer').focus();
        }
        
        function checkMathAnswer() {
            if (!mathGameState.isPlaying) return;
            
            const userAnswer = parseFloat(document.getElementById('mathAnswer').value.trim());
            const correctAnswer = mathGameState.currentAnswer;
            
            if (isNaN(userAnswer)) {
                document.getElementById('mathFeedback').innerHTML = '<span class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Please enter a valid number!</span>';
                return;
            }
            
            // Allow for small floating point differences
            const isCorrect = Math.abs(userAnswer - correctAnswer) < MATH_ANSWER_TOLERANCE;
            
            if (isCorrect) {
                mathGameState.correctCount++;
                mathGameState.streak++;
                if (mathGameState.streak > mathGameState.bestStreak) {
                    mathGameState.bestStreak = mathGameState.streak;
                }
                
                // Points: base 10 + streak bonus
                const points = 10 + (mathGameState.streak * 2);
                mathGameState.score += points;
                
                // Bonus time for correct answers
                mathGameState.timeLeft = Math.min(mathGameState.timeLeft + 3, 60);
                
                document.getElementById('mathFeedback').innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-2"></i>Correct! +${points} points (+3 seconds)</span>`;
            } else {
                mathGameState.wrongCount++;
                mathGameState.streak = 0;
                
                document.getElementById('mathFeedback').innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-2"></i>Wrong! The answer was ${correctAnswer}</span>`;
            }
            
            updateMathGameUI();
            
            // Generate next question after a brief delay
            setTimeout(() => {
                if (mathGameState.isPlaying) {
                    generateMathQuestion();
                }
            }, 1000);
        }
        
        function skipMathQuestion() {
            if (!mathGameState.isPlaying) return;
            
            mathGameState.score = Math.max(0, mathGameState.score - 5);
            mathGameState.streak = 0;
            
            document.getElementById('mathFeedback').innerHTML = `<span class="text-warning"><i class="fas fa-forward me-2"></i>Skipped! The answer was ${mathGameState.currentAnswer} (-5 points)</span>`;
            
            updateMathGameUI();
            
            setTimeout(() => {
                if (mathGameState.isPlaying) {
                    generateMathQuestion();
                }
            }, 800);
        }
        
        function updateMathGameUI() {
            document.getElementById('mathGameScore').textContent = mathGameState.score;
            document.getElementById('mathGameHighScore').textContent = mathGameState.highScore;
            document.getElementById('mathCorrectCount').textContent = mathGameState.correctCount;
            document.getElementById('mathWrongCount').textContent = mathGameState.wrongCount;
            document.getElementById('mathStreak').textContent = mathGameState.streak;
            document.getElementById('mathTimer').textContent = mathGameState.timeLeft;
            document.getElementById('mathTimer').style.color = mathGameState.timeLeft <= 10 ? '#ef4444' : '';
        }
        
        function endMathGame() {
            mathGameState.isPlaying = false;
            clearInterval(mathGameState.timer);
            
            // Update high score
            if (mathGameState.score > mathGameState.highScore) {
                mathGameState.highScore = mathGameState.score;
                localStorage.setItem('mathGameHighScore', mathGameState.highScore.toString());
            }
            
            // Show game over screen
            document.getElementById('mathQuestionArea').style.display = 'none';
            document.getElementById('mathGameOver').style.display = 'block';
            document.getElementById('mathFinalScore').textContent = mathGameState.score;
            document.getElementById('mathFinalCorrect').textContent = mathGameState.correctCount;
            document.getElementById('mathFinalWrong').textContent = mathGameState.wrongCount;
            document.getElementById('mathFinalStreak').textContent = mathGameState.bestStreak;
            
            // Update high score display
            document.getElementById('mathGameHighScore').textContent = mathGameState.highScore;
        }
        
        // Initialize math game high score on load
        document.addEventListener('DOMContentLoaded', function() {
            const highScore = localStorage.getItem('mathGameHighScore');
            if (highScore) {
                mathGameState.highScore = parseInt(highScore);
            }
        });
        
        // Enhanced AI Research
        let researchHistory = [];
        
        async function researchWithAI() {
            const query = document.getElementById('researchQuery').value.trim();
            const category = document.getElementById('researchCategory').value;
            const provider = document.getElementById('aiProvider').value;
            
            if (!query) {
                addNotification('Please enter a research question', 'warning');
                return;
            }
            
            // Save to history
            const researchItem = {
                id: Date.now(),
                query: query,
                category: category,
                provider: provider,
                timestamp: new Date().toLocaleString()
            };
            researchHistory.unshift(researchItem);
            localStorage.setItem('researchHistory', JSON.stringify(researchHistory));
            
            // Show loading state
            document.getElementById('researchResults').innerHTML = `
                <div class="card mb-3" style="background: rgba(255, 255, 255, 0.15);">
                    <div class="card-body text-center">
                        <div class="spinner-border text-light mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Researching your question using ${provider === 'chatgpt' ? 'ChatGPT' : 'Grok'}...</p>
                    </div>
                </div>
            `;
            
            let response;
            let providerName = provider === 'chatgpt' ? 'ChatGPT' : 'Grok';
            
            // Check which API to use based on provider selection
            if (provider === 'chatgpt') {
                if (chatGPTSettings.enabled && chatGPTSettings.apiKey) {
                    try {
                        response = await callChatGPTAPI(query, category);
                    } catch (error) {
                        console.error('ChatGPT API Error:', error);
                        addNotification('ChatGPT API Error: ' + error.message + '. Using fallback mode.', 'warning');
                        response = generateEnhancedAIResponse(query, category, 'ChatGPT');
                    }
                } else {
                    addNotification('ChatGPT API not configured. Using fallback mode.', 'warning');
                    response = generateEnhancedAIResponse(query, category, 'ChatGPT');
                }
            } else if (provider === 'grok') {
                if (grokSettings.enabled && grokSettings.apiKey) {
                    try {
                        response = await callGrokAPI(query, category);
                    } catch (error) {
                        console.error('Grok API Error:', error);
                        addNotification('Grok API Error: ' + error.message + '. Using fallback mode.', 'warning');
                        response = generateEnhancedAIResponse(query, category, 'Grok');
                    }
                } else {
                    addNotification('Grok API not configured. Using fallback mode.', 'warning');
                    response = generateEnhancedAIResponse(query, category, 'Grok');
                }
            }
            
            document.getElementById('researchResults').innerHTML = `
                <div class="card mb-3" style="background: rgba(255, 255, 255, 0.15);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h4><i class="fas fa-brain me-2"></i>Research Results</h4>
                            <div>
                                <span class="badge bg-primary me-2">${category}</span>
                                <span class="badge bg-success">${providerName}</span>
                            </div>
                        </div>
                        <h5 class="text-info mb-3">"${query}"</h5>
                        ${response}
                        <hr>
                        <div class="mt-3">
                            <h6><i class="fas fa-lightbulb me-2"></i>Related Topics to Explore:</h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${generateRelatedTopics(query, category)}
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted"><i class="fas fa-clock me-1"></i>Researched on: ${new Date().toLocaleString()} using ${providerName}</small>
                        </div>
                    </div>
                </div>
            `;
            
            loadResearchHistory();
            addNotification('Research completed successfully using ' + providerName + '!', 'success');
        }
        
        async function callChatGPTAPI(query, category) {
            const apiKey = chatGPTSettings.apiKey;
            const model = chatGPTSettings.model;
            
            const systemPrompt = `You are an educational AI assistant helping a student with their research. 
The student is researching in the category: ${category}. 
Provide accurate, educational, and age-appropriate information. 
Include relevant examples, explanations, and suggest further areas of study.`;
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: query }
                    ],
                    temperature: 0.7,
                    max_tokens: 1000
                })
            });
            
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            
            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            
            return `
                <div class="alert alert-success text-dark">
                    <div class="d-flex align-items-start mb-2">
                        <i class="fas fa-robot fa-2x me-3"></i>
                        <div>
                            <h6><strong>ChatGPT-4 Response:</strong></h6>
                            <p style="white-space: pre-wrap;">${aiResponse}</p>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Powered by ChatGPT-4 API</strong> - This response was generated using OpenAI's advanced AI model.
                    </div>
                </div>
            `;
        }
        
        async function callGrokAPI(query, category) {
            const apiKey = grokSettings.apiKey;
            const model = grokSettings.model;
            
            const systemPrompt = `You are an educational AI assistant helping a student with their research. 
The student is researching in the category: ${category}. 
Provide accurate, educational, and age-appropriate information. 
Include relevant examples, explanations, and suggest further areas of study.`;
            
            const response = await fetch('https://api.x.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: query }
                    ],
                    temperature: 0.7,
                    max_tokens: 1000,
                    stream: false
                })
            });
            
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            
            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            
            return `
                <div class="alert alert-success text-dark">
                    <div class="d-flex align-items-start mb-2">
                        <i class="fas fa-robot fa-2x me-3"></i>
                        <div>
                            <h6><strong>Grok Response:</strong></h6>
                            <p style="white-space: pre-wrap;">${aiResponse}</p>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Powered by Grok API</strong> - This response was generated using xAI's advanced AI model.
                    </div>
                </div>
            `;
        }
        
        function generateEnhancedAIResponse(query, category, provider = 'AI') {
            // Enhanced AI response with category-specific content
            const responses = {
                science: {
                    intro: 'Based on scientific research and educational databases:',
                    points: [
                        'Scientific principles and theories related to your question',
                        'Real-world applications and examples',
                        'Key scientists and their contributions',
                        'Current research and developments in this area',
                        'Recommended experiments or observations to learn more'
                    ],
                    sources: ['National Science Database', 'Scientific Research Journals', 'Educational Science Resources']
                },
                mathematics: {
                    intro: 'Mathematical analysis and explanations:',
                    points: [
                        'Core mathematical concepts and formulas',
                        'Step-by-step problem-solving approaches',
                        'Real-world applications of these concepts',
                        'Common mistakes to avoid',
                        'Practice problems and exercises'
                    ],
                    sources: ['Mathematics Education Database', 'Khan Academy Resources', 'Mathematical References']
                },
                history: {
                    intro: 'Historical context and information:',
                    points: [
                        'Historical background and timeline',
                        'Key figures and their roles',
                        'Causes and effects of historical events',
                        'Historical significance and impact',
                        'Primary and secondary sources'
                    ],
                    sources: ['Historical Archives', 'Educational History Resources', 'Academic Historical Journals']
                },
                literature: {
                    intro: 'Literary analysis and insights:',
                    points: [
                        'Literary themes and motifs',
                        'Character analysis and development',
                        'Writing style and techniques',
                        'Historical and cultural context',
                        'Critical interpretations and perspectives'
                    ],
                    sources: ['Literary Databases', 'Classic Literature Archives', 'Literary Criticism Resources']
                },
                geography: {
                    intro: 'Geographic information and analysis:',
                    points: [
                        'Geographic features and characteristics',
                        'Climate and environmental factors',
                        'Population and demographics',
                        'Economic and cultural significance',
                        'Current geographic trends and changes'
                    ],
                    sources: ['Geographic Information Systems', 'World Atlas Database', 'Geographic Education Resources']
                },
                technology: {
                    intro: 'Technology insights and information:',
                    points: [
                        'Current technological developments',
                        'How the technology works',
                        'Applications and use cases',
                        'Future trends and implications',
                        'Learning resources and tutorials'
                    ],
                    sources: ['Technology Research Database', 'Tech Education Platforms', 'Innovation Journals']
                },
                general: {
                    intro: 'Comprehensive research findings:',
                    points: [
                        'Overview and background information',
                        'Key concepts and definitions',
                        'Multiple perspectives and viewpoints',
                        'Practical applications and examples',
                        'Further reading and resources'
                    ],
                    sources: ['Educational Databases', 'Academic Resources', 'Research Libraries']
                }
            };
            
            const categoryData = responses[category] || responses.general;
            
            let html = `
                <div class="alert alert-light text-dark">
                    <p><strong>${categoryData.intro}</strong></p>
                    <ul class="mb-3">
                        ${categoryData.points.map(point => `<li>${point}</li>`).join('')}
                    </ul>
                    <div class="mt-3">
                        <h6><i class="fas fa-book me-2"></i>Sources & References:</h6>
                        <ul>
                            ${categoryData.sources.map(source => `<li>${source}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> ${provider} API is not configured or encountered an error. 
                        This is fallback mode with enhanced educational content. 
                        Configure the ${provider} API in Settings for real-time AI-powered research results.
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateRelatedTopics(query, category) {
            const topics = {
                science: ['Physics Principles', 'Chemical Reactions', 'Biology Systems', 'Scientific Method'],
                mathematics: ['Algebra', 'Geometry', 'Calculus', 'Statistics', 'Problem Solving'],
                history: ['Ancient Civilizations', 'World Wars', 'Cultural Movements', 'Political History'],
                literature: ['Poetry Analysis', 'Novel Studies', 'Drama', 'Literary Devices', 'Author Studies'],
                geography: ['World Regions', 'Climate Zones', 'Natural Resources', 'Population Studies'],
                technology: ['Programming', 'Artificial Intelligence', 'Cybersecurity', 'Web Development'],
                general: ['Critical Thinking', 'Research Methods', 'Study Skills', 'Time Management']
            };
            
            const categoryTopics = topics[category] || topics.general;
            return categoryTopics.map(topic => 
                `<button class="btn btn-sm btn-outline-light" onclick="document.getElementById('researchQuery').value='${topic}'; researchWithAI();">${topic}</button>`
            ).join('');
        }
        
        function loadResearchHistory() {
            researchHistory = JSON.parse(localStorage.getItem('researchHistory') || '[]');
            
            if (researchHistory.length === 0) {
                document.getElementById('researchHistory').innerHTML = '';
                return;
            }
            
            let html = `
                <div class="card" style="background: rgba(255, 255, 255, 0.1);">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i>Research History</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
            `;
            
            researchHistory.slice(0, 5).forEach(item => {
                const providerBadge = item.provider ? `<span class="badge bg-success ms-1">${item.provider === 'chatgpt' ? 'ChatGPT' : 'Grok'}</span>` : '';
                html += `
                    <div class="list-group-item" style="background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1);">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${item.query}</h6>
                                <small class="text-muted">
                                    <span class="badge bg-secondary">${item.category}</span>
                                    ${providerBadge}
                                    <i class="fas fa-clock ms-2 me-1"></i>${item.timestamp}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-light" onclick="document.getElementById('researchQuery').value='${item.query}'; document.getElementById('researchCategory').value='${item.category}'; ${item.provider ? `document.getElementById('aiProvider').value='${item.provider}';` : ''} researchWithAI();">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                        ${researchHistory.length > 5 ? `<div class="text-center mt-3"><small class="text-muted">Showing 5 of ${researchHistory.length} searches</small></div>` : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('researchHistory').innerHTML = html;
        }
        
        function clearResearch() {
            document.getElementById('researchQuery').value = '';
            document.getElementById('researchResults').innerHTML = '';
            document.getElementById('researchCategory').value = 'general';
        }

        // Read-Only Teachers Info for Admin
        function renderTeachersReadOnly() {
            renderLessonPlansReadOnly();
        }
        
        function renderHODPortalReadOnly() {
            // Load HOD Dashboard metrics
            const teachers = staff.filter(s => s.role === 'Teacher');
            const lessonPlans = JSON.parse(localStorage.getItem('lessonPlans') || '[]');
            const grades = JSON.parse(localStorage.getItem('grades') || '[]');
            const teacherChats = JSON.parse(localStorage.getItem('teacherChats') || '[]');
            
            document.getElementById('roHodTotalTeachers').textContent = teachers.length;
            document.getElementById('roHodActiveTeachers').textContent = teachers.filter(t => t.status === 'Active').length;
            document.getElementById('roHodTotalLessonPlans').textContent = lessonPlans.length;
            document.getElementById('roHodAvgPerformance').textContent = '85%'; // Mock data
            
            // Load monitoring metrics
            document.getElementById('roMonitorLessonPlansCount').textContent = lessonPlans.length;
            document.getElementById('roMonitorGradesCount').textContent = grades.length;
            document.getElementById('roMonitorAttendanceCount').textContent = attendance.length;
            document.getElementById('roMonitorCommCount').textContent = teacherChats.length;
            
            // Load recent activities
            const activitiesContainer = document.getElementById('roHodRecentActivities');
            if (activitiesContainer) {
                const activities = [
                    { teacher: 'Teacher A', action: 'Submitted lesson plan', time: '10 minutes ago', icon: 'clipboard-list' },
                    { teacher: 'Teacher B', action: 'Entered grades for Grade 10', time: '25 minutes ago', icon: 'graduation-cap' },
                    { teacher: 'Teacher C', action: 'Marked attendance', time: '1 hour ago', icon: 'clock' },
                    { teacher: 'Teacher D', action: 'Uploaded learning resource', time: '2 hours ago', icon: 'upload' },
                    { teacher: 'Teacher E', action: 'Responded to parent message', time: '3 hours ago', icon: 'comments' }
                ];
                
                activitiesContainer.innerHTML = activities.map(act => `
                    <div class="d-flex justify-content-between align-items-center p-3 mb-2" style="background:rgba(255,255,255,0.1);border-radius:8px;">
                        <div>
                            <i class="fas fa-${act.icon} me-2"></i>
                            <strong>${act.teacher}</strong> ${act.action}
                        </div>
                        <small class="text-muted">${act.time}</small>
                    </div>
                `).join('');
            }
            
            // Load activity log
            const activityLog = document.getElementById('roTeacherActivityLog');
            if (activityLog) {
                const activities = [];
                
                // Add lesson plan activities
                lessonPlans.slice(0, 10).forEach(lp => {
                    activities.push({
                        teacher: 'Teacher Name',
                        activity: 'Lesson Plan Submitted',
                        date: lp.date || new Date().toISOString(),
                        details: lp.title || 'Lesson Plan',
                        status: 'Completed'
                    });
                });
                
                // Add grading activities
                grades.slice(0, 10).forEach(grade => {
                    activities.push({
                        teacher: 'Teacher Name',
                        activity: 'Grade Entered',
                        date: new Date().toISOString(),
                        details: `${grade.studentName || 'Student'} - ${grade.subject || 'Subject'}`,
                        status: 'Completed'
                    });
                });
                
                // Sort by date
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                activityLog.innerHTML = activities.slice(0, 20).map(act => {
                    const statusBadge = act.status === 'Completed' ? 'bg-success' : 
                                      act.status === 'Pending' ? 'bg-warning' : 'bg-info';
                    return `
                        <tr>
                            <td>${act.teacher}</td>
                            <td>${act.activity}</td>
                            <td>${new Date(act.date).toLocaleString()}</td>
                            <td>${act.details}</td>
                            <td><span class="badge ${statusBadge}">${act.status}</span></td>
                        </tr>
                    `;
                }).join('');
                
                if (activities.length === 0) {
                    activityLog.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No activities found</td></tr>';
                }
            }
        }
        
        function renderLessonPlansReadOnly() {
            document.getElementById('roLessonPlansList').innerHTML = lessonPlans.length > 0 ? lessonPlans.map(lp => `
                <div class="lesson-plan">
                    <h5>${lp.title}</h5>
                    <p><strong>Subject:</strong> ${lp.subject} | <strong>Date:</strong> ${lp.date}</p>
                    <p><strong>Objectives:</strong> ${lp.objectives}</p>
                    <p><strong>Activities:</strong> ${lp.activities}</p>
                    <p><strong>Materials:</strong> ${lp.materials}</p>
                </div>
            `).join('') : '<p class="text-muted">No lesson plans available.</p>';
        }
        
        function renderGradingReadOnly() {
            const classes = [...new Set(students.map(s => s.grade))];
            document.getElementById('roGradingClass').innerHTML = '<option value="">Select Class</option>' + 
                classes.map(c => `<option value="${c}">${c}</option>`).join('');
            loadGradingReadOnly();
        }
        
        function loadGradingReadOnly() {
            const classFilter = document.getElementById('roGradingClass').value;
            const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
            document.getElementById('roGradingTable').innerHTML = filteredStudents.length > 0 ? filteredStudents.map(s => {
                const studentGrades = grades.filter(g => g.studentId === s.id);
                return studentGrades.length > 0 ? studentGrades.map(sg => `
                    <tr>
                        <td>${s.name}</td>
                        <td>${sg.subject || 'N/A'}</td>
                        <td>${sg.score || ''}</td>
                        <td>${sg.comments || ''}</td>
                    </tr>
                `).join('') : `
                    <tr>
                        <td>${s.name}</td>
                        <td colspan="3" class="text-muted">No grades recorded</td>
                    </tr>
                `;
            }).join('') : '<tr><td colspan="4" class="text-muted">No students found</td></tr>';
        }
        
        function renderResourcesReadOnly() {
            document.getElementById('roResourcesList').innerHTML = resources.length > 0 ? resources.map(r => `
                <div class="lesson-plan">
                    <h5>${r.title}</h5>
                    <p><strong>Type:</strong> ${r.type} | <strong>URL:</strong> <a href="${r.url}" target="_blank">${r.url}</a></p>
                    <p>${r.description}</p>
                </div>
            `).join('') : '<p class="text-muted">No resources available.</p>';
        }
        
        function renderUploadWorkReadOnly() {
            document.getElementById('roUploadedWorkList').innerHTML = uploadedWork.length > 0 ? 
                uploadedWork.map(w => `
                    <div class="report-card mb-2">
                        <div>
                            <h6><i class="fas fa-file me-2"></i>${w.title}</h6>
                            <p class="mb-1"><small>Class: ${w.class} | Uploaded: ${w.uploadDate}</small></p>
                            <p class="mb-1"><small>${w.description}</small></p>
                            <p class="mb-0"><small>Files: ${w.files.map(f => f.name).join(', ')}</small></p>
                        </div>
                    </div>
                `).join('') : 
                '<p class="text-muted">No uploaded work files yet.</p>';
        }
        
        function renderCalendarReadOnly() {
            const monthInput = document.getElementById('roCalendarMonth').value;
            const currentMonth = monthInput ? new Date(monthInput + '-01') : new Date();
            
            // Generate calendar
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            let calendarHTML = '<table class="table table-bordered">';
            calendarHTML += '<thead><tr>';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<th class="text-center">${day}</th>`;
            });
            calendarHTML += '</tr></thead><tbody><tr>';
            
            // Empty cells for days before start of month
            for (let i = 0; i < startDay; i++) {
                calendarHTML += '<td></td>';
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = calendarEvents.filter(e => e.date === currentDate);
                
                calendarHTML += `<td class="timetable-cell" style="height: 100px; vertical-align: top;">`;
                calendarHTML += `<strong>${day}</strong><br>`;
                
                if (dayEvents.length > 0) {
                    dayEvents.forEach(e => {
                        const colors = {
                            'Class': '#36A2EB',
                            'Meeting': '#FFCE56',
                            'Exam': '#FF6384',
                            'Event': '#4BC0C0',
                            'Deadline': '#FF9F40'
                        };
                        const color = colors[e.type] || '#cccccc';
                        calendarHTML += `<div style="background: ${color}; padding: 2px; margin: 2px 0; border-radius: 3px; font-size: 0.75rem;" title="${e.title} - ${e.time}">
                            ${e.title}
                        </div>`;
                    });
                }
                
                calendarHTML += '</td>';
                
                if ((startDay + day) % 7 === 0) {
                    calendarHTML += '</tr><tr>';
                }
            }
            
            // Fill remaining cells
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                calendarHTML += '<td></td>';
            }
            
            calendarHTML += '</tr></tbody></table>';
            document.getElementById('roCalendarView').innerHTML = calendarHTML;
            
            // Render upcoming events
            const today = new Date().toISOString().split('T')[0];
            const upcoming = calendarEvents
                .filter(e => e.date >= today)
                .sort((a, b) => a.date.localeCompare(b.date))
                .slice(0, 5);
            
            document.getElementById('roUpcomingEventsList').innerHTML = upcoming.length > 0 ?
                upcoming.map(e => `
                    <div class="report-card mb-2">
                        <h6>${e.title}</h6>
                        <p class="mb-1"><small><strong>Date:</strong> ${e.date} | <strong>Time:</strong> ${e.time}</small></p>
                        <p class="mb-1"><small><strong>Type:</strong> ${e.type}</small></p>
                        <p class="mb-0"><small>${e.description}</small></p>
                    </div>
                `).join('') :
                '<p class="text-muted">No upcoming events.</p>';
        }

        // Utility: Log audit
        function logAudit(action, details, risk = 'Low') {
            auditLog.unshift({
                id: Date.now(),
                user: currentUser.name,
                action,
                details,
                risk,
                timestamp: new Date().toISOString()
            });
            saveData();
        }
        
        // User Activity Logging for System Management Portal
        function logUserActivity(username, role, action, details) {
            const activities = JSON.parse(localStorage.getItem('userActivities') || '[]');
            activities.unshift({
                id: Date.now(),
                username: username,
                role: role,
                action: action,
                details: details,
                timestamp: new Date().toISOString()
            });
            // Keep only last 1000 activities
            if (activities.length > 1000) {
                activities.splice(1000);
            }
            localStorage.setItem('userActivities', JSON.stringify(activities));
        }
        
        // Track portal usage
        function trackPortalUsage(portal) {
            if (!currentUser) return;
            logUserActivity(currentUser.username || currentUser.name, currentUser.role, 'Portal Access', `Accessed ${portal} portal`);
        }

        // ========================================
        // ONLINE/OFFLINE FUNCTIONALITY
        // ========================================
        
        // Register Service Worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Update online/offline status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusIndicator = document.getElementById('statusIndicator');
            if (statusIndicator) {
                if (isOnline) {
                    statusIndicator.className = 'badge bg-success shadow';
                    statusIndicator.innerHTML = '<i class="fas fa-wifi me-1"></i>Online';
                    // Sync offline queue when coming online
                    syncOfflineData();
                } else {
                    statusIndicator.className = 'badge bg-danger shadow';
                    statusIndicator.innerHTML = '<i class="fas fa-times-circle me-1"></i>Offline';
                }
            }
        }
        
        // Sync offline data when connection is restored
        function syncOfflineData() {
            if (!isOnline || offlineQueue.length === 0) return;
            
            console.log('Syncing offline data...', offlineQueue.length, 'items');
            
            // Process offline queue
            while (offlineQueue.length > 0) {
                const item = offlineQueue.shift();
                console.log('Processing offline item:', item.type);
                // In a real application, this would sync to a server
                // For now, just save to localStorage
                saveData();
            }
            
            addNotification('Offline data synchronized successfully', 'success');
        }
        
        // Add item to offline queue
        function addToOfflineQueue(type, data) {
            offlineQueue.push({
                type: type,
                data: data,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
        }
        
        // Listen for online/offline events
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Update application data across all devices
        // Constant for update button reset delay - reduced for faster response
        const UPDATE_BUTTON_RESET_DELAY = 500;
        
        function updateApplicationData() {
            const updateBtn = document.getElementById('updateAppBtn');
            if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.innerHTML = '<i class="fas fa-bolt me-1"></i><i class="fas fa-spinner fa-spin"></i> Syncing...';
                updateBtn.classList.add('btn-warning');
                updateBtn.classList.remove('btn-info');
            }
            
            // Show sync status indicator
            if (typeof showSyncStatus === 'function') {
                showSyncStatus('Syncing all data...', 'info');
            }
            
            // Force reload all data from localStorage immediately
            loadData();
            
            if (typeof saveData === 'function') {
                saveData(); // This will trigger syncDataToAllDevices for all data types
            }
            
            // Immediately broadcast to ALL devices using multiple methods for guaranteed delivery
            
            // Method 1: BroadcastChannel API (fastest - same browser, different tabs)
            if (typeof broadcastMessage === 'function') {
                broadcastMessage(BROADCAST_TYPES.IMMEDIATE_SYNC, {
                    timestamp: Date.now(),
                    updatedBy: currentUser ? currentUser.name : 'System',
                    role: currentUser ? currentUser.role : 'system',
                    action: 'FULL_SYNC'
                });
            }
            
            // Method 2: localStorage event trigger (cross-tab, cross-window)
            const syncTimestamp = Date.now().toString();
            localStorage.setItem('lastSyncTimestamp', syncTimestamp);
            localStorage.setItem('lastSyncUser', currentUser ? currentUser.name : 'System');
            localStorage.setItem('syncTrigger', Math.random().toString()); // Force event trigger
            
            // Re-render ALL relevant sections for current user role
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection) {
                refreshCurrentSection(currentSection.id);
            }
            
            // Also update dashboard metrics if user is admin/teacher/HOD
            if (currentUser && ['admin', 'teacher', 'hod'].includes(currentUser.role.toLowerCase())) {
                if (typeof renderDashboard === 'function') {
                    // Update dashboard in background for immediate feel
                    setTimeout(() => renderDashboard(), 100);
                }
            }
            
            // Show immediate visual feedback
            setTimeout(() => {
                if (updateBtn) {
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = '<i class="fas fa-check me-1"></i>Synced!';
                    updateBtn.classList.add('btn-success');
                    updateBtn.classList.remove('btn-warning');
                    
                    // Reset button after a short delay
                    setTimeout(() => {
                        updateBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i><span class="d-none d-md-inline">Real-time </span>Update';
                        updateBtn.classList.remove('btn-success');
                        updateBtn.classList.add('btn-info');
                    }, 1500);
                }
                
                // Show sync status success
                if (typeof showSyncStatus === 'function') {
                    showSyncStatus(' Synced!', 'success');
                }
                
                addNotification(' Real-time sync complete! All devices updated instantly.', 'success');
            }, UPDATE_BUTTON_RESET_DELAY);
            
            // Log sync activity
            if (typeof logUserActivity === 'function') {
                logUserActivity(
                    currentUser ? (currentUser.username || currentUser.name) : 'System',
                    currentUser ? currentUser.role : 'System',
                    'Real-time Sync',
                );
            }
        }
        
        // Enhanced listener for data updates from other tabs/windows
        window.addEventListener('storage', function(event) {
            // Handle sync timestamp updates
            if (event.key === 'lastSyncTimestamp' && event.newValue) {
                // Immediately reload data when another tab triggers an update
                loadData();
                const currentSection = document.querySelector('.section:not(.d-none)');
                if (currentSection) {
                    refreshCurrentSection(currentSection.id);
                }
                
                const syncUser = localStorage.getItem('lastSyncUser') || 'Another user';
                addNotification(` Data synced from ${syncUser}`, 'info');
            }
            
            // Handle any data storage changes for real-time updates
            if (['students', 'attendance', 'fees', 'admissions', 'staff', 'announcements'].includes(event.key)) {
                loadData();
                const currentSection = document.querySelector('.section:not(.d-none)');
                if (currentSection) {
                    refreshCurrentSection(currentSection.id);
                }
            }
        });
        
        // Switch to parent timetable tab
        function switchToParentTimetableTab() {
            setTimeout(() => {
                // Activate the timetable tab
                const timetableTab = document.querySelector('a[href="#parent-timetable"]');
                if (timetableTab) {
                    // Remove active from all tabs
                    document.querySelectorAll('#parentTabs .nav-link').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    // Hide all tab panes
                    document.querySelectorAll('#parentPortal .tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    // Activate timetable tab
                    timetableTab.classList.add('active');
                    const timetablePane = document.getElementById('parent-timetable');
                    if (timetablePane) {
                        timetablePane.classList.add('show', 'active');
                    }
                    // Load timetable data
                    if (typeof loadParentChildTimetable === 'function') {
                        loadParentChildTimetable();
                    }
                }
            }, 100);
        }
        
        // ========================================
        // TEACHER CHAT FUNCTIONALITY
        // ========================================
        
        // Render Teacher Chat
        function renderTeacherChat() {
            loadChatStudents();
            loadAdminMessages();
            loadChatHistory();
        }
        
        // Load students list for chat
        function loadChatStudents() {
            const studentsList = document.getElementById('chatStudentsList');
            if (!studentsList) return;
            
            const searchTerm = document.getElementById('studentSearchChat')?.value.toLowerCase() || '';
            const filteredStudents = students.filter(s => 
                s.name.toLowerCase().includes(searchTerm) || 
                s.surname.toLowerCase().includes(searchTerm) ||
                s.grade.toLowerCase().includes(searchTerm)
            );
            
            studentsList.innerHTML = filteredStudents.map(student => `
                <a href="#" class="list-group-item list-group-item-action" 
                   style="background: ${selectedChatStudent?.id === student.id ? 'rgba(255, 255, 255, 0.2)' : 'transparent'}; 
                          border-color: rgba(255, 255, 255, 0.1);"
                   onclick="selectChatStudent(${student.id}); return false;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">${student.name} ${student.surname}</h6>
                            <small class="text-muted">Grade: ${student.grade}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill" style="display: ${hasUnreadMessages(student.id) ? 'inline' : 'none'};">
                            ${getUnreadMessageCount(student.id)}
                        </span>
                    </div>
                </a>
            `).join('');
        }
        
        // Filter chat students
        function filterChatStudents() {
            loadChatStudents();
        }
        
        // Select a student to chat with
        function selectChatStudent(studentId) {
            selectedChatStudent = students.find(s => s.id === studentId);
            if (!selectedChatStudent) return;
            
            document.getElementById('chatStudentName').textContent = 
                `Chat with ${selectedChatStudent.name} ${selectedChatStudent.surname}`;
            document.getElementById('chatMessageInput').disabled = false;
            document.getElementById('sendChatBtn').disabled = false;
            
            // Enable voice note and voice call buttons
            const voiceNoteBtn = document.getElementById('teacherVoiceNoteBtn');
            const voiceCallBtn = document.getElementById('teacherVoiceCallBtn');
            if (voiceNoteBtn) voiceNoteBtn.disabled = false;
            if (voiceCallBtn) voiceCallBtn.disabled = false;
            
            loadChatMessages();
            markMessagesAsRead(studentId);
            loadChatStudents(); // Refresh to update unread count
        }
        
        // Load chat messages for selected student
        function loadChatMessages() {
            if (!selectedChatStudent) return;
            
            const container = document.getElementById('chatMessagesContainer');
            const studentChats = teacherChats.filter(chat => 
                chat.studentId === selectedChatStudent.id || chat.recipientId === selectedChatStudent.id
            );
            
            if (studentChats.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No messages yet. Start the conversation!</p>';
                return;
            }
            
            container.innerHTML = studentChats.map(chat => {
                const isSent = chat.senderId === 'teacher';
                
                // Handle voice note messages
                if (chat.type === 'voice_note') {
                    return `
                        <div class="mb-3 ${isSent ? 'text-end' : 'text-start'}">
                            <div class="voice-note-message d-inline-block" style="max-width: 70%;">
                                <div class="voice-note-player">
                                    <button class="play-btn" onclick="playVoiceNote('${chat.audioUrl}', this)">
                                        <i class="fas fa-play text-white"></i>
                                    </button>
                                    <div class="waveform"></div>
                                    <span class="text-muted"> ${formatDuration(chat.duration || 0)}</span>
                                </div>
                                <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                                    ${new Date(chat.timestamp).toLocaleString()}
                                </small>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="mb-3 ${isSent ? 'text-end' : 'text-start'}">
                        <div class="d-inline-block" style="max-width: 70%; background: ${isSent ? 'rgba(0, 123, 255, 0.2)' : 'rgba(255, 255, 255, 0.2)'}; 
                             padding: 10px; border-radius: 10px;">
                            <div style="font-size: 0.9rem;">${chat.message}</div>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                ${new Date(chat.timestamp).toLocaleString()}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        // Send chat message to student
        function sendChatMessage() {
            if (!selectedChatStudent) return;
            
            const input = document.getElementById('chatMessageInput');
            const message = input.value.trim();
            
            if (!message) {
                addNotification('Please enter a message', 'warning');
                return;
            }
            
            const chatMessage = {
                id: Date.now(),
                senderId: 'teacher',
                senderName: currentUser.name,
                recipientId: selectedChatStudent.id,
                studentId: selectedChatStudent.id,
                message: message,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            teacherChats.push(chatMessage);
            localStorage.setItem('teacherChats', JSON.stringify(teacherChats));
            
            // Broadcast teacher chat to all users immediately
            if (typeof broadcastTeacherChat === 'function') {
                broadcastTeacherChat({
                    id: chatMessage.id,
                    message: message,
                    studentId: selectedChatStudent.id
                });
            }
            
            // Add to offline queue if offline
            if (!isOnline) {
                addToOfflineQueue('chat', chatMessage);
            }
            
            input.value = '';
            loadChatMessages();
            addNotification('Message sent and broadcast!', 'success');
            
            // Log the chat
            logAudit('Chat Message', `Sent message to student: ${selectedChatStudent.name}`, 'Low');
        }
        
        // Check if student has unread messages
        function hasUnreadMessages(studentId) {
            return teacherChats.some(chat => 
                chat.studentId === studentId && 
                chat.senderId !== 'teacher' && 
                !chat.read
            );
        }
        
        // Get unread message count
        function getUnreadMessageCount(studentId) {
            return teacherChats.filter(chat => 
                chat.studentId === studentId && 
                chat.senderId !== 'teacher' && 
                !chat.read
            ).length;
        }
        
        // Mark messages as read
        function markMessagesAsRead(studentId) {
            teacherChats.forEach(chat => {
                if (chat.studentId === studentId && chat.senderId !== 'teacher') {
                    chat.read = true;
                }
            });
            localStorage.setItem('teacherChats', JSON.stringify(teacherChats));
        }
        
        // Load admin messages
        function loadAdminMessages() {
            const container = document.getElementById('adminMessagesContainer');
            if (!container) return;
            
            if (adminMessages.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-dark">
                        <i class="fas fa-info-circle me-2"></i>
                        No messages from admin yet. You can send a message below.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = adminMessages.map(msg => {
                const isSent = msg.senderId === currentUser.username;
                return `
                    <div class="card mb-3" style="background: ${isSent ? 'rgba(0, 123, 255, 0.1)' : 'rgba(255, 255, 255, 0.1)'};">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h6>${msg.subject}</h6>
                                <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
                            </div>
                            <p class="mb-1">${msg.message}</p>
                            <small class="text-muted">
                                ${isSent ? 'To: Admin' : 'From: ' + msg.senderName}
                            </small>
                            ${!isSent && !msg.replied ? `
                                <button class="btn btn-sm btn-primary mt-2" onclick="replyToAdmin(${msg.id})">
                                    <i class="fas fa-reply me-1"></i>Reply
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Send message to admin
        function sendAdminMessage() {
            const subject = document.getElementById('adminMessageSubject').value.trim();
            const message = document.getElementById('adminMessageText').value.trim();
            
            if (!subject || !message) {
                addNotification('Please enter both subject and message', 'warning');
                return;
            }
            
            const adminMessage = {
                id: Date.now(),
                senderId: currentUser.username,
                senderName: currentUser.name,
                recipientId: 'admin',
                subject: subject,
                message: message,
                timestamp: new Date().toISOString(),
                read: false,
                replied: false
            };
            
            adminMessages.push(adminMessage);
            localStorage.setItem('adminMessages', JSON.stringify(adminMessages));
            
            // Broadcast admin message to all users immediately
            if (typeof broadcastAdminMessage === 'function') {
                broadcastAdminMessage({
                    id: adminMessage.id,
                    message: message,
                    subject: subject,
                    priority: 'normal'
                });
            }
            
            // Add to offline queue if offline
            if (!isOnline) {
                addToOfflineQueue('adminMessage', adminMessage);
            }
            
            document.getElementById('adminMessageSubject').value = '';
            document.getElementById('adminMessageText').value = '';
            
            loadAdminMessages();
            addNotification('Message sent and broadcast to all users!', 'success');
            
            logAudit('Admin Message', `Sent message to admin: ${subject}`, 'Low');
        }
        
        // Reply to admin message
        function replyToAdmin(messageId) {
            const message = adminMessages.find(m => m.id === messageId);
            if (!message) return;
            
            document.getElementById('adminMessageSubject').value = 'RE: ' + message.subject;
            document.getElementById('adminMessageText').focus();
            
            // Scroll to the reply form
            document.getElementById('adminMessageText').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Load chat history
        function loadChatHistory() {
            const container = document.getElementById('chatHistoryContainer');
            if (!container) return;
            
            const allChats = [...teacherChats].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            if (allChats.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No chat history yet.</p>';
                return;
            }
            
            const groupedChats = {};
            allChats.forEach(chat => {
                const student = students.find(s => s.id === chat.studentId);
                if (!student) return;
                
                const key = student.id;
                if (!groupedChats[key]) {
                    groupedChats[key] = {
                        student: student,
                        messages: []
                    };
                }
                groupedChats[key].messages.push(chat);
            });
            
            container.innerHTML = Object.values(groupedChats).map(group => `
                <div class="card mb-3" style="background: rgba(255, 255, 255, 0.1);">
                    <div class="card-header">
                        <h6>
                            <i class="fas fa-user me-2"></i>
                            ${group.student.name} ${group.student.surname}
                            <span class="badge bg-secondary ms-2">${group.messages.length} messages</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong>Last message:</strong>
                            <p class="mb-1">${group.messages[0].message}</p>
                            <small class="text-muted">${new Date(group.messages[0].timestamp).toLocaleString()}</small>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="selectChatStudent(${group.student.id}); 
                                document.querySelector('a[href=\\'#chat-students\\']').click();">
                            <i class="fas fa-comments me-1"></i>View Conversation
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Clear chat history
        function clearChatHistory() {
            if (confirm('Are you sure you want to clear all chat history? This action cannot be undone.')) {
                teacherChats = [];
                localStorage.setItem('teacherChats', JSON.stringify(teacherChats));
                loadChatHistory();
                addNotification('Chat history cleared', 'info');
                logAudit('Clear Chat History', 'Cleared all teacher chat history', 'Medium');
            }
        }
        
        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatMessageInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });

        // ========================================
        // EVENTS MANAGEMENT FUNCTIONS
        // ========================================
        
        function loadEventsManagement() {
            renderEventsTable();
            updateEventsMetrics();
            populateEventSelects();
        }
        
        function renderEventsTable() {
            const typeFilter = document.getElementById('eventTypeFilter')?.value || '';
            const dateFilter = document.getElementById('eventDateFilter')?.value || '';
            const searchTerm = document.getElementById('eventSearch')?.value.toLowerCase() || '';
            
            let filteredEvents = schoolEvents;
            
            if (typeFilter) {
                filteredEvents = filteredEvents.filter(e => e.type === typeFilter);
            }
            if (dateFilter) {
                filteredEvents = filteredEvents.filter(e => e.date === dateFilter);
            }
            if (searchTerm) {
                filteredEvents = filteredEvents.filter(e => 
                    e.name.toLowerCase().includes(searchTerm) || 
                    e.location.toLowerCase().includes(searchTerm) ||
                    e.description?.toLowerCase().includes(searchTerm)
                );
            }
            
            const tbody = document.getElementById('eventsTable');
            if (!tbody) return;
            
            tbody.innerHTML = filteredEvents.map(event => {
                const statusBadge = event.status === 'upcoming' ? 'bg-primary' : 
                                  event.status === 'completed' ? 'bg-success' : 'bg-secondary';
                const notificationBadge = event.notificationsSent ? 
                    `<span class="badge bg-success"><i class="fas fa-check"></i> Sent (${event.notificationsSent})</span>` :
                    `<span class="badge bg-warning"><i class="fas fa-times"></i> Not Sent</span>`;
                
                return `<tr>
                    <td>${event.name}</td>
                    <td><span class="badge bg-info">${event.type}</span></td>
                    <td>${event.date}</td>
                    <td>${event.time}</td>
                    <td>${event.location}</td>
                    <td>${event.participants || 'All'}</td>
                    <td><span class="badge ${statusBadge}">${event.status}</span></td>
                    <td>${notificationBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editEvent(${event.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEvent(${event.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${!event.notificationsSent ? `<button class="btn btn-sm btn-success" onclick="sendEventNotifications(${event.id})">
                            <i class="fas fa-bell"></i> Send
                        </button>` : ''}
                    </td>
                </tr>`;
            }).join('');
        }
        
        function updateEventsMetrics() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('totalEvents').textContent = schoolEvents.length;
            document.getElementById('upcomingEvents').textContent = schoolEvents.filter(e => e.date >= today).length;
            document.getElementById('pastEvents').textContent = schoolEvents.filter(e => e.date < today).length;
            document.getElementById('eventNotificationsSent').textContent = schoolEvents.filter(e => e.notificationsSent > 0).length;
        }
        
        function filterEvents() {
            renderEventsTable();
        }
        
        function showAddEventModal() {
            const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
            modal.show();
            
            // Handle participants selection
            document.getElementById('eventParticipants').addEventListener('change', function() {
                const specificGradesContainer = document.getElementById('specificGradesContainer');
                if (this.value === 'specific') {
                    specificGradesContainer.classList.remove('d-none');
                } else {
                    specificGradesContainer.classList.add('d-none');
                }
            });
        }
        
        function addEvent() {
            const name = document.getElementById('eventName').value.trim();
            const type = document.getElementById('eventType').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const location = document.getElementById('eventLocation').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const participants = document.getElementById('eventParticipants').value;
            const specificGrades = document.getElementById('eventSpecificGrades')?.value || '';
            const sendNotification = document.getElementById('eventSendNotification').checked;
            
            if (!name || !type || !date || !time || !location) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const event = {
                id: Date.now(),
                name: name,
                type: type,
                date: date,
                time: time,
                location: location,
                description: description,
                participants: participants === 'specific' ? specificGrades : participants,
                status: date >= new Date().toISOString().split('T')[0] ? 'upcoming' : 'completed',
                notificationsSent: 0,
                createdAt: new Date().toISOString()
            };
            
            schoolEvents.push(event);
            saveData();
            
            if (sendNotification) {
                sendEventNotifications(event.id);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('addEventModal')).hide();
            renderEventsTable();
            updateEventsMetrics();
            addNotification('Event added successfully!', 'success');
            logAudit('Add Event', `Added event: ${name}`, 'Low');
            
            // Clear form
            document.getElementById('eventName').value = '';
            document.getElementById('eventType').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventDescription').value = '';
        }
        
        function showAddExcursionModal() {
            const modal = new bootstrap.Modal(document.getElementById('addExcursionModal'));
            modal.show();
        }
        
        function addExcursion() {
            const name = document.getElementById('excursionName').value.trim();
            const date = document.getElementById('excursionDate').value;
            const time = document.getElementById('excursionTime').value;
            const destination = document.getElementById('excursionDestination').value.trim();
            const cost = document.getElementById('excursionCost').value;
            const description = document.getElementById('excursionDescription').value.trim();
            const grades = document.getElementById('excursionGrades').value.trim();
            const deadline = document.getElementById('excursionDeadline').value;
            const sendNotification = document.getElementById('excursionSendNotification').checked;
            
            if (!name || !date || !time || !destination) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const event = {
                id: Date.now(),
                name: name,
                type: 'excursion',
                date: date,
                time: time,
                location: destination,
                description: `${description}\nCost: R${cost || '0'}\nPermission deadline: ${deadline || 'TBA'}`,
                participants: grades || 'All',
                status: date >= new Date().toISOString().split('T')[0] ? 'upcoming' : 'completed',
                notificationsSent: 0,
                createdAt: new Date().toISOString(),
                cost: cost,
                deadline: deadline
            };
            
            schoolEvents.push(event);
            saveData();
            
            if (sendNotification) {
                sendEventNotifications(event.id);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('addExcursionModal')).hide();
            renderEventsTable();
            updateEventsMetrics();
            addNotification('Excursion added successfully!', 'success');
            logAudit('Add Excursion', `Added excursion: ${name}`, 'Low');
            
            // Clear form
            document.getElementById('excursionName').value = '';
            document.getElementById('excursionDate').value = '';
            document.getElementById('excursionTime').value = '';
            document.getElementById('excursionDestination').value = '';
            document.getElementById('excursionCost').value = '';
            document.getElementById('excursionDescription').value = '';
            document.getElementById('excursionGrades').value = '';
            document.getElementById('excursionDeadline').value = '';
        }
        
        function showAddFundraisingModal() {
            const modal = new bootstrap.Modal(document.getElementById('addFundraisingModal'));
            modal.show();
        }
        
        function addFundraising() {
            const name = document.getElementById('fundraisingName').value.trim();
            const date = document.getElementById('fundraisingDate').value;
            const time = document.getElementById('fundraisingTime').value;
            const location = document.getElementById('fundraisingLocation').value.trim();
            const goal = document.getElementById('fundraisingGoal').value;
            const description = document.getElementById('fundraisingDescription').value.trim();
            const contact = document.getElementById('fundraisingContact').value.trim();
            const sendNotification = document.getElementById('fundraisingSendNotification').checked;
            
            if (!name || !date || !time || !location) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const event = {
                id: Date.now(),
                name: name,
                type: 'fundraising',
                date: date,
                time: time,
                location: location,
                description: `${description}\nFundraising Goal: R${goal || '0'}\nContact: ${contact || 'School Office'}`,
                participants: 'All',
                status: date >= new Date().toISOString().split('T')[0] ? 'upcoming' : 'completed',
                notificationsSent: 0,
                createdAt: new Date().toISOString(),
                goal: goal
            };
            
            schoolEvents.push(event);
            saveData();
            
            if (sendNotification) {
                sendEventNotifications(event.id);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('addFundraisingModal')).hide();
            renderEventsTable();
            updateEventsMetrics();
            addNotification('Fundraising event added successfully!', 'success');
            logAudit('Add Fundraising', `Added fundraising: ${name}`, 'Low');
            
            // Clear form
            document.getElementById('fundraisingName').value = '';
            document.getElementById('fundraisingDate').value = '';
            document.getElementById('fundraisingTime').value = '';
            document.getElementById('fundraisingLocation').value = '';
            document.getElementById('fundraisingGoal').value = '';
            document.getElementById('fundraisingDescription').value = '';
            document.getElementById('fundraisingContact').value = '';
        }
        
        function sendEventNotifications(eventId) {
            const event = schoolEvents.find(e => e.id === eventId);
            if (!event) return;
            
            // Simulate sending notifications
            let recipientCount = 0;
            
            // In a real system, this would send actual notifications
            // For now, we'll just simulate it
            
            // Notify parents
            if (event.participants === 'all' || event.participants === 'students' || event.participants === 'parents') {
                recipientCount += students.length; // All parents
            }
            
            // Notify teachers
            if (event.participants === 'all' || event.participants === 'staff') {
                recipientCount += staff.filter(s => s.role === 'Teacher').length;
            }
            
            event.notificationsSent = recipientCount;
            event.notificationSentAt = new Date().toISOString();
            saveData();
            
            renderEventsTable();
            addNotification(`Notifications sent to ${recipientCount} recipients`, 'success');
            
            // Add to notification system
            addNotification(`Event Notification: ${event.name} on ${event.date} at ${event.time}. Location: ${event.location}`, 'info');
        }
        
        function editEvent(eventId) {
            addNotification('Edit functionality coming soon!', 'info');
        }
        
        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                const eventIndex = schoolEvents.findIndex(e => e.id === eventId);
                if (eventIndex > -1) {
                    const event = schoolEvents[eventIndex];
                    schoolEvents.splice(eventIndex, 1);
                    saveData();
                    renderEventsTable();
                    updateEventsMetrics();
                    addNotification('Event deleted successfully', 'success');
                    logAudit('Delete Event', `Deleted event: ${event.name}`, 'Medium');
                }
            }
        }
        
        function showUpcomingEventsCalendar() {
            // Create and display a calendar modal for events
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            
            // Get all events
            const allEvents = JSON.parse(localStorage.getItem('schoolEvents') || '[]');
            const calendarEventsData = calendarEvents || [];
            const combinedEvents = [...allEvents, ...calendarEventsData];
            
            // Generate calendar HTML
            const modalId = 'eventsCalendarModal';
            let existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHTML = `
                <div class="modal fade" id="${modalId}" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-calendar me-2"></i>Events Calendar</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <input type="month" id="eventsCalendarMonth" class="form-control" value="${currentMonth}" onchange="renderEventsCalendar()">
                                    </div>
                                    <div class="col-md-8 text-end">
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="navigateEventsCalendar(-1)"><i class="fas fa-chevron-left"></i> Previous</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="navigateEventsCalendar(1)">Next <i class="fas fa-chevron-right"></i></button>
                                    </div>
                                </div>
                                <div id="eventsCalendarView"></div>
                                <div class="mt-3">
                                    <h6>Upcoming Events</h6>
                                    <div id="eventsCalendarUpcoming"></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            renderEventsCalendar();
            new bootstrap.Modal(document.getElementById(modalId)).show();
        }
        
        function navigateEventsCalendar(direction) {
            const monthInput = document.getElementById('eventsCalendarMonth');
            if (!monthInput) return;
            
            const current = new Date(monthInput.value + '-01');
            current.setMonth(current.getMonth() + direction);
            monthInput.value = current.toISOString().slice(0, 7);
            renderEventsCalendar();
        }
        
        function renderEventsCalendar() {
            const monthInput = document.getElementById('eventsCalendarMonth');
            if (!monthInput) return;
            
            const currentMonth = monthInput.value ? new Date(monthInput.value + '-01') : new Date();
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            // Get all events
            const schoolEvents = JSON.parse(localStorage.getItem('schoolEvents') || '[]');
            const allEvents = [...schoolEvents, ...(calendarEvents || [])];
            
            // Generate calendar HTML
            let calendarHTML = '<table class="table table-bordered" style="background: rgba(255,255,255,0.1);">';
            calendarHTML += '<thead><tr style="background: rgba(255,255,255,0.2);">';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<th class="text-center" style="color: #fff;">${day}</th>`;
            });
            calendarHTML += '</tr></thead><tbody><tr>';
            
            // Empty cells for days before start of month
            for (let i = 0; i < startDay; i++) {
                calendarHTML += '<td style="background: rgba(255,255,255,0.02);"></td>';
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = allEvents.filter(e => e.date === currentDate || e.eventDate === currentDate);
                const isToday = currentDate === today;
                
                const cellStyle = isToday ? 'background: rgba(233, 69, 96, 0.3); border: 2px solid var(--accent-primary);' : 'background: rgba(255,255,255,0.05);';
                
                calendarHTML += `<td style="height: 100px; vertical-align: top; cursor: pointer; ${cellStyle}" onclick="showEventsForDate('${currentDate}')">`;
                calendarHTML += `<strong style="color: ${isToday ? 'var(--accent-secondary)' : '#fff'};">${day}</strong><br>`;
                
                if (dayEvents.length > 0) {
                    dayEvents.slice(0, 3).forEach(e => {
                        const colors = {
                            'excursion': '#36A2EB',
                            'fundraising': '#FFCE56',
                            'sports': '#FF6384',
                            'cultural': '#4BC0C0',
                            'academic': '#9966FF',
                            'meeting': '#FF9F40',
                            'ceremony': '#C9CBCF',
                            'Class': '#36A2EB',
                            'Meeting': '#FFCE56',
                            'Exam': '#FF6384',
                            'Event': '#4BC0C0',
                            'Deadline': '#FF9F40'
                        };
                        const eventType = e.type || e.eventType || 'other';
                        const color = colors[eventType] || '#cccccc';
                        const title = escapeHtml(e.title || e.name || 'Event');
                        calendarHTML += `<div style="background: ${color}; padding: 2px 4px; margin: 2px 0; border-radius: 3px; font-size: 0.7rem; color: #000; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${title}">
                            ${title}
                        </div>`;
                    });
                    if (dayEvents.length > 3) {
                        calendarHTML += `<small style="color: rgba(255,255,255,0.6);">+${dayEvents.length - 3} more</small>`;
                    }
                }
                
                calendarHTML += '</td>';
                
                if ((startDay + day) % 7 === 0) {
                    calendarHTML += '</tr><tr>';
                }
            }
            
            // Fill remaining cells
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                calendarHTML += '<td style="background: rgba(255,255,255,0.02);"></td>';
            }
            
            calendarHTML += '</tr></tbody></table>';
            
            const calendarView = document.getElementById('eventsCalendarView');
            if (calendarView) {
                calendarView.innerHTML = calendarHTML;
            }
            
            // Render upcoming events
            const upcomingEvents = allEvents
                .filter(e => (e.date || e.eventDate) >= today)
                .sort((a, b) => (a.date || a.eventDate).localeCompare(b.date || b.eventDate))
                .slice(0, 5);
            
            const upcomingContainer = document.getElementById('eventsCalendarUpcoming');
            if (upcomingContainer) {
                if (upcomingEvents.length === 0) {
                    upcomingContainer.innerHTML = '<p class="text-muted">No upcoming events.</p>';
                } else {
                    upcomingContainer.innerHTML = upcomingEvents.map(e => `
                        <div class="p-2 mb-2" style="background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 3px solid var(--accent-primary);">
                            <strong>${escapeHtml(e.title || e.name)}</strong>
                            <br><small><i class="fas fa-calendar me-1"></i>${escapeHtml(e.date || e.eventDate)} ${escapeHtml(e.time || '')}</small>
                            ${e.location ? `<br><small><i class="fas fa-map-marker-alt me-1"></i>${escapeHtml(e.location)}</small>` : ''}
                        </div>
                    `).join('');
                }
            }
        }
        
        function showEventsForDate(date) {
            const schoolEvents = JSON.parse(localStorage.getItem('schoolEvents') || '[]');
            const allEvents = [...schoolEvents, ...(calendarEvents || [])];
            const dayEvents = allEvents.filter(e => e.date === date || e.eventDate === date);
            
            if (dayEvents.length === 0) {
                addNotification(`No events scheduled for ${date}`, 'info');
                return;
            }
            
            let message = `Events on ${date}:\n\n`;
            dayEvents.forEach(e => {
                message += ` ${e.title || e.name}`;
                if (e.time) message += ` at ${e.time}`;
                if (e.location) message += ` (${e.location})`;
                message += '\n';
            });
            
            alert(message);
        }
        
        function populateEventSelects() {
            // Populate meeting teacher select
            const meetingTeacherSelect = document.getElementById('meetingTeacher');
            if (meetingTeacherSelect) {
                const teachers = staff.filter(s => s.role === 'Teacher');
                meetingTeacherSelect.innerHTML = '<option value="">Select Teacher *</option>' +
                    teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            }
            
            // Populate incident student select
            const incidentStudentSelect = document.getElementById('incidentStudent');
            if (incidentStudentSelect) {
                incidentStudentSelect.innerHTML = '<option value="">Select Student *</option>' +
                    students.map(s => `<option value="${s.id}">${s.name} ${s.surname || ''} (${s.grade || 'N/A'})</option>`).join('');
            }
        }
        
        // ========================================
        // PARENT PORTAL FUNCTIONS
        // ========================================
        
        function showRequestMeetingModal() {
            populateEventSelects();
            const modal = new bootstrap.Modal(document.getElementById('requestMeetingModal'));
            modal.show();
        }
        
        function submitMeetingRequest() {
            const teacherId = document.getElementById('meetingTeacher').value;
            const type = document.getElementById('meetingType').value;
            const date = document.getElementById('meetingDate').value;
            const time = document.getElementById('meetingTime').value;
            const reason = document.getElementById('meetingReason').value.trim();
            const contact = document.getElementById('meetingContact').value.trim();
            
            if (!teacherId || !type || !date || !time || !reason) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const teacher = staff.find(s => s.id == teacherId);
            if (!teacher) {
                addNotification('Teacher not found', 'error');
                return;
            }
            
            const request = {
                id: Date.now(),
                parentName: currentUser.name,
                teacherId: teacherId,
                teacherName: teacher.name,
                type: type,
                requestedDate: date,
                requestedTime: time,
                reason: reason,
                contact: contact,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            meetingRequests.push(request);
            saveData();
            
            bootstrap.Modal.getInstance(document.getElementById('requestMeetingModal')).hide();
            loadParentMeetingRequests();
            addNotification('Meeting request submitted successfully!', 'success');
            
            // Clear form
            document.getElementById('meetingTeacher').value = '';
            document.getElementById('meetingType').value = '';
            document.getElementById('meetingDate').value = '';
            document.getElementById('meetingTime').value = '';
            document.getElementById('meetingReason').value = '';
            document.getElementById('meetingContact').value = '';
        }
        
        function loadParentMeetingRequests() {
            if (!currentUser || currentUser.role !== 'parent') return;
            
            const myRequests = meetingRequests.filter(r => r.parentName === currentUser.name);
            const tbody = document.getElementById('parentMeetingRequestsTable');
            
            if (!tbody) return;
            
            tbody.innerHTML = myRequests.map(req => {
                const statusBadge = req.status === 'pending' ? 'bg-warning' : 
                                  req.status === 'approved' ? 'bg-success' : 'bg-danger';
                return `<tr>
                    <td>${req.teacherName}</td>
                    <td><span class="badge bg-info">${req.type}</span></td>
                    <td>${req.requestedDate}</td>
                    <td>${req.requestedTime}</td>
                    <td><span class="badge ${statusBadge}">${req.status}</span></td>
                    <td>${req.notes || '-'}</td>
                </tr>`;
            }).join('');
        }
        
        function sendParentChat() {
            const input = document.getElementById('parentChatInput');
            const message = input.value.trim();
            
            if (!message) {
                addNotification('Please enter a message', 'warning');
                return;
            }
            
            const chatMessage = {
                id: Date.now(),
                from: currentUser.name,
                role: 'parent',
                message: message,
                timestamp: new Date().toISOString()
            };
            
            // Add to a parent chat array (you can extend this)
            let parentChats = JSON.parse(localStorage.getItem('parentChats') || '[]');
            parentChats.push(chatMessage);
            localStorage.setItem('parentChats', JSON.stringify(parentChats));
            
            // Broadcast parent chat to all users immediately
            if (typeof broadcastMessage === 'function') {
                broadcastMessage(BROADCAST_TYPES.PARENT_CHAT, {
                    id: chatMessage.id,
                    message: message,
                    from: currentUser.name
                });
            }
            
            input.value = '';
            loadParentChatMessages();
            addNotification('Message sent and broadcast!', 'success');
        }
        
        function loadParentChatMessages() {
            const container = document.getElementById('parentChatMessages');
            if (!container) return;
            
            let parentChats = JSON.parse(localStorage.getItem('parentChats') || '[]');
            
            if (parentChats.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No messages yet. Start a conversation!</p>';
                return;
            }
            
            container.innerHTML = parentChats.map(chat => {
                const isSent = chat.role === 'parent';
                return `
                    <div class="mb-3 ${isSent ? 'text-end' : 'text-start'}">
                        <div class="d-inline-block" style="max-width: 70%; background: ${isSent ? 'rgba(0, 123, 255, 0.2)' : 'rgba(255, 255, 255, 0.2)'}; 
                             padding: 10px; border-radius: 10px;">
                            <small class="text-muted">${chat.from}</small>
                            <div style="font-size: 0.9rem;">${chat.message}</div>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                ${new Date(chat.timestamp).toLocaleString()}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        function loadParentIncidents() {
            if (!currentUser || currentUser.role !== 'parent') return;
            
            // Get child's student ID (in a real system, this would be properly linked)
            const childStudent = students[0]; // Simplified for demo
            if (!childStudent) return;
            
            const typeFilter = document.getElementById('parentIncidentTypeFilter')?.value || '';
            const dateFilter = document.getElementById('parentIncidentDateFilter')?.value || '';
            
            let filteredIncidents = incidentReports.filter(i => i.studentId == childStudent.id);
            
            if (typeFilter) {
                filteredIncidents = filteredIncidents.filter(i => i.type === typeFilter);
            }
            if (dateFilter) {
                filteredIncidents = filteredIncidents.filter(i => i.date === dateFilter);
            }
            
            const tbody = document.getElementById('parentIncidentsTable');
            if (!tbody) return;
            
            tbody.innerHTML = filteredIncidents.map(incident => {
                const severityBadge = incident.severity === 'high' ? 'bg-danger' : 
                                    incident.severity === 'medium' ? 'bg-warning' : 'bg-info';
                return `<tr>
                    <td>${incident.date}</td>
                    <td><span class="badge bg-secondary">${incident.type}</span></td>
                    <td><span class="badge ${severityBadge}">${incident.severity}</span></td>
                    <td>${incident.description}</td>
                    <td>${incident.action || '-'}</td>
                    <td>${incident.reportedBy}</td>
                </tr>`;
            }).join('');
            
            if (filteredIncidents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No incident reports found.</td></tr>';
            }
        }
        
        // ========================================
        // INCIDENT REPORT FUNCTIONS
        // ========================================
        
        function showAddIncidentModal() {
            populateEventSelects();
            const modal = new bootstrap.Modal(document.getElementById('addIncidentModal'));
            // Set current date and reporter
            document.getElementById('incidentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('incidentReporter').value = currentUser.name;
            modal.show();
        }
        
        function addIncidentReport() {
            const studentId = document.getElementById('incidentStudent').value;
            const type = document.getElementById('incidentType').value;
            const severity = document.getElementById('incidentSeverity').value;
            const date = document.getElementById('incidentDate').value;
            const description = document.getElementById('incidentDescription').value.trim();
            const action = document.getElementById('incidentAction').value.trim();
            const reportedBy = document.getElementById('incidentReporter').value.trim();
            
            if (!studentId || !type || !severity || !date || !description) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const student = students.find(s => s.id == studentId);
            if (!student) {
                addNotification('Student not found', 'error');
                return;
            }
            
            const incident = {
                id: Date.now(),
                studentId: studentId,
                studentName: student.name + ' ' + (student.surname || ''),
                type: type,
                severity: severity,
                date: date,
                description: description,
                action: action,
                reportedBy: reportedBy,
                createdAt: new Date().toISOString()
            };
            
            incidentReports.push(incident);
            saveData();
            
            bootstrap.Modal.getInstance(document.getElementById('addIncidentModal')).hide();
            addNotification('Incident report added successfully!', 'success');
            logAudit('Add Incident', `Added incident report for ${student.name}`, 'Medium');
            
            // Clear form
            document.getElementById('incidentStudent').value = '';
            document.getElementById('incidentType').value = '';
            document.getElementById('incidentSeverity').value = '';
            document.getElementById('incidentDescription').value = '';
            document.getElementById('incidentAction').value = '';
        }
        
        // ========================================
        // TEACHER INCIDENT REPORT FUNCTIONS
        // ========================================
        
        function loadTeacherIncidents() {
            if (!currentUser || currentUser.role !== 'teacher') return;
            
            const typeFilter = document.getElementById('teacherIncidentTypeFilter')?.value || '';
            const studentFilter = document.getElementById('teacherIncidentStudentFilter')?.value || '';
            const dateFilter = document.getElementById('teacherIncidentDateFilter')?.value || '';
            
            let filteredIncidents = incidentReports;
            
            if (typeFilter) {
                filteredIncidents = filteredIncidents.filter(i => i.type === typeFilter);
            }
            if (studentFilter) {
                filteredIncidents = filteredIncidents.filter(i => i.studentId == studentFilter);
            }
            if (dateFilter) {
                filteredIncidents = filteredIncidents.filter(i => i.date === dateFilter);
            }
            
            // Populate student filter if not already populated
            const studentSelect = document.getElementById('teacherIncidentStudentFilter');
            if (studentSelect && studentSelect.options.length === 1) {
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} ${student.surname || ''} (${student.grade || 'N/A'})`;
                    studentSelect.appendChild(option);
                });
            }
            
            const tbody = document.getElementById('teacherIncidentsTable');
            if (!tbody) return;
            
            tbody.innerHTML = filteredIncidents.map(incident => {
                const severityBadge = incident.severity === 'high' ? 'bg-danger' : 
                                    incident.severity === 'medium' ? 'bg-warning' : 'bg-info';
                return `<tr>
                    <td>${incident.date}</td>
                    <td>${incident.studentName}</td>
                    <td><span class="badge bg-secondary">${incident.type}</span></td>
                    <td><span class="badge ${severityBadge}">${incident.severity}</span></td>
                    <td>${incident.description}</td>
                    <td>${incident.action || '-'}</td>
                    <td>${incident.reportedBy}</td>
                </tr>`;
            }).join('');
            
            if (filteredIncidents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No incident reports found.</td></tr>';
            }
        }
        
        // ========================================
        // WORK VAULT FUNCTIONS
        // ========================================
        
        function renderWorkVault() {
            if (!currentUser || currentUser.role !== 'teacher') return;
            
            // Get all student submissions from localStorage
            const allSubmissions = JSON.parse(localStorage.getItem('studentSubmissions') || '[]');
            
            // Get filter values
            const studentFilter = document.getElementById('workVaultStudentFilter')?.value || '';
            const classFilter = document.getElementById('workVaultClassFilter')?.value || '';
            const dateFilter = document.getElementById('workVaultDateFilter')?.value || '';
            const searchTerm = document.getElementById('workVaultSearch')?.value.toLowerCase() || '';
            
            // Apply filters
            let filteredSubmissions = allSubmissions;
            
            if (studentFilter) {
                filteredSubmissions = filteredSubmissions.filter(s => s.student === studentFilter);
            }
            if (classFilter) {
                filteredSubmissions = filteredSubmissions.filter(s => s.grade === classFilter || s.class === classFilter);
            }
            if (dateFilter) {
                filteredSubmissions = filteredSubmissions.filter(s => s.submittedDate === dateFilter);
            }
            if (searchTerm) {
                filteredSubmissions = filteredSubmissions.filter(s => 
                    s.assignment.toLowerCase().includes(searchTerm) || 
                    s.subject.toLowerCase().includes(searchTerm) ||
                    s.student.toLowerCase().includes(searchTerm) ||
                    s.description?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Populate student filter if not already done
            const studentSelect = document.getElementById('workVaultStudentFilter');
            if (studentSelect && studentSelect.options.length === 1) {
                const uniqueStudents = [...new Set(allSubmissions.map(s => s.student))];
                uniqueStudents.forEach(studentName => {
                    const option = document.createElement('option');
                    option.value = studentName;
                    option.textContent = studentName;
                    studentSelect.appendChild(option);
                });
            }
            
            // Populate class filter if not already done
            const classSelect = document.getElementById('workVaultClassFilter');
            if (classSelect && classSelect.options.length === 1) {
                const uniqueClasses = [...new Set(allSubmissions.map(s => s.grade || s.class).filter(c => c && c !== 'N/A'))];
                uniqueClasses.sort();
                uniqueClasses.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
            }
            
            // Update metrics
            const today = new Date().toISOString().split('T')[0];
            const todaySubmissions = allSubmissions.filter(s => s.submittedDate === today).length;
            const uniqueStudents = [...new Set(allSubmissions.map(s => s.student))].length;
            
            // Get submissions from this week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const oneWeekAgoStr = oneWeekAgo.toISOString().split('T')[0];
            const weekSubmissions = allSubmissions.filter(s => s.submittedDate >= oneWeekAgoStr).length;
            
            document.getElementById('totalSubmissions').textContent = allSubmissions.length;
            document.getElementById('todaySubmissions').textContent = todaySubmissions;
            document.getElementById('uniqueStudents').textContent = uniqueStudents;
            document.getElementById('weekSubmissions').textContent = weekSubmissions;
            
            // Render submissions list
            const listContainer = document.getElementById('workVaultList');
            if (!listContainer) return;
            
            if (filteredSubmissions.length === 0) {
                listContainer.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        No submissions found. ${searchTerm || studentFilter || classFilter || dateFilter ? 'Try adjusting your filters.' : 'Students will see their submissions here after uploading.'}
                    </div>
                `;
                return;
            }
            
            // Sort by submitted date (newest first)
            filteredSubmissions.sort((a, b) => new Date(b.submittedTime || b.submittedDate) - new Date(a.submittedTime || a.submittedDate));
            
            const html = filteredSubmissions.map(submission => {
                const statusClass = submission.status === 'Graded' ? 'success' : 
                                  submission.status === 'Under Review' ? 'warning' : 'info';
                const fileNames = submission.files.map(f => f.name).join(', ');
                const filesDisplay = submission.files.map(f => 
                    `<span class="badge bg-secondary me-1" title="${f.size} bytes">${f.name}</span>`
                ).join('');
                
                return `
                    <div class="card mb-3" style="background: rgba(255, 255, 255, 0.1); border-left: 4px solid rgba(99, 102, 241, 0.8);">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="mb-2">
                                        <i class="fas fa-file-alt me-2"></i>${submission.assignment}
                                        <span class="badge bg-${statusClass} ms-2">${submission.status}</span>
                                    </h5>
                                    <div class="mb-2">
                                        <strong><i class="fas fa-user me-1"></i>Student:</strong> ${submission.student}
                                        <span class="badge bg-info ms-2">${submission.grade || submission.class || 'N/A'}</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong><i class="fas fa-book me-1"></i>Subject:</strong> 
                                        <span class="badge bg-primary">${submission.subject}</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong><i class="fas fa-calendar me-1"></i>Submitted:</strong> ${submission.submittedDate}
                                        ${submission.submittedTime ? `<small class="text-muted ms-1">(${new Date(submission.submittedTime).toLocaleTimeString()})</small>` : ''}
                                    </div>
                                    ${submission.description ? `
                                        <div class="mb-2">
                                            <strong><i class="fas fa-comment me-1"></i>Description:</strong><br>
                                            <small>${submission.description}</small>
                                        </div>
                                    ` : ''}
                                    <div class="mb-2">
                                        <strong><i class="fas fa-paperclip me-1"></i>Files (${submission.files.length}):</strong><br>
                                        ${filesDisplay}
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="mb-2">
                                        <strong>Grade:</strong> ${submission.gradeValue || submission.grade || '-'}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Feedback:</strong><br>
                                        <small>${submission.feedback || 'No feedback yet'}</small>
                                    </div>
                                    <button class="btn btn-sm btn-primary mb-2" onclick="gradeSubmission(${submission.id})">
                                        <i class="fas fa-pen me-1"></i>Grade Work
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="viewSubmissionDetails(${submission.id})">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = html;
        }
        
        // Grade submission function
        function gradeSubmission(submissionId) {
            const allSubmissions = JSON.parse(localStorage.getItem('studentSubmissions') || '[]');
            const submission = allSubmissions.find(s => s.id === submissionId);
            
            if (!submission) {
                addNotification('Submission not found', 'error');
                return;
            }
            
            const grade = prompt(`Enter grade for "${submission.assignment}" (e.g., A, B, C, 85%, etc.):`, submission.gradeValue || '');
            if (grade === null) return; // User cancelled
            
            const feedback = prompt('Enter feedback for the student:', submission.feedback || '');
            if (feedback === null) return; // User cancelled
            
            // Update submission
            submission.gradeValue = grade || '-';
            submission.grade = grade || '-';
            submission.feedback = feedback || 'No feedback provided';
            submission.status = grade ? 'Graded' : 'Under Review';
            submission.gradedDate = new Date().toISOString().split('T')[0];
            submission.gradedBy = currentUser.name;
            
            // Save back to localStorage
            localStorage.setItem('studentSubmissions', JSON.stringify(allSubmissions));
            
            // Refresh display
            renderWorkVault();
            addNotification('Work graded successfully!', 'success');
            
            // Log the action
            logAudit('Grade Work', `Graded ${submission.assignment} for ${submission.student}`, 'Low');
        }
        
        // View submission details
        function viewSubmissionDetails(submissionId) {
            const allSubmissions = JSON.parse(localStorage.getItem('studentSubmissions') || '[]');
            const submission = allSubmissions.find(s => s.id === submissionId);
            
            if (!submission) {
                addNotification('Submission not found', 'error');
                return;
            }
            
            const filesList = submission.files.map(f => `- ${f.name} (${(f.size / 1024).toFixed(2)} KB)`).join('\n');
            
            alert(`Submission Details:
            
Assignment: ${submission.assignment}
Student: ${submission.student}
Grade/Class: ${submission.grade || submission.class || 'N/A'}
Subject: ${submission.subject}
Submitted: ${submission.submittedDate}
Status: ${submission.status}
Grade: ${submission.gradeValue || submission.grade || '-'}

Description:
${submission.description || 'No description provided'}

Files:
${filesList}

Feedback:
${submission.feedback || 'No feedback yet'}`);
        }
        
        // ========================================
        // VIRTUAL FORMS FUNCTIONS
        // ========================================
        
        // Constants
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB in bytes
        
        let virtualForms = [];
        
        function loadVirtualForms() {
            virtualForms = JSON.parse(localStorage.getItem('virtualForms') || '[]');
            renderVirtualForms();
        }
        
        function saveVirtualForms() {
            localStorage.setItem('virtualForms', JSON.stringify(virtualForms));
        }
        
        function uploadVirtualForm() {
            const formName = document.getElementById('virtualFormName').value.trim();
            const formFile = document.getElementById('virtualFormFile').files[0];
            const formDescription = document.getElementById('virtualFormDescription').value.trim();
            const formCategory = document.getElementById('virtualFormCategory').value;
            
            if (!formName) {
                addNotification('Please enter a form name', 'warning');
                return;
            }
            
            if (!formFile) {
                addNotification('Please select a file to upload', 'warning');
                return;
            }
            
            // Validate file size using constant
            if (formFile.size > MAX_FILE_SIZE) {
                addNotification(`File size exceeds ${MAX_FILE_SIZE / (1024 * 1024)}MB limit. Please choose a smaller file.`, 'error');
                return;
            }
            
            // Validate file type
            const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
                                  'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'text/plain'];
            if (!allowedTypes.includes(formFile.type)) {
                addNotification('Invalid file type. Please upload PDF, Word, Excel, or Text files only.', 'error');
                return;
            }
            
            // Create form object
            const reader = new FileReader();
            reader.onload = function(e) {
                const form = {
                    id: Date.now(),
                    name: formName,
                    fileName: formFile.name,
                    fileSize: formFile.size,
                    fileType: formFile.type,
                    fileData: e.target.result,
                    description: formDescription,
                    category: formCategory,
                    uploadedDate: new Date().toISOString().split('T')[0],
                    uploadedBy: currentUser.name
                };
                
                virtualForms.push(form);
                saveVirtualForms();
                renderVirtualForms();
                
                // Clear form
                document.getElementById('virtualFormName').value = '';
                document.getElementById('virtualFormFile').value = '';
                document.getElementById('virtualFormDescription').value = '';
                
                addNotification('Form uploaded successfully!', 'success');
                logAudit('Upload Virtual Form', `Uploaded form: ${formName}`, 'Low');
            };
            
            reader.readAsDataURL(formFile);
        }
        
        function renderVirtualForms() {
            const container = document.getElementById('uploadedVirtualForms');
            if (!container) return;
            
            if (virtualForms.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No forms uploaded yet. Upload a form using the section above.</p>';
                return;
            }
            
            container.innerHTML = virtualForms.map(form => `
                <div class="file-item">
                    <div style="flex: 1;">
                        <h6><i class="fas fa-file me-2"></i>${form.name}</h6>
                        <p class="mb-1 text-muted"><small>${form.description || 'No description'}</small></p>
                        <p class="mb-0">
                            <span class="badge bg-primary">${form.category}</span>
                            <span class="badge bg-secondary ms-1">${form.fileName}</span>
                            <span class="badge bg-info ms-1">${(form.fileSize / 1024).toFixed(2)} KB</span>
                            <span class="badge bg-success ms-1">${form.uploadedDate}</span>
                        </p>
                    </div>
                    <div style="white-space: nowrap;">
                        <button class="btn btn-sm btn-info me-1" onclick="viewVirtualForm(${form.id})" title="View Form">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary me-1" onclick="editVirtualForm(${form.id})" title="Edit/Fill Form">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-success me-1" onclick="printVirtualForm(${form.id})" title="Print Form">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary me-1" onclick="downloadVirtualForm(${form.id})" title="Download Form">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteVirtualForm(${form.id})" title="Delete Form">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function viewVirtualForm(id) {
            const form = virtualForms.find(f => f.id === id);
            if (!form) {
                addNotification('Form not found', 'error');
                return;
            }
            
            // Open in new window/tab
            const newWindow = window.open('', '_blank');
            if (form.fileType === 'application/pdf') {
                newWindow.document.write(`
                    <html>
                        <head><title>${form.name}</title></head>
                        <body style="margin:0;">
                            <embed src="${form.fileData}" type="application/pdf" width="100%" height="100%" />
                        </body>
                    </html>
                `);
            } else {
                newWindow.document.write(`
                    <html>
                        <head><title>${form.name}</title></head>
                        <body style="padding: 20px; font-family: Arial;">
                            <h2>${form.name}</h2>
                            <p><strong>Description:</strong> ${form.description || 'No description'}</p>
                            <p><strong>Category:</strong> ${form.category}</p>
                            <p><strong>File Name:</strong> ${form.fileName}</p>
                            <p><strong>Uploaded:</strong> ${form.uploadedDate}</p>
                            <p><strong>Uploaded By:</strong> ${form.uploadedBy}</p>
                            <hr>
                            <p><em>File preview not available for this file type. Please download to view.</em></p>
                        </body>
                    </html>
                `);
            }
        }
        
        function editVirtualForm(id) {
            const form = virtualForms.find(f => f.id === id);
            if (!form) {
                addNotification('Form not found', 'error');
                return;
            }
            
            // Feature not yet fully implemented - provide clear feedback
            addNotification('Form editing feature coming soon! For now, please download the form and edit it locally.', 'info');
            
            // Optionally open for viewing
            if (confirm(`The form editor is not yet available.\n\nWould you like to view the form instead?`)) {
                viewVirtualForm(id);
            }
        }
        
        function printVirtualForm(id) {
            const form = virtualForms.find(f => f.id === id);
            if (!form) {
                addNotification('Form not found', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            if (form.fileType === 'application/pdf') {
                printWindow.document.write(`
                    <html>
                        <head><title>Print: ${form.name}</title></head>
                        <body onload="window.print(); window.close();">
                            <embed src="${form.fileData}" type="application/pdf" width="100%" height="100%" />
                        </body>
                    </html>
                `);
            } else {
                printWindow.document.write(`
                    <html>
                        <head><title>Print: ${form.name}</title></head>
                        <body style="padding: 20px;" onload="window.print();">
                            <h2>${form.name}</h2>
                            <p><strong>Category:</strong> ${form.category}</p>
                            <p><strong>Description:</strong> ${form.description || 'No description'}</p>
                            <hr>
                            <p>File: ${form.fileName}</p>
                        </body>
                    </html>
                `);
            }
        }
        
        function downloadVirtualForm(id) {
            const form = virtualForms.find(f => f.id === id);
            if (!form) {
                addNotification('Form not found', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.href = form.fileData;
            link.download = form.fileName;
            link.click();
            
            addNotification('Form downloaded successfully!', 'success');
            logAudit('Download Virtual Form', `Downloaded form: ${form.name}`, 'Low');
        }
        
        function deleteVirtualForm(id) {
            const form = virtualForms.find(f => f.id === id);
            if (!form) {
                addNotification('Form not found', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete the form "${form.name}"?`)) {
                return;
            }
            
            const index = virtualForms.findIndex(f => f.id === id);
            if (index > -1) {
                virtualForms.splice(index, 1);
                saveVirtualForms();
                renderVirtualForms();
                addNotification('Form deleted successfully!', 'success');
                logAudit('Delete Virtual Form', `Deleted form: ${form.name}`, 'Medium');
            }
        }
        
        // Functions for the pre-defined admission form
        // Note: getAdmissionFormHTML() returns a static, sanitized HTML string
        // No user input is included in the HTML content to prevent XSS
        function viewAdmissionForm() {
            const newWindow = window.open('about:blank', '_blank');
            if (!newWindow) {
                addNotification('Pop-up blocked. Please allow pop-ups for this site to view forms.', 'warning');
                return;
            }
            try {
                newWindow.document.open();
                newWindow.document.write(getAdmissionFormHTML());
                newWindow.document.close();
            } catch (error) {
                addNotification('Error opening form. Please check your browser settings.', 'error');
                console.error('Error opening form:', error);
            }
        }
        
        function fillAdmissionForm() {
            const newWindow = window.open('about:blank', '_blank');
            newWindow.document.write(getAdmissionFormHTML());
            addNotification('Admission form opened for filling. Fill and submit when ready.', 'info');
        }
        
        function printAdmissionForm() {
            const printWindow = window.open('about:blank', '_blank');
            printWindow.document.write(getAdmissionFormHTML());
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }
        
        function downloadAdmissionForm() {
            const htmlContent = getAdmissionFormHTML();
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'admission-form-bophelong-school.html';
            link.click();
            addNotification('Admission form downloaded as HTML file!', 'success');
        }
        
        function getAdmissionFormHTML() {
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application for Admission - Bophelong Community Independent School</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }
        .header { text-align: center; border-bottom: 2px solid #007bff; padding-bottom: 20px; margin-bottom: 20px; }
        .logo { max-width: 200px; height: auto; }
        h1, h2, h3 { color: #007bff; }
        form { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; }
        .row .col { flex: 1; }
        .checkbox-group { display: flex; gap: 20px; margin-top: 5px; }
        .checkbox-group label { font-weight: normal; display: inline-flex; align-items: center; gap: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .section { margin-bottom: 30px; border: 1px solid #eee; padding: 15px; border-radius: 4px; }
        .agreement { background-color: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; }
        button:hover { background: #0056b3; }
        @media print { .no-print { display: none; } }
        @media (max-width: 600px) { .row { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://img1.wsimg.com/isteam/ip/33f55342-69d0-4c3b-9478-c9e1f81bbc39/blob.png" alt="Bophelong Community Independent School Logo" class="logo">
        <h1>Application for Admission to School</h1>
        <p>Bophelong Community Independent School | Tel: (012) 801-7552 | Pretoria | Fax: 012-8017552</p>
        <p><em>This form must be completed in full. Changes to be initialed and signed by parent/guardian. Completing the form does not necessarily mean that the Internet form has been accepted into the school.</em></p>
    </div>

    <form id="enrollmentForm">
        <!-- Page 1: Learner Information -->
        <div class="section">
            <h2>Learner Information</h2>
            <div class="row">
                <div class="col">
                    <label for="gradeApplied">Grade Applied For:</label>
                    <select id="gradeApplied" name="gradeApplied" required>
                        <option value="">Select Grade</option>
                        <option value="R">Grade R</option>
                        <option value="1">Grade 1</option>
                        <option value="2">Grade 2</option>
                        <option value="3">Grade 3</option>
                        <option value="4">Grade 4</option>
                        <option value="5">Grade 5</option>
                        <option value="6">Grade 6</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                        <option value="9">Grade 9</option>
                        <option value="10">Grade 10</option>
                        <option value="11">Grade 11</option>
                        <option value="12">Grade 12</option>
                    </select>
                </div>
                <div class="col">
                    <label for="highestGrade">Highest Grade Passed:</label>
                    <input type="text" id="highestGrade" name="highestGrade">
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label for="yearPassed">Year When Grade was Passed:</label>
                    <input type="number" id="yearPassed" name="yearPassed">
                </div>
                <div class="col">
                    <label for="accessionNo">Accession No:</label>
                    <input type="text" id="accessionNo" name="accessionNo">
                </div>
            </div>
            <label for="surname">Surname:</label>
            <input type="text" id="surname" name="surname" required>
            <label for="initials">Initials:</label>
            <input type="text" id="initials" name="initials">
            <label for="nickName">Nick Name:</label>
            <input type="text" id="nickName" name="nickName">
            <label for="dob">Date of Birth (YYYY-MM-DD):</label>
            <input type="date" id="dob" name="dob" required>
            <div class="row">
                <div class="col">
                    <label for="race">Race:</label>
                    <select id="race" name="race">
                        <option value="">Select</option>
                        <option value="Asian">Asian</option>
                        <option value="Black">Black</option>
                        <option value="Coloured">Coloured</option>
                        <option value="White">White</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col">
                    <label>Gender:</label>
                    <div class="checkbox-group">
                        <label><input type="radio" name="gender" value="Male"> Male</label>
                        <label><input type="radio" name="gender" value="Female"> Female</label>
                    </div>
                </div>
            </div>
            <label for="idNumber">ID Number / Passport No:</label>
            <input type="text" id="idNumber" name="idNumber">
            <label for="citizenship">Citizenship:</label>
            <input type="text" id="citizenship" name="citizenship">
            <label for="physicalAddress">Physical Address of Residence:</label>
            <textarea id="physicalAddress" name="physicalAddress" rows="3"></textarea>
            <div class="row">
                <div class="col">
                    <label for="homeTel">Home Telephone:</label>
                    <input type="tel" id="homeTel" name="homeTel">
                </div>
                <div class="col">
                    <label for="emergencyTel">Emergency Telephone:</label>
                    <input type="tel" id="emergencyTel" name="emergencyTel">
                </div>
            </div>
            <label for="learnerEmail">Learner Email Address:</label>
            <input type="email" id="learnerEmail" name="learnerEmail">
            <label for="learnerCell">Learner Cell:</label>
            <input type="tel" id="learnerCell" name="learnerCell">
            <div class="row">
                <div class="col">
                    <label for="homeLanguage">Home Language:</label>
                    <input type="text" id="homeLanguage" name="homeLanguage">
                </div>
                <div class="col">
                    <label for="preferredLanguage">Preferred Language of Learner:</label>
                    <input type="text" id="preferredLanguage" name="preferredLanguage">
                </div>
            </div>
            <label>Preferred Language of Instruction:</label>
            <input type="text" id="instructionLanguage" name="instructionLanguage" value="English" readonly>
        </div>

        <!-- Previous School Information -->
        <div class="section">
            <h2>Previous School Information</h2>
            <label for="previousSchoolName">Name of Previous School:</label>
            <input type="text" id="previousSchoolName" name="previousSchoolName">
            <label for="previousSchoolAddress">Previous School Address:</label>
            <textarea id="previousSchoolAddress" name="previousSchoolAddress" rows="2"></textarea>
            <div class="row">
                <div class="col">
                    <label for="previousProvince">Province:</label>
                    <input type="text" id="previousProvince" name="previousProvince">
                </div>
                <div class="col">
                    <label for="previousCountry">Country:</label>
                    <input type="text" id="previousCountry" name="previousCountry">
                </div>
            </div>
        </div>

        <!-- Parent/Guardian Information -->
        <div class="section">
            <h2>Parent/Guardian Information</h2>
            <h3>Parent 1</h3>
            <div class="row">
                <div class="col">
                    <label for="parent1Title">Title:</label>
                    <input type="text" id="parent1Title" name="parent1Title">
                </div>
                <div class="col">
                    <label for="parent1Surname">Surname:</label>
                    <input type="text" id="parent1Surname" name="parent1Surname">
                </div>
            </div>
            <label for="parent1FirstName">First Name:</label>
            <input type="text" id="parent1FirstName" name="parent1FirstName">
            <label for="parent1IdNumber">ID Number:</label>
            <input type="text" id="parent1IdNumber" name="parent1IdNumber">
            <div class="row">
                <div class="col">
                    <label for="parent1Cell">Cell Number:</label>
                    <input type="tel" id="parent1Cell" name="parent1Cell">
                </div>
                <div class="col">
                    <label for="parent1Email">E-Mail Address:</label>
                    <input type="email" id="parent1Email" name="parent1Email">
                </div>
            </div>
        </div>

        <!-- School Fee Policy -->
        <div class="section">
            <h2>School Fee Policy 2025</h2>
            <table>
                <thead>
                    <tr><th>Description</th><th>Registration</th><th>Monthly Fees</th><th>Total per 12 Months</th></tr>
                </thead>
                <tbody>
                    <tr><td>Registration for New Learners</td><td>R900.00</td><td>-</td><td>R900.00</td></tr>
                    <tr><td>School fees for Grade R</td><td>-</td><td>R800.00</td><td>R9,600.00</td></tr>
                    <tr><td>School Fees for Foundation Phase Grade 1-3</td><td>-</td><td>R1,320.00</td><td>R15,840.00</td></tr>
                    <tr><td>School Fees for Primary Grade 4-6</td><td>-</td><td>R1,460.00</td><td>R17,520.00</td></tr>
                    <tr><td>School Fees for High School Grade 7-9</td><td>-</td><td>R1,540.00</td><td>R18,480.00</td></tr>
                    <tr><td>School Fees for FET Grade 10-12</td><td>-</td><td>R1,680.00</td><td>R20,160.00</td></tr>
                </tbody>
            </table>
            <div class="agreement">
                <p><strong>I, the parent/guardian, have read and understood the above School Fee Policy and agree with the terms outlined in the policy.</strong></p>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="agreeFeePolicy" name="agreeFeePolicy" required> I Agree</label>
                </div>
                <label for="parentSignature">Signature Parent/Guardian:</label>
                <input type="text" id="parentSignature" name="parentSignature" placeholder="Type your name as signature">
                <label for="dateSign">Date:</label>
                <input type="date" id="dateSign" name="dateSign">
            </div>
        </div>

        <button type="submit" class="no-print">Submit Application</button>
        <button type="button" onclick="window.print()" class="no-print" style="background: #28a745; margin-left: 10px;">Print Form</button>
    </form>

    <scr` + `ipt>
        document.getElementById('enrollmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!document.getElementById('agreeFeePolicy').checked) {
                alert('You must agree to the School Fee Policy.');
                return;
            }
            
            // Extract form data
            const formData = {
                gradeApplied: document.getElementById('gradeApplied').value,
                surname: document.getElementById('surname').value,
                initials: document.getElementById('initials').value,
                nickName: document.getElementById('nickName').value,
                dob: document.getElementById('dob').value,
                race: document.getElementById('race').value,
                gender: document.querySelector('input[name="gender"]:checked')?.value || '',
                idNumber: document.getElementById('idNumber').value,
                citizenship: document.getElementById('citizenship').value,
                physicalAddress: document.getElementById('physicalAddress').value,
                homeTel: document.getElementById('homeTel').value,
                emergencyTel: document.getElementById('emergencyTel').value,
                learnerEmail: document.getElementById('learnerEmail').value,
                learnerCell: document.getElementById('learnerCell').value,
                homeLanguage: document.getElementById('homeLanguage').value,
                preferredLanguage: document.getElementById('preferredLanguage').value,
                previousSchoolName: document.getElementById('previousSchoolName').value,
                previousSchoolAddress: document.getElementById('previousSchoolAddress').value,
                parent1Title: document.getElementById('parent1Title').value,
                parent1Surname: document.getElementById('parent1Surname').value,
                parent1FirstName: document.getElementById('parent1FirstName').value,
                parent1IdNumber: document.getElementById('parent1IdNumber').value,
                parent1Cell: document.getElementById('parent1Cell').value,
                parent1Email: document.getElementById('parent1Email').value,
                parentSignature: document.getElementById('parentSignature').value,
                dateSign: document.getElementById('dateSign').value
            };
            
            // Save application to admission system
            try {
                // Generate unique ID and reference number once
                const applicationId = Date.now();
                const accessionNumber = 'ONLINE-' + applicationId;
                
                // Get existing admissions from localStorage (if in main window)
                if (window.opener && window.opener.admissions) {
                    const admission = {
                        id: applicationId,
                        name: formData.surname + ' ' + (formData.nickName || formData.initials),
                        surname: formData.surname,
                        firstName: formData.nickName || formData.initials,
                        accession: accessionNumber,
                        grade: formData.gradeApplied,
                        classValue: '',
                        cell: formData.learnerCell,
                        email: formData.learnerEmail,
                        username: '',
                        password: '',
                        status: 'pending',
                        gender: formData.gender,
                        homeLanguage: formData.homeLanguage,
                        fatherName: formData.parent1FirstName,
                        fatherSurname: formData.parent1Surname,
                        fatherEmail: formData.parent1Email,
                        fatherCell: formData.parent1Cell,
                        motherName: '',
                        motherSurname: '',
                        motherEmail: '',
                        motherCell: '',
                        applicationDate: new Date().toISOString(),
                        applicationSource: 'Online Application Form',
                        idNumber: formData.idNumber,
                        dob: formData.dob,
                        previousSchool: formData.previousSchoolName,
                        saSamsFormat: true
                    };
                    
                    // Add to admissions
                    window.opener.admissions.push(admission);
                    window.opener.saveData();
                    window.opener.renderAdmissions();
                    window.opener.addNotification(' New online application received: ' + admission.name + ' (Grade ' + admission.grade + ')', 'success');
                    window.opener.logAudit('Online Application Submitted', 'Application from ' + admission.name, 'Medium');
                    
                    // Show success with redirect option
                    alert('Application submitted successfully!\\n\\nThank you for applying to Bophelong Community Independent School.\\n\\nYour application has been sent directly to the admissions office.\\n\\nReference: ' + accessionNumber + '\\n\\nYou will be contacted soon.');
                    
                    // Close window after 2 seconds
                    setTimeout(() => {
                        if (confirm('Application submitted! Would you like to return to the main system?')) {
                            window.close();
                        }
                    }, 1000);
                } else {
                    // Store in localStorage for later sync
                    const onlineApplications = JSON.parse(localStorage.getItem('onlineApplications') || '[]');
                    onlineApplications.push({
                        ...formData,
                        applicationDate: new Date().toISOString(),
                        status: 'pending',
                        accession: accessionNumber,
                        id: applicationId
                    });
                    localStorage.setItem('onlineApplications', JSON.stringify(onlineApplications));
                    
                    alert('Application submitted successfully!\\n\\nThank you for applying to Bophelong Community Independent School.\\n\\nReference: ' + accessionNumber + '\\n\\nYour application will be reviewed and you will be contacted soon.');
                }
            } catch (err) {
                console.error('Error saving application:', err);
                alert('Application submitted successfully!\\n\\nThank you for applying to Bophelong Community Independent School.\\n\\nYou will be contacted soon.');
            }
        });
    </scr` + `ipt>
</body>
</html>`;
        }
        
        // ========================================
        // ONLINE APPLICATIONS MANAGEMENT
        // ========================================
        
        function loadOnlineApplications() {
            refreshApplicationsList();
        }
        
        function refreshApplicationsList() {
            // Load online applications from both admissions (with pending status) and onlineApplications in localStorage
            const pendingAdmissions = admissions.filter(a => a.status === 'pending' && a.applicationSource === 'Online Application Form');
            const onlineApps = JSON.parse(localStorage.getItem('onlineApplications') || '[]');
            
            const allApplications = [...pendingAdmissions, ...onlineApps];
            const container = document.getElementById('submittedApplicationsList');
            
            if (!container) return;
            
            if (allApplications.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No online applications submitted yet. Applications submitted via the online form will appear here.</p>';
                return;
            }
            
            container.innerHTML = allApplications.map(app => {
                const name = app.name || `${app.surname} ${app.nickName || app.initials || app.firstName || ''}`;
                const grade = app.grade || app.gradeApplied || 'N/A';
                const status = app.status || 'pending';
                const date = app.applicationDate ? new Date(app.applicationDate).toLocaleString() : 'Recently';
                const reference = app.accession || 'ONLINE-' + app.id;
                
                const statusBadge = status === 'approved' ? 'bg-success' : 
                                  status === 'rejected' ? 'bg-danger' : 
                                  'bg-warning';
                
                return `
                    <div class="file-item">
                        <div style="flex: 1;">
                            <h6><i class="fas fa-user-graduate me-2"></i>${name}</h6>
                            <p class="mb-1"><small><strong>Grade:</strong> ${grade} | <strong>Reference:</strong> ${reference}</small></p>
                            <p class="mb-0">
                                <span class="badge ${statusBadge}">${status.toUpperCase()}</span>
                                <span class="badge bg-info ms-1">${date}</span>
                            </p>
                        </div>
                        <div style="white-space: nowrap;">
                            ${status === 'pending' ? `
                                <button class="btn btn-sm btn-success me-1" onclick="approveApplication(${app.id})" title="Approve Application">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn btn-sm btn-danger me-1" onclick="rejectApplication(${app.id})" title="Reject Application">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-info" onclick="viewOnlineApplication(${app.id})" title="View Details">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function approveApplication(appId) {
            const onlineApps = JSON.parse(localStorage.getItem('onlineApplications') || '[]');
            let application = onlineApps.find(a => a.id === appId);
            let fromStorage = true;
            
            if (!application) {
                // Check in admissions
                application = admissions.find(a => a.id === appId);
                fromStorage = false;
            }
            
            if (!application) {
                addNotification('Application not found', 'error');
                return;
            }
            
            if (!confirm(`Approve application for ${application.name || application.surname}?`)) {
                return;
            }
            
            // If from localStorage, move to admissions
            if (fromStorage) {
                const admission = {
                    id: application.id,
                    name: `${application.surname} ${application.nickName || application.initials || ''}`,
                    surname: application.surname,
                    firstName: application.nickName || application.initials,
                    accession: application.accession || 'ONLINE-' + application.id,
                    grade: application.gradeApplied,
                    classValue: '',
                    cell: application.learnerCell,
                    email: application.learnerEmail,
                    username: '',
                    password: '',
                    status: 'approved',
                    gender: application.gender,
                    homeLanguage: application.homeLanguage,
                    fatherName: application.parent1FirstName,
                    fatherSurname: application.parent1Surname,
                    fatherEmail: application.parent1Email,
                    fatherCell: application.parent1Cell,
                    motherName: '',
                    motherSurname: '',
                    motherEmail: '',
                    motherCell: '',
                    applicationDate: application.applicationDate,
                    applicationSource: 'Online Application Form',
                    idNumber: application.idNumber,
                    dob: application.dob,
                    previousSchool: application.previousSchoolName,
                    saSamsFormat: true
                };
                
                admissions.push(admission);
                
                // Remove from onlineApplications
                const updatedApps = onlineApps.filter(a => a.id !== appId);
                localStorage.setItem('onlineApplications', JSON.stringify(updatedApps));
            } else {
                // Update status in admissions
                application.status = 'approved';
            }
            
            saveData();
            renderAdmissions();
            refreshApplicationsList();
            addNotification('Application approved successfully!', 'success');
            logAudit('Approve Application', `Approved online application: ${application.name || application.surname}`, 'Medium');
        }
        
        function approveAllApplications() {
            const onlineApps = JSON.parse(localStorage.getItem('onlineApplications') || '[]');
            const pendingAdmissions = admissions.filter(a => a.status === 'pending' && a.applicationSource === 'Online Application Form');
            
            const totalPending = onlineApps.length + pendingAdmissions.length;
            
            if (totalPending === 0) {
                addNotification('No pending applications to approve', 'info');
                return;
            }
            
            if (!confirm(`Approve all ${totalPending} pending applications?`)) {
                return;
            }
            
            // Approve all from localStorage
            onlineApps.forEach(app => {
                const admission = {
                    id: app.id,
                    name: `${app.surname} ${app.nickName || app.initials || ''}`,
                    surname: app.surname,
                    firstName: app.nickName || app.initials,
                    accession: app.accession || 'ONLINE-' + app.id,
                    grade: app.gradeApplied,
                    classValue: '',
                    cell: app.learnerCell,
                    email: app.learnerEmail,
                    username: '',
                    password: '',
                    status: 'approved',
                    gender: app.gender,
                    homeLanguage: app.homeLanguage,
                    fatherName: app.parent1FirstName,
                    fatherSurname: app.parent1Surname,
                    fatherEmail: app.parent1Email,
                    fatherCell: app.parent1Cell,
                    motherName: '',
                    motherSurname: '',
                    motherEmail: '',
                    motherCell: '',
                    applicationDate: app.applicationDate,
                    applicationSource: 'Online Application Form',
                    idNumber: app.idNumber,
                    dob: app.dob,
                    previousSchool: app.previousSchoolName,
                    saSamsFormat: true
                };
                admissions.push(admission);
            });
            
            // Approve all pending in admissions
            pendingAdmissions.forEach(app => {
                app.status = 'approved';
            });
            
            // Clear onlineApplications
            localStorage.setItem('onlineApplications', '[]');
            
            saveData();
            renderAdmissions();
            refreshApplicationsList();
            addNotification(`All ${totalPending} applications approved successfully!`, 'success');
            logAudit('Approve All Applications', `Approved ${totalPending} online applications`, 'High');
        }
        
        function rejectApplication(appId) {
            const onlineApps = JSON.parse(localStorage.getItem('onlineApplications') || '[]');
            let application = onlineApps.find(a => a.id === appId);
            let fromStorage = true;
            
            if (!application) {
                application = admissions.find(a => a.id === appId);
                fromStorage = false;
            }
            
            if (!application) {
                addNotification('Application not found', 'error');
                return;
            }
            
            const reason = prompt(`Reject application for ${application.name || application.surname}?\n\nPlease provide a reason (optional):`);
            if (reason === null) return; // User cancelled
            
            if (fromStorage) {
                application.status = 'rejected';
                application.rejectionReason = reason || 'No reason provided';
                localStorage.setItem('onlineApplications', JSON.stringify(onlineApps));
            } else {
                application.status = 'rejected';
                application.rejectionReason = reason || 'No reason provided';
                saveData();
            }
            
            refreshApplicationsList();
            addNotification('Application rejected', 'info');
            logAudit('Reject Application', `Rejected online application: ${application.name || application.surname}`, 'Medium');
        }
        
        function viewOnlineApplication(appId) {
            const onlineApps = JSON.parse(localStorage.getItem('onlineApplications') || '[]');
            let application = onlineApps.find(a => a.id === appId);
            
            if (!application) {
                application = admissions.find(a => a.id === appId);
            }
            
            if (!application) {
                addNotification('Application not found', 'error');
                return;
            }
            
            const details = `
Application Details:

Reference: ${application.accession || 'ONLINE-' + application.id}
Status: ${(application.status || 'pending').toUpperCase()}

LEARNER INFORMATION:
Name: ${application.name || application.surname + ' ' + (application.nickName || application.initials || application.firstName || '')}
Gender: ${application.gender || 'N/A'}
Date of Birth: ${application.dob || 'N/A'}
ID Number: ${application.idNumber || 'N/A'}
Grade Applied: ${application.grade || application.gradeApplied || 'N/A'}
Home Language: ${application.homeLanguage || 'N/A'}
Email: ${application.email || application.learnerEmail || 'N/A'}
Cell: ${application.cell || application.learnerCell || 'N/A'}

PARENT/GUARDIAN INFORMATION:
Father: ${application.fatherName || application.parent1FirstName || ''} ${application.fatherSurname || application.parent1Surname || 'N/A'}
Email: ${application.fatherEmail || application.parent1Email || 'N/A'}
Cell: ${application.fatherCell || application.parent1Cell || 'N/A'}

PREVIOUS SCHOOL:
${application.previousSchool || application.previousSchoolName || 'N/A'}

APPLICATION DATE:
${application.applicationDate ? new Date(application.applicationDate).toLocaleString() : 'Recently'}

${application.status === 'rejected' ? '\nREJECTION REASON:\n' + (application.rejectionReason || 'No reason provided') : ''}

            `;
            
            alert(details);
        }

        // Search debounces
        document.getElementById('admissionSearch').addEventListener('input', debounce(renderAdmissions, 300));
        document.getElementById('studentSearch').addEventListener('input', debounce(renderStudents, 300));
        document.getElementById('feeSearch').addEventListener('input', debounce(renderFees, 300));
        document.getElementById('contentSearch').addEventListener('input', debounce(renderContents, 300));
        document.getElementById('staffSearch').addEventListener('input', debounce(renderStaff, 300));
        document.getElementById('jobSearch').addEventListener('input', debounce(renderJobs, 300));

        // Initialize
        loadData();
        populateSelects();
        loadSavedTheme(); // Load saved theme on page load
        loadVirtualForms(); // Load virtual forms
        document.getElementById('payrollMonthFilter').value = new Date().toISOString().slice(0,7);
        if (document.getElementById('markAllPresentDate')) {
            document.getElementById('markAllPresentDate').value = new Date().toISOString().split('T')[0];
        }
        if (document.getElementById('calendarMonth')) {
            document.getElementById('calendarMonth').value = new Date().toISOString().slice(0,7);
        }
        if (document.getElementById('roCalendarMonth')) {
            document.getElementById('roCalendarMonth').value = new Date().toISOString().slice(0,7);
        }
        
        // Initialize online/offline status
        updateOnlineStatus();
        
        // Load chat data
        teacherChats = JSON.parse(localStorage.getItem('teacherChats') || '[]');
        adminMessages = JSON.parse(localStorage.getItem('adminMessages') || '[]');
        offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
        
        // Live messaging: Auto-refresh messages every 3 seconds when chat is active
        let messageRefreshInterval = null;
        
        function startLiveMessaging() {
            if (messageRefreshInterval) {
                clearInterval(messageRefreshInterval);
            }
            
            messageRefreshInterval = setInterval(function() {
                // Only refresh if we're in the media or teacher chat sections
                const currentSection = document.querySelector('.section:not(.d-none)');
                if (!currentSection) return;
                
                const sectionId = currentSection.id;
                
                // Refresh teacher chat if in teachers section
                if (sectionId === 'teachers' && selectedChatStudent) {
                    // Reload chat data from localStorage (simulating real-time updates)
                    teacherChats = JSON.parse(localStorage.getItem('teacherChats') || '[]');
                    loadChatMessages();
                    loadChatStudents(); // Refresh unread counts
                }
                
                // Refresh admin messages
                if (sectionId === 'teachers') {
                    adminMessages = JSON.parse(localStorage.getItem('adminMessages') || '[]');
                    loadAdminMessages();
                }
                
                // Refresh chat history
                if (sectionId === 'teachers') {
                    const chatHistoryTab = document.querySelector('#chat-history.active');
                    if (chatHistoryTab) {
                        loadChatHistory();
                    }
                }
            }, 3000); // Refresh every 3 seconds
        }
        
        // Start live messaging when document is ready
        startLiveMessaging();
        
        // Restart live messaging when switching sections
        const originalShowSection = showSection;
        showSection = function(section) {
            originalShowSection(section);
            startLiveMessaging();
        };
        
        // ========================================
        // REAL-TIME COMMUNICATION SYSTEM
        // Using BroadcastChannel API for instant cross-tab/window communication
        // ========================================
        
        // Initialize BroadcastChannel for real-time messaging
        let schoolBroadcastChannel = null;
        
        // Generate a unique session ID for this browser tab/window
        const broadcastSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        try {
            schoolBroadcastChannel = new BroadcastChannel('school-management-channel');
            console.log('BroadcastChannel initialized for real-time communication');
        } catch (e) {
            console.log('BroadcastChannel not supported:', e.message, '- using localStorage fallback');
        }
        
        // Broadcast types for different communication events
        const BROADCAST_TYPES = {
            LIVE_CHAT: 'live_chat_message',
            VOICE_NOTE: 'voice_note',
            VOICE_CALL: 'voice_call',
            VIDEO_CALL: 'video_call',
            ANNOUNCEMENT: 'announcement',
            ADMIN_MESSAGE: 'admin_message',
            TEACHER_CHAT: 'teacher_chat',
            PARENT_CHAT: 'parent_chat',
            CALL_INCOMING: 'call_incoming',
            CALL_ENDED: 'call_ended',
            // Enhanced real-time data synchronization types
            DATA_UPDATE: 'data_update',
            STUDENT_UPDATE: 'student_update',
            ATTENDANCE_UPDATE: 'attendance_update',
            FEE_UPDATE: 'fee_update',
            STAFF_UPDATE: 'staff_update',
            ADMISSION_UPDATE: 'admission_update',
            SETTINGS_UPDATE: 'settings_update',
            IMMEDIATE_SYNC: 'immediate_sync',
            // User management real-time sync
            USER_UPDATE: 'user_update'
        };
        
        // Broadcast a message to all tabs/windows
        function broadcastMessage(type, data) {
            const message = {
                type: type,
                data: data,
                timestamp: Date.now(),
                sessionId: broadcastSessionId,
                sender: currentUser ? currentUser.name : 'System',
                senderRole: currentUser ? currentUser.role : 'system'
            };
            
            // Use BroadcastChannel if available
            if (schoolBroadcastChannel) {
                schoolBroadcastChannel.postMessage(message);
            }
            
            // Also update localStorage for persistence and fallback
            let broadcasts = JSON.parse(localStorage.getItem('realtimeBroadcasts') || '[]');
            broadcasts.push(message);
            // Keep only last 100 broadcasts efficiently using slice
            if (broadcasts.length > 100) {
                broadcasts = broadcasts.slice(-100);
            }
            localStorage.setItem('realtimeBroadcasts', JSON.stringify(broadcasts));
            localStorage.setItem('lastBroadcast', JSON.stringify(message));
        }
        
        // Handle incoming broadcast messages
        function handleBroadcastMessage(message) {
            // Don't process our own messages using session ID (more reliable than name/timestamp)
            if (message.sessionId === broadcastSessionId) {
                return;
            }
            
            switch (message.type) {
                case BROADCAST_TYPES.LIVE_CHAT:
                    handleIncomingLiveChat(message);
                    break;
                case BROADCAST_TYPES.VOICE_NOTE:
                    handleIncomingVoiceNote(message);
                    break;
                case BROADCAST_TYPES.VOICE_CALL:
                case BROADCAST_TYPES.CALL_INCOMING:
                    handleIncomingVoiceCall(message);
                    break;
                case BROADCAST_TYPES.VIDEO_CALL:
                    handleIncomingVideoCall(message);
                    break;
                case BROADCAST_TYPES.ANNOUNCEMENT:
                    handleIncomingAnnouncement(message);
                    break;
                case BROADCAST_TYPES.ADMIN_MESSAGE:
                    handleIncomingAdminMessage(message);
                    break;
                case BROADCAST_TYPES.TEACHER_CHAT:
                    handleIncomingTeacherChat(message);
                    break;
                case BROADCAST_TYPES.CALL_ENDED:
                    handleCallEnded(message);
                    break;
                // Enhanced real-time data synchronization handlers
                case BROADCAST_TYPES.DATA_UPDATE:
                case BROADCAST_TYPES.IMMEDIATE_SYNC:
                    handleImmediateDataSync(message);
                    break;
                case BROADCAST_TYPES.STUDENT_UPDATE:
                    handleStudentDataSync(message);
                    break;
                case BROADCAST_TYPES.ATTENDANCE_UPDATE:
                    handleAttendanceDataSync(message);
                    break;
                case BROADCAST_TYPES.FEE_UPDATE:
                    handleFeeDataSync(message);
                    break;
                case BROADCAST_TYPES.STAFF_UPDATE:
                    handleStaffDataSync(message);
                    break;
                case BROADCAST_TYPES.ADMISSION_UPDATE:
                    handleAdmissionDataSync(message);
                    break;
                case BROADCAST_TYPES.SETTINGS_UPDATE:
                    handleSettingsDataSync(message);
                    break;
                case BROADCAST_TYPES.USER_UPDATE:
                    handleUserDataSync(message);
                    break;
            }
        }
        
        // Set up BroadcastChannel listener
        if (schoolBroadcastChannel) {
            schoolBroadcastChannel.onmessage = function(event) {
                handleBroadcastMessage(event.data);
            };
        }
        
        // Fallback: Listen for localStorage changes (for cross-tab sync without BroadcastChannel)
        window.addEventListener('storage', function(event) {
            if (event.key === 'lastBroadcast' && event.newValue) {
                try {
                    const message = JSON.parse(event.newValue);
                    handleBroadcastMessage(message);
                } catch (e) {
                    console.log('Error parsing broadcast message:', e.message, '- Raw value length:', event.newValue ? event.newValue.length : 0);
                }
            }
            
            // Direct localStorage change detection for immediate sync
            // This provides additional sync for cross-device scenarios
            if (event.key === 'users' && event.newValue) {
                try {
                    // Reload users immediately when they change
                    users = JSON.parse(event.newValue);
                    console.log('Users synced via localStorage change detection');
                    
                    // Re-render if viewing settings section
                    const currentSection = document.querySelector('.section:not(.d-none)');
                    if (currentSection && currentSection.id === 'settings') {
                        if (typeof renderUsersList === 'function') {
                            renderUsersList();
                        }
                    }
                } catch (e) {
                    console.log('Error syncing users:', e.message);
                }
            }
            
            if (event.key === 'announcements' && event.newValue) {
                try {
                    // Reload announcements immediately when they change
                    announcements = JSON.parse(event.newValue);
                    console.log('Announcements synced via localStorage change detection');
                    
                    // Re-render announcement lists
                    if (typeof renderAnnouncementsList === 'function') {
                        renderAnnouncementsList();
                    }
                    
                    // Re-render dashboard if viewing it
                    const currentSection = document.querySelector('.section:not(.d-none)');
                    if (currentSection && currentSection.id === 'dashboard') {
                        if (typeof renderDashboard === 'function') {
                            renderDashboard();
                        }
                    }
                } catch (e) {
                    console.log('Error syncing announcements:', e.message);
                }
            }
        });
        
        // ========================================
        // INCOMING MESSAGE HANDLERS
        // ========================================
        
        function handleIncomingLiveChat(message) {
            // Reload live chat messages from localStorage
            liveChatMessages = JSON.parse(localStorage.getItem('liveChatMessages') || '[]');
            
            // Re-render if live chat is visible
            const liveChatContainer = document.getElementById('liveChatContainer');
            if (liveChatContainer && !liveChatContainer.classList.contains('d-none')) {
                renderLiveChatMessages();
                
                // Scroll to bottom
                const messagesContainer = document.getElementById('liveChatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }
            
            // Show notification for new message
            showRealtimeNotification(
                'New Live Chat Message',
                `${message.sender}: ${message.data.text || 'New message received'}`,
                'chat'
            );
        }
        
        function handleIncomingVoiceNote(message) {
            // Reload chats from localStorage
            liveChatMessages = JSON.parse(localStorage.getItem('liveChatMessages') || '[]');
            teacherChats = JSON.parse(localStorage.getItem('teacherChats') || '[]');
            
            // Re-render appropriate chat section
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection) {
                if (currentSection.id === 'media') {
                    renderLiveChatMessages();
                } else if (currentSection.id === 'teachers') {
                    loadChatMessages();
                }
            }
            
            // Show notification
            showRealtimeNotification(
                'New Voice Note',
                `${message.sender} sent a voice note`,
                'voice'
            );
        }
        
        function handleIncomingVoiceCall(message) {
            // Show incoming call modal
            showIncomingCallModal(message.data, 'voice');
            
            // Play ringtone if available
            playCallRingtone();
            
            // Show notification
            showRealtimeNotification(
                'Incoming Voice Call',
                `${message.sender} is calling...`,
                'call'
            );
        }
        
        function handleIncomingVideoCall(message) {
            // Show incoming call modal
            showIncomingCallModal(message.data, 'video');
            
            // Play ringtone
            playCallRingtone();
            
            // Show notification
            showRealtimeNotification(
                'Incoming Video Call',
                `${message.sender} wants to video call...`,
                'video'
            );
        }
        
        function handleIncomingAnnouncement(message) {
            // Reload announcements
            announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            
            // Update any visible announcement lists
            if (typeof renderAnnouncementsList === 'function') {
                renderAnnouncementsList();
            }
            
            // Also refresh dashboard if currently viewing it (announcements may appear there)
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection && currentSection.id === 'dashboard') {
                if (typeof renderDashboard === 'function') {
                    renderDashboard();
                }
            }
            
            // Show prominent notification for announcements
            showRealtimeNotification(
                ` New Announcement: ${message.data.title || 'Important Notice'}`,
                message.data.content || 'Check the announcements section for details',
                'announcement',
                true // Priority notification
            );
            
            // Also show as a system alert for priority announcements
            if (message.data.priority === 'Urgent' || message.data.priority === 'High') {
                addNotification(` URGENT: ${message.data.title}`, 'warning');
            }
        }
        
        function handleIncomingAdminMessage(message) {
            // Reload admin messages
            adminMessages = JSON.parse(localStorage.getItem('adminMessages') || '[]');
            
            // Re-render admin messages if in teachers section
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection && currentSection.id === 'teachers') {
                loadAdminMessages();
            }
            
            // Show notification
            showRealtimeNotification(
                'Admin Message Received',
                `${message.sender}: ${message.data.message || 'New admin message'}`,
                'admin'
            );
        }
        
        function handleIncomingTeacherChat(message) {
            // Reload teacher chats
            teacherChats = JSON.parse(localStorage.getItem('teacherChats') || '[]');
            
            // Re-render if in teachers section
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection && currentSection.id === 'teachers') {
                loadChatMessages();
                loadChatStudents();
            }
            
            // Show notification
            showRealtimeNotification(
                'New Message',
                `${message.sender}: ${message.data.message || 'New message received'}`,
                'chat'
            );
        }
        
        function handleCallEnded(message) {
            // Hide any incoming call modals
            hideIncomingCallModal();
            
            // Stop ringtone
            stopCallRingtone();
            
            // Show notification
            addNotification(`Call ended with ${message.sender}`, 'info');
        }
        
        // ========================================
        // REAL-TIME DATA SYNCHRONIZATION HANDLERS
        // Ensures all devices stay in sync immediately
        // ========================================
        
        function handleImmediateDataSync(message) {
            // Immediately reload all data from localStorage
            loadData();
            
            // Re-render the current section
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection) {
                refreshCurrentSection(currentSection.id);
            }
            
            // Show sync notification with real-time indicator
            showRealtimeNotification(
                ' Data Synced',
                `${message.sender} made changes - your view is now updated`,
                'sync'
            );
            
            // Log sync activity
            console.log('Real-time sync completed from:', message.sender, 'at', new Date(message.timestamp).toLocaleTimeString());
        }
        
        function handleStudentDataSync(message) {
            // Reload students data
            students = JSON.parse(localStorage.getItem('students') || '[]');
            
            // Re-render if viewing students section
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection && currentSection.id === 'students') {
                renderStudents();
            }
            
            // Update dashboard counts if visible
            if (currentSection && currentSection.id === 'dashboard') {
                renderDashboard();
            }
            
            showRealtimeNotification(
                ' Student Data Updated',
                `${message.sender} updated student records`,
                'sync'
            );
        }
        
        function handleAttendanceDataSync(message) {
            // Reload attendance data
            attendance = JSON.parse(localStorage.getItem('attendance') || '[]');
            
            // Re-render if viewing attendance section
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection && currentSection.id === 'attendance') {
                renderAttendance();
            }
            
            showRealtimeNotification(
                ' Attendance Updated',
                `${message.sender} updated attendance records`,
                'sync'
            );
        }
        
        function handleFeeDataSync(message) {
            // Reload fees data
            fees = JSON.parse(localStorage.getItem('fees') || '[]');
            
            // Re-render if viewing fees section
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection && currentSection.id === 'fees') {
                renderFees();
            }
            
            showRealtimeNotification(
                ' Finance Updated',
                `${message.sender} updated fee records`,
                'sync'
            );
        }
        
        function handleStaffDataSync(message) {
            // Reload staff data
            staff = JSON.parse(localStorage.getItem('staff') || '[]');
            
            // Re-render if viewing HR section
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection && currentSection.id === 'hr') {
                renderStaff();
            }
            
            showRealtimeNotification(
                ' Staff Data Updated',
                `${message.sender} updated staff records`,
                'sync'
            );
        }
        
        function handleAdmissionDataSync(message) {
            // Reload admissions data
            admissions = JSON.parse(localStorage.getItem('admissions') || '[]');
            
            // Re-render if viewing admission section
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection && currentSection.id === 'admission') {
                renderAdmissions();
            }
            
            showRealtimeNotification(
                ' Admission Updated',
                `${message.sender} updated admission records`,
                'sync'
            );
        }
        
        function handleSettingsDataSync(message) {
            // Settings have been updated, reload theme and preferences
            loadSavedTheme();
            
            showRealtimeNotification(
                ' Settings Updated',
                `${message.sender} updated system settings`,
                'sync'
            );
        }
        
        function handleUserDataSync(message) {
            // Reload users data from localStorage - this is critical for login sync
            users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Re-render if viewing settings section with user management
            const currentSection = document.querySelector('.section:not(.d-none)');
            if (currentSection && currentSection.id === 'settings') {
                if (typeof renderUsersList === 'function') {
                    renderUsersList();
                }
                if (typeof updateUserStatistics === 'function') {
                    updateUserStatistics();
                }
            }
            
            // Show notification with action-specific message
            const details = message.data?.details || {};
            const action = details.action || 'updated';
            const userName = details.userName || '';
            const userRole = details.userRole || '';
            
            let notificationTitle = ' User Data Updated';
            let notificationMessage = `${message.sender} updated user accounts`;
            
            if (action === 'create') {
                notificationTitle = ' New User Created';
                notificationMessage = `${userRole} account "${userName}" is now active and can log in`;
            } else if (action === 'delete') {
                notificationTitle = ' User Removed';
                notificationMessage = `User "${userName}" has been removed from the system`;
            } else if (action === 'update') {
                notificationTitle = ' User Updated';
                notificationMessage = `User "${userName}" credentials have been updated`;
            }
            
            showRealtimeNotification(
                notificationTitle,
                notificationMessage,
                'sync'
            );
            
            console.log('User data synchronized in real-time:', action, userName || '(all users)');
        }
        
        // Helper function to refresh the current section
        function refreshCurrentSection(sectionId) {
            switch(sectionId) {
                case 'dashboard':
                    if (typeof renderDashboard === 'function') renderDashboard();
                    break;
                case 'students':
                    if (typeof renderStudents === 'function') renderStudents();
                    break;
                case 'admission':
                    if (typeof renderAdmissions === 'function') renderAdmissions();
                    break;
                case 'fees':
                    if (typeof renderFees === 'function') renderFees();
                    break;
                case 'attendance':
                    if (typeof renderAttendance === 'function') renderAttendance();
                    break;
                case 'teachers':
                    if (typeof loadChatMessages === 'function') loadChatMessages();
                    if (typeof loadChatStudents === 'function') loadChatStudents();
                    break;
                case 'parentPortal':
                    if (typeof loadParentPortal === 'function') loadParentPortal();
                    break;
                case 'hr':
                    if (typeof renderStaff === 'function') renderStaff();
                    break;
                case 'media':
                    if (typeof renderLiveChatMessages === 'function') renderLiveChatMessages();
                    break;
                case 'hodDashboard':
                    if (typeof loadHODDashboard === 'function') loadHODDashboard();
                    break;
                case 'teacherMonitoring':
                    if (typeof loadTeacherMonitoring === 'function') loadTeacherMonitoring();
                    break;
                case 'settings':
                    if (typeof renderUsersList === 'function') renderUsersList();
                    if (typeof updateUserStatistics === 'function') updateUserStatistics();
                    break;
            }
        }
        
        // Function to broadcast data updates to all devices
        // Valid updateType values: 'STUDENT_UPDATE', 'ATTENDANCE_UPDATE', 'FEE_UPDATE', 'STAFF_UPDATE', 'ADMISSION_UPDATE', 'SETTINGS_UPDATE', 'DATA_UPDATE', 'IMMEDIATE_SYNC', 'USER_UPDATE'
        function broadcastDataUpdate(updateType, details) {
            // Validate updateType is a known broadcast type
            const validTypes = ['STUDENT_UPDATE', 'ATTENDANCE_UPDATE', 'FEE_UPDATE', 'STAFF_UPDATE', 'ADMISSION_UPDATE', 'SETTINGS_UPDATE', 'DATA_UPDATE', 'IMMEDIATE_SYNC', 'USER_UPDATE'];
            if (!validTypes.includes(updateType)) {
                console.warn('broadcastDataUpdate: Unknown updateType "' + updateType + '", using DATA_UPDATE');
                updateType = 'DATA_UPDATE';
            }
            
            const type = BROADCAST_TYPES[updateType] || BROADCAST_TYPES.DATA_UPDATE;
            broadcastMessage(type, {
                updateType: updateType,
                details: details,
                timestamp: Date.now()
            });
        }
        
        // ========================================
        // REAL-TIME NOTIFICATION SYSTEM
        // ========================================
        
        // Create floating notification container
        function createNotificationContainer() {
            let container = document.getElementById('realtimeNotifications');
            if (!container) {
                container = document.createElement('div');
                container.id = 'realtimeNotifications';
                container.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    z-index: 2000;
                    max-width: 350px;
                    width: 100%;
                    pointer-events: none;
                `;
                document.body.appendChild(container);
            }
            return container;
        }
        
        function showRealtimeNotification(title, message, type, priority = false) {
            const container = createNotificationContainer();
            
            // Determine icon and color based on type
            let icon, bgColor;
            switch (type) {
                case 'chat':
                    icon = 'fa-comments';
                    bgColor = 'linear-gradient(135deg, #0ea5e9, #38bdf8)';
                    break;
                case 'voice':
                    icon = 'fa-microphone';
                    bgColor = 'linear-gradient(135deg, #8b5cf6, #a78bfa)';
                    break;
                case 'call':
                    icon = 'fa-phone';
                    bgColor = 'linear-gradient(135deg, #10b981, #34d399)';
                    break;
                case 'video':
                    icon = 'fa-video';
                    bgColor = 'linear-gradient(135deg, #f59e0b, #fbbf24)';
                    break;
                case 'announcement':
                    icon = 'fa-bullhorn';
                    bgColor = 'linear-gradient(135deg, #e94560, #ff6b6b)';
                    break;
                case 'admin':
                    icon = 'fa-user-shield';
                    bgColor = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
                    break;
                case 'sync':
                    icon = 'fa-sync-alt';
                    bgColor = 'linear-gradient(135deg, #10b981, #059669)';
                    break;
                default:
                    icon = 'fa-bell';
                    bgColor = 'linear-gradient(135deg, #667eea, #764ba2)';
            }
            
            const notification = document.createElement('div');
            notification.className = 'realtime-notification';
            notification.style.cssText = `
                background: ${bgColor};
                border-radius: 12px;
                padding: 15px 20px;
                margin-bottom: 10px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                color: #fff;
                pointer-events: auto;
                cursor: pointer;
                transform: translateX(120%);
                transition: transform 0.3s ease-out, opacity 0.3s ease-out;
                opacity: 0;
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <strong style="font-size: 0.95rem; display: block; margin-bottom: 4px;">${title}</strong>
                        <p style="margin: 0; font-size: 0.85rem; opacity: 0.9; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${message}</p>
                        <small style="opacity: 0.7; font-size: 0.75rem;">${new Date().toLocaleTimeString()}</small>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: #fff; opacity: 0.7; cursor: pointer; padding: 0; font-size: 1rem;">&times;</button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 50);
            
            // Auto remove after 5 seconds (8 for priority)
            const duration = priority ? 8000 : 5000;
            setTimeout(() => {
                notification.style.transform = 'translateX(120%)';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, duration);
            
            // Click to dismiss
            notification.addEventListener('click', function() {
                notification.style.transform = 'translateX(120%)';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            });
            
            // Play notification sound
            playNotificationSound();
        }
        
        // ========================================
        // INCOMING CALL MODAL
        // ========================================
        
        let incomingCallRingtone = null;
        
        function showIncomingCallModal(callData, callType) {
            // Hide any existing modal
            hideIncomingCallModal();
            
            const modal = document.createElement('div');
            modal.id = 'incomingCallModal';
            modal.className = 'incoming-call-modal show';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
                border-radius: 20px;
                padding: 40px;
                z-index: 2500;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
                text-align: center;
                min-width: 300px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                animation: callPulse 0.5s ease;
            `;
            
            const icon = callType === 'video' ? 'fa-video' : 'fa-phone';
            const callTypeText = callType === 'video' ? 'Video Call' : 'Voice Call';
            
            modal.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div class="recording-indicator" style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #34d399); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas ${icon}" style="font-size: 2rem; color: #fff;"></i>
                    </div>
                    <h4 style="color: #fff; margin-bottom: 5px;">Incoming ${callTypeText}</h4>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">${callData.caller || 'Unknown'} is calling...</p>
                </div>
                <div style="display: flex; justify-content: center; gap: 20px;">
                    <button onclick="acceptIncomingCall('${callType}', '${callData.callId || ''}')" style="background: linear-gradient(135deg, #10b981, #34d399); border: none; border-radius: 50%; width: 60px; height: 60px; color: #fff; cursor: pointer; transition: transform 0.3s;">
                        <i class="fas fa-phone" style="font-size: 1.5rem;"></i>
                    </button>
                    <button onclick="rejectIncomingCall('${callData.callId || ''}')" style="background: linear-gradient(135deg, #ef4444, #f87171); border: none; border-radius: 50%; width: 60px; height: 60px; color: #fff; cursor: pointer; transition: transform 0.3s;">
                        <i class="fas fa-phone-slash" style="font-size: 1.5rem;"></i>
                    </button>
                </div>
            `;
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.id = 'incomingCallBackdrop';
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 2400;
            `;
            
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        }
        
        function hideIncomingCallModal() {
            const modal = document.getElementById('incomingCallModal');
            const backdrop = document.getElementById('incomingCallBackdrop');
            if (modal) modal.remove();
            if (backdrop) backdrop.remove();
            stopCallRingtone();
        }
        
        function acceptIncomingCall(callType, callId) {
            hideIncomingCallModal();
            
            // Show appropriate call interface based on call type
            if (callType === 'video') {
                // Navigate to video call section or show video call UI
                const videoContainer = document.getElementById('videoChatContainer') || 
                                      document.getElementById('parentVideoChatContainer');
                if (videoContainer) {
                    videoContainer.classList.add('active');
                }
                addNotification('Video call connected!', 'success');
            } else {
                // Show voice call UI
                const voiceControls = document.getElementById('voiceCallControls') ||
                                     document.getElementById('teacherVoiceCallControls') ||
                                     document.getElementById('parentVoiceCallControls');
                if (voiceControls) {
                    voiceControls.style.display = 'block';
                }
                addNotification('Voice call connected!', 'success');
            }
            
            // Broadcast acceptance
            broadcastMessage(BROADCAST_TYPES.CALL_INCOMING, {
                action: 'accepted',
                callId: callId,
                callType: callType
            });
        }
        
        function rejectIncomingCall(callId) {
            hideIncomingCallModal();
            addNotification('Call rejected', 'info');
            
            // Broadcast rejection
            broadcastMessage(BROADCAST_TYPES.CALL_ENDED, {
                action: 'rejected',
                callId: callId
            });
        }
        
        // ========================================
        // AUDIO NOTIFICATION SOUNDS
        // ========================================
        
        // Shared AudioContext instance for better performance
        let sharedAudioContext = null;
        
        function getAudioContext() {
            if (!sharedAudioContext) {
                try {
                    sharedAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('AudioContext not available:', e.message);
                }
            }
            return sharedAudioContext;
        }
        
        function playNotificationSound() {
            try {
                const audioContext = getAudioContext();
                if (!audioContext) return;
                
                // Resume context if suspended (required by some browsers)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 880;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Could not play notification sound:', e.message);
            }
        }
        
        function playCallRingtone() {
            try {
                stopCallRingtone(); // Stop any existing ringtone
                
                const audioContext = getAudioContext();
                if (!audioContext) return;
                
                // Resume context if suspended
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                function playRingTone() {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 440;
                    oscillator.type = 'sine';
                    gainNode.gain.value = 0.15;
                    
                    oscillator.start();
                    
                    // Ring pattern: on for 0.5s, off for 0.5s
                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime + 0.5);
                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime + 1);
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime + 1.5);
                    
                    oscillator.stop(audioContext.currentTime + 2);
                }
                
                playRingTone();
                incomingCallRingtone = setInterval(playRingTone, 2000);
            } catch (e) {
                console.log('Could not play ringtone:', e.message);
            }
        }
        
        function stopCallRingtone() {
            if (incomingCallRingtone) {
                clearInterval(incomingCallRingtone);
                incomingCallRingtone = null;
            }
        }
        
        // ========================================
        // ENHANCED SEND FUNCTIONS WITH BROADCASTING
        // ========================================
        
        const originalSendLiveChatMessage = typeof sendLiveChatMessage !== 'undefined' ? sendLiveChatMessage : null;
        sendLiveChatMessage = function() {
            const input = document.getElementById('liveChatInput');
            const text = input.value.trim();
            
            if (!text) {
                addNotification('Please enter a message', 'warning');
                return;
            }
            
            const message = {
                id: Date.now(),
                sender: currentUser.name,
                role: currentUser.role,
                text: text,
                timestamp: new Date().toISOString()
            };
            
            liveChatMessages.push(message);
            localStorage.setItem('liveChatMessages', JSON.stringify(liveChatMessages));
            
            
            
            // Broadcast to all tabs/windows on this device
            broadcastMessage(BROADCAST_TYPES.LIVE_CHAT, {
                text: text,
                messageId: message.id
            });
            
            input.value = '';
            renderLiveChatMessages();
            
            // Scroll to bottom
            const container = document.getElementById('liveChatMessages');
            if (container) container.scrollTop = container.scrollHeight;
            
            addNotification('Message sent to all users!', 'success');
        };
        
        const originalCreateAnnouncement = typeof createAnnouncement !== 'undefined' ? createAnnouncement : null;
        createAnnouncement = function() {
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            const priority = document.getElementById('announcementPriority').value;
            const audience = document.getElementById('announcementAudience').value;
            
            if (!title || !content) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const announcement = {
                id: Date.now(),
                title: title,
                content: content,
                priority: priority,
                audience: audience,
                timestamp: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            announcements.push(announcement);
            localStorage.setItem('announcements', JSON.stringify(announcements));
            
            
            
            // Broadcast announcement to all users immediately on this device
            broadcastMessage(BROADCAST_TYPES.ANNOUNCEMENT, {
                title: title,
                content: content,
                priority: priority,
                audience: audience,
                announcementId: announcement.id
            });
            
            // Clear form
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
            document.getElementById('announcementPriority').value = 'Medium';
            document.getElementById('announcementAudience').value = 'All';
            
            renderAnnouncementsList();
            addNotification('Announcement published and broadcast to all users!', 'success');
        };
        
        // Function to broadcast voice notes after recording
        function broadcastVoiceNote(voiceNoteData, targetChat) {
            broadcastMessage(BROADCAST_TYPES.VOICE_NOTE, {
                audioUrl: voiceNoteData.audioUrl,
                duration: voiceNoteData.duration,
                targetChat: targetChat
            });
        }
        
        // Function to broadcast voice call initiation - Enhanced to ring on all devices
        function broadcastVoiceCallStart(callData) {
            const callInfo = {
                callId: callData.callId || Date.now(),
                caller: currentUser.name,
                callerRole: currentUser.role,
                participants: callData.participants || [],
                callType: 'voice',
                context: callData.context || 'general',
                timestamp: Date.now()
            };
            
            // Broadcast as incoming call to trigger ringtone on all devices
            broadcastMessage(BROADCAST_TYPES.CALL_INCOMING, callInfo);
            broadcastMessage(BROADCAST_TYPES.VOICE_CALL, callInfo);
            
            // Also store in localStorage for devices that may not have BroadcastChannel
            localStorage.setItem('activeCall', JSON.stringify(callInfo));
            localStorage.setItem('incomingCall', JSON.stringify(callInfo));
            
            console.log('Voice call broadcast to all devices:', callInfo.caller);
        }
        
        // Function to broadcast video call initiation - Enhanced to ring on all devices
        function broadcastVideoCallStart(callData) {
            const callInfo = {
                callId: callData.callId || Date.now(),
                caller: currentUser.name,
                callerRole: currentUser.role,
                participants: callData.participants || [],
                callType: 'video',
                context: callData.context || 'general',
                timestamp: Date.now()
            };
            
            // Broadcast as incoming call to trigger ringtone on all devices
            broadcastMessage(BROADCAST_TYPES.CALL_INCOMING, callInfo);
            broadcastMessage(BROADCAST_TYPES.VIDEO_CALL, callInfo);
            
            // Also store in localStorage for devices that may not have BroadcastChannel
            localStorage.setItem('activeCall', JSON.stringify(callInfo));
            localStorage.setItem('incomingCall', JSON.stringify(callInfo));
            
            console.log('Video call broadcast to all devices:', callInfo.caller);
        }
        
        // Function to broadcast call end
        function broadcastCallEnd(callId) {
            broadcastMessage(BROADCAST_TYPES.CALL_ENDED, {
                callId: callId,
                endedBy: currentUser.name,
                timestamp: Date.now()
            });
            
            // Clear active call from localStorage
            localStorage.removeItem('activeCall');
            localStorage.removeItem('incomingCall');
        }
        
        // Function to broadcast admin messages
        function broadcastAdminMessage(messageData) {
            broadcastMessage(BROADCAST_TYPES.ADMIN_MESSAGE, {
                message: messageData.message,
                priority: messageData.priority || 'normal',
                messageId: messageData.id
            });
        }
        
        // Function to broadcast teacher chat messages
        function broadcastTeacherChat(chatData) {
            broadcastMessage(BROADCAST_TYPES.TEACHER_CHAT, {
                message: chatData.message,
                studentId: chatData.studentId,
                chatId: chatData.id
            });
        }
        
        // Listen for incoming calls via localStorage (for cross-browser/device support)
        window.addEventListener('storage', function(event) {
            if (event.key === 'incomingCall' && event.newValue) {
                try {
                    const callInfo = JSON.parse(event.newValue);
                    // Don't show modal if we initiated the call - use safe null checks
                    const currentUserName = currentUser && currentUser.name ? currentUser.name : '';
                    const callerName = callInfo && callInfo.caller ? callInfo.caller : '';
                    
                    if (callerName && callerName !== currentUserName) {
                        showIncomingCallModal(callInfo, callInfo.callType || 'voice');
                        playCallRingtone();
                    }
                } catch (e) {
                    console.log('Error parsing incoming call:', e.message);
                }
            }
        });
        
        console.log('Real-time communication system initialized successfully!');
        
        // ========================================
        
        // Load and display call history
        function loadCallHistory() {
            const callHistory = JSON.parse(localStorage.getItem('callHistory') || '[]');
            const tableBody = document.getElementById('callHistoryTable');
            const emptyMessage = document.getElementById('callHistoryEmpty');
            
            if (!tableBody) return;
            
            if (callHistory.length === 0) {
                tableBody.innerHTML = '';
                if (emptyMessage) emptyMessage.style.display = 'block';
                return;
            }
            
            if (emptyMessage) emptyMessage.style.display = 'none';
            
            tableBody.innerHTML = callHistory.map(call => {
                const date = new Date(call.timestamp);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                // Determine contact name
                const contact = call.direction === 'outgoing' ? 
                    (call.recipient || 'Unknown') : 
                    (call.caller || 'Unknown');
                
                // Format duration
                const duration = call.duration ? 
                    `${Math.floor(call.duration / 60)}:${String(call.duration % 60).padStart(2, '0')}` : 
                    (call.status === 'connected' ? 'In progress' : '-');
                
                // Call type icon and color
                const typeIcon = call.callType === 'video' ? 
                    '<i class="fas fa-video text-warning"></i>' : 
                    '<i class="fas fa-phone text-success"></i>';
                
                // Direction icon
                const directionIcon = call.direction === 'outgoing' ? 
                    '<i class="fas fa-arrow-up text-info"></i> Outgoing' : 
                    '<i class="fas fa-arrow-down text-primary"></i> Incoming';
                
                // Status badge
                let statusBadge = '';
                switch(call.status) {
                    case 'connected':
                        statusBadge = '<span class="badge bg-success">Connected</span>';
                        break;
                    case 'ended':
                        statusBadge = call.answered ? 
                            '<span class="badge bg-info">Completed</span>' : 
                            '<span class="badge bg-danger">Missed</span>';
                        break;
                    case 'ringing':
                        statusBadge = '<span class="badge bg-warning">Ringing</span>';
                        break;
                    default:
                        statusBadge = '<span class="badge bg-secondary">' + call.status + '</span>';
                }
                
                // Action buttons
                const actions = `
                    <button class="btn btn-sm btn-success" onclick="callBack('${contact}', '${call.callType}')" title="Call back">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCallRecord('${call.callId}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                return `
                    <tr>
                        <td>${typeIcon} ${call.callType === 'video' ? 'Video' : 'Voice'}</td>
                        <td>${directionIcon}</td>
                        <td>${contact}</td>
                        <td>${statusBadge}</td>
                        <td>${duration}</td>
                        <td><small>${formattedDate}</small></td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Refresh call history
        function refreshCallHistory() {
            addNotification('Refreshing call history...', 'info');
            loadCallHistory();
            addNotification(' Call history refreshed', 'success');
        }
        
        // Call back from history
        function callBack(contact, callType) {
            closeCallHistory();
            if (callType === 'video') {
                startVideoCall(contact);
            } else {
                startVoiceCall(contact);
            }
        }
        
        // Delete call record
        function deleteCallRecord(callId) {
            if (!confirm('Delete this call record?')) return;
            
            let callHistory = JSON.parse(localStorage.getItem('callHistory') || '[]');
            callHistory = callHistory.filter(c => c.callId != callId);
            localStorage.setItem('callHistory', JSON.stringify(callHistory));
            
            loadCallHistory();
            addNotification('Call record deleted', 'info');
        }
        
        // Show FCM status
        function showFCMStatus() {
            const status = {
                
                token: fcmToken ? ' Registered' : ' Not registered',
                notifications: Notification.permission === 'granted' ? ' Allowed' : 
                              Notification.permission === 'denied' ? ' Blocked' : ' Not requested',
            };
            
            const message = `
 FCM Service: ${status.messaging}<br>
 FCM Token: ${status.token}<br>
 Browser Notifications: ${status.notifications}<br>
<br>
${fcmToken ? '<small>Token: ' + fcmToken.substring(0, 30) + '...</small>' : ''}
            `;
            
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">FCM Status</h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            ${message}
                        </div>
                        <div class="modal-footer">
                            ${Notification.permission !== 'granted' ? 
                                '<button class="btn btn-primary" onclick="'.modal\').remove();">Request Permission</button>' : ''}
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        console.log(' Enhanced real-time communication system loaded!');
        
        // ========================================
        // WEBRTC DIALER FUNCTIONS
        // Integrated dialer with socket.io signaling
        // ========================================
        
        // Dialer state
        let dialerNumber = '';
        let dialerSocket = null;
        let dialerPc = null;
        let dialerLocalStream = null;
        let dialerCallingTo = null;
        let dialerTimerInterval = null;
        let dialerSeconds = 0;
        
        // Initialize Socket.IO connection for dialer
        function initDialerSocket() {
            if (dialerSocket && dialerSocket.connected) return;
            
            const SIGNALING_SERVER = "https://webrtc-signal-server.up.railway.app";
            
            try {
                dialerSocket = io(SIGNALING_SERVER);
                
                dialerSocket.on('connect', () => {
                    console.log(' WebRTC Dialer connected to signaling server');
                });
                
                dialerSocket.on('offer', async data => {
                    // Sanitize the caller name to prevent XSS
                    const sanitizedCaller = String(data.from || 'Unknown').replace(/[<>'"]/g, '');
                    if (confirm(`Incoming call from ${sanitizedCaller}. Accept?`)) {
                        await dialerAnswerCall(data);
                    }
                });
                
                dialerSocket.on('answer', async data => {
                    if (dialerPc) {
                        await dialerPc.setRemoteDescription(new RTCSessionDescription(data.answer));
                        document.getElementById('dialerCallDuration').textContent = '00:00';
                    }
                });
                
                dialerSocket.on('candidate', async data => {
                    if (dialerPc && data.candidate) {
                        try {
                            await dialerPc.addIceCandidate(new RTCIceCandidate(data.candidate));
                        } catch(e) {
                            console.error('Error adding ICE candidate:', e);
                        }
                    }
                });
                
                dialerSocket.on('hangup', () => {
                    dialerHangUp();
                });
                
            } catch (error) {
                console.error('Failed to connect to signaling server:', error);
                addNotification('Failed to connect to signaling server', 'danger');
            }
        }
        
        // Open the dialer interface
        function openDialer() {
            const dialerContainer = document.getElementById('webrtcDialerContainer');
            const chatMessages = document.getElementById('liveChatMessages');
            
            if (dialerContainer) {
                dialerContainer.classList.remove('d-none');
                if (chatMessages) {
                    chatMessages.style.height = '200px';
                }
                
                // Initialize socket connection
                initDialerSocket();
                
                addNotification('WebRTC Dialer opened', 'info');
            }
        }
        
        // Close the dialer interface
        function closeDialer() {
            const dialerContainer = document.getElementById('webrtcDialerContainer');
            const chatMessages = document.getElementById('liveChatMessages');
            
            if (dialerContainer) {
                dialerContainer.classList.add('d-none');
                if (chatMessages) {
                    chatMessages.style.height = '400px';
                }
                dialerNumber = '';
                document.getElementById('dialerDisplay').textContent = '';
            }
        }
        
        // Add digit to dialer display
        function dialerAddDigit(digit) {
            dialerNumber += digit;
            document.getElementById('dialerDisplay').textContent = dialerNumber;
        }
        
        // Clear dialer display
        function dialerClear() {
            dialerNumber = '';
            document.getElementById('dialerDisplay').textContent = '';
        }
        
        // Create WebRTC peer connection
        function createDialerPeerConnection() {
            dialerPc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });
            
            if (dialerLocalStream) {
                dialerLocalStream.getTracks().forEach(track => {
                    dialerPc.addTrack(track, dialerLocalStream);
                });
            }
            
            dialerPc.ontrack = e => {
                const remoteVideo = document.getElementById('dialerRemoteVideo');
                if (remoteVideo) {
                    remoteVideo.srcObject = e.streams[0];
                    remoteVideo.style.display = 'block';
                }
            };
            
            dialerPc.onicecandidate = e => {
                if (e.candidate && dialerSocket) {
                    dialerSocket.emit('candidate', { 
                        to: dialerCallingTo || 'all', 
                        candidate: e.candidate 
                    });
                }
            };
        }
        
        // Make a call using the dialer
        async function dialerMakeCall() {
            if (!dialerNumber) {
                addNotification('Please enter a number or user ID', 'warning');
                return;
            }
            
            try {
                addNotification('Initiating call...', 'info');
                
                // Get local audio stream
                dialerLocalStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true, 
                    video: false 
                });
                
                createDialerPeerConnection();
                dialerCallingTo = dialerNumber;
                
                const offer = await dialerPc.createOffer();
                await dialerPc.setLocalDescription(offer);
                
                if (dialerSocket) {
                    dialerSocket.emit('offer', { to: dialerCallingTo, offer });
                }
                
                // Show active call screen
                document.getElementById('dialerScreen').classList.add('d-none');
                document.getElementById('activeDialerCall').classList.remove('d-none');
                document.getElementById('dialerCallerName').textContent = dialerNumber;
                document.getElementById('dialerCallDuration').textContent = 'Ringing...';
                
                dialerStartTimer();
                addNotification(' Calling ' + dialerNumber, 'info');
                
            } catch (error) {
                console.error('Error making call:', error);
                addNotification('Cannot start call: ' + error.message, 'danger');
            }
        }
        
        // Answer incoming call
        async function dialerAnswerCall(data) {
            try {
                dialerLocalStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true, 
                    video: false 
                });
                
                createDialerPeerConnection();
                dialerCallingTo = data.from;
                
                await dialerPc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await dialerPc.createAnswer();
                await dialerPc.setLocalDescription(answer);
                
                if (dialerSocket) {
                    dialerSocket.emit('answer', { to: data.from, answer });
                }
                
                // Show active call screen
                document.getElementById('dialerScreen').classList.add('d-none');
                document.getElementById('activeDialerCall').classList.remove('d-none');
                document.getElementById('dialerCallerName').textContent = data.from;
                document.getElementById('dialerCallDuration').textContent = '00:00';
                
                dialerStartTimer();
                
            } catch (error) {
                console.error('Error answering call:', error);
                addNotification('Cannot answer call: ' + error.message, 'danger');
            }
        }
        
        // Hang up the call
        function dialerHangUp() {
            if (dialerPc) {
                dialerPc.close();
                dialerPc = null;
            }
            
            if (dialerLocalStream) {
                dialerLocalStream.getTracks().forEach(t => t.stop());
                dialerLocalStream = null;
            }
            
            if (dialerSocket && dialerCallingTo) {
                dialerSocket.emit('hangup', { to: dialerCallingTo });
            }
            
            // Reset UI
            clearInterval(dialerTimerInterval);
            dialerSeconds = 0;
            document.getElementById('dialerScreen').classList.remove('d-none');
            document.getElementById('activeDialerCall').classList.add('d-none');
            dialerCallingTo = null;
            
            const remoteVideo = document.getElementById('dialerRemoteVideo');
            if (remoteVideo) {
                remoteVideo.srcObject = null;
                remoteVideo.style.display = 'none';
            }
            
            addNotification('Call ended', 'info');
        }
        
        // Toggle mute
        function dialerToggleMute() {
            if (!dialerLocalStream) return;
            
            const audioTrack = dialerLocalStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                const muteBtn = document.getElementById('dialerMuteBtn');
                const icon = muteBtn.querySelector('i');
                
                if (audioTrack.enabled) {
                    icon.className = 'fas fa-microphone';
                    muteBtn.classList.remove('btn-secondary');
                    muteBtn.classList.add('btn-warning');
                } else {
                    icon.className = 'fas fa-microphone-slash';
                    muteBtn.classList.remove('btn-warning');
                    muteBtn.classList.add('btn-secondary');
                }
            }
        }
        
        // Start call timer
        function dialerStartTimer() {
            clearInterval(dialerTimerInterval);
            dialerSeconds = 0;
            dialerTimerInterval = setInterval(() => {
                dialerSeconds++;
                const m = String(Math.floor(dialerSeconds / 60)).padStart(2, '0');
                const s = String(dialerSeconds % 60).padStart(2, '0');
                document.getElementById('dialerCallDuration').textContent = `${m}:${s}`;
            }, 1000);
        }
        
        console.log(' WebRTC Dialer integrated into live chat system');
        
        // ========================================
        // ========================================
        (function() {
            
            
            
        })();
        
        // ========================================
        // HOD (HEAD OF DEPARTMENT) FUNCTIONS
        // ========================================
        
        function loadHODDashboard() {
            if (!currentUser || currentUser.role.toLowerCase() !== 'hod') return;
            
            // Calculate metrics
            const teachers = staff.filter(s => s.role === 'Teacher');
            const lessonPlans = JSON.parse(localStorage.getItem('lessonPlans') || '[]');
            const grades = JSON.parse(localStorage.getItem('grades') || '[]');
            const today = new Date().toISOString().split('T')[0];
            
            // Update metrics
            document.getElementById('hodTotalTeachers').textContent = teachers.length;
            document.getElementById('hodActiveTeachers').textContent = teachers.filter(t => t.status === 'Active').length;
            document.getElementById('hodTotalLessonPlans').textContent = lessonPlans.length;
            document.getElementById('hodAvgPerformance').textContent = '85%'; // Mock data
            
            // Load performance chart
            const perfCanvas = document.getElementById('hodPerformanceChart');
            if (perfCanvas && typeof Chart !== 'undefined') {
                new Chart(perfCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: teachers.map(t => t.name).slice(0, 10),
                        datasets: [{
                            label: 'Performance Score',
                            data: teachers.map(() => Math.floor(Math.random() * 40 + 60)).slice(0, 10),
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }
            
            // Load attendance chart
            const attCanvas = document.getElementById('hodAttendanceChart');
            if (attCanvas && typeof Chart !== 'undefined') {
                new Chart(attCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                        datasets: [{
                            label: 'Teacher Attendance %',
                            data: [95, 92, 98, 90, 96],
                            borderColor: 'rgba(118, 75, 162, 1)',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }
            
            // Load recent activities
            const activitiesContainer = document.getElementById('hodRecentActivities');
            if (activitiesContainer) {
                const activities = [
                    { teacher: 'John Doe', action: 'Submitted lesson plan', time: '10 minutes ago', icon: 'clipboard-list' },
                    { teacher: 'Jane Smith', action: 'Entered grades for Grade 10', time: '25 minutes ago', icon: 'graduation-cap' },
                    { teacher: 'Mike Johnson', action: 'Marked attendance', time: '1 hour ago', icon: 'clock' },
                    { teacher: 'Sarah Williams', action: 'Uploaded learning resource', time: '2 hours ago', icon: 'upload' },
                    { teacher: 'David Brown', action: 'Responded to parent message', time: '3 hours ago', icon: 'comments' }
                ];
                
                activitiesContainer.innerHTML = activities.map(act => `
                    <div class="d-flex justify-content-between align-items-center p-3 mb-2" style="background:rgba(255,255,255,0.1);border-radius:8px;">
                        <div>
                            <i class="fas fa-${act.icon} me-2"></i>
                            <strong>${act.teacher}</strong> ${act.action}
                        </div>
                        <small class="text-muted">${act.time}</small>
                    </div>
                `).join('');
            }
        }
        
        function loadTeacherMonitoring() {
            if (!currentUser || currentUser.role.toLowerCase() !== 'hod') return;
            
            const teacherFilter = document.getElementById('monitorTeacherFilter')?.value || '';
            const dateFilter = document.getElementById('monitorDateFilter')?.value || '';
            
            // Populate teacher filter if empty
            const teacherSelect = document.getElementById('monitorTeacherFilter');
            if (teacherSelect && teacherSelect.options.length === 1) {
                const teachers = staff.filter(s => s.role === 'Teacher');
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.name;
                    teacherSelect.appendChild(option);
                });
            }
            
            // Load lesson plans, grades, attendance data
            const lessonPlans = JSON.parse(localStorage.getItem('lessonPlans') || '[]');
            const grades = JSON.parse(localStorage.getItem('grades') || '[]');
            const teacherChats = JSON.parse(localStorage.getItem('teacherChats') || '[]');
            
            document.getElementById('monitorLessonPlansCount').textContent = lessonPlans.length;
            document.getElementById('monitorGradesCount').textContent = grades.length;
            document.getElementById('monitorAttendanceCount').textContent = attendance.length;
            document.getElementById('monitorCommCount').textContent = teacherChats.length;
            
            // Load activity log
            const activityLog = document.getElementById('teacherActivityLog');
            if (activityLog) {
                const teachers = staff.filter(s => s.role === 'Teacher');
                const activities = [];
                
                // Add lesson plan activities
                lessonPlans.forEach(lp => {
                    activities.push({
                        teacher: 'Teacher Name',
                        activity: 'Lesson Plan Submitted',
                        date: lp.date || new Date().toISOString(),
                        details: lp.title,
                        status: 'Completed'
                    });
                });
                
                // Add grading activities
                grades.slice(0, 10).forEach(grade => {
                    activities.push({
                        teacher: 'Teacher Name',
                        activity: 'Grade Entered',
                        date: new Date().toISOString(),
                        details: `${grade.studentName} - ${grade.subject}`,
                        status: 'Completed'
                    });
                });
                
                // Sort by date
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                activityLog.innerHTML = activities.slice(0, 20).map(act => {
                    const statusBadge = act.status === 'Completed' ? 'bg-success' : 
                                      act.status === 'Pending' ? 'bg-warning' : 'bg-info';
                    return `
                        <tr>
                            <td>${act.teacher}</td>
                            <td>${act.activity}</td>
                            <td>${new Date(act.date).toLocaleString()}</td>
                            <td>${act.details}</td>
                            <td><span class="badge ${statusBadge}">${act.status}</span></td>
                        </tr>
                    `;
                }).join('');
                
                if (activities.length === 0) {
                    activityLog.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No activities found</td></tr>';
                }
            }
        }
        
        function loadTeacherPortalView() {
            if (!currentUser || currentUser.role.toLowerCase() !== 'hod') return;
            
            const teacherId = document.getElementById('hodSelectTeacher')?.value || '';
            const dateRange = document.getElementById('hodViewDateRange')?.value || '';
            
            // Populate teacher select if empty
            const teacherSelect = document.getElementById('hodSelectTeacher');
            if (teacherSelect && teacherSelect.options.length === 1) {
                const teachers = staff.filter(s => s.role === 'Teacher');
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.name + ' - ' + (teacher.department || 'General');
                    teacherSelect.appendChild(option);
                });
            }
            
            if (!teacherId) {
                document.getElementById('teacherPortalTabs').style.display = 'none';
                document.getElementById('teacherPortalTabContent').style.display = 'none';
                return;
            }
            
            // Show tabs and content
            document.getElementById('teacherPortalTabs').style.display = 'flex';
            document.getElementById('teacherPortalTabContent').style.display = 'block';
            
            const selectedTeacher = staff.find(s => s.id == teacherId);
            if (!selectedTeacher) return;
            
            // Load lesson plans
            const lessonPlans = JSON.parse(localStorage.getItem('lessonPlans') || '[]');
            const hodLessonPlansList = document.getElementById('hodLessonPlansList');
            if (hodLessonPlansList) {
                if (lessonPlans.length === 0) {
                    hodLessonPlansList.innerHTML = '<p class="text-muted">No lesson plans found</p>';
                } else {
                    hodLessonPlansList.innerHTML = lessonPlans.slice(0, 10).map(lp => `
                        <div class="lesson-plan">
                            <h6>${lp.title}</h6>
                            <p><strong>Subject:</strong> ${lp.subject} | <strong>Date:</strong> ${lp.date}</p>
                            <p>${lp.description || 'No description'}</p>
                        </div>
                    `).join('');
                }
            }
            
            // Load grading records
            const grades = JSON.parse(localStorage.getItem('grades') || '[]');
            const hodGradingTable = document.getElementById('hodGradingTable');
            if (hodGradingTable) {
                hodGradingTable.innerHTML = grades.slice(0, 20).map(grade => `
                    <tr>
                        <td>${grade.studentName || 'Student'}</td>
                        <td>${grade.subject || 'N/A'}</td>
                        <td>${grade.grade || '-'}</td>
                        <td>${new Date().toLocaleDateString()}</td>
                        <td>${grade.comments || '-'}</td>
                    </tr>
                `).join('');
                
                if (grades.length === 0) {
                    hodGradingTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No grading records found</td></tr>';
                }
            }
            
            // Load resources
            const resources = JSON.parse(localStorage.getItem('resources') || '[]');
            const hodResourcesList = document.getElementById('hodResourcesList');
            if (hodResourcesList) {
                if (resources.length === 0) {
                    hodResourcesList.innerHTML = '<p class="text-muted">No resources found</p>';
                } else {
                    hodResourcesList.innerHTML = resources.slice(0, 10).map(res => `
                        <div class="p-3 mb-2" style="background:rgba(255,255,255,0.1);border-radius:8px;">
                            <h6><i class="fas fa-file me-2"></i>${res.title || 'Resource'}</h6>
                            <p class="mb-0"><small>${res.description || 'No description'}</small></p>
                        </div>
                    `).join('');
                }
            }
            
            // Load uploaded work
            const uploadedWork = JSON.parse(localStorage.getItem('uploadedWork') || '[]');
            const hodUploadedWorkList = document.getElementById('hodUploadedWorkList');
            if (hodUploadedWorkList) {
                if (uploadedWork.length === 0) {
                    hodUploadedWorkList.innerHTML = '<p class="text-muted">No uploaded work found</p>';
                } else {
                    hodUploadedWorkList.innerHTML = uploadedWork.slice(0, 10).map(work => `
                        <div class="p-3 mb-2" style="background:rgba(255,255,255,0.1);border-radius:8px;">
                            <h6><i class="fas fa-upload me-2"></i>${work.title || 'Work'}</h6>
                            <p class="mb-0"><small>Uploaded: ${work.date || 'Recently'}</small></p>
                        </div>
                    `).join('');
                }
            }
            
            // Load chat history
            const teacherChats = JSON.parse(localStorage.getItem('teacherChats') || '[]');
            const hodChatHistory = document.getElementById('hodChatHistory');
            if (hodChatHistory) {
                if (teacherChats.length === 0) {
                    hodChatHistory.innerHTML = '<p class="text-muted">No chat history found</p>';
                } else {
                    hodChatHistory.innerHTML = teacherChats.slice(0, 20).map(chat => `
                        <div class="p-3 mb-2" style="background:rgba(255,255,255,0.1);border-radius:8px;">
                            <div class="d-flex justify-content-between">
                                <strong>${chat.senderName || 'Teacher'}</strong>
                                <small class="text-muted">${new Date(chat.timestamp).toLocaleString()}</small>
                            </div>
                            <p class="mb-0 mt-2">${chat.message}</p>
                        </div>
                    `).join('');
                }
            }
        }
        
        function loadDepartmentReports() {
            if (!currentUser || currentUser.role.toLowerCase() !== 'hod') return;
            
            // Set current month as default
            const reportMonth = document.getElementById('reportMonth');
            if (reportMonth && !reportMonth.value) {
                reportMonth.value = new Date().toISOString().slice(0, 7);
            }
            
            // Load charts
            const perfCanvas = document.getElementById('departmentPerformanceChart');
            if (perfCanvas && typeof Chart !== 'undefined') {
                new Chart(perfCanvas.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['Excellent', 'Good', 'Average', 'Needs Improvement'],
                        datasets: [{
                            data: [35, 40, 20, 5],
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(255, 99, 132, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            const actCanvas = document.getElementById('departmentActivityChart');
            if (actCanvas && typeof Chart !== 'undefined') {
                new Chart(actCanvas.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Lesson Plans', 'Grading', 'Attendance', 'Communication'],
                        datasets: [{
                            data: [150, 230, 180, 95],
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.6)',
                                'rgba(118, 75, 162, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(153, 102, 255, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Load statistics table
            const statsTable = document.getElementById('departmentStatsTable');
            if (statsTable) {
                const teachers = staff.filter(s => s.role === 'Teacher');
                statsTable.innerHTML = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Total Teachers</td>
                                <td>${teachers.length}</td>
                                <td><span class="badge bg-success">+5%</span></td>
                            </tr>
                            <tr>
                                <td>Avg Attendance Rate</td>
                                <td>94%</td>
                                <td><span class="badge bg-success">+2%</span></td>
                            </tr>
                            <tr>
                                <td>Lesson Plans Completion</td>
                                <td>87%</td>
                                <td><span class="badge bg-info">+1%</span></td>
                            </tr>
                            <tr>
                                <td>Grading Completion</td>
                                <td>92%</td>
                                <td><span class="badge bg-success">+3%</span></td>
                            </tr>
                            <tr>
                                <td>Parent Communication</td>
                                <td>78%</td>
                                <td><span class="badge bg-warning">-2%</span></td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }
        }
        
        function generateTeacherReport() {
            addNotification('Generating teacher report...', 'info');
            setTimeout(() => {
                addNotification('Teacher report generated successfully!', 'success');
            }, 1500);
        }
        
        function generateDepartmentReport() {
            const reportType = document.getElementById('reportType').value;
            const reportMonth = document.getElementById('reportMonth').value;
            addNotification(`Generating ${reportType} report for ${reportMonth}...`, 'info');
            setTimeout(() => {
                addNotification('Department report generated successfully!', 'success');
            }, 1500);
        }
        
        function exportDepartmentData() {
            addNotification('Exporting department data to Excel...', 'info');
            setTimeout(() => {
                addNotification('Data exported successfully!', 'success');
            }, 1500);
        }
        
        // ========================================
        // SYSTEM MANAGEMENT PORTAL FUNCTIONS
        // ========================================
        
        // This function is deprecated and provides a notification to users
        function loadSystemManagement() {
            // Show notification if user tries to access this functionality
            if (typeof addNotification === 'function') {
            }
            // Redirect to dashboard
            showSection('dashboard');
        }
        
        function loadStorageInfo() {
            // Calculate localStorage usage
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length + key.length;
                }
            }
            
            // Convert to KB
            const sizeKB = (totalSize / 1024).toFixed(2);
            const maxSizeKB = 5120; // 5MB approximate limit
            const percentage = ((totalSize / 1024 / maxSizeKB) * 100).toFixed(1);
            const availableKB = (maxSizeKB - (totalSize / 1024)).toFixed(2);
            
            document.getElementById('storageUsed').textContent = sizeKB + ' KB';
            document.getElementById('storageAvailable').textContent = availableKB + ' KB';
            const storageBarElement = document.getElementById('storageBar');
            storageBarElement.style.width = percentage + '%';
            storageBarElement.textContent = percentage + '%';
            storageBarElement.setAttribute('aria-valuenow', percentage);
            
            // Update storage status and bar color
            const storageBar = document.getElementById('storageBar');
            const storageStatus = document.getElementById('storageStatus');
            
            if (percentage < 50) {
                storageBar.className = 'progress-bar bg-success';
                storageStatus.innerHTML = '<i class="fas fa-check-circle me-2"></i>Storage is healthy';
                storageStatus.parentElement.className = 'alert alert-success mt-3';
            } else if (percentage < 80) {
                storageBar.className = 'progress-bar bg-warning';
                storageStatus.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Storage usage is moderate';
                storageStatus.parentElement.className = 'alert alert-warning mt-3';
            } else {
                storageBar.className = 'progress-bar bg-danger';
                storageStatus.innerHTML = '<i class="fas fa-times-circle me-2"></i>Storage is nearly full! Consider clearing old data.';
                storageStatus.parentElement.className = 'alert alert-danger mt-3';
            }
        }
        
        function loadSystemActivities() {
            const activities = JSON.parse(localStorage.getItem('userActivities') || '[]');
            const roleFilter = document.getElementById('activityRoleFilter')?.value || '';
            const dateFilter = document.getElementById('activityDateFilter')?.value || '';
            
            let filteredActivities = activities;
            
            if (roleFilter) {
                filteredActivities = filteredActivities.filter(a => a.role === roleFilter);
            }
            
            if (dateFilter) {
                filteredActivities = filteredActivities.filter(a => 
                    a.timestamp.startsWith(dateFilter)
                );
            }
            
            const table = document.getElementById('systemActivityLog');
            if (!table) return;
            
            if (filteredActivities.length === 0) {
                table.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No activities found</td></tr>';
                return;
            }
            
            table.innerHTML = filteredActivities.slice(0, 100).map(act => `
                <tr>
                    <td>${act.username}</td>
                    <td><span class="badge bg-primary">${act.role}</span></td>
                    <td>${act.action}</td>
                    <td>${act.details}</td>
                    <td>${new Date(act.timestamp).toLocaleString()}</td>
                </tr>
            `).join('');
        }
        
        function exportSystemActivities() {
            const activities = JSON.parse(localStorage.getItem('userActivities') || '[]');
            
            if (activities.length === 0) {
                addNotification('No activities to export', 'warning');
                return;
            }
            
            // Convert to CSV
            const csv = ['Username,Role,Action,Details,Timestamp'].concat(
                activities.map(a => 
                    `"${a.username}","${a.role}","${a.action}","${a.details}","${a.timestamp}"`
                )
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `system-activities-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            addNotification('System activities exported successfully!', 'success');
            logUserActivity(currentUser.username || currentUser.name, currentUser.role, 'Export', 'Exported system activities');
        }
    </script>
    
    <!-- Mobile Bottom Navigation Bar -->
    <div class="mobile-nav-bar mobile-only">
        <div class="nav-items">
            <a href="#dashboard" class="nav-item admin-only non-student" onclick="showSection('dashboard')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>

            <a href="#attendance" class="nav-item non-student" onclick="showSection('attendance')">
                <i class="fas fa-clipboard-check"></i>
                <span>Attendance</span>
            </a>

            <a href="#settings" class="nav-item" onclick="showSection('settings')">
                <i class="fas fa-user-circle"></i>
                <span>Profile</span>
            </a>
        </div>
    </div>
    
    <!-- PWA Install Prompt -->
    <div id="installPrompt">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <strong><i class="fas fa-mobile-alt me-2"></i>Install App</strong>
                <p style="margin: 5px 0 0 0; font-size: 0.9em;">Install BIS Management System for quick access and offline use!</p>
            </div>
            <div style="white-space: nowrap;">
                <button class="btn-install" id="installButton">
                    <i class="fas fa-download me-1"></i>Install
                </button>
                <button class="btn-dismiss" id="dismissButton">
                    <i class="fas fa-times me-1"></i>Not Now
                </button>
            </div>
        </div>
    </div>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        // Show success notification if addNotification function is available
                        setTimeout(() => {
                            if (typeof addNotification === 'function') {
                                addNotification('App ready for offline use!', 'success');
                            }
                        }, 2000);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                        // Show user-friendly error notification
                        if (typeof addNotification === 'function') {
                            addNotification('Offline mode unavailable. Please check your connection.', 'warning');
                        } else {
                            console.warn('PWA: Service worker registration failed, offline functionality unavailable');
                        }
                    });
            });
        } else {
            console.log('Service Worker not supported in this browser');
            // Notify user that PWA features are not available
            setTimeout(() => {
                if (typeof addNotification === 'function') {
                    addNotification('This browser does not support offline mode.', 'info');
                }
            }, 2000);
        }
        
        // PWA Install Prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installButton = document.getElementById('installButton');
        const dismissButton = document.getElementById('dismissButton');
        
        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show the install prompt after a delay (only if not dismissed and not already installed)
            setTimeout(() => {
                const dismissedPermanently = localStorage.getItem('installPromptDismissed');
                const dismissedInSession = sessionStorage.getItem('installPromptDismissed');
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
                
                if (!isStandalone && !dismissedPermanently && !dismissedInSession) {
                    installPrompt.classList.add('show');
                }
            }, 3000);
        });
        
        // Install button click handler
        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                return;
            }
            // Show the install prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            // Clear the deferredPrompt for garbage collection
            deferredPrompt = null;
            // Hide the install prompt
            installPrompt.classList.remove('show');
        });
        
        // Dismiss button click handler
        dismissButton.addEventListener('click', () => {
            installPrompt.classList.remove('show');
            
            // Ask user if they want to permanently dismiss or just for this session
            const dismissPermanently = confirm('Hide this install prompt permanently?\n\nClick OK to never see this again, or Cancel to hide it just for this session.');
            
            if (dismissPermanently) {
                localStorage.setItem('installPromptDismissed', 'true');
            } else {
                sessionStorage.setItem('installPromptDismissed', 'true');
            }
        });
        
        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installPrompt.classList.remove('show');
            // Show success notification if available
            if (typeof addNotification === 'function') {
                addNotification('App installed successfully!', 'success');
            }
        });
        
        // Hide install prompt if app is already running as installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('App is running as installed PWA');
        }
        
        // iOS standalone detection
        if (('standalone' in window.navigator) && window.navigator.standalone) {
            console.log('App is running as iOS standalone');
        }
        
        // Fallback tab handler for Admission tabs (works even without Bootstrap JS)
        document.querySelectorAll('#admissionTabs .nav-link').forEach(function(tab) {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Get the tab content container (sibling of the tabs)
                var tabContainer = document.getElementById('admissionTabs');
                var tabContent = tabContainer ? tabContainer.nextElementSibling : null;
                
                // Remove active class from all tabs and tab panes
                document.querySelectorAll('#admissionTabs .nav-link').forEach(function(t) {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });
                if (tabContent && tabContent.classList.contains('tab-content')) {
                    tabContent.querySelectorAll('.tab-pane').forEach(function(p) {
                        p.classList.remove('show', 'active');
                    });
                }
                
                // Add active class to clicked tab and corresponding pane
                this.classList.add('active');
                this.setAttribute('aria-selected', 'true');
                
                // Validate href attribute before using as selector
                var href = this.getAttribute('href');
                if (href && /^#[a-zA-Z][\w-]*$/.test(href)) {
                    var target = document.querySelector(href);
                    if (target) {
                        target.classList.add('show', 'active');
                    }
                }
            });
        });
        
        // ========================================
        // COMMHUB PRO - GROUP VIDEO + CHAT
        // WebRTC-based group video conferencing
        // 
        // LOCATION: Media > CommHub Pro tab
        // HTML Section: Lines ~5893-6000 (id="media-commhub-pro")
        // JavaScript: Lines ~30195-30660
        // ========================================
        
        // CommHub Pro state
        let commhubSocket = null;
        let commhubMyStream = null;
        let commhubPeers = {};
        let commhubUsername = '';
        let commhubRoom = '';
        let commhubMediaRecorder = null;
        let commhubRecordedChunks = [];
        let commhubIsRecording = false;
        let commhubIncomingCallData = null;
        let commhubConnectionAttempts = 0;
        let commhubMaxRetries = 3;
        let commhubRetryTimeout = null;
        let commhubServerAvailable = false;
        let commhubLastConnectionTest = 0;
        
        // Keep-alive and persistent connection variables
        let commhubHeartbeatInterval = null;
        let commhubKeepAliveInterval = null;
        const COMMHUB_HEARTBEAT_INTERVAL = 30000; // Send heartbeat every 30 seconds
        const COMMHUB_KEEP_ALIVE_INTERVAL = 60000; // Check connection every 60 seconds
        
        // Connection timeout constants
        const CONNECTIVITY_TEST_CACHE_DURATION = 60000; // 60 seconds
        const CONNECTION_TIMEOUT = 30000; // 30 seconds
        const CONNECTIVITY_TEST_TIMEOUT = 5000; // 5 seconds
        
        // Shared ICE server configuration
        const COMMHUB_ICE_CONFIG = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };
        
        // Test server connectivity before attempting full connection
        async function testServerConnectivity(serverUrl) {
            return new Promise((resolve) => {
                try {
                    // Test WebSocket connection directly with a short timeout
                    const testSocket = io(serverUrl, {
                        transports: ['websocket', 'polling'],
                        timeout: CONNECTIVITY_TEST_TIMEOUT,
                        reconnection: false, // Don't retry for connectivity test
                        autoConnect: true
                    });
                    
                    const timeoutId = setTimeout(() => {
                        testSocket.close();
                        console.log('Server connectivity test timed out');
                        resolve(false);
                    }, CONNECTIVITY_TEST_TIMEOUT);
                    
                    testSocket.on('connect', () => {
                        clearTimeout(timeoutId);
                        testSocket.close();
                        console.log('Server connectivity test passed');
                        resolve(true);
                    });
                    
                    testSocket.on('connect_error', (error) => {
                        clearTimeout(timeoutId);
                        testSocket.close();
                        console.error('Server connectivity test failed:', error);
                        resolve(false);
                    });
                    
                } catch (error) {
                    console.error('Server connectivity test exception:', error);
                    resolve(false);
                }
            });
        }
        
        // Initialize CommHub Pro (connects to signaling server)
        function initCommHubSocket() {
            // Permanent signaling server deployed on Railway
            const SIGNALING_SERVER = "wss://commhub-signaling-production.up.railway.app";
            
            try {
                // Configure Socket.IO with enhanced timeout and retry settings
                commhubSocket = io(SIGNALING_SERVER, {
                    transports: ['websocket', 'polling'], // Try websocket first, fallback to polling
                    timeout: 20000, // Increased timeout to 20 seconds
                    reconnection: true,
                    reconnectionDelay: 2000, // Start with 2 second delay
                    reconnectionDelayMax: 10000, // Max 10 seconds between retries
                    reconnectionAttempts: commhubMaxRetries,
                    upgrade: true, // Allow transport upgrade
                    rememberUpgrade: true, // Remember successful transport
                    forceNew: false, // Reuse connection if available
                    autoConnect: true,
                    // Add extra socket options for better error handling
                    path: '/socket.io/',
                    withCredentials: false,
                    extraHeaders: {
                        'Accept': 'application/json'
                    }
                });
                
                commhubSocket.on('connect', () => {
                    console.log(' CommHub Pro connected to signaling server');
                    commhubConnectionAttempts = 0; // Reset on successful connection
                    commhubServerAvailable = true; // Mark server as available
                    
                    // Update visual status indicator
                    const statusEl = document.getElementById('videoServerStatus');
                    if (statusEl) {
                        statusEl.className = 'badge bg-success';
                        statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                    }
                    
                    // Only show notification if not auto-initializing
                    if (currentUser && typeof addNotification === 'function') {
                        addNotification('Video server connected', 'success');
                    }
                    
                    // Hide troubleshooting help on successful connection
                    const helpAlert = document.getElementById('commhubConnectionHelp');
                    if (helpAlert) {
                        helpAlert.style.display = 'none';
                    }
                });
                
                commhubSocket.on('connect_error', (error) => {
                    commhubConnectionAttempts++;
                    console.error('CommHub Pro connection error (attempt ' + commhubConnectionAttempts + '):', error);
                    
                    // Only show notifications if user is actively trying to use video features
                    // (not during auto-initialization)
                    if (!commhubMyStream) {
                        // Silent failure during auto-init - just log
                        if (commhubConnectionAttempts >= commhubMaxRetries) {
                            console.log(' Video server not available - will retry when needed');
                            commhubSocket = null;
                        }
                        return;
                    }
                    
                    let errorMessage = 'Unable to connect to video server. ';
                    
                    // Detect specific error types and provide appropriate messages
                    if (error.message) {
                        const msg = error.message.toLowerCase();
                        if (msg.includes('websocket') || msg.includes('ws')) {
                            errorMessage += 'Error: websocket error. ';
                        } else if (msg.includes('timeout')) {
                            errorMessage += 'Connection timed out. ';
                        } else if (msg.includes('xhr poll error') || msg.includes('xhr')) {
                            errorMessage += 'Network error occurred. ';
                        } else if (msg.includes('econnrefused') || msg.includes('refused')) {
                            errorMessage += 'Server connection refused. ';
                        } else {
                            errorMessage += 'Error: ' + error.message + '. ';
                        }
                    } else {
                        // Generic error without message - likely websocket issue
                        errorMessage += 'Error: websocket error. ';
                    }
                    
                    // Add helpful suggestions based on attempt
                    if (commhubConnectionAttempts >= commhubMaxRetries) {
                        errorMessage += 'Failed to join room: Cannot connect to video server. Please check your internet connection and firewall settings.';
                        if (typeof addNotification === 'function') {
                            addNotification(errorMessage, 'danger');
                        }
                        
                        // Show troubleshooting help
                        const helpAlert = document.getElementById('commhubConnectionHelp');
                        if (helpAlert) {
                            helpAlert.style.display = 'block';
                        }
                        
                        // Stop media stream if connection completely failed
                        if (commhubMyStream) {
                            commhubMyStream.getTracks().forEach(track => track.stop());
                            commhubMyStream = null;
                        }
                        
                        // Reset connection state
                        commhubSocket = null;
                    } else {
                        errorMessage += 'Retrying connection (attempt ' + commhubConnectionAttempts + ' of ' + commhubMaxRetries + ')...';
                        if (typeof addNotification === 'function') {
                            addNotification(errorMessage, 'warning');
                        }
                    }
                });
                
                commhubSocket.on('disconnect', (reason) => {
                    console.log('CommHub Pro disconnected:', reason);
                    
                    // Update visual status indicator
                    const statusEl = document.getElementById('videoServerStatus');
                    if (statusEl) {
                        statusEl.className = 'badge bg-warning';
                        statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Reconnecting...';
                    }
                    
                    // Only show notifications if user was actively using video features
                    if (!commhubMyStream && !commhubRoom) {
                        // Silent disconnect during idle - socket.io will auto-reconnect
                        console.log(' Video server disconnected (idle) - will reconnect automatically');
                        return;
                    }
                    
                    // Handle different disconnect reasons
                    if (typeof addNotification === 'function') {
                        if (reason === 'io server disconnect') {
                            // Server initiated disconnect, try to reconnect
                            addNotification('Disconnected from video server. Reconnecting...', 'warning');
                        } else if (reason === 'transport close') {
                            addNotification('Connection lost due to transport closure. Please check your internet connection.', 'warning');
                        } else if (reason === 'transport error') {
                            addNotification('Connection lost due to transport error. Please check your internet connection and firewall settings.', 'warning');
                        } else if (reason === 'ping timeout') {
                            addNotification('Connection timed out. Please check your internet connection.', 'warning');
                        } else {
                            addNotification('Disconnected from video server: ' + reason, 'warning');
                        }
                    }
                });
                
                commhubSocket.on('reconnect', (attemptNumber) => {
                    console.log('CommHub Pro reconnected after ' + attemptNumber + ' attempts');
                    
                    // Update visual status indicator
                    const statusEl = document.getElementById('videoServerStatus');
                    if (statusEl) {
                        statusEl.className = 'badge bg-success';
                        statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                    }
                    
                    // Only notify if user was actively using video features
                    if (commhubMyStream || commhubRoom) {
                        if (typeof addNotification === 'function') {
                            addNotification('Reconnected to video server', 'success');
                        }
                    }
                });
                
                commhubSocket.on('reconnect_failed', () => {
                    console.error('CommHub Pro reconnection failed');
                    // Only notify if user was actively using video features
                    if (commhubMyStream || commhubRoom) {
                        if (typeof addNotification === 'function') {
                            addNotification('Failed to reconnect to video server. Please refresh the page and try again.', 'danger');
                        }
                    }
                });
                
                commhubSocket.on('user-connected', (userId, userName) => {
                    addCommHubParticipant(userName, userId);
                    connectToCommHubUser(userId);
                    addCommHubChatMessage(`${userName} joined`, 'system');
                });
                
                commhubSocket.on('user-disconnected', (userId, userName) => {
                    if (commhubPeers[userId]) {
                        commhubPeers[userId].close();
                        delete commhubPeers[userId];
                    }
                    removeCommHubParticipant(userId);
                    addCommHubChatMessage(`${userName} left`, 'system');
                });
                
                commhubSocket.on('chat', (userName, msg) => {
                    addCommHubChatMessage(`${userName}: ${msg}`);
                });
                
                commhubSocket.on('reaction', (emoji) => {
                    showCommHubReaction(emoji);
                });
                
                commhubSocket.on('offer', async (userId, description) => {
                    await handleCommHubOffer(userId, description);
                });
                
                commhubSocket.on('answer', (userId, description) => {
                    if (commhubPeers[userId]) {
                        commhubPeers[userId].setRemoteDescription(new RTCSessionDescription(description));
                    }
                });
                
                commhubSocket.on('candidate', (userId, candidate) => {
                    if (commhubPeers[userId]) {
                        commhubPeers[userId].addIceCandidate(new RTCIceCandidate(candidate));
                    }
                });
                
                // Handle incoming call requests
                commhubSocket.on('incoming-call', (callData) => {
                    showIncomingCallNotification(callData);
                });
                
            } catch (error) {
                console.error('Failed to initialize CommHub Pro:', error);
                addNotification('CommHub Pro initialization failed: ' + error.message + '. Please check console for details.', 'danger');
            }
            
            // Start keep-alive mechanism
            startCommHubKeepAlive();
        }
        
        // Keep CommHub Pro connection alive with periodic heartbeats
        function startCommHubKeepAlive() {
            // Clear any existing intervals
            if (commhubHeartbeatInterval) clearInterval(commhubHeartbeatInterval);
            if (commhubKeepAliveInterval) clearInterval(commhubKeepAliveInterval);
            
            // Send periodic heartbeat to keep connection alive
            commhubHeartbeatInterval = setInterval(() => {
                if (commhubSocket && commhubSocket.connected) {
                    commhubSocket.emit('heartbeat', {
                        timestamp: Date.now(),
                        username: commhubUsername || 'anonymous'
                    });
                    console.log(' CommHub heartbeat sent');
                }
            }, COMMHUB_HEARTBEAT_INTERVAL);
            
            // Periodically check connection health and reconnect if needed
            commhubKeepAliveInterval = setInterval(() => {
                if (!commhubSocket || !commhubSocket.connected) {
                    console.log(' CommHub connection lost, attempting reconnection...');
                    
                    // Update status indicator
                    const statusEl = document.getElementById('videoServerStatus');
                    if (statusEl) {
                        statusEl.className = 'badge bg-warning';
                        statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Reconnecting...';
                    }
                    
                    // Attempt to reconnect
                    try {
                        if (commhubSocket && typeof commhubSocket.connect === 'function') {
                            commhubSocket.connect();
                        } else {
                            // Reinitialize socket if it's not properly initialized
                            initCommHubSocket();
                        }
                    } catch (error) {
                        console.error('CommHub reconnection failed:', error);
                    }
                } else {
                    console.log(' CommHub connection healthy');
                }
            }, COMMHUB_KEEP_ALIVE_INTERVAL);
            
            console.log(' CommHub keep-alive mechanism started');
        }
        
        // Stop keep-alive mechanism (useful when disconnecting intentionally)
        function stopCommHubKeepAlive() {
            if (commhubHeartbeatInterval) {
                clearInterval(commhubHeartbeatInterval);
                commhubHeartbeatInterval = null;
            }
            if (commhubKeepAliveInterval) {
                clearInterval(commhubKeepAliveInterval);
                commhubKeepAliveInterval = null;
            }
            console.log(' CommHub keep-alive mechanism stopped');
        }
        
        // Show incoming call notification
        function showIncomingCallNotification(callData) {
            commhubIncomingCallData = callData;
            const modal = document.getElementById('incomingCallModal');
            const backdrop = document.getElementById('incomingCallBackdrop');
            const callerName = document.getElementById('incomingCallerName');
            const callTitle = document.getElementById('incomingCallTitle');
            
            callerName.textContent = callData.callerName + ' is calling...';
            callTitle.textContent = 'CommHub Pro Call';
            backdrop.style.display = 'block';
            modal.style.display = 'block';
            
            // Play notification sound (if available)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGnOH0u2snBSuBzvLZiTYIF2u+7+OZURMXZLXL6KhxJAMxh9fs2plfFQdOwujuxWQhBzKJ2fPQjTMHGmW+8OqfUhYMUanm9LdjGwU3jtv03pBECBRlt+PqsnMkBDBv2u7ZkjEHHGvA8emiVhgNTKXh8btoHwU1jtrz0I45BhtpvvTrpVgWDk6q5fS1YhgEMYra8syFNQcbaL307KRUFAxNqOXzu2keAzB/2fDYjDQGG2i78eqjURcLTajj86xbHgIvfdf03H8xBxlnvPLspVcZCkyn4fCsYB8DMIXb89yMNgYZarzy6p9RFAxMqeT0t2MfCDN31/LMeSwFJHfH8N2QQAoUXrTp66hVFApGnOH0u2snBSuBzvLZiTYIF2u+7+OZURMXZLXL6KhxJAMxh9fs2plfFQdOwujuxWQhBzKJ2fPQjTMHGmW+8OqfUhYMUanm9LdjGwU3jtv03pBECBRlt+PqsnMkBDBv2u7ZkjEHHGvA8emiVhgNTKXh8btoHwU1jtrz0I45BhtpvvTrpVgWDk6q5fS1YhgEMYra8syFNQcbaL307KRUFAxNqOXzu2keAzB/2fDYjDQGG2i78eqjURcLTajj86xbHgIvfdf03H8xBxlnvPLspVcZCkyn4fCsYB8DMIXb89yMNgYZarzy6p9RFAxMqeT0t2MfCDN31/LMeSwFJHfH8N2QQAoUXrTp66hVFApGnOH0u2snBSuBzvLZiTYIF2u+7+OZURMXZLXLt6JxJAMxh9fs2plfFQdOwujuxWQhBzKJ2fPQjTMHGmW+8OqfUhYMUanm9LdjGwU3jtv03pBECBRlt+PqsnMkBDBv2u7ZkjEHHGvA8emiVhgNTKXh8btoHwU1jtrz0I45BhtpvvTrpVgWDk6q5fS1YhgEMYra8syFNQcbaL307KRUFAxNqOXzu2keAzB/2fDYjDQGG2i78eqjURcLTajj86xbHgIvfdf03H8xBxlnvPLspVcZCkyn4fCsYB8DMIXb89yMNgYZarzy6p9RFAxMqeT0t2MfCDN31/LMeSwFJHfH8N2QQAoUXrTp66hVFApGnOH0u2snBSuBzvLZiTYIF2u+7+OZURMXZLXL6KhxJAMxh9fs2plfFQdOwujuxWQhBzKJ2fPQjTMHGmW+8OqfUhYMUanm9LdjGwU3jtv03pBECBRlt+PqsnMkBDBv2u7ZkjEHHGvA8emiVhgNTKXh8btoHwU1jtrz0I45BhtpvvTrpVgWDk6q5fS1YhgEMYra8syFNQcbaL307KRUFAxNqOXzu2keAzB/2fDYjDQGG2i78eqjURcLTajj86xbHgIvfdf03H8xBxlnvPLspVcZCkyn4fCsYB8DMIXb89yMNgYZarzy6p9RFAxMqeT0t2MfCDN31/LMeSwFJHfH8N2QQAoUXrTp66hVFApGnOH0u2snBSuBzvLZiTYIF2u+7+OZURMXZLXL6KhxJAMxh9fs2plfFQdOwujuxWQhBzKJ2fPQjTMHGmW+8OqfUhYMUanm9LdjGwU3jtv03pBECBRlt+PqsnMkBDBv2u7ZkjEHHGvA8emiVhgNTKXh8btoHwU1jtrz0I45BhtpvvTrpVgWDk6q5fS1YhgEMYra8syFNQcbaL307KRUFAxNqOXzu2keAzB/2fDYjDQGG2i78eqjURcLTajj86xbHgIvfdf03H8xBxlnvPLspVcZCkyn4fCsYB8DMIXb89yMNgYZarzy6p9RFAxMqeT0t2MfCDN31/LMeSwFJHfH8N2QQAoUXrTp66hVFApGnOH0u2snBSuBzvLZiTYIF2u+7+OZURMXZLXL6KhxJAMxh9fs2plfFQdOwujuxWQhBzKJ2fPQjTMHGmW+8OqfUhYMUanm9LdjGwU3jtv03pBECBRlt+PqsnMkBDBv2u7ZkjEHHGvA8emiVhgNTKXh8btoHwU1jtrz0I45BhtpvvTrpVgWDk6q5fS1YhgEMYra8syFNQcbaL307KRUFAxNqOXzu2keAzB/2fDYjDQGG2i78eqjURcLTajj86xbHgIvfdf03H8xBxlnvPLspVcZCkyn4fCsYB8DMIXb89yMNgYZarzy6p9RFAxMqeT0t2MfCDN31/LMeSwFJHfH8N2QQAoUXrTp66hVFApGnOH0u2snBSuBzvLZiTYIF2u+7+OZURMXZLXL6KhxJAMxh9fs2plfFQdOwujuxWQhBzKJ2fPQjTMHGmW+8OqfUhYMUanm9LdjGwU3jtv03pBECBRlt+PqsnMkBDBv2u7ZkjEHHGvA8emiVhgNTKXh8btoHwU1jtrz0I45BhtpvvTrpVgWDk6q5fS1YhgEMYra8syFNQcbaL307KRUFAxNqOXzu2keAzB/2fDYjDQGG2i78eqjURcLTajj86xbHgIvfdf03H8xBxlnvPLspVcZCkyn4fCsYB8DMIXb89yMNgYZarzy6p9RFAxMqeT0t2MfCDN31/LMeSwFJHfH8N2QQAoUXrTp66hVFApGnOH0u2snBSuBzvLZiTYIF2u+7+OZURMXZLXL6KhxJAMxh9fs2plfFQdOwujuxWQhBzKJ2fPQjTMHGmW+8OqfUhYMUanm9LdjGwU3jtv03pBECBRlt+PqsnMkBDBv2u7ZkjEHHGvA8emiVhgNTKXh8btoHwU1jtrz0I45BhtpvvTrpVgWDk6q5fS1YhgEMYra8syFNQcbaL307KRUFAxNqOXzu2keAzB/2fDYjDQGG2i78eqjURcLTajj86xbHgIvfdf03H8xBxlnvPLspVcZCkyn4fCsYB8DMIXb89yMNgYZarzy6p9RFAxMqeT0t2MfCDN31/LMeSwFJHfH8N2QQAoUXrTp66hVFApGnOH0u2snBSuBzvLZiTYIF2u+7+OZ');
                audio.play().catch(() => {}); // Ignore if autoplay is blocked
            } catch (e) {}
        }
        
        // Accept incoming call (CommHub Pro)
        async function acceptIncomingCall() {
            const modal = document.getElementById('incomingCallModal');
            const backdrop = document.getElementById('incomingCallBackdrop');
            backdrop.style.display = 'none';
            modal.style.display = 'none';
            
            if (!commhubIncomingCallData) return;
            
            try {
                // Auto-join the room
                document.getElementById('commhubRoomInput').value = commhubIncomingCallData.roomName;
                await joinCommHubRoom();
                addNotification('Call accepted', 'success');
            } catch (error) {
                console.error('Error accepting call:', error);
                addNotification('Failed to accept call: ' + error.message, 'danger');
            }
            
            commhubIncomingCallData = null;
        }
        
        // Decline incoming call (CommHub Pro)
        function declineIncomingCall() {
            const modal = document.getElementById('incomingCallModal');
            const backdrop = document.getElementById('incomingCallBackdrop');
            backdrop.style.display = 'none';
            modal.style.display = 'none';
            
            if (commhubSocket && commhubIncomingCallData) {
                commhubSocket.emit('call-declined', commhubIncomingCallData.callerId);
            }
            
            addNotification('Call declined', 'info');
            commhubIncomingCallData = null;
        }
        
        // Join CommHub room
        async function joinCommHubRoom() {
            const roomInput = document.getElementById('commhubRoomInput');
            const rawRoom = roomInput.value.trim();
            
            // Validate and sanitize room name
            if (!rawRoom) {
                addNotification('Please enter a room name', 'warning');
                return;
            }
            
            // Sanitize room name - allow only alphanumeric, dash, and underscore
            commhubRoom = rawRoom.replace(/[^a-zA-Z0-9-_]/g, '').substring(0, 50) || 'default-room';
            if (commhubRoom !== rawRoom) {
                addNotification('Room name sanitized to: ' + commhubRoom, 'info');
            }
            
            commhubUsername = currentUser ? currentUser.name : 'User' + Math.floor(Math.random() * 9999);
            
            try {
                // Test server connectivity first (cache result)
                const now = Date.now();
                if (now - commhubLastConnectionTest > CONNECTIVITY_TEST_CACHE_DURATION || !commhubServerAvailable) {
                    addNotification('Testing connection to video server...', 'info');
                    const SIGNALING_SERVER = "wss://commhub-signaling-production.up.railway.app";
                    commhubServerAvailable = await testServerConnectivity(SIGNALING_SERVER);
                    commhubLastConnectionTest = now;
                    
                    if (!commhubServerAvailable) {
                        throw new Error('Video server is currently unavailable. Please check your internet connection or try again later. The server may be temporarily down for maintenance.');
                    }
                }
                
                // Get local media stream
                commhubMyStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                // Initialize socket if not connected
                if (!commhubSocket || !commhubSocket.connected) {
                    addNotification('Connecting to video server...', 'info');
                    
                    // Reset connection attempts counter when starting fresh
                    commhubConnectionAttempts = 0;
                    
                    initCommHubSocket();
                    
                    // Wait for socket connection with timeout
                    const connectionPromise = new Promise((resolve, reject) => {
                        let retryAttempt = 0;
                        const maxRetries = 3;
                        
                        // Helper to cleanup event listeners
                        const cleanupListeners = () => {
                            if (commhubSocket) {
                                commhubSocket.off('connect', connectHandler);
                                commhubSocket.off('connect_error', errorHandler);
                            }
                        };
                        
                        const timeoutId = setTimeout(() => {
                            cleanupListeners();
                            reject(new Error('Connection timeout. The server might be unavailable or your internet connection is too slow.'));
                        }, CONNECTION_TIMEOUT);
                        
                        const connectHandler = () => {
                            clearTimeout(timeoutId);
                            cleanupListeners();
                            resolve();
                        };
                        
                        const errorHandler = (error) => {
                            retryAttempt++;
                            console.error('Connection attempt ' + retryAttempt + ' failed:', error);
                            
                            // Extract error message
                            let errorMsg = 'websocket error';
                            if (error && error.message) {
                                errorMsg = error.message;
                            } else if (error && error.type) {
                                errorMsg = error.type;
                            }
                            
                            // If we've exhausted retries, reject
                            if (retryAttempt >= maxRetries) {
                                clearTimeout(timeoutId);
                                cleanupListeners();
                                reject(new Error('Connection failed after ' + maxRetries + ' attempts. Last error: ' + errorMsg));
                            }
                            // Otherwise, the Socket.IO library will retry automatically
                        };
                        
                        if (commhubSocket) {
                            commhubSocket.on('connect', connectHandler);
                            commhubSocket.on('connect_error', errorHandler);
                        } else {
                            clearTimeout(timeoutId);
                            reject(new Error('Failed to initialize socket connection'));
                        }
                    });
                    
                    try {
                        await connectionPromise;
                        joinCommHubRoomAfterConnection();
                    } catch (error) {
                        const errorMsg = error.message || 'Unknown error';
                        // Show user-friendly error message that matches the format user reported
                        throw new Error('Failed to join room: Cannot connect to video server. Please check your internet connection and firewall settings.');
                    }
                } else {
                    joinCommHubRoomAfterConnection();
                }
                
                function joinCommHubRoomAfterConnection() {
                    if (!commhubSocket || !commhubSocket.connected) {
                        addNotification('Connection lost. Please try again.', 'danger');
                        return;
                    }
                    
                    commhubSocket.emit('join-room', commhubRoom, commhubUsername);
                    
                    // Add local video
                    addCommHubVideoStream(commhubMyStream, commhubUsername, true);
                    
                    // Enable controls
                    enableCommHubControls();
                    
                    // Hide join form
                    roomInput.disabled = true;
                    document.getElementById('commhubJoinBtn').disabled = true;
                    
                    addNotification(`Joined room: ${commhubRoom}`, 'success');
                }
                
            } catch (error) {
                console.error('Error joining CommHub room:', error);
                
                // Stop any media streams if they were started
                if (commhubMyStream) {
                    commhubMyStream.getTracks().forEach(track => track.stop());
                    commhubMyStream = null;
                }
                
                // Provide specific error messages
                let errorMsg = 'Failed to join room: ';
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMsg += 'Camera/microphone permission denied. Please allow access and try again.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMsg += 'No camera or microphone found. Please connect a device and try again.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMsg += 'Camera/microphone is already in use by another application.';
                } else if (error.message && error.message.includes('timeout')) {
                    errorMsg += 'Connection timeout. Please check your internet connection and try again.';
                } else if (error.message && error.message.includes('connect')) {
                    errorMsg += 'Cannot connect to video server. Please check your internet connection and firewall settings.';
                } else {
                    errorMsg += error.message || 'Unknown error occurred.';
                }
                
                addNotification(errorMsg, 'danger');
            }
        }
        
        // Leave CommHub room
        function leaveCommHubRoom() {
            // Stop all tracks
            if (commhubMyStream) {
                commhubMyStream.getTracks().forEach(track => track.stop());
                commhubMyStream = null;
            }
            
            // Close all peer connections
            Object.values(commhubPeers).forEach(peer => peer.close());
            commhubPeers = {};
            
            // Emit leave event
            if (commhubSocket) {
                commhubSocket.emit('leave-room');
            }
            
            // Reset UI
            document.getElementById('commhubVideoGrid').innerHTML = `
                <div style="text-align:center; padding:40px; color:#666; grid-column: 1/-1;">
                    <i class="fas fa-video-slash fa-3x mb-3"></i>
                    <p>Join a room to start video conferencing</p>
                </div>
            `;
            document.getElementById('commhubParticipants').innerHTML = `
                <div style="text-align:center; padding:20px; color:#888;">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <p>No participants yet</p>
                </div>
            `;
            document.getElementById('commhubChatMessages').innerHTML = `
                <div style="text-align:center; padding:20px; color:#888;">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i>
                    <p>No messages yet</p>
                </div>
            `;
            
            // Re-enable join form
            document.getElementById('commhubRoomInput').disabled = false;
            document.getElementById('commhubJoinBtn').disabled = false;
            
            // Disable controls
            disableCommHubControls();
            
            commhubRoom = '';
            addNotification('Left the room', 'info');
        }
        
        // Add video stream to grid
        function addCommHubVideoStream(stream, name, isSelf = false, userId = null) {
            const videoGrid = document.getElementById('commhubVideoGrid');
            
            // Clear placeholder if exists
            if (videoGrid.querySelector('.fas.fa-video-slash')) {
                videoGrid.innerHTML = '';
            }
            
            const container = document.createElement('div');
            container.className = 'commhub-video-container';
            if (userId) container.dataset.userId = userId;
            container.style.cssText = 'position:relative; border-radius:12px; overflow:hidden; background:#000;';
            
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            if (isSelf) video.muted = true;
            video.style.cssText = 'width:100%; height:100%; object-fit:cover;';
            
            const label = document.createElement('div');
            label.textContent = name + (isSelf ? ' (You)' : '');
            label.style.cssText = 'position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:20px; font-size:14px; color:white;';
            
            container.appendChild(video);
            container.appendChild(label);
            videoGrid.appendChild(container);
        }
        
        // Connect to new user
        async function connectToCommHubUser(userId) {
            const peer = new RTCPeerConnection(COMMHUB_ICE_CONFIG);
            
            commhubMyStream.getTracks().forEach(track => peer.addTrack(track, commhubMyStream));
            
            peer.ontrack = (e) => {
                const existingVideo = document.querySelector(`.commhub-video-container[data-user-id="${userId}"]`);
                if (!existingVideo) {
                    addCommHubVideoStream(e.streams[0], 'Participant', false, userId);
                }
            };
            
            peer.onicecandidate = (e) => {
                if (e.candidate && commhubSocket) {
                    commhubSocket.emit('candidate', userId, e.candidate);
                }
            };
            
            const offer = await peer.createOffer();
            await peer.setLocalDescription(offer);
            
            if (commhubSocket) {
                commhubSocket.emit('offer', userId, peer.localDescription);
            }
            
            commhubPeers[userId] = peer;
        }
        
        // Handle incoming offer
        async function handleCommHubOffer(userId, description) {
            const peer = new RTCPeerConnection(COMMHUB_ICE_CONFIG);
            
            commhubMyStream.getTracks().forEach(track => peer.addTrack(track, commhubMyStream));
            
            peer.ontrack = (e) => {
                addCommHubVideoStream(e.streams[0], 'Participant', false, userId);
            };
            
            peer.onicecandidate = (e) => {
                if (e.candidate && commhubSocket) {
                    commhubSocket.emit('candidate', userId, e.candidate);
                }
            };
            
            await peer.setRemoteDescription(new RTCSessionDescription(description));
            const answer = await peer.createAnswer();
            await peer.setLocalDescription(answer);
            
            if (commhubSocket) {
                commhubSocket.emit('answer', userId, answer);
            }
            
            commhubPeers[userId] = peer;
        }
        
        // Add participant to sidebar
        function addCommHubParticipant(name, id) {
            const container = document.getElementById('commhubParticipants');
            
            // Remove placeholder if exists
            if (container.querySelector('.fa-users')) {
                container.innerHTML = '';
            }
            
            const p = document.createElement('div');
            p.dataset.userId = id;
            p.style.cssText = 'padding:10px; border-radius:8px; margin:5px 0; background:#2a2a2a; display:flex; align-items:center; gap:10px;';
            p.innerHTML = `
                <div style="width:36px; height:36px; border-radius:50%; background:#555; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white;">
                    ${name.charAt(0).toUpperCase()}
                </div>
                <div style="color:white;">${name}</div>
            `;
            container.appendChild(p);
        }
        
        // Remove participant from sidebar
        function removeCommHubParticipant(id) {
            const p = document.querySelector(`[data-user-id="${id}"]`);
            if (p) p.remove();
        }
        
        // Add chat message
        function addCommHubChatMessage(msg, type = 'user') {
            const container = document.getElementById('commhubChatMessages');
            
            // Remove placeholder if exists
            if (container.querySelector('.fa-comment-slash')) {
                container.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.style.cssText = `margin-bottom:10px; padding:8px 12px; border-radius:8px; background:${type === 'system' ? 'rgba(255,255,255,0.05)' : 'rgba(0,82,204,0.2)'}; color:white; font-size:14px;`;
            div.textContent = msg;
            if (type === 'system') {
                div.style.fontStyle = 'italic';
                div.style.opacity = '0.7';
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        // Send chat message
        function sendCommHubChat() {
            const input = document.getElementById('commhubChatInput');
            const msg = input.value.trim();
            
            if (msg && commhubSocket) {
                commhubSocket.emit('chat', msg);
                addCommHubChatMessage(`You: ${msg}`);
                input.value = '';
            }
        }
        
        // Toggle microphone
        function toggleCommHubMute() {
            if (!commhubMyStream) return;
            
            const audioTrack = commhubMyStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                const btn = document.getElementById('commhubMuteBtn');
                btn.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
                btn.style.background = audioTrack.enabled ? '#333' : '#666';
            }
        }
        
        // Toggle video
        function toggleCommHubVideo() {
            if (!commhubMyStream) return;
            
            const videoTrack = commhubMyStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                const btn = document.getElementById('commhubVideoBtn');
                btn.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
                btn.style.background = videoTrack.enabled ? '#333' : '#666';
            }
        }
        
        // Share screen
        async function toggleCommHubScreen() {
            if (!commhubMyStream) return;
            
            try {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const screenTrack = screenStream.getTracks()[0];
                
                // Replace video track for all peers
                Object.values(commhubPeers).forEach(peer => {
                    const sender = peer.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) sender.replaceTrack(screenTrack);
                });
                
                // Handle screen share stop
                screenTrack.onended = () => {
                    const videoTrack = commhubMyStream.getVideoTracks()[0];
                    Object.values(commhubPeers).forEach(peer => {
                        const sender = peer.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) sender.replaceTrack(videoTrack);
                    });
                };
                
                addNotification('Screen sharing started', 'success');
            } catch (error) {
                console.error('Screen share error:', error);
                addNotification('Cannot share screen: ' + error.message, 'danger');
            }
        }
        
        // Raise hand
        function raiseCommHubHand() {
            if (commhubSocket) {
                commhubSocket.emit('reaction', ' Raised Hand');
                addCommHubChatMessage('You raised your hand', 'system');
            }
        }
        
        // Send reaction
        function sendCommHubReaction() {
            const emojis = ['', '', '', '', '', ''];
            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
            if (commhubSocket) {
                commhubSocket.emit('reaction', emoji);
            }
        }
        
        // Toggle recording
        async function toggleCommHubRecording() {
            if (commhubIsRecording) {
                stopCommHubRecording();
            } else {
                await startCommHubRecording();
            }
        }
        
        // Start recording conference
        async function startCommHubRecording() {
            if (!commhubMyStream) {
                addNotification('Join a room first to start recording', 'warning');
                return;
            }
            
            try {
                // Get the video grid container to capture both local and remote streams
                const videoGrid = document.getElementById('commhubVideoGrid');
                
                // Try to capture the video grid (requires screen capture or canvas)
                // Alternative: record only local stream
                const stream = commhubMyStream;
                
                // Check if MediaRecorder is supported
                if (!MediaRecorder.isTypeSupported('video/webm')) {
                    addNotification('Recording not supported in this browser', 'danger');
                    return;
                }
                
                commhubRecordedChunks = [];
                commhubMediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp8,opus'
                });
                
                commhubMediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        commhubRecordedChunks.push(event.data);
                    }
                };
                
                commhubMediaRecorder.onstop = () => {
                    const blob = new Blob(commhubRecordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    
                    // Create download link
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `conference-recording-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.webm`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    addNotification('Recording saved successfully!', 'success');
                    
                    // Hide recording indicator
                    document.getElementById('recordingIndicator').style.display = 'none';
                };
                
                commhubMediaRecorder.start(1000); // Collect data every second
                commhubIsRecording = true;
                
                // Update UI
                const btn = document.getElementById('commhubRecordBtn');
                btn.style.background = '#ef4444';
                btn.innerHTML = '<i class="fas fa-stop"></i>';
                
                // Show recording indicator
                document.getElementById('recordingIndicator').style.display = 'block';
                
                addNotification('Recording started', 'success');
                addCommHubChatMessage('Recording started', 'system');
                
                // Notify other users
                if (commhubSocket) {
                    commhubSocket.emit('chat', ' Recording started');
                }
                
            } catch (error) {
                console.error('Recording error:', error);
                addNotification('Failed to start recording: ' + error.message, 'danger');
            }
        }
        
        // Stop recording conference
        function stopCommHubRecording() {
            if (!commhubMediaRecorder || !commhubIsRecording) return;
            
            try {
                commhubMediaRecorder.stop();
                commhubIsRecording = false;
                
                // Update UI
                const btn = document.getElementById('commhubRecordBtn');
                btn.style.background = '#333';
                btn.innerHTML = '<i class="fas fa-circle"></i>';
                
                addNotification('Recording stopped', 'info');
                addCommHubChatMessage('Recording stopped', 'system');
                
                // Notify other users
                if (commhubSocket) {
                    commhubSocket.emit('chat', ' Recording stopped');
                }
                
            } catch (error) {
                console.error('Stop recording error:', error);
                addNotification('Failed to stop recording: ' + error.message, 'danger');
            }
        }
        
        // Show reaction animation
        function showCommHubReaction(emoji) {
            const container = document.getElementById('commhubVideoGrid');
            const reaction = document.createElement('div');
            reaction.textContent = emoji;
            reaction.style.cssText = `
                position:absolute; 
                font-size:40px; 
                left:${Math.random() * 80}%; 
                top:80%; 
                animation:commhubFloat 3s ease-out forwards;
                pointer-events:none;
                z-index:1000;
            `;
            container.style.position = 'relative';
            container.appendChild(reaction);
            setTimeout(() => reaction.remove(), 3000);
        }
        
        // Enable controls
        function enableCommHubControls() {
            document.getElementById('commhubMuteBtn').disabled = false;
            document.getElementById('commhubVideoBtn').disabled = false;
            document.getElementById('commhubScreenBtn').disabled = false;
            document.getElementById('commhubHandBtn').disabled = false;
            document.getElementById('commhubReactBtn').disabled = false;
            document.getElementById('commhubRecordBtn').disabled = false;
            document.getElementById('commhubLeaveBtn').disabled = false;
        }
        
        // Disable controls
        function disableCommHubControls() {
            document.getElementById('commhubMuteBtn').disabled = true;
            document.getElementById('commhubVideoBtn').disabled = true;
            document.getElementById('commhubScreenBtn').disabled = true;
            document.getElementById('commhubHandBtn').disabled = true;
            document.getElementById('commhubReactBtn').disabled = true;
            document.getElementById('commhubRecordBtn').disabled = true;
            document.getElementById('commhubLeaveBtn').disabled = true;
            
            // Stop recording if active
            if (commhubIsRecording) {
                stopCommHubRecording();
            }
        }
        
        // Add CSS animation for reactions
        if (!document.querySelector('#commhub-animations')) {
            const style = document.createElement('style');
            style.id = 'commhub-animations';
            style.textContent = `
                @keyframes commhubFloat {
                    0% { transform: translateY(0) scale(0); opacity: 0; }
                    50% { transform: translateY(-150px) scale(1); opacity: 1; }
                    100% { transform: translateY(-300px) scale(0); opacity: 0; }
                }
                .commhub-ctrl-btn:hover { background: #444 !important; transform: scale(1.05); }
                .commhub-ctrl-btn:disabled { opacity: 0.5; cursor: not-allowed; }
            `;
            document.head.appendChild(style);
        }
        
        console.log(' CommHub Pro - Group Video + Chat loaded!');
        console.log(' Deploy your signaling server on Railway: https://railway.com?referralCode=Y-GB9M');
    </script>
    
    </body>
</html>
