<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Comprehensive HRMS - Allos Connect (Sage-inspired)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f8ff; color: #333; box-shadow: 0 0 20px #4169E1; }
        .sidebar { background-color: #e6f3ff; border-right: 1px solid #87ceeb; height: 100vh; position: fixed; width: 250px; padding: 20px; overflow-y: auto; transition: width 0.3s ease; z-index: 1000; box-shadow: 0 0 20px #4169E1; }
        .sidebar.collapsed { width: 60px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link { color: #001f3f; font-weight: 500; margin-bottom: 10px; padding: 10px; transition: all 0.2s; }
        .sidebar .nav-link:hover { color: #4169e1; background-color: #add8e6; border-radius: 5px; }
        .sidebar .nav-link.active { color: #4169e1; background-color: #b0e0e6; border-radius: 5px; }
        .content { margin-left: 250px; padding: 40px; transition: margin-left 0.3s ease; background-color: #f8fbff; box-shadow: 0 0 20px #4169E1; }
        .content.expanded { margin-left: 60px; }
        .card-metric { background-color: #ffffff; border: 1px solid #add8e6; box-shadow: 0 4px 15px rgba(135,206,235,0.2), 0 0 10px #4169E1; border-radius: 10px; transition: transform 0.2s; }
        .card-metric:hover { transform: translateY(-5px); }
        .table { background-color: #ffffff; box-shadow: 0 2px 10px rgba(135,206,235,0.1), 0 0 10px #4169E1; border-radius: 10px; overflow: hidden; border: 1px solid #e6f3ff; }
        .modal-content { border-radius: 15px; box-shadow: 0 5px 20px rgba(65,105,225,0.2), 0 0 10px #4169E1; border: 1px solid #add8e6; }
        .btn-toggle-sidebar { position: fixed; top: 20px; left: 260px; z-index: 1001; transition: left 0.3s ease; background-color: #4169e1; border-color: #4169e1; }
        .btn-toggle-sidebar.expanded { left: 70px; }
        #notificationBell { position: fixed; top: 20px; right: 20px; z-index: 1100; }
        .admin-only { display: block; }
        .employee-only { display: none; }
        .dark-mode { background-color: #001f3f; color: #e0e0e0; }
        .dark-mode .sidebar { background-color: #0d1b2a; border-right: 1px solid #4169e1; }
        .dark-mode .nav-link { color: #add8e6; }
        .dark-mode .nav-link:hover { color: #ffffff; background-color: #4169e1; }
        .dark-mode .content { background-color: #001f3f; }
        .dark-mode .card-metric { background-color: #0d1b2a; border: 1px solid #4169e1; }
        .dark-mode .table { background-color: #0d1b2a; color: #e0e0e0; border: 1px solid #add8e6; }
        .dark-mode .table-striped tbody tr:nth-of-type(odd) { background-color: #1a2b4a; }
        .dark-mode .table thead th { background-color: #4169e1; color: white; }
        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 60px; }
            .btn-toggle-sidebar { left: 70px; }
        }
        /* Login Page Styles */
        .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #4169e1, #87ceeb); }
        .login-card { width: 100%; max-width: 420px; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(65,105,225,0.3); background: white; }
        .login-title { font-weight: 700; color: #4169e1; }
        .login-demo { font-size: 0.85rem; color: #666; }
        .payslip-preview { display: none; }
        .payslip-header { background-color: #4169e1; color: white; padding: 1rem; text-align: center; }
        .payslip-body { padding: 1rem; }
        .payslip-footer { border-top: 1px solid #ddd; padding: 1rem; text-align: center; font-size: 0.8rem; }
        /* make audit table scrollable on small screens */
        #audit .table { max-height: 60vh; overflow-y: auto; display: block; }
        #pdfCanvas { max-width: 100%; height: auto; }
        /* Wellness Module Styles */
        .wellness-progress { background-color: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden; }
        .wellness-progress-bar { height: 100%; background: linear-gradient(90deg, #28a745, #ffc107, #fd7e14); transition: width 0.3s ease; }
        .wellness-card { border-left: 4px solid #28a745; }
        .survey-question { margin-bottom: 1rem; }
        .resource-card { transition: transform 0.2s; }
        .resource-card:hover { transform: translateY(-2px); }
        /* Advanced Payroll Styles */
        .payroll-run-card { background: linear-gradient(135deg, #4169e1, #87ceeb); color: white; }
        .earnings-breakdown { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .deduction-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .payroll-summary { font-size: 1.1em; font-weight: bold; }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-users fa-3x text-primary mb-3"></i>
                <h3 class="login-title">HRMS - Allos Connect</h3>
                <p class="text-muted">Sign in to access your dashboard</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <div class="login-demo">
                    <p class="mb-1"><strong>Admin:</strong> admin / admin123</p>
                    <p class="mb-0"><strong>Employee:</strong> john / john123</p>
                </div>
            </form>
            <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#onboardingModal">
                New Employee? Start Onboarding
            </button>
        </div>
    </div>
    <!-- Main App (Hidden until login) -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-primary rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>
        <button class="btn btn-sm btn-primary btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="sidebar">
            <h4 class="mb-4"><i class="fas fa-users me-2"></i><span class="nav-text">HRMS - Allos Connect</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">HR Analytics Dashboard</span></a></li>
                <li class="employee-only"><a href="#myDashboard" class="nav-link" onclick="showSection('myDashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">My Dashboard</span></a></li>
                <li class="admin-only"><a href="#employees" class="nav-link" onclick="showSection('employees')"><i class="fas fa-user-friends me-2"></i><span class="nav-text">Employees (HR Core)</span></a></li>
                <li class="employee-only"><a href="#myProfile" class="nav-link" onclick="showSection('myProfile')"><i class="fas fa-user me-2"></i><span class="nav-text">My Profile</span></a></li>
                <li class="employee-only"><a href="#handbook" class="nav-link" onclick="showSection('handbook')"><i class="fas fa-book me-2"></i><span class="nav-text">Employee Handbook</span></a></li>
                <li class="admin-only"><a href="#payroll" class="nav-link" onclick="showSection('payroll')"><i class="fas fa-money-check-alt me-2"></i><span class="nav-text">Advanced Payroll</span></a></li>
                <li class="employee-only"><a href="#myPayroll" class="nav-link" onclick="showSection('myPayroll')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">My Payslips</span></a></li>
                <li class="admin-only"><a href="#recruitment" class="nav-link" onclick="showSection('recruitment')"><i class="fas fa-briefcase me-2"></i><span class="nav-text">iRecruit</span></a></li>
                <li class="employee-only"><a href="#openJobs" class="nav-link" onclick="showSection('openJobs')"><i class="fas fa-briefcase me-2"></i><span class="nav-text">Job Openings</span></a></li>
                <li><a href="#performance" class="nav-link" onclick="showSection('performance')"><i class="fas fa-chart-line me-2"></i><span class="nav-text">Performance</span></a></li>
                <li><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Time & Attendance</span></a></li>
                <li><a href="#leaves" class="nav-link" onclick="showSection('leaves')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Leaves</span></a></li>
                <li class="admin-only"><a href="#benefits" class="nav-link" onclick="showSection('benefits')"><i class="fas fa-gift me-2"></i><span class="nav-text">Benefits Admin</span></a></li>
                <li class="employee-only"><a href="#myBenefits" class="nav-link" onclick="showSection('myBenefits')"><i class="fas fa-gift me-2"></i><span class="nav-text">My Benefits</span></a></li>
                <li class="admin-only"><a href="#training" class="nav-link" onclick="showSection('training')"><i class="fas fa-graduation-cap me-2"></i><span class="nav-text">Training Admin</span></a></li>
                <li class="employee-only"><a href="#myTraining" class="nav-link" onclick="showSection('myTraining')"><i class="fas fa-graduation-cap me-2"></i><span class="nav-text">My Training</span></a></li>
                <li class="admin-only"><a href="#compliance" class="nav-link" onclick="showSection('compliance')"><i class="fas fa-balance-scale me-2"></i><span class="nav-text">Compliance</span></a></li>
                <li class="admin-only"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">My Workforce Analyzer</span></a></li>
                <li class="admin-only"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="admin-only"><a href="#audit" class="nav-link" onclick="showSection('audit')"><i class="fas fa-history me-2"></i><span class="nav-text">Payroll Audit Trail</span></a></li>
                <li class="admin-only"><a href="#mediaApproval" class="nav-link" onclick="showSection('mediaApproval')"><i class="fas fa-check-circle me-2"></i><span class="nav-text">Media Approval</span></a></li>
                <!-- New Wellness Links -->
                <li class="admin-only"><a href="#wellnessAdmin" class="nav-link" onclick="showSection('wellnessAdmin')"><i class="fas fa-heartbeat me-2"></i><span class="nav-text">Wellness Admin</span></a></li>
                <li class="employee-only"><a href="#myWellness" class="nav-link" onclick="showSection('myWellness')"><i class="fas fa-heartbeat me-2"></i><span class="nav-text">My Wellness</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
        <div class="content">
            <!-- Dashboard (HR Analytics) -->
            <section id="dashboard" class="section">
                <h2>HR Analytics Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Employees</h5><h3 id="totalEmployees">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositions">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Performance</h5><h3 id="avgPerformance">0/5</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeaves">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3 bg-primary text-white"><h5>Compliance</h5><h3 id="complianceScore">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Expiring Certs</h5><h3 id="expiringCerts">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Payroll Cost</h5><h3 id="totalPayrollCost">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Salary</h5><h3 id="avgSalary">R0</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4"></canvas>
            </section>
            <!-- Enhanced Employee Dashboard -->
            <section id="myDashboard" class="section d-none">
                <h2>Welcome, <span id="myName"></span></h2>
                <div class="row mt-4">
                    <div class="col-md-3 col-sm-6 mb-3"><div class="card card-metric p-3"><h5>Recent Payslips</h5><p id="recentPayslips">No recent payslips</p></div></div>
                    <div class="col-md-3 col-sm-6 mb-3"><div class="card card-metric p-3"><h5>Upcoming Leaves</h5><h3 id="upcomingLeaves">0</h3></div></div>
                    <div class="col-md-3 col-sm-6 mb-3"><div class="card card-metric p-3"><h5>Performance Rating</h5><h3 id="myAvgPerformance">0/5</h3></div></div>
                    <div class="col-md-3 col-sm-6 mb-3"><div class="card card-metric p-3"><h5>Pending Tasks</h5><h3 id="pendingTasks">0</h3></div></div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6"><canvas id="myPerformanceChart" height="200"></canvas></div>
                    <div class="col-md-6"><canvas id="myLeaveChart" height="200"></canvas></div>
                </div>
            </section>
            <!-- Employees Section -->
            <section id="employees" class="section d-none">
                <h2>Employee Management (HR Core)</h2>
                <button class="btn btn-primary" onclick="showAddEmployeeModal()">Add Employee</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Name</th><th>Position</th><th>Branch</th><th>Salary</th><th>Tax #</th><th>UIF #</th><th>Actions</th></tr></thead>
                    <tbody id="employeeTable"></tbody>
                </table>
            </section>
            <!-- Handbook Section -->
            <section id="handbook" class="section d-none">
                <h2>Employee Handbook</h2>
                <div id="handbookViewer" class="mb-3"></div>
                <button class="btn btn-primary admin-only" onclick="showUploadHandbookModal()">Upload New Handbook</button>
            </section>
            <!-- Advanced Payroll Section -->
            <section id="payroll" class="section d-none">
                <h2>Advanced Payroll Management</h2>
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card payroll-run-card p-3">
                            <h5>Run Payroll</h5>
                            <button class="btn btn-light" onclick="runBatchPayroll()">Process Batch Payroll</button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Pending Runs</h5>
                            <h3 id="pendingPayrollRuns">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Total YTD Payroll</h5>
                            <h3 id="ytdPayroll">R0</h3>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary me-2" onclick="showAddPayrollModal()">Add Individual Entry</button>
                <button class="btn btn-secondary me-2" onclick="generatePayrollReport()">Generate Report</button>
                <button class="btn btn-info" onclick="exportPayrollToSARS()">Export to SARS</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Employee</th><th>Period</th><th>Gross Earnings</th><th>Total Deductions</th><th>Net Pay</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="payrollTable"></tbody>
                </table>
                <div id="payrollSummary" class="payroll-summary mt-3"></div>
            </section>
            <!-- Recruitment Section -->
            <section id="recruitment" class="section d-none">
                <h2>iRecruit</h2>
                <button class="btn btn-primary" onclick="showAddJobModal()">Add Job</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Title</th><th>Branch</th><th>Applications</th><th>Actions</th></tr></thead>
                    <tbody id="jobTable"></tbody>
                </table>
            </section>
            <!-- Performance Section -->
            <section id="performance" class="section d-none">
                <h2>Performance</h2>
                <button class="btn btn-primary admin-only" onclick="showAddReviewModal()">Add Review</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Employee</th><th>Date</th><th>Score</th><th>Comments</th><th class="admin-only">Actions</th></tr></thead>
                    <tbody id="performanceTable"></tbody>
                </table>
            </section>
            <!-- Attendance Section -->
            <section id="attendance" class="section d-none">
                <h2>Time & Attendance</h2>
                <button class="btn btn-primary" onclick="clockIn()">Clock In</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Employee</th><th>Date</th><th>Hours</th><th>Overtime</th><th>Status</th><th class="admin-only">Actions</th></tr></thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </section>
            <!-- Leaves Section -->
            <section id="leaves" class="section d-none">
                <h2>Leaves</h2>
                <button class="btn btn-primary" onclick="showAddLeaveModal()">Request Leave</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Employee</th><th>Start Date</th><th>End Date</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="leavesTable"></tbody>
                </table>
            </section>
            <!-- Benefits Admin -->
            <section id="benefits" class="section d-none">
                <h2>Benefits Admin</h2>
                <button class="btn btn-primary" onclick="showAddBenefitModal()">Add Benefit Plan</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Cost</th><th>Actions</th></tr></thead>
                    <tbody id="benefitTable"></tbody>
                </table>
            </section>
            <!-- Training Admin -->
            <section id="training" class="section d-none">
                <h2>Training Admin</h2>
                <button class="btn btn-primary" onclick="showAddCourseModal()">Add Course</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Actions</th></tr></thead>
                    <tbody id="courseTable"></tbody>
                </table>
            </section>
            <!-- Compliance Section -->
            <section id="compliance" class="section d-none">
                <h2>Compliance</h2>
                <button class="btn btn-primary" onclick="showAddCertificationModal()">Add Certification</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Employee</th><th>Name</th><th>Expiry Date</th><th>Actions</th></tr></thead>
                    <tbody id="certificationTable"></tbody>
                </table>
            </section>
            <!-- Reports (My Workforce Analyzer) -->
            <section id="reports" class="section d-none">
                <h2>My Workforce Analyzer</h2>
                <button class="btn btn-primary me-2" onclick="exportToExcel(employees, 'employees')">Export Employees</button>
                <button class="btn btn-primary me-2" onclick="exportToExcel(payrolls, 'payrolls')">Export Payrolls</button>
                <button class="btn btn-primary me-2" onclick="exportToExcel(leaves, 'leaves')">Export Leaves</button>
                <button class="btn btn-primary" onclick="exportToExcel(reviews, 'performance')">Export Performance</button>
                <button class="btn btn-success" onclick="exportWellnessReport()">Export Wellness</button>
            </section>
            <!-- Settings -->
            <section id="settings" class="section d-none">
                <h2>Settings</h2>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode(this.checked)">
                    <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
                </div>
                <div class="mt-3">
                    <h5>Payroll Settings</h5>
                    <label class="form-label">Pay Frequency</label>
                    <select id="payFrequency" class="form-control" onchange="saveSettings()">
                        <option value="monthly">Monthly</option>
                        <option value="biweekly">Bi-weekly</option>
                    </select>
                    <label class="form-label mt-3">Tax Year Start</label>
                    <input type="date" id="taxYearStart" class="form-control" value="2025-03-01" onchange="saveSettings()">
                </div>
            </section>
            <!-- Media Approval Workflow -->
            <section id="mediaApproval" class="section d-none">
                <h2>Media Content Approval</h2>
                <button class="btn btn-primary" onclick="showUploadMediaModal()">Upload Media for Approval</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Title</th><th>Uploader</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="mediaTable"></tbody>
                </table>
            </section>
            <!-- ==== AUDIT TRAIL SECTION (Admin only) ==== -->
            <section id="audit" class="section d-none">
                <h2>Payroll Audit Trail</h2>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
                    <tbody id="auditTable"></tbody>
                </table>
            </section>
            <!-- ==== MY PROFILE (Employee) ==== -->
            <section id="myProfile" class="section d-none">
                <h2>My Profile â€“ <span id="profileName"></span></h2>
                <div class="text-center mb-4">
                    <img id="profilePic" src="" alt="Profile Picture" class="rounded-circle img-thumbnail" style="width:150px; height:150px; object-fit:cover;">
                    <input type="file" id="profilePicUpload" accept="image/*" class="d-none">
                    <button class="btn btn-primary mt-2" onclick="document.getElementById('profilePicUpload').click()">Upload Picture</button>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card p-3 mb-3"><strong>Email:</strong> <span id="profileEmail"></span></div>
                        <div class="card p-3 mb-3"><strong>Phone:</strong> <span id="profilePhone"></span></div>
                        <div class="card p-3 mb-3"><strong>Salary:</strong> <span id="profileSalary"></span></div>
                        <div class="card p-3 mb-3"><strong>Tax #:</strong> <span id="profileTax"></span></div>
                        <div class="card p-3 mb-3"><strong>UIF #:</strong> <span id="profileUIF"></span></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Enrolled Benefits</h5>
                        <ul id="profileBenefits" class="list-group"></ul>
                        <h5 class="mt-3">Compliance Certificates</h5>
                        <ul id="profileCerts" class="list-group"></ul>
                    </div>
                </div>
                <button class="btn btn-primary mt-3" onclick="showEditMyProfile()">Edit Profile</button>
            </section>
            <!-- ==== MY PAYSLIPS (Employee) ==== -->
            <section id="myPayroll" class="section d-none">
                <h2>My Payslips & Earnings</h2>
                <div class="card mb-3">
                    <div class="card-body">
                        <h5>YTD Earnings: <span id="myYTDEarnings">R0</span> | YTD Tax: <span id="myYTDTax">R0</span></h5>
                    </div>
                </div>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Period</th><th>Gross</th><th>Deductions</th><th>Bonus</th><th>Net</th><th>Action</th></tr></thead>
                    <tbody id="myPayrollTable"></tbody>
                </table>
            </section>
            <!-- ==== MY BENEFITS (Employee) ==== -->
            <section id="myBenefits" class="section d-none">
                <h2>My Benefits</h2>
                <div class="card mb-3">
                    <div class="card-body">
                        <h5>Total Benefits Cost: <span id="totalBenefitsCost">R0.00</span></h5>
                    </div>
                </div>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Name</th><th>Description</th><th>Cost</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="myBenefitTable"></tbody>
                </table>
            </section>
            <!-- ==== MY TRAINING (Employee) ==== -->
            <section id="myTraining" class="section d-none">
                <h2>My Training</h2>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Name</th><th>Description</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="myCourseTable"></tbody>
                </table>
            </section>
            <!-- ==== JOB OPENINGS (Employee) ==== -->
            <section id="openJobs" class="section d-none">
                <h2>Job Openings</h2>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Title</th><th>Branch</th><th>Description</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="openJobTable"></tbody>
                </table>
            </section>
            <!-- New Wellness Admin Section (Admin Only) -->
            <section id="wellnessAdmin" class="section d-none admin-only">
                <h2>Wellness Admin</h2>
                <div class="row mb-4">
                    <div class="col-md-3"><div class="card card-metric p-3 wellness-card"><h5>Avg Wellness Score</h5><h3 id="avgWellnessScore">0/10</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Active Goals</h5><h3 id="activeGoals">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Completed Surveys</h5><h3 id="completedSurveys">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>High-Risk Alerts</h5><h3 id="highRiskAlerts">0</h3></div></div>
                </div>
                <button class="btn btn-primary me-2" onclick="showAddResourceModal()">Add Wellness Resource</button>
                <button class="btn btn-primary me-2" onclick="showAddSurveyModal()">Create New Survey</button>
                <button class="btn btn-secondary" onclick="exportWellnessReport()">Export Wellness Report</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Employee</th><th>Wellness Score</th><th>Last Survey</th><th>Goals Progress</th><th>Alerts</th><th>Actions</th></tr></thead>
                    <tbody id="wellnessAdminTable"></tbody>
                </table>
                <canvas id="wellnessAdminChart" class="mt-4"></canvas>
            </section>
            <!-- New My Wellness Section (Employee Only) -->
            <section id="myWellness" class="section d-none employee-only">
                <h2>My Wellness Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-4 mb-3">
                        <div class="card wellness-card p-3">
                            <h5>Overall Wellness Score</h5>
                            <h3 id="myWellnessScore">0/10</h3>
                            <div class="wellness-progress mt-2">
                                <div class="wellness-progress-bar" id="myWellnessProgress" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card p-3">
                            <h5>Active Goals</h5>
                            <ul id="myActiveGoals" class="list-unstyled"></ul>
                            <button class="btn btn-sm btn-success mt-2" onclick="showAddGoalModal()">Add Goal</button>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card p-3">
                            <h5>Quick Actions</h5>
                            <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="showSurveyModal()">Take Survey</button>
                            <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="showResourcesModal()">View Resources</button>
                            <button class="btn btn-outline-warning btn-sm w-100" onclick="requestCounseling()">Request Counseling</button>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6"><canvas id="myWellnessChart" height="200"></canvas></div>
                    <div class="col-md-6">
                        <h5>Recent Activity</h5>
                        <ul id="myWellnessActivity" class="list-group"></ul>
                    </div>
                </div>
            </section>
            <!-- Payslip Preview Modal -->
            <div class="modal fade" id="payslipModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Advanced Payslip Preview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="payslipPreview" class="payslip-preview">
                                <div class="payslip-header">
                                    <h4>Allos Connect - Payslip</h4>
                                    <p id="payslipEmployee"></p>
                                    <p id="payslipPeriod"></p>
                                </div>
                                <div class="payslip-body">
                                    <h6>Earnings Breakdown</h6>
                                    <div class="earnings-breakdown">
                                        <div class="deduction-item"><span>Basic Salary</span><span id="payslipBasic">R0.00</span></div>
                                        <div class="deduction-item"><span>Overtime</span><span id="payslipOvertime">R0.00</span></div>
                                        <div class="deduction-item"><span>Bonus/Commission</span><span id="payslipBonus">R0.00</span></div>
                                        <div class="deduction-item"><span><strong>Total Earnings</strong></span><strong id="payslipGross">R0.00</strong></div>
                                    </div>
                                    <h6 class="mt-3">Deductions</h6>
                                    <div class="earnings-breakdown">
                                        <div class="deduction-item"><span>PAYE Tax</span><span id="payslipTax">R0.00</span></div>
                                        <div class="deduction-item"><span>UIF Contribution</span><span id="payslipUIF">R0.00</span></div>
                                        <div class="deduction-item"><span>SDL</span><span id="payslipSDL">R0.00</span></div>
                                        <div class="deduction-item"><span>Benefits/Pension</span><span id="payslipBenefits">R0.00</span></div>
                                        <div class="deduction-item"><span>Other</span><span id="payslipOther">R0.00</span></div>
                                        <div class="deduction-item"><span><strong>Total Deductions</strong></span><strong id="payslipTotalDeductions">R0.00</strong></div>
                                    </div>
                                    <div class="payroll-summary mt-3"><strong>Net Pay: <span id="payslipNet">R0.00</span></strong></div>
                                    <div id="payslipTaxNumber" class="mt-3"></div>
                                </div>
                                <div class="payslip-footer">
                                    <p>Tax Number: <span id="payslipTaxNumFooter"></span></p>
                                    <p>This is a computer-generated payslip. Compliant with SARS regulations.</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button class="btn btn-primary" onclick="downloadPayslip()">Download PDF</button>
                            <button class="btn btn-info" onclick="printPayslip()">Print</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tax Liability Download Modal -->
            <div class="modal fade" id="taxLiabilityModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Advanced Tax Liability Summary</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="taxLiabilityContent">
                                <p id="taxLiabilityEmployee"></p>
                                <table class="table">
                                    <thead><tr><th>Period</th><th>PAYE</th><th>UIF</th><th>SDL</th><th>Total Tax</th></tr></thead>
                                    <tbody id="taxLiabilityTable"></tbody>
                                </table>
                                <p>YTD Total Tax Liability: <span id="totalTaxLiability">R0.00</span></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button class="btn btn-primary" onclick="downloadTaxLiability()">Download Report</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Notifications Modal -->
            <div class="modal fade" id="notificationsModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header"><h5>Alerts & Workflow</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <table class="table"><tbody id="notificationsTable"></tbody></table>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="markAllRead()">Mark All Read</button></div>
                    </div>
                </div>
            </div>
            <!-- Onboarding Modal -->
            <div class="modal fade" id="onboardingModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Employee Self-Onboarding</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Welcome! Please complete your onboarding details below. Once submitted, you can log in with your chosen credentials. Note: Salary will be set by HR.</p>
                            <input id="onbName" placeholder="Full Name" class="form-control mb-3" required>
                            <select id="onbPosition" class="form-control mb-3" required>
                                <option value="">Select Position</option>
                                <option>Producer</option><option>Editor</option><option>Marketer</option><option>Admin</option>
                            </select>
                            <select id="onbBranch" class="form-control mb-3 branch-select" required></select>
                            <input id="onbEmail" type="email" placeholder="Email" class="form-control mb-3" required>
                            <input id="onbPhone" placeholder="Phone" class="form-control mb-3" required>
                            <input id="onbTaxNumber" placeholder="Tax Number" class="form-control mb-3" required>
                            <input id="onbUIF" placeholder="UIF Number" class="form-control mb-3" required>
                            <input id="onbUsername" placeholder="Choose Username" class="form-control mb-3" required>
                            <input id="onbPassword" type="password" placeholder="Choose Password" class="form-control mb-3" required>
                            <input id="onbConfirmPassword" type="password" placeholder="Confirm Password" class="form-control mb-3" required>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveOnboardingEmployee()">Complete Onboarding</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Upload Handbook Modal -->
            <div class="modal fade" id="uploadHandbookModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Upload Employee Handbook</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="handbookFile" accept=".pdf" class="form-control">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="uploadHandbook()">Upload</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add/Edit Employee Modal -->
            <div class="modal fade" id="addEmployeeModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addEmployeeModalLabel">Add Employee</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="empName" placeholder="Name" class="form-control mb-3">
                            <select id="empPosition" class="form-control mb-3"><option>Producer</option><option>Editor</option><option>Marketer</option><option>Admin</option></select>
                            <select id="empBranch" class="form-control mb-3 branch-select"></select>
                            <input id="empEmail" placeholder="Email" class="form-control mb-3">
                            <input id="empPhone" placeholder="Phone" class="form-control mb-3">
                            <input id="empSalary" type="number" placeholder="Salary" class="form-control mb-3">
                            <input id="empUsername" placeholder="Username" class="form-control mb-3">
                            <input id="empPassword" type="password" placeholder="Password" class="form-control mb-3">
                            <input id="empTaxNumber" placeholder="Tax Number" class="form-control mb-3">
                            <input id="empUIF" placeholder="UIF Number" class="form-control mb-3">
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveEmployee()">Save</button></div>
                    </div>
                </div>
            </div>
            <!-- Advanced Add/Edit Payroll Modal -->
            <div class="modal fade" id="addPayrollModal">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addPayrollModalLabel">Add Payroll Entry</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <select id="payEmployee" class="form-control mb-3 emp-select" onchange="loadEmployeePayData(); calculatePayroll()"></select>
                                    <input id="payPeriod" type="month" class="form-control mb-3" onchange="calculatePayroll()">
                                    <input id="payHoursWorked" type="number" placeholder="Regular Hours" class="form-control mb-2" onchange="calculatePayroll()">
                                    <input id="payOvertimeHours" type="number" placeholder="Overtime Hours" class="form-control mb-2" onchange="calculatePayroll()">
                                    <input id="payCommission" type="number" placeholder="Commission" class="form-control mb-3" onchange="calculatePayroll()">
                                </div>
                                <div class="col-md-6">
                                    <h6>Earnings</h6>
                                    <div class="earnings-breakdown">
                                        <div class="deduction-item"><span>Basic Pay</span><span id="payBasic">R0.00</span></div>
                                        <div class="deduction-item"><span>Overtime Pay</span><span id="payOvertime">R0.00</span></div>
                                        <div class="deduction-item"><span>Commission</span><span id="payComm">R0.00</span></div>
                                        <div class="deduction-item"><span><strong>Gross Earnings</strong></span><strong id="payGross">R0.00</strong></div>
                                    </div>
                                    <h6 class="mt-3">Deductions</h6>
                                    <div class="earnings-breakdown">
                                        <div class="deduction-item"><span>PAYE Tax</span><span id="payPAYE">R0.00</span></div>
                                        <div class="deduction-item"><span>UIF</span><span id="payUIF">R0.00</span></div>
                                        <div class="deduction-item"><span>SDL</span><span id="paySDL">R0.00</span></div>
                                        <div class="deduction-item"><span>Benefits</span><span id="payBenefits">R0.00</span></div>
                                        <div class="deduction-item"><span><strong>Total Deductions</strong></span><strong id="payTotalDeductions">R0.00</strong></div>
                                    </div>
                                    <div class="payroll-summary mt-3"><strong>Net Pay: <span id="payNet">R0.00</span></strong></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="savePayroll()">Save & Process</button></div>
                    </div>
                </div>
            </div>
            <!-- Add/Edit Job Modal -->
            <div class="modal fade" id="addJobModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addJobModalLabel">Add Job</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="jobTitle" placeholder="Title" class="form-control mb-3">
                            <select id="jobBranch" class="form-control mb-3 branch-select"></select>
                            <textarea id="jobDesc" placeholder="Description" class="form-control mb-3"></textarea>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveJob()">Save</button></div>
                    </div>
                </div>
            </div>
            <!-- Add/Edit Review Modal -->
            <div class="modal fade" id="addReviewModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addReviewModalLabel">Add Review</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <select id="reviewEmployee" class="form-control mb-3 emp-select"></select>
                            <input id="reviewScore" type="number" min="0" max="5" placeholder="Score (0-5)" class="form-control mb-3">
                            <textarea id="reviewComments" placeholder="Comments" class="form-control mb-3"></textarea>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveReview()">Save</button></div>
                    </div>
                </div>
            </div>
            <!-- Add/Edit Leave Modal -->
            <div class="modal fade" id="addLeaveModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addLeaveModalLabel">Request Leave</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <select id="leaveEmployee" class="form-control mb-3 emp-select"></select>
                            <input id="leaveStart" type="date" class="form-control mb-3">
                            <input id="leaveEnd" type="date" class="form-control mb-3">
                            <select id="leaveType" class="form-control mb-3"><option>Sick</option><option>Annual</option><option>Maternity</option></select>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveLeave()">Save</button></div>
                    </div>
                </div>
            </div>
            <!-- Add/Edit Benefit Modal -->
            <div class="modal fade" id="addBenefitModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addBenefitModalLabel">Add Benefit Plan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="benefitName" placeholder="Name" class="form-control mb-3">
                            <textarea id="benefitDesc" placeholder="Description" class="form-control mb-3"></textarea>
                            <input id="benefitCost" type="number" placeholder="Cost" class="form-control mb-3">
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveBenefit()">Save</button></div>
                    </div>
                </div>
            </div>
            <!-- Add/Edit Course Modal -->
            <div class="modal fade" id="addCourseModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addCourseModalLabel">Add Course</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="courseName" placeholder="Name" class="form-control mb-3">
                            <textarea id="courseDesc" placeholder="Description" class="form-control mb-3"></textarea>
                            <textarea id="courseQuestions" placeholder="Quiz Questions (JSON format)" class="form-control mb-3"></textarea>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveCourse()">Save</button></div>
                    </div>
                </div>
            </div>
            <!-- Add/Edit Certification Modal -->
            <div class="modal fade" id="addCertificationModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addCertificationModalLabel">Add Certification</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <select id="certEmployee" class="form-control mb-3 emp-select"></select>
                            <input id="certName" placeholder="Name" class="form-control mb-3">
                            <input id="certExpiry" type="date" class="form-control mb-3">
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveCertification()">Save</button></div>
                    </div>
                </div>
            </div>
            <!-- Upload Media Modal -->
            <div class="modal fade" id="uploadMediaModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5>Upload Media</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="mediaTitle" placeholder="Title" class="form-control mb-3">
                            <textarea id="mediaDesc" placeholder="Description" class="form-control mb-3"></textarea>
                            <input id="mediaFile" type="file" class="form-control mb-3">
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="uploadMedia()">Upload</button></div>
                    </div>
                </div>
            </div>
            <!-- ==== EDIT MY PROFILE MODAL ==== -->
            <div class="modal fade" id="editMyProfileModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header"><h5>Edit My Profile</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="editName" placeholder="Name" class="form-control mb-3">
                            <input id="editEmail" placeholder="Email" class="form-control mb-3">
                            <input id="editPhone" placeholder="Phone" class="form-control mb-3">
                            <input id="editPassword" type="password" placeholder="New Password (optional)" class="form-control mb-3">
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveMyProfile()">Save</button></div>
                    </div>
                </div>
            </div>
            <!-- Image Crop Modal -->
            <div class="modal fade" id="cropModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5>Crop Profile Picture</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <img id="cropImage" src="" style="max-width:100%;">
                            <div class="mt-3">
                                <button id="cropConfirm" class="btn btn-primary">Crop & Upload</button>
                                <button id="cropCancel" class="btn btn-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Quiz Modal -->
            <div class="modal fade" id="quizModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="quizTitle">Quiz</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body" id="quizBody"></div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="submitQuiz()">Submit</button></div>
                    </div>
                </div>
            </div>
            <!-- New Wellness Survey Modal -->
            <div class="modal fade" id="surveyModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 id="surveyTitle">Wellness Survey</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="surveyForm">
                                <div id="surveyQuestions"></div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="submitSurvey()">Submit Survey</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- New Add Wellness Resource Modal -->
            <div class="modal fade" id="addResourceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5>Add Wellness Resource</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="resourceTitle" placeholder="Title" class="form-control mb-3">
                            <textarea id="resourceDesc" placeholder="Description" class="form-control mb-3"></textarea>
                            <input id="resourceLink" placeholder="Link (optional)" class="form-control mb-3">
                            <select id="resourceCategory" class="form-control mb-3">
                                <option>Mental Health</option>
                                <option>Physical Fitness</option>
                                <option>Nutrition</option>
                                <option>Stress Management</option>
                            </select>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveResource()">Save</button></div>
                    </div>
                </div>
            </div>
            <!-- New Wellness Resources Modal -->
            <div class="modal fade" id="resourcesModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header"><h5>Wellness Resources</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <div id="resourcesList"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- New Add Goal Modal -->
            <div class="modal fade" id="addGoalModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5>Add Wellness Goal</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="goalTitle" placeholder="Goal Title" class="form-control mb-3">
                            <textarea id="goalDesc" placeholder="Description" class="form-control mb-3"></textarea>
                            <input id="goalTargetDate" type="date" class="form-control mb-3">
                            <select id="goalCategory" class="form-control mb-3">
                                <option>Mental Health</option>
                                <option>Physical Fitness</option>
                                <option>Nutrition</option>
                                <option>Work-Life Balance</option>
                            </select>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveGoal()">Save Goal</button></div>
                    </div>
                </div>
            </div>
            <!-- New Add Survey Modal (Admin) -->
            <div class="modal fade" id="addSurveyModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header"><h5>Create New Survey</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="surveyName" placeholder="Survey Name" class="form-control mb-3">
                            <textarea id="surveyDesc" placeholder="Description" class="form-control mb-3"></textarea>
                            <div id="surveyQuestionInputs"></div>
                            <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addSurveyQuestion()">Add Question</button>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveSurvey()">Save Survey</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Data Structures
        let employees = JSON.parse(localStorage.getItem('employees')) || [
            { id: 1, name: 'John Doe', position: 'Producer', branch: 'Johannesburg', email: 'john@allos.com', phone: '0821234567', salary: 25000, username: 'john', password: 'john123', taxNumber: '1234567890123', uifNumber: 'UIF123', enrolledBenefits: [], enrolledCourses: [], wellness: { score: 0, surveys: [], goals: [], metrics: { stress: 5, energy: 5, mood: 5 } }, index: 0 },
            { id: 2, name: 'Admin User', position: 'Admin', branch: 'Cape Town', email: 'admin@allos.com', phone: '0827654321', salary: 30000, username: 'admin', password: 'admin123', taxNumber: '9876543210987', uifNumber: 'UIF456', enrolledBenefits: [], enrolledCourses: [], wellness: { score: 0, surveys: [], goals: [], metrics: { stress: 5, energy: 5, mood: 5 } }, index: 1 }
        ];
        let payrolls = JSON.parse(localStorage.getItem('payrolls')) || [];
        let jobs = JSON.parse(localStorage.getItem('jobs')) || [];
        let reviews = JSON.parse(localStorage.getItem('reviews')) || [];
        let attendances = JSON.parse(localStorage.getItem('attendances')) || [];
        let leaves = JSON.parse(localStorage.getItem('leaves')) || [];
        let benefitPlans = JSON.parse(localStorage.getItem('benefitPlans')) || [];
        let courses = JSON.parse(localStorage.getItem('courses')) || [];
        let certifications = JSON.parse(localStorage.getItem('certifications')) || [];
        let mediaContents = JSON.parse(localStorage.getItem('mediaContents')) || [];
        let auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let handbookFile = localStorage.getItem('handbookFile') || null;
        let wellnessResources = JSON.parse(localStorage.getItem('wellnessResources')) || [];
        let wellnessSurveys = JSON.parse(localStorage.getItem('wellnessSurveys')) || [
            { id: 1, name: 'Monthly Wellness Check', questions: [
                { question: 'Stress Level (1-10)', type: 'scale' },
                { question: 'Energy Level (1-10)', type: 'scale' },
                { question: 'Mood (1-10)', type: 'scale' }
            ] }
        ];
        let branches = ['Johannesburg', 'Cape Town', 'Durban', 'Pretoria'];
        let currentUser = null;
        let currentJobEdit = -1;
        let currentReviewEdit = -1;
        let currentLeaveEdit = -1;
        let currentBenefitEdit = -1;
        let currentCourseEdit = -1;
        let currentCertEdit = -1;
        let currentMediaEdit = -1;
        let currentQuizCourseId = null;
        let surveyQuestionCounter = 0;

        // Payroll Constants (South Africa - 2025 Rates)
        const UIF_RATE = 0.01; // 1% employee + 1% employer
        const SDL_RATE = 0.01; // 1% on gross up to threshold
        const OVERTIME_RATE = 1.5;
        const PAYE_THRESHOLDS = [
            { limit: 95000, rate: 0.18 },
            { limit: 150000, rate: 0.26 },
            { limit: 230000, rate: 0.31 },
            { limit: 350000, rate: 0.36 },
            { limit: 450000, rate: 0.39 },
            { limit: 600000, rate: 0.41 },
            { limit: Infinity, rate: 0.45 }
        ];
        const TAX_REBATE = 17365; // Basic rebate 2025
        const PAY_FREQUENCY = 'monthly'; // Default

        // Utility Functions
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const content = document.querySelector('.content');
            const toggleBtn = document.querySelector('.btn-toggle-sidebar');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            toggleBtn.classList.toggle('expanded');
        }
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
            document.getElementById(section).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.target.classList.add('active');
            if (section === 'payroll') renderPayroll();
            if (section === 'myPayroll') renderMyPayroll();
            if (section === 'dashboard') renderDashboard();
            if (section === 'myDashboard') renderMyDashboard();
            if (section === 'employees') renderEmployees();
            if (section === 'handbook') renderHandbook();
            if (section === 'recruitment') renderRecruitment();
            if (section === 'performance') renderPerformance();
            if (section === 'attendance') renderAttendance();
            if (section === 'leaves') renderLeaves();
            if (section === 'benefits') renderBenefits();
            if (section === 'training') renderTraining();
            if (section === 'compliance') renderCompliance();
            if (section === 'reports') renderReports();
            if (section === 'settings') renderSettings();
            if (section === 'audit') renderAudit();
            if (section === 'mediaApproval') renderMediaApproval();
            if (section === 'myProfile') renderMyProfile();
            if (section === 'myBenefits') renderMyBenefits();
            if (section === 'myTraining') renderMyTraining();
            if (section === 'openJobs') renderOpenJobs();
            if (section === 'wellnessAdmin') renderWellnessAdmin();
            if (section === 'myWellness') renderMyWellness();
            updateRoleVisibility();
        }
        function updateRoleVisibility() {
            const isAdmin = currentUser.role === 'admin';
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
            document.querySelectorAll('.employee-only').forEach(el => el.style.display = isAdmin ? 'none' : 'block');
        }
        function toggleDarkMode(enabled) {
            document.body.classList.toggle('dark-mode', enabled);
            localStorage.setItem('darkMode', enabled);
        }
        function saveSettings() {
            const settings = {
                payFrequency: document.getElementById('payFrequency').value,
                taxYearStart: document.getElementById('taxYearStart').value
            };
            localStorage.setItem('settings', JSON.stringify(settings));
        }
        function renderSettings() {
            const settings = JSON.parse(localStorage.getItem('settings')) || {};
            document.getElementById('payFrequency').value = settings.payFrequency || 'monthly';
            document.getElementById('taxYearStart').value = settings.taxYearStart || '2025-03-01';
        }
        function addNotification(user, message) {
            const notif = { id: Date.now(), message, read: false, date: new Date().toLocaleString() };
            notifications.push(notif);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            if (user !== 'admin' && currentUser.index === user) updateNotificationBadge();
        }
        function updateNotificationBadge() {
            const unread = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationBadge');
            badge.textContent = unread;
            badge.style.display = unread > 0 ? 'block' : 'none';
        }
        function renderNotifications() {
            document.getElementById('notificationsTable').innerHTML = notifications.map(n => `
                <tr class="${n.read ? '' : 'table-info'}">
                    <td>${n.message}</td>
                    <td>${n.date}</td>
                    <td><button class="btn btn-sm btn-primary" onclick="markRead(${n.id})">Read</button></td>
                </tr>
            `).join('');
            updateNotificationBadge();
        }
        function markRead(id) {
            const notif = notifications.find(n => n.id === id);
            if (notif) notif.read = true;
            localStorage.setItem('notifications', JSON.stringify(notifications));
            renderNotifications();
        }
        function markAllRead() {
            notifications.forEach(n => n.read = true);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            renderNotifications();
        }
        function populateSelects(selectId, options) {
            const select = document.getElementById(selectId);
            select.innerHTML = options.map(opt => `<option>${opt}</option>`).join('');
        }
        function populateOnboardingSelects() {
            populateSelects('onbBranch', branches);
        }
        function populateEmployeeSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = employees.map((e, i) => `<option value="${i}">${e.name} (${e.position})</option>`).join('');
        }
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const user = employees.find(e => e.username === username && e.password === password);
            if (user || (username === 'admin' && password === 'admin123')) {
                currentUser = user || { role: 'admin', index: -1 };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                initApp();
            } else {
                alert('Invalid credentials');
            }
        }
        function logout() {
            localStorage.removeItem('currentUser');
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
        }
        function initApp() {
            updateRoleVisibility();
            renderDashboard();
            renderEmployees();
            renderHandbook();
            renderPayroll();
            renderRecruitment();
            renderPerformance();
            renderAttendance();
            renderLeaves();
            renderBenefits();
            renderTraining();
            renderCompliance();
            renderMediaApproval();
            renderAudit();
            renderNotifications();
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeSwitch').checked = true;
            }
            renderSettings();
        }

        // Employee Management
        let currentEmployeeEdit = -1;
        function showAddEmployeeModal() {
            currentEmployeeEdit = -1;
            document.getElementById('addEmployeeModalLabel').innerHTML = 'Add Employee';
            // Reset form
            const modal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
            populateSelects('empBranch', branches);
            modal.show();
        }
        function showEditEmployeeModal(i) {
            currentEmployeeEdit = i;
            document.getElementById('addEmployeeModalLabel').innerHTML = 'Edit Employee';
            const emp = employees[i];
            document.getElementById('empName').value = emp.name;
            document.getElementById('empPosition').value = emp.position;
            document.getElementById('empBranch').value = emp.branch;
            document.getElementById('empEmail').value = emp.email;
            document.getElementById('empPhone').value = emp.phone;
            document.getElementById('empSalary').value = emp.salary;
            document.getElementById('empUsername').value = emp.username;
            document.getElementById('empPassword').value = '';
            document.getElementById('empTaxNumber').value = emp.taxNumber;
            document.getElementById('empUIF').value = emp.uifNumber;
            populateSelects('empBranch', branches);
            const modal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
            modal.show();
        }
        function saveEmployee() {
            const emp = {
                id: currentEmployeeEdit === -1 ? Date.now() : employees[currentEmployeeEdit].id,
                name: document.getElementById('empName').value,
                position: document.getElementById('empPosition').value,
                branch: document.getElementById('empBranch').value,
                email: document.getElementById('empEmail').value,
                phone: document.getElementById('empPhone').value,
                salary: parseFloat(document.getElementById('empSalary').value),
                username: document.getElementById('empUsername').value,
                password: document.getElementById('empPassword').value || employees[currentEmployeeEdit]?.password,
                taxNumber: document.getElementById('empTaxNumber').value,
                uifNumber: document.getElementById('empUIF').value,
                enrolledBenefits: employees[currentEmployeeEdit]?.enrolledBenefits || [],
                enrolledCourses: employees[currentEmployeeEdit]?.enrolledCourses || [],
                wellness: employees[currentEmployeeEdit]?.wellness || { score: 0, surveys: [], goals: [], metrics: { stress: 5, energy: 5, mood: 5 } },
                index: currentEmployeeEdit === -1 ? employees.length : currentEmployeeEdit
            };
            if (currentEmployeeEdit === -1) {
                employees.push(emp);
                addNotification('admin', `New employee added: ${emp.name}`);
            } else {
                employees[currentEmployeeEdit] = emp;
                addNotification('admin', `Employee updated: ${emp.name}`);
            }
            localStorage.setItem('employees', JSON.stringify(employees));
            renderEmployees();
            renderDashboard();
            bootstrap.Modal.getInstance(document.getElementById('addEmployeeModal')).hide();
            logAudit('EMPLOYEE_UPDATE', emp.name);
        }
        function renderEmployees() {
            document.getElementById('employeeTable').innerHTML = employees.map((emp, i) => `
                <tr>
                    <td>${emp.id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.position}</td>
                    <td>${emp.branch}</td>
                    <td>R${emp.salary.toFixed(2)}</td>
                    <td>${emp.taxNumber}</td>
                    <td>${emp.uifNumber}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditEmployeeModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
            populateEmployeeSelect('payEmployee');
            populateEmployeeSelect('reviewEmployee');
            populateEmployeeSelect('leaveEmployee');
            populateEmployeeSelect('certEmployee');
        }
        function deleteEmployee(i) {
            if (confirm('Delete employee?')) {
                const name = employees[i].name;
                employees.splice(i, 1);
                localStorage.setItem('employees', JSON.stringify(employees));
                renderEmployees();
                renderDashboard();
                logAudit('EMPLOYEE_DELETE', name);
            }
        }

        // Handbook
        function renderHandbook() {
            if (handbookFile) {
                // Simulate PDF viewer
                document.getElementById('handbookViewer').innerHTML = '<iframe src="' + handbookFile + '" width="100%" height="600px"></iframe>';
            } else {
                document.getElementById('handbookViewer').innerHTML = '<p>No handbook uploaded. Please upload via admin.</p>';
            }
        }
        function showUploadHandbookModal() {
            const modal = new bootstrap.Modal(document.getElementById('uploadHandbookModal'));
            modal.show();
        }
        function uploadHandbook() {
            const file = document.getElementById('handbookFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    handbookFile = e.target.result;
                    localStorage.setItem('handbookFile', handbookFile);
                    renderHandbook();
                    addNotification('admin', 'Handbook uploaded');
                };
                reader.readAsDataURL(file);
                bootstrap.Modal.getInstance(document.getElementById('uploadHandbookModal')).hide();
            }
        }

        // Advanced Payroll Functions (Enhanced with top software features: Gusto, ADP, Paychex, Rippling, BambooHR, QuickBooks, OnPay, Wave, Justworks, Square)
        function loadEmployeePayData() {
            const empIndex = document.getElementById('payEmployee').value;
            const emp = employees[empIndex];
            if (emp) {
                document.getElementById('payHoursWorked').value = 160; // Default monthly hours
                document.getElementById('payOvertimeHours').value = 0;
                document.getElementById('payCommission').value = 0;
            }
        }
        function calculatePAYE(grossAnnual) {
            let tax = 0;
            let prevLimit = 0;
            PAYE_THRESHOLDS.forEach(threshold => {
                const slice = Math.min(grossAnnual, threshold.limit) - prevLimit;
                if (slice > 0) tax += slice * (threshold.rate / 12); // Monthly
                prevLimit = threshold.limit;
            });
            tax -= TAX_REBATE / 12; // Monthly rebate
            return Math.max(0, tax);
        }
        function calculateUIF(gross) {
            return Math.min(gross * UIF_RATE, 177.12); // 2025 cap
        }
        function calculateSDL(gross) {
            return gross * SDL_RATE; // Employer portion, but include for total
        }
        function calculateBenefitsDeductions(empIndex) {
            const emp = employees[empIndex];
            return emp.enrolledBenefits.reduce((sum, bId) => {
                const benefit = benefitPlans.find(b => b.id === bId);
                return sum + (benefit ? benefit.cost : 0);
            }, 0);
        }
        function calculatePayroll() {
            const empIndex = parseInt(document.getElementById('payEmployee').value);
            const emp = employees[empIndex];
            if (!emp) return;
            const regularHours = parseFloat(document.getElementById('payHoursWorked').value) || 0;
            const overtimeHours = parseFloat(document.getElementById('payOvertimeHours').value) || 0;
            const commission = parseFloat(document.getElementById('payCommission').value) || 0;
            const hourlyRate = emp.salary / 160; // Assume 160 hours/month
            const basicPay = regularHours * hourlyRate;
            const overtimePay = overtimeHours * hourlyRate * OVERTIME_RATE;
            const gross = basicPay + overtimePay + commission;
            const paye = calculatePAYE(emp.salary * 12); // Annualize for accuracy
            const uif = calculateUIF(gross);
            const sdl = calculateSDL(gross);
            const benefits = calculateBenefitsDeductions(empIndex);
            const totalDeductions = paye + uif + sdl + benefits;
            const net = gross - totalDeductions;
            // Update UI
            document.getElementById('payBasic').textContent = `R${basicPay.toFixed(2)}`;
            document.getElementById('payOvertime').textContent = `R${overtimePay.toFixed(2)}`;
            document.getElementById('payComm').textContent = `R${commission.toFixed(2)}`;
            document.getElementById('payGross').textContent = `R${gross.toFixed(2)}`;
            document.getElementById('payPAYE').textContent = `R${paye.toFixed(2)}`;
            document.getElementById('payUIF').textContent = `R${uif.toFixed(2)}`;
            document.getElementById('paySDL').textContent = `R${sdl.toFixed(2)}`;
            document.getElementById('payBenefits').textContent = `R${benefits.toFixed(2)}`;
            document.getElementById('payTotalDeductions').textContent = `R${totalDeductions.toFixed(2)}`;
            document.getElementById('payNet').textContent = `R${net.toFixed(2)}`;
        }
        function runBatchPayroll() {
            const period = prompt('Enter payroll period (YYYY-MM):');
            if (!period) return;
            let totalCost = 0;
            employees.forEach((emp, i) => {
                const payrollEntry = {
                    id: Date.now() + i,
                    employeeIndex: i,
                    period: period,
                    basicPay: emp.salary,
                    overtimePay: 0, // Integrate with attendance
                    commission: 0,
                    gross: emp.salary,
                    paye: calculatePAYE(emp.salary * 12),
                    uif: calculateUIF(emp.salary),
                    sdl: calculateSDL(emp.salary),
                    benefits: calculateBenefitsDeductions(i),
                    totalDeductions: 0,
                    net: 0,
                    status: 'Processed',
                    taxNumber: emp.taxNumber,
                    dateProcessed: new Date().toISOString()
                };
                payrollEntry.totalDeductions = payrollEntry.paye + payrollEntry.uif + payrollEntry.sdl + payrollEntry.benefits;
                payrollEntry.net = payrollEntry.gross - payrollEntry.totalDeductions;
                payrolls.push(payrollEntry);
                totalCost += payrollEntry.net;
                addNotification('admin', `Payroll processed for ${emp.name}`);
            });
            localStorage.setItem('payrolls', JSON.stringify(payrolls));
            renderPayroll();
            renderDashboard();
            logAudit('BATCH_PAYROLL', `Processed for ${period}, total R${totalCost.toFixed(2)}`);
            alert(`Batch payroll run for ${period}. Total cost: R${totalCost.toFixed(2)}`);
        }
        let currentPayrollEdit = -1;
        function showAddPayrollModal() {
            currentPayrollEdit = -1;
            document.getElementById('addPayrollModalLabel').innerHTML = 'Add Payroll Entry';
            populateEmployeeSelect('payEmployee');
            document.getElementById('payPeriod').value = '';
            // Reset calculations
            const modal = new bootstrap.Modal(document.getElementById('addPayrollModal'));
            modal.show();
        }
        function showEditPayrollModal(i) {
            currentPayrollEdit = i;
            document.getElementById('addPayrollModalLabel').innerHTML = 'Edit Payroll Entry';
            const p = payrolls[i];
            document.getElementById('payEmployee').value = p.employeeIndex;
            document.getElementById('payPeriod').value = p.period;
            // Load other fields from payroll
            loadEmployeePayData();
            calculatePayroll();
            const modal = new bootstrap.Modal(document.getElementById('addPayrollModal'));
            modal.show();
        }
        function savePayroll() {
            const empIndex = parseInt(document.getElementById('payEmployee').value);
            const period = document.getElementById('payPeriod').value;
            const p = {
                id: currentPayrollEdit === -1 ? Date.now() : payrolls[currentPayrollEdit].id,
                employeeIndex: empIndex,
                period,
                basicPay: parseFloat(document.getElementById('payBasic').textContent.replace('R', '')),
                overtimePay: parseFloat(document.getElementById('payOvertime').textContent.replace('R', '')),
                commission: parseFloat(document.getElementById('payComm').textContent.replace('R', '')),
                gross: parseFloat(document.getElementById('payGross').textContent.replace('R', '')),
                paye: parseFloat(document.getElementById('payPAYE').textContent.replace('R', '')),
                uif: parseFloat(document.getElementById('payUIF').textContent.replace('R', '')),
                sdl: parseFloat(document.getElementById('paySDL').textContent.replace('R', '')),
                benefits: parseFloat(document.getElementById('payBenefits').textContent.replace('R', '')),
                totalDeductions: parseFloat(document.getElementById('payTotalDeductions').textContent.replace('R', '')),
                net: parseFloat(document.getElementById('payNet').textContent.replace('R', '')),
                status: currentPayrollEdit === -1 ? 'Draft' : payrolls[currentPayrollEdit].status,
                taxNumber: employees[empIndex].taxNumber,
                dateProcessed: new Date().toISOString()
            };
            if (currentPayrollEdit === -1) {
                payrolls.push(p);
                addNotification('admin', `New payroll entry for ${employees[empIndex].name}`);
            } else {
                payrolls[currentPayrollEdit] = p;
                addNotification('admin', `Payroll updated for ${employees[empIndex].name}`);
            }
            localStorage.setItem('payrolls', JSON.stringify(payrolls));
            renderPayroll();
            bootstrap.Modal.getInstance(document.getElementById('addPayrollModal')).hide();
            logAudit('PAYROLL_UPDATE', `${employees[empIndex].name} â€“ ${period}`);
        }
        function renderPayroll() {
            const filteredPayrolls = payrolls.filter(p => {
                // Show only current period or all for admin
                return currentUser.role === 'admin' || p.employeeIndex === currentUser.index;
            });
            document.getElementById('payrollTable').innerHTML = filteredPayrolls.map((p, i) => `
                <tr>
                    <td>${p.id}</td>
                    <td>${employees[p.employeeIndex]?.name || 'Unknown'}</td>
                    <td>${p.period}</td>
                    <td>R${p.gross.toFixed(2)}</td>
                    <td>R${p.totalDeductions.toFixed(2)}</td>
                    <td>R${p.net.toFixed(2)}</td>
                    <td><span class="badge bg-${p.status === 'Processed' ? 'success' : 'warning'}">${p.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="generatePayslip(${payrolls.indexOf(p)})">Payslip</button>
                        <button class="btn btn-sm btn-info" onclick="showTaxLiability(${p.employeeIndex}, '${p.period}')">Tax Report</button>
                        ${currentUser.role === 'admin' ? `<button class="btn btn-sm btn-secondary" onclick="showEditPayrollModal(${payrolls.indexOf(p)})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePayroll(${payrolls.indexOf(p)})">Delete</button>` : ''}
                    </td>
                </tr>
            `).join('');
            // Summary
            const totalGross = filteredPayrolls.reduce((sum, p) => sum + p.gross, 0);
            const totalNet = filteredPayrolls.reduce((sum, p) => sum + p.net, 0);
            document.getElementById('payrollSummary').innerHTML = `<strong>Summary: Gross R${totalGross.toFixed(2)} | Net R${totalNet.toFixed(2)}</strong>`;
            // Pending runs
            document.getElementById('pendingPayrollRuns').textContent = payrolls.filter(p => p.status === 'Draft').length;
            // YTD
            const ytdGross = payrolls.filter(p => new Date(p.period + '-01') >= new Date('2025-03-01')).reduce((sum, p) => sum + p.gross, 0);
            document.getElementById('ytdPayroll').textContent = `R${ytdGross.toFixed(2)}`;
        }
        function deletePayroll(i) {
            if (confirm('Delete payroll entry?')) {
                const p = payrolls[i];
                payrolls.splice(i, 1);
                localStorage.setItem('payrolls', JSON.stringify(payrolls));
                logAudit('PAYROLL_DELETE', `${employees[p.employeeIndex].name} â€“ ${p.period}`);
                renderPayroll();
                renderDashboard();
            }
        }
        function generatePayslip(i) {
            const p = payrolls[i];
            const emp = employees[p.employeeIndex];
            document.getElementById('payslipEmployee').innerHTML = `Employee: ${emp.name}<br>Email: ${emp.email}<br>Position: ${emp.position}`;
            document.getElementById('payslipPeriod').innerHTML = `Period: ${p.period}`;
            document.getElementById('payslipBasic').textContent = `R${p.basicPay.toFixed(2)}`;
            document.getElementById('payslipOvertime').textContent = `R${p.overtimePay.toFixed(2)}`;
            document.getElementById('payslipBonus').textContent = `R${p.commission.toFixed(2)}`;
            document.getElementById('payslipGross').textContent = `R${p.gross.toFixed(2)}`;
            document.getElementById('payslipTax').textContent = `R${p.paye.toFixed(2)}`;
            document.getElementById('payslipUIF').textContent = `R${p.uif.toFixed(2)}`;
            document.getElementById('payslipSDL').textContent = `R${p.sdl.toFixed(2)}`;
            document.getElementById('payslipBenefits').textContent = `R${p.benefits.toFixed(2)}`;
            document.getElementById('payslipOther').textContent = `R0.00`; // Additional
            document.getElementById('payslipTotalDeductions').textContent = `R${p.totalDeductions.toFixed(2)}`;
            document.getElementById('payslipNet').textContent = `R${p.net.toFixed(2)}`;
            document.getElementById('payslipTaxNumber').innerHTML = `<strong>Tax Number:</strong> ${p.taxNumber}`;
            document.getElementById('payslipTaxNumFooter').textContent = p.taxNumber;
            document.getElementById('payslipPreview').style.display = 'block';
            const modal = new bootstrap.Modal(document.getElementById('payslipModal'));
            modal.show();
        }
        function printPayslip() {
            const printContent = document.getElementById('payslipPreview').innerHTML;
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            location.reload();
        }
        function downloadPayslip() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.html(document.getElementById('payslipPreview'), {
                callback: function (doc) {
                    doc.save('advanced-payslip.pdf');
                },
                x: 10,
                y: 10
            });
        }
        function showTaxLiability(empIndex, period = null) {
            const emp = employees[empIndex];
            let empPayslips = payrolls.filter(p => p.employeeIndex === empIndex);
            if (period) empPayslips = empPayslips.filter(p => p.period === period);
            document.getElementById('taxLiabilityEmployee').innerHTML = `Tax Summary for ${emp.name} ${period ? `(${period})` : 'YTD'}`;
            document.getElementById('taxLiabilityTable').innerHTML = empPayslips.map(p => `
                <tr><td>${p.period}</td><td>R${p.paye.toFixed(2)}</td><td>R${p.uif.toFixed(2)}</td><td>R${p.sdl.toFixed(2)}</td><td>R${(p.paye + p.uif + p.sdl).toFixed(2)}</td></tr>
            `).join('');
            const totalTax = empPayslips.reduce((sum, p) => sum + p.paye + p.uif + p.sdl, 0);
            document.getElementById('totalTaxLiability').textContent = `R${totalTax.toFixed(2)}`;
            const modal = new bootstrap.Modal(document.getElementById('taxLiabilityModal'));
            modal.show();
        }
        function downloadTaxLiability() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.html(document.getElementById('taxLiabilityContent'), {
                callback: function (doc) {
                    doc.save('tax-liability-report.pdf');
                },
                x: 10,
                y: 10
            });
        }
        function generatePayrollReport() {
            const report = {
                period: new Date().toLocaleDateString(),
                totalEmployees: employees.length,
                totalGross: payrolls.reduce((sum, p) => sum + p.gross, 0),
                totalTax: payrolls.reduce((sum, p) => sum + p.paye + p.uif + p.sdl, 0),
                details: payrolls.map(p => ({ employee: employees[p.employeeIndex].name, gross: p.gross, net: p.net }))
            };
            alert('Payroll report generated. Implement export logic.');
            console.log(report); // For demo
        }
        function exportPayrollToSARS() {
            // Simulate SARS eFiling export (XML/CSV)
            const sarsData = payrolls.map(p => ({
                employeeIRNumber: employees[p.employeeIndex].taxNumber,
                gross: p.gross,
                paye: p.paye,
                uif: p.uif
            }));
            const ws = XLSX.utils.json_to_sheet(sarsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'SARS Export');
            XLSX.writeFile(wb, 'sars-payroll-export.xlsx');
            addNotification('admin', 'SARS export generated');
        }
        function renderMyPayroll() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const myP = payrolls.filter(p => p.employeeIndex === user.index);
            const ytdGross = myP.reduce((sum, p) => sum + p.gross, 0);
            const ytdTax = myP.reduce((sum, p) => sum + p.paye, 0);
            document.getElementById('myYTDEarnings').textContent = `R${ytdGross.toFixed(2)}`;
            document.getElementById('myYTDTax').textContent = `R${ytdTax.toFixed(2)}`;
            const tbody = document.getElementById('myPayrollTable');
            tbody.innerHTML = myP.map((p, i) => `
                <tr>
                    <td>${p.period}</td>
                    <td>R${p.gross.toFixed(2)}</td>
                    <td>R${p.totalDeductions.toFixed(2)}</td>
                    <td>R${p.commission.toFixed(2)}</td>
                    <td>R${p.net.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="generatePayslip(${payrolls.indexOf(p)})">View Payslip</button>
                        <button class="btn btn-sm btn-info" onclick="showTaxLiability(${user.index}, '${p.period}')">Tax Details</button>
                    </td>
                </tr>
            `).join('');
        }

        // Recruitment
        function showAddJobModal() {
            currentJobEdit = -1;
            document.getElementById('addJobModalLabel').innerHTML = 'Add Job';
            document.getElementById('jobTitle').value = '';
            document.getElementById('jobBranch').value = '';
            document.getElementById('jobDesc').value = '';
            populateSelects('jobBranch', branches);
            const modal = new bootstrap.Modal(document.getElementById('addJobModal'));
            modal.show();
        }
        function saveJob() {
            const j = {
                id: currentJobEdit === -1 ? Date.now() : jobs[currentJobEdit].id,
                title: document.getElementById('jobTitle').value,
                branch: document.getElementById('jobBranch').value,
                description: document.getElementById('jobDesc').value,
                applications: currentJobEdit === -1 ? [] : jobs[currentJobEdit].applications,
            };
            if (currentJobEdit === -1) {
                jobs.push(j);
                addNotification('admin', `New job added: ${j.title}`);
            } else {
                jobs[currentJobEdit] = j;
                addNotification('admin', `Job updated: ${j.title}`);
            }
            localStorage.setItem('jobs', JSON.stringify(jobs));
            renderRecruitment();
            bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
        }
        function renderRecruitment() {
            document.getElementById('jobTable').innerHTML = jobs.map((j, i) => `
                <tr>
                    <td>${j.id}</td>
                    <td>${j.title}</td>
                    <td>${j.branch}</td>
                    <td>${j.applications.length}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditJobModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteJob(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('openPositions').textContent = jobs.length;
        }
        function showEditJobModal(i) {
            currentJobEdit = i;
            document.getElementById('addJobModalLabel').innerHTML = 'Edit Job';
            const j = jobs[i];
            document.getElementById('jobTitle').value = j.title;
            document.getElementById('jobBranch').value = j.branch;
            document.getElementById('jobDesc').value = j.description;
            populateSelects('jobBranch', branches);
            const modal = new bootstrap.Modal(document.getElementById('addJobModal'));
            modal.show();
        }
        function deleteJob(i) {
            if (confirm('Delete?')) {
                jobs.splice(i, 1);
                localStorage.setItem('jobs', JSON.stringify(jobs));
                renderRecruitment();
                renderDashboard();
            }
        }

        // Performance
        function showAddReviewModal() {
            currentReviewEdit = -1;
            document.getElementById('addReviewModalLabel').innerHTML = 'Add Review';
            populateEmployeeSelect('reviewEmployee');
            document.getElementById('reviewScore').value = '';
            document.getElementById('reviewComments').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addReviewModal'));
            modal.show();
        }
        function saveReview() {
            const r = {
                employeeIndex: parseInt(document.getElementById('reviewEmployee').value),
                date: new Date().toLocaleDateString(),
                score: parseFloat(document.getElementById('reviewScore').value),
                comments: document.getElementById('reviewComments').value,
            };
            if (currentReviewEdit === -1) {
                reviews.push(r);
                addNotification('admin', `New review for ${employees[r.employeeIndex].name}`);
            } else {
                reviews[currentReviewEdit] = {...reviews[currentReviewEdit], ...r};
                addNotification('admin', `Review updated for ${employees[r.employeeIndex].name}`);
            }
            localStorage.setItem('reviews', JSON.stringify(reviews));
            renderPerformance();
            renderDashboard();
            bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
        }
        function renderPerformance() {
            document.getElementById('performanceTable').innerHTML = reviews.map((r, i) => `
                <tr>
                    <td>${employees[r.employeeIndex]?.name || 'Unknown'}</td>
                    <td>${r.date}</td>
                    <td>${r.score}/5</td>
                    <td>${r.comments}</td>
                    <td class="admin-only">
                        <button class="btn btn-sm btn-primary" onclick="showEditReviewModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteReview(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
            const avgScore = reviews.length ? (reviews.reduce((sum, r) => sum + r.score, 0) / reviews.length).toFixed(1) : 0;
            document.getElementById('avgPerformance').textContent = `${avgScore}/5`;
        }
        function showEditReviewModal(i) {
            currentReviewEdit = i;
            document.getElementById('addReviewModalLabel').innerHTML = 'Edit Review';
            const r = reviews[i];
            document.getElementById('reviewEmployee').value = r.employeeIndex;
            document.getElementById('reviewScore').value = r.score;
            document.getElementById('reviewComments').value = r.comments;
            populateEmployeeSelect('reviewEmployee');
            const modal = new bootstrap.Modal(document.getElementById('addReviewModal'));
            modal.show();
        }
        function deleteReview(i) {
            if (confirm('Delete?')) {
                reviews.splice(i, 1);
                localStorage.setItem('reviews', JSON.stringify(reviews));
                renderPerformance();
                renderDashboard();
            }
        }

        // Attendance (Enhanced for payroll integration)
        function clockIn() {
            const employeeIndex = prompt('Enter employee index to clock in:');
            if (employeeIndex === null) return;
            const att = {
                employeeIndex: parseInt(employeeIndex),
                date: new Date().toLocaleDateString(),
                hours: 8, // Default
                overtime: 0,
                status: 'Present'
            };
            attendances.push(att);
            localStorage.setItem('attendances', JSON.stringify(attendances));
            addNotification('admin', `${employees[att.employeeIndex]?.name || 'Unknown'} clocked in`);
            renderAttendance();
        }
        function renderAttendance() {
            document.getElementById('attendanceTable').innerHTML = attendances.map((a, i) => `
                <tr>
                    <td>${employees[a.employeeIndex]?.name || 'Unknown'}</td>
                    <td>${a.date}</td>
                    <td>${a.hours}</td>
                    <td>${a.overtime}</td>
                    <td>${a.status}</td>
                    <td class="admin-only">
                        <button class="btn btn-sm btn-danger" onclick="deleteAttendance(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        function deleteAttendance(i) {
            if (confirm('Delete?')) {
                attendances.splice(i, 1);
                localStorage.setItem('attendances', JSON.stringify(attendances));
                renderAttendance();
            }
        }

        // Leaves
        function showAddLeaveModal() {
            currentLeaveEdit = -1;
            document.getElementById('addLeaveModalLabel').innerHTML = 'Request Leave';
            populateEmployeeSelect('leaveEmployee');
            document.getElementById('leaveStart').value = '';
            document.getElementById('leaveEnd').value = '';
            document.getElementById('leaveType').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addLeaveModal'));
            modal.show();
        }
        function saveLeave() {
            const l = {
                employeeIndex: parseInt(document.getElementById('leaveEmployee').value),
                startDate: document.getElementById('leaveStart').value,
                endDate: document.getElementById('leaveEnd').value,
                type: document.getElementById('leaveType').value,
                status: currentLeaveEdit === -1 ? 'Pending' : leaves[currentLeaveEdit].status,
            };
            if (currentLeaveEdit === -1) {
                leaves.push(l);
                addNotification('admin', `New leave request from ${employees[l.employeeIndex].name}`);
            } else {
                leaves[currentLeaveEdit] = l;
                addNotification('admin', `Leave updated for ${employees[l.employeeIndex].name}`);
            }
            localStorage.setItem('leaves', JSON.stringify(leaves));
            renderLeaves();
            bootstrap.Modal.getInstance(document.getElementById('addLeaveModal')).hide();
        }
        function renderLeaves() {
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            let filteredLeaves = leaves;
            if (user.role === 'employee') {
                filteredLeaves = leaves.filter(l => l.employeeIndex === user.index);
            }
            document.getElementById('leavesTable').innerHTML = filteredLeaves.map((l, i) => `
                <tr>
                    <td>${employees[l.employeeIndex]?.name || 'Unknown'}</td>
                    <td>${l.startDate}</td>
                    <td>${l.endDate}</td>
                    <td>${l.type}</td>
                    <td>${l.status}</td>
                    <td>
                        ${user.role === 'admin' ? `
                            <button class="btn btn-sm btn-success" onclick="approveLeave(${i})">Approve</button>
                            <button class="btn btn-sm btn-danger" onclick="rejectLeave(${i})">Reject</button>
                        ` : ''}
                        <button class="btn btn-sm btn-primary" onclick="showEditLeaveModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLeave(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
            const pending = leaves.filter(l => l.status === 'Pending').length;
            document.getElementById('pendingLeaves').textContent = pending;
        }
        function showEditLeaveModal(i) {
            currentLeaveEdit = i;
            document.getElementById('addLeaveModalLabel').innerHTML = 'Edit Leave';
            const l = leaves[i];
            document.getElementById('leaveEmployee').value = l.employeeIndex;
            document.getElementById('leaveStart').value = l.startDate;
            document.getElementById('leaveEnd').value = l.endDate;
            document.getElementById('leaveType').value = l.type;
            populateEmployeeSelect('leaveEmployee');
            const modal = new bootstrap.Modal(document.getElementById('addLeaveModal'));
            modal.show();
        }
        function approveLeave(i) {
            leaves[i].status = 'Approved';
            localStorage.setItem('leaves', JSON.stringify(leaves));
            renderLeaves();
            addNotification('admin', `Leave approved for ${employees[leaves[i].employeeIndex].name}`);
        }
        function rejectLeave(i) {
            leaves[i].status = 'Rejected';
            localStorage.setItem('leaves', JSON.stringify(leaves));
            renderLeaves();
            addNotification(leaves[i].employeeIndex, `Leave rejected`);
        }
        function deleteLeave(i) {
            if (confirm('Delete?')) {
                leaves.splice(i, 1);
                localStorage.setItem('leaves', JSON.stringify(leaves));
                renderLeaves();
            }
        }

        // Benefits
        function showAddBenefitModal() {
            currentBenefitEdit = -1;
            document.getElementById('addBenefitModalLabel').innerHTML = 'Add Benefit Plan';
            document.getElementById('benefitName').value = '';
            document.getElementById('benefitDesc').value = '';
            document.getElementById('benefitCost').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addBenefitModal'));
            modal.show();
        }
        function saveBenefit() {
            const b = {
                id: currentBenefitEdit === -1 ? Date.now() : benefitPlans[currentBenefitEdit].id,
                name: document.getElementById('benefitName').value,
                description: document.getElementById('benefitDesc').value,
                cost: parseFloat(document.getElementById('benefitCost').value),
            };
            if (currentBenefitEdit === -1) {
                benefitPlans.push(b);
                addNotification('admin', `New benefit plan added: ${b.name}`);
            } else {
                benefitPlans[currentBenefitEdit] = b;
                addNotification('admin', `Benefit plan updated: ${b.name}`);
            }
            localStorage.setItem('benefitPlans', JSON.stringify(benefitPlans));
            renderBenefits();
            bootstrap.Modal.getInstance(document.getElementById('addBenefitModal')).hide();
        }
        function renderBenefits() {
            document.getElementById('benefitTable').innerHTML = benefitPlans.map((b, i) => `
                <tr>
                    <td>${b.id}</td>
                    <td>${b.name}</td>
                    <td>${b.description}</td>
                    <td>R${b.cost}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditBenefitModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBenefit(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        function showEditBenefitModal(i) {
            currentBenefitEdit = i;
            document.getElementById('addBenefitModalLabel').innerHTML = 'Edit Benefit Plan';
            const b = benefitPlans[i];
            document.getElementById('benefitName').value = b.name;
            document.getElementById('benefitDesc').value = b.description;
            document.getElementById('benefitCost').value = b.cost;
            const modal = new bootstrap.Modal(document.getElementById('addBenefitModal'));
            modal.show();
        }
        function deleteBenefit(i) {
            if (confirm('Delete?')) {
                benefitPlans.splice(i, 1);
                localStorage.setItem('benefitPlans', JSON.stringify(benefitPlans));
                renderBenefits();
            }
        }

        // Training
        function showAddCourseModal() {
            currentCourseEdit = -1;
            document.getElementById('addCourseModalLabel').innerHTML = 'Add Course';
            document.getElementById('courseName').value = '';
            document.getElementById('courseDesc').value = '';
            document.getElementById('courseQuestions').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addCourseModal'));
            modal.show();
        }
        function saveCourse() {
            let questions = [];
            try {
                questions = JSON.parse(document.getElementById('courseQuestions').value || '[]');
            } catch (e) {
                alert('Invalid JSON for questions');
                return;
            }
            const c = {
                id: currentCourseEdit === -1 ? Date.now() : courses[currentCourseEdit].id,
                name: document.getElementById('courseName').value,
                description: document.getElementById('courseDesc').value,
                questions
            };
            if (currentCourseEdit === -1) {
                courses.push(c);
                addNotification('admin', `New course added: ${c.name}`);
            } else {
                courses[currentCourseEdit] = c;
                addNotification('admin', `Course updated: ${c.name}`);
            }
            localStorage.setItem('courses', JSON.stringify(courses));
            renderTraining();
            bootstrap.Modal.getInstance(document.getElementById('addCourseModal')).hide();
        }
        function renderTraining() {
            document.getElementById('courseTable').innerHTML = courses.map((c, i) => `
                <tr>
                    <td>${c.id}</td>
                    <td>${c.name}</td>
                    <td>${c.description}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditCourseModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCourse(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        function showEditCourseModal(i) {
            currentCourseEdit = i;
            document.getElementById('addCourseModalLabel').innerHTML = 'Edit Course';
            const c = courses[i];
            document.getElementById('courseName').value = c.name;
            document.getElementById('courseDesc').value = c.description;
            document.getElementById('courseQuestions').value = JSON.stringify(c.questions, null, 2);
            const modal = new bootstrap.Modal(document.getElementById('addCourseModal'));
            modal.show();
        }
        function deleteCourse(i) {
            if (confirm('Delete?')) {
                courses.splice(i, 1);
                localStorage.setItem('courses', JSON.stringify(courses));
                renderTraining();
            }
        }

        // Compliance
        function showAddCertificationModal() {
            currentCertEdit = -1;
            document.getElementById('addCertificationModalLabel').innerHTML = 'Add Certification';
            populateEmployeeSelect('certEmployee');
            document.getElementById('certName').value = '';
            document.getElementById('certExpiry').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addCertificationModal'));
            modal.show();
        }
        function saveCertification() {
            const cert = {
                employeeIndex: parseInt(document.getElementById('certEmployee').value),
                name: document.getElementById('certName').value,
                expiryDate: document.getElementById('certExpiry').value,
            };
            if (currentCertEdit === -1) {
                certifications.push(cert);
                addNotification('admin', `New certification for ${employees[cert.employeeIndex].name}`);
            } else {
                certifications[currentCertEdit] = cert;
                addNotification('admin', `Certification updated for ${employees[cert.employeeIndex].name}`);
            }
            localStorage.setItem('certifications', JSON.stringify(certifications));
            renderCompliance();
            renderDashboard();
            bootstrap.Modal.getInstance(document.getElementById('addCertificationModal')).hide();
        }
        function renderCompliance() {
            const now = new Date();
            const expiring = certifications.filter(c => new Date(c.expiryDate) < new Date(now.getFullYear(), now.getMonth() + 3)).length;
            document.getElementById('expiringCerts').textContent = expiring;
            document.getElementById('certificationTable').innerHTML = certifications.map((c, i) => `
                <tr>
                    <td>${employees[c.employeeIndex]?.name || 'Unknown'}</td>
                    <td>${c.name}</td>
                    <td>${c.expiryDate}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditCertificationModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCertification(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        function showEditCertificationModal(i) {
            currentCertEdit = i;
            document.getElementById('addCertificationModalLabel').innerHTML = 'Edit Certification';
            const cert = certifications[i];
            document.getElementById('certEmployee').value = cert.employeeIndex;
            document.getElementById('certName').value = cert.name;
            document.getElementById('certExpiry').value = cert.expiryDate;
            populateEmployeeSelect('certEmployee');
            const modal = new bootstrap.Modal(document.getElementById('addCertificationModal'));
            modal.show();
        }
        function deleteCertification(i) {
            if (confirm('Delete?')) {
                certifications.splice(i, 1);
                localStorage.setItem('certifications', JSON.stringify(certifications));
                renderCompliance();
                renderDashboard();
            }
        }

        // Media Approval
        function showUploadMediaModal() {
            document.getElementById('mediaTitle').value = '';
            document.getElementById('mediaDesc').value = '';
            document.getElementById('mediaFile').value = '';
            const modal = new bootstrap.Modal(document.getElementById('uploadMediaModal'));
            modal.show();
        }
        function uploadMedia() {
            const title = document.getElementById('mediaTitle').value;
            const desc = document.getElementById('mediaDesc').value;
            const file = document.getElementById('mediaFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mediaContents.push({id: Date.now(), title, desc, fileData: e.target.result, status: 'Pending', uploader: currentUser.role === 'admin' ? 'Admin' : employees[currentUser.index].name});
                    localStorage.setItem('mediaContents', JSON.stringify(mediaContents));
                    addNotification('admin', `New media uploaded: ${title}`);
                    renderMediaApproval();
                    bootstrap.Modal.getInstance(document.getElementById('uploadMediaModal')).hide();
                };
                reader.readAsDataURL(file);
            }
        }
        function renderMediaApproval() {
            document.getElementById('mediaTable').innerHTML = mediaContents.map((m, i) => `
                <tr>
                    <td>${m.id}</td>
                    <td>${m.title}</td>
                    <td>${m.uploader}</td>
                    <td>${m.status}</td>
                    <td>
                        ${currentUser.role === 'admin' ? `
                            <button class="btn btn-sm btn-success" onclick="approveMedia(${i})">Approve</button>
                            <button class="btn btn-sm btn-danger" onclick="rejectMedia(${i})">Reject</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        function approveMedia(i) {
            mediaContents[i].status = 'Approved';
            localStorage.setItem('mediaContents', JSON.stringify(mediaContents));
            addNotification(mediaContents[i].uploader === 'Admin' ? 'admin' : mediaContents[i].uploader, 'Media approved');
            renderMediaApproval();
        }
        function rejectMedia(i) {
            mediaContents[i].status = 'Rejected';
            localStorage.setItem('mediaContents', JSON.stringify(mediaContents));
            addNotification(mediaContents[i].uploader === 'Admin' ? 'admin' : mediaContents[i].uploader, 'Media rejected');
            renderMediaApproval();
        }

        // Reports
        function exportToExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            XLSX.writeFile(wb, filename + '.xlsx');
        }
        function renderReports() {
            // No specific render, just exports
        }

        // Audit Trail
        function logAudit(action, details) {
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const entry = {
                time: new Date().toLocaleString(),
                user: user.role === 'admin' ? 'admin' : employees[user.index]?.name || 'unknown',
                action,
                details
            };
            auditLog.push(entry);
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
        }
        function renderAudit() {
            const tbody = document.getElementById('auditTable');
            tbody.innerHTML = auditLog.slice(-50).map(a => `
                <tr>
                    <td>${a.time}</td>
                    <td>${a.user}</td>
                    <td>${a.action}</td>
                    <td>${a.details}</td>
                </tr>
            `).join('');
        }

        // My Profile
        function renderMyProfile() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            document.getElementById('profileName').textContent = emp.name;
            document.getElementById('profileEmail').textContent = emp.email;
            document.getElementById('profilePhone').textContent = emp.phone;
            document.getElementById('profileSalary').textContent = `R${emp.salary.toFixed(2)}`;
            document.getElementById('profileTax').textContent = emp.taxNumber || '-';
            document.getElementById('profileUIF').textContent = emp.uifNumber || '-';
            document.getElementById('profilePic').src = emp.profilePic || 'https://placehold.co/150x150';
            // Benefits
            const benList = document.getElementById('profileBenefits');
            benList.innerHTML = '';
            if (emp.enrolledBenefits && emp.enrolledBenefits.length) {
                emp.enrolledBenefits.forEach(bId => {
                    const b = benefitPlans.find(x => x.id === bId);
                    if (b) {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = `${b.name} â€“ R${b.cost.toFixed(2)}/month`;
                        benList.appendChild(li);
                    }
                });
            } else {
                benList.innerHTML = '<li class="list-group-item">None enrolled</li>';
            }
            // Certs
            const certList = document.getElementById('profileCerts');
            certList.innerHTML = '';
            const myCerts = certifications.filter(c => c.employeeIndex === user.index);
            if (myCerts.length) {
                myCerts.forEach(c => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `<strong>${c.name}</strong> â€“ expires ${c.expiryDate}`;
                    certList.appendChild(li);
                });
            } else {
                certList.innerHTML = '<li class="list-group-item">No certificates</li>';
            }
        }
        document.getElementById('profilePicUpload').addEventListener('change', uploadProfilePic);
        function uploadProfilePic(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                alert('Please upload a valid image file.');
                event.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('cropImage').src = e.target.result;
                const modal = new bootstrap.Modal(document.getElementById('cropModal'));
                modal.show();
                const image = document.getElementById('cropImage');
                let cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.8
                });
                document.getElementById('cropConfirm').onclick = function() {
                    const canvas = cropper.getCroppedCanvas({ width: 150, height: 150 });
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    const user = JSON.parse(localStorage.getItem('currentUser'));
                    employees[user.index].profilePic = dataUrl;
                    localStorage.setItem('employees', JSON.stringify(employees));
                    renderMyProfile();
                    modal.hide();
                    cropper.destroy();
                    event.target.value = '';
                    alert('Profile picture updated!');
                };
                document.getElementById('cropCancel').onclick = function() {
                    modal.hide();
                    cropper.destroy();
                    event.target.value = '';
                };
            };
            reader.readAsDataURL(file);
        }
        function showEditMyProfile() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            document.getElementById('editName').value = emp.name;
            document.getElementById('editEmail').value = emp.email;
            document.getElementById('editPhone').value = emp.phone;
            const modal = new bootstrap.Modal(document.getElementById('editMyProfileModal'));
            modal.show();
        }
        function saveMyProfile() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const idx = user.index;
            employees[idx].name = document.getElementById('editName').value;
            employees[idx].email = document.getElementById('editEmail').value;
            employees[idx].phone = document.getElementById('editPhone').value;
            const pwd = document.getElementById('editPassword').value;
            if (pwd) employees[idx].password = pwd;
            localStorage.setItem('employees', JSON.stringify(employees));
            renderMyProfile();
            bootstrap.Modal.getInstance(document.getElementById('editMyProfileModal')).hide();
        }

        // My Benefits
        function renderMyBenefits() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            let totalCost = 0;
            const tbody = document.getElementById('myBenefitTable');
            tbody.innerHTML = benefitPlans.map(b => {
                const enrolled = emp.enrolledBenefits?.includes(b.id) || false;
                if (enrolled) totalCost += b.cost;
                return `
                    <tr>
                        <td>${b.name}</td>
                        <td>${b.description}</td>
                        <td>R${b.cost.toFixed(2)}</td>
                        <td>${enrolled ? 'Enrolled' : 'Available'}</td>
                        <td>
                            <button class="btn btn-sm ${enrolled ? 'btn-danger' : 'btn-success'}" onclick="${enrolled ? 'unenrollBenefit' : 'enrollBenefit'}(${b.id})">${enrolled ? 'Unenroll' : 'Enroll'}</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('totalBenefitsCost').textContent = `R${totalCost.toFixed(2)}`;
        }
        function enrollBenefit(id) {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            if (!emp.enrolledBenefits) emp.enrolledBenefits = [];
            if (!emp.enrolledBenefits.includes(id)) {
                emp.enrolledBenefits.push(id);
                localStorage.setItem('employees', JSON.stringify(employees));
                addNotification('admin', `${emp.name} enrolled in benefit ${id}`);
                renderMyBenefits();
            }
        }
        function unenrollBenefit(id) {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            emp.enrolledBenefits = emp.enrolledBenefits.filter(b => b !== id);
            localStorage.setItem('employees', JSON.stringify(employees));
            addNotification('admin', `${emp.name} unenrolled from benefit ${id}`);
            renderMyBenefits();
        }

        // My Training
        function renderMyTraining() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            document.getElementById('myCourseTable').innerHTML = courses.map(c => {
                const enrolled = emp.enrolledCourses?.includes(c.id) || false;
                return `
                    <tr>
                        <td>${c.name}</td>
                        <td>${c.description}</td>
                        <td>${enrolled ? 'Enrolled' : 'Available'}</td>
                        <td>
                            <button class="btn btn-sm ${enrolled ? 'btn-danger' : 'btn-success'}" onclick="${enrolled ? 'unenrollCourse' : 'enrollCourse'}(${c.id})">${enrolled ? 'Unenroll' : 'Enroll'}</button>
                            ${enrolled && c.questions.length > 0 ? '<button class="btn btn-sm btn-info" onclick="startQuiz('+c.id+')">Take Quiz</button>' : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        function enrollCourse(id) {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            if (!emp.enrolledCourses) emp.enrolledCourses = [];
            if (!emp.enrolledCourses.includes(id)) {
                emp.enrolledCourses.push(id);
                localStorage.setItem('employees', JSON.stringify(employees));
                addNotification('admin', `${emp.name} enrolled in course ${id}`);
                renderMyTraining();
            }
        }
        function unenrollCourse(id) {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            emp.enrolledCourses = emp.enrolledCourses.filter(c => c !== id);
            localStorage.setItem('employees', JSON.stringify(employees));
            addNotification('admin', `${emp.name} unenrolled from course ${id}`);
            renderMyTraining();
        }
        function startQuiz(courseId) {
            currentQuizCourseId = courseId;
            const course = courses.find(c => c.id === courseId);
            document.getElementById('quizTitle').textContent = `Quiz for ${course.name}`;
            const quizBody = document.getElementById('quizBody');
            quizBody.innerHTML = course.questions.map((q, idx) => `
                <div class="mb-3">
                    <label class="form-label">${q.question}</label>
                    ${q.options ? q.options.map((opt, oIdx) => `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="q${idx}" value="${oIdx}">
                            <label class="form-check-label">${opt}</label>
                        </div>
                    `).join('') : ''}
                </div>
            `).join('');
            const modal = new bootstrap.Modal(document.getElementById('quizModal'));
            modal.show();
        }
        function submitQuiz() {
            const course = courses.find(c => c.id === currentQuizCourseId);
            let score = 0;
            course.questions.forEach((q, idx) => {
                const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                if (selected && parseInt(selected.value) === q.correct) score++;
            });
            alert(`Your score: ${score} / ${course.questions.length}`);
            bootstrap.Modal.getInstance(document.getElementById('quizModal')).hide();
        }

        // Open Jobs
        function renderOpenJobs() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            document.getElementById('openJobTable').innerHTML = jobs.map(j => {
                const applied = j.applications.includes(user.index);
                return `
                    <tr>
                        <td>${j.title}</td>
                        <td>${j.branch}</td>
                        <td>${j.description}</td>
                        <td>${applied ? 'Applied' : 'Open'}</td>
                        <td>
                            <button class="btn btn-sm ${applied ? 'btn-secondary disabled' : 'btn-primary'}" onclick="applyJob(${j.id})" ${applied ? 'disabled' : ''}>${applied ? 'Applied' : 'Apply'}</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        function applyJob(id) {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const job = jobs.find(j => j.id === id);
            if (job && !job.applications.includes(user.index)) {
                job.applications.push(user.index);
                localStorage.setItem('jobs', JSON.stringify(jobs));
                addNotification('admin', `${employees[user.index].name} applied for ${job.title}`);
                renderOpenJobs();
            }
        }

        // Dashboard Renders
        function renderDashboard() {
            document.getElementById('totalEmployees').textContent = employees.length;
            const totalPayroll = payrolls.reduce((sum, p) => sum + p.net, 0);
            document.getElementById('totalPayrollCost').textContent = `R${totalPayroll.toFixed(2)}`;
            const avgSalary = employees.length ? (employees.reduce((sum, e) => sum + e.salary, 0) / employees.length).toFixed(0) : 0;
            document.getElementById('avgSalary').textContent = `R${avgSalary}`;
            // Compliance score (simulated)
            const compliance = Math.round(Math.random() * 100);
            document.getElementById('complianceScore').textContent = `${compliance}%`;
            // Chart
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Employees', 'Open Positions', 'Avg Performance', 'Pending Leaves'],
                    datasets: [{ label: 'Metrics', data: [employees.length, jobs.length, parseFloat(document.getElementById('avgPerformance').textContent), parseInt(document.getElementById('pendingLeaves').textContent)] }]
                }
            });
        }
        function renderMyDashboard() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            document.getElementById('myName').textContent = emp.name;
            const myReviews = reviews.filter(r => r.employeeIndex === user.index);
            const myAvg = myReviews.length ? (myReviews.reduce((sum, r) => sum + r.score, 0) / myReviews.length).toFixed(1) : 0;
            document.getElementById('myAvgPerformance').textContent = `${myAvg}/5`;
            const myRecentP = payrolls.filter(p => p.employeeIndex === user.index).slice(-1)[0];
            document.getElementById('recentPayslips').textContent = myRecentP ? `Last: ${myRecentP.period} - R${myRecentP.net.toFixed(2)}` : 'No recent payslips';
            // Charts
            const perfCtx = document.getElementById('myPerformanceChart').getContext('2d');
            new Chart(perfCtx, { type: 'doughnut', data: { labels: ['Performance'], datasets: [{ data: [myAvg * 20] }] } });
            const leaveCtx = document.getElementById('myLeaveChart').getContext('2d');
            new Chart(leaveCtx, { type: 'pie', data: { labels: ['Approved', 'Pending'], datasets: [{ data: [1, 0] }] } });
        }

        // Wellness Module
        function renderWellnessAdmin() {
            const avgScore = employees.length ? (employees.reduce((sum, e) => sum + (e.wellness?.score || 0), 0) / employees.length).toFixed(1) : 0;
            document.getElementById('avgWellnessScore').textContent = `${avgScore}/10`;
            document.getElementById('activeGoals').textContent = employees.reduce((sum, e) => sum + (e.wellness?.goals?.filter(g => !g.completed).length || 0), 0);
            document.getElementById('completedSurveys').textContent = employees.reduce((sum, e) => sum + (e.wellness?.surveys?.length || 0), 0);
            document.getElementById('highRiskAlerts').textContent = employees.filter(e => (e.wellness?.metrics?.stress || 0) > 8).length;
            document.getElementById('wellnessAdminTable').innerHTML = employees.map((e, i) => {
                const score = e.wellness?.score || 0;
                const goalsProgress = e.wellness?.goals?.filter(g => g.completed).length || 0;
                const totalGoals = e.wellness?.goals?.length || 0;
                const alerts = (e.wellness?.metrics?.stress || 0) > 8 ? 'High Stress' : 'None';
                const lastSurvey = e.wellness?.surveys?.slice(-1)[0]?.date || 'N/A';
                return `
                    <tr>
                        <td>${e.name}</td>
                        <td>${score}/10</td>
                        <td>${lastSurvey}</td>
                        <td>${goalsProgress}/${totalGoals}</td>
                        <td>${alerts}</td>
                        <td><button class="btn btn-sm btn-info" onclick="viewEmployeeWellness(${i})">View Details</button></td>
                    </tr>
                `;
            }).join('');
            const adminCtx = document.getElementById('wellnessAdminChart').getContext('2d');
            new Chart(adminCtx, { 
                type: 'line', 
                data: { 
                    labels: employees.map(e => e.name), 
                    datasets: [{ label: 'Wellness Score', data: employees.map(e => e.wellness?.score || 0) }] 
                } 
            });
        }
        function renderMyWellness() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            const wellness = emp.wellness || { score: 0, surveys: [], goals: [], metrics: { stress: 5, energy: 5, mood: 5 } };
            document.getElementById('myWellnessScore').textContent = `${wellness.score}/10`;
            document.getElementById('myWellnessProgress').style.width = `${(wellness.score / 10) * 100}%`;
            const goalsList = document.getElementById('myActiveGoals');
            goalsList.innerHTML = wellness.goals.filter(g => !g.completed).map(g => `<li>${g.title} <small>Due: ${g.targetDate}</small></li>`).join('') || '<li>No active goals</li>';
            const activityList = document.getElementById('myWellnessActivity');
            activityList.innerHTML = wellness.surveys.slice(-3).map(s => `<li class="list-group-item">${s.date}: Survey Completed (Score: ${s.score}/10)</li>`).join('') || '<li class="list-group-item">No recent activity</li>';
            const myCtx = document.getElementById('myWellnessChart').getContext('2d');
            new Chart(myCtx, { 
                type: 'radar', 
                data: { 
                    labels: ['Stress', 'Energy', 'Mood'], 
                    datasets: [{ data: [wellness.metrics.stress, wellness.metrics.energy, wellness.metrics.mood] }] 
                } 
            });
        }
        function showSurveyModal() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const survey = wellnessSurveys[0];
            document.getElementById('surveyTitle').textContent = survey.name;
            const questionsDiv = document.getElementById('surveyQuestions');
            questionsDiv.innerHTML = survey.questions.map((q, idx) => `
                <div class="survey-question">
                    <label class="form-label">${q.question}</label>
                    <input type="range" class="form-range" min="1" max="10" name="q${idx}" required>
                    <small>1 (Low) - 10 (High)</small>
                </div>
            `).join('');
            const modal = new bootstrap.Modal(document.getElementById('surveyModal'));
            modal.show();
        }
        function submitSurvey() {
            const form = document.getElementById('surveyForm');
            const formData = new FormData(form);
            let totalScore = 0;
            let questionCount = 0;
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('q')) {
                    totalScore += parseInt(value);
                    questionCount++;
                }
            }
            const avgScore = totalScore / questionCount;
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            if (!emp.wellness) emp.wellness = { score: 0, surveys: [], goals: [], metrics: {} };
            emp.wellness.score = avgScore;
            emp.wellness.surveys.push({ date: new Date().toLocaleDateString(), score: avgScore });
            emp.wellness.metrics = { 
                stress: parseInt(formData.get('q0') || 5), 
                energy: parseInt(formData.get('q1') || 5), 
                mood: parseInt(formData.get('q2') || 5) 
            };
            localStorage.setItem('employees', JSON.stringify(employees));
            addNotification(user.index, 'Wellness survey submitted!');
            if (avgScore < 4) addNotification('admin', `${emp.name} has low wellness score (${avgScore}/10)`);
            bootstrap.Modal.getInstance(document.getElementById('surveyModal')).hide();
            renderMyWellness();
            renderWellnessAdmin();
        }
        function showAddResourceModal() {
            const modal = new bootstrap.Modal(document.getElementById('addResourceModal'));
            modal.show();
        }
        function saveResource() {
            const resource = {
                id: Date.now(),
                title: document.getElementById('resourceTitle').value,
                desc: document.getElementById('resourceDesc').value,
                link: document.getElementById('resourceLink').value,
                category: document.getElementById('resourceCategory').value
            };
            wellnessResources.push(resource);
            localStorage.setItem('wellnessResources', JSON.stringify(wellnessResources));
            addNotification('admin', `New wellness resource added: ${resource.title}`);
            bootstrap.Modal.getInstance(document.getElementById('addResourceModal')).hide();
            renderResourcesList();
        }
        function showResourcesModal() {
            renderResourcesList();
            const modal = new bootstrap.Modal(document.getElementById('resourcesModal'));
            modal.show();
        }
        function renderResourcesList() {
            document.getElementById('resourcesList').innerHTML = wellnessResources.map(r => `
                <div class="card resource-card mb-3">
                    <div class="card-body">
                        <h6>${r.title}</h6>
                        <p class="card-text">${r.desc}</p>
                        ${r.link ? `<a href="${r.link}" target="_blank" class="btn btn-sm btn-primary">Access Resource</a>` : ''}
                        <span class="badge bg-secondary float-end">${r.category}</span>
                    </div>
                </div>
            `).join('');
        }
        function showAddGoalModal() {
            const modal = new bootstrap.Modal(document.getElementById('addGoalModal'));
            modal.show();
        }
        function saveGoal() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const emp = employees[user.index];
            const goal = {
                id: Date.now(),
                title: document.getElementById('goalTitle').value,
                desc: document.getElementById('goalDesc').value,
                targetDate: document.getElementById('goalTargetDate').value,
                category: document.getElementById('goalCategory').value,
                completed: false,
                progress: 0
            };
            if (!emp.wellness) emp.wellness = { score: 0, surveys: [], goals: [], metrics: {} };
            emp.wellness.goals.push(goal);
            localStorage.setItem('employees', JSON.stringify(employees));
            addNotification(user.index, `New wellness goal added: ${goal.title}`);
            bootstrap.Modal.getInstance(document.getElementById('addGoalModal')).hide();
            renderMyWellness();
        }
        function requestCounseling() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            addNotification('admin', `Counseling request from ${employees[user.index].name}`);
            alert('Counseling request submitted. HR will contact you soon.');
        }
        function showAddSurveyModal() {
            document.getElementById('surveyName').value = '';
            document.getElementById('surveyDesc').value = '';
            document.getElementById('surveyQuestionInputs').innerHTML = '';
            surveyQuestionCounter = 0;
            addSurveyQuestion();
            const modal = new bootstrap.Modal(document.getElementById('addSurveyModal'));
            modal.show();
        }
        function addSurveyQuestion() {
            const inputsDiv = document.getElementById('surveyQuestionInputs');
            const idx = surveyQuestionCounter++;
            inputsDiv.innerHTML += `
                <div class="question-input mb-3 border p-3 rounded">
                    <input type="text" placeholder="Question ${idx + 1}" class="form-control mb-2" name="q${idx}">
                    <select class="form-control mb-2" name="type${idx}">
                        <option value="scale">Scale (1-10)</option>
                        <option value="multiple">Multiple Choice</option>
                    </select>
                    <textarea placeholder="Options (comma-separated for multiple choice)" class="form-control" name="opts${idx}"></textarea>
                    <button type="button" class="btn btn-sm btn-danger mt-2" onclick="this.parentElement.remove()">Remove</button>
                </div>
            `;
        }
        function saveSurvey() {
            const name = document.getElementById('surveyName').value;
            const desc = document.getElementById('surveyDesc').value;
            const questions = [];
            document.querySelectorAll('.question-input').forEach(qDiv => {
                const question = qDiv.querySelector('input[name^=q]').value;
                const type = qDiv.querySelector('select[name^=type]').value;
                const optsInput = qDiv.querySelector('textarea[name^=opts]').value;
                const options = optsInput ? optsInput.split(',').map(o => o.trim()) : [];
                if (question) questions.push({ question, type, options });
            });
            const survey = { id: Date.now(), name, desc, questions };
            wellnessSurveys.push(survey);
            localStorage.setItem('wellnessSurveys', JSON.stringify(wellnessSurveys));
            addNotification('admin', `New survey created: ${name}`);
            bootstrap.Modal.getInstance(document.getElementById('addSurveyModal')).hide();
        }
        function exportWellnessReport() {
            const reportData = employees.map(e => ({
                name: e.name,
                wellnessScore: e.wellness?.score || 0,
                goalsCompleted: e.wellness?.goals?.filter(g => g.completed).length || 0,
                lastSurvey: e.wellness?.surveys?.slice(-1)[0]?.date || 'N/A'
            }));
            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Wellness Report');
            XLSX.writeFile(wb, 'wellness-report.xlsx');
        }
        function viewEmployeeWellness(index) {
            alert(`Viewing wellness details for ${employees[index].name}. (Detailed view modal can be implemented here)`);
        }

        // Onboarding
        function saveOnboardingEmployee() {
            const password = document.getElementById('onbPassword').value;
            const confirm = document.getElementById('onbConfirmPassword').value;
            if (password !== confirm) {
                alert('Passwords do not match');
                return;
            }
            const newEmp = {
                id: Date.now(),
                name: document.getElementById('onbName').value,
                position: document.getElementById('onbPosition').value,
                branch: document.getElementById('onbBranch').value,
                email: document.getElementById('onbEmail').value,
                phone: document.getElementById('onbPhone').value,
                salary: 0, // Set by HR
                username: document.getElementById('onbUsername').value,
                password,
                taxNumber: document.getElementById('onbTaxNumber').value,
                uifNumber: document.getElementById('onbUIF').value,
                enrolledBenefits: [],
                enrolledCourses: [],
                wellness: { score: 0, surveys: [], goals: [], metrics: { stress: 5, energy: 5, mood: 5 } },
                index: employees.length
            };
            employees.push(newEmp);
            localStorage.setItem('employees', JSON.stringify(employees));
            addNotification('admin', `New onboarding: ${newEmp.name}`);
            bootstrap.Modal.getInstance(document.getElementById('onboardingModal')).hide();
            alert('Onboarding complete! HR will set your salary and approve.');
        }

        // On Load
        document.addEventListener('DOMContentLoaded', () => {
            populateOnboardingSelects();
            if (localStorage.getItem('currentUser')) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                initApp();
                showSection('dashboard'); // Default
            }
            // Event listeners for modals
            const modals = ['addEmployeeModal', 'addPayrollModal', 'addJobModal', 'addReviewModal', 'addLeaveModal', 'addBenefitModal', 'addCourseModal', 'addCertificationModal', 'uploadMediaModal', 'editMyProfileModal', 'cropModal', 'quizModal', 'surveyModal', 'addResourceModal', 'resourcesModal', 'addGoalModal', 'addSurveyModal', 'onboardingModal', 'uploadHandbookModal', 'payslipModal', 'taxLiabilityModal', 'notificationsModal'];
            modals.forEach(mId => {
                const modalEl = document.getElementById(mId);
                if (modalEl) {
                    modalEl.addEventListener('hidden.bs.modal', () => {
                        // Reset forms if needed
                    });
                }
            });
        });
    </script>
</body>
</html>
