<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Comprehensive HRMS - Allos Connect (Sage-inspired)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f8ff; color: #333; box-shadow: 0 0 20px #4169E1; }
        .sidebar { background-color: #e6f3ff; border-right: 1px solid #87ceeb; height: 100vh; position: fixed; width: 250px; padding: 20px; overflow-y: auto; transition: width 0.3s ease; z-index: 1000; box-shadow: 0 0 20px #4169E1; }
        .sidebar.collapsed { width: 60px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link { color: #001f3f; font-weight: 500; margin-bottom: 10px; padding: 10px; transition: all 0.2s; }
        .sidebar .nav-link:hover { color: #4169e1; background-color: #add8e6; border-radius: 5px; }
        .sidebar .nav-link.active { color: #4169e1; background-color: #b0e0e6; border-radius: 5px; }
        .content { margin-left: 250px; padding: 40px; transition: margin-left 0.3s ease; background-color: #f8fbff; box-shadow: 0 0 20px #4169E1; }
        .content.expanded { margin-left: 60px; }
        .card-metric { background-color: #ffffff; border: 1px solid #add8e6; box-shadow: 0 4px 15px rgba(135,206,235,0.2), 0 0 10px #4169E1; border-radius: 10px; transition: transform 0.2s; }
        .card-metric:hover { transform: translateY(-5px); }
        .table { background-color: #ffffff; box-shadow: 0 2px 10px rgba(135,206,235,0.1), 0 0 10px #4169E1; border-radius: 10px; overflow: hidden; border: 1px solid #e6f3ff; }
        .modal-content { border-radius: 15px; box-shadow: 0 5px 20px rgba(65,105,225,0.2), 0 0 10px #4169E1; border: 1px solid #add8e6; }
        .btn-toggle-sidebar { position: fixed; top: 20px; left: 260px; z-index: 1001; transition: left 0.3s ease; background-color: #4169e1; border-color: #4169e1; }
        .btn-toggle-sidebar.expanded { left: 70px; }
        #notificationBell { position: fixed; top: 20px; right: 20px; z-index: 1100; }
        .admin-only { display: block; }
        .employee-only { display: none; }
        .dark-mode { background-color: #001f3f; color: #e0e0e0; }
        .dark-mode .sidebar { background-color: #0d1b2a; border-right: 1px solid #4169e1; }
        .dark-mode .nav-link { color: #add8e6; }
        .dark-mode .nav-link:hover { color: #ffffff; background-color: #4169e1; }
        .dark-mode .content { background-color: #001f3f; }
        .dark-mode .card-metric { background-color: #0d1b2a; border: 1px solid #4169e1; }
        .dark-mode .table { background-color: #0d1b2a; color: #e0e0e0; border: 1px solid #add8e6; }
        .dark-mode .table-striped tbody tr:nth-of-type(odd) { background-color: #1a2b4a; }
        .dark-mode .table thead th { background-color: #4169e1; color: white; }
        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 60px; }
            .btn-toggle-sidebar { left: 70px; }
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="position-fixed top-0 start-0 w-100 h-100 bg-light d-flex align-items-center justify-content-center" style="z-index:2000;">
        <div class="card shadow" style="width:380px;">
            <div class="card-body">
                <h3 class="text-center mb-4"><i class="fas fa-lock me-2"></i>HRMS Login</h3>
                <input type="text" id="username" class="form-control mb-3" placeholder="Username" required>
                <input type="password" id="password" class="form-control mb-3" placeholder="Password" required>
                <button class="btn btn-primary w-100" onclick="login()">Login</button>
                <small class="d-block text-center mt-3 text-muted">Demo: admin/admin123 | john/john123</small>
            </div>
        </div>
    </div>

    <div class="app-container" style="display:none;">
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-primary rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span classJ="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>

        <button class="btn btn-sm btn-primary btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="sidebar">
            <h4 class="mb-4"><i class="fas fa-users me-2"></i><span class="nav-text">HRMS - Allos Connect</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">HR Analytics Dashboard</span></a></li>
                <li class="employee-only"><a href="#myDashboard" class="nav-link" onclick="showSection('myDashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">My Dashboard</span></a></li>
                <li class="admin-only"><a href="#employees" class="nav-link" onclick="showSection('employees')"><i class="fas fa-user-friends me-2"></i><span class="nav-text">Employees (HR Core)</span></a></li>
                <li class="employee-only"><a href="#myProfile" class="nav-link" onclick="showSection('myProfile')"><i class="fas fa-user me-2"></i><span class="nav-text">My Profile</span></a></li>
                <li class="admin-only"><a href="#payroll" class="nav-link" onclick="showSection('payroll')"><i class="fas fa-money-check-alt me-2"></i><span class="nav-text">Payroll</span></a></li>
                <li class="employee-only"><a href="#myPayroll" class="nav-link" onclick="showSection('myPayroll')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">My Payslips</span></a></li>
                <li class="admin-only"><a href="#recruitment" class="nav-link" onclick="showSection('recruitment')"><i class="fas fa-briefcase me-2"></i><span class="nav-text">iRecruit</span></a></li>
                <li class="employee-only"><a href="#openJobs" class="nav-link" onclick="showSection('openJobs')"><i class="fas fa-briefcase me-2"></i><span class="nav-text">Job Openings</span></a></li>
                <li><a href="#performance" class="nav-link" onclick="showSection('performance')"><i class="fas fa-chart-line me-2"></i><span class="nav-text">Performance</span></a></li>
                <li><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Time & Attendance</span></a></li>
                <li><a href="#leaves" class="nav-link" onclick="showSection('leaves')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Leaves</span></a></li>
                <li class="admin-only"><a href="#benefits" class="nav-link" onclick="showSection('benefits')"><i class="fas fa-gift me-2"></i><span class="nav-text">Benefits Admin</span></a></li>
                <li class="employee-only"><a href="#myBenefits" class="nav-link" onclick="showSection('myBenefits')"><i class="fas fa-gift me-2"></i><span class="nav-text">My Benefits</span></a></li>
                <li class="admin-only"><a href="#training" class="nav-link" onclick="showSection('training')"><i class="fas fa-graduation-cap me-2"></i><span class="nav-text">Training Admin</span></a></li>
                <li class="employee-only"><a href="#myTraining" class="nav-link" onclick="showSection('myTraining')"><i class="fas fa-graduation-cap me-2"></i><span class="nav-text">My Training</span></a></li>
                <li class="admin-only"><a href="#compliance" class="nav-link" onclick="showSection('compliance')"><i class="fas fa-balance-scale me-2"></i><span class="nav-text">Compliance</span></a></li>
                <li class="admin-only"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">My Workforce Analyzer</span></a></li>
                <li class="admin-only"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="admin-only"><a href="#mediaApproval" class="nav-link" onclick="showSection('mediaApproval')"><i class="fas fa-check-circle me-2"></i><span class="nav-text">Media Approval</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>

        <div class="content">
            <!-- Dashboard (HR Analytics) -->
            <section id="dashboard" class="section">
                <h2>HR Analytics Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Employees</h5><h3 id="totalEmployees">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositions">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Performance</h5><h3 id="avgPerformance">0/5</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeaves">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3 bg-primary text-white"><h5>Compliance</h5><h3 id="complianceScore">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Expiring Certs</h5><h3 id="expiringCerts">0</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4"></canvas>
            </section>

            <!-- Employees Section -->
            <section id="employees" class="section d-none">
                <h2>Employee Management (HR Core)</h2>
                <button class="btn btn-primary" onclick="showAddEmployeeModal()">Add Employee</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Name</th><th>Position</th><th>Branch</th><th>Actions</th></tr></thead>
                    <tbody id="employeeTable"></tbody>
                </table>
            </section>

            <!-- Payroll Section -->
            <section id="payroll" class="section d-none">
                <h2>Payroll</h2>
                <button class="btn btn-primary" onclick="showAddPayrollModal()">Add Payroll Entry</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Employee</th><th>Month</th><th>Salary</th><th>Deductions</th><th>Net</th><th>Actions</th></tr></thead>
                    <tbody id="payrollTable"></tbody>
                </table>
            </section>

            <!-- Recruitment Section -->
            <section id="recruitment" class="section d-none">
                <h2>iRecruit</h2>
                <button class="btn btn-primary" onclick="showAddJobModal()">Add Job</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Title</th><th>Branch</th><th>Applications</th><th>Actions</th></tr></thead>
                    <tbody id="jobTable"></tbody>
                </table>
            </section>

            <!-- Performance Section -->
            <section id="performance" class="section d-none">
                <h2>Performance</h2>
                <button class="btn btn-primary admin-only" onclick="showAddReviewModal()">Add Review</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Employee</th><th>Date</th><th>Score</th><th>Comments</th><th class="admin-only">Actions</th></tr></thead>
                    <tbody id="performanceTable"></tbody>
                </table>
            </section>

            <!-- Attendance Section -->
            <section id="attendance" class="section d-none">
                <h2>Time & Attendance</h2>
                <button class="btn btn-primary" onclick="clockIn()">Clock In</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Employee</th><th>Date</th><th>Status</th><th class="admin-only">Actions</th></tr></thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </section>

            <!-- Leaves Section -->
            <section id="leaves" class="section d-none">
                <h2>Leaves</h2>
                <button class="btn btn-primary" onclick="showAddLeaveModal()">Request Leave</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Employee</th><th>Start Date</th><th>End Date</th><th>Type</th><th>Status</th><th class="admin-only">Actions</th></tr></thead>
                    <tbody id="leavesTable"></tbody>
                </table>
            </section>

            <!-- Benefits Admin -->
            <section id="benefits" class="section d-none">
                <h2>Benefits Admin</h2>
                <button class="btn btn-primary" onclick="showAddBenefitModal()">Add Benefit Plan</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Cost</th><th>Actions</th></tr></thead>
                    <tbody id="benefitTable"></tbody>
                </table>
            </section>

            <!-- Training Admin -->
            <section id="training" class="section d-none">
                <h2>Training Admin</h2>
                <button class="btn btn-primary" onclick="showAddCourseModal()">Add Course</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Actions</th></tr></thead>
                    <tbody id="courseTable"></tbody>
                </table>
            </section>

            <!-- Compliance Section -->
            <section id="compliance" class="section d-none">
                <h2>Compliance</h2>
                <button class="btn btn-primary" onclick="showAddCertificationModal()">Add Certification</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>Employee</th><th>Name</th><th>Expiry Date</th><th>Actions</th></tr></thead>
                    <tbody id="certificationTable"></tbody>
                </table>
            </section>

            <!-- Reports (My Workforce Analyzer) -->
            <section id="reports" class="section d-none">
                <h2>My Workforce Analyzer</h2>
                <button class="btn btn-primary me-2" onclick="exportToExcel(employees, 'employees')">Export Employees</button>
                <button class="btn btn-primary me-2" onclick="exportToExcel(payrolls, 'payrolls')">Export Payrolls</button>
                <button class="btn btn-primary me-2" onclick="exportToExcel(leaves, 'leaves')">Export Leaves</button>
                <button class="btn btn-primary" onclick="exportToExcel(reviews, 'performance')">Export Performance</button>
            </section>

            <!-- Settings -->
            <section id="settings" class="section d-none">
                <h2>Settings</h2>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode(this.checked)">
                    <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
                </div>
            </section>

            <!-- Media Approval Workflow -->
            <section id="mediaApproval" class="section d-none">
                <h2>Media Content Approval</h2>
                <button class="btn btn-primary" onclick="showUploadMediaModal()">Upload Media for Approval</button>
                <table class="table table-striped mt-3">
                    <thead><tr><th>ID</th><th>Title</th><th>Uploader</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="mediaTable"></tbody>
                </table>
            </section>

            <!-- Notifications Modal -->
            <div class="modal fade" id="notificationsModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header"><h5>Alerts & Workflow</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <table class="table"><tbody id="notificationsTable"></tbody></table>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="markAllRead()">Mark All Read</button></div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Employee Modal -->
            <div class="modal fade" id="addEmployeeModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addEmployeeModalLabel">Add Employee</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="empName" placeholder="Name" class="form-control mb-3">
                            <select id="empPosition" class="form-control mb-3"><option>Producer</option><option>Editor</option><option>Marketer</option><option>Admin</option></select>
                            <select id="empBranch" class="form-control mb-3 branch-select"></select>
                            <input id="empEmail" placeholder="Email" class="form-control mb-3">
                            <input id="empPhone" placeholder="Phone" class="form-control mb-3">
                            <input id="empSalary" type="number" placeholder="Salary" class="form-control mb-3">
                            <input id="empUsername" placeholder="Username" class="form-control mb-3">
                            <input id="empPassword" type="password" placeholder="Password" class="form-control mb-3">
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveEmployee()">Save</button></div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Payroll Modal -->
            <div class="modal fade" id="addPayrollModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addPayrollModalLabel">Add Payroll</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <select id="payEmployee" class="form-control mb-3 emp-select" onchange="calculateDeductions()"></select>
                            <input id="payMonth" type="month" class="form-control mb-3" onchange="calculateDeductions()">
                            <input id="paySalary" type="number" placeholder="Salary" class="form-control mb-3" onchange="updateNet()">
                            <input id="payDeductions" type="number" placeholder="Deductions" class="form-control mb-3" onchange="updateNet()">
                            <input id="payNet" type="number" placeholder="Net" class="form-control mb-3" readonly>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="savePayroll()">Save</button></div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Job Modal -->
            <div class="modal fade" id="addJobModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addJobModalLabel">Add Job</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="jobTitle" placeholder="Title" class="form-control mb-3">
                            <select id="jobBranch" class="form-control mb-3 branch-select"></select>
                            <textarea id="jobDesc" placeholder="Description" class="form-control mb-3"></textarea>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveJob()">Save</button></div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Review Modal -->
            <div class="modal fade" id="addReviewModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addReviewModalLabel">Add Review</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <select id="reviewEmployee" class="form-control mb-3 emp-select"></select>
                            <input id="reviewScore" type="number" min="0" max="5" placeholder="Score (0-5)" class="form-control mb-3">
                            <textarea id="reviewComments" placeholder="Comments" class="form-control mb-3"></textarea>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveReview()">Save</button></div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Leave Modal -->
            <div class="modal fade" id="addLeaveModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addLeaveModalLabel">Request Leave</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <select id="leaveEmployee" class="form-control mb-3 emp-select"></select>
                            <input id="leaveStart" type="date" class="form-control mb-3">
                            <input id="leaveEnd" type="date" class="form-control mb-3">
                            <select id="leaveType" class="form-control mb-3"><option>Sick</option><option>Annual</option><option>Maternity</option></select>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveLeave()">Save</button></div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Benefit Modal -->
            <div class="modal fade" id="addBenefitModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addBenefitModalLabel">Add Benefit Plan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="benefitName" placeholder="Name" class="form-control mb-3">
                            <textarea id="benefitDesc" placeholder="Description" class="form-control mb-3"></textarea>
                            <input id="benefitCost" type="number" placeholder="Cost" class="form-control mb-3">
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveBenefit()">Save</button></div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Course Modal -->
            <div class="modal fade" id="addCourseModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addCourseModalLabel">Add Course</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="courseName" placeholder="Name" class="form-control mb-3">
                            <textarea id="courseDesc" placeholder="Description" class="form-control mb-3"></textarea>
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveCourse()">Save</button></div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Certification Modal -->
            <div class="modal fade" id="addCertificationModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5 id="addCertificationModalLabel">Add Certification</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <select id="certEmployee" class="form-control mb-3 emp-select"></select>
                            <input id="certName" placeholder="Name" class="form-control mb-3">
                            <input id="certExpiry" type="date" class="form-control mb-3">
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="saveCertification()">Save</button></div>
                    </div>
                </div>
            </div>

            <!-- Upload Media Modal -->
            <div class="modal fade" id="uploadMediaModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header"><h5>Upload Media</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">
                            <input id="mediaTitle" placeholder="Title" class="form-control mb-3">
                            <textarea id="mediaDesc" placeholder="Description" class="form-control mb-3"></textarea>
                            <input id="mediaFile" type="file" class="form-control mb-3">
                        </div>
                        <div class="modal-footer"><button class="btn btn-primary" onclick="uploadMedia()">Upload</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // === DATA ===
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let payrolls = JSON.parse(localStorage.getItem('payrolls')) || [];
        let jobs = JSON.parse(localStorage.getItem('jobs')) || [];
        let reviews = JSON.parse(localStorage.getItem('reviews')) || [];
        let attendances = JSON.parse(localStorage.getItem('attendances')) || [];
        let leaves = JSON.parse(localStorage.getItem('leaves')) || [];
        let benefitPlans = JSON.parse(localStorage.getItem('benefitPlans')) || [];
        let courses = JSON.parse(localStorage.getItem('courses')) || [];
        let certifications = JSON.parse(localStorage.getItem('certifications')) || [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];
        let settings = JSON.parse(localStorage.getItem('settings')) || { darkMode: false };
        let mediaContents = JSON.parse(localStorage.getItem('mediaContents')) || [];

        const branches = ['Marketing','Production','Sales','Content Creation','Digital Media','Administration','Creative Design'];

        // === LOGIN & ROLE ===
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === 'admin123') {
                localStorage.setItem('currentUser', JSON.stringify({role: 'admin'}));
                finishLogin();
            } else {
                const idx = employees.findIndex(e => e.username === username && e.password === password);
                if (idx !== -1) {
                    localStorage.setItem('currentUser', JSON.stringify({role: 'employee', index: idx}));
                    finishLogin();
                } else {
                    alert('Invalid username or password');
                }
            }
        }

        function finishLogin() {
            document.getElementById('loginContainer').style.display = 'none';
            document.querySelector('.app-container').style.display = 'block';
            initApp();
        }

        function logout() {
            if (confirm('Logout?')) {
                localStorage.removeItem('currentUser');
                location.reload();
            }
        }

        // === ROLE VISIBILITY ===
        function applyRoleRestrictions() {
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = user.role === 'admin' ? 'block' : 'none');
            document.querySelectorAll('.employee-only').forEach(el => el.style.display = user.role === 'employee' ? 'block' : 'none');
        }

        // === NOTIFICATIONS ===
        function addNotification(to, message) {
            notifications.push({id: Date.now(), to, message, date: new Date().toLocaleString(), read: false});
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const count = user.role === 'admin' 
                ? notifications.filter(n => n.to === 'admin' && !n.read).length 
                : notifications.filter(n => n.to === user.index && !n.read).length;
            const badge = document.getElementById('notificationBadge');
            badge.textContent = count;
            badge.style.display = count > 0 ? 'block' : 'none';
        }

        function markAllRead() {
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            notifications.forEach(n => {
                if ((user.role === 'admin' && n.to === 'admin') || n.to === user.index) n.read = true;
            });
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            renderNotifications();
        };

        function markRead(id) {
            const n = notifications.find(x => x.id === id);
            if (n) n.read = true;
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            renderNotifications();
        };

        function renderNotifications() {
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const rel = user.role === 'admin' 
                ? notifications.filter(n => n.to === 'admin') 
                : notifications.filter(n => n.to === user.index);
            document.getElementById('notificationsTable').innerHTML = rel.map(n => `<tr><td>${n.date}</td><td>${n.message}</td><td>${n.read ? '' : '<button class="btn btn-sm btn-secondary" onclick="markRead('+n.id+')">Read</button>'}</td></tr>`).join('');
        }

        // === INIT ===
        function initApp() {
            applyRoleRestrictions();
            populateSelects();
            updateNotificationBadge();
            renderDashboard();
            if (JSON.parse(localStorage.getItem('currentUser') || '{}').role === 'employee') {
                showSection('myDashboard');
                renderMyDashboard();
            } else {
                showSection('dashboard');
            }
            applyDarkMode();
            document.getElementById('darkModeSwitch').checked = settings.darkMode;
        }

        function populateSelects() {
            const branchSelects = document.querySelectorAll('.branch-select');
            branchSelects.forEach(s => {
                s.innerHTML = branches.map(b => `<option>${b}</option>`).join('');
            });
            const empSelects = document.querySelectorAll('.emp-select');
            empSelects.forEach(s => {
                s.innerHTML = employees.map((e, i) => `<option value="${i}">${e.name}</option>`).join('');
            });
        }

        // === SIDEBAR TOGGLE ===
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
            const content = document.querySelector('.content');
            content.classList.toggle('expanded');
            const btn = document.querySelector('.btn-toggle-sidebar');
            btn.classList.toggle('expanded');
        }

        // === DARK MODE ===
        function applyDarkMode() {
            document.body.classList.toggle('dark-mode', settings.darkMode);
        }

        function toggleDarkMode(checked) {
            settings.darkMode = checked;
            localStorage.setItem('settings', JSON.stringify(settings));
            applyDarkMode();
        }

        // === SECTION NAVIGATION ===
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
            document.getElementById(id).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`a[href="#${id}"]`)?.classList.add('active');

            // Render based on section
            if (id === 'dashboard') renderDashboard();
            if (id === 'employees') renderEmployees();
            if (id === 'payroll') renderPayroll();
            if (id === 'recruitment') renderRecruitment();
            if (id === 'performance') renderPerformance();
            if (id === 'attendance') renderAttendance();
            if (id === 'leaves') renderLeaves();
            if (id === 'benefits') renderBenefits();
            if (id === 'training') renderTraining();
            if (id === 'compliance') renderCompliance();
            if (id === 'mediaApproval') renderMediaApproval();
        }

        // === DASHBOARD ===
        function renderDashboard() {
            document.getElementById('totalEmployees').textContent = employees.length;
            document.getElementById('openPositions').textContent = jobs.length;
            const avgPerf = reviews.length ? (reviews.reduce((sum, r) => sum + r.score, 0) / reviews.length).toFixed(1) : 0;
            document.getElementById('avgPerformance').textContent = avgPerf + '/5';
            const pending = leaves.filter(l => l.status === 'Pending').length;
            document.getElementById('pendingLeaves').textContent = pending;
            let compliance = 100;
            if (certifications.length) {
                compliance = (certifications.filter(c => new Date(c.expiryDate) > new Date()).length / certifications.length * 100).toFixed(0);
            }
            document.getElementById('complianceScore').textContent = compliance + '%';
            const expiring = certifications.filter(c => new Date(c.expiryDate) < new Date(new Date().setMonth(new Date().getMonth() + 1))).length;
            document.getElementById('expiringCerts').textContent = expiring;

            const branchCounts = branches.map(b => employees.filter(e => e.branch === b).length);
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: branches,
                    datasets: [{label: 'Employees per Branch', data: branchCounts, backgroundColor: '#4169e1'}]
                },
                options: {scales: {y: {beginAtZero: true}}}
            });
        }

        // === EMPLOYEES ===
        let currentEmployeeEdit = -1;
        function showAddEmployeeModal() {
            currentEmployeeEdit = -1;
            document.getElementById('addEmployeeModalLabel').innerHTML = 'Add Employee';
            document.getElementById('empName').value = '';
            document.getElementById('empPosition').value = '';
            document.getElementById('empBranch').value = '';
            document.getElementById('empEmail').value = '';
            document.getElementById('empPhone').value = '';
            document.getElementById('empSalary').value = '';
            document.getElementById('empUsername').value = '';
            document.getElementById('empPassword').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
            modal.show();
        }

        function showEditEmployeeModal(i) {
            currentEmployeeEdit = i;
            document.getElementById('addEmployeeModalLabel').innerHTML = 'Edit Employee';
            const e = employees[i];
            document.getElementById('empName').value = e.name;
            document.getElementById('empPosition').value = e.position;
            document.getElementById('empBranch').value = e.branch;
            document.getElementById('empEmail').value = e.email;
            document.getElementById('empPhone').value = e.phone;
            document.getElementById('empSalary').value = e.salary;
            document.getElementById('empUsername').value = e.username;
            document.getElementById('empPassword').value = e.password;
            const modal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
            modal.show();
        }

        function saveEmployee() {
            const emp = {
                name: document.getElementById('empName').value,
                position: document.getElementById('empPosition').value,
                branch: document.getElementById('empBranch').value,
                email: document.getElementById('empEmail').value,
                phone: document.getElementById('empPhone').value,
                salary: parseFloat(document.getElementById('empSalary').value),
                username: document.getElementById('empUsername').value,
                password: document.getElementById('empPassword').value,
                enrolledBenefits: currentEmployeeEdit !== -1 ? employees[currentEmployeeEdit].enrolledBenefits || [] : [],
            };
            if (currentEmployeeEdit === -1) {
                employees.push(emp);
                addNotification('admin', `New employee added: ${emp.name}`);
            } else {
                employees[currentEmployeeEdit] = {...employees[currentEmployeeEdit], ...emp};
                addNotification('admin', `Employee updated: ${emp.name}`);
            }
            localStorage.setItem('employees', JSON.stringify(employees));
            populateSelects();
            renderEmployees();
            bootstrap.Modal.getInstance(document.getElementById('addEmployeeModal')).hide();
        }

        function renderEmployees() {
            document.getElementById('employeeTable').innerHTML = employees.map((e, i) => `
                <tr>
                    <td>${i+1}</td>
                    <td>${e.name}</td>
                    <td>${e.position}</td>
                    <td>${e.branch}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditEmployeeModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteEmployee(i) {
            if (confirm('Delete?')) {
                const name = employees[i].name;
                employees.splice(i, 1);
                localStorage.setItem('employees', JSON.stringify(employees));
                populateSelects();
                renderEmployees();
                addNotification('admin', `Employee deleted: ${name}`);
            }
        }

        // === PAYROLL ===
        let currentPayrollEdit = -1;
        function showAddPayrollModal() {
            currentPayrollEdit = -1;
            document.getElementById('addPayrollModalLabel').innerHTML = 'Add Payroll';
            document.getElementById('payEmployee').value = '';
            document.getElementById('payMonth').value = '';
            document.getElementById('paySalary').value = '';
            document.getElementById('payDeductions').value = '';
            document.getElementById('payNet').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addPayrollModal'));
            modal.show();
        }

        function showEditPayrollModal(i) {
            currentPayrollEdit = i;
            document.getElementById('addPayrollModalLabel').innerHTML = 'Edit Payroll';
            const p = payrolls[i];
            document.getElementById('payEmployee').value = p.employeeIndex;
            document.getElementById('payMonth').value = p.month;
            document.getElementById('paySalary').value = p.salary;
            document.getElementById('payDeductions').value = p.deductions;
            document.getElementById('payNet').value = p.net;
            const modal = new bootstrap.Modal(document.getElementById('addPayrollModal'));
            modal.show();
        }

        function calculateTax(annualIncome) {
            let tax = 0;
            if (annualIncome <= 237100) {
                tax = annualIncome * 0.18;
            } else if (annualIncome <= 370500) {
                tax = 42678 + (annualIncome - 237100) * 0.26;
            } else if (annualIncome <= 512800) {
                tax = 77362 + (annualIncome - 370500) * 0.31;
            } else if (annualIncome <= 673000) {
                tax = 121475 + (annualIncome - 512800) * 0.36;
            } else if (annualIncome <= 857900) {
                tax = 179147 + (annualIncome - 673000) * 0.39;
            } else if (annualIncome <= 1817000) {
                tax = 251258 + (annualIncome - 857900) * 0.41;
            } else {
                tax = 596695 + (annualIncome - 1817000) * 0.45;
            }
            return tax;
        }

        function calculateDeductions() {
            const employeeIndex = parseInt(document.getElementById('payEmployee').value);
            const month = document.getElementById('payMonth').value;
            if (isNaN(employeeIndex) || !month) return;
            const emp = employees[employeeIndex];
            const salary = emp.salary || 0;
            document.getElementById('paySalary').value = salary;

            // Benefits cost
            let benefitsCost = 0;
            if (emp.enrolledBenefits) {
                emp.enrolledBenefits.forEach(bId => {
                    const benefit = benefitPlans.find(b => b.id === bId);
                    if (benefit) benefitsCost += benefit.cost;
                });
            }

            // Tax
            const annualIncome = salary * 12;
            const annualTax = calculateTax(annualIncome);
            const monthlyTax = annualTax / 12;

            // Attendance adjustment
            const workingDays = 22; // Assumption
            const monthStr = month.substring(5) + '/';
            const year = month.substring(0, 4);
            const presentDays = attendances.filter(a => a.employeeIndex === employeeIndex && a.date.startsWith(monthStr) && a.date.endsWith(year)).length;
            const absentDays = workingDays - presentDays;
            const dailyRate = salary / workingDays;
            const absenceDeduction = absentDays * dailyRate;

            const deductions = monthlyTax + benefitsCost + absenceDeduction;
            document.getElementById('payDeductions').value = deductions.toFixed(2);

            updateNet();
        }

        function updateNet() {
            const salary = parseFloat(document.getElementById('paySalary').value) || 0;
            const deductions = parseFloat(document.getElementById('payDeductions').value) || 0;
            document.getElementById('payNet').value = (salary - deductions).toFixed(2);
        }

        function savePayroll() {
            const p = {
                employeeIndex: parseInt(document.getElementById('payEmployee').value),
                month: document.getElementById('payMonth').value,
                salary: parseFloat(document.getElementById('paySalary').value),
                deductions: parseFloat(document.getElementById('payDeductions').value),
                net: parseFloat(document.getElementById('payNet').value),
            };
            if (currentPayrollEdit === -1) {
                payrolls.push(p);
                addNotification('admin', `New payroll for ${employees[p.employeeIndex].name}`);
            } else {
                payrolls[currentPayrollEdit] = p;
                addNotification('admin', `Payroll updated for ${employees[p.employeeIndex].name}`);
            }
            localStorage.setItem('payrolls', JSON.stringify(payrolls));
            renderPayroll();
            bootstrap.Modal.getInstance(document.getElementById('addPayrollModal')).hide();
        }

        function renderPayroll() {
            document.getElementById('payrollTable').innerHTML = payrolls.map((p, i) => `
                <tr>
                    <td>${i+1}</td>
                    <td>${employees[p.employeeIndex]?.name || 'Unknown'}</td>
                    <td>${p.month}</td>
                    <td>R${p.salary.toFixed(2)}</td>
                    <td>R${p.deductions.toFixed(2)}</td>
                    <td>R${p.net.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditPayrollModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePayroll(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deletePayroll(i) {
            if (confirm('Delete?')) {
                payrolls.splice(i, 1);
                localStorage.setItem('payrolls', JSON.stringify(payrolls));
                renderPayroll();
            }
        }

        // === RECRUITMENT ===
        let currentJobEdit = -1;
        function showAddJobModal() {
            currentJobEdit = -1;
            document.getElementById('addJobModalLabel').innerHTML = 'Add Job';
            document.getElementById('jobTitle').value = '';
            document.getElementById('jobBranch').value = '';
            document.getElementById('jobDesc').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addJobModal'));
            modal.show();
        }

        function showEditJobModal(i) {
            currentJobEdit = i;
            document.getElementById('addJobModalLabel').innerHTML = 'Edit Job';
            const j = jobs[i];
            document.getElementById('jobTitle').value = j.title;
            document.getElementById('jobBranch').value = j.branch;
            document.getElementById('jobDesc').value = j.description;
            const modal = new bootstrap.Modal(document.getElementById('addJobModal'));
            modal.show();
        }

        function saveJob() {
            const j = {
                id: currentJobEdit === -1 ? Date.now() : jobs[currentJobEdit].id,
                title: document.getElementById('jobTitle').value,
                branch: document.getElementById('jobBranch').value,
                description: document.getElementById('jobDesc').value,
                applications: currentJobEdit === -1 ? [] : jobs[currentJobEdit].applications,
            };
            if (currentJobEdit === -1) {
                jobs.push(j);
                addNotification('admin', `New job added: ${j.title}`);
            } else {
                jobs[currentJobEdit] = j;
                addNotification('admin', `Job updated: ${j.title}`);
            }
            localStorage.setItem('jobs', JSON.stringify(jobs));
            renderRecruitment();
            bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
        }

        function renderRecruitment() {
            document.getElementById('jobTable').innerHTML = jobs.map((j, i) => `
                <tr>
                    <td>${j.id}</td>
                    <td>${j.title}</td>
                    <td>${j.branch}</td>
                    <td>${j.applications.length}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditJobModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteJob(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteJob(i) {
            if (confirm('Delete?')) {
                jobs.splice(i, 1);
                localStorage.setItem('jobs', JSON.stringify(jobs));
                renderRecruitment();
            }
        }

        // === PERFORMANCE ===
        let currentReviewEdit = -1;
        function showAddReviewModal() {
            currentReviewEdit = -1;
            document.getElementById('addReviewModalLabel').innerHTML = 'Add Review';
            document.getElementById('reviewEmployee').value = '';
            document.getElementById('reviewScore').value = '';
            document.getElementById('reviewComments').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addReviewModal'));
            modal.show();
        }

        function showEditReviewModal(i) {
            currentReviewEdit = i;
            document.getElementById('addReviewModalLabel').innerHTML = 'Edit Review';
            const r = reviews[i];
            document.getElementById('reviewEmployee').value = r.employeeIndex;
            document.getElementById('reviewScore').value = r.score;
            document.getElementById('reviewComments').value = r.comments;
            const modal = new bootstrap.Modal(document.getElementById('addReviewModal'));
            modal.show();
        }

        function saveReview() {
            const r = {
                employeeIndex: parseInt(document.getElementById('reviewEmployee').value),
                date: new Date().toLocaleDateString(),
                score: parseFloat(document.getElementById('reviewScore').value),
                comments: document.getElementById('reviewComments').value,
            };
            if (currentReviewEdit === -1) {
                reviews.push(r);
                addNotification('admin', `New review for ${employees[r.employeeIndex].name}`);
            } else {
                reviews[currentReviewEdit] = {...reviews[currentReviewEdit], ...r};
                addNotification('admin', `Review updated for ${employees[r.employeeIndex].name}`);
            }
            localStorage.setItem('reviews', JSON.stringify(reviews));
            renderPerformance();
            bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
        }

        function renderPerformance() {
            document.getElementById('performanceTable').innerHTML = reviews.map((r, i) => `
                <tr>
                    <td>${employees[r.employeeIndex]?.name || 'Unknown'}</td>
                    <td>${r.date}</td>
                    <td>${r.score}/5</td>
                    <td>${r.comments}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditReviewModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteReview(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteReview(i) {
            if (confirm('Delete?')) {
                reviews.splice(i, 1);
                localStorage.setItem('reviews', JSON.stringify(reviews));
                renderPerformance();
            }
        }

        // === ATTENDANCE ===
        function clockIn() {
            const employeeIndex = prompt('Enter employee index to clock in:');
            if (employeeIndex === null) return;
            const att = {
                employeeIndex: parseInt(employeeIndex),
                date: new Date().toLocaleDateString(),
                status: 'Present'
            };
            attendances.push(att);
            localStorage.setItem('attendances', JSON.stringify(attendances));
            addNotification('admin', `${employees[att.employeeIndex]?.name || 'Unknown'} clocked in`);
            renderAttendance();
        }

        function renderAttendance() {
            document.getElementById('attendanceTable').innerHTML = attendances.map((a, i) => `
                <tr>
                    <td>${employees[a.employeeIndex]?.name || 'Unknown'}</td>
                    <td>${a.date}</td>
                    <td>${a.status}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteAttendance(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteAttendance(i) {
            if (confirm('Delete?')) {
                attendances.splice(i, 1);
                localStorage.setItem('attendances', JSON.stringify(attendances));
                renderAttendance();
            }
        }

        // === LEAVES ===
        let currentLeaveEdit = -1;
        function showAddLeaveModal() {
            currentLeaveEdit = -1;
            document.getElementById('addLeaveModalLabel').innerHTML = 'Request Leave';
            document.getElementById('leaveEmployee').value = '';
            document.getElementById('leaveStart').value = '';
            document.getElementById('leaveEnd').value = '';
            document.getElementById('leaveType').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addLeaveModal'));
            modal.show();
        }

        function showEditLeaveModal(i) {
            currentLeaveEdit = i;
            document.getElementById('addLeaveModalLabel').innerHTML = 'Edit Leave';
            const l = leaves[i];
            document.getElementById('leaveEmployee').value = l.employeeIndex;
            document.getElementById('leaveStart').value = l.startDate;
            document.getElementById('leaveEnd').value = l.endDate;
            document.getElementById('leaveType').value = l.type;
            const modal = new bootstrap.Modal(document.getElementById('addLeaveModal'));
            modal.show();
        }

        function saveLeave() {
            const l = {
                employeeIndex: parseInt(document.getElementById('leaveEmployee').value),
                startDate: document.getElementById('leaveStart').value,
                endDate: document.getElementById('leaveEnd').value,
                type: document.getElementById('leaveType').value,
                status: currentLeaveEdit === -1 ? 'Pending' : leaves[currentLeaveEdit].status,
            };
            if (currentLeaveEdit === -1) {
                leaves.push(l);
                addNotification('admin', `New leave request from ${employees[l.employeeIndex].name}`);
            } else {
                leaves[currentLeaveEdit] = l;
                addNotification('admin', `Leave updated for ${employees[l.employeeIndex].name}`);
            }
            localStorage.setItem('leaves', JSON.stringify(leaves));
            renderLeaves();
            bootstrap.Modal.getInstance(document.getElementById('addLeaveModal')).hide();
        }

        function renderLeaves() {
            document.getElementById('leavesTable').innerHTML = leaves.map((l, i) => `
                <tr>
                    <td>${employees[l.employeeIndex]?.name || 'Unknown'}</td>
                    <td>${l.startDate}</td>
                    <td>${l.endDate}</td>
                    <td>${l.type}</td>
                    <td>${l.status}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="approveLeave(${i})">Approve</button>
                        <button class="btn btn-sm btn-danger" onclick="rejectLeave(${i})">Reject</button>
                        <button class="btn btn-sm btn-primary" onclick="showEditLeaveModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLeave(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function approveLeave(i) {
            leaves[i].status = 'Approved';
            localStorage.setItem('leaves', JSON.stringify(leaves));
            renderLeaves();
        }

        function rejectLeave(i) {
            leaves[i].status = 'Rejected';
            localStorage.setItem('leaves', JSON.stringify(leaves));
            renderLeaves();
        }

        function deleteLeave(i) {
            if (confirm('Delete?')) {
                leaves.splice(i, 1);
                localStorage.setItem('leaves', JSON.stringify(leaves));
                renderLeaves();
            }
        }

        // === BENEFITS ===
        let currentBenefitEdit = -1;
        function showAddBenefitModal() {
            currentBenefitEdit = -1;
            document.getElementById('addBenefitModalLabel').innerHTML = 'Add Benefit Plan';
            document.getElementById('benefitName').value = '';
            document.getElementById('benefitDesc').value = '';
            document.getElementById('benefitCost').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addBenefitModal'));
            modal.show();
        }

        function showEditBenefitModal(i) {
            currentBenefitEdit = i;
            document.getElementById('addBenefitModalLabel').innerHTML = 'Edit Benefit Plan';
            const b = benefitPlans[i];
            document.getElementById('benefitName').value = b.name;
            document.getElementById('benefitDesc').value = b.description;
            document.getElementById('benefitCost').value = b.cost;
            const modal = new bootstrap.Modal(document.getElementById('addBenefitModal'));
            modal.show();
        }

        function saveBenefit() {
            const b = {
                id: currentBenefitEdit === -1 ? Date.now() : benefitPlans[currentBenefitEdit].id,
                name: document.getElementById('benefitName').value,
                description: document.getElementById('benefitDesc').value,
                cost: parseFloat(document.getElementById('benefitCost').value),
            };
            if (currentBenefitEdit === -1) {
                benefitPlans.push(b);
                addNotification('admin', `New benefit plan added: ${b.name}`);
            } else {
                benefitPlans[currentBenefitEdit] = b;
                addNotification('admin', `Benefit plan updated: ${b.name}`);
            }
            localStorage.setItem('benefitPlans', JSON.stringify(benefitPlans));
            renderBenefits();
            bootstrap.Modal.getInstance(document.getElementById('addBenefitModal')).hide();
        }

        function renderBenefits() {
            document.getElementById('benefitTable').innerHTML = benefitPlans.map((b, i) => `
                <tr>
                    <td>${b.id}</td>
                    <td>${b.name}</td>
                    <td>${b.description}</td>
                    <td>R${b.cost}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditBenefitModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBenefit(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteBenefit(i) {
            if (confirm('Delete?')) {
                benefitPlans.splice(i, 1);
                localStorage.setItem('benefitPlans', JSON.stringify(benefitPlans));
                renderBenefits();
            }
        }

        // === TRAINING ===
        let currentCourseEdit = -1;
        function showAddCourseModal() {
            currentCourseEdit = -1;
            document.getElementById('addCourseModalLabel').innerHTML = 'Add Course';
            document.getElementById('courseName').value = '';
            document.getElementById('courseDesc').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addCourseModal'));
            modal.show();
        }

        function showEditCourseModal(i) {
            currentCourseEdit = i;
            document.getElementById('addCourseModalLabel').innerHTML = 'Edit Course';
            const c = courses[i];
            document.getElementById('courseName').value = c.name;
            document.getElementById('courseDesc').value = c.description;
            const modal = new bootstrap.Modal(document.getElementById('addCourseModal'));
            modal.show();
        }

        function saveCourse() {
            const c = {
                id: currentCourseEdit === -1 ? Date.now() : courses[currentCourseEdit].id,
                name: document.getElementById('courseName').value,
                description: document.getElementById('courseDesc').value,
            };
            if (currentCourseEdit === -1) {
                courses.push(c);
                addNotification('admin', `New course added: ${c.name}`);
            } else {
                courses[currentCourseEdit] = c;
                addNotification('admin', `Course updated: ${c.name}`);
            }
            localStorage.setItem('courses', JSON.stringify(courses));
            renderTraining();
            bootstrap.Modal.getInstance(document.getElementById('addCourseModal')).hide();
        }

        function renderTraining() {
            document.getElementById('courseTable').innerHTML = courses.map((c, i) => `
                <tr>
                    <td>${c.id}</td>
                    <td>${c.name}</td>
                    <td>${c.description}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditCourseModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCourse(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteCourse(i) {
            if (confirm('Delete?')) {
                courses.splice(i, 1);
                localStorage.setItem('courses', JSON.stringify(courses));
                renderTraining();
            }
        }

        // === COMPLIANCE ===
        let currentCertEdit = -1;
        function showAddCertificationModal() {
            currentCertEdit = -1;
            document.getElementById('addCertificationModalLabel').innerHTML = 'Add Certification';
            document.getElementById('certEmployee').value = '';
            document.getElementById('certName').value = '';
            document.getElementById('certExpiry').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addCertificationModal'));
            modal.show();
        }

        function showEditCertificationModal(i) {
            currentCertEdit = i;
            document.getElementById('addCertificationModalLabel').innerHTML = 'Edit Certification';
            const cert = certifications[i];
            document.getElementById('certEmployee').value = cert.employeeIndex;
            document.getElementById('certName').value = cert.name;
            document.getElementById('certExpiry').value = cert.expiryDate;
            const modal = new bootstrap.Modal(document.getElementById('addCertificationModal'));
            modal.show();
        }

        function saveCertification() {
            const cert = {
                employeeIndex: parseInt(document.getElementById('certEmployee').value),
                name: document.getElementById('certName').value,
                expiryDate: document.getElementById('certExpiry').value,
            };
            if (currentCertEdit === -1) {
                certifications.push(cert);
                addNotification('admin', `New certification for ${employees[cert.employeeIndex].name}`);
            } else {
                certifications[currentCertEdit] = cert;
                addNotification('admin', `Certification updated for ${employees[cert.employeeIndex].name}`);
            }
            localStorage.setItem('certifications', JSON.stringify(certifications));
            renderCompliance();
            bootstrap.Modal.getInstance(document.getElementById('addCertificationModal')).hide();
        }

        function renderCompliance() {
            document.getElementById('certificationTable').innerHTML = certifications.map((c, i) => `
                <tr>
                    <td>${employees[c.employeeIndex]?.name || 'Unknown'}</td>
                    <td>${c.name}</td>
                    <td>${c.expiryDate}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditCertificationModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCertification(${i})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteCertification(i) {
            if (confirm('Delete?')) {
                certifications.splice(i, 1);
                localStorage.setItem('certifications', JSON.stringify(certifications));
                renderCompliance();
            }
        }

        // === MEDIA APPROVAL ===
        let currentMediaEdit = -1;
        function showUploadMediaModal() {
            document.getElementById('mediaTitle').value = '';
            document.getElementById('mediaDesc').value = '';
            document.getElementById('mediaFile').value = '';
            const modal = new bootstrap.Modal(document.getElementById('uploadMediaModal'));
            modal.show();
        }

        function uploadMedia() {
            const title = document.getElementById('mediaTitle').value;
            const desc = document.getElementById('mediaDesc').value;
            const file = document.getElementById('mediaFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mediaContents.push({id: Date.now(), title, desc, fileData: e.target.result, status: 'Pending', uploader: 'Admin'});
                    localStorage.setItem('mediaContents', JSON.stringify(mediaContents));
                    addNotification('admin', `New media uploaded: ${title}`);
                    renderMediaApproval();
                    bootstrap.Modal.getInstance(document.getElementById('uploadMediaModal')).hide();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderMediaApproval() {
            document.getElementById('mediaTable').innerHTML = mediaContents.map((m, i) => `
                <tr>
                    <td>${m.id}</td>
                    <td>${m.title}</td>
                    <td>${m.uploader}</td>
                    <td>${m.status}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="approveMedia(${i})">Approve</button>
                        <button class="btn btn-sm btn-danger" onclick="rejectMedia(${i})">Reject</button>
                    </td>
                </tr>
            `).join('');
        }

        function approveMedia(i) {
            mediaContents[i].status = 'Approved';
            localStorage.setItem('mediaContents', JSON.stringify(mediaContents));
            renderMediaApproval();
        }

        function rejectMedia(i) {
            mediaContents[i].status = 'Rejected';
            localStorage.setItem('mediaContents', JSON.stringify(mediaContents));
            renderMediaApproval();
        }

        // === REPORTS ===
        function exportToExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            XLSX.writeFile(wb, filename + '.xlsx');
        }

        // === ON LOAD ===
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('currentUser')) {
                document.getElementById('loginContainer').style.display = 'none';
                document.querySelector('.app-container').style.display = 'block';
                initApp();
            }
        });
    </script>
</body>
</html>
