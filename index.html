<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced School Management System (ASMS) - Bophelong Independent School</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1e3c72, #2a5298); 
            color: #fff; 
            min-height: 100vh;
        }
        .sidebar { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            border-right: 1px solid rgba(255, 255, 255, 0.2); 
            height: 100vh; 
            position: fixed; 
            width: 260px; 
            padding: 20px; 
            overflow-y: auto; 
            transition: width 0.3s ease; 
            z-index: 1000; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link { 
            color: #fff; 
            font-weight: 500; 
            margin-bottom: 10px; 
            padding: 12px; 
            border-radius: 10px; 
            transition: all 0.3s; 
            backdrop-filter: blur(5px);
        }
        .sidebar .nav-link:hover { 
            background: rgba(255, 255, 255, 0.2); 
            transform: translateX(5px); 
        }
        .sidebar .nav-link.active { 
            background: rgba(255, 255, 255, 0.3); 
            font-weight: 600;
        }
        .content { 
            margin-left: 260px; 
            padding: 40px; 
            transition: margin-left 0.3s ease; 
            min-height: 100vh;
        }
        .content.expanded { margin-left: 70px; }
        .card-metric { 
            background: rgba(255, 255, 255, 0.15); 
            border: none; 
            border-radius: 15px; 
            backdrop-filter: blur(10px); 
            transition: transform 0.3s; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .card-metric:hover { transform: translateY(-8px); }
        .table { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 15px; 
            overflow: hidden; 
            backdrop-filter: blur(10px);
        }
        .table th { background: rgba(255, 255, 255, 0.2); color: #fff; }
        .modal-content { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 20px; 
            backdrop-filter: blur(15px); 
            color: #333;
        }
        .btn-toggle-sidebar { 
            position: fixed; 
            top: 20px; 
            left: 270px; 
            z-index: 1001; 
            background: rgba(255, 255, 255, 0.2); 
            border: none; 
            color: #fff;
        }
        .btn-toggle-sidebar.expanded { left: 80px; }
        #notificationBell { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1100; 
        }
        .admin-only { display: block; }
        .teacher-only { display: none; }
        .parent-only { display: none; }
        .student-only { display: none; }
        .dark-mode { filter: brightness(0.8); }
        .login-page { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }
        .login-card { 
            width: 100%; 
            max-width: 450px; 
            padding: 2.5rem; 
            border-radius: 20px; 
            background: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); 
            backdrop-filter: blur(15px);
        }
        .login-title { 
            font-weight: 700; 
            color: #1e3c72; 
            text-align: center;
        }
        .report-card { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 15px; 
            padding: 20px; 
            margin: 10px 0; 
            backdrop-filter: blur(10px);
        }
        .timetable-cell { 
            padding: 10px; 
            text-align: center; 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 8px; 
            margin: 2px; 
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-message { 
            margin-bottom: 10px; 
            padding: 10px; 
            border-radius: 10px; 
        }
        .chat-user { background: rgba(255, 255, 255, 0.2); }
        .chat-assistant { background: rgba(0, 255, 0, 0.1); }
        .editable { cursor: pointer; }
        .editable:hover { background: rgba(255, 255, 255, 0.2); }
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 70px; }
            .btn-toggle-sidebar { left: 80px; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x text-primary mb-3"></i>
                <h3 class="login-title">ASMS - Bophelong Independent School</h3>
                <p class="text-muted">Advanced School Management System</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <button type="button" class="btn btn-secondary w-100 mb-3" onclick="biometricLogin()">
                    <i class="fas fa-fingerprint me-2"></i>Biometric Login
                </button>
                <div class="login-demo">
                    <p class="mb-1"><strong>Admin:</strong> admin / admin123</p>
                    <p class="mb-1"><strong>Teacher:</strong> teacher / teacher123</p>
                    <p class="mb-1"><strong>Parent:</strong> parent / parent123</p>
                    <p class="mb-0"><strong>Student:</strong> student / student123</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-warning rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>

        <button class="btn btn-sm btn-light btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

        <div class="sidebar">
            <h4 class="mb-4 text-center"><i class="fas fa-school me-2"></i><span class="nav-text">ASMS</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only non-student"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
                <li class="non-student"><a href="#admission" class="nav-link" onclick="showSection('admission')"><i class="fas fa-user-plus me-2"></i><span class="nav-text">Admission</span></a></li>
                <li class="non-student"><a href="#students" class="nav-link" onclick="showSection('students')"><i class="fas fa-users me-2"></i><span class="nav-text">Student Info</span></a></li>
                <li class="non-student"><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
                <li class="non-student"><a href="#fees" class="nav-link" onclick="showSection('fees')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">Fee Management</span></a></li>
                <li><a href="#timetable" class="nav-link" onclick="showSection('timetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Timetable</span></a></li>
                <li><a href="#exams" class="nav-link" onclick="showSection('exams')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Examinations</span></a></li>
                <li class="admin-only non-student"><a href="#hr" class="nav-link" onclick="showSection('hr')"><i class="fas fa-user-tie me-2"></i><span class="nav-text">HR Management</span></a></li>
                <li class="non-student"><a href="#communication" class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments me-2"></i><span class="nav-text">Communication</span></a></li>
                <li><a href="#content" class="nav-link" onclick="showSection('content')"><i class="fas fa-book me-2"></i><span class="nav-text">Content</span></a></li>
                <li class="admin-only non-student"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Reports</span></a></li>
                <li class="admin-only non-student"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="student-only"><a href="#aiResearch" class="nav-link" onclick="showSection('aiResearch')"><i class="fas fa-robot me-2"></i><span class="nav-text">AI Research</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section">
                <h2>School Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Students</h5><h3 id="totalStudents">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's Attendance</h5><h3 id="todayAttendance">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Fees</h5><h3 id="pendingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Upcoming Exams</h5><h3 id="upcomingExams">0</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4"></canvas>
            </section>

            <!-- Admission Management -->
            <section id="admission" class="section d-none">
                <h2>Admission Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddAdmissionModal()">New Application</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="admissionTable"></tbody>
                </table>
            </section>

            <!-- Student Information System -->
            <section id="students" class="section d-none">
                <h2>Student Information System</h2>
                <button class="btn btn-primary mb-3" onclick="showAddStudentModal()">Add Student</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search student..." id="studentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchStudents()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Parent</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="studentTable"></tbody>
                </table>
            </section>

            <!-- Attendance Management -->
            <section id="attendance" class="section d-none">
                <h2>Attendance Management</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="date" id="attendanceDate" class="form-control" onchange="loadAttendance()">
                    </div>
                    <div class="col-md-4">
                        <select id="attendanceClass" class="form-control" onchange="loadAttendance()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success mb-3" onclick="markAllPresent()">Mark All Present</button>
                <button class="btn btn-info mb-3" onclick="syncBiometricAttendance()">Sync Biometric Attendance</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </section>

            <!-- Fee Management -->
            <section id="fees" class="section d-none">
                <h2>Fee Management</h2>
                <button class="btn btn-primary mb-3" onclick="generateFeeInvoice()">Generate Invoice</button>
                <div class="row mb-3">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Collected</h5><h3 id="totalCollected">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Outstanding</h5><h3 id="outstandingFees">R0</h3></div></div>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Student</th><th>Amount</th><th>Due Date</th><th>Status</th><th>Receipt</th><th>Actions</th></tr></thead>
                    <tbody id="feeTable"></tbody>
                </table>
            </section>

            <!-- Timetable Management -->
            <section id="timetable" class="section d-none">
                <h2>Timetable Management</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="timetableGrade" class="form-control" onchange="loadTimetable()">
                            <option value="">Select Grade</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="toggleEditTimetable()">Edit Timetable</button>
                    </div>
                </div>
                <div id="timetableContainer"></div>
            </section>

            <!-- Examination Management -->
            <section id="exams" class="section d-none">
                <h2>Examination Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddExamModal()">Schedule Exam</button>
                <button class="btn btn-info mb-3" onclick="generateReportCard()">Generate Report Card</button>
                <table class="table table-striped">
                    <thead><tr><th>Exam</th><th>Date</th><th>Subject</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="examTable"></tbody>
                </table>
            </section>

            <!-- HR Management -->
            <section id="hr" class="section d-none admin-only">
                <h2>Human Resource Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddStaffModal()">Add Staff</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Department</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="staffTable"></tbody>
                </table>
            </section>

            <!-- Communication Module -->
            <section id="communication" class="section d-none">
                <h2>Communication Hub</h2>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <textarea id="messageText" class="form-control" rows="3" placeholder="Type message..."></textarea>
                    </div>
                    <div class="col-md-3">
                        <select id="messageRecipient" class="form-control">
                            <option value="all">All</option>
                            <option value="parents">Parents</option>
                            <option value="students">Students</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success w-100" onclick="sendMessage()">Send Message</button>
                    </div>
                </div>
                <div id="messageHistory" class="mt-3"></div>
            </section>

            <!-- Content Module -->
            <section id="content" class="section d-none">
                <h2>Content Management</h2>
                <p>This comprehensive module hosts subjects, interventions, online lessons, textbooks, examinations, and work due. Filter by grade and subject for easy access.</p>
                <button class="btn btn-primary mb-3" onclick="showUploadContentModal()">Upload Content</button>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="contentGradeFilter" class="form-control" onchange="renderContent()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="contentSubjectFilter" class="form-control" placeholder="Filter by Subject" oninput="debounce(renderContent, 300)()">
                    </div>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Type</th><th>Name</th><th>Grade</th><th>Subject</th><th>Actions</th></tr></thead>
                    <tbody id="contentTable"></tbody>
                </table>
            </section>

            <!-- Reports -->
            <section id="reports" class="section d-none admin-only">
                <h2>Reports & Analytics</h2>
                <div class="row">
                    <div class="col-md-4"><button class="btn btn-primary w-100 mb-3" onclick="exportToExcel(students, 'students')">Export Students</button></div>
                    <div class="col-md-4"><button class="btn btn-success w-100 mb-3" onclick="exportToExcel(fees, 'fees')">Export Fees</button></div>
                    <div class="col-md-4"><button class="btn btn-info w-100 mb-3" onclick="exportToExcel(attendanceRecords, 'attendance')">Export Attendance</button></div>
                </div>
            </section>

            <!-- Settings -->
            <section id="settings" class="section d-none admin-only">
                <h2>System Settings</h2>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode(this.checked)">
                    <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
                </div>
                <h5>School Year</h5>
                <input type="text" id="schoolYear" class="form-control w-50" value="2025">
            </section>

            <!-- AI Research Module (Student Only) -->
            <section id="aiResearch" class="section d-none">
                <h2>AI Research Module - Powered by Grok</h2>
                <div class="mb-3">
                    <label>API Key (obtain from https://x.ai/api):</label>
                    <input type="text" id="grokApiKey" class="form-control" placeholder="Enter your xAI API Key">
                </div>
                <div id="chatHistory" class="border p-3 mb-3" style="height: 400px; overflow-y: auto;"></div>
                <div class="input-group">
                    <textarea id="grokQuery" class="form-control" rows="2" placeholder="Enter your research query..."></textarea>
                    <button class="btn btn-primary" onclick="sendGrokQuery()">Send</button>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="addAdmissionModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Add Admission Application</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input id="appName" placeholder="Student Name" class="form-control mb-3">
                    <input id="appParent" placeholder="Parent Name" class="form-control mb-3">
                    <select id="appGrade" class="form-control mb-3">
                        <option value="">Select Grade</option>
                        <option>Grade R</option><option>Grade 1</option><option>Grade 12</option>
                    </select>
                    <input type="file" id="appDocuments" class="form-control mb-3" multiple>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveAdmission()">Submit</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="uploadContentModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Upload Content</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="contentName" placeholder="Content Name" class="form-control mb-3">
                    <select id="contentType" class="form-control mb-3">
                        <option>Subject</option>
                        <option>Intervention</option>
                        <option>Online Lesson</option>
                        <option>Textbook</option>
                        <option>Examination</option>
                        <option>Work Due</option>
                    </select>
                    <select id="contentGrade" class="form-control mb-3">
                        <option value="">Select Grade</option>
                        <option>Grade R</option><option>Grade 1</option><option>Grade 12</option>
                    </select>
                    <input type="text" id="contentSubject" placeholder="Subject" class="form-control mb-3">
                    <input type="file" id="contentFile" class="form-control mb-3">
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveContent()">Upload</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewStudentModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Student Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="studentDetails"></div>
                <input type="file" id="studentDocuments" class="form-control mb-3" multiple>
                <button class="btn btn-primary" onclick="uploadStudentDocuments()">Upload Documents</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="previewContentModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5>Content Preview</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="previewBody"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editTimetableModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Edit Timetable Entry</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="editTimetableValue" class="form-control" placeholder="Enter subject">
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveTimetableEdit()">Save</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="updateFeeModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Update Fee</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="number" id="updateFeeAmount" class="form-control mb-3" placeholder="Amount">
                    <input type="date" id="updateFeeDueDate" class="form-control mb-3">
                    <select id="updateFeeStatus" class="form-control mb-3">
                        <option>Pending</option>
                        <option>Paid</option>
                    </select>
                    <input type="file" id="feeReceipt" class="form-control mb-3">
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveFeeUpdate()">Save</button></div>
            </div>
        </div>
    </div>

    <script>
        // Global Data
        let students = JSON.parse(localStorage.getItem('students')) || [];
        let admissions = JSON.parse(localStorage.getItem('admissions')) || [];
        let attendanceRecords = JSON.parse(localStorage.getItem('attendance')) || [];
        let fees = JSON.parse(localStorage.getItem('fees')) || [];
        let exams = JSON.parse(localStorage.getItem('exams')) || [];
        let staff = JSON.parse(localStorage.getItem('staff')) || [];
        let messages = JSON.parse(localStorage.getItem('messages')) || [];
        let content = JSON.parse(localStorage.getItem('content')) || [];
        let timetables = JSON.parse(localStorage.getItem('timetables')) || {}; // Grade -> timetable data
        let documents = JSON.parse(localStorage.getItem('documents')) || {}; // id -> array of {name, data}
        let currentUser = null;
        let chatHistory = [];
        let editingCell = null;
        let editingFee = null;

        // Utility: Debounce for performance
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Login
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if ((username === 'admin' && password === 'admin123') ||
                (username === 'teacher' && password === 'teacher123') ||
                (username === 'parent' && password === 'parent123') ||
                (username === 'student' && password === 'student123')) {
                currentUser = { username, role: username };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                initApp();
            } else {
                alert('Invalid credentials');
            }
        }

        function biometricLogin() {
            // Placeholder for biometric integration (e.g., using WebAuthn or external API)
            if (navigator.credentials) {
                // Example WebAuthn for fingerprint/face (requires setup)
                alert('Biometric login initiated. (Integrate with your biomatrix system API here, e.g., fingerprint scanner.)');
                // Simulate success
                currentUser = { username: 'student', role: 'student' }; // Replace with actual auth
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                initApp();
            } else {
                alert('Biometric not supported in this browser. Use username/password.');
            }
        }

        function initApp() {
            updateRoleVisibility();
            populateGrades();
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            renderDashboard();
            renderAll();
            if (currentUser.role === 'student') {
                showSection('aiResearch');
            } else {
                showSection('dashboard');
            }
        }

        function populateGrades() {
            const grades = [...new Set(students.map(s => s.grade).filter(g => g))];
            const gradeOptions = '<option value="">All Grades/Select Grade</option>' + grades.map(g => `<option>${g}</option>`).join('');
            document.getElementById('attendanceClass').innerHTML = gradeOptions.replace('Select', 'All');
            document.getElementById('timetableGrade').innerHTML = gradeOptions;
            document.getElementById('contentGradeFilter').innerHTML = gradeOptions.replace('Select', 'All');
            if (document.getElementById('contentGrade')) document.getElementById('contentGrade').innerHTML = gradeOptions;
            if (document.getElementById('appGrade')) document.getElementById('appGrade').innerHTML = gradeOptions;
        }

        function updateRoleVisibility() {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = currentUser.role === 'admin' ? 'block' : 'none');
            document.querySelectorAll('.teacher-only').forEach(el => el.style.display = currentUser.role === 'teacher' ? 'block' : 'none');
            document.querySelectorAll('.parent-only').forEach(el => el.style.display = currentUser.role === 'parent' ? 'block' : 'none');
            document.querySelectorAll('.student-only').forEach(el => el.style.display = currentUser.role === 'student' ? 'block' : 'none');
            if (currentUser.role === 'student') {
                document.querySelectorAll('.non-student').forEach(el => el.style.display = 'none');
            }
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
            document.getElementById(id).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const link = document.querySelector(`a[href="#${id}"]`);
            if (link) link.classList.add('active');
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
            document.querySelector('.content').classList.toggle('expanded');
            document.querySelector('.btn-toggle-sidebar').classList.toggle('expanded');
        }

        function toggleDarkMode(checked) {
            document.body.classList.toggle('dark-mode', checked);
        }

        function renderDashboard() {
            requestAnimationFrame(() => {
                document.getElementById('totalStudents').textContent = students.length;
                const today = new Date().toISOString().split('T')[0];
                const todayAtt = attendanceRecords.filter(a => a.date === today);
                const attRate = students.length ? Math.round((todayAtt.filter(a => a.status === 'Present').length / students.length) * 100) : 0;
                document.getElementById('todayAttendance').textContent = attRate + '%';
                document.getElementById('pendingFees').textContent = 'R' + fees.filter(f => f.status === 'Pending').reduce((s, f) => s + f.amount, 0);
                document.getElementById('upcomingExams').textContent = exams.filter(e => new Date(e.date) > new Date()).length;

                const ctx = document.getElementById('dashboardChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Present', 'Absent'],
                        datasets: [{
                            data: [attRate, 100 - attRate],
                            backgroundColor: ['#28a745', '#dc3545']
                        }]
                    }
                });
            });
        }

        function renderAll() {
            renderAdmissions();
            renderStudents();
            loadAttendance();
            renderFees();
            loadTimetable();
            renderExams();
            renderHR();
            renderCommunication();
            renderContent();
        }

        // Admission
        function showAddAdmissionModal() {
            const modal = new bootstrap.Modal(document.getElementById('addAdmissionModal'));
            modal.show();
        }
        function saveAdmission() {
            const app = {
                id: Date.now(),
                name: document.getElementById('appName').value,
                parent: document.getElementById('appParent').value,
                grade: document.getElementById('appGrade').value,
                status: 'Pending',
                documents: []
            };
            const files = document.getElementById('appDocuments').files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    app.documents.push({name: file.name, data: e.target.result});
                    if (app.documents.length === files.length) {
                        admissions.push(app);
                        localStorage.setItem('admissions', JSON.stringify(admissions));
                        renderAdmissions();
                    }
                };
                reader.readAsDataURL(file);
            }
            if (files.length === 0) {
                admissions.push(app);
                localStorage.setItem('admissions', JSON.stringify(admissions));
                renderAdmissions();
            }
            bootstrap.Modal.getInstance(document.getElementById('addAdmissionModal')).hide();
        }
        function renderAdmissions() {
            requestAnimationFrame(() => {
                document.getElementById('admissionTable').innerHTML = admissions.map(a => `
                    <tr>
                        <td>${a.id}</td>
                        <td>${a.name}</td>
                        <td>${a.grade}</td>
                        <td>${a.status}</td>
                        <td>${a.documents ? a.documents.length : 0} docs</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="approveAdmission(${a.id})">Approve</button>
                            <button class="btn btn-sm btn-danger" onclick="rejectAdmission(${a.id})">Reject</button>
                        </td>
                    </tr>
                `).join('');
            });
        }
        function approveAdmission(id) {
            const app = admissions.find(a => a.id === id);
            const newStudent = {
                id: Date.now(),
                name: app.name,
                grade: app.grade,
                parent: app.parent,
                status: 'Active'
            };
            students.push(newStudent);
            documents[newStudent.id] = app.documents || [];
            admissions = admissions.filter(a => a.id !== id);
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('documents', JSON.stringify(documents));
            localStorage.setItem('admissions', JSON.stringify(admissions));
            renderAdmissions();
            renderStudents();
            populateGrades();
        }
        function rejectAdmission(id) {
            admissions = admissions.filter(a => a.id !== id);
            localStorage.setItem('admissions', JSON.stringify(admissions));
            renderAdmissions();
        }

        // Students
        function showAddStudentModal() {
            alert('Use Admission module to add students');
        }
        function renderStudents(filteredStudents = students) {
            requestAnimationFrame(() => {
                document.getElementById('studentTable').innerHTML = filteredStudents.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${s.grade}</td>
                        <td>${s.parent}</td>
                        <td>${s.status}</td>
                        <td>${documents[s.id] ? documents[s.id].length : 0} docs</td>
                        <td><button class="btn btn-sm btn-info" onclick="viewStudent(${s.id})">View</button></td>
                    </tr>
                `).join('');
            });
        }
        function searchStudents() {
            const term = document.getElementById('studentSearch').value.toLowerCase();
            const filtered = students.filter(s => s.name.toLowerCase().includes(term) || s.grade.toLowerCase().includes(term));
            renderStudents(filtered);
        }
        function viewStudent(id) {
            const s = students.find(st => st.id === id);
            document.getElementById('studentDetails').innerHTML = `
                <p><strong>Name:</strong> ${s.name}</p>
                <p><strong>Grade:</strong> ${s.grade}</p>
                <p><strong>Parent:</strong> ${s.parent}</p>
                <p><strong>Status:</strong> ${s.status}</p>
                <div>Documents: ${documents[id] ? documents[id].map(d => `<a href="${d.data}" download="${d.name}">${d.name}</a>`).join('<br>') : 'None'}</div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('viewStudentModal'));
            modal.show();
        }
        function uploadStudentDocuments() {
            const id = students.find(s => true).id; // Placeholder, assume from context
            const files = document.getElementById('studentDocuments').files;
            if (!documents[id]) documents[id] = [];
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    documents[id].push({name: file.name, data: e.target.result});
                    localStorage.setItem('documents', JSON.stringify(documents));
                    viewStudent(id); // Refresh
                };
                reader.readAsDataURL(file);
            }
            bootstrap.Modal.getInstance(document.getElementById('viewStudentModal')).hide();
        }

        // Attendance
        function loadAttendance() {
            requestAnimationFrame(() => {
                const date = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
                const selectedClass = document.getElementById('attendanceClass').value;
                let filteredStudents = students;
                if (selectedClass) {
                    filteredStudents = students.filter(s => s.grade === selectedClass);
                }
                const records = attendanceRecords.filter(a => a.date === date);
                document.getElementById('attendanceTable').innerHTML = filteredStudents.map(s => {
                    const rec = records.find(r => r.studentId === s.id);
                    return `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.name}</td>
                            <td>${rec ? rec.status : 'Absent'}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="markPresent(${s.id}, '${date}')">Present</button>
                                <button class="btn btn-sm btn-warning" onclick="markAbsent(${s.id}, '${date}')">Absent</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            });
        }
        function markPresent(id, date) {
            const existing = attendanceRecords.find(a => a.studentId === id && a.date === date);
            if (existing) existing.status = 'Present';
            else attendanceRecords.push({ studentId: id, date, status: 'Present' });
            localStorage.setItem('attendance', JSON.stringify(attendanceRecords));
            loadAttendance();
        }
        function markAbsent(id, date) {
            const existing = attendanceRecords.find(a => a.studentId === id && a.date === date);
            if (existing) existing.status = 'Absent';
            else attendanceRecords.push({ studentId: id, date, status: 'Absent' });
            localStorage.setItem('attendance', JSON.stringify(attendanceRecords));
            loadAttendance();
        }
        function markAllPresent() {
            const date = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            const selectedClass = document.getElementById('attendanceClass').value;
            let filteredStudents = students;
            if (selectedClass) {
                filteredStudents = students.filter(s => s.grade === selectedClass);
            }
            filteredStudents.forEach(s => markPresent(s.id, date));
        }
        function syncBiometricAttendance() {
            // Enhanced integration with biometric system
            alert('Attendance synced from biometric system for students and teachers. (Integrate your biomatrix API here, e.g., fetch attendance data and update records.)');
            // Example: fetch('biomatrix-api-url?date=' + date).then(res => res.json()).then(data => { data.forEach(d => markPresent(d.studentId, date)); loadAttendance(); });
        }

        // Fees
        function generateFeeInvoice() {
            if (!students.length) return alert('No students');
            // For demo, generate for first student
            const student = students[0];
            fees.push({
                id: Date.now(),
                studentId: student.id,
                amount: 2500,
                dueDate: '2025-12-01',
                status: 'Pending',
                receipt: null
            });
            localStorage.setItem('fees', JSON.stringify(fees));
            renderFees();
        }
        function renderFees() {
            requestAnimationFrame(() => {
                document.getElementById('feeTable').innerHTML = fees.map(f => {
                    const s = students.find(st => st.id === f.studentId);
                    return `
                        <tr>
                            <td>${s?.name || 'Unknown'}</td>
                            <td>R${f.amount}</td>
                            <td>${f.dueDate}</td>
                            <td>${f.status}</td>
                            <td>${f.receipt ? '<a href="' + f.receipt + '" download>Download</a>' : 'None'}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="payFee(${f.id})">Pay</button>
                                <button class="btn btn-sm btn-secondary" onclick="updateFee(${f.id})">Update</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('totalCollected').textContent = 'R' + fees.filter(f => f.status === 'Paid').reduce((s, f) => s + f.amount, 0);
                document.getElementById('outstandingFees').textContent = 'R' + fees.filter(f => f.status === 'Pending').reduce((s, f) => s + f.amount, 0);
            });
        }
        function payFee(id) {
            const f = fees.find(fee => fee.id === id);
            if (f) f.status = 'Paid';
            localStorage.setItem('fees', JSON.stringify(fees));
            renderFees();
        }
        function updateFee(id) {
            editingFee = fees.find(f => f.id === id);
            document.getElementById('updateFeeAmount').value = editingFee.amount;
            document.getElementById('updateFeeDueDate').value = editingFee.dueDate;
            document.getElementById('updateFeeStatus').value = editingFee.status;
            const modal = new bootstrap.Modal(document.getElementById('updateFeeModal'));
            modal.show();
        }
        function saveFeeUpdate() {
            if (!editingFee) return;
            editingFee.amount = parseFloat(document.getElementById('updateFeeAmount').value);
            editingFee.dueDate = document.getElementById('updateFeeDueDate').value;
            editingFee.status = document.getElementById('updateFeeStatus').value;
            const file = document.getElementById('feeReceipt').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    editingFee.receipt = e.target.result;
                    localStorage.setItem('fees', JSON.stringify(fees));
                    renderFees();
                };
                reader.readAsDataURL(file);
            } else {
                localStorage.setItem('fees', JSON.stringify(fees));
                renderFees();
            }
            bootstrap.Modal.getInstance(document.getElementById('updateFeeModal')).hide();
            editingFee = null;
        }

        // Timetable
        function loadTimetable() {
            const grade = document.getElementById('timetableGrade').value;
            if (!grade) return;
            if (!timetables[grade]) {
                timetables[grade] = Array.from({length: 5}, () => Array.from({length: 8}, () => ''));
            }
            renderTimetable(grade);
        }
        function renderTimetable(grade) {
            requestAnimationFrame(() => {
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                const times = Array(8).fill().map((_, i) => `0${i + 8}:00`);
                const container = document.getElementById('timetableContainer');
                let html = '<table class="table"><thead><tr><th>Time</th>' + days.map(d => `<th>${d}</th>`).join('') + '</tr></thead><tbody>';
                times.forEach((time, tIndex) => {
                    html += `<tr><td>${time}</td>`;
                    days.forEach((day, dIndex) => {
                        const value = timetables[grade][dIndex][tIndex] || '';
                        html += `<td class="timetable-cell editable" onclick="editTimetableCell('${grade}', ${dIndex}, ${tIndex})">${value}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            });
        }
        function editTimetableCell(grade, dayIndex, timeIndex) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'teacher') return;
            editingCell = {grade, dayIndex, timeIndex};
            document.getElementById('editTimetableValue').value = timetables[grade][dayIndex][timeIndex] || '';
            const modal = new bootstrap.Modal(document.getElementById('editTimetableModal'));
            modal.show();
        }
        function saveTimetableEdit() {
            if (!editingCell) return;
            const value = document.getElementById('editTimetableValue').value;
            timetables[editingCell.grade][editingCell.dayIndex][editingCell.timeIndex] = value;
            localStorage.setItem('timetables', JSON.stringify(timetables));
            bootstrap.Modal.getInstance(document.getElementById('editTimetableModal')).hide();
            renderTimetable(editingCell.grade);
            editingCell = null;
        }
        function toggleEditTimetable() {
            // Already editable via clicks
            alert('Click on cells to edit (admin/teacher only).');
        }

        // Exams
        function showAddExamModal() {
            // Stub: add example
            exams.push({
                id: Date.now(),
                name: 'Term 4 Exams',
                date: '2025-12-10',
                subject: 'Mathematics',
                status: 'Scheduled'
            });
            localStorage.setItem('exams', JSON.stringify(exams));
            renderExams();
        }
        function renderExams() {
            requestAnimationFrame(() => {
                document.getElementById('examTable').innerHTML = exams.map(e => `
                    <tr>
                        <td>${e.name}</td>
                        <td>${e.date}</td>
                        <td>${e.subject}</td>
                        <td>${e.status}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="generateReportCard(${e.id})">Report</button></td>
                    </tr>
                `).join('');
            });
        }
        function generateReportCard(id) {
            // Stub
            alert('Report card generated for exam ID: ' + (id || 'all'));
        }

        // HR
        function showAddStaffModal() {
            staff.push({
                id: Date.now(),
                name: 'New Teacher',
                role: 'Teacher',
                department: 'Academics',
                status: 'Active'
            });
            localStorage.setItem('staff', JSON.stringify(staff));
            renderHR();
        }
        function renderHR() {
            requestAnimationFrame(() => {
                document.getElementById('staffTable').innerHTML = staff.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${s.role}</td>
                        <td>${s.department}</td>
                        <td>${s.status}</td>
                        <td><button class="btn btn-sm btn-info" onclick="editStaff(${s.id})">Edit</button></td>
                    </tr>
                `).join('');
            });
        }
        function editStaff(id) {
            // Stub
            alert('Edit staff ID: ' + id);
        }

        // Communication
        function sendMessage() {
            const text = document.getElementById('messageText').value;
            if (!text) return;
            messages.push({
                id: Date.now(),
                text,
                recipient: document.getElementById('messageRecipient').value,
                timestamp: new Date().toLocaleString()
            });
            localStorage.setItem('messages', JSON.stringify(messages));
            document.getElementById('messageText').value = '';
            renderCommunication();
        }
        function renderCommunication() {
            requestAnimationFrame(() => {
                document.getElementById('messageHistory').innerHTML = messages.map(m => `
                    <div class="alert alert-info">
                        <small>${m.timestamp} - To: ${m.recipient}</small>
                        <p>${m.text}</p>
                    </div>
                `).join('');
            });
        }

        // Content
        function showUploadContentModal() {
            const modal = new bootstrap.Modal(document.getElementById('uploadContentModal'));
            modal.show();
        }
        function saveContent() {
            const name = document.getElementById('contentName').value;
            const type = document.getElementById('contentType').value;
            const grade = document.getElementById('contentGrade').value;
            const subject = document.getElementById('contentSubject').value;
            const file = document.getElementById('contentFile').files[0];
            if (!file) return alert('Select a file');
            const reader = new FileReader();
            reader.onload = function(e) {
                content.push({
                    id: Date.now(),
                    name,
                    type,
                    grade,
                    subject,
                    data: e.target.result,
                    filename: file.name,
                    mimeType: file.type
                });
                localStorage.setItem('content', JSON.stringify(content));
                renderContent();
                bootstrap.Modal.getInstance(document.getElementById('uploadContentModal')).hide();
            };
            reader.readAsDataURL(file);
        }
        function renderContent() {
            requestAnimationFrame(() => {
                let filteredContent = content;
                const gradeFilter = document.getElementById('contentGradeFilter').value;
                const subjectFilter = document.getElementById('contentSubjectFilter').value.toLowerCase();
                if (gradeFilter) filteredContent = filteredContent.filter(c => c.grade === gradeFilter);
                if (subjectFilter) filteredContent = filteredContent.filter(c => c.subject.toLowerCase().includes(subjectFilter));
                if (currentUser.role === 'student') {
                    filteredContent = filteredContent.filter(c => ['Textbook', 'Examination', 'Online Lesson'].includes(c.type));
                }
                document.getElementById('contentTable').innerHTML = filteredContent.map(c => `
                    <tr>
                        <td>${c.type}</td>
                        <td>${c.name}</td>
                        <td>${c.grade || 'N/A'}</td>
                        <td>${c.subject || 'N/A'}</td>
                        <td>
                            <a href="${c.data}" download="${c.filename}" class="btn btn-sm btn-info">Download</a>
                            <button class="btn btn-sm btn-secondary" onclick="previewContent(${c.id})">Preview</button>
                        </td>
                    </tr>
                `).join('');
            });
        }
        function previewContent(id) {
            const c = content.find(con => con.id === id);
            if (!c) return;
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '';
            if (c.mimeType.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = c.data;
                img.style.maxWidth = '100%';
                previewBody.appendChild(img);
            } else if (c.mimeType === 'application/pdf') {
                const iframe = document.createElement('iframe');
                iframe.src = c.data;
                iframe.style.width = '100%';
                iframe.style.height = '500px';
                previewBody.appendChild(iframe);
            } else if (c.mimeType.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = c.data;
                video.controls = true;
                video.style.maxWidth = '100%';
                previewBody.appendChild(video);
            } else if (c.mimeType.startsWith('text/')) {
                const pre = document.createElement('pre');
                pre.textContent = atob(c.data.split(',')[1]); // Decode base64
                previewBody.appendChild(pre);
            } else {
                previewBody.innerHTML = '<p>Preview not supported for this file type. Download to view.</p>';
            }
            const modal = new bootstrap.Modal(document.getElementById('previewContentModal'));
            modal.show();
        }

        // AI Research with Grok
        async function sendGrokQuery() {
            const query = document.getElementById('grokQuery').value;
            if (!query) return;
            const apiKey = document.getElementById('grokApiKey').value;
            if (!apiKey) return alert('Enter your xAI API Key');
            addChatMessage('user', query);
            document.getElementById('grokQuery').value = '';
            try {
                const response = await fetch('https://api.x.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'grok-beta',
                        messages: [...chatHistory, {role: 'system', content: 'You are Grok, a helpful and engaging AI built by xAI. Be concise, witty, and informative.'}, {role: 'user', content: query}]
                    })
                });
                const data = await response.json();
                const reply = data.choices[0].message.content;
                addChatMessage('assistant', reply);
            } catch (error) {
                addChatMessage('assistant', 'Error: ' + error.message + '. Check API key and network.');
            }
        }
        function addChatMessage(role, content) {
            chatHistory.push({role, content});
            const div = document.createElement('div');
            div.classList.add('chat-message', `chat-${role}`);
            div.textContent = `${role === 'user' ? 'You' : 'Grok'}: ${content}`;
            document.getElementById('chatHistory').appendChild(div);
            div.scrollIntoView();
        }

        // Reports
        function exportToExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, `${filename}-2025.xlsx`);
        }

        function logout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('currentUser')) {
                currentUser = JSON.parse(localStorage.getItem('currentUser'));
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                initApp();
            }
        });
    </script>
</body>
</html>
