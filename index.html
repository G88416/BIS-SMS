<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced School Management System (ASMS) - Bophelong Independent School</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe SDK -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            height: 100vh;
            position: fixed;
            width: 260px;
            padding: 20px;
            overflow-y: auto;
            transition: width 0.3s ease;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link {
            color: #fff;
            font-weight: 500;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 10px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }
        .content {
            margin-left: 260px;
            padding: 40px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        .content.expanded { margin-left: 70px; }
        .card-metric {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .card-metric:hover { transform: translateY(-8px); }
        .table {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .table th { background: rgba(255, 255, 255, 0.2); color: #fff; }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            color: #333;
        }
        .btn-toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 270px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
        }
        .btn-toggle-sidebar.expanded { left: 80px; }
        #notificationBell {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        .admin-only { display: block; }
        .teacher-only { display: none; }
        .parent-only { display: none; }
        .student-only { display: none; }
        .non-student { display: block; }
        .dark-mode { filter: brightness(0.8); }
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }
        .login-card {
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
        }
        .login-title {
            font-weight: 700;
            color: #1e3c72;
            text-align: center;
        }
        .report-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }
        .timetable-cell {
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin: 2px;
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
        }
        .chat-user { background: rgba(255, 255, 255, 0.2); }
        .chat-assistant { background: rgba(0, 255, 0, 0.1); }
        .editable { cursor: pointer; }
        .editable:hover { background: rgba(255, 255, 255, 0.2); }
        .payslip-preview { background: white; color: black; padding: 20px; border-radius: 10px; }
        .hr-chart { height: 300px; }
        .leave-calendar { height: 400px; }
        .applicant-stage { cursor: pointer; }
        .cert-expiry { color: #ffc107; }
        .cert-expired { color: #dc3545; }
        .lesson-plan { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 10px 0; }
        .file-preview { max-height: 300px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .refresh-btn { position: absolute; top: 10px; right: 10px; }
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 70px; }
            .btn-toggle-sidebar { left: 80px; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x text-primary mb-3"></i>
                <h3 class="login-title">ASMS - Bophelong Independent School</h3>
                <p class="text-muted">Advanced School Management System</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <button type="button" class="btn btn-secondary w-100 mb-3" onclick="biometricLogin()">
                    <i class="fas fa-fingerprint me-2"></i>Biometric Login
                </button>
                <div class="login-demo">
                    <p class="mb-1"><strong>Admin:</strong> admin / admin123</p>
                    <p class="mb-1"><strong>Teacher:</strong> teacher / teacher123</p>
                    <p class="mb-1"><strong>Parent:</strong> parent / parent123</p>
                    <p class="mb-0"><strong>Student:</strong> student / student123</p>
                </div>
            </form>
        </div>
    </div>
    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-warning rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>
        <button class="btn btn-sm btn-light btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="sidebar">
            <h4 class="mb-4 text-center"><i class="fas fa-school me-2"></i><span class="nav-text">ASMS</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only non-student"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
                <li class="non-student"><a href="#admission" class="nav-link" onclick="showSection('admission')"><i class="fas fa-user-plus me-2"></i><span class="nav-text">Admission</span></a></li>
                <li class="non-student"><a href="#students" class="nav-link" onclick="showSection('students')"><i class="fas fa-users me-2"></i><span class="nav-text">Student Info</span></a></li>
                <li class="non-student"><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
                <li class="non-student"><a href="#fees" class="nav-link" onclick="showSection('fees')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">Fee Management</span></a></li>
                <li class="teacher-only non-student"><a href="#timetable" class="nav-link" onclick="showSection('timetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Timetable</span></a></li>
                <li class="teacher-only non-student"><a href="#teachers" class="nav-link" onclick="showSection('teachers')"><i class="fas fa-chalkboard-teacher me-2"></i><span class="nav-text">Advanced Teachers</span></a></li>
                <li class="teacher-only non-student"><a href="#exams" class="nav-link" onclick="showSection('exams')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Examinations</span></a></li>
                <li class="admin-only non-student"><a href="#hr" class="nav-link" onclick="showSection('hr')"><i class="fas fa-user-tie me-2"></i><span class="nav-text">HR Management</span></a></li>
                <li class="non-student"><a href="#communication" class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments me-2"></i><span class="nav-text">Communication</span></a></li>
                <li class="admin-only non-student"><a href="#content" class="nav-link" onclick="showSection('content')"><i class="fas fa-book me-2"></i><span class="nav-text">Content</span></a></li>
                <li class="admin-only non-student"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Reports</span></a></li>
                <li class="admin-only non-student"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="student-only"><a href="#aiResearch" class="nav-link" onclick="showSection('aiResearch')"><i class="fas fa-robot me-2"></i><span class="nav-text">AI Research</span></a></li>
                <li class="parent-only"><a href="#parentPortal" class="nav-link" onclick="showSection('parentPortal')"><i class="fas fa-home me-2"></i><span class="nav-text">Parent Portal</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
        <div class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section">
                <h2>School Dashboard <button class="btn btn-sm btn-info refresh-btn" onclick="refreshDashboard()"><i class="fas fa-sync-alt"></i> Refresh</button></h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Students</h5><h3 id="totalStudents">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's Attendance</h5><h3 id="todayAttendance">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Fees</h5><h3 id="pendingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Upcoming Exams</h5><h3 id="upcomingExams">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaffDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeavesDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositionsDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Performance</h5><h3 id="avgPerformanceDash">0%</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4"></canvas>
            </section>
            <!-- Admission Management -->
            <section id="admission" class="section d-none">
                <h2>Admission Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddAdmissionModal()">New Application</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkAdmissionModal()">Bulk Import (CSV/Excel/Word/PDF)</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search admissions..." id="admissionSearch">
                    <button class="btn btn-outline-secondary" onclick="searchAdmissions()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="admissionTable"></tbody>
                </table>
            </section>
            <!-- Student Information System -->
            <section id="students" class="section d-none">
                <h2>Student Information System</h2>
                <button class="btn btn-primary mb-3" onclick="showAddStudentModal()">Add Student</button>
                <button class="btn btn-info mb-3" onclick="showBulkStudentModal()">Bulk Import Students (CSV/Excel/Word/PDF)</button>
                <button class="btn btn-info mb-3" onclick="importClassListFromPDF()">Import Class List from MX-4051 PDF</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search student..." id="studentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchStudents()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Parent</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="studentTable"></tbody>
                </table>
            </section>
            <!-- Attendance Management -->
            <section id="attendance" class="section d-none">
                <h2>Attendance Management</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="date" id="attendanceDate" class="form-control" onchange="loadAttendance()">
                    </div>
                    <div class="col-md-4">
                        <select id="attendanceClass" class="form-control" onchange="loadAttendance()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success mb-3" onclick="showBulkAttendanceModal()">Bulk Mark Attendance</button>
                <button class="btn btn-info mb-3" onclick="syncBiometricAttendance()">Sync Biometric Attendance</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </section>
            <!-- Fee Management -->
            <section id="fees" class="section d-none">
                <h2>Fee Management</h2>
                <button class="btn btn-primary mb-3" onclick="showGenerateInvoiceModal()">Generate Invoice</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkUploadFeesModal()">Bulk Import (CSV/Excel/Word/PDF)</button>
                <button class="btn btn-warning mb-3" onclick="sendFeeReminders()">Send Reminders</button>
                <div class="row mb-3">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Collected</h5><h3 id="totalCollected">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Outstanding</h5><h3 id="outstandingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Overdue</h5><h3 id="overdueFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Payment Rate</h5><h3 id="paymentRate">0%</h3></div></div>
                </div>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search fees..." id="feeSearch">
                    <button class="btn btn-outline-secondary" onclick="searchFees()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Student</th><th>Amount</th><th>Due Date</th><th>Paid Date</th><th>Status</th><th>Receipt</th><th>Actions</th></tr></thead>
                    <tbody id="feeTable"></tbody>
                </table>
                <div id="feeHistory" class="mt-4"></div>
            </section>
            <!-- Timetable Management -->
            <section id="timetable" class="section d-none">
                <h2>Timetable Management</h2>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="timetableGrade" class="form-control" onchange="loadTimetable()">
                            <option value="">Select Grade</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="timetableTeacher" class="form-control" onchange="highlightTeacherSchedule()">
                            <option value="">Select Teacher</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="showAddTimeSlotModal()">Add Time Slot</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning" onclick="checkTimetableConflicts()">Check Conflicts</button>
                    </div>
                </div>
                <div id="timetableContainer"></div>
            </section>
            <!-- Advanced Teachers Module -->
            <section id="teachers" class="section d-none teacher-only">
                <h2>Advanced Teachers Module</h2>
                <ul class="nav nav-tabs mb-3" id="teachersTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#lesson-plans" onclick="renderLessonPlans()">Lesson Plans</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#grading" onclick="renderGrading()">Grading</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#resources" onclick="renderResources()">Resources</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#student-progress" onclick="renderStudentProgress()">Student Progress</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="lesson-plans">
                        <button class="btn btn-primary mb-3" onclick="showAddLessonPlanModal()">Add Lesson Plan</button>
                        <div id="lessonPlansList"></div>
                    </div>
                    <div class="tab-pane fade" id="grading">
                        <button class="btn btn-primary mb-3" onclick="showAddGradeModal()">Add Grade</button>
                        <select id="gradingClass" class="form-control mb-3" onchange="loadGrading()">
                            <option value="">Select Class</option>
                        </select>
                        <table class="table table-striped">
                            <thead><tr><th>Student</th><th>Subject</th><th>Grade</th><th>Comments</th><th>Actions</th></tr></thead>
                            <tbody id="gradingTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="resources">
                        <button class="btn btn-primary mb-3" onclick="showAddResourceModal()">Add Resource</button>
                        <div id="resourcesList"></div>
                    </div>
                    <div class="tab-pane fade" id="student-progress">
                        <select id="progressStudent" class="form-control mb-3" onchange="loadStudentProgress()">
                            <option value="">Select Student</option>
                        </select>
                        <canvas id="progressChart" class="mt-4"></canvas>
                        <div id="progressDetails"></div>
                    </div>
                </div>
            </section>
            <!-- Examination Management -->
            <section id="exams" class="section d-none">
                <h2>Examination Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddExamModal()">Schedule Exam</button>
                <button class="btn btn-info mb-3" onclick="showEnterMarksModal()">Enter Marks</button>
                <button class="btn btn-success mb-3" onclick="generateAllReportCards()">Generate All Report Cards</button>
                <button class="btn btn-warning mb-3" onclick="generateHallTickets()">Generate Hall Tickets</button>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="examGradeFilter" class="form-control" onchange="renderExams()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="examSubjectFilter" class="form-control" placeholder="Filter by Subject" oninput="debounce(renderExams, 300)()">
                    </div>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Exam</th><th>Date</th><th>Subject</th><th>Grade</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="examTable"></tbody>
                </table>
                <div id="marksEntry" class="mt-4 d-none">
                    <h3>Enter Marks for <span id="marksExamName"></span></h3>
                    <table class="table table-striped">
                        <thead><tr><th>Student</th><th>Marks</th></tr></thead>
                        <tbody id="marksTable"></tbody>
                    </table>
                    <button class="btn btn-primary" onclick="saveMarks()">Save</button>
                </div>
            </section>
            <!-- Enhanced HR Management -->
            <section id="hr" class="section d-none admin-only">
                <h2>Human Resource Management</h2>
                <ul class="nav nav-tabs mb-3" id="hrTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#hr-staff" onclick="renderStaff()">Staff</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-payroll" onclick="renderPayrolls()">Payroll</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-leaves" onclick="renderLeaves()">Leaves</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-performance" onclick="renderReviews()">Performance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-recruitment" onclick="renderJobs()">Recruitment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-audit" onclick="renderAudit()">Audit Trail</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="hr-staff">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddStaffModal()">Add Staff</button>
                                <button class="btn btn-secondary ms-2" onclick="syncStaffBiometric()">Sync Biometric</button>
                                <button class="btn btn-info ms-2" onclick="generateStaffReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Search staff..." id="staffSearch" oninput="debounce(renderStaff, 300)()">
                                    <select id="staffFilterRole" class="form-select" style="max-width: 150px;" onchange="renderStaff()">
                                        <option value="">All Roles</option>
                                        <option value="Teacher">Teacher</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Support">Support</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaff">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Active</h5><h3 id="activeStaff">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Salary</h5><h3 id="avgSalary">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Expiring Certs</h5><h3 id="expiringCerts">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Department</th><th>Salary</th><th>Tax #</th><th>UIF #</th><th>Cert Expiry</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="staffTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-payroll">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddPayrollModal()">Add Payroll</button>
                                <button class="btn btn-info ms-2" onclick="generatePayroll()">Generate Payroll</button>
                                <button class="btn btn-success ms-2" onclick="exportPayrollToExcel()">Export Payroll</button>
                                <button class="btn btn-warning ms-2" onclick="calculateCompliance()">Check Compliance</button>
                            </div>
                            <div class="col-md-6">
                                <input type="month" id="payrollMonthFilter" class="form-control" onchange="renderPayrolls()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Payroll</h5><h3 id="totalPayroll">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Deductions</h5><h3 id="totalDeductions">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Net Payroll</h5><h3 id="netPayroll">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Compliance Score</h5><h3 id="complianceScore">0%</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Month</th><th>Salary</th><th>Deductions</th><th>Tax</th><th>UIF</th><th>Net</th><th>Actions</th></tr></thead>
                            <tbody id="payrollTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-leaves">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddLeaveModal()">Add Leave Request</button>
                                <button class="btn btn-info ms-2" onclick="generateLeaveReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="date" id="leaveDateFilter" class="form-control" onchange="renderLeaves()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Requests</h5><h3 id="totalLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending</h5><h3 id="pendingLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Approved</h5><h3 id="approvedLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Rejected</h5><h3 id="rejectedLeaves">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Type</th><th>Date</th><th>Days</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="leavesTable"></tbody>
                        </table>
                        <canvas id="leaveChart" class="mt-4 hr-chart"></canvas>
                    </div>
                    <div class="tab-pane fade" id="hr-performance">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddReviewModal()">Add Review</button>
                                <button class="btn btn-info ms-2" onclick="generatePerformanceReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="date" id="reviewDateFilter" class="form-control" onchange="renderReviews()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Score</h5><h3 id="avgScore">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Reviews</h5><h3 id="totalReviews">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Goals Achieved</h5><h3 id="goalsAchieved">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Feedback</h5><h3 id="pendingFeedback">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Date</th><th>Score</th><th>Comments</th><th>Actions</th></tr></thead>
                            <tbody id="reviewsTable"></tbody>
                        </table>
                        <canvas id="performanceChart" class="mt-4 hr-chart"></canvas>
                    </div>
                    <div class="tab-pane fade" id="hr-recruitment">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddJobModal()">Add Job</button>
                                <button class="btn btn-success ms-2" onclick="showApplyJobModal()">Apply</button>
                                <button class="btn btn-info ms-2" onclick="generateRecruitmentReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" placeholder="Search jobs..." id="jobSearch" oninput="debounce(renderJobs, 300)()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositions">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Applications</h5><h3 id="totalApplications">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Interviews Scheduled</h5><h3 id="interviewsScheduled">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Hire Rate</h5><h3 id="hireRate">0%</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Title</th><th>Department</th><th>Applications</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="jobTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-audit">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-info" onclick="generateAuditReport()">Generate Report</button>
                                <button class="btn btn-success ms-2" onclick="exportAuditToExcel()">Export</button>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="date" id="auditDateFilter" class="form-control" onchange="renderAudit()">
                                    <select id="auditActionFilter" class="form-select" style="max-width: 150px;" onchange="renderAudit()">
                                        <option value="">All Actions</option>
                                        <option value="Update">Update</option>
                                        <option value="Delete">Delete</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Entries</h5><h3 id="totalAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's</h5><h3 id="todayAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>High Risk</h5><h3 id="highRiskAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Compliance Issues</h5><h3 id="complianceIssues">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Details</th><th>Risk</th></tr></thead>
                            <tbody id="auditTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <!-- Communication -->
            <section id="communication" class="section d-none non-student">
                <h2>Communication</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="showSendMessageModal()">Send Message</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success" onclick="viewAnnouncements()">View Announcements</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-info" onclick="startChat()">Live Chat</button>
                    </div>
                </div>
                <div id="messagesContainer"></div>
            </section>
            <!-- Content Management -->
            <section id="content" class="section d-none">
                <h2>Content Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddContentModal()">Add Content</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search content..." id="contentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchContent()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="contentTable"></tbody>
                </table>
            </section>
            <!-- Reports -->
            <section id="reports" class="section d-none admin-only">
                <h2>Reports</h2>
                <select id="reportType" class="form-select mb-3" style="width: auto;">
                    <option value="attendance">Attendance Report</option>
                    <option value="fees">Fee Report</option>
                    <option value="exams">Exam Report</option>
                    <option value="hr">HR Report</option>
                </select>
                <button class="btn btn-primary mb-3" onclick="generateReport()">Generate</button>
                <button class="btn btn-success mb-3" onclick="exportReport()">Export</button>
                <div id="reportOutput" class="d-none"></div>
            </section>
            <!-- Settings -->
            <section id="settings" class="section d-none admin-only">
                <h2>Settings</h2>
                <div class="row">
                    <div class="col-md-6">
                        <h5>SMS Integration (WinSMS)</h5>
                        <div class="mb-3">
                            <label>Username</label>
                            <input type="text" id="smsUsername" class="form-control" placeholder="WinSMS Username">
                        </div>
                        <div class="mb-3">
                            <label>Password</label>
                            <input type="password" id="smsPassword" class="form-control" placeholder="WinSMS Password">
                        </div>
                        <button class="btn btn-primary" onclick="saveSMSSettings()">Save SMS Settings</button>
                    </div>
                    <div class="col-md-6">
                        <h5>HR Settings</h5>
                        <div class="mb-3">
                            <label>Annual Leave Days</label>
                            <input type="number" id="annualLeaveDays" class="form-control" value="21">
                        </div>
                        <div class="mb-3">
                            <label>UIF Rate (%)</label>
                            <input type="number" id="uifRate" class="form-control" value="1" step="0.1">
                        </div>
                        <button class="btn btn-primary" onclick="updateHRSettings()">Update HR Settings</button>
                    </div>
                </div>
                <div class="mt-4">
                    <button class="btn btn-secondary" onclick="backupData()">Backup Data</button>
                    <button class="btn btn-warning ms-2" onclick="restoreData()">Restore Data</button>
                </div>
            </section>
            <!-- Parent Portal -->
            <section id="parentPortal" class="section d-none parent-only">
                <h2>Parent Portal</h2>
                <div id="parentChildInfo"></div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4>Attendance</h4>
                        <div id="parentAttendance"></div>
                    </div>
                    <div class="col-md-6">
                        <h4>Fees</h4>
                        <div id="parentFees"></div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4>Grades</h4>
                        <div id="parentGrades"></div>
                    </div>
                    <div class="col-md-6">
                        <h4>Announcements</h4>
                        <div id="parentAnnouncements"></div>
                    </div>
                </div>
            </section>
            <!-- AI Research for Students -->
            <section id="aiResearch" class="section d-none student-only">
                <h2>AI Research Assistant</h2>
                <div class="mb-3">
                    <input type="text" id="researchQuery" class="form-control" placeholder="Ask a research question...">
                    <button class="btn btn-primary mt-2" onclick="researchWithAI()">Research</button>
                </div>
                <div id="researchResults"></div>
            </section>
            <!-- Modals -->
            <!-- Bulk Admission Modal -->
            <div class="modal fade" id="bulkAdmissionModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Import Admissions (CSV/Excel/Word/PDF)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="admissionFile" class="form-control" accept=".csv,.xlsx,.doc,.docx,.pdf">
                            <div id="admissionPreview" class="mt-3 file-preview"></div>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="previewBulkFile('admissionFile', 'admissionPreview')">Preview</button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkAdmissions()">Import</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Student Import Modal -->
            <div class="modal fade" id="bulkStudentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Import Students (CSV/Excel/Word/PDF)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="studentFile" class="form-control" accept=".csv,.xlsx,.doc,.docx,.pdf">
                            <div id="studentPreview" class="mt-3 file-preview"></div>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="previewBulkFile('studentFile', 'studentPreview')">Preview</button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkStudents()">Import</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Fees Upload Modal -->
            <div class="modal fade" id="bulkUploadFeesModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Upload Fees (CSV/Excel/Word/PDF)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="feesFile" class="form-control" accept=".csv,.xlsx,.doc,.docx,.pdf">
                            <div id="feesPreview" class="mt-3 file-preview"></div>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="previewBulkFile('feesFile', 'feesPreview')">Preview</button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkFees()">Upload</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Other modals remain unchanged... -->
            <!-- New Admission Modal -->
            <div class="modal fade" id="addAdmissionModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">New Admission</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="admissionName" class="form-control mb-2" placeholder="Name">
                            <input type="text" id="admissionGrade" class="form-control mb-2" placeholder="Grade">
                            <input type="text" id="admissionUsername" class="form-control mb-2" placeholder="Student Username">
                            <input type="password" id="admissionPassword" class="form-control mb-2" placeholder="Student Password">
                            <select id="admissionStatus" class="form-control mb-2">
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveAdmission()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Student Modal -->
            <div class="modal fade" id="addStudentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Student</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="studentName" class="form-control mb-2" placeholder="Full Name">
                            <input type="text" id="studentGrade" class="form-control mb-2" placeholder="Grade">
                            <input type="text" id="studentParent" class="form-control mb-2" placeholder="Parent Name">
                            <input type="text" id="studentAccession" class="form-control mb-2" placeholder="Accession Number">
                            <input type="text" id="studentEducator" class="form-control mb-2" placeholder="Educator">
                            <select id="studentStatus" class="form-control mb-2">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveStudent()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Attendance Marking Modal -->
            <div class="modal fade" id="attendanceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Mark Attendance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="attendanceStudentId">
                            <p id="attendanceStudentName"></p>
                            <input type="date" id="attendanceModalDate" class="form-control mb-2">
                            <select id="attendanceStatus" class="form-control mb-2">
                                <option value="Present">Present</option>
                                <option value="Absent">Absent</option>
                                <option value="Late">Late</option>
                            </select>
                            <textarea id="attendanceNotes" class="form-control" placeholder="Notes"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveAttendanceMark()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Attendance Modal -->
            <div class="modal fade" id="bulkAttendanceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Mark Attendance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="date" id="bulkAttendanceDate" class="form-control mb-2">
                            <select id="bulkStatus" class="form-control mb-2">
                                <option value="Present">All Present</option>
                                <option value="Absent">All Absent</option>
                            </select>
                            <select id="bulkClass" class="form-control mb-2">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="bulkMarkAttendance()">Mark</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Generate Invoice Modal -->
            <div class="modal fade" id="generateInvoiceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Generate Invoice</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="invoiceStudent" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <input type="number" id="invoiceAmount" class="form-control mb-2" placeholder="Amount (R)">
                            <input type="date" id="invoiceDueDate" class="form-control mb-2">
                            <textarea id="invoiceDescription" class="form-control mb-2" placeholder="Description"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveInvoice()">Generate</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Time Slot Modal -->
            <div class="modal fade" id="addTimeSlotModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Time Slot</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="timeSlotGrade" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="timeSlotDay" class="form-control mb-2">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                            </select>
                            <input type="time" id="timeSlotTime" class="form-control mb-2">
                            <input type="text" id="timeSlotSubject" class="form-control mb-2" placeholder="Subject/Teacher">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveTimeSlot()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Exam Modal -->
            <div class="modal fade" id="addExamModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Schedule Exam</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="examName" class="form-control mb-2" placeholder="Exam Name">
                            <input type="date" id="examDate" class="form-control mb-2">
                            <input type="text" id="examSubject" class="form-control mb-2" placeholder="Subject">
                            <select id="examGrade" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="examStatus" class="form-control mb-2">
                                <option value="Scheduled">Scheduled</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveExam()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Payroll Modal -->
            <div class="modal fade" id="addPayrollModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Payroll</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="payrollStaff" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <input type="month" id="payrollMonth" class="form-control mb-2">
                            <input type="number" id="payrollSalary" class="form-control mb-2" placeholder="Gross Salary (R)">
                            <input type="number" id="payrollDeductions" class="form-control mb-2" placeholder="Deductions (R)">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="savePayroll()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Notifications Modal (example, add if needed) -->
            <div class="modal fade" id="notificationsModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Notifications</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="notificationsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        <script>
    // Global data structures (mock initial data)
    let students = [], admissions = [], fees = [], timetable = {}, exams = [], staff = [], payrolls = [], leaveRequests = [], performanceReviews = [], jobs = [], auditLog = [], messages = [], contents = [], announcements = [], grades = [], attendanceRecords = {}, users = [], currentUser = {}, notifications = [], hrSettings = { annualLeaveDays: 21, uifRate: 0.01 }, smsSettings = { username: '', password: '' };
    let dashboardChart, leaveChart, performanceChart;
    let editingStaffId, editingReviewId, editingJob;

    // Utility function for debounce
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // File preview utility for bulk imports
    function previewBulkFile(fileInputId, previewId) {
        const fileInput = document.getElementById(fileInputId);
        const previewDiv = document.getElementById(previewId);
        const file = fileInput.files[0];
        if (!file) return;

        const fileType = file.name.split('.').pop().toLowerCase();
        previewDiv.innerHTML = '<p><strong>Previewing:</strong> ' + file.name + '</p>';

        const reader = new FileReader();
        reader.onload = function(e) {
            let content = '';
            if (fileType === 'csv') {
                content = e.target.result.split('\n').slice(0, 10).join('<br>');
            } else if (fileType === 'xlsx') {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                content = XLSX.utils.sheet_to_html(firstSheet).split('</table>')[0] + '</table>';
            } else if (fileType === 'pdf') {
                // Mock PDF preview (in real impl, use pdf.js)
                content = '<p>PDF content preview (mock): First few lines extracted...</p><p>Line 1: Header</p><p>Line 2: Data Row 1</p>';
            } else if (fileType === 'doc' || fileType === 'docx') {
                // Mock Word preview (in real impl, use mammoth.js or similar)
                content = '<p>Word document preview (mock): Document text extracted...</p><p>Section 1: Student Name, Grade...</p>';
            }
            previewDiv.innerHTML += '<div class="file-preview">' + content + '</div>';
        };

        if (fileType === 'csv' || fileType === 'txt') {
            reader.readAsText(file);
        } else if (fileType === 'xlsx' || fileType === 'pdf' || fileType === 'doc' || fileType === 'docx') {
            reader.readAsArrayBuffer(file);
        }
    }

    // Bulk Admissions Import (enhanced for Word/PDF)
    function uploadBulkAdmissions() {
        const file = document.getElementById('admissionFile').files[0];
        if (!file) return;
        const reader = new FileReader();
        const fileType = file.name.split('.').pop().toLowerCase();
        if (fileType === 'pdf' || fileType === 'doc' || fileType === 'docx') {
            addNotification('Word/PDF admissions parsed and imported (mock)', 'success');
            // Mock add some admissions
            for (let i = 0; i < 3; i++) {
                admissions.push({ id: Date.now() + i, name: 'Bulk Admission ' + i, grade: 'Grade 1', status: 'Pending' });
            }
        } else {
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                jsonData.forEach(row => {
                    const id = Date.now() + Math.random();
                    admissions.push({
                        id,
                        name: row.Name || 'Unknown',
                        grade: row.Grade || 'Unknown',
                        status: row.Status || 'Pending'
                    });
                });
                saveData();
                renderAdmissions();
                addNotification('Bulk admissions imported', 'success');
            };
            reader.readAsArrayBuffer(file);
        }
        bootstrap.Modal.getInstance(document.getElementById('bulkAdmissionModal')).hide();
    }

    // Enhanced uploadBulkStudents with preview support and Word/PDF
    function uploadBulkStudents() {
        const file = document.getElementById('studentFile').files[0];
        if (!file) return;
        const fileType = file.name.split('.').pop().toLowerCase();
        if (fileType === 'pdf' || fileType === 'doc' || fileType === 'docx') {
            addNotification('Word/PDF parsed and imported (mock)', 'success');
            // Mock add some students
            for (let i = 0; i < 5; i++) {
                students.push({ id: Date.now() + i, name: 'Bulk Student ' + i, grade: 'Grade 1', parent: 'Parent', status: 'Active' });
            }
        } else {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                jsonData.forEach(row => {
                    const id = Date.now() + Math.random();
                    students.push({
                        id,
                        name: row.Name || 'Unknown',
                        grade: row.Grade || 'Unknown',
                        parent: row.Parent || 'Unknown',
                        status: row.Status || 'Active'
                    });
                });
                saveData();
                renderStudents();
                integrateEducatorsAsStaff();
                addNotification('Bulk students imported', 'success');
            };
            reader.readAsArrayBuffer(file);
        }
        bootstrap.Modal.getInstance(document.getElementById('bulkStudentModal')).hide();
    }

    // Enhanced uploadBulkFees with preview support and Word/PDF
    function uploadBulkFees() {
        const file = document.getElementById('feesFile').files[0];
        if (!file) return;
        const fileType = file.name.split('.').pop().toLowerCase();
        if (fileType === 'pdf' || fileType === 'doc' || fileType === 'docx') {
            addNotification('Word/PDF fees parsed and uploaded (mock)', 'success');
            // Mock add some fees
            for (let i = 0; i < 3; i++) {
                fees.push({ id: Date.now() + i, studentId: students[0]?.id || 1, amount: 1000 + i * 100, dueDate: new Date().toISOString().split('T')[0], status: 'Pending' });
            }
        } else {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                jsonData.forEach(row => {
                    const id = Date.now() + Math.random();
                    fees.push({
                        id,
                        studentId: row.StudentID || 1,
                        amount: parseFloat(row.Amount) || 0,
                        dueDate: row.DueDate || '',
                        status: row.Status || 'Pending'
                    });
                });
                saveData();
                renderFees();
                addNotification('Bulk fees uploaded', 'success');
            };
            reader.readAsArrayBuffer(file);
        }
        bootstrap.Modal.getInstance(document.getElementById('bulkUploadFeesModal')).hide();
    }

    // Dashboard Refresh
    function refreshDashboard() {
        loadData(); // Reload from storage
        updateDashboardMetrics();
        if (dashboardChart) dashboardChart.destroy();
        // Re-render chart (mock)
        const ctx = document.getElementById('dashboardChart').getContext('2d');
        dashboardChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar'],
                datasets: [{ label: 'Attendance', data: [65, 59, 80] }]
            },
            options: { responsive: true }
        });
        addNotification('Dashboard refreshed', 'info');
    }

    function updateDashboardMetrics() {
        document.getElementById('totalStudents').textContent = students.length;
        const today = new Date().toISOString().split('T')[0];
        const todayRecords = attendanceRecords[today] || {};
        const present = Object.values(todayRecords).filter(r => r.status === 'Present').length;
        const attendanceRate = students.length > 0 ? Math.round((present / students.length) * 100) : 0;
        document.getElementById('todayAttendance').textContent = attendanceRate + '%';
        const pendingFeesAmount = fees.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
        document.getElementById('pendingFees').textContent = 'R' + pendingFeesAmount.toLocaleString();
        document.getElementById('upcomingExams').textContent = exams.filter(e => new Date(e.date) > new Date()).length;
        document.getElementById('totalStaffDash').textContent = staff.length;
        document.getElementById('pendingLeavesDash').textContent = leaveRequests.filter(l => l.status === 'Pending').length;
        document.getElementById('openPositionsDash').textContent = jobs.filter(j => j.status === 'Open').length;
        const avgPerformance = grades.length > 0 ? Math.round(grades.reduce((sum, g) => sum + g.score, 0) / grades.length) : 0;
        document.getElementById('avgPerformanceDash').textContent = avgPerformance + '%';
    }

    // ========== ORIGINAL FUNCTIONS FROM index(90).html (INTEGRATED HERE) ==========
    // (All original functions pasted below for completeness. No changes except where enhanced above.)

    // Login and Auth
    function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const user = users.find(u => u.username === username && u.password === password);
        if (user) {
            currentUser = user;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            loadData();
            showSection('dashboard');
            updateUserVisibility();
            addNotification('Login successful', 'success');
            logAudit('Login', `User ${username} logged in`);
        } else {
            addNotification('Invalid credentials', 'error');
        }
    }

    function biometricLogin() {
        addNotification('Biometric login simulated', 'info');
        login(); // Mock success
    }

    function logout() {
        currentUser = {};
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('loginPage').style.display = 'flex';
        addNotification('Logged out', 'info');
        logAudit('Logout', 'User logged out');
    }

    function updateUserVisibility() {
        const role = currentUser.role || 'student';
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = role === 'admin' ? 'block' : 'none');
        document.querySelectorAll('.teacher-only').forEach(el => el.style.display = role === 'teacher' ? 'block' : 'none');
        document.querySelectorAll('.parent-only').forEach(el => el.style.display = role === 'parent' ? 'block' : 'none');
        document.querySelectorAll('.student-only').forEach(el => el.style.display = role === 'student' ? 'block' : 'none');
        document.querySelectorAll('.non-student').forEach(el => el.style.display = role !== 'student' ? 'block' : 'none');
    }

    // Navigation
    function showSection(section) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
        document.getElementById(section).classList.remove('d-none');
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector(`a[href="#${section}"]`).classList.add('active');
        if (section === 'dashboard') updateDashboardMetrics();
        if (section === 'students') renderStudents();
        if (section === 'admission') renderAdmissions();
        if (section === 'fees') renderFees();
        if (section === 'attendance') loadAttendance();
        if (section === 'timetable') loadTimetable();
        if (section === 'exams') renderExams();
        if (section === 'hr') renderStaff();
        if (section === 'communication') renderMessages();
        if (section === 'content') renderContents();
        if (section === 'reports') generateReport();
        if (section === 'settings') loadSettings();
        if (section === 'parentPortal') loadParentPortal();
        if (section === 'aiResearch') {};
    }

    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const content = document.querySelector('.content');
        const toggleBtn = document.querySelector('.btn-toggle-sidebar');
        sidebar.classList.toggle('collapsed');
        content.classList.toggle('expanded');
        toggleBtn.classList.toggle('expanded');
    }

    // Data Persistence
    function saveData() {
        const data = {
            students, admissions, fees, timetable, exams, staff, payrolls, leaveRequests,
            performanceReviews, jobs, auditLog, messages, contents, announcements, grades,
            attendanceRecords, users, hrSettings, smsSettings
        };
        localStorage.setItem('asmsData', JSON.stringify(data));
    }

    function loadData() {
        const saved = localStorage.getItem('asmsData');
        if (saved) {
            const data = JSON.parse(saved);
            students = data.students || [];
            admissions = data.admissions || [];
            fees = data.fees || [];
            timetable = data.timetable || {};
            exams = data.exams || [];
            staff = data.staff || [];
            payrolls = data.payrolls || [];
            leaveRequests = data.leaveRequests || [];
            performanceReviews = data.performanceReviews || [];
            jobs = data.jobs || [];
            auditLog = data.auditLog || [];
            messages = data.messages || [];
            contents = data.contents || [];
            announcements = data.announcements || [];
            grades = data.grades || [];
            attendanceRecords = data.attendanceRecords || {};
            users = data.users || [
                { username: 'admin', password: 'admin123', name: 'Admin', role: 'admin' },
                { username: 'teacher', password: 'teacher123', name: 'Teacher', role: 'teacher' },
                { username: 'parent', password: 'parent123', name: 'Parent', role: 'parent' },
                { username: 'student', password: 'student123', name: 'Student', role: 'student' }
            ];
            hrSettings = data.hrSettings || { annualLeaveDays: 21, uifRate: 0.01 };
            smsSettings = data.smsSettings || { username: '', password: '' };
        }
        // Mock some data if empty
        if (students.length === 0) {
            students = [{ id: 1, name: 'John Doe', grade: 'Grade 1', parent: 'Jane Doe', status: 'Active', accession: 'ACC001', educator: 'Ms. Smith' }];
        }
        if (staff.length === 0) {
            staff = [{ id: 1, name: 'Ms. Smith', role: 'Teacher', department: 'Math', salary: 30000, taxNumber: 'TAX123', uifNumber: 'UIF456', certExpiry: '2026-01-01', status: 'Active', username: 'teacher', password: 'teacher123' }];
        }
        updateDashboardMetrics();
    }

    function populateSelects() {
        // Grades
        const grades = [...new Set(students.map(s => s.grade))];
        document.querySelectorAll('select[id*="Grade"], select[id*="class"]').forEach(sel => {
            if (!sel.hasChildNodes()) {
                sel.innerHTML += grades.map(g => `<option value="${g}">${g}</option>`).join('');
            }
        });
        // Students for invoices, etc.
        document.getElementById('invoiceStudent').innerHTML = students.map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('');
        // Staff for payroll, leaves
        document.getElementById('payrollStaff').innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('leaveStaff').innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('reviewStaff').innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        // Teachers for timetable
        document.getElementById('timetableTeacher').innerHTML = staff.filter(s => s.role === 'Teacher').map(t => `<option value="${t.name}">${t.name}</option>`).join('');
        // Exam grades
        document.getElementById('examGrade').innerHTML = grades.map(g => `<option value="${g}">${g}</option>`).join('');
        document.getElementById('examGradeFilter').innerHTML = `<option value="">All Grades</option>` + grades.map(g => `<option value="${g}">${g}</option>`).join('');
        // Time slot grades
        document.getElementById('timeSlotGrade').innerHTML = grades.map(g => `<option value="${g}">${g}</option>`).join('');
        // Bulk class
        document.getElementById('bulkClass').innerHTML = `<option value="">All Classes</option>` + grades.map(g => `<option value="${g}">${g}</option>`).join('');
        // Attendance class
        document.getElementById('attendanceClass').innerHTML = `<option value="">All Classes</option>` + grades.map(g => `<option value="${g}">${g}</option>`).join('');
        // Grading class
        document.getElementById('gradingClass').innerHTML = `<option value="">Select Class</option>` + grades.map(g => `<option value="${g}">${g}</option>`).join('');
        // Progress student
        document.getElementById('progressStudent').innerHTML = `<option value="">Select Student</option>` + students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    // Notifications
    function addNotification(message, type = 'info') {
        notifications.unshift({ message, type, timestamp: new Date().toLocaleString() });
        const badge = document.getElementById('notificationBadge');
        badge.textContent = notifications.length;
        badge.style.display = 'block';
        // Show toast (mock)
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed top-0 end-0 m-3`;
        toast.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message} <button type="button" class="btn-close float-end" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(toast);
        // Auto remove after 5s
        setTimeout(() => toast.remove(), 5000);
    }

    function renderNotifications() {
        document.getElementById('notificationsList').innerHTML = notifications.map(n => `
            <div class="alert alert-${n.type}">${n.message} <small>${n.timestamp}</small></div>
        `).join('');
    }

    // Admissions
    function renderAdmissions() {
        const search = document.getElementById('admissionSearch').value.toLowerCase();
        const filtered = admissions.filter(a => a.name.toLowerCase().includes(search));
        document.getElementById('admissionTable').innerHTML = filtered.map(a => `
            <tr>
                <td>${a.id}</td>
                <td>${a.name}</td>
                <td>${a.grade}</td>
                <td><span class="badge bg-${a.status === 'Approved' ? 'success' : 'warning'}">${a.status}</span></td>
                <td><button class="btn btn-sm btn-info">View Docs</button></td>
                <td><button class="btn btn-sm btn-primary" onclick="editAdmission(${a.id})">Edit</button></td>
            </tr>
        `).join('');
    }

    function showAddAdmissionModal() {
        new bootstrap.Modal(document.getElementById('addAdmissionModal')).show();
    }

    function saveAdmission() {
        const name = document.getElementById('admissionName').value;
        const grade = document.getElementById('admissionGrade').value;
        const username = document.getElementById('admissionUsername').value;
        const password = document.getElementById('admissionPassword').value;
        const status = document.getElementById('admissionStatus').value;
        if (name && grade) {
            const id = Date.now();
            admissions.push({ id, name, grade, status });
            if (username && password) {
                users.push({ username, password, name, role: 'student' });
            }
            saveData();
            renderAdmissions();
            bootstrap.Modal.getInstance(document.getElementById('addAdmissionModal')).hide();
            addNotification('Admission added', 'success');
        }
    }

    function editAdmission(id) {
        // Implement edit modal similar to staff
        alert('Edit admission ' + id);
    }

    function searchAdmissions() {
        renderAdmissions();
    }

    function showBulkAdmissionModal() {
        new bootstrap.Modal(document.getElementById('bulkAdmissionModal')).show();
    }

    // Students
    function renderStudents() {
        const search = document.getElementById('studentSearch').value.toLowerCase();
        const filtered = students.filter(s => s.name.toLowerCase().includes(search));
        document.getElementById('studentTable').innerHTML = filtered.map(s => `
            <tr>
                <td>${s.accession || s.id}</td>
                <td>${s.name}</td>
                <td>${s.grade}</td>
                <td>${s.parent}</td>
                <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'warning'}">${s.status}</span></td>
                <td><button class="btn btn-sm btn-info">View Docs</button></td>
                <td><button class="btn btn-sm btn-primary" onclick="editStudent(${s.id})">Edit</button></td>
            </tr>
        `).join('');
    }

    function showAddStudentModal() {
        new bootstrap.Modal(document.getElementById('addStudentModal')).show();
    }

    function saveStudent() {
        const name = document.getElementById('studentName').value;
        const grade = document.getElementById('studentGrade').value;
        const parent = document.getElementById('studentParent').value;
        const accession = document.getElementById('studentAccession').value;
        const educator = document.getElementById('studentEducator').value;
        const status = document.getElementById('studentStatus').value;
        if (name && grade) {
            const id = Date.now();
            students.push({ id, name, grade, parent, status, accession, educator });
            saveData();
            renderStudents();
            bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
            addNotification('Student added', 'success');
        }
    }

    function editStudent(id) {
        // Implement edit
        alert('Edit student ' + id);
    }

    function searchStudents() {
        renderStudents();
    }

    function showBulkStudentModal() {
        new bootstrap.Modal(document.getElementById('bulkStudentModal')).show();
    }

    function importClassListFromPDF() {
        addNotification('PDF import from MX-4051 simulated', 'info');
        // Mock
        uploadBulkStudents(); // Reuse logic
    }

    function integrateEducatorsAsStaff() {
        // Mock: Add educators from students to staff if not exist
        students.forEach(s => {
            if (s.educator && !staff.find(st => st.name === s.educator)) {
                staff.push({ id: Date.now(), name: s.educator, role: 'Teacher', department: 'General', salary: 25000, taxNumber: '', uifNumber: '', certExpiry: '2026-01-01', status: 'Active' });
            }
        });
        saveData();
    }

    // Attendance (from original)
    function loadAttendance() {
        const date = document.getElementById('attendanceDate').value;
        const classFilter = document.getElementById('attendanceClass').value;
        const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
        const records = attendanceRecords[date] || {};
        document.getElementById('attendanceTable').innerHTML = filteredStudents.map(s => {
            const record = records[s.id] || { status: 'Absent' };
            return `
                <tr>
                    <td>${s.accession || s.id}</td>
                    <td>${s.name}</td>
                    <td><span class="badge bg-${record.status === 'Present' ? 'success' : record.status === 'Late' ? 'warning' : 'danger'}">${record.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="showAttendanceModal(${s.id}, '${s.name}')">Edit</button></td>
                </tr>
            `;
        }).join('');
    }

    function showAttendanceModal(id, name) {
        document.getElementById('attendanceStudentId').value = id;
        document.getElementById('attendanceStudentName').textContent = name;
        document.getElementById('attendanceModalDate').value = document.getElementById('attendanceDate').value;
        new bootstrap.Modal(document.getElementById('attendanceModal')).show();
    }

    function saveAttendanceMark() {
        const studentId = document.getElementById('attendanceStudentId').value;
        const date = document.getElementById('attendanceModalDate').value;
        const status = document.getElementById('attendanceStatus').value;
        const notes = document.getElementById('attendanceNotes').value;
        if (!attendanceRecords[date]) attendanceRecords[date] = {};
        attendanceRecords[date][studentId] = { status, notes };
        saveData();
        loadAttendance();
        bootstrap.Modal.getInstance(document.getElementById('attendanceModal')).hide();
        addNotification('Attendance marked', 'success');
    }

    function showBulkAttendanceModal() {
        new bootstrap.Modal(document.getElementById('bulkAttendanceModal')).show();
    }

    function bulkMarkAttendance() {
        const date = document.getElementById('bulkAttendanceDate').value;
        const status = document.getElementById('bulkStatus').value;
        const classFilter = document.getElementById('bulkClass').value;
        const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
        if (!attendanceRecords[date]) attendanceRecords[date] = {};
        filteredStudents.forEach(s => {
            attendanceRecords[date][s.id] = { status };
        });
        saveData();
        loadAttendance();
        bootstrap.Modal.getInstance(document.getElementById('bulkAttendanceModal')).hide();
        addNotification('Bulk attendance marked', 'success');
    }

    function syncBiometricAttendance() {
        addNotification('Biometric sync simulated', 'info');
        // Mock sync
        const today = new Date().toISOString().split('T')[0];
        if (!attendanceRecords[today]) attendanceRecords[today] = {};
        students.forEach(s => {
            if (!attendanceRecords[today][s.id]) {
                attendanceRecords[today][s.id] = { status: Math.random() > 0.2 ? 'Present' : 'Absent' };
            }
        });
        saveData();
        loadAttendance();
    }

    // Fee Management (from original, with enhancements)
    function renderFees() {
        const search = document.getElementById('feeSearch').value.toLowerCase();
        const filtered = fees.filter(f => 
            students.find(s => s.id === f.studentId)?.name.toLowerCase().includes(search) || search === ''
        );
        document.getElementById('feeTable').innerHTML = filtered.map(f => {
            const student = students.find(s => s.id === f.studentId);
            return `
                <tr>
                    <td>${student ? student.name : 'Unknown'}</td>
                    <td>R${f.amount.toLocaleString()}</td>
                    <td>${f.dueDate}</td>
                    <td>${f.paidDate || ''}</td>
                    <td><span class="badge bg-${f.status === 'Paid' ? 'success' : f.status === 'Pending' ? 'warning' : 'danger'}">${f.status}</span></td>
                    <td><button class="btn btn-sm btn-success" onclick="generateReceipt(${f.id})">Receipt</button></td>
                    <td><button class="btn btn-sm btn-primary" onclick="editFee(${f.id})">Edit</button></td>
                </tr>
            `;
        }).join('');
        // Metrics
        const totalCollected = fees.filter(f => f.status === 'Paid').reduce((sum, f) => sum + f.amount, 0);
        const outstanding = fees.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
        const overdue = fees.filter(f => f.status === 'Pending' && new Date(f.dueDate) < new Date()).reduce((sum, f) => sum + f.amount, 0);
        const paymentRate = fees.length > 0 ? Math.round((totalCollected / (totalCollected + outstanding)) * 100) : 0;
        document.getElementById('totalCollected').textContent = 'R' + totalCollected.toLocaleString();
        document.getElementById('outstandingFees').textContent = 'R' + outstanding.toLocaleString();
        document.getElementById('overdueFees').textContent = 'R' + overdue.toLocaleString();
        document.getElementById('paymentRate').textContent = paymentRate + '%';
        // History
        document.getElementById('feeHistory').innerHTML = fees.slice(-5).map(f => `
            <div class="report-card">
                <strong>${students.find(s => s.id === f.studentId)?.name}</strong>: R${f.amount} - ${f.status} on ${f.paidDate || f.dueDate}
            </div>
        `).join('');
    }

    function showGenerateInvoiceModal() {
        document.getElementById('invoiceStudent').innerHTML = students.map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('');
        new bootstrap.Modal(document.getElementById('generateInvoiceModal')).show();
    }

    function saveInvoice() {
        const studentId = document.getElementById('invoiceStudent').value;
        const amount = parseFloat(document.getElementById('invoiceAmount').value);
        const dueDate = document.getElementById('invoiceDueDate').value;
        const description = document.getElementById('invoiceDescription').value;
        if (studentId && amount && dueDate) {
            const id = Date.now();
            fees.push({ id, studentId, amount, dueDate, description, status: 'Pending', paidDate: '' });
            saveData();
            renderFees();
            bootstrap.Modal.getInstance(document.getElementById('generateInvoiceModal')).hide();
            addNotification('Invoice generated', 'success');
        }
    }

    function editFee(id) {
        const fee = fees.find(f => f.id === id);
        if (fee) {
            // Similar edit logic as above
            alert('Edit fee ' + id + ' (implement modal)');
        }
    }

    function generateReceipt(id) {
        const fee = fees.find(f => f.id === id);
        if (fee) {
            const student = students.find(s => s.id === fee.studentId);
            const receipt = `
                <div class="payslip-preview">
                    <h4>Receipt #${id}</h4>
                    <p>Student: ${student.name}</p>
                    <p>Amount: R${fee.amount}</p>
                    <p>Date: ${new Date().toLocaleDateString()}</p>
                </div>
            `;
            // Create modal dynamically or use existing
            const modalHtml = `<div class="modal fade" id="receiptModal"><div class="modal-dialog"><div class="modal-content">${receipt}</div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('receiptModal')).show();
            // Clean up after close
            document.getElementById('receiptModal').addEventListener('hidden.bs.modal', () => document.getElementById('receiptModal').remove());
        }
    }

    function searchFees() {
        renderFees();
    }

    function sendFeeReminders() {
        const overdue = fees.filter(f => f.status === 'Pending' && new Date(f.dueDate) < new Date());
        overdue.forEach(f => {
            const student = students.find(s => s.id === f.studentId);
            addNotification(`Reminder sent to ${student.name} for R${f.amount}`, 'warning');
        });
        if (overdue.length > 0) {
            addNotification(overdue.length + ' reminders sent', 'info');
        } else {
            addNotification('No overdue fees', 'info');
        }
    }

    // Timetable (from original)
    function loadTimetable() {
        const grade = document.getElementById('timetableGrade').value;
        if (!grade) return;
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        let table = '<table class="table"><thead><tr><th>Time</th>' + days.map(d => `<th>${d}</th>`).join('') + '</tr></thead><tbody>';
        const times = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00'];
        times.forEach(time => {
            table += `<tr><td>${time}</td>`;
            days.forEach(day => {
                const slot = timetable[grade]?.[day]?.[time] || '';
                table += `<td class="timetable-cell editable" onclick="editTimeSlot('${grade}', '${day}', '${time}')">${slot}</td>`;
            });
            table += '</tr>';
        });
        table += '</tbody></table>';
        document.getElementById('timetableContainer').innerHTML = table;
    }

    function showAddTimeSlotModal() {
        document.getElementById('timeSlotGrade').innerHTML = [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
        new bootstrap.Modal(document.getElementById('addTimeSlotModal')).show();
    }

    function saveTimeSlot() {
        const grade = document.getElementById('timeSlotGrade').value;
        const day = document.getElementById('timeSlotDay').value;
        const time = document.getElementById('timeSlotTime').value;
        const subject = document.getElementById('timeSlotSubject').value;
        if (!timetable[grade]) timetable[grade] = {};
        if (!timetable[grade][day]) timetable[grade][day] = {};
        timetable[grade][day][time] = subject;
        saveData();
        loadTimetable();
        bootstrap.Modal.getInstance(document.getElementById('addTimeSlotModal')).hide();
        addNotification('Time slot added', 'success');
    }

    function editTimeSlot(grade, day, time) {
        document.getElementById('timeSlotGrade').value = grade;
        document.getElementById('timeSlotDay').value = day;
        document.getElementById('timeSlotTime').value = time;
        document.getElementById('timeSlotSubject').value = timetable[grade][day][time] || '';
        // Override to update
        const saveBtn = document.querySelector('#addTimeSlotModal .btn-primary');
        saveBtn.textContent = 'Update';
        saveBtn.onclick = () => {
            timetable[grade][day][time] = document.getElementById('timeSlotSubject').value;
            saveData();
            loadTimetable();
            bootstrap.Modal.getInstance(document.getElementById('addTimeSlotModal')).hide();
            saveBtn.textContent = 'Save';
            saveBtn.onclick = saveTimeSlot;
            addNotification('Time slot updated', 'success');
        };
        new bootstrap.Modal(document.getElementById('addTimeSlotModal')).show();
    }

    function checkTimetableConflicts() {
        // Mock conflict check
        addNotification('No conflicts found (mock)', 'success');
    }

    function highlightTeacherSchedule() {
        const teacher = document.getElementById('timetableTeacher').value;
        if (teacher) {
            // Highlight cells with teacher
            document.querySelectorAll('.timetable-cell').forEach(cell => {
                if (cell.textContent.includes(teacher)) {
                    cell.style.background = 'rgba(255, 255, 0, 0.3)';
                }
            });
        }
    }

    // Teachers Module (lesson plans, grading, etc. - from original)
    function renderLessonPlans() {
        // Mock
        document.getElementById('lessonPlansList').innerHTML = '<div class="lesson-plan"><p>Sample Lesson Plan</p></div>';
    }

    function showAddLessonPlanModal() {
        // Implement
        alert('Add lesson plan modal');
    }

    function renderGrading() {
        // Mock table
        document.getElementById('gradingTable').innerHTML = '<tr><td>Student1</td><td>Math</td><td>85</td><td>Good</td><td>Edit</td></tr>';
    }

    function showAddGradeModal() {
        // Implement
        alert('Add grade modal');
    }

    function loadGrading() {
        // Load based on class
        renderGrading();
    }

    function renderResources() {
        document.getElementById('resourcesList').innerHTML = '<p>Sample Resource</p>';
    }

    function showAddResourceModal() {
        // Implement
        alert('Add resource modal');
    }

    function renderStudentProgress() {
        // Mock chart
        const ctx = document.getElementById('progressChart').getContext('2d');
        new Chart(ctx, { type: 'line', data: { labels: ['Test1', 'Test2'], datasets: [{ data: [80, 90] }] } });
        document.getElementById('progressDetails').innerHTML = '<p>Progress details</p>';
    }

    function loadStudentProgress() {
        renderStudentProgress();
    }

    // Exams (from original)
    function renderExams() {
        const gradeFilter = document.getElementById('examGradeFilter').value;
        const subjectFilter = document.getElementById('examSubjectFilter').value.toLowerCase();
        const filtered = exams.filter(e => 
            (!gradeFilter || e.grade === gradeFilter) && 
            (!subjectFilter || e.subject.toLowerCase().includes(subjectFilter))
        );
        document.getElementById('examTable').innerHTML = filtered.map(e => `
            <tr>
                <td>${e.name}</td>
                <td>${e.date}</td>
                <td>${e.subject}</td>
                <td>${e.grade}</td>
                <td><span class="badge bg-${e.status === 'Completed' ? 'success' : 'warning'}">${e.status}</span></td>
                <td><button class="btn btn-sm btn-primary" onclick="editExam(${e.id})">Edit</button> <button class="btn btn-sm btn-info" onclick="showEnterMarksModal(${e.id})">Marks</button></td>
            </tr>
        `).join('');
    }

    function showAddExamModal() {
        document.getElementById('examGrade').innerHTML = [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
        new bootstrap.Modal(document.getElementById('addExamModal')).show();
    }

    function saveExam() {
        const name = document.getElementById('examName').value;
        const date = document.getElementById('examDate').value;
        const subject = document.getElementById('examSubject').value;
        const grade = document.getElementById('examGrade').value;
        const status = document.getElementById('examStatus').value;
        if (name && date && subject && grade) {
            const id = Date.now();
            exams.push({ id, name, date, subject, grade, status });
            saveData();
            renderExams();
            bootstrap.Modal.getInstance(document.getElementById('addExamModal')).hide();
            addNotification('Exam scheduled', 'success');
        }
    }

    function editExam(id) {
        // Similar edit logic
        alert('Edit exam ' + id + ' (implement)');
    }

    function showEnterMarksModal(examId) {
        document.getElementById('marksExamName').textContent = exams.find(e => e.id === examId)?.name || '';
        const exam = exams.find(e => e.id === examId);
        if (exam) {
            const studentsInGrade = students.filter(s => s.grade === exam.grade);
            document.getElementById('marksTable').innerHTML = studentsInGrade.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td><input type="number" class="form-control" min="0" max="100" data-student="${s.id}"></td>
                </tr>
            `).join('');
            document.getElementById('marksEntry').classList.remove('d-none');
        }
    }

    function saveMarks() {
        const inputs = document.querySelectorAll('#marksTable input');
        inputs.forEach(input => {
            const studentId = input.dataset.student;
            const score = parseFloat(input.value);
            if (score) {
                const id = Date.now();
                grades.push({ id, studentId, subject: document.getElementById('marksExamName').textContent, score, comments: '' });
            }
        });
        saveData();
        document.getElementById('marksEntry').classList.add('d-none');
        renderExams();
        addNotification('Marks saved', 'success');
    }

    function generateAllReportCards() {
        students.forEach(s => {
            const studentGrades = grades.filter(g => g.studentId === s.id);
            const avg = studentGrades.length > 0 ? studentGrades.reduce((sum, g) => sum + g.score, 0) / studentGrades.length : 0;
            addNotification(`Report card for ${s.name}: ${Math.round(avg)}%`, 'info');
        });
    }

    function generateHallTickets() {
        exams.forEach(e => {
            if (e.status === 'Scheduled') {
                students.filter(s => s.grade === e.grade).forEach(s => {
                    addNotification(`Hall ticket for ${s.name} - ${e.name}`, 'info');
                });
            }
        });
    }

    // HR Management (full from original)
    function renderHR() {
        // Default to staff
        renderStaff();
    }

    function renderStaff() {
        const search = document.getElementById('staffSearch').value.toLowerCase();
        const roleFilter = document.getElementById('staffFilterRole').value;
        const filtered = staff.filter(s => 
            s.name.toLowerCase().includes(search) && 
            (!roleFilter || s.role === roleFilter)
        );
        document.getElementById('staffTable').innerHTML = filtered.map(s => {
            const expiryDate = new Date(s.certExpiry);
            const isExpired = expiryDate < new Date();
            return `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.role}</td>
                    <td>${s.department}</td>
                    <td>R${s.salary.toLocaleString()}</td>
                    <td>${s.taxNumber}</td>
                    <td>${s.uifNumber}</td>
                    <td><span class="${isExpired ? 'cert-expired' : 'cert-expiry'}">${s.certExpiry}</span></td>
                    <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'warning'}">${s.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="showAddStaffModal(${s.id})">Edit</button></td>
                </tr>
            `;
        }).join('');
        // Metrics
        document.getElementById('totalStaff').textContent = staff.length;
        document.getElementById('activeStaff').textContent = staff.filter(s => s.status === 'Active').length;
        const avgSalary = staff.length > 0 ? Math.round(staff.reduce((sum, s) => sum + s.salary, 0) / staff.length) : 0;
        document.getElementById('avgSalary').textContent = 'R' + avgSalary.toLocaleString();
        const expiringCerts = staff.filter(s => new Date(s.certExpiry) < new Date(Date.now() + 90*24*60*60*1000)).length;
        document.getElementById('expiringCerts').textContent = expiringCerts;
    }

    let addStaffModal; // Assume modal exists
    function showAddStaffModal(editId) {
        if (editId) {
            editingStaffId = editId;
            const staffMember = staff.find(s => s.id === editId);
            if (staffMember) {
                document.getElementById('staffModalTitle').textContent = 'Edit Staff';
                document.getElementById('staffName').value = staffMember.name;
                document.getElementById('staffRole').value = staffMember.role;
                document.getElementById('staffDepartment').value = staffMember.department;
                document.getElementById('staffSalary').value = staffMember.salary;
                document.getElementById('staffTax').value = staffMember.taxNumber;
                document.getElementById('staffUif').value = staffMember.uifNumber;
                document.getElementById('staffCertExpiry').value = staffMember.certExpiry;
                document.getElementById('staffUsername').value = staffMember.username || '';
                document.getElementById('staffPassword').value = '';
            }
            const saveBtn = document.querySelector('#addStaffModal .btn-primary');
            saveBtn.textContent = 'Update';
            saveBtn.onclick = updateStaff;
        } else {
            document.getElementById('staffModalTitle').textContent = 'Add Staff';
            // Clear form
            const saveBtn = document.querySelector('#addStaffModal .btn-primary');
            saveBtn.textContent = 'Save';
            saveBtn.onclick = saveStaff;
            editingStaffId = null;
        }
        new bootstrap.Modal(document.getElementById('addStaffModal')).show();
    }

    function saveStaff() {
        const name = document.getElementById('staffName').value;
        const role = document.getElementById('staffRole').value;
        const department = document.getElementById('staffDepartment').value;
        const salary = parseFloat(document.getElementById('staffSalary').value);
        const tax = document.getElementById('staffTax').value;
        const uif = document.getElementById('staffUif').value;
        const certExpiry = document.getElementById('staffCertExpiry').value;
        const username = document.getElementById('staffUsername').value;
        const password = document.getElementById('staffPassword').value;
        if (name && role && salary) {
            const id = Date.now();
            const newStaff = { id, name, role, department, salary, taxNumber: tax, uifNumber: uif, certExpiry, status: 'Active' };
            if (username && password) {
                newStaff.username = username;
                users.push({ username, password, name, role });
            }
            staff.push(newStaff);
            saveData();
            renderStaff();
            bootstrap.Modal.getInstance(document.getElementById('addStaffModal')).hide();
            addNotification('Staff added', 'success');
        }
    }

    function updateStaff() {
        if (editingStaffId) {
            const staffMember = staff.find(s => s.id === editingStaffId);
            if (staffMember) {
                staffMember.name = document.getElementById('staffName').value;
                staffMember.role = document.getElementById('staffRole').value;
                staffMember.department = document.getElementById('staffDepartment').value;
                staffMember.salary = parseFloat(document.getElementById('staffSalary').value);
                staffMember.taxNumber = document.getElementById('staffTax').value;
                staffMember.uifNumber = document.getElementById('staffUif').value;
                staffMember.certExpiry = document.getElementById('staffCertExpiry').value;
                const username = document.getElementById('staffUsername').value;
                const password = document.getElementById('staffPassword').value;
                if (password) {
                    const existingUser = users.find(u => u.name === staffMember.name);
                    if (existingUser) {
                        existingUser.password = password;
                    } else if (username) {
                        users.push({ username, password, name: staffMember.name, role: staffMember.role });
                    }
                }
                saveData();
                renderStaff();
                bootstrap.Modal.getInstance(document.getElementById('addStaffModal')).hide();
                addNotification('Staff updated', 'success');
            }
        }
    }

    function syncStaffBiometric() {
        addNotification('Biometric sync for staff simulated', 'info');
    }

    function generateStaffReport() {
        addNotification('Staff report generated (mock PDF)', 'success');
        // Use jsPDF for actual generation
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('Staff Report', 10, 10);
        doc.save('staff-report.pdf');
    }

    // Payroll Tab
    function renderPayrolls() {
        const monthFilter = document.getElementById('payrollMonthFilter').value;
        const filtered = monthFilter ? payrolls.filter(p => p.month === monthFilter) : payrolls;
        document.getElementById('payrollTable').innerHTML = filtered.map(p => {
            const staffMember = staff.find(s => s.id === p.staffId);
            const deductions = p.deductions || 0;
            const tax = p.salary * 0.25; // Mock
            const uif = p.salary * hrSettings.uifRate;
            const net = p.salary - deductions - tax - uif;
            return `
                <tr>
                    <td>${p.id}</td>
                    <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                    <td>${p.month}</td>
                    <td>R${p.salary.toLocaleString()}</td>
                    <td>R${deductions.toLocaleString()}</td>
                    <td>R${tax.toLocaleString()}</td>
                    <td>R${uif.toLocaleString()}</td>
                    <td>R${net.toLocaleString()}</td>
                    <td><button class="btn btn-sm btn-success" onclick="generatePayslip(${p.id})">Payslip</button></td>
                </tr>
            `;
        }).join('');
        // Metrics
        const totalPay = filtered.reduce((sum, p) => sum + p.salary, 0);
        const totalDed = filtered.reduce((sum, p) => sum + (p.deductions || 0), 0);
        const netPay = totalPay - totalDed;
        const compliance = Math.random() * 100; // Mock
        document.getElementById('totalPayroll').textContent = 'R' + totalPay.toLocaleString();
        document.getElementById('totalDeductions').textContent = 'R' + totalDed.toLocaleString();
        document.getElementById('netPayroll').textContent = 'R' + netPay.toLocaleString();
        document.getElementById('complianceScore').textContent = Math.round(compliance) + '%';
    }

    function showAddPayrollModal() {
        document.getElementById('payrollStaff').innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        new bootstrap.Modal(document.getElementById('addPayrollModal')).show();
    }

    function savePayroll() {
        const staffId = document.getElementById('payrollStaff').value;
        const month = document.getElementById('payrollMonth').value;
        const salary = parseFloat(document.getElementById('payrollSalary').value);
        const deductions = parseFloat(document.getElementById('payrollDeductions').value) || 0;
        if (staffId && month && salary) {
            const id = Date.now();
            payrolls.push({ id, staffId, month, salary, deductions });
            saveData();
            renderPayrolls();
            bootstrap.Modal.getInstance(document.getElementById('addPayrollModal')).hide();
            addNotification('Payroll added', 'success');
        }
    }

    function generatePayroll() {
        staff.forEach(s => {
            if (!payrolls.find(p => p.staffId === s.id && p.month === new Date().toISOString().slice(0,7))) {
                const id = Date.now();
                payrolls.push({ id, staffId: s.id, month: new Date().toISOString().slice(0,7), salary: s.salary, deductions: 0 });
            }
        });
        saveData();
        renderPayrolls();
        addNotification('Payroll generated', 'success');
    }

    function exportPayrollToExcel() {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(payrolls.map(p => ({
            ...p,
            staffName: staff.find(s => s.id === p.staffId)?.name || ''
        })));
        XLSX.utils.book_append_sheet(wb, ws, 'Payroll');
        XLSX.writeFile(wb, 'payroll.xlsx');
        addNotification('Payroll exported', 'success');
    }

    function calculateCompliance() {
        addNotification('Compliance checked (mock)', 'info');
    }

    function generatePayslip(id) {
        const payroll = payrolls.find(p => p.id === id);
        if (payroll) {
            const staffMember = staff.find(s => s.id === payroll.staffId);
            const deductions = payroll.deductions || 0;
            const tax = payroll.salary * 0.25;
            const uif = payroll.salary * hrSettings.uifRate;
            const net = payroll.salary - deductions - tax - uif;
            const payslip = `
                <div class="payslip-preview">
                    <h4>Payslip for ${staffMember.name}</h4>
                    <p>Month: ${payroll.month}</p>
                    <p>Gross: R${payroll.salary.toLocaleString()}</p>
                    <p>Deductions: R${deductions.toLocaleString()}</p>
                    <p>Tax: R${tax.toLocaleString()}</p>
                    <p>UIF: R${uif.toLocaleString()}</p>
                    <p><strong>Net: R${net.toLocaleString()}</strong></p>
                </div>
            `;
            // Similar modal as receipt
            const modalHtml = `<div class="modal fade" id="payslipModal"><div class="modal-dialog"><div class="modal-content">${payslip}</div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('payslipModal')).show();
            document.getElementById('payslipModal').addEventListener('hidden.bs.modal', () => document.getElementById('payslipModal').remove());
            addNotification('Payslip generated', 'success');
        }
    }

    // Leaves Tab
    function renderLeaves() {
        const dateFilter = document.getElementById('leaveDateFilter').value;
        const filtered = dateFilter ? leaveRequests.filter(l => l.date === dateFilter) : leaveRequests;
        document.getElementById('leavesTable').innerHTML = filtered.map(l => {
            const staffMember = staff.find(s => s.id === l.staffId);
            return `
                <tr>
                    <td>${l.id}</td>
                    <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                    <td>${l.type}</td>
                    <td>${l.date}</td>
                    <td>${l.days}</td>
                    <td><span class="badge bg-${l.status === 'Approved' ? 'success' : l.status === 'Rejected' ? 'danger' : 'warning'}">${l.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="toggleLeaveStatus(${l.id})">Toggle</button></td>
                </tr>
            `;
        }).join('');
        // Metrics
        document.getElementById('totalLeaves').textContent = leaveRequests.length;
        document.getElementById('pendingLeaves').textContent = leaveRequests.filter(l => l.status === 'Pending').length;
        document.getElementById('approvedLeaves').textContent = leaveRequests.filter(l => l.status === 'Approved').length;
        document.getElementById('rejectedLeaves').textContent = leaveRequests.filter(l => l.status === 'Rejected').length;
        // Chart
        const ctx = document.getElementById('leaveChart').getContext('2d');
        if (leaveChart) leaveChart.destroy();
        leaveChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Pending', 'Approved', 'Rejected'],
                datasets: [{
                    data: [leaveRequests.filter(l => l.status === 'Pending').length, leaveRequests.filter(l => l.status === 'Approved').length, leaveRequests.filter(l => l.status === 'Rejected').length],
                    backgroundColor: ['#FFCE56', '#36A2EB', '#FF6384']
                }]
            },
            options: { responsive: true }
        });
    }

    function showAddLeaveModal() {
        document.getElementById('leaveStaff').innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        new bootstrap.Modal(document.getElementById('addLeaveModal')).show();
    }

    function saveLeave() {
        const staffId = document.getElementById('leaveStaff').value;
        const type = document.getElementById('leaveType').value;
        const date = document.getElementById('leaveDate').value;
        const days = parseInt(document.getElementById('leaveDays').value);
        if (staffId && date && days) {
            const id = Date.now();
            leaveRequests.push({ id, staffId, type, date, days, status: 'Pending' });
            saveData();
            renderLeaves();
            bootstrap.Modal.getInstance(document.getElementById('addLeaveModal')).hide();
            addNotification('Leave request added', 'success');
        }
    }

    function toggleLeaveStatus(id) {
        const leave = leaveRequests.find(l => l.id === id);
        if (leave) {
            leave.status = leave.status === 'Pending' ? 'Approved' : leave.status === 'Approved' ? 'Rejected' : 'Pending';
            saveData();
            renderLeaves();
            addNotification('Leave status updated', 'info');
        }
    }

    function generateLeaveReport() {
        addNotification('Leave report generated (mock)', 'success');
    }

    // Performance Tab
    function renderReviews() {
        const dateFilter = document.getElementById('reviewDateFilter').value;
        const filtered = dateFilter ? performanceReviews.filter(r => r.date === dateFilter) : performanceReviews;
        document.getElementById('reviewsTable').innerHTML = filtered.map(r => {
            const staffMember = staff.find(s => s.id === r.staffId);
            return `
                <tr>
                    <td>${r.id}</td>
                    <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                    <td>${r.date}</td>
                    <td>${r.score}</td>
                    <td>${r.comments}</td>
                    <td><button class="btn btn-sm btn-warning" onclick="editReview(${r.id})">Edit</button></td>
                </tr>
            `;
        }).join('');
        // Metrics
        const avgScore = performanceReviews.length > 0 ? Math.round(performanceReviews.reduce((sum, r) => sum + r.score, 0) / performanceReviews.length) : 0;
        document.getElementById('avgScore').textContent = avgScore;
        document.getElementById('totalReviews').textContent = performanceReviews.length;
        document.getElementById('goalsAchieved').textContent = performanceReviews.filter(r => r.score > 80).length;
        document.getElementById('pendingFeedback').textContent = 0; // Mock
        // Chart
        const ctx = document.getElementById('performanceChart').getContext('2d');
        if (performanceChart) performanceChart.destroy();
        performanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Scores'],
                datasets: [{
                    label: 'Average',
                    data: [avgScore],
                    backgroundColor: '#4BC0C0'
                }]
            },
            options: { responsive: true }
        });
    }

    function showAddReviewModal() {
        document.getElementById('reviewStaff').innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        new bootstrap.Modal(document.getElementById('addReviewModal')).show();
    }

    function saveReview() {
        const staffId = document.getElementById('reviewStaff').value;
        const date = document.getElementById('reviewDate').value;
        const score = parseFloat(document.getElementById('reviewScore').value);
        const comments = document.getElementById('reviewComments').value;
        if (staffId && date && score) {
            const id = Date.now();
            performanceReviews.push({ id, staffId, date, score, comments });
            saveData();
            renderReviews();
            bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
            addNotification('Review added', 'success');
        }
    }

    function editReview(id) {
        editingReviewId = id;
        const review = performanceReviews.find(r => r.id === id);
        if (review) {
            document.getElementById('reviewStaff').value = review.staffId;
            document.getElementById('reviewDate').value = review.date;
            document.getElementById('reviewScore').value = review.score;
            document.getElementById('reviewComments').value = review.comments;
            // Override save
            const saveBtn = document.querySelector('#addReviewModal .btn-primary');
            saveBtn.textContent = 'Update';
            saveBtn.onclick = updateReview;
            new bootstrap.Modal(document.getElementById('addReviewModal')).show();
        }
    }

    function updateReview() {
        const review = performanceReviews.find(r => r.id === editingReviewId);
        if (review) {
            review.staffId = document.getElementById('reviewStaff').value;
            review.date = document.getElementById('reviewDate').value;
            review.score = parseFloat(document.getElementById('reviewScore').value);
            review.comments = document.getElementById('reviewComments').value;
            saveData();
            renderReviews();
            bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
            const saveBtn = document.querySelector('#addReviewModal .btn-primary');
            saveBtn.textContent = 'Save';
            saveBtn.onclick = saveReview;
            addNotification('Review updated', 'success');
        }
    }

    function generatePerformanceReport() {
        addNotification('Performance report generated (mock)', 'success');
    }

    // Recruitment Tab
    function renderJobs() {
        const search = document.getElementById('jobSearch').value.toLowerCase();
        const filtered = jobs.filter(j => j.title.toLowerCase().includes(search));
        document.getElementById('jobTable').innerHTML = filtered.map(j => `
            <tr>
                <td>${j.id}</td>
                <td>${j.title}</td>
                <td>${j.department}</td>
                <td>${j.applications || 0}</td>
                <td><span class="badge bg-${j.status === 'Open' ? 'success' : 'danger'}">${j.status}</span></td>
                <td><button class="btn btn-sm btn-primary" onclick="editJob(${j.id})">Edit</button> <button class="btn btn-sm btn-info" onclick="showScheduleInterviewModal(${j.id})">Schedule</button></td>
            </tr>
        `).join('');
        // Metrics
        document.getElementById('openPositions').textContent = jobs.filter(j => j.status === 'Open').length;
        document.getElementById('totalApplications').textContent = jobs.reduce((sum, j) => sum + (j.applications || 0), 0);
        document.getElementById('interviewsScheduled').textContent = 0; // Mock
        document.getElementById('hireRate').textContent = '0%'; // Mock
    }

    function showAddJobModal(editId) {
        editingJob = editId || null;
        if (editId) {
            const job = jobs.find(j => j.id === editId);
            if (job) {
                document.getElementById('jobModalTitle').textContent = 'Edit Job';
                document.getElementById('jobTitle').value = job.title;
                document.getElementById('jobDepartment').value = job.department;
                document.getElementById('jobDescription').value = job.description;
                document.getElementById('jobStatus').value = job.status;
                const saveBtn = document.querySelector('#addJobModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = updateJob;
            }
        } else {
            document.getElementById('jobModalTitle').textContent = 'Add Job';
            // Clear
            const saveBtn = document.querySelector('#addJobModal .btn-primary');
            saveBtn.textContent = 'Save';
            saveBtn.onclick = saveJob;
        }
        new bootstrap.Modal(document.getElementById('addJobModal')).show();
    }

    function saveJob() {
        const title = document.getElementById('jobTitle').value;
        const department = document.getElementById('jobDepartment').value;
        const description = document.getElementById('jobDescription').value;
        const status = document.getElementById('jobStatus').value;
        if (title && department) {
            const id = Date.now();
            jobs.push({ id, title, department, description, status, applications: 0 });
            saveData();
            renderJobs();
            bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
            addNotification('Job added', 'success');
        }
    }

    function updateJob() {
        if (editingJob) {
            const job = jobs.find(j => j.id === editingJob);
            if (job) {
                job.title = document.getElementById('jobTitle').value;
                job.department = document.getElementById('jobDepartment').value;
                job.description = document.getElementById('jobDescription').value;
                job.status = document.getElementById('jobStatus').value;
                saveData();
                renderJobs();
                bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
                addNotification('Job updated', 'success');
            }
        }
    }

    function showApplyJobModal() {
        document.getElementById('applyJobSelect').innerHTML = jobs.map(j => `<option value="${j.id}">${j.title}</option>`).join('');
        new bootstrap.Modal(document.getElementById('applyJobModal')).show();
    }

    function submitApplication() {
        const jobId = document.getElementById('applyJobSelect').value;
        const name = document.getElementById('applicantName').value;
        const email = document.getElementById('applicantEmail').value;
        const phone = document.getElementById('applicantPhone').value;
        const coverLetter = document.getElementById('applicantCoverLetter').value;
        const job = jobs.find(j => j.id === jobId);
        if (job && name && email) {
            job.applications = (job.applications || 0) + 1;
            // Mock applicant
            addNotification(`Application from ${name} for ${job.title}`, 'info');
            saveData();
            renderJobs();
            bootstrap.Modal.getInstance(document.getElementById('applyJobModal')).hide();
        }
    }

    function showScheduleInterviewModal(jobId) {
        // Mock applicant for job
        document.getElementById('interviewApplicant').value = 'Mock Applicant';
        new bootstrap.Modal(document.getElementById('scheduleInterviewModal')).show();
    }

    function saveInterview() {
        const dateTime = document.getElementById('interviewDateTime').value;
        const type = document.getElementById('interviewType').value;
        const notes = document.getElementById('interviewNotes').value;
        if (dateTime) {
            addNotification(`Interview scheduled for ${dateTime}`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('scheduleInterviewModal')).hide();
        }
    }

    function generateRecruitmentReport() {
        addNotification('Recruitment report generated (mock)', 'success');
    }

    // Audit Tab
    function renderAudit() {
        const dateFilter = document.getElementById('auditDateFilter').value;
        const actionFilter = document.getElementById('auditActionFilter').value;
        const filtered = auditLog.filter(a => 
            (!dateFilter || a.timestamp.startsWith(dateFilter)) &&
            (!actionFilter || a.action === actionFilter)
        );
        document.getElementById('auditTable').innerHTML = filtered.map(a => `
            <tr>
                <td>${a.timestamp}</td>
                <td>${a.user}</td>
                <td>${a.action}</td>
                <td>${a.details}</td>
                <td><span class="badge bg-${a.risk === 'High' ? 'danger' : 'warning'}">${a.risk}</span></td>
            </tr>
        `).join('');
        // Metrics
        document.getElementById('totalAudit').textContent = auditLog.length;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('todayAudit').textContent = auditLog.filter(a => a.timestamp.startsWith(today)).length;
        document.getElementById('highRiskAudit').textContent = auditLog.filter(a => a.risk === 'High').length;
        document.getElementById('complianceIssues').textContent = 0; // Mock
    }

    function generateAuditReport() {
        addNotification('Audit report generated (mock)', 'success');
    }

    function exportAuditToExcel() {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(auditLog);
        XLSX.utils.book_append_sheet(wb, ws, 'Audit');
        XLSX.writeFile(wb, 'audit.xlsx');
        addNotification('Audit exported', 'success');
    }

    // Communication
    function renderMessages() {
        document.getElementById('messagesContainer').innerHTML = messages.map(m => `
            <div class="chat-message ${m.sender === currentUser.name ? 'chat-user' : 'chat-assistant'}">
                <strong>${m.sender}:</strong> ${m.text} <small>${m.timestamp}</small>
            </div>
        `).join('');
    }

    function showSendMessageModal() {
        // Assume modal with recipient, text, viaSMS checkbox
        new bootstrap.Modal(document.getElementById('sendMessageModal')).show();
    }

    function sendMessage() {
        const recipient = document.getElementById('messageRecipient').value;
        const text = document.getElementById('messageText').value;
        const viaSMS = document.getElementById('sendViaSMS').checked;
        if (text) {
            const id = Date.now();
            messages.push({ id, sender: currentUser.name, recipient, text, timestamp: new Date().toLocaleString(), viaSMS });
            if (viaSMS) {
                // Mock SMS
                addNotification('SMS sent via WinSMS', 'info');
            }
            saveData();
            renderMessages();
            bootstrap.Modal.getInstance(document.getElementById('sendMessageModal')).hide();
            addNotification('Message sent', 'success');
        }
    }

    function viewAnnouncements() {
        announcements.forEach(a => {
            addNotification(a.title + ': ' + a.content, 'info');
        });
    }

    function startChat() {
        addNotification('Live chat started (mock)', 'info');
        // Simulate chat
        setInterval(() => {
            messages.push({ id: Date.now(), sender: 'Assistant', text: 'Hello! How can I help?', timestamp: new Date().toLocaleString() });
            renderMessages();
        }, 10000);
    }

    // Content Management
    function renderContents() {
        const search = document.getElementById('contentSearch').value.toLowerCase();
        const filtered = contents.filter(c => c.title.toLowerCase().includes(search));
        document.getElementById('contentTable').innerHTML = filtered.map(c => `
            <tr>
                <td>${c.id}</td>
                <td>${c.title}</td>
                <td>${c.type}</td>
                <td><span class="badge bg-${c.status === 'Published' ? 'success' : 'warning'}">${c.status}</span></td>
                <td><button class="btn btn-sm btn-primary" onclick="editContent(${c.id})">Edit</button></td>
            </tr>
        `).join('');
    }

    function showAddContentModal() {
        new bootstrap.Modal(document.getElementById('addContentModal')).show();
    }

    function saveContent() {
        const title = document.getElementById('contentTitle').value;
        const type = document.getElementById('contentType').value;
        const body = document.getElementById('contentBody').value;
        const status = document.getElementById('contentStatus').value;
        const file = document.getElementById('contentFile').files[0];
        if (title && body) {
            const id = Date.now();
            contents.push({ id, title, type, body, status, file: file ? file.name : '' });
            saveData();
            renderContents();
            bootstrap.Modal.getInstance(document.getElementById('addContentModal')).hide();
            addNotification('Content added', 'success');
        }
    }

    function editContent(id) {
        // Similar edit logic
        alert('Edit content ' + id + ' (implement)');
    }

    function searchContent() {
        renderContents();
    }

    // Reports
    function generateReport() {
        const type = document.getElementById('reportType').value;
        let report = '';
        switch (type) {
            case 'attendance':
                report = 'Attendance Report: ' + Object.keys(attendanceRecords).length + ' days';
                break;
            case 'fees':
                report = 'Fee Report: R' + fees.reduce((sum, f) => sum + f.amount, 0).toLocaleString();
                break;
            case 'exams':
                report = 'Exam Report: ' + exams.length + ' exams';
                break;
            case 'hr':
                report = 'HR Report: ' + staff.length + ' staff';
                break;
        }
        document.getElementById('reportOutput').innerHTML = `<div class="report-card">${report}</div>`;
        document.getElementById('reportOutput').classList.remove('d-none');
    }

    function exportReport() {
        addNotification('Report exported (mock)', 'success');
    }

    // Settings
    function loadSettings() {
        document.getElementById('smsUsername').value = smsSettings.username;
        document.getElementById('smsPassword').value = smsSettings.password;
        document.getElementById('annualLeaveDays').value = hrSettings.annualLeaveDays;
        document.getElementById('uifRate').value = hrSettings.uifRate * 100;
    }

    function saveSMSSettings() {
        smsSettings.username = document.getElementById('smsUsername').value;
        smsSettings.password = document.getElementById('smsPassword').value;
        saveData();
        addNotification('SMS settings saved', 'success');
    }

    function updateHRSettings() {
        hrSettings.annualLeaveDays = parseInt(document.getElementById('annualLeaveDays').value);
        hrSettings.uifRate = parseFloat(document.getElementById('uifRate').value) / 100;
        saveData();
        addNotification('HR settings updated', 'success');
    }

    function backupData() {
        const data = {
            students, admissions, fees, timetable, exams, staff, payrolls, leaveRequests,
            performanceReviews, jobs, auditLog, messages, contents, announcements, grades,
            attendanceRecords, users, hrSettings, smsSettings
        };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'asms-backup.json';
        a.click();
        addNotification('Data backed up', 'success');
    }

    function restoreData() {
        if (confirm('Restore will overwrite data?')) {
            // Implement file upload and restore
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = ev => {
                    const data = JSON.parse(ev.target.result);
                    Object.assign(window, data);
                    saveData();
                    loadData();
                    addNotification('Data restored', 'success');
                };
                reader.readAsText(file);
            };
            input.click();
        }
    }

    // Parent Portal
    function loadParentPortal() {
        // Mock child
        const child = students.find(s => s.parent === currentUser.name) || students[0];
        document.getElementById('parentChildInfo').innerHTML = `<h4>Child: ${child ? child.name : 'No child'}</h4>`;
        // Attendance
        const recentAttendance = Object.entries(attendanceRecords).slice(-5).map(([date, records]) => {
            const status = records[child.id]?.status || 'Absent';
            return `<p>${date}: ${status}</p>`;
        }).join('');
        document.getElementById('parentAttendance').innerHTML = recentAttendance;
        // Fees
        const parentFees = fees.filter(f => students.find(s => s.id === f.studentId)?.parent === currentUser.name);
        document.getElementById('parentFees').innerHTML = parentFees.map(f => `
            <p>${f.description}: R${f.amount} - ${f.status}</p>
        `).join('');
        // Grades
        const parentGrades = grades.filter(g => students.find(s => s.id === g.studentId)?.parent === currentUser.name);
        document.getElementById('parentGrades').innerHTML = parentGrades.map(g => `
            <p>${g.subject}: ${g.score}%</p>
        `).join('');
        // Announcements
        document.getElementById('parentAnnouncements').innerHTML = announcements.map(a => `<p><strong>${a.title}</strong>: ${a.content}</p>`).join('');
    }

    // AI Research
    function researchWithAI() {
        const query = document.getElementById('researchQuery').value;
        if (query) {
            document.getElementById('researchResults').innerHTML = `
                <div class="alert alert-info">
                    <h5>Research on "${query}"</h5>
                    <p>Mock AI response: This is a simulated research result based on your query. In a real system, this would integrate with an AI API like Grok.</p>
                    <ul>
                        <li>Key fact 1</li>
                        <li>Key fact 2</li>
                        <li>Source: Educational Database</li>
                    </ul>
                </div>
            `;
            addNotification('Research completed', 'success');
        }
    }

    // Utility: Log audit
    function logAudit(action, details, risk = 'Low') {
        auditLog.unshift({
            id: Date.now(),
            user: currentUser.name,
            action,
            details,
            risk,
            timestamp: new Date().toISOString()
        });
        saveData();
    }

    // Search debounces (from original)
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('admissionSearch').addEventListener('input', debounce(renderAdmissions, 300));
        document.getElementById('studentSearch').addEventListener('input', debounce(renderStudents, 300));
        document.getElementById('feeSearch').addEventListener('input', debounce(renderFees, 300));
        document.getElementById('contentSearch').addEventListener('input', debounce(renderContents, 300));
        document.getElementById('staffSearch').addEventListener('input', debounce(renderStaff, 300));
        document.getElementById('jobSearch').addEventListener('input', debounce(renderJobs, 300));
        document.getElementById('payrollMonthFilter').value = new Date().toISOString().slice(0,7);
        document.getElementById('bulkAttendanceDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
    });

    // Initialize
    window.onload = function() {
        loadData();
        populateSelects();
        updateDashboardMetrics();
        // Mock dashboard chart
        const ctx = document.getElementById('dashboardChart').getContext('2d');
        dashboardChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar'],
                datasets: [{ label: 'Attendance', data: [65, 59, 80] }]
            },
            options: { responsive: true }
        });
        // Mock announcements
        announcements = [{ title: 'Welcome', content: 'School starts soon!' }];
    };
</script>
</body>
</html>
