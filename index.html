<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Powerful Attendance with SMS Alerts - Johannesburg School SIS</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{--primary:#28a745;--sidebar-bg:#0d6efd;--light-bg:#f8f9fa}
body{background:var(--light-bg);font-family:Segoe UI,sans-serif;min-height:100vh}
.sidebar{background:var(--sidebar-bg);color:#fff;position:fixed;width:240px;height:100vh;overflow-y:auto;transition:width .3s}
.sidebar .brand{background:var(--primary);padding:1.5rem;text-align:center;font-weight:bold}
.sidebar a{color:#fff;padding:.9rem 1.2rem;display:flex;align-items:center;text-decoration:none;cursor:pointer}
.sidebar a:hover,.sidebar a.active{background:rgba(255,255,255,.1)}
.sidebar i{width:24px;margin-right:12px}
.main-content{margin-left:240px;padding:1.5rem}
.topbar{background:#fff;padding:1rem 1.5rem;box-shadow:0 2px 4px rgba(0,0,0,.08);border-radius:8px;margin-bottom:1.5rem}
.section{display:none}
.section.active{display:block}
@media (max-width:992px){.sidebar{width:70px}.sidebar .brand,.sidebar span{display:none}.main-content{margin-left:70px}}
@media print{.sidebar,.topbar,.no-print{display:none!important}.main-content{margin-left:0;padding:0}body{background:#fff}.print-title{text-align:center;margin-bottom:2rem}}
.status-present{background:#d4edda;color:#155724}
.status-absent{background:#f8d7da;color:#721c24}
.status-late{background:#fff3cd;color:#856404}
.status-excused{background:#e2e3e5;color:#41464b}
</style>
</head>
<body>

<div class="sidebar">
  <div class="brand text-white">School SIS</div>
  <a data-section="dashboard" class="active"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
  <a data-section="students"><i class="fas fa-users"></i><span>Students</span></a>
  <a data-section="classes"><i class="fas fa-book"></i><span>Classes</span></a>
  <a data-section="attendance"><i class="fas fa-calendar-check"></i><span>Attendance</span></a>
  <a data-section="grades"><i class="fas fa-graduation-cap"></i><span>Grades</span></a>
  <a data-section="finance"><i class="fas fa-money-bill-wave"></i><span>Finance</span></a>
</div>

<div class="main-content">
  <div class="topbar d-flex justify-content-between align-items-center">
    <h4 id="page-title">Attendance with SMS Alerts</h4>
    <div><span class="me-3">Goodness • Johannesburg</span><button class="btn btn-primary btn-sm"><i class="fas fa-bell"></i></button></div>
  </div>

  <!-- Dashboard (updated with alerts stat) -->
  <div id="dashboard" class="section active">
    <div class="row g-4">
      <div class="col-lg-3"><div class="card p-3 text-center"><h6>Students</h6><h3 id="total-students">0</h3></div></div>
      <div class="col-lg-3"><div class="card p-3 text-center"><h6>Classes</h6><h3 id="total-classes">0</h3></div></div>
      <div class="col-lg-3"><div class="card p-3 text-center"><h6>Avg Attendance</h6><h3 id="avg-attendance">0%</h3></div></div>
      <div class="col-lg-3"><div class="card p-3 text-center"><h6>SMS Alerts Today</h6><h3 id="sms-today">0</h3></div></div>
    </div>
  </div>

  <!-- Powerful Attendance with SMS Alerts -->
  <div id="attendance" class="section">
    <h4>Powerful Daily Attendance with SMS Alerts</h4>
    <div class="row mb-3 align-items-end">
      <div class="col-md-4"><label>Class</label><select class="form-select" id="att-class" onchange="loadDate()"></select></div>
      <div class="col-md-3"><label>Date</label><input type="date" class="form-control" id="att-date" onchange="loadAttendance()"></div>
      <div class="col-md-5 text-end">
        <button class="btn btn-outline-primary me-2 no-print" onclick="setAll('P')">All Present</button>
        <button class="btn btn-success me-2 no-print" onclick="saveAttendance(true)">Save & Send Alerts</button>
        <button class="btn btn-warning me-2 no-print" onclick="sendAbsenceAlerts()">Send Absence Alerts Only</button>
        <button class="btn btn-info no-print" onclick="printRegister()">Print Register</button>
      </div>
    </div>

    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr><th>#</th><th>Student</th><th>Parent Phone</th><th>Status</th><th>Note</th><th class="no-print">Alert</th></tr></thead>
          <tbody id="att-body"></tbody>
        </table>
      </div>
      <div class="mt-3 fw-bold">Class Attendance: <span id="class-rate">0%</span> (<span id="present-count">0</span>/<span id="total-count">0</span>) • Absences: <span id="absence-count">0</span></div>
    </div></div>

    <div class="mt-4 card no-print"><div class="card-body">
      <h5>Term Attendance Trend</h5>
      <canvas id="att-chart" height="150"></canvas>
    </div></div>

    <div class="mt-4 card no-print"><div class="card-body">
      <h5>SMS Alert Log (Today)</h5>
      <ul class="list-group" id="sms-log"></ul>
    </div></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const data={students:JSON.parse(localStorage.getItem('students'))||[],classes:JSON.parse(localStorage.getItem('classes'))||[],attendance:JSON.parse(localStorage.getItem('attendance'))||{},smsLog:JSON.parse(localStorage.getItem('smsLog'))||{}};
let attChart=null;

// Mock parent phones (add real in student management later)
data.students.forEach(s=>{if(!s.parentPhone)s.parentPhone='0821234567';}); // SA example numbers

function nav(id){document.querySelectorAll('.section').forEach(s=>s.classList.toggle('active',s.id===id));
document.querySelectorAll('.sidebar a').forEach(a=>a.classList.toggle('active',a.dataset.section===id));
document.getElementById('page-title').textContent=id==='attendance'?'Attendance with SMS':id.charAt(0).toUpperCase()+id.slice(1);
if(id==='attendance')initAtt();if(id==='dashboard')updateDash();}

document.querySelectorAll('.sidebar a').forEach(a=>a.onclick=()=>nav(a.dataset.section));

function initAtt(){const sel=document.getElementById('att-class');sel.innerHTML='<option value="">Select Class</option>';
data.classes.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.text=`${c.name} (Grade ${c.grade})`;sel.appendChild(o);});
document.getElementById('att-date').value=new Date().toISOString().split('T')[0];renderSmsLog();}

function loadDate(){loadAttendance();}

function loadAttendance(){const cid=document.getElementById('att-class').value;if(!cid)return;
const date=document.getElementById('att-date').value||new Date().toISOString().split('T')[0];
const cls=data.classes.find(c=>c.id==cid);
if(!cls||!cls.studentIds){document.getElementById('att-body').innerHTML='<tr><td colspan="6">No students in this class</td></tr>';return;}
if(!data.attendance[cid])data.attendance[cid]={};
if(!data.attendance[cid][date])data.attendance[cid][date]={};
const rec=data.attendance[cid][date];

let body='';let present=0;let absences=0;let total=cls.studentIds.length;
cls.studentIds.forEach((sid,i)=>{const stu=data.students.find(s=>s.id==sid);
if(!stu)return;
const status=rec[sid]?.status||'P';const note=rec[sid]?.note||'';
if(status==='P')present++; else if(status==='A')absences++;
body+=`<tr class="status-${status.toLowerCase()}">
  <td>${i+1}</td><td>${stu.name}</td><td>${stu.parentPhone||'N/A'}</td>
  <td><select class="form-select" data-sid="${sid}" onchange="updateRow(this)">
    <option value="P" ${status==='P'?'selected':''}>Present</option>
    <option value="A" ${status==='A'?'selected':''}>Absent</option>
    <option value="L" ${status==='L'?'selected':''}>Late</option>
    <option value="E" ${status==='E'?'selected':''}>Excused</option>
  </select></td>
  <td><input type="text" class="form-control" data-sid="${sid}" value="${note}" placeholder="Reason"></td>
  <td>${status==='A'?'<i class="fas fa-bell text-danger"></i>':''}</td>
</tr>`;});
document.getElementById('att-body').innerHTML=body;
document.getElementById('class-rate').textContent=Math.round((present/total)*100)+'%';
document.getElementById('present-count').textContent=present;
document.getElementById('total-count').textContent=total;
document.getElementById('absence-count').textContent=absences;
updateTermChart(cid);}

function updateRow(sel){const row=sel.closest('tr');row.className='status-'+sel.value.toLowerCase();
row.querySelector('td:last-child').innerHTML=sel.value==='A'?'<i class="fas fa-bell text-danger"></i>':'';calcClassRate();}

function calcClassRate(){const rows=document.querySelectorAll('#att-body tr');
let presents=0;let absences=0;
rows.forEach(r=>{const sel=r.querySelector('select');if(sel){if(sel.value==='P')presents++;if(sel.value==='A')absences++;}});
const total=rows.length;
document.getElementById('class-rate').textContent=total>0?Math.round((presents/total)*100)+'%':'0%';
document.getElementById('present-count').textContent=presents;
document.getElementById('total-count').textContent=total;
document.getElementById('absence-count').textContent=absences;}

function setAll(status){document.querySelectorAll('#att-body select').forEach(s=>s.value=status);
document.querySelectorAll('#att-body tr').forEach(r=>{r.className='status-'+status.toLowerCase();
r.querySelector('td:last-child').innerHTML=status==='A'?'<i class="fas fa-bell text-danger"></i>':'';});calcClassRate();}

function saveAttendance(sendAlerts=false){const cid=document.getElementById('att-class').value;const date=document.getElementById('att-date').value;
if(!cid||!date)return alert('Select class & date');
data.attendance[cid]=data.attendance[cid]||{};data.attendance[cid][date]={};
document.querySelectorAll('#att-body select,#att-body input[type=text]').forEach(el=>{const sid=el.dataset.sid;
if(!sid)return;
data.attendance[cid][date][sid]=data.attendance[cid][date][sid]||{};
if(el.tagName==='SELECT')data.attendance[cid][date][sid].status=el.value;
else data.attendance[cid][date][sid].note=el.value;});
localStorage.setItem('attendance',JSON.stringify(data.attendance));
if(sendAlerts)sendAbsenceAlerts();
else alert('Attendance saved!');
updateDash();}

function sendAbsenceAlerts(){const cid=document.getElementById('att-class').value;const date=document.getElementById('att-date').value;
if(!cid||!date)return alert('Select class & date');
const cls=data.classes.find(c=>c.id==cid);
const rec=data.attendance[cid]?.[date]||{};
let alertsSent=0;const todayKey=date;
data.smsLog[todayKey]=data.smsLog[todayKey]||[];
cls.studentIds.forEach(sid=>{const stu=data.students.find(s=>s.id==sid);
if(!stu)return;
const status=rec[sid]?.status||'P';
if(status==='A' && stu.parentPhone){ // Only absent
  const msg=`Dear Parent of ${stu.name}, your child is marked absent today (${new Date(date).toLocaleDateString('en-ZA')}). Reason: ${rec[sid]?.note||'Not provided'}. - Johannesburg School`;
  // Mock send (in real app: fetch to SMS gateway like BulkSMS/Clickatell)
  console.log('SMS to '+stu.parentPhone+': '+msg);
  data.smsLog[todayKey].push({student:stu.name,phone:stu.parentPhone,message:msg,time:new Date().toLocaleTimeString()});
  alertsSent++;
}});
localStorage.setItem('smsLog',JSON.stringify(data.smsLog));
renderSmsLog();
alert(`SMS absence alerts sent to ${alertsSent} parents! (Mock - check console/log)`);
updateDash();}

function renderSmsLog(){const today=document.getElementById('att-date').value||new Date().toISOString().split('T')[0];
const log=document.getElementById('sms-log');log.innerHTML='';
(data.smsLog[today]||[]).forEach(entry=>{log.innerHTML+=`<li class="list-group-item"><strong>${entry.student}</strong> (${entry.phone}) at ${entry.time}<br><small>${entry.message}</small></li>`;});}

function printRegister(){window.print();}

function updateTermChart(cid){
// Stub - could implement actual chart with historical data
if(attChart){attChart.destroy();}
const ctx=document.getElementById('att-chart');
if(ctx){
const chartCtx=ctx.getContext('2d');
attChart=new Chart(chartCtx,{
type:'line',
data:{
labels:['Week 1','Week 2','Week 3','Week 4'],
datasets:[{
label:'Attendance %',
data:[95,92,94,96],
borderColor:'#28a745',
backgroundColor:'rgba(40,167,69,0.1)'
}]
},
options:{scales:{y:{beginAtZero:true,max:100}}}
});
}
}

function updateDash(){
let smsToday=0;const today=new Date().toISOString().split('T')[0];
if(data.smsLog[today])smsToday=data.smsLog[today].length;
document.getElementById('sms-today').textContent=smsToday;
document.getElementById('total-students').textContent=data.students.length;
document.getElementById('total-classes').textContent=data.classes.length;
// Calculate avg attendance - simple stub
document.getElementById('avg-attendance').textContent='95%';
}

initAtt();updateDash();
</script>
</body>
</html>
