<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firestore Queries Example - BIS-SMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <h1>Firestore Queries Example</h1>
    <p class="text-muted">This page demonstrates how to use the Firestore queries in BIS-SMS</p>
    
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Dashboard Statistics</h5>
          </div>
          <div class="card-body">
            <button class="btn btn-primary" onclick="loadDashboard()">Load Dashboard Stats</button>
            <div id="dashboard-results" class="mt-3"></div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Students</h5>
          </div>
          <div class="card-body">
            <button class="btn btn-primary" onclick="loadStudents()">Load All Students</button>
            <button class="btn btn-secondary" onclick="searchStudent()">Search Student</button>
            <div id="students-results" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Teachers</h5>
          </div>
          <div class="card-body">
            <button class="btn btn-primary" onclick="loadTeachers()">Load All Teachers</button>
            <div id="teachers-results" class="mt-3"></div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Classes</h5>
          </div>
          <div class="card-body">
            <button class="btn btn-primary" onclick="loadClasses()">Load All Classes</button>
            <div id="classes-results" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5>Financial Report</h5>
          </div>
          <div class="card-body">
            <button class="btn btn-primary" onclick="generateReport()">Generate Financial Report</button>
            <div id="report-results" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, where, getDocs, Timestamp, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBsUOSF5eENLCq_4fH9lLx_WIVUa6QDeBE",
      authDomain: "bis-management-system-d77f4.firebaseapp.com",
      projectId: "bis-management-system-d77f4",
      storageBucket: "bis-management-system-d77f4.firebasestorage.app",
      messagingSenderId: "724917351295",
      appId: "1:724917351295:web:d87a2da7979babda08e04a",
      measurementId: "G-NQKBSS701Y"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Make available globally
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseCollection = collection;
    window.firebaseQuery = query;
    window.firebaseOrderBy = orderBy;
    window.firebaseWhere = where;
    window.firebaseGetDocs = getDocs;
    window.firebaseTimestamp = Timestamp;
    window.firebaseDoc = doc;
    
    console.log('✅ Firebase initialized');
  </script>
  
  <!-- Include the Firestore integration helper -->
  <script type="module" src="firestore-integration.js"></script>
  
  <!-- Example functions -->
  <script>
    // Wait for Firestore API to be ready
    window.addEventListener('firestoreApiReady', () => {
      console.log('✅ Firestore API ready for use');
    });
    
    async function loadDashboard() {
      const resultsDiv = document.getElementById('dashboard-results');
      resultsDiv.innerHTML = '<div class="spinner-border" role="status"></div> Loading...';
      
      try {
        const { stats, activities } = await window.FirestoreAPI.loadDashboardData();
        
        resultsDiv.innerHTML = `
          <div class="alert alert-success">
            <h6>Dashboard Statistics</h6>
            <ul class="mb-0">
              <li><strong>Total Students:</strong> ${stats.totalStudents}</li>
              <li><strong>Total Due:</strong> R${stats.totalDue.toLocaleString()}</li>
              <li><strong>Total Paid:</strong> R${stats.totalPaid.toLocaleString()}</li>
              <li><strong>Outstanding Balance:</strong> R${stats.totalBalance.toLocaleString()}</li>
              <li><strong>Collection Rate:</strong> ${stats.collectionRate}%</li>
              <li><strong>Net Surplus:</strong> R${stats.netSurplus.toLocaleString()}</li>
            </ul>
            <hr>
            <h6>Recent Activities (${activities.length})</h6>
            ${activities.length > 0 ? activities.map(a => `<li>${a.title}</li>`).join('') : '<p>No recent activities</p>'}
          </div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        console.error('Error loading dashboard:', error);
      }
    }
    
    async function loadStudents() {
      const resultsDiv = document.getElementById('students-results');
      resultsDiv.innerHTML = '<div class="spinner-border" role="status"></div> Loading...';
      
      try {
        const students = await window.FirestoreAPI.getAllStudents();
        
        resultsDiv.innerHTML = `
          <div class="alert alert-success">
            <h6>Total Students: ${students.length}</h6>
            <ul class="mb-0" style="max-height: 200px; overflow-y: auto;">
              ${students.map(s => `<li>${s.name} - Grade ${s.grade}</li>`).join('')}
            </ul>
          </div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        console.error('Error loading students:', error);
      }
    }
    
    async function searchStudent() {
      const searchTerm = prompt('Enter student name to search:');
      if (!searchTerm) return;
      
      const resultsDiv = document.getElementById('students-results');
      resultsDiv.innerHTML = '<div class="spinner-border" role="status"></div> Searching...';
      
      try {
        const students = await window.FirestoreAPI.searchStudents(searchTerm);
        
        resultsDiv.innerHTML = `
          <div class="alert alert-info">
            <h6>Search Results: ${students.length} found</h6>
            <ul class="mb-0">
              ${students.length > 0 ? students.map(s => `<li>${s.name} - Grade ${s.grade}</li>`).join('') : '<li>No students found</li>'}
            </ul>
          </div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        console.error('Error searching students:', error);
      }
    }
    
    async function loadTeachers() {
      const resultsDiv = document.getElementById('teachers-results');
      resultsDiv.innerHTML = '<div class="spinner-border" role="status"></div> Loading...';
      
      try {
        const teachers = await window.FirestoreAPI.getAllTeachers();
        
        resultsDiv.innerHTML = `
          <div class="alert alert-success">
            <h6>Total Teachers: ${teachers.length}</h6>
            <ul class="mb-0" style="max-height: 200px; overflow-y: auto;">
              ${teachers.map(t => `<li>${t.name} - ${t.subject}</li>`).join('')}
            </ul>
          </div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        console.error('Error loading teachers:', error);
      }
    }
    
    async function loadClasses() {
      const resultsDiv = document.getElementById('classes-results');
      resultsDiv.innerHTML = '<div class="spinner-border" role="status"></div> Loading...';
      
      try {
        const classes = await window.FirestoreAPI.getAllClasses();
        
        resultsDiv.innerHTML = `
          <div class="alert alert-success">
            <h6>Total Classes: ${classes.length}</h6>
            <ul class="mb-0" style="max-height: 200px; overflow-y: auto;">
              ${classes.map(c => `<li>${c.name} - Grade ${c.grade}</li>`).join('')}
            </ul>
          </div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        console.error('Error loading classes:', error);
      }
    }
    
    async function generateReport() {
      const resultsDiv = document.getElementById('report-results');
      resultsDiv.innerHTML = '<div class="spinner-border" role="status"></div> Generating report...';
      
      try {
        const startDate = new Date('2026-01-01');
        const endDate = new Date('2026-01-31');
        
        const report = await window.FirestoreAPI.generateFinancialReport(startDate, endDate);
        
        resultsDiv.innerHTML = `
          <div class="alert alert-success">
            <h6>Financial Report (Jan 2026)</h6>
            <h6>Income Summary</h6>
            <ul>
              <li><strong>Total Due:</strong> R${report.summary.income.totalDue.toLocaleString()}</li>
              <li><strong>Total Paid:</strong> R${report.summary.income.totalPaid.toLocaleString()}</li>
              <li><strong>Outstanding:</strong> R${report.summary.income.totalBalance.toLocaleString()}</li>
              <li><strong>Collection Rate:</strong> ${report.summary.income.collectionRate}%</li>
            </ul>
            <h6>Expenses Summary</h6>
            <ul>
              <li><strong>Total Expenses:</strong> R${report.summary.expenses.total.toLocaleString()}</li>
            </ul>
            <h6>Net Position</h6>
            <ul>
              <li><strong>Net Surplus/Deficit:</strong> R${report.summary.netSurplus.toLocaleString()}</li>
            </ul>
            <h6>Outstanding Students</h6>
            <p>${report.outstandingStudents.length} students with outstanding fees</p>
          </div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        console.error('Error generating report:', error);
      }
    }
  </script>
</body>
</html>
