rules_version = '2';

// BIS-SMS Firestore Security Rules
// 
// PERFORMANCE NOTE: These rules use Firestore document reads (get() calls) for role checking
// and relationship validation. For better performance in production, consider:
// 1. Using Firebase Auth Custom Claims for user roles instead of Firestore reads
// 2. Denormalizing frequently accessed data to reduce get() calls
// 3. Using Cloud Functions to manage complex authorization logic
// 
// This implementation prioritizes security correctness and clarity over performance.
// Optimize based on actual usage patterns and scale requirements.

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for role-based access control
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isTeacher() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }
    
    function isStudent() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }
    
    function isParent() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'parent';
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isParentOfStudent(studentId) {
      return isParent() && 
             studentId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.childrenIds;
    }
    
    function isTeacherOfClass(classId) {
      return isTeacher() && 
             get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid;
    }
    
    // Users collection - basic user profiles
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin() || isOwner(userId);
      allow delete: if isAdmin();
    }
    
    // Students collection
    match /students/{studentId} {
      allow read: if isAdmin() || 
                     isTeacher() || 
                     (isStudent() && isOwner(studentId)) ||
                     isParentOfStudent(studentId);
      allow create: if isAdmin() &&
                       // Validate required fields
                       request.resource.data.keys().hasAll(['id', 'name', 'grade', 'firstname', 'surname', 'gender']) &&
                       // Validate createdAt and updatedAt timestamps
                       request.resource.data.createdAt is timestamp &&
                       request.resource.data.updatedAt is timestamp &&
                       // Validate createdBy is the current user
                       request.resource.data.createdBy == request.auth.uid;
      allow update: if isAdmin() &&
                       // Ensure updatedAt is set
                       request.resource.data.updatedAt is timestamp &&
                       // Prevent modification of createdAt and createdBy
                       request.resource.data.createdAt == resource.data.createdAt &&
                       request.resource.data.createdBy == resource.data.createdBy;
      allow delete: if isAdmin();
    }
    
    // Teachers collection
    match /teachers/{teacherId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Classes collection
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin() &&
                       // Ensure updatedAt is set when modifying
                       request.resource.data.updatedAt is timestamp;
      allow delete: if isAdmin();
    }
    
    // Attendance records
    // Note: Attendance documents are keyed by classId and contain nested student data
    match /attendance/{classId} {
      allow read: if isAdmin() || 
                     isTeacherOfClass(classId) ||
                     (isStudent() && request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.studentIds) ||
                     (isParent() && 
                      get(/databases/$(database)/documents/classes/$(classId)).data.studentIds.hasAny(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.childrenIds));
      allow write: if isAdmin() || isTeacherOfClass(classId);
    }
    
    // Grades collection
    // Note: Grade documents are keyed by classId and contain nested student data
    match /grades/{classId} {
      allow read: if isAdmin() || 
                     isTeacherOfClass(classId) ||
                     (isStudent() && request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.studentIds) ||
                     (isParent() && 
                      get(/databases/$(database)/documents/classes/$(classId)).data.studentIds.hasAny(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.childrenIds));
      allow write: if isAdmin() || isTeacherOfClass(classId);
    }
    
    // Individual student grades
    match /gradesData/{studentId} {
      allow read: if isAdmin() || 
                     isTeacher() ||
                     (isStudent() && isOwner(studentId)) ||
                     isParentOfStudent(studentId);
      allow write: if isAdmin() || isTeacher();
    }
    
    // Subjects per class
    match /subjects/{classId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacherOfClass(classId);
    }
    
    // Messages collection
    match /messages/{messageId} {
      allow read: if isAuthenticated() && 
                     (resource.data.senderId == request.auth.uid || 
                      resource.data.recipientId == request.auth.uid ||
                      isAdmin());
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.senderId;
      allow update, delete: if isAdmin() || 
                              (isAuthenticated() && resource.data.senderId == request.auth.uid);
    }
    
    // Choptso chat messages collection
    match /choptsoMessages/{messageId} {
      allow read: if isAuthenticated() && 
                     (resource.data.broadcast == true || 
                      resource.data.senderId == request.auth.uid || 
                      request.auth.uid in resource.data.participants ||
                      isAdmin());
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.senderId &&
                       (request.resource.data.broadcast == true || 
                        request.auth.uid in request.resource.data.participants) &&
                       // Validate emoji and reaction fields if present
                       (!request.resource.data.keys().hasAny(['emoji']) || 
                        request.resource.data.emoji is string) &&
                       (!request.resource.data.keys().hasAny(['reactions']) || 
                        request.resource.data.reactions is map);
      allow update: if isAuthenticated() && 
                       (isAdmin() || 
                        resource.data.senderId == request.auth.uid ||
                        // Allow participants to add reactions to messages
                        (request.auth.uid in resource.data.participants &&
                         // Only allow updating reactions, readBy, and deliveredTo fields
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'readBy', 'deliveredTo', 'updatedAt'])));
      allow delete: if isAdmin();
    }
    
    // Choptso conversations metadata (for conversation lists, read receipts, etc.)
    match /choptsoConversations/{conversationId} {
      allow read: if isAuthenticated() && 
                     (request.auth.uid in resource.data.participants || isAdmin());
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() && 
                       (request.auth.uid in resource.data.participants || isAdmin()) &&
                       // Allow updating typing indicators, last message, and user status
                       (!request.resource.data.keys().hasAny(['typingUsers']) || 
                        request.resource.data.typingUsers is list);
      allow delete: if isAdmin();
    }
    
    // Choptso emoji reactions (subcollection under messages for scalability)
    match /choptsoMessages/{messageId}/reactions/{reactionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId &&
                       request.resource.data.emoji is string &&
                       request.resource.data.emoji.size() <= 10; // Limit emoji string length
      allow update: if isAuthenticated() && 
                       (isAdmin() || resource.data.userId == request.auth.uid);
      allow delete: if isAuthenticated() && 
                       (isAdmin() || resource.data.userId == request.auth.uid);
    }
    
    // Choptso user status and presence
    match /choptsoStatus/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (isOwner(userId) || isAdmin()) &&
                      (!request.resource.data.keys().hasAny(['status']) || 
                       request.resource.data.status in ['online', 'away', 'busy', 'offline']) &&
                      (!request.resource.data.keys().hasAny(['customEmoji']) || 
                       request.resource.data.customEmoji is string);
    }
    
    // User profiles (profile pictures, bio, etc.)
    match /userProfiles/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (isOwner(userId) || isAdmin()) &&
                      (!request.resource.data.keys().hasAny(['profilePicUrl']) || 
                       request.resource.data.profilePicUrl is string) &&
                      (!request.resource.data.keys().hasAny(['userId']) || 
                       request.resource.data.userId == userId);
    }
    
    // User status (online/away/busy/offline)
    match /userStatus/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (isOwner(userId) || isAdmin()) &&
                      (!request.resource.data.keys().hasAny(['status']) || 
                       request.resource.data.status in ['online', 'away', 'busy', 'offline']) &&
                      (!request.resource.data.keys().hasAny(['userId']) || 
                       request.resource.data.userId == userId);
    }
    
    // Status updates (24-hour stories)
    match /statuses/{statusId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId &&
                       request.resource.data.timestamp is timestamp &&
                       request.resource.data.expiresAt is timestamp &&
                       request.resource.data.type in ['text', 'image', 'canvas'] &&
                       // Text status validation
                       (request.resource.data.type != 'text' || 
                        (request.resource.data.text is string && 
                         request.resource.data.text.size() <= 500 &&
                         request.resource.data.bgColor is string)) &&
                       // Image/canvas status validation
                       ((request.resource.data.type == 'text') || 
                        request.resource.data.imageUrl is string);
      allow update: if isAuthenticated() && 
                       (isAdmin() || resource.data.userId == request.auth.uid);
      allow delete: if isAuthenticated() && 
                       (isAdmin() || resource.data.userId == request.auth.uid);
    }
    
    // Fees and payments
    match /fees/{studentId} {
      allow read: if isAdmin() || 
                     (isStudent() && isOwner(studentId)) ||
                     isParentOfStudent(studentId);
      allow write: if isAdmin();
    }
    
    // Expenses (school expenses)
    match /expenses/{expenseId} {
      allow read, write: if isAdmin();
    }
    
    // Homework assignments
    match /homework/{classId} {
      allow read: if isAuthenticated() &&
                     (isAdmin() || 
                      isTeacherOfClass(classId) ||
                      (isStudent() && request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.studentIds) ||
                      (isParent() && get(/databases/$(database)/documents/classes/$(classId)).data.studentIds.hasAny(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.childrenIds)));
      allow write: if isAdmin() || isTeacherOfClass(classId);
    }
    
    // School announcements
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }
    
    // School events calendar
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }
    
    // Health records for students
    match /healthRecords/{studentId} {
      allow read: if isAdmin() || 
                     (isStudent() && isOwner(studentId)) ||
                     isParentOfStudent(studentId);
      allow write: if isAdmin() || isParentOfStudent(studentId);
    }
    
    // Student achievements
    match /achievements/{studentId} {
      allow read: if isAdmin() || 
                     isTeacher() ||
                     (isStudent() && isOwner(studentId)) ||
                     isParentOfStudent(studentId);
      allow write: if isAdmin() || isTeacher();
    }
    
    // Exam timetable
    match /examTimetable/{timetableId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }
    
    // Notifications
    match /notifications/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(userId);
    }
    
    // School schedule
    match /schedule/{scheduleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Call history for voice/video calls
    match /callHistory/{callId} {
      allow read: if isAuthenticated() && 
                     (resource.data.callerId == request.auth.uid || 
                      resource.data.recipientId == request.auth.uid ||
                      isAdmin());
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.callerId;
      allow update: if isAuthenticated() && 
                       (request.auth.uid == resource.data.callerId || 
                        request.auth.uid == resource.data.recipientId ||
                        isAdmin());
      allow delete: if isAdmin();
    }
    
    // Assignments collection
    match /assignments/{assignmentId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isTeacher();
      allow update: if isAdmin() || isTeacher();
      allow delete: if isAdmin() || isTeacher();
    }
    
    // Assignment submissions
    match /assignmentSubmissions/{submissionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.studentId;
      allow update: if isAdmin() || 
                       isTeacher() || 
                       (isStudent() && request.auth.uid == resource.data.studentId);
      allow delete: if isAdmin();
    }
    
    // Lesson plans
    match /lessonPlans/{planId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isTeacher();
    }
    
    // Resources collection
    match /resources/{resourceId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isTeacher();
      allow update: if isAdmin() || 
                       (isTeacher() && resource.data.uploadedBy == request.auth.uid);
      allow delete: if isAdmin() || 
                       (isTeacher() && resource.data.uploadedBy == request.auth.uid);
    }
    
    // Resource downloads tracking
    match /resourceDownloads/{downloadId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
