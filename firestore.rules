rules_version = '2';

// BIS-SMS Firestore Security Rules
// 
// PERFORMANCE NOTE: These rules use Firestore document reads (get() calls) for role checking
// and relationship validation. For better performance in production, consider:
// 1. Using Firebase Auth Custom Claims for user roles instead of Firestore reads
// 2. Denormalizing frequently accessed data to reduce get() calls
// 3. Using Cloud Functions to manage complex authorization logic
// 
// This implementation prioritizes security correctness and clarity over performance.
// Optimize based on actual usage patterns and scale requirements.

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for role-based access control
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isTeacher() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }
    
    function isStudent() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }
    
    function isParent() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'parent';
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isParentOfStudent(studentId) {
      return isParent() && 
             studentId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.childrenIds;
    }
    
    function isTeacherOfClass(classId) {
      return isTeacher() && 
             get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid;
    }
    
    // Users collection - basic user profiles
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin() || isOwner(userId);
      allow delete: if isAdmin();
    }
    
    // Students collection
    match /students/{studentId} {
      allow read: if isAdmin() || 
                     isTeacher() || 
                     (isStudent() && isOwner(studentId)) ||
                     isParentOfStudent(studentId);
      allow create, update, delete: if isAdmin();
    }
    
    // Teachers collection
    match /teachers/{teacherId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Classes collection
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Attendance records
    // Note: Attendance documents are keyed by classId and contain nested student data
    match /attendance/{classId} {
      allow read: if isAdmin() || 
                     isTeacherOfClass(classId) ||
                     (isStudent() && request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.studentIds) ||
                     (isParent() && 
                      get(/databases/$(database)/documents/classes/$(classId)).data.studentIds.hasAny(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.childrenIds));
      allow write: if isAdmin() || isTeacherOfClass(classId);
    }
    
    // Grades collection
    // Note: Grade documents are keyed by classId and contain nested student data
    match /grades/{classId} {
      allow read: if isAdmin() || 
                     isTeacherOfClass(classId) ||
                     (isStudent() && request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.studentIds) ||
                     (isParent() && 
                      get(/databases/$(database)/documents/classes/$(classId)).data.studentIds.hasAny(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.childrenIds));
      allow write: if isAdmin() || isTeacherOfClass(classId);
    }
    
    // Individual student grades
    match /gradesData/{studentId} {
      allow read: if isAdmin() || 
                     isTeacher() ||
                     (isStudent() && isOwner(studentId)) ||
                     isParentOfStudent(studentId);
      allow write: if isAdmin() || isTeacher();
    }
    
    // Subjects per class
    match /subjects/{classId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacherOfClass(classId);
    }
    
    // Messages collection
    match /messages/{messageId} {
      allow read: if isAuthenticated() && 
                     (resource.data.senderId == request.auth.uid || 
                      resource.data.recipientId == request.auth.uid ||
                      isAdmin());
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.senderId;
      allow update, delete: if isAdmin() || 
                              (isAuthenticated() && resource.data.senderId == request.auth.uid);
    }
    
    // Choptso chat messages collection
    match /choptsoMessages/{messageId} {
      allow read: if isAuthenticated() && 
                     (resource.data.broadcast == true || 
                      resource.data.senderId == request.auth.uid || 
                      request.auth.uid in resource.data.participants ||
                      isAdmin());
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.senderId &&
                       (request.resource.data.broadcast == true || 
                        request.auth.uid in request.resource.data.participants);
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.senderId == request.auth.uid);
      allow delete: if isAdmin();
    }
    
    // Choptso conversations metadata (for conversation lists, read receipts, etc.)
    match /choptsoConversations/{conversationId} {
      allow read: if isAuthenticated() && 
                     (request.auth.uid in resource.data.participants || isAdmin());
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() && 
                       (request.auth.uid in resource.data.participants || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Fees and payments
    match /fees/{studentId} {
      allow read: if isAdmin() || 
                     (isStudent() && isOwner(studentId)) ||
                     isParentOfStudent(studentId);
      allow write: if isAdmin();
    }
    
    // Expenses (school expenses)
    match /expenses/{expenseId} {
      allow read, write: if isAdmin();
    }
    
    // Homework assignments
    match /homework/{classId} {
      allow read: if isAuthenticated() &&
                     (isAdmin() || 
                      isTeacherOfClass(classId) ||
                      (isStudent() && request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.studentIds) ||
                      (isParent() && get(/databases/$(database)/documents/classes/$(classId)).data.studentIds.hasAny(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.childrenIds)));
      allow write: if isAdmin() || isTeacherOfClass(classId);
    }
    
    // School announcements
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }
    
    // School events calendar
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }
    
    // Health records for students
    match /healthRecords/{studentId} {
      allow read: if isAdmin() || 
                     (isStudent() && isOwner(studentId)) ||
                     isParentOfStudent(studentId);
      allow write: if isAdmin() || isParentOfStudent(studentId);
    }
    
    // Student achievements
    match /achievements/{studentId} {
      allow read: if isAdmin() || 
                     isTeacher() ||
                     (isStudent() && isOwner(studentId)) ||
                     isParentOfStudent(studentId);
      allow write: if isAdmin() || isTeacher();
    }
    
    // Exam timetable
    match /examTimetable/{timetableId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }
    
    // Notifications
    match /notifications/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(userId);
    }
    
    // School schedule
    match /schedule/{scheduleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
